---
title: 浏览器中的架构
date: 2021-02-20 20:12:24
top: false
cover: false
password:
toc: true
mathjax: false
summary:
tags:
  - 浏览器
categories:
  - 浏览器
---

### 前言<hr>
由于市面上浏览器众多并且每个浏览器厂商实现有一定的区别。也是由于本人开发和搜索都是用的 Chrome，所以本文和后续关于浏览器的文章都是以 Chrome 为准。本文主要从几个角度概括的介绍浏览器的架构，更多的细节包括浏览器引擎Blink & V8，渲染引擎等会在后续学习更多知识后整理呈现

### 计算机架构<hr>
为了了解浏览器正在运行的环境，我们需要了解一些计算机部件及其功能。

> **计算机组成**

计算机组成分为五大部分控制器，处理器，存储器，输入和输出设备。如下图展示
<img src="/images/architecture01.jpeg">

1. **处理单元（Processing Unit，PU）：**包含了算术逻辑单元和处理器寄存器。用于完成各种算术和逻辑运算
2. **控制器单元（Control Unit，CU）：**包含了指令寄存器和程序计数器。用于控制程序的流程（程序流）
3. **储存器：**包括用于存储数据和指令的主存储器和容量更大但速度却慢的外部存储器
4. **输入/输出设备：**键盘、鼠标属于输入设备，显示器是输出设备，网卡即是输入设备又是输出设备

> **CPU 中央处理器**

<img src="/images/architecture02.png">

CPU 是计算机系统的运算和控制核心，负责处理各种不同的任务。**CPU 的运作原理可分为四个阶段：提取、解码、执行和写回。CPU 的核心数量也决定了运算处理速度的高低。** 一个 CPU 内核，在上图中被描绘为办公室工作人员，可以一一处理许多不同的任务。它可以处理从数学到美术的所有工作，同时又知道如何回复客户的电话。

> **GPU 图形处理器**

<img src="/images/architecture03.png">

GPU 是计算机的另一部分。与 CPU 不同，GPU 擅长处理简单任务，但同时跨多个内核。顾名思义，它最初是为处理图形而开发的。这就是为什么在图形上下文中“使用 GPU ”或“支持 GPU ”与快速渲染和流畅交互相关联的原因。近年来，随着 GPU 的加速计算，仅 GPU 上的计算就变得越来越多。

> **三层计算机体系结构**

<img src="/images/architecture04.png">

如上图三层计算机体系结构图中所示。机器硬件在底部，操作系统在中间，应用程序在顶部。当在计算机或手机上启动应用程序时，为应用程序供电的是 CPU 和 GPU。通常应用程序使用操作系统提供的机制在 CPU 和 GPU 上运行。

### 进程、线程、协程<hr>

在深入研究浏览器架构之前需要掌握的另一个概念是进程、线程和协程

<img src="/images/architecture05.png">

1. 线程是程序执行的最小单位，而进程是操作系统分配资源的最小单位
2. 一个进程可以拥有多个线程，一个线程也可以拥有多个协程
3. 进程之间相互独立，同一进程下的各个线程之间共享程序的内存空间及一些进程级的资源，某进程内的线程在其它进程不可见
4. 协程，是一种基于线程之上，但又比线程更加轻量级的存在，这种由程序员自己写程序来管理的轻量级线程叫做『用户空间线程』，具有对内核来说不可见的特性
5. 协程出现的场景是为了解决 I/O 阻塞，且需要大量并发的场景

当我们启动一个应用程序时，就会创建一个进程。而操作系统为进程提供了一块用于工作的“slab”内存，所有的应用程序状态都保存在这个私有内存空间中。当关闭应用程序时，进程也会消失，操作系统会释放内存。

> **进程间通信（IPC）**

<img src="/images/architecture.svg">

进程可以要求操作系统启动另一个进程来运行不同的任务。可以使用 IPC 进行两个进程之间的通讯。上面动画中就展示了使用 IPC 通讯的过程。（<a href="/2019/04/12/node/process">Node 中的进程通讯</a>）

大多数程序被设计成使用 IPC来进行进程间的通信，好处是不会因为一个工作进程失去响应时，而造成应用程序不能继续工作。

### 浏览器架构<hr>

> **浏览器的主要功能**

浏览器的主要功能就是向服务器发出请求，在浏览器窗口中展示对应的网络资源。而它的用户界面有很多彼此相同的元素，其中包括：

1. 用来输入 URI 的地址栏
2. 前进和后退按钮
3. 书签设置选项
4. 用于刷新和停止加载当前文档的刷新和停止按钮
5. 用于返回主页的主页按钮

浏览器的用户界面并没有任何正式的规范，HTML5 也没有定义浏览器必须具有的用户界面元素，但列出了一些通用的元素，例如地址栏、状态栏和工具栏等。当然，各浏览器也可以有自己独特的功能。

> **浏览器的高层结构**

<img src="/images/architecture06.png">

如上图浏览器的主要组件为：

1. 用户界面 - 包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面
2. 浏览器引擎 - 在用户界面和渲染引擎之间传送指令
3. 渲染引擎 - 负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上。
4. 网络 - 用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现。
5. 用户界面后端 - 用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。
6. JavaScript 解释器。用于解析和执行 JavaScript 代码。
7. 数据存储。这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。

> **Chrome 浏览器架构**

<img src="/images/architecture07.png">
借助进程和线程，浏览器可以设计成单进程、多线程架构（图左），或者利用 IPC 实现多进程、多线程架构（图右）。

<img src="/images/architecture08.png">

由于没有关于如何构建浏览器的标准，所以每个浏览器实现的方案细节可能不太一样，通过图中看到 Chrome 浏览器的架构有很多个进程，每个进程各司其职：
1. 浏览器进程（Browser Process）- 负责管理 Chrome 应用本身，包括地址栏、书签、前进和后退按钮。同时也负责可不见的功能，比如网络请求、文件按访问等，也负责其他进程的调度
2. 渲染进程（Renderer Process）- 负责站点的渲染，其中也包括 JavaScript 代码的运行，web worker的管理等
3. 插件进程（Plugin Process）- 控制网站使用的所有插件功能，例如Flash
4. GPU进程（GPU Process）- 独立于其他进程处理 GPU 任务。它被分离到不同的进程中，因为 GPU 处理来自多个应用程序的请求，并在同一个屏幕上绘制

<img src="/images/architecture09.png">

上面是几个主要的进程，当然还有更多的进程，例如扩展进程或工具进程。可以点击右上角设置 > 更多工具 > 任务管理器来查看其他进程和进程占用的 CPU 和内存情况。

> **多进程架构的好处**

Chrome 使用多个渲染进程，每个标签页都有自己的渲染进程且独立运行，这样的好处就是当有一个标签页面由于异常造成无响应甚至崩溃时，不会影响其它标签页面。

<img src="/images/architecture10.png">

另一个好处是，借助操作系统对进程安全的控制，浏览器可以将页面放置在沙箱中，站点的代码可以运行在隔离的环境中，保证核心进程的安全。

虽然多进程的架构优于单进程架构，但由于进程独享自己的私有内存，以渲染进程为例，虽然渲染的站点不同，但工作内容大体相似，为了完成渲染工作它们会在自己的内存中包含相同的功能，例如 V8 引擎（用于解析和运行Javascript），这意味着这部分相同的功能需要占用每个进程的内存空间。为了节省内存，Chrome 限制了最大进程数，最大进程数取决于硬件的能力，同时当使用多个页签访问相同的站点时浏览器不会创建新的渲染进程。

> 基于站点隔离的渲染进程

Chrome 每个标签是一个渲染进程，它允许跨站点的 iframes 在单个渲染进程中运行，并在不同站点之间共享内存空间。在同一个渲染器进程中运行a.com和b.com似乎没有问题。
由于同源策略的影响确保一个网站不能在未经同意的情况下访问其他网站的数据。所以在 Chrome 67 默认启用的站点隔离，为每个跨站点的 iframe 在一个标签页获得一个单独的渲染程序进程并在不同的站点之间共享内存空间。

<img src="/images/architecture11.png">

### 参考
- <a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%A4%AE%E5%A4%84%E7%90%86%E5%99%A8">维基百科关于 CPU 的介绍</a>
- <a href="https://www.cnblogs.com/Survivalist/p/11527949.html">一文读懂什么是进程、线程、协程</a>
