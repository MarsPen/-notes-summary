<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>React åŸç†ä¹‹ hook</title>
      <link href="/2019/11/09/react/library-react-hook/"/>
      <url>/2019/11/09/react/library-react-hook/</url>
      
        <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯-hook"><a href="#ä»€ä¹ˆæ˜¯-hook" class="headerlink" title="ä»€ä¹ˆæ˜¯ hook"></a>ä»€ä¹ˆæ˜¯ hook<hr></h3><p>hook æ„ä¸ºé’©å­ï¼Œå½“ä»£ç æ‰§è¡Œç‰¹å®šçš„æ—¶æœŸæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ hook ä¸­çš„ä»£ç å’Œç”Ÿå‘½å‘¨æœŸç±»ä¼¼ã€‚</p><h3 id="è§£å†³çš„é—®é¢˜"><a href="#è§£å†³çš„é—®é¢˜" class="headerlink" title="è§£å†³çš„é—®é¢˜"></a>è§£å†³çš„é—®é¢˜<hr></h3><p>å®ƒèƒ½å¤Ÿåœ¨ä¸ä½¿ç”¨ç±»çš„æƒ…å†µä¸‹ä½¿ç”¨çŠ¶æ€å’Œå…¶ä»–åŠŸèƒ½ï¼Œå®ƒçš„ç¼–å†™åŸºæœ¬ä¸Šæ˜¯å‡½æ•°ç»„ä»¶çš„æ–¹å¼ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬å†™ react è™½ç„¶éƒ½æ˜¯ç»„ä»¶å¼å¼€å‘ï¼Œæé«˜äº†ä»£ç çš„çµæ´»æ€§ï¼Œä½†æ˜¯éšç€ä¸šåŠ¡å¤æ‚åŒ–ï¼Œå¥½å¤šä¸šåŠ¡ä»£ç ä¸å¾—ä¸å’Œå„ç§ç”Ÿå‘½å‘¨æœŸçš„é’©å­ç›¸å…³è”ï¼Œä¸æ–¹ä¾¿æŠ½ç¦»ï¼Œæ‰€ä»¥åªèƒ½å¤åˆ¶ï¼Œç²˜è´´è¿›è¡Œä¿®æ”¹ã€‚</p><p>hook å°±æ˜¯ä¸ºäº†è§£å†³ç»„ä»¶å¤ç”¨è¿™ä¸ªé—®é¢˜å‡ºç°çš„ï¼Œä¸‹é¢æˆ‘ä¼šé€šè¿‡ hook ä½¿ç”¨å’ŒåŸç†æ¥è¯´æ˜å®ƒçš„å¼ºå¤§ä¹‹å¤„ã€‚</p><h3 id="è¡¥å……çš„çŸ¥è¯†"><a href="#è¡¥å……çš„çŸ¥è¯†" class="headerlink" title="è¡¥å……çš„çŸ¥è¯†"></a>è¡¥å……çš„çŸ¥è¯†<hr></h3><p>åœ¨äº†è§£ hook ä¹‹å‰å…ˆçœ‹ä¸€ä¸‹ react è¿™ä¸¤æ–¹é¢<a href="https://reactjs.org/docs/render-props.html" target="_blank" rel="noopener">æ¸²æŸ“å±æ€§</a>å’Œ<a href="https://reactjs.org/docs/higher-order-components.html" target="_blank" rel="noopener">é«˜é˜¶ç»„ä»¶</a>çš„çŸ¥è¯†æœ‰åŠ©äºç†è§£ hook</p><h3 id="hook-çš„è§„åˆ™"><a href="#hook-çš„è§„åˆ™" class="headerlink" title="hook çš„è§„åˆ™"></a>hook çš„è§„åˆ™<hr></h3><p>hook æœ¬è´¨å°±æ˜¯ JavaScript å‡½æ•°ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨å®ƒæ—¶éœ€è¦éµå¾ªä¸¤æ¡è§„åˆ™</p><ul><li>åªåœ¨æœ€é¡¶å±‚ä½¿ç”¨ hookï¼Œä¸è¦åœ¨å¾ªç¯ï¼Œæ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨ hook</li><li>åªåœ¨ React å‡½æ•°ä¸­è°ƒç”¨ hookï¼Œä¸è¦åœ¨æ™®é€šçš„ JavaScript å‡½æ•°ä¸­è°ƒç”¨ hook</li></ul><p>é€šè¿‡<a href="https://www.npmjs.com/package/eslint-plugin-react-hooks" target="_blank" rel="noopener">eslint-plugin-react-hooks</a>æ’ä»¶å¯ä»¥å¼ºåˆ¶æ‰§è¡Œè¿™ä¸¤æ¡è§„åˆ™</p><pre class="line-numbers language-js"><code class="language-js">npm install eslint<span class="token operator">-</span>plugin<span class="token operator">-</span>react<span class="token operator">-</span>hooks <span class="token operator">--</span>save<span class="token operator">-</span>dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ä½ çš„ ESLint é…ç½®</span><span class="token punctuation">{</span>  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token string">"react-hooks"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">"rules"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token string">"react-hooks/rules-of-hooks"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// æ£€æŸ¥ Hook çš„è§„åˆ™</span>    <span class="token string">"react-hooks/exhaustive-deps"</span><span class="token punctuation">:</span> <span class="token string">"warn"</span> <span class="token comment" spellcheck="true">// æ£€æŸ¥ effect çš„ä¾èµ–</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="hook-çš„åˆ†ç±»"><a href="#hook-çš„åˆ†ç±»" class="headerlink" title="hook çš„åˆ†ç±»"></a>hook çš„åˆ†ç±»<hr></h3><p>hookåˆ†ä¸ºå†…ç½®çš„å’Œè‡ªå®šä¹‰çš„ä¸¤ç§ç±»å‹ï¼Œå†…ç½®çš„ hook æœ‰ä»¥ä¸‹å‡ ä¸ª</p><p>åŸºç¡€ hook</p><ul><li>useState</li><li>useEffect</li><li>useContext</li></ul><p>é¢å¤– hook</p><ul><li>useReducer</li><li>useCallback</li><li>useMemo</li><li>useRef</li><li>useImperativeHandle</li><li>useLayoutEffect</li><li>useDebugValue</li></ul><h3 id="hook-çš„ä½¿ç”¨"><a href="#hook-çš„ä½¿ç”¨" class="headerlink" title="hook çš„ä½¿ç”¨"></a>hook çš„ä½¿ç”¨<hr></h3><blockquote><p>useState è¿”å›ä¸€ä¸ª stateï¼Œä»¥åŠæ›´æ–° state çš„å‡½æ•°</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// hook æ¨¡å¼</span><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">const</span>  Example  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å£°æ˜ä¸€ä¸ªå« "count" çš„ state å˜é‡</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span>p<span class="token operator">></span>You clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>        Click me      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// class æ¨¡å¼</span><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>p<span class="token operator">></span>You clicked <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span> times<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>          Click me        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢æ¥è‡ªå®˜ç½‘çš„ä¾‹å­æˆ‘ä»¬å¾ˆæ¸…æ™°çš„çœ‹åˆ°æ²¡æœ‰ classã€ä¹Ÿæ²¡æœ‰äº†æ˜¾ç¤ºå£°æ˜çš„constructorã€thisï¼Œè€Œæ˜¯ä½¿ç”¨äº† useState è¿™ä¸ªå‡½æ•°ã€‚<br>ä½†æ˜¯ä¸Šé¢çš„ä»£ç æœ‰ä¸€ä¸ªç–‘é—®æˆ‘ä»¬æ€ä¹ˆå®šä¹‰å¤šä¸ª stateï¼Ÿ è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢ä¸¤ç§æ–¹å¼</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// count</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// name</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// age</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// propertys</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>propertys<span class="token punctuation">,</span> setPropertys<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>count<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">28</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®˜æ–¹å»ºè®®æ˜¯å°†ä¸åŒåŠŸèƒ½çš„ state æŠ½ç¦»åˆ° ä¸åŒ useState ä¸­ã€‚è¿™æ ·åœ¨åæœŸæ‹†åˆ†é€»è¾‘çš„æ—¶å€™æ›´åŠ å®¹æ˜“æ§åˆ¶</p><p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬çŸ¥é“ useState çš„ä½œç”¨æ˜¯</p><ul><li>å®ƒè®©æˆ‘ä»¬åœ¨å‡½æ•°ç»„ä»¶ä¸­å­˜å‚¨å†…éƒ¨ state</li><li>å¯ä»¥é€šè¿‡ useState çš„è¿”å›å€¼æ¥æ›´æ–° state</li><li>æ ¹æ® useState å‡ºç°çš„é¡ºåºæ¥ä¿è¯åœ¨ä½¿ç”¨çš„èƒ½æ‰¾åˆ°å¯¹åº”çš„ stateï¼ˆuseEffect ä¼šè®²ï¼‰ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢è¯´åˆ° hook å£°æ˜è¦åœ¨æœ€å¤–å±‚</li><li>hook ä¸­æ²¡æœ‰ä½¿ç”¨ thisï¼Œè€Œæ˜¯é€šè¿‡ç»„ä»¶å†…éƒ¨çš„ã€Œè®°å¿†å•å…ƒæ ¼ã€åˆ—è¡¨æ¥å¯¹å½“å…ˆæ¸²æŸ“ä¸­çš„ç»„ä»¶è¿›è¡Œè¿½è¸ªã€‚</li></ul><blockquote><p>useEffect æ¥æ”¶ä¸€ä¸ªå‡½æ•°ã€‚é»˜è®¤çš„æƒ…å†µä¸‹ effect å°†åœ¨æ¯è½®æ¸²æŸ“ç»“æŸåæ‰§è¡Œ</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token function">useEffect</span><span class="token punctuation">(</span>didUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// hook æ¨¡å¼</span><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span>p<span class="token operator">></span>You clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>        Click me      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// class æ¨¡å¼</span><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>p<span class="token operator">></span>You clicked <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span> times<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>          Click me        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å¯¹æ¯”åº”è¯¥çŸ¥é“äº† useEffectï¼Œçš„åŸºæœ¬ä½œç”¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ª hook ä¸­å‘é€ç½‘ç»œè¯·æ±‚ï¼Œè¿›è¡Œæœ‰å‰¯ä½œç”¨æ“ä½œçš„è®¡ç®—ç­‰ç­‰ã€‚</p><p>æ‰€ä»¥å¯ä»¥æŠŠå®ƒå½“ä½œ componentDidMountï¼ŒcomponentDidUpdate å’Œ componentWillUnmount è¿™ä¸‰ä¸ªå‡½æ•°çš„ç»„åˆã€‚</p><p>å›åˆ°å¤šä¸ª useState çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå¤šä¸ª useEffect æ˜¯æ€ä¹ˆæ‰§è¡Œå’ŒåŒ¹é…çš„</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// hook 1</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// hook 2</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ä¾‹å­çœ‹åˆ° hook å…è®¸æˆ‘ä»¬æŒ‰ç…§ä»£ç çš„ç”¨é€”åˆ†ç¦»ä»–ä»¬ï¼ŒReact å°†æŒ‰ç…§ effect å£°æ˜çš„é¡ºåºä¾æ¬¡è°ƒç”¨ç»„ä»¶ä¸­çš„æ¯ä¸€ä¸ª effectï¼Œå¦åˆ™å°±æœ‰å¯èƒ½æ‰¾ä¸åˆ°å¯¹åº”çš„æ ‡è¯†è€Œå‡ºé”™</p><p>åœ¨æ¯æ¬¡è¿›è¡Œé‡æ–°æ¸²æŸ“çš„æ—¶å€™éƒ½è¦è¿è¡Œ Effectï¼Œè€Œä¸æ˜¯åªåœ¨å¸è½½ç»„ä»¶çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ã€‚æ˜¯é˜²æ­¢æ²¡æœ‰å¤„ç†æ›´æ–°é€»è¾‘è€Œå¯¼è‡´çš„å¸¸è§ bugï¼Œä½†æ˜¯æ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œæ¸…ç†æˆ–è€…æ‰§è¡Œ effect å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜æˆ‘ä»¬æ€ä¹ˆæ¥è§£å†³å‘¢ï¼Ÿ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// åœ¨ class ä¸­</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevState<span class="token punctuation">.</span>count <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// hook ä¸­</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ä»…åœ¨ count æ›´æ”¹æ—¶æ›´æ–°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘æˆ‘ä»¬çœ‹åˆ°åœ¨ class ä¸­ éœ€è¦æˆ‘ä»¬è‡ªå·±åœ¨ componentDidUpdate ä¸­å¤„ç†å¯¹åº”çš„é€»è¾‘ï¼Œè€Œ hook ä¸­è¢«å†…ç½®åˆ°äº† api ä¸­å®ƒä¼šå¯¹å‰ä¸€æ¬¡å’Œåä¸€æ¬¡è¿›è¡Œæ¯”è¾ƒï¼Œé€šè¿‡ç¬¬äºŒä¸ªå‚æ•°æ¥è·³è¿‡å¯¹ effect çš„è°ƒç”¨å®ç°äº†æ€§èƒ½ä¼˜åŒ–,ä½†æ˜¯åœ¨ä½¿ç”¨ä¸­è¿˜æœ‰ä¸€äº›é—®é¢˜å¦‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> someProp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>someProp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ğŸ”´ è¿™æ ·ä¸å®‰å…¨ï¼ˆå®ƒè°ƒç”¨çš„ `doSomething` å‡½æ•°ä½¿ç”¨äº† `someProp`ï¼‰</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> someProp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>someProp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>someProp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// âœ… å®‰å…¨ï¼ˆæˆ‘ä»¬çš„ effect ä»…ç”¨åˆ°äº† `someProp`ï¼‰</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“å‡½æ•°ï¼ˆä»¥åŠå®ƒæ‰€è°ƒç”¨çš„å‡½æ•°ï¼‰ä¸å¼•ç”¨ propsã€state ä»¥åŠç”±å®ƒä»¬è¡ç”Ÿè€Œæ¥çš„å€¼æ—¶ï¼Œæ‰å¯ä»¥é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°è·³è¿‡ effect çš„è°ƒç”¨ã€‚</p><p>é€šè¿‡ä¸Šé¢æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ useEffect</p><ul><li>åœ¨æ‰§è¡Œ DOM æ›´æ–°ä¹‹åæ‰è°ƒç”¨æ­¤ hook</li><li>å¯ä»¥å‘Šè¯‰ react ç»„ä»¶éœ€è¦åœ¨æ¸²æŸ“åæ‰§è¡ŒæŸäº›æ“ä½œï¼ˆåŒ…å«å‰¯ä½œç”¨çš„ä¸€äº›é€»è¾‘ç­‰ï¼‰</li><li>æ”¾åœ¨ç»„ä»¶å†…éƒ¨è®©æˆ‘ä»¬å¯ä»¥åœ¨ effect ä¸­ç›´æ¥è®¿é—® state çš„å˜é‡ï¼ˆå› ä¸ºä½¿ç”¨äº†é—­åŒ…æœºåˆ¶ï¼Œä¿å­˜åœ¨å‡½æ•°ä½œç”¨åŸŸä¸­ï¼‰</li><li>ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œï¼ˆç¬¬ä¸€æ¬¡æ¸²æŸ“å’Œæ¯æ¬¡æ›´æ–°ï¼‰å¯ä»¥é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œæ€§èƒ½ä¼˜åŒ–</li><li>ä½¿ç”¨ useEffect è°ƒåº¦çš„ effect ä¸ä¼šé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•</li><li>effect è¿”å›ä¸€ä¸ªå‡½æ•°æ˜¯å› ä¸ºï¼Œå¯ä»¥åœ¨å‡½æ•°å†…è¿›è¡Œæ¸…é™¤ä¸€äº›å‰¯ä½œç”¨ï¼ˆå¼•ç”¨äº†å¤–éƒ¨çš„å˜é‡ä¸Šé¢çš„ä¾‹å­ï¼‰</li></ul><p>ç”±äºæ–‡ç« çš„ç¯‡å¹…é—®é¢˜æˆ‘ä»¬å°±ä¸å†è¿™é‡Œè¿›è¡Œæ›´å¤šhook çš„ä»‹ç»äº†ï¼Œå¯ä»¥æŸ¥çœ‹<a href="https://zh-hans.reactjs.org/docs/hooks-reference.html" target="_blank" rel="noopener">å®˜ç½‘</a></p><h3 id="hooks-çš„åŸç†"><a href="#hooks-çš„åŸç†" class="headerlink" title="hooks çš„åŸç†"></a>hooks çš„åŸç†<hr></h3><p>åœ¨ä¸Šé¢çš„ä»‹ç» useEffect çš„æ—¶å€™æåˆ°è¿‡ hook å®é™…ä¸Šæ˜¯ä½¿ç”¨é—­åŒ…æœºåˆ¶ï¼Œå°†çŠ¶æ€è¡Œä¸ºå’Œå‰¯ä½œç”¨å°è£…åœ¨å…¶ä¸­ã€‚</p><p>è®©æˆ‘ä»¬æ¥å›å¿†ä¸€ä¸‹ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Œã€Šä½ ä¸çŸ¥é“çš„JSã€‹è¿™æœ¬ä¹¦ä¸­å°†é—­åŒ…å®šä¹‰ä¸ºã€‚</p><p><strong>é—­åŒ…æ˜¯æŒ‡æŸä¸ªå‡½æ•°èƒ½å¤Ÿè®°ä½å¹¶è®¿é—®å…¶è¯æ³•èŒƒå›´ï¼Œå³ä½¿è¯¥å‡½æ•°åœ¨å…¶è¯æ³•èŒƒå›´ä¹‹å¤–æ‰§è¡Œ</strong></p><blockquote><p>useState å®ç°</p></blockquote><p>æˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„ demo å·²ç»çŸ¥é“ä½¿ç”¨ useState æ—¶å€™</p><ul><li>è¿”å›ä¸€ä¸ªå˜é‡å’Œä¸€ä¸ªå‡½æ•°ï¼Œ</li><li>å‚æ•°ä¸ºè¿”å›å˜é‡çš„é»˜è®¤å€¼</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _val <span class="token operator">=</span> initialValue   <span class="token keyword">function</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// é—­åŒ…</span>    <span class="token keyword">return</span> _val   <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// é—­åŒ…</span>    _val <span class="token operator">=</span> newVal   <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token keyword">var</span> <span class="token punctuation">[</span>foo<span class="token punctuation">,</span> setFoo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 0</span><span class="token function">setFoo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬çœ‹åˆ°å€ŸåŠ© foo å’Œ setFooï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®¿é—®å’Œæ“çºµï¼ˆä¹Ÿç§°ä¸ºâ€œå°é—­â€ï¼‰å†…éƒ¨å˜é‡_valã€‚</p><p>å®ƒä»¬ä¿ç•™å¯¹ useState çš„ä½œç”¨åŸŸçš„è®¿é—®æƒé™ï¼Œè¯¥å¼•ç”¨ç§°ä¸ºé—­åŒ…ã€‚åœ¨ react ä¸­è¿™å°±æ˜¯çŠ¶æ€ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“çŠ¶æ€å¿…é¡»æ˜¯å˜é‡è€Œä¸æ˜¯å‡½æ•°ã€‚æ‰€ä»¥æˆ‘ä»¬ä½œå‡ºå¦‚ä¸‹ä¿®æ”¹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _val <span class="token operator">=</span> <span class="token punctuation">{</span>value <span class="token punctuation">:</span> initialValue<span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    _val<span class="token punctuation">.</span>value <span class="token operator">=</span> newVal  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// æš´éœ² _val</span>  <span class="token keyword">return</span> <span class="token punctuation">[</span>_val<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token keyword">var</span> <span class="token punctuation">[</span>foo<span class="token punctuation">,</span> setFoo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 0}</span><span class="token function">setFoo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 1}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ä»£ç ä¼¼ä¹è·Ÿæˆ‘ä»¬æƒ³è¦çš„æ ·å­æ›´è¿‘äº†ï¼Œä½†æ˜¯é—®é¢˜åœ¨äºè§£æ„ foo æ—¶è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡å’Œ React.useState API è¿˜æ˜¯æœ‰åŒºåˆ«ã€‚</p><ul><li>useState è¿”å›çš„æ–°å‡½æ•°è®¾ç½®å€¼ä¹‹åéœ€è¦é‡æ–°æ¸²æŸ“é¡µé¢</li><li>ç”±äº _val åœ¨å‡½æ•°å†…éƒ¨è¢«å£°æ˜çš„ï¼Œæ¯æ¬¡é‡æ–°è°ƒç”¨éƒ½ä¼šè¢«åˆå§‹åŒ–ï¼Œæ‰€ä»¥å°† _val æåˆ°å…¨å±€</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> MyReact <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å°† _val æäº¤å…¨å±€ç”¨äºä¿å­˜è¿™ä¸ªå€¼</span>  <span class="token keyword">let</span> _val   <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿ render ç”¨äºæ”¹å˜å€¼åéœ€è¦é‡æ–°æ¸²æŸ“</span>    <span class="token function">render</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> Comp <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      Comp<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> Comp    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// useState</span>    <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>      _val <span class="token operator">=</span> _val <span class="token operator">||</span> initialValue      <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _val <span class="token operator">=</span> newVal      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span>_val<span class="token punctuation">,</span> setState<span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    click<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    render<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render:'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> AppApp <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// render: { count: 0 }</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// render: { count: 1 }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹åˆ°ä¸Šé¢çš„æ‰§è¡Œç»“æœä¹‹åï¼Œå…¶å® useState è¿™ä¸ª api å°±æ¨¡æ‹ŸæˆåŠŸäº†ï¼Œä¸‹é¢è®©æˆ‘çœ‹çœ‹ useEffect çš„å®ç°</p><blockquote><p>useEffect å®ç°</p></blockquote><p>é€šè¿‡ä¸Šé¢ä½¿ç”¨ useEffectï¼Œæˆ‘ä»¬çŸ¥é“ useEffectå®é™…ä¸Š</p><ul><li>æœ‰ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯å¯é€‰å‚æ•°-æ•°ç»„</li><li>æ ¹æ®ç¬¬äºŒä¸ªå‚æ•°ä¸­æ˜¯å¦æœ‰å˜åŒ–ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ useEffect æ¥æé«˜æ€§èƒ½</li></ul><p>é‚£ä¹ˆæ ¹æ®ä¸Šé¢çš„è§„åˆ™æˆ‘ä»¬å®ç°å¦‚ä¸‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> MyReact <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> _val<span class="token punctuation">,</span> _deps <span class="token comment" spellcheck="true">// ç”¨äºä¿æŒæ•°æ®ï¼Œå› ä¸ºä¾èµ–å‘ç”Ÿæ”¹å˜åä¼šé‡æ–°æ¸²æŸ“æ‰§è¡Œ</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿ render å‡½æ•°</span>    <span class="token function">render</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> Comp <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      Comp<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> Comp    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿ useEffect</span>    <span class="token function">useEffect</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> depArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> hasNoDeps <span class="token operator">=</span> <span class="token operator">!</span>depArray      <span class="token keyword">const</span> hasChangedDeps <span class="token operator">=</span> _deps <span class="token operator">?</span> <span class="token operator">!</span>depArray<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> el <span class="token operator">===</span> _deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token boolean">true</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNoDeps <span class="token operator">||</span> hasChangedDeps<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        _deps <span class="token operator">=</span> depArray      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿ useState</span>    <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>      _val <span class="token operator">=</span> _val <span class="token operator">||</span> initialValue      <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _val <span class="token operator">=</span> newVal      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span>_val<span class="token punctuation">,</span> setState<span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// æ¥è°ƒç”¨ä¸€ä¸‹ï¼Œçœ‹çœ‹ç»“æœ</span><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  MyReact<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effect'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    click<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    noop<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span>    render<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> AppApp <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 0</span><span class="token comment" spellcheck="true">// render {count: 0}</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 1</span><span class="token comment" spellcheck="true">// render {count: 1}</span>App<span class="token punctuation">.</span><span class="token function">noop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// // no effect run</span><span class="token comment" spellcheck="true">// render {count: 1}</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 2</span><span class="token comment" spellcheck="true">// render {count: 2}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢åŸºæœ¬å®ç°äº† useStateã€ useEffectï¼Œä½†æ˜¯ä¹Ÿåªæ˜¯è°ƒç”¨äº†ä¸€æ¬¡ï¼Œå¦‚æœç»„ä»¶ä¸­è¿›è¡Œå¤šæ¬¡è°ƒç”¨å‘¢ï¼Ÿå¦‚ä¸‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// hook 1</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// hook 2</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæŒ‰ç…§å¤šæ¬¡è°ƒç”¨æˆ‘ä»¬çš„å®ç°å°±ä¼šå‘ç”Ÿå˜é‡å†²çªï¼Œå› ä¸ºåœ¨ä¸Šé¢çš„å®ç°è¿‡ç¨‹ä¸­æˆ‘ä»¬å…±äº«äº†ä¸€ä¸ªå…¨å±€å˜é‡ç”¨äºå­˜å‚¨æ•°æ®ã€‚</p><p>é€šè¿‡ä¸Šé¢ä»‹ç» API çš„æ—¶å€™è¯´è¿‡å®ƒæ˜¯é€šè¿‡ç»„ä»¶å†…éƒ¨çš„ã€Œè®°å¿†å•å…ƒæ ¼ã€åˆ—è¡¨æ¥å¯¹å½“å…ˆæ¸²æŸ“ä¸­çš„ç»„ä»¶è¿›è¡Œè¿½è¸ªï¼Œæœ€ä¸»è¦çš„æ˜¯æ ¹æ®æ‰§è¡Œçš„é¡ºåºæ¥è°ƒç”¨çš„ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡æ•°ç»„æ¥ç»´æŠ¤å½“å‰çš„è®°å¿†åˆ—è¡¨å‘¢ï¼Ÿå¦‚ä¸‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> MyReact <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// é€šè¿‡æ•°ç»„å’Œç´¢å¼•ç»´æŠ¤å½“å‰çš„è®°å¿†å•å…ƒ</span>  <span class="token keyword">let</span> hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    currentHook <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token function">render</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// è¿è¡Œ effects</span>      <span class="token keyword">const</span> Comp <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      Comp<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// é‡ç½®ä¸ºä¸‹ä¸€æ¬¡æ¸²æŸ“</span>      currentHook <span class="token operator">=</span> <span class="token number">0</span>      <span class="token keyword">return</span> Comp    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿ useEffect</span>    <span class="token function">useEffect</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> depArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> hasNoDeps <span class="token operator">=</span> <span class="token operator">!</span>depArray      <span class="token keyword">const</span> deps <span class="token operator">=</span> hooks<span class="token punctuation">[</span>currentHook<span class="token punctuation">]</span>      <span class="token keyword">const</span> hasChangedDeps <span class="token operator">=</span> deps <span class="token operator">?</span> <span class="token operator">!</span>depArray<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> el <span class="token operator">===</span> deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token boolean">true</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNoDeps <span class="token operator">||</span> hasChangedDeps<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        hooks<span class="token punctuation">[</span>currentHook<span class="token punctuation">]</span> <span class="token operator">=</span> depArray      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// ç´¯åŠ  currentHook</span>      currentHook<span class="token operator">++</span>     <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿ useState</span>    <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>      hooks<span class="token punctuation">[</span>currentHook<span class="token punctuation">]</span> <span class="token operator">=</span> hooks<span class="token punctuation">[</span>currentHook<span class="token punctuation">]</span> <span class="token operator">||</span> initialValue      <span class="token keyword">const</span> setStateHookIndex <span class="token operator">=</span> currentHook      <span class="token keyword">const</span> setState <span class="token operator">=</span> newState <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>hooks<span class="token punctuation">[</span>setStateHookIndex<span class="token punctuation">]</span> <span class="token operator">=</span> newState<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">//  è¿”å› state ç„¶å currentHook+1</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>currentHook<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> setState<span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>  MyReact<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effect'</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> text<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> text<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    click<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    type<span class="token punctuation">:</span> txt <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setText</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span><span class="token punctuation">,</span>    noop<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span>    render<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> text <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> AppApp <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 0 foo</span><span class="token comment" spellcheck="true">// render {count: 0, text: 'foo'}</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 1 foo</span><span class="token comment" spellcheck="true">// render {count: 1, text: 'foo'}</span>App<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 1 bar</span><span class="token comment" spellcheck="true">// render {count: 1, text: 'bar'}</span>App<span class="token punctuation">.</span><span class="token function">noop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// // no effect run</span><span class="token comment" spellcheck="true">// render {count: 1, text: 'bar'}</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 2 bar</span><span class="token comment" spellcheck="true">// render {count: 2, text: 'bar'}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„å®ç°æˆ‘ä»¬åŸºæœ¬äº†è§£äº† hooks çš„å®ç°åŠåŸç†</p><ul><li>åˆ©ç”¨äº†é—­åŒ…æœºåˆ¶</li><li>æŒ‰ç…§æ‰§è¡Œé¡ºåºæ”¾å…¥ç»´æŠ¤çš„æ•°ç»„é˜Ÿåˆ—å’Œç´¢å¼•ä¸­</li><li>å½“è¿›è¡Œå–å€¼æ“ä½œåˆ™æŒ‰ç…§å‹æ ˆçš„é¡ºåºæ¥è¿›è¡Œå–å€¼å’Œåˆ¤æ–­é€»è¾‘</li></ul><h3 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="æ¨èé˜…è¯»"></a>æ¨èé˜…è¯»<hr></h3><p><a href="https://zh-hans.reactjs.org/docs/hooks-reference.html" target="_blank" rel="noopener">Hook API</a><br><a href="https://medium.com/@dan_abramov/making-sense-of-react-hooks-fdbde8803889" target="_blank" rel="noopener">ç†è§£ React Hook</a><br><a href="https://cloud.tencent.com/developer/article/1468196" target="_blank" rel="noopener">Hook åŸç†</a><br><a href="https://overreacted.io/making-setinterval-declarative-with-react-hooks/" target="_blank" rel="noopener">Hook çš„ä½¿ç”¨é—®é¢˜</a><br><a href="https://github.com/facebook/react/blob/master/packages/react/src/ReactHooks.js" target="_blank" rel="noopener">æºç </a></p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React åŸç†ä¹‹ setState æ‰§è¡Œæœºåˆ¶</title>
      <link href="/2019/10/09/react/library-react-state/"/>
      <url>/2019/10/09/react/library-react-state/</url>
      
        <content type="html"><![CDATA[<p>æåˆ° react çš„ setState å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬ä»¥å®é™…å¼€å‘ä¸­é‡åˆ°çš„å‡ ä¸ªé—®é¢˜ï¼Œæ¥å¼•å…¥ setState çš„æœºåˆ¶</p><h3 id="é—®é¢˜é›†åˆ"><a href="#é—®é¢˜é›†åˆ" class="headerlink" title="é—®é¢˜é›†åˆ"></a>é—®é¢˜é›†åˆ</h3><blockquote><p>setState æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ</p></blockquote><p><strong>1. ç”Ÿå‘½å‘¨æœŸå’Œåˆæˆäº‹ä»¶ä¸­</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹è°ƒç”¨"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å¼€å§‹è°ƒç”¨ 0</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count1"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// count1 0</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count2"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// count2 0</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ç»“æŸè°ƒç”¨"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ç»“æŸè°ƒç”¨ 0</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>2. å¼‚æ­¥ä»£ç å’ŒåŸç”Ÿäº‹ä»¶ä¸­</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹è°ƒç”¨"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å¼€å§‹è°ƒç”¨ 0</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count1"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// count1 1</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count2"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// count2 2</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ç»“æŸè°ƒç”¨"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ç»“æŸè°ƒç”¨ 2</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>3. è¿ç»­å¤šæ¬¡ setState</strong></p><p>å¦‚æœæƒ³è¦åœ¨ componentDidMount é˜¶æ®µç«‹å³æ‹¿åˆ°æ•°æ®å¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ¨¡å¼</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹è°ƒç”¨"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count1"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count2"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ç»“æŸè°ƒç”¨"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œç»“æœ</p><pre class="line-numbers language-md"><code class="language-md">å¼€å§‹è°ƒç”¨ 0ç»“æŸè°ƒç”¨ 0count1 1count2 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬å·²ç»çœ‹å‡ºäº†é—®é¢˜</p><ul><li>ä¸ºä»€ä¹ˆè¿ç»­ setState ä¹‹åå€¼ç»“æœç›¸åŒã€‚</li><li>ä¸ºä»€ä¹ˆåœ¨ç”Ÿå‘½å‘¨æœŸå’Œåˆæˆäº‹ä»¶ä¸­ä¸èƒ½åŠæ—¶çš„æ‹¿åˆ°ç»“æœã€‚</li><li>ä¸ºä»€ä¹ˆå¼‚æ­¥ä»£ç å’ŒåŸç”Ÿäº‹ä»¶ä¸­å°±èƒ½æ‹¿åˆ°ç»“æœäº†ï¼Œåˆ°åº•æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ã€‚</li></ul><p>é€šè¿‡å®˜ç½‘å¯¹<a href="https://reactjs.org/docs/react-component.html#setstate" target="_blank" rel="noopener">setState()</a>ä»‹ç»ï¼Œæˆ‘ä»¬å¤§æ¦‚æ€»ç»“å¦‚ä¸‹è¿™å‡ æ–¹é¢</p><ul><li>é€šè¿‡é˜Ÿåˆ—çš„å½¢å¼ä¿å­˜ç»„ä»¶çŠ¶æ€å¹¶é€šçŸ¥ React è¿™ä¸ªç»„ä»¶å’Œå®ƒçš„å­ç»„ä»¶éœ€è¦é‡æ–°æ¸²</li><li>å¹¶ä¸èƒ½æ€»æ˜¯ç«‹å³æ›´æ–°ç»„ä»¶ï¼Œä¹Ÿä¸èƒ½ä¿è¯æ›´æ–°åæ•°æ®ç«‹å³ç”Ÿæ•ˆ</li><li>æœ‰æ—¶å€™ä¼šæ‰¹é‡æ¨è¿Ÿæ›´æ–°ï¼Œå¦‚æœéœ€è¦åœ¨è°ƒç”¨åç›´æ¥æ‹¿åˆ°æ•°æ®å¯åˆ©ç”¨å›è°ƒæˆ–è€… componentDidUpdateï¼ˆå®˜ç½‘å»ºè®®ï¼‰</li><li>ä¼šæ‰§è¡Œæµ…åˆå¹¶æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ state </li><li>åœ¨åŒä¸€å‘¨æœŸé åçš„ setState()å°†ä¼šè¦†ç›–å‰ä¸€ä¸ª setSate() çš„å€¼(ç›¸åŒå±æ€§å)</li></ul><p>é€šè¿‡ä¸Šé¢çš„æ€»ç»“ï¼Œæˆ‘ä»¬å¯èƒ½å·²ç»è§£å†³äº†æå‡ºçš„é—®é¢˜ã€‚ä½†å®é™…ä¸Šè¿œè¿œæ²¡é‚£ä¹ˆç®€å•ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹æºç ä¸­ setStateã€‚æ­¤æ–‡ç« åˆ†æä¸º 16.9 ç‰ˆæœ¬ï¼ˆ 16.9å…³äºè°ƒåº¦å’Œ setState æ”¹åŠ¨è¿˜æ˜¯è›®å¤§çš„ç½‘ä¸Šé€šè¿‡æ‰¹å¤„ç†æ§åˆ¶æ ‡å¿—å·²ç»åœ¨æºç ä¸­ä¸è§äº†ï¼‰</p><p>ç”±äºæœ¬äººèƒ½åŠ›æœ‰é™æ‰€ä»¥ä¸ä¼šå°†æ•´ä¸ªæµç¨‹è¿›è¡Œåˆ†æå®Œæ¯•å› ä¸ºåœ¨setState åŒ…æ‹¬ç”Ÿå‘½å‘¨æœŸï¼Œç»„ä»¶æ¸²æŸ“ï¼Œäº‹ä»¶åˆæˆï¼Œæ‰¹å¤„ç†ç­‰å¤šå¤„éƒ½ä¼šæ¶‰åŠã€‚</p><p>æˆ‘ä»¬é€šè¿‡æºç æ¥çœ‹ä¸€ä¸‹ setState çš„æ‰§è¡Œè¿‡ç¨‹ã€‚ç”±äºæºç å¾ˆå¤šå¾ˆé•¿ï¼Œå¦‚æœä¸æƒ³äº†è§£æºç å¯ä»¥æŸ¥çœ‹æ–‡ç« åé¢çš„æ€»ç»“</p><h3 id="setStateå…¥å£"><a href="#setStateå…¥å£" class="headerlink" title="setStateå…¥å£"></a>setStateå…¥å£<hr></h3><p>å®šä¹‰åœ¨æ–‡ä»¶ <code>packages/react/src/ReactBaseClasses.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/*** æ€»æ˜¯ä½¿ç”¨ setState æ¥æ”¹å˜çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ this.state* æ— æ³•ä¿è¯ setState ä¼šç«‹å³æ›´æ–°ï¼Œæ‰€ä»¥è°ƒç”¨ this.state å¯èƒ½è¿˜æ˜¯æ—§å€¼ * æ— æ³•ä¿è¯å¯¹ setState çš„è°ƒç”¨å°†åŒæ­¥è¿è¡Œï¼Œä»–ä»¬å¯èƒ½ä¼šè¢«æ‰¹é‡å¤„ç†* å¯ä»¥æä¾›ä¸€ä¸ªå¯é€‰çš„å›è°ƒï¼Œå®ƒå°†åœ¨å¯¹ setState çš„è°ƒç”¨å®é™…å®Œæˆæ—¶æ‰§è¡Œ* setState ç¬¬ä¸€ä¸ªå‚æ•°ä¸º function æ—¶ï¼Œä¼šåœ¨å°†æ¥çš„æŸä¸ªæ—¶å€™å’Œç»„ä»¶å‚æ•°(state,props, context)ä¸€èµ·è¢«è°ƒç”¨(ä¸æ˜¯åŒæ­¥è°ƒç”¨)ã€‚è¿™äº›å€¼å¯ä»¥ä¸this.stateä¸åŒ* å› ä¸º function å¯èƒ½åœ¨ receiveProps ä¹‹å shouldComponentUpdateä¹‹å‰è°ƒç”¨ï¼Œnew stateã€propsã€contentè¿˜æ²¡æ›´æ–°åˆ°å½“å‰thisæŒ‡å‘çš„è¿™äº›å€¼ã€‚*/</span>Component<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setState <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>partialState<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">invariant</span><span class="token punctuation">(</span>    <span class="token keyword">typeof</span> partialState <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">||</span>      <span class="token keyword">typeof</span> partialState <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">||</span>      partialState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token string">"setState(...): takes an object of state variables to update or a "</span> <span class="token operator">+</span>      <span class="token string">"function which returns an object of state variables."</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token string">"setState"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬çœ‹åˆ° setState ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°</p><ul><li>partialState é€šè¿‡ invariant å‡½æ•°éªŒè¯æˆ‘ä»¬çŸ¥é“éœ€è¦å¯¹è±¡ã€å‡½æ•°ã€null</li><li>callback å›è°ƒå‡½æ•°</li></ul><p>partialState è¿™ä¸ªå‚æ•°ä¼ å…¥çš„æ˜¯ stateï¼Œä¹Ÿè®¸æ˜¯æ•´ä¸ªstateï¼Œä¹Ÿè®¸æ˜¯éƒ¨åˆ†ï¼Œä½†æ˜¯æœ€åéƒ½ä¼šè¢«æ‰§è¡Œæµ…åˆå¹¶ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> dontMutate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dontMutate<span class="token punctuation">)</span> <span class="token punctuation">{</span>  dontMutate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  nextState <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> nextState<span class="token punctuation">,</span> partialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>nextState<span class="token punctuation">,</span> partialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥æ‰§è¡Œäº† </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token string">"setState"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨è¿™é‡Œè°ƒç”¨äº† this.updater ä¸­çš„ enqueueSetState, è¿™æ˜¯ä¸€ä¸ª setState çš„é˜Ÿåˆ—ï¼ˆå‡†ç¡®çš„è¯´å®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼‰</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">,</span> updater<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å¦‚æœä¸€ä¸ªç»„ä»¶æœ‰å­—ç¬¦ä¸²å¼•ç”¨ï¼Œå°†åœ¨ä»¥ååˆ†é…ä¸€ä¸ªä¸åŒçš„å¯¹è±¡</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>refs <span class="token operator">=</span> emptyObject<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åˆå§‹åŒ–é»˜è®¤çš„ updater ï¼Œä½†æ˜¯åœ¨render çš„æ—¶å€™è¢«æ³¨å…¥çœŸæ­£çš„å€¼</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>updater <span class="token operator">=</span> updater <span class="token operator">||</span> ReactNoopUpdateQueue<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„æ³¨é‡Šæˆ‘ä»¬çœ‹åˆ° updater æœ‰ä¸€ä¸ªé»˜è®¤å€¼ï¼Œä½†æ˜¯çœŸæ­£çš„å€¼æ˜¯åœ¨ render çš„æ—¶å€™è¢«æ³¨å…¥çš„</p><h3 id="updater"><a href="#updater" class="headerlink" title="updater"></a>updater<hr></h3><p>é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª updater çš„æ•°æ®ç»“æ„ï¼Œå®šä¹‰åœ¨ <code>react\packages\react-reconciler\src\ReactFiberClassComponent</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//classComponent åˆå§‹åŒ–çš„æ—¶å€™æ‹¿åˆ°çš„ update ç»“æ„</span><span class="token keyword">const</span> classComponentUpdater <span class="token operator">=</span> <span class="token punctuation">{</span>  isMounted<span class="token punctuation">,</span>  <span class="token function">enqueueSetState</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// inst å°±æ˜¯ä¼ å…¥çš„ thisï¼Œé€šè¿‡ this è·å– fiber å¯¹è±¡ </span>    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è®¡ç®—å½“å‰æ—¶é—´</span>    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¼‚æ­¥åŠ è½½çš„è®¾ç½®</span>    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ ¹æ®è¶…æ—¶æ—¶é—´è®¾ç½®ä»»åŠ¡çš„ä¼˜å…ˆçº§</span>    <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>      currentTime<span class="token punctuation">,</span>      fiber<span class="token punctuation">,</span>      suspenseConfig<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ›å»º update ç»“æ„</span>    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ä¼ è¿›æ¥çš„ state</span>    update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// callback å°±æ˜¯ setState çš„å›è°ƒå‡½æ•° setstate({},()=>{})</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> undefined <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>revertPassiveEffectsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å°† update ç»“æ„æ”¾å…¥é˜Ÿåˆ—</span>    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ä»»åŠ¡è°ƒåº¦æµç¨‹</span>    <span class="token function">scheduleWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// æ›¿æ¢ state</span>  <span class="token function">enqueueReplaceState</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>      currentTime<span class="token punctuation">,</span>      fiber<span class="token punctuation">,</span>      suspenseConfig<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>    update<span class="token punctuation">.</span>tag <span class="token operator">=</span> ReplaceState<span class="token punctuation">;</span>    update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> undefined <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>revertPassiveEffectsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scheduleWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// å¼ºåˆ¶æ›´æ–° state</span>  <span class="token function">enqueueForceUpdate</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>      currentTime<span class="token punctuation">,</span>      fiber<span class="token punctuation">,</span>      suspenseConfig<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>    update<span class="token punctuation">.</span>tag <span class="token operator">=</span> ForceUpdate<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> undefined <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>revertPassiveEffectsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scheduleWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹ enqueueSetStateï¼Œé€šè¿‡ä¸Šé¢çš„æ³¨é‡Šæˆ‘ä»¬å¾ˆæ¸…æ¥šçš„çŸ¥é“æ¯ä¸ªæ–¹æ³•çš„ä½œç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ enqueueSetState çš„æµç¨‹</p><ul><li>è·å– this ä¸Šçš„ fiber å¯¹è±¡</li><li>è®¡ç®— currentTime æ—¶é—´</li><li>æ ¹æ® fiber å¯¹è±¡å’Œ currentTime æ—¶é—´ï¼Œè®¡ç®—è¶…æ—¶æ—¶é—´ </li><li>æ ¹æ® expirationTime åˆ›å»º update å¯¹è±¡</li><li>å°†ä¼ å…¥çš„ payload ä¹Ÿå°±æ˜¯ state èµ‹å€¼åˆ° update.payload</li><li>å¦‚æœ callback å­˜åœ¨å°† callback èµ‹å€¼åˆ° update.callback</li><li>å°† update æ¨å…¥ updateQueue é˜Ÿåˆ—</li><li>è¿›è¡Œä»»åŠ¡è°ƒåº¦</li></ul><p>å…³äº requestCurrentTimeã€ requestCurrentSuspenseConfigã€computeExpirationForFiber åœ¨è¿™é‡Œå°±ä¸å¤šåšè§£é‡Šã€‚è¯·æŸ¥çœ‹<a href="https://www.studyfe.cn/2019/10/04/react/library-react-fiber01/"> FiberRoot æ„å»ºè¿‡ç¨‹</a>å’Œ<a href="https://www.studyfe.cn/2019/10/06/react/library-react-fiber02/">FiberRoot è°ƒåº¦è¿‡ç¨‹</a></p><h3 id="createUpdate"><a href="#createUpdate" class="headerlink" title="createUpdate "></a>createUpdate <hr></h3><p>ä¸Šé¢ä»£ç  æ‰§è¡Œä¸€å…±æœ‰ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯ enqueueSetStateã€ enqueueReplaceStateã€enqueueForceUpdateï¼Œä»–ä»¬ä¸»è¦æ˜¯çš„åŒºåˆ«å°±æ˜¯åœ¨äº tag ä¸Šã€‚ä¹Ÿå°±æ˜¯ React çš„çŠ¶æ€æ›´æ–°åˆ†ä¸ºå››ç§æƒ…å†µ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> UpdateState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ReplaceState <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ForceUpdate <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> CaptureUpdate <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>  suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Update<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//è¶…æ—¶æ—¶é—´</span>    expirationTime<span class="token punctuation">,</span>    suspenseConfig<span class="token punctuation">,</span>    tag<span class="token punctuation">:</span> UpdateState<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//0æ›´æ–° 1æ›¿æ¢ 2å¼ºåˆ¶æ›´æ–° 3æ•è·æ›´æ–°</span>    <span class="token comment" spellcheck="true">//æ›´æ–°çš„ state</span>    payload<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//å¯¹åº”çš„å›è°ƒï¼Œæ¯”å¦‚setState({}, callback )</span>    callback<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//æŒ‡å‘ä¸‹ä¸€ä¸ªæ›´æ–°</span>    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//æŒ‡å‘ä¸‹ä¸€ä¸ªside effect</span>    nextEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦æ¥çœ‹çœ‹ enqueueUpdate è¿™ä¸ªå‡½æ•°,ä¹Ÿå°±æ˜¯å°† update æ¨å…¥ updateQueue é˜Ÿåˆ—</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// æ¯æ¬¡ setState éƒ½ä¼š updateï¼Œæ¯æ¬¡ updateï¼Œéƒ½ä¼šå…¥åŠ å…¥ updateQueue</span><span class="token keyword">export</span> <span class="token keyword">function</span> enqueueUpdate<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">(</span>fiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span> update<span class="token punctuation">:</span> Update<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// æ›´æ–°é˜Ÿåˆ—æ˜¯å»¶è¿Ÿåˆ›å»ºçš„.</span>  <span class="token comment" spellcheck="true">// fiber => current</span>  <span class="token comment" spellcheck="true">// alternate => workInProgress</span>  <span class="token keyword">const</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// current é˜Ÿåˆ—</span>  <span class="token keyword">let</span> queue1<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// alternate é˜Ÿåˆ—</span>  <span class="token keyword">let</span> queue2<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// currentåˆ°alternateå³workInProgressæœ‰ä¸€ä¸ªæ˜ å°„å…³ç³»</span>  <span class="token comment" spellcheck="true">// è¦ä¿è¯currentå’ŒworkInProgressçš„updateQueueæ˜¯ä¸€è‡´çš„</span>  <span class="token comment" spellcheck="true">// å¦‚æœ alternate é˜Ÿåˆ—æ˜¯ç©ºçš„ </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åªæœ‰ä¸€ä¸ª fiber.</span>    queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>    queue2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//å¦‚æœ current ä»ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–æ›´æ–°é˜Ÿåˆ—</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue1 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">createUpdateQueue</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å¦‚æœ alternate ä¸ä¸ºç©º åˆ™åˆ†åˆ«æ›´æ–°å„è‡ªçš„é˜Ÿåˆ—</span>    queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>    queue2 <span class="token operator">=</span> alternate<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue1 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue2 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// queue1 å’Œ queue2 çš„ fiber éƒ½æ²¡æœ‰æ›´æ–°é˜Ÿåˆ—ã€‚åˆ™åˆ›å»ºä¸€ä¸ªæ–°é˜Ÿåˆ—.</span>        queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">createUpdateQueue</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">;</span>        queue2 <span class="token operator">=</span> alternate<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">createUpdateQueue</span><span class="token punctuation">(</span>          alternate<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœ queue2å­˜åœ¨ï¼Œåˆ™åˆ©ç”¨ cloneUpdateQueue å…‹éš†ä¸€ä¸ªé˜Ÿåˆ—åˆ° queue1</span>        queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">cloneUpdateQueue</span><span class="token punctuation">(</span>queue2<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue2 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              queue2 <span class="token operator">=</span> alternate<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">cloneUpdateQueue</span><span class="token punctuation">(</span>queue1<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Both owners have an update queue.</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue2 <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> queue1 <span class="token operator">===</span> queue2<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åªæœ‰ä¸€ä¸ªé˜Ÿåˆ—.</span>    <span class="token function">appendUpdateToQueue</span><span class="token punctuation">(</span>queue1<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// å°†æ›´æ–°é™„åŠ åˆ°ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œ</span>     <span class="token comment" spellcheck="true">// åŒæ—¶è€ƒè™‘åˆ°åˆ—è¡¨çš„æŒä¹…ç»“æ„ä¸å¸Œæœ›å°†ç›¸åŒçš„æ›´æ–°æ·»åŠ å¤šæ¬¡</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue1<span class="token punctuation">.</span>lastUpdate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> queue2<span class="token punctuation">.</span>lastUpdate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å…¶ä¸­ä¸€ä¸ªé˜Ÿåˆ—ä¸æ˜¯ç©ºçš„ã€‚å°†æ›´æ–°æ·»åŠ åˆ°ä¸¤ä¸ªé˜Ÿåˆ—.</span>      <span class="token function">appendUpdateToQueue</span><span class="token punctuation">(</span>queue1<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">appendUpdateToQueue</span><span class="token punctuation">(</span>queue2<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ä¸¤ä¸ªé˜Ÿåˆ—éƒ½ä¸æ˜¯ç©ºçš„ã€‚ç”±äºç»“æ„å…±äº«ï¼Œè¿™ä¸¤ä¸ªåˆ—è¡¨ä¸­çš„æœ€æ–°æ›´æ–°æ˜¯ç›¸åŒçš„ã€‚</span>      <span class="token comment" spellcheck="true">// å› æ­¤ï¼Œåªå‘å…¶ä¸­ä¸€ä¸ªåˆ—è¡¨è¿½åŠ ã€‚</span>      <span class="token function">appendUpdateToQueue</span><span class="token punctuation">(</span>queue1<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// è¦æ›´æ–° queue2 çš„ `lastUpdate` æŒ‡é’ˆ.</span>      queue2<span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> update<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„æ³¨é‡Š</p><ul><li>queue1 æ˜¯ fiber.updateQueue;</li><li>queue2 æ˜¯ alternate.updateQueue</li><li>å¦‚æœéƒ½ä¸º nullï¼Œåˆ™è°ƒç”¨ createUpdateQueue() è·å–åˆå§‹é˜Ÿåˆ—</li><li>å¦‚æœæœ‰ä¸€ä¸ªä¸º nullï¼Œåˆ™è°ƒç”¨ cloneUpdateQueue() ä»å¯¹æ–¹ä¸­è·å–é˜Ÿåˆ—</li><li>å¦‚æœéƒ½ä¸ä¸º nullï¼Œåˆ™è°ƒç”¨ appendUpdateToQueue å°† update ä½œä¸º lastUpdate</li></ul><h3 id="createUpdateQueue"><a href="#createUpdateQueue" class="headerlink" title="createUpdateQueue "></a>createUpdateQueue <hr></h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä¸‹ä»£ç  createUpdateQueue åˆ›å»ºæ›´æ–°é˜Ÿåˆ—</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> createUpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">(</span>baseState<span class="token punctuation">:</span> State<span class="token punctuation">)</span><span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> queue<span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ›´æ–°åçš„ state</span>    baseState<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ª update</span>    firstUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ª update</span>    lastUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ•è·æ›´æ–°çš„ update</span>    firstCapturedUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ•è·æ›´æ–°çš„ update</span>    lastCapturedUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªside effect</span>    firstEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// æœ€åä¸€ä¸ªside effect</span>    lastEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªside æ•è·æ›´æ–° effect</span>    firstCapturedEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// æœ€åä¸€ä¸ªside æ•è·æ›´æ–° effect</span>    lastCapturedEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> queue<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„æ³¨é‡Šæˆ‘ä»¬æ¥æ•´ç†ä¸€ä¸‹</p><ul><li><p>baseState åœ¨ç»„ä»¶ setState åï¼Œæ¸²æŸ“å¹¶æ›´æ–°stateï¼Œåœ¨ä¸‹æ¬¡æ›´æ–°æ—¶ï¼Œæ‹¿çš„å°±æ˜¯è¿™æ¬¡æ›´æ–°è¿‡çš„state</p></li><li><p>firstUpdate å’Œ lastUpdate ä¹‹é—´çš„ update é€šè¿‡ä¸Šä¸ª update çš„ next ä¸²è”</p></li></ul><h3 id="cloneUpdateQueue"><a href="#cloneUpdateQueue" class="headerlink" title="cloneUpdateQueue"></a>cloneUpdateQueue</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// å…‹éš†æ›´æ–°é˜Ÿåˆ—</span><span class="token keyword">function</span> cloneUpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">(</span>  currentQueue<span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> queue<span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>    baseState<span class="token punctuation">:</span> currentQueue<span class="token punctuation">.</span>baseState<span class="token punctuation">,</span>    firstUpdate<span class="token punctuation">:</span> currentQueue<span class="token punctuation">.</span>firstUpdate<span class="token punctuation">,</span>    lastUpdate<span class="token punctuation">:</span> currentQueue<span class="token punctuation">.</span>lastUpdate<span class="token punctuation">,</span>    firstCapturedUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    lastCapturedUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    firstEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    lastEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    firstCapturedEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    lastCapturedEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> queue<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä»¥ä¸Šä»£ç æˆ‘ä»¬çŸ¥é“ UpdateQueue å®é™…ä¸Šæ˜¯ä¸€ä¸ª<a href="https://github.com/trekhleb/javascript-algorithms/blob/master/README.zh-CN.md" target="_blank" rel="noopener">é“¾è¡¨</a></p><img src="/images/updateQueue.jpg"><p>é€šè¿‡ä¸Šé¢çš„å›¾ç‰‡å±•ç¤º,æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹è§è¿™æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ã€‚å½“ç„¶å…·ä½“çš„æ“ä½œé“¾è¡¨çš„æ–¹æ³•æˆ‘å°±ä¸åœ¨è¿™é‡Œå±•å¼€äº†ã€‚</p><p>å…·ä½“çš„æ›´æ–°é˜Ÿåˆ—æ­¥éª¤å¦‚ä¸‹</p><ul><li>åˆ›å»ºæ›´æ–°é˜Ÿåˆ— createUpdateQueue()</li><li>æ›´æ–° state getStateFromUpdate()</li><li>å¤„ç†æ›´æ–° processUpdateQueue()</li><li>æäº¤æ›´æ–° commitUpdateQueue()</li></ul><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>react äº‹ä»¶ç³»ç»Ÿä¸­å’Œé€šè¿‡ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè°ƒç”¨çš„ setState åœ¨æ¨å…¥é˜Ÿåˆ—å‰é¢çš„é˜¶æ®µå®é™…ä¸Šéƒ½å¯ä»¥å±äºåŒæ­¥é˜¶æ®µï¼Œä½†åœ¨æ‰§è¡Œæ‰¹å¤„ç†åˆ°æ¸²æŸ“é˜¶æ®µéƒ½ä¼šè§¦å‘æ‰¹å¤„ç†ç”±äºè‡ªå®šä¹‰çš„ä¸€å¥—äº‹ä»¶ç³»ç»Ÿæ‰€ä»¥éƒ½æ˜¯å¼‚æ­¥ã€‚</p><p>ä½¿ç”¨åŸç”Ÿäº‹ä»¶ç›‘å¬å’Œ settimeout è¿™ç§å½“æ—¶ä¸ä¼šè§¦å‘æ­¤äº‹ä»¶ç³»ç»Ÿ ï¼Œä¹Ÿä¸ä¼šè§¦å‘æ‰¹å¤„ç†ï¼Œæ‰€ä»¥å¯ä»¥æ›´æ–° this.setState æ‰€ä»¥æ˜¯åŒæ­¥çš„ã€‚</p><h3 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="æ¨èé˜…è¯»"></a>æ¨èé˜…è¯»</h3><p> <a href="https://stackoverflow.com/questions/48563650/does-react-keep-the-order-for-state-updates/48610973#48610973" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆä¼šæ‰¹é‡æ‰§è¡Œ</a><br> <a href="https://github.com/facebook/react/issues/9439" target="_blank" rel="noopener">æŸäº›æƒ…å†µä¸‹ setState çš„å·¥ä½œæ–¹å¼</a><br> <a href="https://github.com/facebook/react/issues/11527#issuecomment-360199710" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆä¸ç›´æ¥æ›´æ–° this.state</a></p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React åŸç†ä¹‹ FiberRoot è°ƒåº¦è¿‡ç¨‹</title>
      <link href="/2019/10/06/react/library-react-fiber02/"/>
      <url>/2019/10/06/react/library-react-fiber02/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬å¯¹ fiber çš„åˆ›å»ºåšäº†å¤§æ¦‚çš„äº†è§£ï¼Œå¹¶ä¸”è¿˜å¼•å…¥äº† scheduleWork å‡½æ•°ã€‚scheduleWork å‡½æ•°å®é™…æ‰§è¡Œäº†å¦‚ä¸‹å‡ ä¸ªé‡è¦çš„å‡½æ•°</p><ul><li>checkForNestedUpdates åˆ¤æ–­æ˜¯å¦æœ‰æ— é™å¾ªç¯çš„ update</li><li>markUpdateTimeFromFiberToRoot æ‰¾åˆ° rootFiber å¹¶éå†æ›´æ–°å­èŠ‚ç‚¹çš„ expirationTime </li><li>checkForInterruption åˆ¤æ–­æ˜¯å¦æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</li><li>schedulePendingInteractions ç«‹å³æ‰§è¡Œè°ƒåº¦ä»»åŠ¡</li><li>scheduleCallbackForRoot å¼‚æ­¥ä»»åŠ¡ç«‹å³æ‰§è¡Œè°ƒåº¦ä»»åŠ¡</li><li>rootsWithPendingDiscreteUpdates å¾—åˆ° DiscreteTime</li></ul><h2 id="checkForNestedUpdates"><a href="#checkForNestedUpdates" class="headerlink" title="checkForNestedUpdates "></a>checkForNestedUpdates <hr></h2><blockquote><p>checkForNestedUpdates æœ€å¤§æ›´æ–°æ·±åº¦ä¸º 50ï¼Œé˜²æ­¢æ— é™å¾ªç¯ </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> NESTED_UPDATE_LIMIT <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span><span class="token keyword">let</span> nestedUpdateCount<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>nestedUpdateCount <span class="token operator">></span> NESTED_UPDATE_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>    nestedUpdateCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    rootWithNestedUpdates <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token function">invariant</span><span class="token punctuation">(</span>      <span class="token boolean">false</span><span class="token punctuation">,</span>      <span class="token string">'Maximum update depth exceeded. This can happen when a component '</span> <span class="token operator">+</span>        <span class="token string">'repeatedly calls setState inside componentWillUpdate or '</span> <span class="token operator">+</span>        <span class="token string">'componentDidUpdate. React limits the number of nested updates to '</span> <span class="token operator">+</span>        <span class="token string">'prevent infinite loops.'</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="markUpdateTimeFromFiberToRoot"><a href="#markUpdateTimeFromFiberToRoot" class="headerlink" title="markUpdateTimeFromFiberToRoot "></a>markUpdateTimeFromFiberToRoot <hr></h2><blockquote><p>markUpdateTimeFromFiberToRoot </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">markUpdateTimeFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//å¦‚æœfiberå¯¹è±¡çš„è¿‡æœŸæ—¶é—´å°äº expirationTimeï¼Œåˆ™æ›´æ–°fiberå¯¹è±¡çš„è¿‡æœŸæ—¶é—´</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">//å‘ä¸Šéå†çˆ¶èŠ‚ç‚¹ï¼Œç›´åˆ°rootèŠ‚ç‚¹ï¼Œåœ¨éå†çš„è¿‡ç¨‹ä¸­æ›´æ–°å­èŠ‚ç‚¹çš„expirationTime</span>  <span class="token keyword">let</span> node <span class="token operator">=</span> fiber<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ ‘çš„é¡¶å±‚èŠ‚ç‚¹ root</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    root <span class="token operator">=</span> fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      alternate <span class="token operator">=</span> node<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>        node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>          alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>          alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime        <span class="token punctuation">)</span> <span class="token punctuation">{</span>          alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>        alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>        alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">//å¦‚æœæ˜¯é¡¶å±‚ rootFiberï¼Œç»“æŸå¾ªç¯</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>        root <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Update the first and last pending expiration times in this root</span>    <span class="token keyword">const</span> firstPendingTime <span class="token operator">=</span> root<span class="token punctuation">.</span>firstPendingTime<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">></span> firstPendingTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>      root<span class="token punctuation">.</span>firstPendingTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> lastPendingTime <span class="token operator">=</span> root<span class="token punctuation">.</span>lastPendingTime<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastPendingTime <span class="token operator">===</span> NoWork <span class="token operator">||</span> expirationTime <span class="token operator">&lt;</span> lastPendingTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>      root<span class="token punctuation">.</span>lastPendingTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> root<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„å‡½æ•°æˆ‘ä»¬çŸ¥é“æ­¤å‡½æ•°æœ‰å¦‚ä¸‹ä½œç”¨</p><ul><li>æ›´æ–° fiber å¯¹è±¡çš„ expirationTime</li><li>æ ¹æ® fiber.return å‘ä¸Šéå†å¯»æ‰¾ FiberRootï¼Œå¹¶æ›´æ–°çˆ¶å¯¹è±¡çš„å­èŠ‚ç‚¹çš„ childExpirationTime</li><li>æ›´æ–°è¯¥ rootFiber çš„æ–°è€æŒ‚èµ·æ—¶é—´</li><li>è¿”å› FiberRoot</li></ul><h2 id="checkForInterruption"><a href="#checkForInterruption" class="headerlink" title="checkForInterruption "></a>checkForInterruption <hr></h2><blockquote><p>checkForInterruption</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">checkForInterruption</span><span class="token punctuation">(</span>  fiberThatReceivedUpdate<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>  updateExpirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    enableUserTimingAPI <span class="token operator">&amp;&amp;</span>    workInProgressRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>    updateExpirationTime <span class="token operator">></span> renderExpirationTime  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ‰“æ–­å½“å‰ä»»åŠ¡ï¼Œä¼˜å…ˆæ‰§è¡Œä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡</span>    interruptedBy <span class="token operator">=</span> fiberThatReceivedUpdate<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="schedulePendingInteractions"><a href="#schedulePendingInteractions" class="headerlink" title="schedulePendingInteractions"></a>schedulePendingInteractions<hr></h2><blockquote><p>schedulePendingInteractions</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯åŒæ­¥ä»»åŠ¡å¹¶ä¸”æ˜¯åˆæ¬¡æ¸²æŸ“çš„è¯ï¼Œåˆ™ä¼šå…ˆæ‰§è¡Œ</span>  <span class="token comment" spellcheck="true">// __interactionsRef è®¾ç½®å½“å‰è·Ÿè¸ªçš„ interactions æ ˆ</span>  <span class="token function">scheduleInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">,</span> __interactionsRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>scheduleInteractions</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// å’Œ schedule çš„äº¤äº’</span><span class="token keyword">function</span> <span class="token function">scheduleInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">,</span> interactions<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>interactions<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> pendingInteractionMap <span class="token operator">=</span> root<span class="token punctuation">.</span>pendingInteractionMap<span class="token punctuation">;</span>    <span class="token keyword">const</span> pendingInteractions <span class="token operator">=</span> pendingInteractionMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingInteractions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// éå†å¹¶æ›´æ–°è¿˜æœªè°ƒåº¦çš„åŒæ­¥ä»»åŠ¡çš„æ•°é‡</span>      interactions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>interaction <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pendingInteractions<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>interaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          interaction<span class="token punctuation">.</span>__count<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        pendingInteractions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>interaction<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// é‡æ–°è®¾ç½® fiberRoot ä¸Šçš„ pendingInteractionMap</span>      pendingInteractionMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>interactions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// è·å–å½“å‰è°ƒåº¦ä¸­åŒæ­¥ä»»åŠ¡çš„æ•°é‡</span>      interactions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>interaction <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        interaction<span class="token punctuation">.</span>__count<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> subscriber <span class="token operator">=</span> __subscriberRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> threadID <span class="token operator">=</span> <span class="token function">computeThreadID</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// åˆ©ç”¨çº¿ç¨‹å»æŸ¥çœ‹åŒæ­¥çš„æ›´æ–°ä»»åŠ¡æ˜¯å¦ä¼šæŠ¥é”™</span>      subscriber<span class="token punctuation">.</span><span class="token function">onWorkScheduled</span><span class="token punctuation">(</span>interactions<span class="token punctuation">,</span> threadID<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç  scheduleInteractions çš„ä¸»è¦ä½œç”¨æ˜¯</p><ul><li>è·å– fiber ä¸Šçš„ pendingInteractionMap å±æ€§</li><li>é€šè¿‡ pendingInteractionMap è·å– expirationTime</li><li>è·å–æ¯æ¬¡ schedule æ‰€éœ€çš„ update ä»»åŠ¡çš„é›†åˆ</li></ul><h2 id="scheduleCallbackForRoot"><a href="#scheduleCallbackForRoot" class="headerlink" title="scheduleCallbackForRoot"></a>scheduleCallbackForRoot<hr></h2><p>åœ¨render()ä¹‹åï¼Œç«‹å³æ‰§è¡Œè°ƒåº¦ä»»åŠ¡</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">scheduleCallbackForRoot</span><span class="token punctuation">(</span>  root<span class="token punctuation">:</span> FiberRoot<span class="token punctuation">,</span>  priorityLevel<span class="token punctuation">:</span> ReactPriorityLevel<span class="token punctuation">,</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// è·å–rootçš„å›è°ƒè¿‡æœŸæ—¶é—´</span>  <span class="token keyword">const</span> existingCallbackExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackExpirationTime<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ›´æ–°rootçš„å›è°ƒè¿‡æœŸæ—¶é—´</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackExpirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å½“æ–°çš„expirationTimeæ¯”å·²å­˜åœ¨çš„callbackçš„expirationTimeä¼˜å…ˆçº§æ›´é«˜çš„æ—¶å€™</span>    <span class="token keyword">const</span> existingCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// æ‰“æ–­å·²å­˜åœ¨çš„ callbackï¼‰</span>      <span class="token comment" spellcheck="true">// å°†å·²å­˜åœ¨çš„ callback èŠ‚ç‚¹ä»é“¾è¡¨ä¸­ç§»é™¤</span>      <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ›´æ–°callbackExpirationTime</span>    root<span class="token punctuation">.</span>callbackExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯åŒæ­¥ä»»åŠ¡</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// åœ¨ä¸´æ—¶é˜Ÿåˆ—ä¸­åŒæ­¥è¢«è°ƒåº¦çš„ callback</span>      root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span>        runRootCallback<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>          <span class="token keyword">null</span><span class="token punctuation">,</span>          root<span class="token punctuation">,</span>          renderRoot<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        <span class="token operator">!</span>disableSchedulerTimeoutBasedOnReactExpirationTime <span class="token operator">&amp;&amp;</span>        expirationTime <span class="token operator">!==</span> Never      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        options <span class="token operator">=</span> <span class="token punctuation">{</span>timeout<span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// callbackNode å³ç»è¿‡å¤„ç†åŒ…è£…çš„æ–°ä»»åŠ¡</span>      root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>        priorityLevel<span class="token punctuation">,</span>        runRootCallback<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>          <span class="token keyword">null</span><span class="token punctuation">,</span>          root<span class="token punctuation">,</span>          renderRoot<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>        options<span class="token punctuation">,</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        enableUserTimingAPI <span class="token operator">&amp;&amp;</span>        expirationTime <span class="token operator">!==</span> Sync <span class="token operator">&amp;&amp;</span>        <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¼€å§‹è°ƒåº¦ callback çš„æ ‡å¿—</span>        <span class="token function">startRequestCallbackTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// è·Ÿè¸ªé˜Ÿåˆ—ï¼Œå¹¶è®¡æ•°æ£€æŸ¥æ˜¯å¦æŠ¥é”™</span>  <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šè¿°ä»£ç æˆ‘ä»¬çŸ¥é“ scheduleCallbackForRoot çš„ä¸»è¦ä½œç”¨æ˜¯</p><ul><li>å¯¹æ¯”ä»»åŠ¡ä¼˜å…ˆçº§å¦‚æœæ–°çš„ scheduleCallback çš„ä¼˜å…ˆçº§æ›´é«˜æ—¶ï¼Œä¸­æ–­å½“å‰ä»»åŠ¡(cancelCallbackï¼‰</li><li>å¦‚æœæ˜¯åŒæ­¥ä»»åŠ¡ï¼Œè°ƒç”¨ scheduleSyncCallback åœ¨ä¸´æ—¶é˜Ÿåˆ—ä¸­è¿›è¡Œè°ƒåº¦ï¼Œå¦åˆ™æ›´æ–°è°ƒåº¦é˜Ÿåˆ—çš„çŠ¶æ€</li><li>è®¾ç½®å¼€å§‹è°ƒåº¦çš„æ—¶é—´èŠ‚ç‚¹å¹¶é€šè¿‡ schedulePendingInteractions è®¡æ•°è·Ÿè¸ªé˜Ÿåˆ—çš„æ›´æ–°æƒ…å†µ</li></ul><p>é€šè¿‡ä¸Šé¢ scheduleCallbackForRoot æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“ Fiber æœºåˆ¶å¯ä»¥ä¸ºæ¯ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¼˜å…ˆçº§æ’åºï¼ŒåŒæ—¶å¯ä»¥æ ¹æ®ä»»åŠ¡çš„ä¼˜å…ˆçº§ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå½“ä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡æ‰§è¡Œä¹‹åï¼Œè¿˜å¯ä»¥ç»§ç»­ä¹‹å‰è¢«ä¸­æ–­çš„ä»»åŠ¡ã€‚åœ¨è¿™ä¸ªæœŸé—´å¯ä»¥è®°å½•ä»»åŠ¡è°ƒåº¦æ‰§è¡Œåˆ°äº†å“ªé‡Œã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å…·ä½“çœ‹çœ‹ scheduleCallbackForRoot è°ƒç”¨çš„å‡ ä¸ªé‡è¦çš„æ–¹æ³•</p><h3 id="cancelCallback"><a href="#cancelCallback" class="headerlink" title="cancelCallback"></a>cancelCallback</h3><blockquote><p>cancelCallback ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</p></blockquote><p>å®šä¹‰åœ¨æ–‡ä»¶ /packages/react-reconciler/src/SchedulerWithReactIntegration.js</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cancelCallback</span><span class="token punctuation">(</span>callbackNode<span class="token punctuation">:</span> mixed<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackNode <span class="token operator">!==</span> fakeCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">Scheduler_cancelCallback</span><span class="token punctuation">(</span>callbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// å¼•å…¥çš„å•ç‹¬ Scheduler åº“</span><span class="token keyword">const</span> <span class="token punctuation">{</span> unstable_cancelCallback<span class="token punctuation">:</span> Scheduler_cancelCallback <span class="token punctuation">}</span> <span class="token operator">=</span> Scheduler<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å®šä¹‰åœ¨ packages/scheduler/src/Scheduler.js</span><span class="token keyword">function</span> <span class="token function">unstable_cancelCallback</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// è·å– callbackNode çš„ next èŠ‚ç‚¹ </span>  <span class="token keyword">var</span> next <span class="token operator">=</span> task<span class="token punctuation">.</span>next<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å¦‚æœç­‰äº null è¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»ä¸å­˜åœ¨</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Already cancelled.</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å¦‚æœ task === next ç›¸ç­‰è¯´æ˜é“¾è¡¨ç»“æ„ä¸­åªæœ‰ä¸€ä¸ª callbackNode </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// é‡ç½® firstTask / firstDelayedTask</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      firstTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> firstDelayedTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      firstDelayedTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å°† firstTask / firstDelayedTask æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      firstTask <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> firstDelayedTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      firstDelayedTask <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// é“¾è¡¨æ“ä½œ</span>    <span class="token keyword">var</span> previous <span class="token operator">=</span> task<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>    previous<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>    next<span class="token punctuation">.</span>previous <span class="token operator">=</span> previous<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// åˆ é™¤å·²ç»å­˜åœ¨çš„ callbackNode</span>  task<span class="token punctuation">.</span>next <span class="token operator">=</span> task<span class="token punctuation">.</span>previous <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç çš„ä¸Šä¸‹æ–‡æˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡æ“ä½œ schedule é“¾è¡¨ï¼Œé€šè¿‡å¯¹æ¯”æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„ä¼˜å…ˆçº§æ¥ç¡®å®šæ˜¯å¦è¦ç§»é™¤æ­£åœ¨æ‰§è¡Œçš„ callbackNodeï¼Œå°†èŠ‚ç‚¹æŒ‡å‘ä¸‹ä¸€ä¸ªè°ƒåº¦ä»»åŠ¡</p><h3 id="scheduleSyncCallback"><a href="#scheduleSyncCallback" class="headerlink" title="scheduleSyncCallback "></a>scheduleSyncCallback <hr></h3><blockquote><p>scheduleSyncCallback åŒæ­¥ä»»åŠ¡ï¼Œå°†è°ƒåº¦ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¹¶è¿”å›ä¸´æ—¶é˜Ÿåˆ—</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">:</span> SchedulerCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å°†æ­¤å›è°ƒæ¨å…¥å†…éƒ¨é˜Ÿåˆ—ï¼Œå¦‚æœåŒæ­¥é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–åŒæ­¥é˜Ÿåˆ—å¹¶åœ¨</span>  <span class="token comment" spellcheck="true">// åœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦çš„æ—¶å€™åˆ·æ–°ï¼Œæˆ–è€…æ›´æ—©çš„æ—¶å€™è°ƒç”¨â€˜flushSyncCallbackQueueâ€™ã€‚</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>syncQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    syncQueue <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æœ€å¿«åœ¨ä¸‹ä¸€æ¬¡åˆ·æ–°é˜Ÿåˆ—</span>    immediateQueueCallbackNode <span class="token operator">=</span> <span class="token function">Scheduler_scheduleCallback</span><span class="token punctuation">(</span>      Scheduler_ImmediatePriority<span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// å¾ªç¯éå† syncQueueï¼Œå¹¶æ›´æ–°èŠ‚ç‚¹çš„isSyncçŠ¶æ€ï¼Œæ›´æ–°åŒæ­¥é˜Ÿåˆ—</span>      flushSyncCallbackQueueImpl<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//å¦‚æœåŒæ­¥é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™å°† callback push åˆ°é˜Ÿåˆ—</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// push ç°æœ‰é˜Ÿåˆ—ã€‚ä¸éœ€è¦è°ƒåº¦ callbackï¼Œå› ä¸ºåœ¨åˆ›å»ºé˜Ÿåˆ—æ—¶å·²ç»è°ƒåº¦äº†å›è°ƒ</span>    syncQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> fakeCallbackNode<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="scheduleCallback"><a href="#scheduleCallback" class="headerlink" title="scheduleCallback"></a>scheduleCallback<hr></h3><blockquote><p>scheduleCallback å¼‚æ­¥ä»»åŠ¡ï¼Œå¯¹ callback è¿›è¡ŒåŒ…è£…è¿”å›æ–°çš„ task å¹¶æ›´æ–°è°ƒåº¦é˜Ÿåˆ—çš„çŠ¶æ€</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// è°ƒç”¨ Scheduler_scheduleCallback</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>  reactPriorityLevel<span class="token punctuation">:</span> ReactPriorityLevel<span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> SchedulerCallback<span class="token punctuation">,</span>  options<span class="token punctuation">:</span> SchedulerCallbackOptions <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">reactPriorityToSchedulerPriority</span><span class="token punctuation">(</span>reactPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">Scheduler_scheduleCallback</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// å¼•å…¥å•ç‹¬ scheduler åº“</span><span class="token keyword">const</span> <span class="token punctuation">{</span> unstable_scheduleCallback<span class="token punctuation">:</span> Scheduler_scheduleCallback <span class="token punctuation">}</span> <span class="token operator">=</span> Scheduler<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å®šä¹‰åœ¨ packages/scheduler/src/Scheduler.js</span><span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> startTime<span class="token punctuation">;</span>  <span class="token keyword">var</span> timeout<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åœ¨ä¸Šé¢æ‰§è¡ŒåŒæ­¥ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ä¹Ÿè°ƒç”¨äº†ä¸€æ¬¡ </span>  <span class="token comment" spellcheck="true">// scheduleCallback ä½†ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°</span>  <span class="token comment" spellcheck="true">// æ‰€ä»¥å¯ä»¥ç”¨æ¥åŒºåˆ†æ¥åŒºåˆ†æ‰§è¡Œçš„æ—¶å€™æ‰§è¡Œæ—¶æœº</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> options <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> delay <span class="token operator">=</span> options<span class="token punctuation">.</span>delay<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> delay <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> delay <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      startTime <span class="token operator">=</span> currentTime <span class="token operator">+</span> delay<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    timeout <span class="token operator">=</span>      <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>timeout <span class="token operator">===</span> <span class="token string">'number'</span>        <span class="token operator">?</span> options<span class="token punctuation">.</span>timeout        <span class="token punctuation">:</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**    * æ ¹æ®ä¼ å…¥ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¥åˆ¤æ–­å½“å‰æ‰§è¡Œçš„ timeout    * ç«‹å³æ‰§è¡Œ ImmediatePriority timeout -1     * ç”¨æˆ·äº¤äº’ä¼˜å…ˆçº§ UserBlockingPriority  timeout 250    * æ™®é€šä¼˜å…ˆçº§ NormalPriority timeout 5000    * é—²ç½®çš„ä¼˜å…ˆçº§ IdlePriority timeout 1073741823    * ä½ä¼˜å…ˆçº§ LowPriority timeout 10000    */</span>    timeout <span class="token operator">=</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>    startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// expirationTime = å½“å‰æ—¶é—´ + 5s å</span>  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> timeout<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ç»„æˆæ–°çš„ task ç»“æ„</span>  <span class="token keyword">var</span> newTask <span class="token operator">=</span> <span class="token punctuation">{</span>    callback<span class="token punctuation">,</span>    priorityLevel<span class="token punctuation">,</span>    startTime<span class="token punctuation">,</span>    expirationTime<span class="token punctuation">,</span>    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    previous<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å»¶æœŸä»»åŠ¡</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">></span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å°†å»¶æœŸçš„ task æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ </span>    <span class="token function">insertDelayedTask</span><span class="token punctuation">(</span>newTask<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//åˆ¤æ–­è°ƒåº¦é˜Ÿåˆ—çš„ firstTask ä»»åŠ¡ä¸º nullï¼Œå¹¶ä¸” firstDelayedTask è°ƒåº¦é˜Ÿåˆ—çš„å¤´ä»»åŠ¡æ­£å¥½æ˜¯ newTaskï¼Œ</span>    <span class="token comment" spellcheck="true">//è¯´æ˜æ‰€æœ‰ä»»åŠ¡å‡å»¶æœŸï¼Œå¹¶ä¸”æ­¤æ—¶çš„ä»»åŠ¡æ˜¯ç¬¬ä¸€ä¸ªå»¶æœŸä»»åŠ¡</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTask <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> firstDelayedTask <span class="token operator">===</span> newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¦‚æœå»¶è¿Ÿè°ƒåº¦å¼€å§‹çš„ flag ä¸º trueï¼Œåˆ™å–æ¶ˆå®šæ—¶çš„æ—¶é—´</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Cancel an existing timeout.</span>        <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// Schedule a timeout.</span>      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ­£å¸¸ä»»åŠ¡</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æŒ‰ç…§æ­£å¸¸çš„æ‰§è¡Œä»»åŠ¡æ’å…¥ task </span>    <span class="token function">insertScheduledTask</span><span class="token punctuation">(</span>newTask<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ˜¯å¦æ›´æ–°è°ƒåº¦çš„æ ‡å¿—</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPerformingWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// æ›´æ–°è°ƒåº¦æ‰§è¡Œ</span>      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> newTask<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ä»¬çŸ¥é“ Scheduler_scheduleCallback çš„ä¸»è¦ä½œç”¨æ˜¯</p><ul><li>ç¡®å®šå½“å‰æ—¶é—´ startTime å’Œå»¶è¿Ÿæ›´æ–°æ—¶é—´ timeout</li><li>æ–°å»º newTask åŒ…è£…å¯¹è±¡</li><li>å¦‚æœæ˜¯å»¶è¿Ÿä»»åŠ¡åˆ™å°† newTask æ”¾å…¥å»¶è¿Ÿè°ƒåº¦é˜Ÿåˆ—å¹¶æ‰§è¡Œ requestHostTimeout</li><li>å¦‚æœæ˜¯æ­£å¸¸ä»»åŠ¡åˆ™å°† newTask æ”¾å…¥æ­£å¸¸è°ƒåº¦é˜Ÿåˆ—å¹¶æ‰§è¡Œ requestHostCallback</li><li>è¿”å›æ–°çš„ newTask</li></ul><p>ä»ä¸Šé¢çš„æ®µè½æ€»ç»“ä¸­æˆ‘ä»¬çœ‹åˆ° Scheduler_scheduleCallback çš„ä½œç”¨ï¼Œæ ¹æ®ä»»åŠ¡çš„ä¸åŒå»æ‰§è¡Œäº† requestHostTimeout å’Œ requestHostCallbackï¼Œç”±äºè¿™ä¸¤ä¸ªæ–¹æ³•åˆ†ä¸ºé DOM ç¯å¢ƒå’Œ DOM ç¯å¢ƒï¼Œæˆ‘ä»¬åªçœ‹ DOM ç¯å¢ƒçš„å®ç°å³å¯</p><p>å®šä¹‰åœ¨æ–‡ä»¶ /packages/scheduler/src/forks/SchedulerHostConfig.default.js</p><h3 id="requestHostTimeout"><a href="#requestHostTimeout" class="headerlink" title="requestHostTimeout "></a>requestHostTimeout <hr></h3><blockquote><p>requestHostTimeout</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handleTimeout</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å»¶æœŸå¼€å¯çš„ flag</span>  isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ˜¯å¦å¼€å§‹æ›´æ–°è°ƒåº¦çš„ flag</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å¦‚æœç¬¬ä¸€ä¸ªä»»åŠ¡ä¸ä¸º null </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœç¬¬ä¸€ä¸ªå»¶æ—¶ä»»åŠ¡ä¸ä¸ºnull</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firstDelayedTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ç»§ç»­é€’å½’æ‰§è¡Œ requestHostTimeout</span>      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>        handleTimeout<span class="token punctuation">,</span>        firstDelayedTask<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">,</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>requestHostTimeout <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>  taskTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ç†è§£ä¸ºå¦‚æœæ˜¯å»¶æœŸçš„ä»»åŠ¡ï¼Œæ’å…¥é˜Ÿåˆ—ä¸­ã€‚é€šè¿‡è®¡ç®—å»¶æœŸä»»åŠ¡çš„æ—¶é—´å’Œå½“å‰çš„æœ€æ–°æ—¶é—´æ¥é€’å½’æ‰§è¡Œ requestHostTimeoutï¼Œç›´åˆ° isHostTimeoutScheduled æ ‡å¿—ä¸º true æ‰§è¡Œå–æ¶ˆå®šæ—¶å™¨å‡½æ•°ã€‚å½“ startTime &lt; currentTimeåæ’å…¥æ­£å¸¸ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œ requestHostCallback</p><h3 id="requestHostCallback"><a href="#requestHostCallback" class="headerlink" title="requestHostCallback"></a>requestHostCallback</h3><blockquote><p>requestHostCallback åœ¨æ¯ä¸€å¸§å†…æ‰§è¡Œè°ƒåº¦ä»»åŠ¡</p></blockquote><pre class="line-numbers language-js"><code class="language-js">requestHostCallback <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// callback å°±æ˜¯ flushWork å›è°ƒç”¨ workLoop æ¥æ‰§è¡Œä»»åŠ¡</span>  scheduledHostCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// é»˜è®¤ä¸º false</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableMessageLoopImplementation<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMessageLoopRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>      isMessageLoopRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// é»˜è®¤ä¸º false å½“æ‰§è¡Œä¸€æ¬¡å¾ªç¯å isRAFLoopRunning ä¸º true </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRAFLoopRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¼€å§‹ä¸€ä¸ª rAF (requestAnimationFrame) å¾ªç¯ã€‚</span>      isRAFLoopRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>rAFTime <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// é»˜è®¤ false </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestIdleCallbackBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">cancelIdleCallback</span><span class="token punctuation">(</span>idleCallbackID<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// é»˜è®¤ false </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestTimerEventBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">clearTimeout</span><span class="token punctuation">(</span>idleTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">onAnimationFrame</span><span class="token punctuation">(</span>rAFTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// å¦‚æœé”™è¿‡äº†ä¸Šä¸€ä¸ª vsyncï¼Œä¸‹ä¸€ä¸ª rAF å¯èƒ½å°±ä¸ä¼šå‡ºç°åœ¨å¦ä¸€ä¸ªå¸§ä¸Š</span>      <span class="token comment" spellcheck="true">// ä¸ºäº†äº‰å–å°½å¯èƒ½å¤šçš„ç©ºé—²æ—¶é—´ï¼Œä½¿ç”¨ requestIdleCallback å‘å¸ƒä¸€ä¸ªå›è°ƒ</span>      <span class="token comment" spellcheck="true">// å¦‚æœå¸§ä¸­è¿˜æœ‰ç©ºé—²æ—¶é—´ï¼Œå®ƒåº”è¯¥è¢«è§¦å‘ã€‚è¿™æ ·å°±ä¸ä¼šå½±å“é¡µé¢çš„åˆ·æ–°æ¸²æŸ“ï¼Œç”¨æˆ·ä¸ä¼šæ„Ÿåˆ°å¡é¡¿</span>      <span class="token keyword">let</span> idleCallbackID<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>requestIdleCallbackBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>        idleCallbackID <span class="token operator">=</span> <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>          <span class="token keyword">function</span> <span class="token function">onIdleCallbackBeforeFirstFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestTimerEventBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">clearTimeout</span><span class="token punctuation">(</span>idleTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            frameDeadline <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> frameLength<span class="token punctuation">;</span>            <span class="token function">performWorkUntilDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// å¦‚æœè¿™æ˜¯åœ¨ rAF ä¹‹å‰è§¦å‘çš„ï¼Œåˆ™å¾ˆå¯èƒ½è¡¨ç¤ºåœ¨ä¸‹ä¸€æ¬¡ vsync ä¹‹å‰æœ‰ç©ºé—²æ—¶é—´ã€‚</span>      <span class="token keyword">let</span> idleTimeoutID<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>requestTimerEventBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>        idleTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">onTimerEventBeforeFirstFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>requestIdleCallbackBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">cancelIdleCallback</span><span class="token punctuation">(</span>idleCallbackID<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          frameDeadline <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> frameLength<span class="token punctuation">;</span>          <span class="token function">performWorkUntilDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢çš„ä»£ç ä¸­å¤§æ¦‚çŸ¥é“ requestHostCallback ä¸»è¦æ˜¯è°ƒç”¨äº†å¦‚ä¸‹å‡ ä¸ªæ–¹æ³•</p><ul><li>requestAnimationFrame</li><li>onAnimationFrame</li><li>requestIdleCallback</li><li>performWorkUntilDeadline</li></ul><p>ä¸‹é¢æˆ‘ä»¬å¯¹ä¸Šé¢çš„æ–¹æ³•æ…¢æ…¢æ‹†è§£</p><blockquote><p>requestAnimationFrame å®šä¹‰ä¸º window.requestAnimationFrame</p></blockquote><p>è¯¥æ–¹æ³•å‘Šè¯‰æµè§ˆå™¨ä½ å¸Œæœ›æ‰§è¡Œä¸€ä¸ªåŠ¨ç”»ï¼Œå¹¶ä¸”è¦æ±‚æµè§ˆå™¨åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°æ›´æ–°åŠ¨ç”»ã€‚è¯¥æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨æµè§ˆå™¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰æ‰§è¡Œï¼ˆ<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame" target="_blank" rel="noopener">æ¥è‡³MDN</a>ï¼‰</p><blockquote><p>onAnimationFrame</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> onAnimationFrame <span class="token operator">=</span> rAFTime <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledHostCallback <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    prevRAFTime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    prevRAFInterval <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    isRAFLoopRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// åœ¨å¸§çš„å¼€å¤´å®‰æ’ä¸‹ä¸€ä¸ªåŠ¨ç”»å›è°ƒ</span>  <span class="token comment" spellcheck="true">// è¿™æ ·èƒ½å¤Ÿç¡®ä¿å®ƒåœ¨å°½å¯èƒ½æ—©çš„æ¡†æ¶å†…è¢«è§¦å‘ï¼Œå¦‚æœç­‰åˆ°å¸§çš„æœ«å°¾æ‰å‘å¸ƒå›è°ƒ</span>  <span class="token comment" spellcheck="true">// é‚£ä¹ˆå°±å†’ç€æµè§ˆå™¨è·³è¿‡ä¸€å¸§çš„é£é™©ï¼Œç›´åˆ°é‚£ä¹‹åçš„å¸§æ‰è§¦å‘å›è°ƒ</span>  <span class="token comment" spellcheck="true">// å¦‚æœè°ƒåº¦å™¨é˜Ÿåˆ—åœ¨å¸§ç»“æŸæ—¶ä¸æ˜¯ç©ºçš„ï¼Œå®ƒå°†ç»§ç»­åœ¨å›è°ƒä¸­åˆ·æ–°</span>  <span class="token comment" spellcheck="true">// å¦‚æœé˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå®ƒå°†ç«‹å³é€€å‡º</span>  isRAFLoopRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>nextRAFTime <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>rAFTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">onAnimationFrame</span><span class="token punctuation">(</span>nextRAFTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> onTimeout <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    frameDeadline <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> frameLength <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token function">performWorkUntilDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    rAFTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>onTimeout<span class="token punctuation">,</span> frameLength <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  rAFTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>onTimeout<span class="token punctuation">,</span> frameLength <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    prevRAFTime <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>    <span class="token comment" spellcheck="true">// ç¡®ä¿è¿™æ¬¡ rAF çš„æ—¶é—´ä¸ä¸Šæ¬¡ä¸åŒï¼Œä¿è¯ä¸å†åŒä¸€å¸§å†…åŒæ—¶æ‰§è¡Œä»»åŠ¡</span>    rAFTime <span class="token operator">-</span> prevRAFTime <span class="token operator">></span> <span class="token number">0.1</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> rAFInterval <span class="token operator">=</span> rAFTime <span class="token operator">-</span> prevRAFTime<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fpsLocked <span class="token operator">&amp;&amp;</span> prevRAFInterval <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// è§‚å¯Ÿä¸¤ä¸ªè¿ç»­çš„å¸§é—´éš”ã€‚ä½¿ç”¨å®ƒæ¥åŠ¨æ€è°ƒæ•´å¸§é€Ÿç‡ã€‚</span>      <span class="token comment" spellcheck="true">// å¦‚æœä¸€å¸§å¾ˆé•¿ï¼Œé‚£ä¹ˆä¸‹ä¸€å¸§å°±ä¼šå¾ˆçŸ­ã€‚å¦‚æœè¿ç»­ä¸¤å¸§éƒ½å¾ˆçŸ­ï¼Œé‚£å°±è¯´æ˜æˆ‘ä»¬çš„å¸§ç‡æ¯”å½“å‰ä¼˜åŒ–çš„å¸§ç‡è¦é«˜ã€‚</span>      <span class="token comment" spellcheck="true">// åŠ¨æ€è°ƒæ•´å¸§ç‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ 120h zæ˜¾ç¤ºå™¨æˆ– 90hz VR æ˜¾ç¤ºå™¨ä¸Šè¿è¡Œã€‚å–ä¸¤ä¸ªä¸­çš„æœ€å¤§å€¼ï¼Œä»¥é˜²å…¶ä¸­ä¸€ä¸ªç”±äºé”™è¿‡å¸§è€Œå¼‚å¸¸</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>rAFInterval <span class="token operator">&lt;</span> frameLength <span class="token operator">&amp;&amp;</span> prevRAFInterval <span class="token operator">&lt;</span> frameLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>        frameLength <span class="token operator">=</span>          rAFInterval <span class="token operator">&lt;</span> prevRAFInterval <span class="token operator">?</span> prevRAFInterval <span class="token punctuation">:</span> rAFInterval<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>frameLength <span class="token operator">&lt;</span> <span class="token number">8.33</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// é˜²å¾¡æ€§ç¼–ç ã€‚ä¸æ”¯æŒé«˜äº120hzçš„å¸§é€Ÿç‡</span>          <span class="token comment" spellcheck="true">// å¦‚æœè®¡ç®—å‡ºçš„å¸§é•¿åº¦å°äº8ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªbug </span>          frameLength <span class="token operator">=</span> <span class="token number">8.33</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    prevRAFInterval <span class="token operator">=</span> rAFInterval<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  prevRAFTime <span class="token operator">=</span> rAFTime<span class="token punctuation">;</span>  frameDeadline <span class="token operator">=</span> rAFTime <span class="token operator">+</span> frameLength<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ä½¿ç”¨ postMessage æŠ€å·§å°†ç©ºé—²çš„ä»»åŠ¡å»¶è¿Ÿåˆ°é‡æ–°ç»˜åˆ¶ä¹‹å</span>  port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>requestIdleCallback å®šä¹‰ä¸º window.requestIdleCallback</p></blockquote><p>window.requestIdleCallback()æ–¹æ³•å°†åœ¨æµè§ˆå™¨çš„ç©ºé—²æ—¶æ®µå†…è°ƒç”¨çš„å‡½æ•°æ’é˜Ÿã€‚è¿™ä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿåœ¨ä¸»äº‹ä»¶å¾ªç¯ä¸Šæ‰§è¡Œåå°å’Œä½ä¼˜å…ˆçº§å·¥ä½œï¼Œè€Œä¸ä¼šå½±å“å»¶è¿Ÿå…³é”®äº‹ä»¶ï¼Œå¦‚åŠ¨ç”»å’Œè¾“å…¥å“åº”ã€‚å‡½æ•°ä¸€èˆ¬ä¼šæŒ‰å…ˆè¿›å…ˆè°ƒç”¨çš„é¡ºåºæ‰§è¡Œï¼Œç„¶è€Œï¼Œå¦‚æœå›è°ƒå‡½æ•°æŒ‡å®šäº†æ‰§è¡Œè¶…æ—¶æ—¶é—´timeoutï¼Œåˆ™æœ‰å¯èƒ½ä¸ºäº†åœ¨è¶…æ—¶å‰æ‰§è¡Œå‡½æ•°è€Œæ‰“ä¹±æ‰§è¡Œé¡ºåºã€‚<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" target="_blank" rel="noopener">æ¥è‡³MDN</a></p><blockquote><p>performWorkUntilDeadline </p></blockquote><p>ç”±äº enableMessageLoopImplementation ä¸º false æ‰€ä»¥æˆ‘ä»¬åªçœ‹ else ä¸­çš„é€»è¾‘</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> performWorkUntilDeadline <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableMessageLoopImplementation<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å½“å‰æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledHostCallback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// </span>      <span class="token keyword">const</span> hasTimeRemaining <span class="token operator">=</span> frameDeadline <span class="token operator">-</span> currentTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¼€å§‹æ‰§è¡Œä»»åŠ¡</span>        <span class="token keyword">const</span> hasMoreWork <span class="token operator">=</span> <span class="token function">scheduledHostCallback</span><span class="token punctuation">(</span>          hasTimeRemaining<span class="token punctuation">,</span>          currentTime<span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è°ƒåº¦ä»»åŠ¡ç»“æŸ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasMoreWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>          scheduledHostCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æµè§ˆå™¨ç»˜åˆ¶çš„æ ‡å¿—</span>    needsPaint <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2<span class="token punctuation">;</span>channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> performWorkUntilDeadline<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡æ‹†è§£æ³¨é‡Šæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ requestHostCallback çš„ä¸»è¦ä½œç”¨</p><ul><li>åˆ©ç”¨æµè§ˆå™¨çš„ window.requestAnimationFrame API åœ¨æ¯ä¸€å¸§ä¹‹åçš„ç©ºé—²æ—¶é—´å¼€å§‹æ‰§è¡Œä»»åŠ¡ã€‚</li><li>onAnimationFrame ä¼šåŠ å…¥ event loopï¼Œè¿›è¡Œé€’å½’ä¹Ÿå°±æ˜¯æ¯ä¸€å¸§æ‰§è¡Œä¸€æ¬¡ï¼Œå½“ä¸‹ä¸€å¸§æ‰§è¡Œ onAnimationFrame çš„æ—¶å€™ï¼Œä¹‹å‰å°±å·²ç»è®¡ç®—å‡ºäº† nextRAFTimeã€‚ç›´åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºã€‚</li><li>åœ¨æ‰§è¡Œ onAnimationFrame æœŸé—´å¯¹ frameDeadline è¿›è¡Œè®¡ç®— <code>frameDeadline = getCurrentTime() + frameLength / 2</code> å¾—åˆ°å½“å‰å¸§çš„æˆªæ­¢æ—¶é—´ï¼ˆ33.33/2ï¼‰16.7ms</li><li>å¦‚æœé”™è¿‡äº†ä¸Šä¸€ä¸ªrequestAnimationFrameï¼Œåˆ™é€šè¿‡ window.requestIdleCallback åœ¨å‘å¸ƒä¸€ä¸ªå›è°ƒï¼Œåœ¨å¸§ä¸­è¿˜æœ‰ç©ºä½™æ—¶é—´çš„æ—¶å€™ä¼šè¢«è§¦å‘ï¼Œè¿™æ ·ç”¨æˆ·å°±ä¸ä¼šæ„Ÿè§‰åˆ°å¡é¡¿ã€‚</li><li>æœ€åé€šè¿‡ onmessage æ¥å— postMessage æŒ‡ä»¤, è§¦å‘æ¶ˆæ¯äº‹ä»¶çš„æ‰§è¡Œæœ€ç»ˆæ‰§è¡Œ scheduledHostCallbackï¼ˆä¹Ÿå°±æ˜¯ flushWorkï¼‰</li></ul><p>ä¸Šé¢è¯´åˆ° scheduledHostCallback å®é™…ä¸Šå°±æ˜¯ flushWorkï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æ flushWork </p><h3 id="flushWork"><a href="#flushWork" class="headerlink" title="flushWork"></a>flushWork</h3><blockquote><p>flushWork</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">flushWork</span><span class="token punctuation">(</span>hasTimeRemaining<span class="token punctuation">,</span> initialTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// è°ƒåº¦ä»»åŠ¡æ˜¯å¦æ‰§è¡Œçš„æ ‡å¿—</span>  isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>    isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> currentTime <span class="token operator">=</span> initialTime<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ£€æŸ¥æ˜¯å¦æœ‰æ²¡è¿‡æœŸçš„ä»»åŠ¡ï¼Œå¹¶æŠŠå®ƒä»¬åŠ å…¥åˆ°æ–°çš„è°ƒåº¦é˜Ÿåˆ—ä¸­</span>  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  isPerformingWork <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// hasTimeRemaining = frameDeadline - currentTime > 0</span>    <span class="token comment" spellcheck="true">// åœ¨ä¸€å¸§å†…æ‰§è¡Œçš„æ—¶é—´è¶…æ—¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasTimeRemaining<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ä¸€ç›´æ‰§è¡Œè¿‡æœŸçš„ä»»åŠ¡ï¼Œç›´åˆ°åˆ°è¾¾ä¸€ä¸ªä¸è¿‡æœŸçš„ä»»åŠ¡ä¸ºæ­¢</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>        firstTask <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>        <span class="token comment" spellcheck="true">// å¦‚æœ firstTask.expirationTimeä¸€ç›´ >= currentTimeï¼Œåˆ™é€’å½’æ‰§è¡Œ flushTask æ–¹æ³•</span>        firstTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime <span class="token operator">&amp;&amp;</span>        <span class="token operator">!</span><span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">flushTask</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ä¸æ–­åˆ·æ–°å›è°ƒï¼Œç›´åˆ°åœ¨å¸§ä¸­è€—å°½æ—¶é—´</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>          <span class="token function">flushTask</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>          currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>          firstTask <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>          <span class="token comment" spellcheck="true">// æ¯”è¾ƒ frameDeadline å’Œ currentTimeï¼Œå¦‚æœå½“å‰å¸§è¿˜æœ‰æ—¶é—´çš„è¯ï¼Œå°±ä¸€ç›´æ‰§è¡Œ</span>          <span class="token operator">!</span><span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>          <span class="token operator">!</span><span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Return whether there's additional work</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>firstDelayedTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ‰§è¡Œå»¶æœŸçš„ä»»åŠ¡</span>        <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>          handleTimeout<span class="token punctuation">,</span>          firstDelayedTask<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    isPerformingWork <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢æ³¨é‡Šæˆ‘ä»¬äº†è§£åˆ° flushWork çš„ä¸»è¦ä½œç”¨</p><ul><li>åˆ¤æ–­æ˜¯å¦æ˜¯è¶…æ—¶ä»»åŠ¡ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ cancelHostTimeout å–æ¶ˆæ‰§è¡Œçš„è°ƒåº¦ä»»åŠ¡</li><li>è°ƒç”¨ advanceTimers é‡æ–°æ£€æŸ¥æ˜¯å¦æœ‰æ²¡è¿‡æœŸçš„ä»»åŠ¡ï¼Œå°†ä»–ä»¬åŠ å…¥åˆ°æ–°çš„è°ƒåº¦é˜Ÿåˆ—</li><li>æ‰§è¡Œè°ƒåº¦é˜Ÿåˆ—å°† isPerformingWork æ ‡å¿—æ”¹ä¸º true </li><li>åˆ¤æ–­ä¸€å¸§å†…çš„å‰©ä½™æ—¶é—´ï¼Œæ‰§è¡Œè°ƒåº¦é˜Ÿåˆ—ï¼Œåˆ†ä¸ºä»¥ä¸‹æƒ…å†µ</li></ul><p><strong>å¦‚æœå‰©ä½™æ—¶é—´å°äº0ï¼Œè°ƒåº¦é˜Ÿåˆ—å­˜åœ¨ä¸”è°ƒåº¦ä»»åŠ¡è¿‡æœŸ</strong></p><ol><li>è°ƒç”¨ flushTask()ï¼Œä»è°ƒåº¦é˜Ÿåˆ—ä¸­å–å‡ºè°ƒåº¦ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œä¹‹åå°†è°ƒåº¦ä»»åŠ¡ç”Ÿå‡ºçš„å­è°ƒåº¦ä»»åŠ¡æ’å…¥åˆ°å…¶å</li><li>è°ƒç”¨ getCurrentTime()ï¼Œåˆ·æ–°å½“å‰æ—¶é—´</li><li>è°ƒç”¨ advanceTimers()ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä¸è¿‡æœŸçš„ä»»åŠ¡ï¼Œå¹¶æŠŠå®ƒä»¬åŠ å…¥åˆ°æ–°çš„è°ƒåº¦é˜Ÿåˆ—ä¸­ </li></ol><p><strong>å¦‚æœå‰©ä½™æ—¶é—´å¤§äº0ï¼Œè°ƒåº¦é˜Ÿåˆ—å­˜åœ¨ä¸”è°ƒåº¦ä»»åŠ¡æœªè¢«ä¸­æ–­</strong></p><ol><li>è°ƒç”¨ flushTask()ï¼Œä»è°ƒåº¦é˜Ÿåˆ—ä¸­å–å‡ºè°ƒåº¦ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œæ‰§è¡Œè°ƒåº¦ä»»åŠ¡ç”Ÿå‡ºçš„å­è°ƒåº¦ä»»åŠ¡</li><li>è°ƒç”¨ getCurrentTime()ï¼Œåˆ·æ–°å½“å‰æ—¶é—´</li><li>è°ƒç”¨ advanceTimers()ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä¸è¿‡æœŸçš„ä»»åŠ¡ï¼Œå¹¶æŠŠå®ƒä»¬åŠ å…¥åˆ°æ–°çš„è°ƒåº¦é˜Ÿåˆ—ä¸­</li></ol><p>å¦‚æœè°ƒåº¦ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseï¼Œæ‰§è¡Œå»¶æœŸçš„ä»»åŠ¡</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤ï¼ŒReact çš„åŸºç¡€è°ƒåº¦æµç¨‹ä¾¿ç®—æ˜¯èµ°äº†ä¸€éï¼Œä¸‹é¢æˆ‘ä»¬å°±16.9ç‰ˆæœ¬ä»£ç çš„æ‰§è¡Œé¡ºåºçœ‹ä¸€ä¸‹æµç¨‹å›¾<br><image src="/images/library-react-schedule.jpg"></image></p><p>å…¶å®16.9å’Œ16.8 åœ¨è°ƒåº¦æµç¨‹ä¸Šè¿˜æ˜¯æœ‰ä¸€å®šåŒºåˆ«çš„é‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹16.8çš„æ•´ä¸ªè°ƒåº¦æµç¨‹ï¼Œå¯¹æ¯”å­¦ä¹ ï¼Œæ›´æœ‰åŠ©äºåŠ æ·±ç†è§£ã€‚<br><image src="/images/scheduler-fiber-scheduler.png"></image></p><h2 id="ç›¸å…³æ–‡ç« "><a href="#ç›¸å…³æ–‡ç« " class="headerlink" title="ç›¸å…³æ–‡ç« "></a>ç›¸å…³æ–‡ç« </h2><p><a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener">React Fiber(æ—¶é—´åˆ†ç‰‡)</a></p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React åŸç†ä¹‹ FiberRoot æ„å»ºè¿‡ç¨‹</title>
      <link href="/2019/10/04/react/library-react-fiber01/"/>
      <url>/2019/10/04/react/library-react-fiber01/</url>
      
        <content type="html"><![CDATA[<p>fiber æ˜¯å½“å‰æ•´ä¸ª react æ ¸å¿ƒéƒ¨åˆ†ï¼Œå…¶ä¸­åŒ…å«äº†å¤§é‡çš„è®¡ç®—æœºçŸ¥è¯†ã€‚å¦‚æœé˜…è¯» react çš„æºç èƒ½è®©äººæ„Ÿè§‰åˆ°æ— åŠ›ã€‚</p><p>æ¯æ¬¡ç‰ˆæœ¬æ›´æ–°ï¼Œæ ¸å¿ƒéƒ¨åˆ†çš„å‡½æ•°æ€»æ˜¯è¦åŠ¨é‚£ä¹ˆä¸€åŠ¨ã€‚ä» 15, åˆ° 16 åˆ° 16.8ã€16.9 åˆ°ç°åœ¨çš„ 16.10ï¼ŒåŒ…æ‹¬ç°åœ¨å·²ç»æ”¹ç‰ˆçš„ vue3.0 ç€å®è®©äººéš¾å—ã€‚ä½†æ˜¯å­¦ä¹ çš„æ­¥ä¼è¿˜æ˜¯ä¸èƒ½åœä¸‹ã€‚react ç³»åˆ—æ–‡ç« ä¸»è¦æ˜¯ä¾èµ– 16.9 çš„æºç è¿›è¡Œåˆ†æã€‚</p><p>æˆ‘ä»¬è¨€å½’æ­£ä¼ ï¼Œè¿™ä¸€ç« åˆ°åé¢çš„å‡ ç¯‡æ–‡ç« éƒ½æ˜¯å¯¹ fiber çš„å­¦ä¹ å’Œç†è§£åŒ…æ‹¬æ„å»ºã€è°ƒåº¦ã€æ›´æ–°ç­‰ã€‚å¦‚æœ‰é”™è¯¯æ¬¢è¿åœ¨ git åšå®¢é¡¹ç›®ä¸‹æäº¤ issueã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-fiber"><a href="#ä»€ä¹ˆæ˜¯-fiber" class="headerlink" title="ä»€ä¹ˆæ˜¯ fiber"></a>ä»€ä¹ˆæ˜¯ fiber<hr></h2><p>Fiber çš„ä¸­æ–‡è§£é‡Šæ˜¯çº¤ç¨‹ï¼Œæ˜¯çº¿ç¨‹çš„é¢—ç²’åŒ–çš„ä¸€ä¸ªæ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒ…å«å¤šä¸ª Fiberã€‚å¯ä»¥ä½¿åŒæ­¥è®¡ç®—å˜å¾—è¢«æ‹†è§£ã€å¼‚æ­¥åŒ–ï¼Œä½¿æµè§ˆå™¨ä¸»çº¿ç¨‹å¾—ä»¥è°ƒæ§ã€‚</p><p>é€šè¿‡æŠŠæ›´æ–°è¿‡ç¨‹ç¢ç‰‡åŒ–ï¼Œå½“æ‰§è¡Œå®Œä¸€æ®µæ›´æ–°çš„æ—¶å€™ï¼ŒæŠŠæ§åˆ¶æƒäº¤è¿˜ç»™ React è´Ÿè´£ä»»åŠ¡åè°ƒçš„æ¨¡å—ï¼Œé€šè¿‡è°ƒåº¦ç³»ç»Ÿçš„ä»»åŠ¡çš„ä¼˜å…ˆçº§å»æ‰§è¡Œæ›´æ–°æ“ä½œã€‚</p><h2 id="åˆ›å»º-FiberRoot"><a href="#åˆ›å»º-FiberRoot" class="headerlink" title="åˆ›å»º FiberRoot"></a>åˆ›å»º FiberRoot<hr></h2><p>ä¸‹é¢æˆ‘ä»¬å°± FiberRoot çš„åˆ›å»ºæ¥å¼€å§‹æˆ‘ä»¬çš„è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬åœ¨ <a href="https://www.studyfe.cn/2019/10/01/react/library-react-jsx/">jsx</a> è½¬æ¢çš„æ—¶å€™ä»‹ç»è¿‡ jsx ä¸»è¦æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™é€šè¿‡ React.createElement è¿™ä¸ªå‡½æ•°è¿›è¡Œè½¬æ¢çš„ï¼Œé‚£ä¹ˆè½¬æ¢åçš„ä»£ç ä¼šåœ¨ ReactDOM.render ä¸­è¿›è¡Œæ‰§è¡Œï¼Œé¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ ReactDOM.render çš„æ‰§è¡Œå‡½æ•°ï¼Œå®šä¹‰åœ¨æ–‡ä»¶ <code>packages/react-dom/src/client/ReactDOM.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> ReactDOM<span class="token punctuation">:</span> Object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ...</span>  <span class="token function">hydrate</span><span class="token punctuation">(</span>element<span class="token punctuation">:</span> React$Node<span class="token punctuation">,</span> container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span> callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">invariant</span><span class="token punctuation">(</span>      <span class="token function">isValidContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token string">'Target container is not a DOM element.'</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// TODO: throw or warn if we couldn't hydrate?</span>    <span class="token keyword">return</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>      <span class="token keyword">null</span><span class="token punctuation">,</span>      element<span class="token punctuation">,</span>      container<span class="token punctuation">,</span>      <span class="token boolean">true</span><span class="token punctuation">,</span>      callback<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span>    element<span class="token punctuation">:</span> React$Element<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">,</span>    container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>    callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">invariant</span><span class="token punctuation">(</span>      <span class="token function">isValidContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token string">'Target container is not a DOM element.'</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>      <span class="token keyword">null</span><span class="token punctuation">,</span>      element<span class="token punctuation">,</span>      container<span class="token punctuation">,</span>      <span class="token boolean">false</span><span class="token punctuation">,</span>      callback<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»è¿‡ä¸Šé¢çš„éƒ¨åˆ†ä»£ç æˆ‘ä»¬å·²ç»çœ‹åˆ°äº† render å‡½æ•°ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œ render å‡½æ•°ä¹‹å‰æ‰§è¡Œäº† hydrate å‡½æ•°ï¼Œè¿™æ®µä»£ç æ˜¯ React16 æ–°å¢çš„ä¸»è¦æ˜¯ä½¿â½¤ç”¨æœåŠ¡ç«¯æ¸²æŸ“å’Œæœ¬åœ° DOM è¿›ï¨ˆè°ƒå’Œï¼Œé€šè¿‡å‚æ•°åŒºåˆ†æ˜¯å¦æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Œæœ€ååœ¨åˆ›å»º fiberRoot è¿‡ç¨‹ä¸­åšåŒºåˆ†ã€‚å…·ä½“è¿‡ç¨‹åœ¨åé¢ä¼šä½œå‡ºåˆ†æã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ render å‡½æ•°ï¼Œé€šè¿‡ invariant éªŒè¯æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ DOM element ç„¶åæ‰§è¡Œäº†ä¸€ä¸ªä¸»è¦çš„æ–¹æ³• legacyRenderSubtreeIntoContainer</p><h3 id="legacyRenderSubtreeIntoContainer"><a href="#legacyRenderSubtreeIntoContainer" class="headerlink" title="legacyRenderSubtreeIntoContainer "></a>legacyRenderSubtreeIntoContainer <hr></h3><blockquote><p>legacyRenderSubtreeIntoContainer æ–¹æ³•ä¸»è¦çš„ä½œç”¨æ˜¯</p></blockquote><ul><li>è°ƒç”¨ legacyCreateRootFromDOMContainer ç»™ root å…ƒç´ æ‰“ä¸Šæ ‡è¯† _reactRootContainerï¼Œè¿™é‡Œé¢çš„ forceHydrate å°±æ˜¯åŒºåˆ†æ˜¯å¦æ˜¯æœåŠ¡ç«¯çš„æ ‡å¿— </li><li>è°ƒç”¨ ReactSyncRoot åˆ›å»º fiberRoot</li><li>è°ƒç”¨ unbatchedUpdatesï¼Œç¬¬ä¸€æ¬¡æ¸²æŸ“æ˜¯ä¸ä½¿ç”¨æ‰¹é‡æ›´æ–°ã€‚æœ€åè°ƒç”¨ updateContainer æ›´æ–°å­èŠ‚ç‚¹ï¼Œç”Ÿæˆå®Œæ•´çš„ fiber æ ‘</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// æ¸²æŸ“Dom Treeåˆ°æŒ‚è½½çš„containerèŠ‚ç‚¹ä¸Š</span><span class="token keyword">function</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>  parentComponent<span class="token punctuation">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">,</span>  children<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>  container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>  forceHydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// åˆ¤æ–­container æ˜¯å¦æœ‰_reactRootContainerå±æ€§ï¼Œæ­£å¸¸æƒ…å†µç¬¬ä¸€æ¬¡æ¸²æŸ“ container æ˜¯ä¸ä¼šæœ‰ _reactRootContainer å±æ€§çš„</span>  <span class="token keyword">let</span> root<span class="token punctuation">:</span> _ReactSyncRoot <span class="token operator">=</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_reactRootContainer<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> fiberRoot<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åˆæ¬¡æ¸²æŸ“ï¼Œåˆå§‹åŒ– root å¯¹è±¡</span>    root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>      container<span class="token punctuation">,</span>      forceHydrate<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ç»“åˆ ReactSyncRoot å‡½æ•° this._internalRoot = root;  </span>    <span class="token comment" spellcheck="true">// fiberRoot ä¸º createContainer å‡½æ•°è¿”å›ç»“æœ</span>    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>      callback <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>        originalCallback<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// åˆæ¬¡æ¸²æŸ“ä¸ä½¿ç”¨æ‰¹é‡æ›´æ–°.</span>    <span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// æ‰¹é‡æ›´æ–°å­èŠ‚ç‚¹</span>      <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>      callback <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>        originalCallback<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Update</span>    <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„å¤§è‡´æµç¨‹ï¼Œæ¥è¯¦ç»†çš„è¯´æ˜ä¸‰ä¸ªæ­¥éª¤ä¸­çš„æ‰§è¡Œè¿‡ç¨‹</p><h3 id="legacyCreateRootFromDOMContainer"><a href="#legacyCreateRootFromDOMContainer" class="headerlink" title="legacyCreateRootFromDOMContainer "></a>legacyCreateRootFromDOMContainer <hr></h3><blockquote><p>legacyCreateRootFromDOMContainerï¼Œæ­¤æ–¹æ³•çš„ä½œç”¨æ˜¯</p></blockquote><ul><li>åˆ¤æ–­æ˜¯å¦æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æ ‡å¿— shouldHydrate</li><li>æ¸…é™¤æ‰€æœ‰å­å…ƒç´  removeChild</li><li>è¿”å› ReactSyncRoot çš„å®ä¾‹</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>  container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>  forceHydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> _ReactSyncRoot <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// é€šè¿‡ä¼ é€’è¿‡æ¥çš„ hydrate æ ‡å¿—ï¼Œæ¥ç¡®å®šæ˜¯å¦ä¼šè°ƒå’Œï¼ˆå¤ç”¨ï¼‰åŸæ¥å­˜åœ¨çš„ dom èŠ‚ç‚¹ï¼Œä»¥æé«˜æ€§èƒ½ï¼Œä¹‹ååœ¨å’Œæ–°æ¸²æŸ“çš„èŠ‚ç‚¹è¿›è¡Œåˆå¹¶</span>  <span class="token keyword">const</span> shouldHydrate <span class="token operator">=</span> forceHydrate <span class="token operator">||</span> <span class="token function">shouldHydrateDueToLegacyHeuristic</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldHydrate<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> warned <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> rootSibling<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ é™¤container ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rootSibling <span class="token operator">=</span> container<span class="token punctuation">.</span>lastChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ...</span>      <span class="token punctuation">}</span>      container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>rootSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// root æ˜¯åŒæ­¥æ›´æ–°çš„.</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactSyncRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> LegacyRoot<span class="token punctuation">,</span> shouldHydrate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ReactSyncRoot"><a href="#ReactSyncRoot" class="headerlink" title="ReactSyncRoot "></a>ReactSyncRoot <hr></h3><blockquote><p>ReactSyncRootï¼Œæ­¤æ–¹æ³•ä¸»è¦çš„ä½œç”¨æ˜¯</p></blockquote><ul><li>è°ƒç”¨ createContainer</li><li>åˆ›å»ºäº†ä¸€ä¸ª fiberRoot è¿›è¡Œèµ‹å€¼</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">ReactSyncRoot</span><span class="token punctuation">(</span>  container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>  tag<span class="token punctuation">:</span> RootTag<span class="token punctuation">,</span>  hydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å°† createContainer è¿”å›çš„å€¼èµ‹å€¼ç»™å®ä¾‹çš„ _internalRoot</span>  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> root<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="createContainer"><a href="#createContainer" class="headerlink" title="createContainer "></a>createContainer <hr></h3><blockquote><p>createContainer æ­¤æ–¹æ³•ä¸»è¦æ¥æºäº <code>react-reconciler/inline.dom</code></p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>  computeUniqueAsyncExpiration<span class="token punctuation">,</span>  findHostInstanceWithNoPortals<span class="token punctuation">,</span>  updateContainerAtExpirationTime<span class="token punctuation">,</span>  flushRoot<span class="token punctuation">,</span>  createContainer<span class="token punctuation">,</span>  updateContainer<span class="token punctuation">,</span>  batchedEventUpdates<span class="token punctuation">,</span>  batchedUpdates<span class="token punctuation">,</span>  unbatchedUpdates<span class="token punctuation">,</span>  discreteUpdates<span class="token punctuation">,</span>  flushDiscreteUpdates<span class="token punctuation">,</span>  flushSync<span class="token punctuation">,</span>  flushControlled<span class="token punctuation">,</span>  injectIntoDevTools<span class="token punctuation">,</span>  getPublicRootInstance<span class="token punctuation">,</span>  findHostInstance<span class="token punctuation">,</span>  findHostInstanceWithWarning<span class="token punctuation">,</span>  flushPassiveEffects<span class="token punctuation">,</span>  IsThisRendererActing<span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-reconciler/inline.dom'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°å¼•å…¥çš„è¿™ä¸ªæ–‡ä»¶é‡Œé¢å®šä¹‰çš„å¾ˆå¤šç›¸å…³æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿›å…¥è¿™ä¸ªæ–‡ä»¶</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./src/ReactFiberReconciler'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é€šè¿‡åå­—å°±èƒ½çœ‹åˆ°è¿™æ˜¯ fiber çš„æ„å»ºæ–‡ä»¶ï¼Œè¿›å…¥è¿™ä¸ªæ–‡ä»¶æŸ¥çœ‹ createContainer</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>  containerInfo<span class="token punctuation">:</span> Container<span class="token punctuation">,</span>  tag<span class="token punctuation">:</span> RootTag<span class="token punctuation">,</span>  hydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> OpaqueRoot <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ–¹æ³•ä¸»è¦çš„ä½œç”¨æ˜¯</p><ul><li>è¿”å› createFiberRoot æ–¹æ³•çš„å€¼</li></ul><h3 id="createFiberRoot"><a href="#createFiberRoot" class="headerlink" title="createFiberRoot"></a>createFiberRoot<hr></h3><blockquote><p>createFiberRoot æ–¹æ³•æ¥æºäºæ–‡ä»¶ <code>./ReactFiberRoot</code>ï¼Œæ­¤æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯</p></blockquote><ul><li>è°ƒç”¨ createHostRootFiber å‡½æ•°è¿”å›  uninitializedFiber</li><li>å°† uninitializedFibe èµ‹å€¼åœ¨ root å¯¹è±¡çš„ current ä¸Š</li><li>å°† root èµ‹å€¼ç»™ uninitializedFiber.stateNode</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>  containerInfo<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  tag<span class="token punctuation">:</span> RootTag<span class="token punctuation">,</span>  hydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> FiberRoot <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// root èŠ‚ç‚¹æ˜¯ fiber</span>  <span class="token keyword">const</span> root<span class="token punctuation">:</span> FiberRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å¾ªç¯ç»“æ„ï¼Œè¿›è¡Œç›¸äº’å¼•ç”¨</span>  <span class="token comment" spellcheck="true">// æ­¤å¤„å®é™…ä¸Šä¸€ä¸ªå•å‘é“¾è¡¨çš„ä¸²è”æ–¹å¼ï¼Œç”¨è¿™ä¸ªæ•°æ®ç»“æ„æŠŠæ•´ä¸ª fiber æ ‘ä¸²è”èµ·æ¥</span>  <span class="token keyword">const</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// current æ˜¯ uninitializedFiber</span>  <span class="token comment" spellcheck="true">// æ¯ä¸€ä¸ª ReactElment èŠ‚ç‚¹éƒ½å¯¹åº”ä¸€ä¸ª fiber å¯¹è±¡ï¼Œä¹Ÿå°±ä¼šæœ‰ä¸€ä¸ªæ ‘çŠ¶ç»“æ„</span>  <span class="token comment" spellcheck="true">// root.current æ˜¯å½“å‰çš„ fiber å¯¹è±¡çš„æ ‘çŠ¶ç»“æ„çš„é¡¶ç‚¹</span>  root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>  uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>  <span class="token keyword">return</span> root<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„æ–¹æ³•æˆ‘ä»¬çŸ¥é“æ‰§è¡Œäº† FiberRootNode å’Œ createHostRootFiber æ¥åˆ›å»ºæ•´ä¸ªç»“æ„æˆ‘ä»¬å¿…é¡»æ¸…æ¥šä»–ä»¬æ˜¯ä»€ä¹ˆå…³ç³»</p><ul><li>root æ˜¯ ReactRoot å®ä¾‹ï¼Œ</li><li>root._internalRoot æ˜¯ fiberRoot å®ä¾‹ï¼Œ</li><li>root._internalRoot.current æ˜¯ Fiber å®ä¾‹ï¼Œ</li><li>root._internalRoot.current.stateNode = root._internalRoot</li></ul><h3 id="FiberRootNode"><a href="#FiberRootNode" class="headerlink" title="FiberRootNode "></a>FiberRootNode <hr></h3><blockquote><p>new FiberRootNode æ­¤æ–¹æ³•çš„ä½œç”¨æ˜¯åˆ›å»º FiberRootNodeï¼Œä¹Ÿå°±æ˜¯ fiber çš„ root èŠ‚ç‚¹ </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// æ ‡è®°ä¸åŒçš„ç»„ä»¶ç±»å‹</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å¯¹åº”çš„ root èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯å¯¹åº”çš„ fiber å¯¹è±¡</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// dom ä¸Šçš„ root èŠ‚ç‚¹ render é‡Œæ¥æ”¶çš„ç¬¬äºŒä¸ªå‚æ•°</span>  <span class="token comment" spellcheck="true">// ReactDOM.render(element, document.getElementById('root'));</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>containerInfo <span class="token operator">=</span> containerInfo<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åœ¨æŒä¹…æ›´æ–°ä¸­ç”¨åˆ°</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pingCache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// è®°å½•æ›´æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œåœ¨commit é˜¶æ®µåªä¼šå¤„ç†è¿™ä¸ªå€¼å¯¹åº”çš„ä»»åŠ¡</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åœ¨ä»»åŠ¡è¢«æŒ‚èµ·çš„æ—¶å€™é€šè¿‡ setTimeout è®¾ç½®çš„è¿”å›å†…å®¹ï¼Œç”¨æ¥ä¸‹â¼€æ¬¡å¦‚æœæœ‰æ–°çš„ä»»åŠ¡æŒ‚èµ·æ—¶æ¸…ï§¤è¿˜æ²¡è§¦å‘çš„ timeout</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> noTimeout<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ˜¯å¦è¿›è¡Œè°ƒåˆæ ‡å¿—</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>hydrate <span class="token operator">=</span> hydrate<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>firstBatch <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>callbackExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>firstPendingTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>lastPendingTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pingTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>interactionThreadID <span class="token operator">=</span> <span class="token function">unstable_getThreadID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedInteractions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingInteractionMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥ä¼šæ‰§è¡Œ createHostRootFiber</p><h3 id="createHostRootFiber"><a href="#createHostRootFiber" class="headerlink" title="createHostRootFiber "></a>createHostRootFiber <hr></h3><blockquote><p>createHostRootFiber æ¥æºäº <code>./ReactFiber</code>ï¼Œæ­¤æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯</p></blockquote><ul><li>é€šè¿‡ RootTag æ¥è¿›è¡Œå¯¹æ¯”åŒºåˆ†åˆ›å»º fiber çš„æ¨¡å¼</li><li>æ‰§è¡Œ createFiber å‡½æ•°ï¼Œæ‹¿åˆ°è¿”å›å€¼</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> RootTag<span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token punctuation">{</span>  <span class="token keyword">let</span> mode<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> ConcurrentRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mode <span class="token operator">=</span> ConcurrentMode <span class="token operator">|</span> BatchedMode <span class="token operator">|</span> StrictMode<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> BatchedRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mode <span class="token operator">=</span> BatchedMode <span class="token operator">|</span> StrictMode<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    mode <span class="token operator">=</span> NoMode<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer <span class="token operator">&amp;&amp;</span> isDevToolsPresent<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mode <span class="token operator">|</span><span class="token operator">=</span> ProfileMode<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>HostRoot<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ä¸Šé¢çš„å¯¹æ¯”è¿‡ç¨‹æœ‰å‡ ä¸ªå˜é‡æˆ‘è§‰å¾—æŒºæœ‰æ„æ€ï¼Œå¦‚æœå…¶ä»–åŒå­¦ä¸æ„Ÿå…´è¶£å¯ä»¥ç›´æ¥ç•¥è¿‡ä»¥ä¸‹æ­¤éƒ¨åˆ†</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>ConcurrentRoot<span class="token punctuation">,</span> BatchedRoot<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared/ReactRootTags'</span><span class="token punctuation">;</span><span class="token keyword">export</span> type RootTag <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> LegacyRoot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> BatchedRoot <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ConcurrentRoot <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>  NoMode<span class="token punctuation">,</span>  ConcurrentMode<span class="token punctuation">,</span>  ProfileMode<span class="token punctuation">,</span>  StrictMode<span class="token punctuation">,</span>  BatchedMode<span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactTypeOfMode'</span><span class="token punctuation">;</span><span class="token keyword">export</span> type TypeOfMode <span class="token operator">=</span> number<span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> NoMode <span class="token operator">=</span> <span class="token number">0b0000</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> StrictMode <span class="token operator">=</span> <span class="token number">0b0001</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ä» root ä¸­è¯»å–æ•°æ®ï¼Œåˆ é™¤ BatchedMode å’Œ ConcurrentMode</span><span class="token keyword">export</span> <span class="token keyword">const</span> BatchedMode <span class="token operator">=</span> <span class="token number">0b0010</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ConcurrentMode <span class="token operator">=</span> <span class="token number">0b0100</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ProfileMode <span class="token operator">=</span> <span class="token number">0b1000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢äºŒè¿›åˆ¶è®¡ç®—ï¼Œæ¥ç¡®å®š expiriation-time æ¨¡å¼ï¼Œå…³äºæ­¤æ¨¡å¼æˆ‘ä»¬ä¼šåœ¨åç»­æ–‡ç« ä¸­è¿›è¡Œä»‹ç»ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ createFiber</p><h3 id="createFiber"><a href="#createFiber" class="headerlink" title="createFiber "></a>createFiber <hr></h3><blockquote><p>createFiber æ­¤æ–¹æ³•ä¸»è¦çš„ä½œç”¨æ˜¯è¿”å›äº† FiberNode çš„å®ä¾‹ è¿›è¡Œ FiberNode çš„åˆå§‹åŒ–</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> createFiber <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>  tag<span class="token punctuation">:</span> WorkTag<span class="token punctuation">,</span>  pendingProps<span class="token punctuation">:</span> mixed<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>  mode<span class="token punctuation">:</span> TypeOfMode<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// $FlowFixMe: the shapes are exact here but Flow doesn't like constructors</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FiberNode</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> key<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="FiberNode"><a href="#FiberNode" class="headerlink" title="FiberNode "></a>FiberNode <hr></h3><blockquote><p>FiberNode</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span>  tag<span class="token punctuation">:</span> WorkTag<span class="token punctuation">,</span>  pendingProps<span class="token punctuation">:</span> mixed<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>  mode<span class="token punctuation">:</span> TypeOfMode<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Instance</span>  <span class="token comment" spellcheck="true">// åŒºåˆ† fiberçš„ä¸åŒç±»å‹ï¼Œæ ‡è®°ä¸åŒçš„ç»„ä»¶ç±»å‹</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ReactElementé‡Œé¢çš„key</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// è°ƒç”¨`createElement`çš„ç¬¬ä¸€ä¸ªå‚æ•°</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>elementType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å¼‚æ­¥ç»„ä»¶resolvedä¹‹åè¿”å›çš„å†…å®¹ï¼Œä¸€èˆ¬æ˜¯`function`æˆ–è€…`class`</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å¯¹åº”èŠ‚ç‚¹çš„å®ä¾‹ </span>  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Fiber å•é“¾è¡¨ç»“æ„æ ‘ç»“æ„.</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åœ¨ setState ä¹‹å pendingProps é‡Œå­˜çš„æ–°çš„ props </span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åœ¨ setState ä¹‹å memoizedProps å­˜çš„è€çš„ props</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åœ¨ setState æˆ–è€… forceUpdate åˆ›å»ºæ›´æ–°ä¹‹åå°±ä¼šå­˜åœ¨æ­¤é˜Ÿåˆ—é‡Œï¼Œä¹Ÿæ˜¯å•å‘é“¾è¡¨ç»“æ„</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// èŠ‚ç‚¹çš„æ›´æ–°æ¨¡å¼</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Effects</span>  <span class="token comment" spellcheck="true">// æ ‡è®°æœ€ç»ˆdomèŠ‚ç‚¹è¦è¿›è¡Œå“ªäº›æ›´æ–°çš„å·¥å…·</span>  <span class="token comment" spellcheck="true">// æ ‡è®°æ˜¯å¦æ‰§è¡Œç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„å†…å®¹</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>effectTag <span class="token operator">=</span> NoEffect<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦çš„è¿‡æœŸæ—¶é—´</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„åˆå§‹åŒ– fiberRoot çš„è¿‡ç¨‹å°±ç»“æŸäº†ï¼Œåœ¨åˆ›å»º fiberRoot çš„åŒæ—¶è¿˜è¿›è¡Œäº† </p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢æˆ‘ä»¬å°±çœ‹çœ‹æ€ä¹ˆæ›´æ–°çš„å­èŠ‚ç‚¹</p><h3 id="unbatchedUpdates"><a href="#unbatchedUpdates" class="headerlink" title="unbatchedUpdates"></a>unbatchedUpdates</h3><p>åˆ›å»ºå®Œ fiberRoot åœ¨ unbatchedUpdates ä¸­æ‰§ï¨ˆ updateContainer å¯¹å®¹å™¨å†…å®¹è¿›â¾ï¤æ–°ã€‚é‚£ä¹ˆåœ¨æ‰§è¡Œæ›´æ–°ä¹‹å‰ unbatchedUpdates åšäº†ä»€ä¹ˆï¼Ÿæ¥ä¸‹æ¥è¿›å…¥ unbatchedUpdates</p><blockquote><p>unbatchedUpdates ä¸ä¼šè¿›è¡Œæ‰¹é‡æ›´æ–°ï¼Œå®šä¹‰åœ¨æ–‡ä»¶ <code>packages/react-reconciler/src/ReactFiberWorkLoop.js</code> ä¸­</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> unbatchedUpdates<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>fn<span class="token punctuation">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span> A<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> R<span class="token punctuation">,</span> a<span class="token punctuation">:</span> A<span class="token punctuation">)</span><span class="token punctuation">:</span> R <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// type ExecutionContext = number;</span>  <span class="token comment" spellcheck="true">// const NoContext = </span><span class="token comment" spellcheck="true">/*                    */</span> <span class="token number">0b000000</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const BatchedContext = </span><span class="token comment" spellcheck="true">/*               */</span> <span class="token number">0b000001</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const EventContext = </span><span class="token comment" spellcheck="true">/*                 */</span> <span class="token number">0b000010</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const DiscreteEventContext = </span><span class="token comment" spellcheck="true">/*         */</span> <span class="token number">0b000100</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const LegacyUnbatchedContext = </span><span class="token comment" spellcheck="true">/*       */</span> <span class="token number">0b001000</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const RenderContext = </span><span class="token comment" spellcheck="true">/*                */</span> <span class="token number">0b010000</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const CommitContext = </span><span class="token comment" spellcheck="true">/*                */</span> <span class="token number">0b100000</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// let executionContext: ExecutionContext = NoContext;</span>  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>  executionContext <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>BatchedContext<span class="token punctuation">;</span>  executionContext <span class="token operator">|</span><span class="token operator">=</span> LegacyUnbatchedContext<span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// åˆ·æ–°åœ¨æ­¤æ‰¹å¤„ç†æœŸé—´è°ƒåº¦çš„å³æ—¶å›è°ƒ</span>      <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿ç®—ç¬¦çš„æ¦‚å¿µ</p><ul><li>&amp; å¦‚æœä¸¤ä½éƒ½æ˜¯ 1 åˆ™è®¾ç½®æ¯ä½ä¸º 1 </li><li>| å¦‚æœä¸¤ä½ä¹‹ä¸€ä¸º 1 åˆ™è®¾ç½®æ¯ä½ä¸º 1</li><li>~ åè½¬æ“ä½œæ•°çš„æ¯”ç‰¹ä½ï¼Œå³ 0 å˜æˆ 1ï¼Œ1 å˜æˆ 0</li></ul><p>ä¸Šé¢è¡¨è¾¾å¼ç›¸å½“äºä¸‹é¢å†™æ³•ï¼Œåˆå§‹åŒ–çš„å€¼ä¸º</p><pre class="line-numbers language-js"><code class="language-js">executionContext <span class="token operator">=</span> executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span>BatchedContext<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 0 &amp; (~1) ä¸º 0</span>executionContext <span class="token operator">=</span> executionContext <span class="token operator">|</span> LegacyUnbatchedContext <span class="token comment" spellcheck="true">// 0 | 8 åˆ™ä¸º 8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>executionContext åˆ™æ˜¯è¿™äº› Context ç»„åˆçš„ç»“æœ:</p><ul><li>å°†å½“å‰ä¸Šä¸‹æ–‡æ·»åŠ  renderï¼šexecutionContext |= RenderContext</li><li>åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äº render é˜¶æ®µï¼š executionContext &amp;= RenderContext === NoContext</li><li>å»é™¤ render: executionContext &amp;= ~RenderContext</li></ul><p>æ‰€ä»¥æ­¤æ–¹æ³•çš„æ‰§è¡Œæµç¨‹æ˜¯</p><ul><li>å°†å½“å‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡èµ‹å€¼ç»™ prevExecutionContext é»˜è®¤ä¸º 0</li><li>å½“å‰ä¸Šä¸‹æ–‡è®¾ç½®æˆ BatchedContext é»˜è®¤ä¸º 0</li><li>æŠŠå½“å‰ä¸Šä¸‹æ–‡è®¾ç½®æˆ LegacyUnbatchedContext é»˜è®¤ä¸º 8</li><li>æ‰§è¡Œ try ä¸­çš„å›è°ƒä¹‹åæ‰§è¡Œ flushSyncCallbackQueue</li><li>æœ€åè¿”å›æ‰§è¡Œç»“æœ</li></ul><p>åœ¨åˆå§‹åŒ–æ›´æ–°é˜¶æ®µ try ä¸­çš„å›è°ƒå®é™…ä¸Šå°±æ˜¯ updateContainerï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ updateContainer</p><h3 id="updateContainer"><a href="#updateContainer" class="headerlink" title="updateContainer "></a>updateContainer <hr></h3><blockquote><p>updateContainer å®šä¹‰åœ¨ <code>/packages/react-reconciler/src/ReactFiberReconciler.js</code></p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>  element<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>  container<span class="token punctuation">:</span> OpaqueRoot<span class="token punctuation">,</span>  parentComponent<span class="token punctuation">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ExpirationTime <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ä¸Šé¢æåˆ°è¿‡ï¼Œå¯¹åº”çš„æ˜¯ä¸€ä¸ª fiber å¯¹è±¡</span>  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// è·å–å½“å‰ä»»åŠ¡æ—¶é—´</span>  <span class="token comment" spellcheck="true">// è¿‡æœŸæ—¶é—´æ˜¯é€šè¿‡æ·»åŠ å½“å‰æ—¶é—´(å¼€å§‹æ—¶é—´)æ¥è®¡ç®—çš„</span>  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// æ‰¹å¤„ç†çš„è¿‡ç¨‹çš„é…ç½® SuspenseConfig é»˜è®¤ä¸º null</span>  <span class="token comment" spellcheck="true">// export type SuspenseConfig = {</span>  <span class="token comment" spellcheck="true">//  timeoutMs: number,</span>  <span class="token comment" spellcheck="true">//  busyDelayMs?: number,</span>  <span class="token comment" spellcheck="true">//  busyMinDurationMs?: number,</span>  <span class="token comment" spellcheck="true">// };</span>  <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// é€šè¿‡ expirationTime å¯¹èŠ‚ç‚¹è®¡ç®—è¿‡æœŸæ—¶é—´</span>  <span class="token comment" spellcheck="true">// å¦‚æœåœ¨åŒä¸€ä¸ªäº‹ä»¶ä¸­å®‰æ’äº†ä¸¤ä¸ªæ›´æ–°ï¼Œåº”è¯¥å°†å®ƒä»¬çš„å¼€å§‹æ—¶é—´è§†ä¸ºåŒæ—¶å‘ç”Ÿçš„</span>  <span class="token comment" spellcheck="true">// å³ä½¿åœ¨ç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡è°ƒç”¨ä¹‹é—´å®é™…çš„æ—¶é’Ÿæ—¶é—´å·²ç»æå‰</span>  <span class="token comment" spellcheck="true">// è¿‡æœŸæ—¶é—´å†³å®šæ›´æ–°çš„æ‰¹å¤„ç†æ–¹å¼ï¼Œåœ¨åŒä¸€äº‹ä»¶ä¸­å‘ç”Ÿçš„å…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„æ‰€æœ‰æ›´æ–°éƒ½èƒ½æ¥æ”¶åˆ°ç›¸åŒçš„è¿‡æœŸæ—¶é—´</span>  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>    currentTime<span class="token punctuation">,</span>    current<span class="token punctuation">,</span>    suspenseConfig<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">updateContainerAtExpirationTime</span><span class="token punctuation">(</span>    element<span class="token punctuation">,</span>    container<span class="token punctuation">,</span>    parentComponent<span class="token punctuation">,</span>    expirationTime<span class="token punctuation">,</span>    suspenseConfig<span class="token punctuation">,</span>    callback<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„é€»è¾‘æœ€ä¸»è¦çš„çš„ä¸¤ä¸ªæ–¹æ³• computeExpirationForFiber å’Œ updateContainerAtExpirationTime</p><h3 id="computeExpirationForFiber"><a href="#computeExpirationForFiber" class="headerlink" title="computeExpirationForFiber "></a>computeExpirationForFiber <hr></h3><blockquote><p>computeExpirationForFiber è®¡ç®—èŠ‚ç‚¹è¿‡æœŸæ—¶é—´</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>  currentTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>  fiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>  suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ExpirationTime <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å½“å‰ fiber å¯¹è±¡é‡‡ç”¨çš„æ¨¡å¼ </span>  <span class="token keyword">const</span> mode <span class="token operator">=</span> fiber<span class="token punctuation">.</span>mode<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**   * form ./ReactTypeOfMode    * è°ƒåº¦ç³»ç»Ÿçš„å¤„ç†æ¨¡å¼   * NoMode 0b0000 --> 0   * BatchedMode 0b0010 --> 2   * ConcurrentMode 0b0100  --> 4   */</span>  <span class="token comment" spellcheck="true">/**   * from ./ReactFiberWorkLoop    * å½“å‰è°ƒåº¦ç³»ç»Ÿçš„ Execution   * ExecutionContext é»˜è®¤å€¼  NoContext  0b000000 --> 0   * RenderContext 0b010000 --> 16   */</span>  <span class="token comment" spellcheck="true">/**   * from ./ReactFiberExpirationTime    * è°ƒåº¦ç³»ç»Ÿçš„å¤„ç†æ¨¡å¼   * Sync é»˜è®¤å€¼ MAX_SIGNED_31_BIT_INT --> 1073741823 (æœ€å¤§ 31 ä½æ•´æ•°ã€‚32 ä½ç³»ç»Ÿçš„ V8 ä¸­çš„æœ€å¤§æ•´æ•°å¤§å°, Math.pow(2, 30) - 1)   * Batched  Sync - 1   * LOW_PRIORITY_EXPIRATION 5000   * LOW_PRIORITY_BATCH_SIZE 250   * HIGH_PRIORITY_EXPIRATION  __DEV__ ? 500 : 150   * HIGH_PRIORITY_BATCH_SIZE 100   */</span>  <span class="token comment" spellcheck="true">/**   * ./SchedulerWithReactIntegration   * é™¤äº† NoPriority ä¹‹å¤–ï¼Œè¿™äº›éƒ½å¯¹åº”äºè°ƒåº¦å™¨ä¼˜å…ˆçº§   * ä½¿ç”¨å‡åºæ•°å­—ï¼Œä»90å¼€å§‹ï¼Œä»¥é¿å…ä¸è°ƒåº¦ç¨‹åºçš„ä¼˜å…ˆçº§å†²çª   * ImmediatePriority  99    * UserBlockingPriority 98   * NormalPriority 96   * IdlePriority 95   * NoPriority 90   */</span>  <span class="token comment" spellcheck="true">// (mode &amp; 2) === 0 </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> BatchedMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// return 1073741823</span>    <span class="token keyword">return</span> Sync<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// (mode &amp; 4) === 0 æ‰§è¡Œ </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// priorityLevel === 99 ? 1073741823 : (1073741823 - 1)</span>    <span class="token keyword">return</span> priorityLevel <span class="token operator">===</span> ImmediatePriority <span class="token operator">?</span> Sync <span class="token punctuation">:</span> Batched<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// (0 &amp; 16-> 0b010000) !== 0 (0b000000)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åˆ©ç”¨æˆ‘ä»¬å·²ç»æ¸²æŸ“çš„æ—¶é—´, é»˜è®¤æ˜¯ noworkï¼ˆ0ï¼‰</span>    <span class="token keyword">return</span> renderExpirationTime<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// expirationTime ä»£è¡¨è¯¥ fiber çš„ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼ŒSync çš„ä¼˜å…ˆçº§æœ€é«˜</span>  <span class="token keyword">let</span> expirationTime<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>suspenseConfig <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åŸºäºæš‚åœè¶…æ—¶è®¡ç®—è¿‡æœŸæ—¶é—´</span>    expirationTime <span class="token operator">=</span> <span class="token function">computeSuspenseExpiration</span><span class="token punctuation">(</span>      currentTime<span class="token punctuation">,</span>      suspenseConfig<span class="token punctuation">.</span>timeoutMs <span class="token operator">|</span> <span class="token number">0</span> <span class="token operator">||</span> LOW_PRIORITY_EXPIRATION<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ ¹æ®è°ƒåº¦å™¨ä¼˜å…ˆçº§è®¡ç®— expirationTime</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">case</span> ImmediatePriority<span class="token punctuation">:</span>        expirationTime <span class="token operator">=</span> Sync<span class="token punctuation">;</span>         <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> UserBlockingPriority<span class="token punctuation">:</span>        expirationTime <span class="token operator">=</span> <span class="token function">computeInteractiveExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> NormalPriority<span class="token punctuation">:</span>      <span class="token keyword">case</span> LowPriority<span class="token punctuation">:</span>        expirationTime <span class="token operator">=</span> <span class="token function">computeAsyncExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> IdlePriority<span class="token punctuation">:</span>        expirationTime <span class="token operator">=</span> Never<span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'Expected a valid priority level'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å¦‚æœæ­£åœ¨æ¸²æŸ“ä¸€ä¸ªæ ‘ï¼Œä¸è¦åœ¨å·²ç»æ¸²æŸ“çš„è¿‡æœŸæ—¶é—´ä¸Šæ›´æ–°æ“ä½œã€‚</span>  <span class="token comment" spellcheck="true">// å¦‚æœåœ¨ä¸åŒçš„ root èŠ‚ç‚¹ä¸Šæ›´æ–°ç§»åŠ¨åˆ°å•ç‹¬çš„æ‰¹å¤„ç†ä¸­</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> expirationTime <span class="token operator">===</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    expirationTime <span class="token operator">-</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> expirationTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šåˆ°ä»£ç çš„æ³¨é‡Šå°±èƒ½çœ‹åˆ° computeExpirationForFiber ä¸»è¦æ˜¯æ ¹æ®ä¸åŒçš„ä»»åŠ¡ä¼˜å…ˆçº§å»è¿›è¡Œè°ƒåº¦æ‰§è¡Œè®¡ç®—è¿‡æœŸæ—¶é—´ expirationTimeï¼Œé‚£ä¹ˆåœ¨ä¸åŒçš„ä»»åŠ¡ä¼˜å…ˆçº§ä¸‹é¢å…·ä½“æ˜¯æ€ä¹ˆè®¡ç®—çš„å‘¢</p><p>ä¸»è¦æœ‰ä¸‹é¢å››ç§</p><ul><li>computeSuspenseExpiration æš‚åœä»»åŠ¡çš„è®¡ç®—</li><li>Sync åŒæ­¥ä»»åŠ¡çš„è®¡ç®—å€¼</li><li>computeInteractiveExpiration äº¤äº’æ›´æ–°çš„è®¡ç®—</li><li>computeAsyncExpiration å¼‚æ­¥ä»»åŠ¡çš„è®¡ç®— </li></ul><p>ä¸Šé¢çš„æ–¹æ³•é™¤äº† Sync ä»»åŠ¡ä¼˜å…ˆçº§æœ€é«˜ä¸º 99 å¤–ï¼Œå…¶ä»–éœ€è¦è®¡ç®—ï¼Œéƒ½è°ƒç”¨äº† ./ReactFiberExpirationTime æ–‡ä»¶ä¸­ computeExpirationBucket æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** computeSuspenseExpiration (currentTime, timeoutMs, LOW_PRIORITY_BATCH_SIZE) {}* timeoutMs --> suspenseConfig.timeoutMs | 0 || LOW_PRIORITY_EXPIRATION* LOW_PRIORITY_BATCH_SIZE --> 200*/</span><span class="token comment" spellcheck="true">/** computeInteractiveExpiration (currentTime, HIGH_PRIORITY_EXPIRATION, HIGH_PRIORITY_BATCH_SIZE) {}* HIGH_PRIORITY_EXPIRATION --> __DEV__ ? 500 : 150* HIGH_PRIORITY_BATCH_SIZE --> 100*/</span><span class="token comment" spellcheck="true">/** computeAsyncExpiration (currentTime, LOW_PRIORITY_EXPIRATION, LOW_PRIORITY_BATCH_SIZE) {}* LOW_PRIORITY_EXPIRATION --> 5000* LOW_PRIORITY_BATCH_SIZE --> 250*/</span><span class="token comment" spellcheck="true">// MAGIC_NUMBER_OFFSET = Batched-1 --> (Sync - 1)-1 --> 1073741821;</span><span class="token comment" spellcheck="true">// UNIT_SIZE = 10</span><span class="token keyword">function</span> <span class="token function">computeExpirationBucket</span><span class="token punctuation">(</span>  currentTime<span class="token punctuation">,</span>  expirationInMs<span class="token punctuation">,</span>  bucketSizeMs<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ExpirationTime <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    MAGIC_NUMBER_OFFSET <span class="token operator">-</span>    <span class="token function">ceiling</span><span class="token punctuation">(</span>      MAGIC_NUMBER_OFFSET <span class="token operator">-</span> currentTime <span class="token operator">+</span> expirationInMs <span class="token operator">/</span> UNIT_SIZE<span class="token punctuation">,</span>      bucketSizeMs <span class="token operator">/</span> UNIT_SIZE<span class="token punctuation">,</span>    <span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">ceiling</span><span class="token punctuation">(</span>num<span class="token punctuation">:</span> number<span class="token punctuation">,</span> precision<span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> number <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">/</span> precision<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> precision<span class="token punctuation">;</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¹æ®ä¸Šé¢å…¬å¼ï¼Œæˆ‘ä»¬é€šè¿‡ä¸åŒçš„ä»»åŠ¡ä¼˜å…ˆçº§æ¥è®¡ç®—ä¸€ä¸‹ expirationTime</p><p>computeAsyncExpiration çš„ expirationTime ä¸º</p><pre class="line-numbers language-js"><code class="language-js"><span class="token number">1073741821</span><span class="token operator">-</span><span class="token function">ceiling</span><span class="token punctuation">(</span><span class="token number">1073741821</span><span class="token operator">-</span>currentTime <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token number">1073741821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1073741821</span> <span class="token operator">-</span> currentTime <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>æˆ‘ä»¬å–æœ€åå››ä½æ¥çœ‹ä¸€ä¸‹è§„å¾‹å¹¶ä¸”æŠŠ currentTime å˜ä¸ºä» <span class="token number">996</span><span class="token operator">-</span><span class="token number">1047</span> çš„æ•°å­—<span class="token number">1821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1821</span> <span class="token operator">-</span> <span class="token number">996</span> <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>  <span class="token comment" spellcheck="true">//1821-1350</span><span class="token number">1821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1821</span> <span class="token operator">-</span> <span class="token number">1021</span><span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>  <span class="token comment" spellcheck="true">//1821-1325</span><span class="token number">1821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1821</span> <span class="token operator">-</span> <span class="token number">1022</span><span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>  <span class="token comment" spellcheck="true">//1821-1300</span><span class="token number">1821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1821</span> <span class="token operator">-</span> <span class="token number">1047</span><span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>  <span class="token comment" spellcheck="true">//1821-1275</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>å¯ä»¥å¾—å‡ºï¼Œåœ¨è·¨åº¦ 996-1021 æ•°å­—ä¹‹å†…æ‰§è¡Œå¾—å‡ºç›¸åŒçš„ç»“æœï¼Œæ‰€ä»¥å¼‚æ­¥æ›´æ–°çš„è¿‡æœŸæ—¶é—´é—´éš”æ˜¯25ms</strong></p><p>åŒç† computeInteractiveExpiration çš„ expirationTime ä¸º</p><pre class="line-numbers language-js"><code class="language-js"><span class="token number">1073741821</span><span class="token operator">-</span><span class="token function">ceiling</span><span class="token punctuation">(</span><span class="token number">1073741821</span><span class="token operator">-</span>currentTime<span class="token operator">+</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>å¯ä»¥å¾—å‡ºï¼Œäº¤äº’æ›´æ–°çš„è¿‡æœŸæ—¶é—´é—´éš”æ˜¯10ms</strong></p><p>computeSuspenseExpiration ä¸­çš„ <a href="https://www.zhihu.com/question/268028123/answer/332182059" target="_blank" rel="noopener">suspenseConfig</a> æ˜¯ç”¨æ¥è§£å†³å¼‚æ­¥ IOé—®é¢˜çš„ï¼Œå®ƒè®¡ç®—çš„ä¼˜å…ˆçº§å–å†³äº suspenseConfig.timeoutMs çš„æ—¶é—´ï¼Œå¦‚æœsuspenseConfig.timeoutMs æ²¡æœ‰å€¼é‚£ä¹ˆé»˜è®¤ä¸º LOW_PRIORITY_EXPIRATIONï¼ˆ5000ï¼‰ï¼ŒLOW_PRIORITY_BATCH_SIZEï¼ˆ250ï¼‰ï¼Œä»£å…¥å…¬å¼ä¸º</p><pre class="line-numbers language-js"><code class="language-js"><span class="token number">1073741821</span><span class="token operator">-</span><span class="token function">ceiling</span><span class="token punctuation">(</span><span class="token number">1073741821</span><span class="token operator">-</span>currentTime<span class="token operator">+</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>å¯ä»¥å¾—å‡ºï¼Œæ—¶é—´é—´éš”æ˜¯25msï¼Œä½†ç”±äº500 çš„å–å€¼ä¸å›ºå®šï¼Œæ‰€ä»¥å®ƒçš„ä¼˜å…ˆçº§ä¸å›ºå®š</strong></p><p>é€šè¿‡ä¸Šé¢è®¡ç®—çš„ç»“è®ºå¾—å‡º</p><ul><li>Sync ä»»åŠ¡ä¼˜å…ˆçº§æœ€é«˜ &gt; computeInteractiveExpiration ç”¨æˆ·äº¤äº’æ›´æ–°ä»»åŠ¡ &gt; computeAsyncExpiration å¼‚æ­¥ä»»åŠ¡çš„è®¡ç®— </li><li>computeSuspenseExpiration çš„æƒ…å†µç”±äºä¸å›ºå®šæ‰€ä»¥ä»»åŠ¡ä¼˜å…ˆçº§ä¸å›ºå®š</li></ul><p>ä»ç»“è®ºä¸­å¾—å‡º react å¼‚æ­¥æ›´æ–°çš„ expirationTime é—´éš”æ˜¯25msï¼Œè®©ä¸¤ä¸ªæˆ–å¤šä¸ªç›¸è¿‘ï¼ˆ25mså†…ï¼‰çš„æ›´æ–°å¾—åˆ°ç›¸åŒçš„ expirationTimeã€‚ç›®çš„å°±æ˜¯è®©è¿™ä¸¤ä¸ªæ›´æ–°è‡ªåŠ¨åˆå¹¶æˆä¸€ä¸ªï¼Œä»è€Œè¾¾åˆ°è‡ªåŠ¨æ‰¹é‡æ›´æ–°çš„ç›®çš„ã€‚è¿™æ ·åœ¨å¼€å‘ä¸­ä¸åœçš„ setState() è¿›è¡Œæ›´æ–°æ“ä½œï¼Œ25mså†…çš„å°±ä¼šåˆå¹¶æé«˜æ€§èƒ½ã€‚æˆ‘ä»¬åé¢ä¹Ÿä¼šä»‹ç» setState å’Œ BatchUpdate çš„è¿è¡Œæœºåˆ¶ã€‚</p><h3 id="updateContainerAtExpirationTime"><a href="#updateContainerAtExpirationTime" class="headerlink" title="updateContainerAtExpirationTime "></a>updateContainerAtExpirationTime <hr></h3><blockquote><p>updateContainerAtExpirationTime å®šä¹‰åœ¨æ–‡ä»¶ <code>packages/react-reconciler/src/ReactFiberReconciler.js</code></p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainerAtExpirationTime</span><span class="token punctuation">(</span>  element<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>  container<span class="token punctuation">:</span> OpaqueRoot<span class="token punctuation">,</span>  parentComponent<span class="token punctuation">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">,</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>  suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// TODO: If this is a nested container, this won't be the root.</span>  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ..</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span>parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>context <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    container<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    container<span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> context<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">scheduleRootUpdate</span><span class="token punctuation">(</span>    current<span class="token punctuation">,</span>    element<span class="token punctuation">,</span>    expirationTime<span class="token punctuation">,</span>    suspenseConfig<span class="token punctuation">,</span>    callback<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢çœ‹åˆ°è·å–å®¹å™¨çš„èŠ‚ç‚¹ï¼Œä¹‹åè¿›å…¥ scheduleRootUpdate æ›´æ–° container</p><h3 id="scheduleRootUpdate"><a href="#scheduleRootUpdate" class="headerlink" title="scheduleRootUpdate"></a>scheduleRootUpdate<hr></h3><blockquote><p>scheduleRootUpdate </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">scheduleRootUpdate</span><span class="token punctuation">(</span>  current<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>  element<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>  suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// è·å¾—ä¼˜å…ˆçº§ååˆ™å’ŒåŒæ­¥æ›´æ–°ä¸€æ ·ï¼Œ åˆ›å»º update ç”¨äºè®°å½•ç»„ä»¶æ”¹å˜çš„çŠ¶æ€çš„å¯¹è±¡</span>  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// è®¾ç½®updateå±æ€§ åˆæ¬¡æ¸²æŸ“</span>  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>element<span class="token punctuation">}</span><span class="token punctuation">;</span>  callback <span class="token operator">=</span> callback <span class="token operator">===</span> undefined <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> callback<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>revertPassiveEffectsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// enqueueUpdate æŠŠ update å¯¹è±¡åŠ å…¥ fiber å¯¹è±¡çš„ updateQueue ä¸­ï¼ŒupdateQueueå¯¹è±¡æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ç»“æ„ </span>  <span class="token comment" spellcheck="true">// åªè¦æœ‰ setState æˆ–è€…å…¶ä»–æ–¹å¼è§¦å‘äº†æ›´æ–°ï¼Œå°±ä¼šåœ¨ fiber ä¸Šçš„ updateQueue é‡Œæ’å…¥ä¸€ä¸ª update</span>  <span class="token comment" spellcheck="true">// è¿™æ ·åœ¨æ›´æ–°çš„æ—¶å€™å°±å¯ä»¥åˆå¹¶ä¸€èµ·æ›´æ–°</span>  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å¼€å§‹è¿›è¡Œä»»åŠ¡è°ƒåº¦æµç¨‹ï¼Œä»»åŠ¡è°ƒåº¦åˆ™éœ€è¦æŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œæ§åˆ¶</span>  <span class="token comment" spellcheck="true">// åœ¨åŒä¸€æ—¶é—´æœ‰ä¸åŒçš„ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œåˆ™éœ€è¦å…ˆæ‰§è¡Œä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡</span>  <span class="token function">scheduleWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> expirationTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="scheduleWork"><a href="#scheduleWork" class="headerlink" title="scheduleWork "></a>scheduleWork <hr></h3><blockquote><p>scheduleWork å¼‚æ­¥è°ƒåº¦æµç¨‹ï¼Œå®šä¹‰åœ¨æ–‡ä»¶ <code>/packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>  fiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æœ‰æ— é™å¾ªç¯çš„ updateï¼Œå¦‚æœè¶…è¿‡50å±‚ä»¶å¥— update</span>  <span class="token comment" spellcheck="true">// å°±ä¼šåœæ­¢è°ƒåº¦ï¼Œå¹¶æŠ¥é”™</span>  <span class="token comment" spellcheck="true">// æ‰€ä»¥æˆ‘ä»¬åœ¨æˆ‘ä»¬ä¸èƒ½åœ¨ render ä¸­æ— æ¡ä»¶çš„è°ƒç”¨ setStateï¼Œé€ æˆæ­»å¾ªç¯</span>  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// æ‰¾åˆ° rootFiber å¹¶éå†æ›´æ–°å­èŠ‚ç‚¹çš„ expirationTime</span>  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">markUpdateTimeFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">warnAboutUpdateOnUnmountedFiberInDEV</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// NoWorkè¡¨ç¤ºæ— æ›´æ–°æ“ä½œ ä¸º 0 </span>  root<span class="token punctuation">.</span>pingTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//åˆ¤æ–­æ˜¯å¦æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</span>  <span class="token function">checkForInterruption</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æŠ¥å‘Šè°ƒåº¦æ›´æ–°</span>  <span class="token function">recordScheduleUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//  è·å–ä¼˜å…ˆçº§</span>  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åŒæ­¥ä»»åŠ¡</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>      <span class="token comment" spellcheck="true">// renderå‰ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œ </span>      <span class="token comment" spellcheck="true">// ä¸æ‰¹é‡æ›´æ–°</span>      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> LegacyUnbatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>      <span class="token comment" spellcheck="true">// æ˜¯å¦å·²ç» render</span>      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext    <span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// è·Ÿè¸ª åœ¨root æ³¨å†ŒæŒ‚èµ·çš„äº¤äº’ï¼Œä»¥é¿å…ä¸¢å¤±è·Ÿè¸ªçš„äº¤äº’æ•°æ®</span>      <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// æ‰¹é‡æ›´æ–°æ—¶ï¼Œrenderæ˜¯åŒæ­¥çš„ï¼Œä½†å¸ƒå±€çš„æ›´æ–°è¦å»¶è¿Ÿåˆ°æ‰¹é‡æ›´æ–°çš„æœ«å°¾æ‰æ‰§è¡Œ</span>      <span class="token comment" spellcheck="true">// æ¸²æŸ“ root ç»„ä»¶</span>      <span class="token comment" spellcheck="true">// è°ƒç”¨workLoopè¿›è¡Œå¾ªç¯å•å…ƒæ›´æ–°</span>      <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token function">renderRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> Sync<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        callback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// render å</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ç«‹å³æ‰§è¡Œè°ƒåº¦ä»»åŠ¡</span>      <span class="token function">scheduleCallbackForRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> ImmediatePriority<span class="token punctuation">,</span> Sync<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// åˆ¤æ–­æ²¡æœ‰updateæ—¶</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆ·æ–°åŒæ­¥ä»»åŠ¡é˜Ÿåˆ—</span>        <span class="token comment" spellcheck="true">// æ”¾åœ¨ scheduleUpdateOnFiber è€Œä¸æ˜¯ scheduleCallbackForFiberä¸­ï¼Œä»¥ä¿ç•™åœ¨ä¸ç«‹å³åˆ·æ–°å›è°ƒçš„æƒ…å†µä¸‹è°ƒåº¦å›è°ƒçš„èƒ½åŠ›ã€‚</span>        <span class="token comment" spellcheck="true">// åªå¯¹ç”¨æˆ·å‘èµ·çš„æ›´æ–°è¿™æ ·åšï¼Œä»¥ä¿æŒåŒæ­¥æ¨¡å¼çš„å†å²è¡Œä¸ºã€‚</span>        <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å¼‚æ­¥ä»»åŠ¡ç«‹å³æ‰§è¡Œè°ƒåº¦ä»»åŠ¡</span>    <span class="token function">scheduleCallbackForRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> priorityLevel<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> DiscreteEventContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>    <span class="token punctuation">(</span>priorityLevel <span class="token operator">===</span> UserBlockingPriority <span class="token operator">||</span> priorityLevel <span class="token operator">===</span> ImmediatePriority<span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootsWithPendingDiscreteUpdates <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// keyæ˜¯rootï¼Œvalueæ˜¯expirationTime</span>      rootsWithPendingDiscreteUpdates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// è·å–æœ€æ–°çš„DiscreteTime</span>      <span class="token keyword">const</span> lastDiscreteTime <span class="token operator">=</span> rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// æ›´æ–°DiscreteTime</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastDiscreteTime <span class="token operator">===</span> undefined <span class="token operator">||</span> lastDiscreteTime <span class="token operator">></span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>        rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">const</span> scheduleWork <span class="token operator">=</span> scheduleUpdateOnFiber<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä»£ç åˆ†ææˆ‘ä»¬äº†è§£åˆ°äº†æ•´ä¸ª fiber çš„åˆ›å»ºè¿‡ç¨‹ä»¥åŠæåˆ°äº†ä¸€ç‚¹ç‚¹çš„è°ƒåº¦ï¼Œå…³äºæ€ä¹ˆæ‰§è¡Œè°ƒåº¦æœºåˆ¶ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¿›è¡Œåˆ†æã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“<hr></h2><p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬æ€»ç»“ä»¥ä¸‹å‡ ä¸ªçŸ¥è¯†ç‚¹</p><blockquote><p>fiber çš„å®ç°åŸç†</p></blockquote><p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬çŸ¥é“ï¼ˆè™½ç„¶è°ƒåº¦è¿‡ç¨‹è¿˜æ²¡æœ‰åˆ†æï¼‰ï¼Œfiber å®é™…ä¸Šæ˜¯å°†éœ€è¦æ‰§è¡Œçš„æ“ä½œæ”¾åœ¨ updateQueue é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯ Javascript çš„æ ˆã€‚é€šè¿‡è°ƒåº¦é€»è¾‘ä¼˜å…ˆçº§æ§åˆ¶åœ¨å†…å­˜ä¸­ä¿ç•™æ ˆå¸§ï¼Œä»è€Œæ§åˆ¶æ•´ä¸ªæ¸²æŸ“ã€‚</p><blockquote><p>fiber çš„ä½œç”¨</p></blockquote><ul><li>æ¯ä¸€ä¸ª ReactElement å¯¹åº”ä¸€ä¸ªFiberå¯¹è±¡</li><li>è®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¾‹å¦‚ props å’Œ state ç­‰</li><li>ä¼šä¸²è”æ•´ä¸ªåº”ç”¨å½¢æˆæ ‘ç»“æ„</li></ul><blockquote><p>fiber-tree</p></blockquote><img src="/images/library-react-fiber-tree.png"><p>ä¸Šé¢çš„å›¾å°±æ˜¯æ•´ä¸ª fiber-tree çš„æ•°æ®ç»“æ„å›¾ï¼Œæ˜¯é€šè¿‡é€’å½’ diffçš„è¿‡ç¨‹ï¼Œæ‹†åˆ†æˆä¸€ç³»åˆ—å°ä»»åŠ¡ï¼Œé€šè¿‡è°ƒåº¦ç®—æ³•ï¼Œå½¢æˆçš„ç»“æ„ã€‚</p><blockquote><p>å…¶ä»–</p></blockquote><p>ç”±äºç¯‡å¹…è¿‡é•¿æ‰€ä»¥è°ƒåº¦æµç¨‹åªåˆ†æçš„å¤§æ¦‚ï¼Œä½†æ˜¯ä»ä¸Šé¢çš„æºç ä¸­æˆ‘ä»¬çŸ¥é“ä»¥ä¸‹å‡ ä¸ªçŸ¥è¯†ç‚¹</p><ul><li>hydrate çš„ä½œç”¨</li><li>åœ¨åˆæ¬¡æ¸²æŸ“æ—¶æ˜¯ä¸ä¼šè¿›è¡Œæ‰¹é‡æ›´æ–°çš„ï¼Œå› ä¸ºè¦åŠ é€Ÿæ¸²æŸ“è¿‡ç¨‹</li><li>FiberNode ä¸­çš„èŠ‚ç‚¹å­—æ®µä¿¡æ¯éƒ½æœ‰ä»€ä¹ˆå«ä¹‰</li><li>åœ¨åˆå§‹åŒ–åˆ›å»ºæ›´æ–°å­èŠ‚ç‚¹ï¼Œé€šè¿‡è¿‡æœŸæ—¶é—´ expirationTime æ¥å†³å®šæ‰¹å¤„ç†çš„æ–¹å¼</li><li>ä»»åŠ¡æ‰§è¡Œçš„ä¼˜å…ˆçº§ä¸º Sync ä»»åŠ¡ä¼˜å…ˆçº§æœ€é«˜ &gt; computeInteractiveExpiration ç”¨æˆ·äº¤äº’æ›´æ–°ä»»åŠ¡ &gt; computeAsyncExpiration å¼‚æ­¥ä»»åŠ¡çš„è®¡ç®—</li><li>è¿›è¡Œ setState çš„æ—¶å€™åœ¨ 25mså†…æ‰§è¡Œå¤šæ¬¡ï¼Œä¼šè¢«è¿›è¡Œåˆå¹¶ï¼Œè¿™ä¸ªåœ¨åç»­æ–‡ç« ä¸­é€šè¿‡ BatchUpdate ä¼šè¯¦ç»†è¯´æ˜</li><li>æ‰€æœ‰çš„æ•°æ®ä¼šæ”¾åœ¨ fiber å¯¹è±¡çš„ updateQueue é˜Ÿåˆ—ä¸­ç­‰å¾…æ›´æ–°æ“ä½œ</li><li>é€šè¿‡ scheduleWork å¼€å¯è°ƒåº¦ä»»åŠ¡ï¼Œè°ƒåº¦ä»»åŠ¡çš„ä¼˜å…ˆçº§é€šè¿‡ expirationTime è®¡ç®—å¾—å‡º</li></ul>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React ä¹‹ç”Ÿå‘½å‘¨æœŸä½¿ç”¨</title>
      <link href="/2019/10/02/react/library-react-lifecycle/"/>
      <url>/2019/10/02/react/library-react-lifecycle/</url>
      
        <content type="html"><![CDATA[<p>å’Œ Vue ä¸€æ · React ä¹Ÿä¼šæœ‰å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œåœ¨ç›¸å¯¹åº”çš„é’©å­å‡½æ•°å†…ï¼Œåˆ†åˆ«åœ¨ä¸åŒæ—¶æœºå¤„ç†ç›¸å¯¹åº”çš„é€»è¾‘ï¼Œè´´ä¸€å¼ æ¥è‡³å®˜ç½‘<a href="http://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/" target="_blank" rel="noopener">ç”Ÿå‘½å‘¨æœŸå›¾</a>ï¼Œé€šè¿‡å‘¨æœŸå›¾è®©æˆ‘ä»¬çœ‹çœ‹ react çš„ç”Ÿå‘½å‘¨æœŸå…·ä½“çš„å«ä¹‰ã€‚</p><p>åœ¨ react ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š</p><ul><li>åˆå§‹åŒ–é˜¶æ®µ</li><li>æŒ‚è½½é˜¶æ®µ</li><li>æ›´æ–°é˜¶æ®µ</li><li>å¸è½½é˜¶æ®µ</li></ul><p>ä¸‹é¢æˆ‘ä»¬å°±æ ¹æ®ä¸åŒé˜¶æ®µå¯¹åº”ä¸åŒçš„é’©å­å‡½æ•°è¿›è¡Œç®€å•çš„ä»‹ç»ä½¿ç”¨ï¼ˆæœ¬æ–‡ä¸»è¦ä¾æ®ç‰ˆæœ¬16.9.0ï¼‰</p><h3 id="åˆå§‹åŒ–é˜¶æ®µï¼ˆInitalizationï¼‰"><a href="#åˆå§‹åŒ–é˜¶æ®µï¼ˆInitalizationï¼‰" class="headerlink" title="åˆå§‹åŒ–é˜¶æ®µï¼ˆInitalizationï¼‰"></a>åˆå§‹åŒ–é˜¶æ®µï¼ˆInitalizationï¼‰<hr></h3><p>æŒ‚è½½é˜¶æ®µå®é™…ä¸Šå°±æ˜¯åœ¨åšåˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œå½“ç»„ä»¶å®ä¾‹è¢«åˆ›å»ºå¹¶æ’å…¥ DOM ä¸­çš„æ—¶å€™ï¼Œå°†ä¾æ¬¡è°ƒç”¨ä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> propTypes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">static</span> defaultProps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢å¯¹ä¸Šé¢çš„ä»£ç è¿›è¡Œæ‹†åˆ†</p><blockquote><p>static propTypes = {} å’Œ static defaultProps = {}</p></blockquote><p>getDefaultProps ç›¸å½“äº ES6ä¸­ static defaultProps = {}<br>getInitialState ç›¸å½“äº constructorä¸­ çš„ this.state = {}</p><ul><li>static defaultProps = {} æ˜¯è®¾ç½®ç»„ä»¶çš„é»˜è®¤ props</li><li>static propTypes = {} ç»„ä»¶çš„ propsç±»å‹æ£€æµ‹</li></ul><blockquote><p>constructor(props)</p></blockquote><p>åœ¨ç»„ä»¶è¿›è¡ŒæŒ‚è½½ä¹‹å‰ï¼Œè°ƒç”¨å®ƒçš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥åšå¦‚ä¸‹äº‹æƒ…</p><ul><li>è®¿é—® props</li><li>åˆå§‹åŒ– state å€¼</li><li>ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°</li></ul><h3 id="æŒ‚è½½é˜¶æ®µï¼ˆMountingï¼‰"><a href="#æŒ‚è½½é˜¶æ®µï¼ˆMountingï¼‰" class="headerlink" title="æŒ‚è½½é˜¶æ®µï¼ˆMountingï¼‰"></a>æŒ‚è½½é˜¶æ®µï¼ˆMountingï¼‰<hr></h3><p>å°†è™šæ‹Ÿ DOM è½¬åŒ–ä¸ºçœŸå® DOM çš„è¿‡ç¨‹</p><blockquote><p>static getDerivedStateFromProps(props, state) æ­¤é’©å­ä¼šæ‰§è¡Œ &gt; 1 æ¬¡</p></blockquote><p>getDerivedStateFromProps æ˜¯åœ¨ render ä¹‹å‰è¢«è°ƒç”¨çš„ï¼Œä¸»è¦å­˜åœ¨çš„ä½œç”¨æ˜¯è®©ç»„ä»¶çš„ props å˜åŒ–æ—¶æ›´æ–° stateã€‚<br>åœ¨åˆå§‹åŒ–æŒ‚è½½å’Œåç»­æ›´æ–°éƒ½ä¼šè¢«è°ƒç”¨ï¼Œå®ƒè¿”å›ä¸€ä¸ªå¯¹è±¡æ¥æ›´æ–°çŠ¶æ€ï¼Œæˆ–è€…è¿”å› null æ¥è¡¨æ˜æ–°å±æ€§ä¸éœ€è¦æ›´æ–°ä»»ä½•çŠ¶æ€ã€‚</p><p>ä½¿ç”¨æ­¤ç”Ÿå‘½å‘¨æœŸæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„çš„åœ°æ–¹</p><ul><li>è°ƒç”¨ this.setState() é€šå¸¸ä¸ä¼šè§¦å‘æ­¤æ–¹æ³•</li><li>æ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨å¤šæ¬¡</li><li>å¿…é¡»æœ‰è¿”å›å€¼ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡æ›´æ–° state æˆ–è€…è¿”å› null</li></ul><blockquote><p>render() æ­¤å‡½æ•°ä¼šæ‰§è¡Œ &gt; 1 æ¬¡ï¼Œä»£è¡¨æŒ‚è½½ï¼ˆæ¸²æŸ“ï¼‰ç»„ä»¶</p></blockquote><p>render å‡½æ•°æ˜¯ç»„ä»¶ä¸­å”¯ä¸€ä¸€ä¸ªå¿…é¡»å®ç°çš„æ–¹æ³•ï¼Œè¯¥å‡½æ•°åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æœ‰å‡ ç‚¹æ³¨æ„çš„åœ°æ–¹</p><ul><li>æ­¤å‡½æ•°ä¼šè¢«è°ƒç”¨å¤šæ¬¡</li><li>ä¸èƒ½åœ¨å‡½æ•°ä¸­è°ƒç”¨ this.setState() æ–¹æ³•</li><li>render() å‡½æ•°åº”è¯¥ä¸º<a href="https://www.studyfe.cn/2019/07/15/javascript/functionalpurity/">çº¯å‡½æ•°</a></li><li>å¿…é¡»æœ‰è¿”å›å€¼ï¼Œå¯ä»¥æœ‰<a href="https://zh-hans.reactjs.org/docs/react-component.html#render" target="_blank" rel="noopener">å¤šç§ç±»å‹</a>ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•è¿”å›å€¼ï¼Œå¯ä»¥ç›´æ¥è¿”å› nullã€‚</li></ul><blockquote><p>componentDidMount()ï¼Œæ­¤é’©å­åªæ‰§è¡Œä¸€æ¬¡ï¼Œä»£è¡¨ç»„ä»¶æ¸²æŸ“å®Œæˆ</p></blockquote><p>æ­¤é’©å­å‡½æ•°å¹¶ä¸æ˜¯åœ¨ render è°ƒç”¨åç«‹å³è°ƒç”¨ï¼Œä¼šåœ¨ç»„ä»¶æŒ‚è½½åï¼ˆæ’å…¥ DOM æ ‘ä¸­ï¼‰ç«‹å³è°ƒç”¨ã€‚</p><ul><li>ä¾èµ–äº DOM èŠ‚ç‚¹çš„åˆå§‹åŒ–åº”è¯¥æ”¾åœ¨è¿™é‡Œ</li><li>å¦‚éœ€é€šè¿‡ç½‘ç»œè¯·æ±‚è·å–æ•°æ®ï¼Œæ­¤å¤„æ˜¯å®ä¾‹åŒ–è¯·æ±‚çš„å¥½åœ°æ–¹</li><li>åœ¨æ­¤é’©å­å‡½æ•°ä¸­å¯ä»¥ç›´æ¥è°ƒç”¨ setState()ï¼Œä½†ä¼šè§¦å‘é¢å¤–çš„æ¸²æŸ“ï¼Œè°ƒç”¨ä¸¤æ¬¡ renderï¼Œå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚æ‰€ä»¥å¦‚æœä¸ä¾èµ– DOMï¼Œåšæ•°æ®åˆå§‹åŒ–æœ€å¥½æ˜¯ç”¨constructorã€‚å½“ç„¶å¦‚æœä½¿ç”¨ redux ä½œä¸ºæ•°æ®å­˜å‚¨å°±æ— å…³ç´§è¦äº†ã€‚å› ä¸º redux ä½œåˆå§‹æ•°æ®è½½å…¥æ—¶ï¼Œæ˜¯å¯ä»¥ä¸éœ€é€è¿‡ react ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚</li></ul><p><strong>æŒ‚è½½é˜¶æ®µå³å°†åºŸå¼ƒçš„é’©å­å‡½æ•°</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * componentWillMount * ä» 15 æ›´æ–°åˆ° 16 åä¸å»ºè®®ä½¿ç”¨ï¼Œè¯¥åç§°å°†ç»§ç»­ä½¿ç”¨è‡³ React 17 * å®ƒåœ¨ render() ä¹‹å‰è°ƒç”¨ï¼Œå› æ­¤åœ¨æ­¤æ–¹æ³•ä¸­åŒæ­¥è°ƒç”¨ setState() ä¸ä¼šè§¦å‘é¢å¤–æ¸²æŸ“ * æ­¤é’©å­åšçš„äº‹æƒ…å®Œå…¨å¯ä»¥åœ¨ constructor ä¸­åšåˆ°ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°æ²¡ä»€ä¹ˆå­˜åœ¨æ„Ÿ */</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ›´æ–°é˜¶æ®µï¼ˆUpdationï¼‰"><a href="#æ›´æ–°é˜¶æ®µï¼ˆUpdationï¼‰" class="headerlink" title="æ›´æ–°é˜¶æ®µï¼ˆUpdationï¼‰"></a>æ›´æ–°é˜¶æ®µï¼ˆUpdationï¼‰<hr></h3><p>ç»„ä»¶ stateï¼Œprops å˜åŒ–å¼•å‘çš„é‡æ–°æ¸²æŸ“çš„è¿‡ç¨‹ï¼Œå°†ä¾æ¬¡è°ƒç”¨ä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span> <span class="token punctuation">}</span>  shouldComponentUpdate <span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">}</span>  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>getDerivedStateFromProps(props,state) åœ¨ç»„ä»¶æŒ‚è½½é˜¶æ®µæœ‰è¯´æ˜ï¼Œåœ¨æ›´æ–°é˜¶æ®µç”¨æ³•ä¸€æ ·ï¼Œå°±ä¸å¤šåšä»‹ç»äº†</p></blockquote><blockquote><p>shouldComponentUpdate (nextProps, nextState)</p></blockquote><p>æ­¤é’©å­é¦–æ¬¡æ¸²æŸ“è°ƒç”¨ render çš„æ—¶å€™ä¸ä¼šè¢«è§¦å‘ï¼Œåœ¨æ›´æ–°é˜¶æ®µæ¥æ”¶åˆ°æ–°çš„ state æˆ–è€… props çš„æ—¶å€™ä¼šåœ¨ render æ–¹æ³•å‰é¢è¢«è°ƒç”¨ï¼Œä½¿ç”¨æ­¤é’©å­åº”æ³¨æ„å‡ ä¸ªåœ°æ–¹</p><ul><li>é¦–æ¬¡æ¸²æŸ“æˆ–ä½¿ç”¨ forceUpdate() æ—¶ä¸ä¼šè°ƒç”¨è¯¥æ–¹æ³•</li><li>é»˜è®¤è¡Œä¸ºæ˜¯å½“ props æˆ– state å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ­¤é’©å­ä¼šåœ¨ render ä¹‹å‰è¢«è°ƒç”¨ï¼Œè¿”å›é»˜è®¤ true</li><li>å¦‚æœè¦æ‰‹åŠ¨çš„è¿”å› falseï¼Œåˆ™ä¼šè·³è¿‡æ›´æ–°é˜¶æ®µï¼Œä¸ä¼šæ‰§è¡Œ UNSAFE_componentWillUpdate()ï¼Œrender() å’Œ componentDidUpdate()</li><li>ä¸å»ºè®®åœ¨æ­¤é’©å­ä¸­è¿›è¡Œæ·±å±‚æ¬¡çš„æ¯”è¾ƒæˆ–ä½¿ç”¨ JSON.stringify()ã€‚è¿™æ ·éå¸¸å½±å“æ•ˆç‡ï¼Œä¸”ä¼šæŸå®³æ€§èƒ½ã€‚</li><li>æ­¤é’©å­å¯ä»¥å¯¹ react è¿›è¡Œæ€§èƒ½ä¸Šçš„ä¼˜åŒ–ï¼Œå› ä¸ºå› ä¸ºçˆ¶ç»„ä»¶çš„é‡æ–°æ›´æ–°ï¼Œä¼šé€ æˆå®ƒä¸‹é¢æ‰€æœ‰çš„å­ç»„ä»¶é‡æ–°æ‰§è¡Œ render æ–¹æ³•ï¼Œå½¢æˆæ–°çš„è™šæ‹ŸDOMï¼Œåœ¨è¿›è¡Œæ¯”å¯¹å†³å®šæ˜¯å¦é‡æ–°æ¸²æŸ“ï¼Œå½±å“æ€§èƒ½ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°† this.props ä¸ nextProps ä»¥åŠ this.state ä¸nextState è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶è¿”å› false ä»¥å‘ŠçŸ¥ React å¯ä»¥è·³è¿‡æ›´æ–°ã€‚ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨å†…ç½®çš„ PureComponent ç»„ä»¶ï¼Œæ¥è¿›è¡Œæµ…å±‚æ¯”è¾ƒï¼Œå‡å°‘è·³è¿‡æ›´æ–°çš„å¿…è¦æ€§ã€‚</li></ul><blockquote><p>render () æ ¹æ®æ–°çš„çŠ¶æ€å¯¹è±¡é‡æ–°æŒ‚è½½(æ¸²æŸ“)ç»„ä»¶ï¼Œåœ¨æŒ‚è½½é˜¶æ®µæœ‰è¯´æ˜ï¼Œåœ¨æ›´æ–°é˜¶æ®µï¼Œå°±ä¸å¤šåšä»‹ç»äº†</p></blockquote><blockquote><p>getSnapshotBeforeUpdateï¼ˆprevProps, prevStateï¼‰</p></blockquote><p>æ­¤é’©å­è§¦å‘çš„æ—¶æœºæ˜¯å‘ç”Ÿåœ¨ç»„ä»¶æ›´æ–°é˜¶æ®µï¼Œåœ¨ render é‡æ–°æ¸²æŸ“ä¹‹åï¼Œç»„ä»¶ DOM æ¸²æŸ“ä¹‹å‰ï¼Œè¿”å›ä¸€ä¸ªå€¼ï¼Œä¸º componentDidUpdate çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼›é…åˆ componentDidUpdateï¼Œ å¯ä»¥è¦†ç›– componentWillUpdate çš„æ‰€æœ‰ç”¨æ³•ã€‚</p><ul><li>æ­¤é’©å­å¯ä»¥å¤„ç†å¼‚æ­¥åŠ è½½èµ„æºå’Œç»„ä»¶åœ¨å‘ç”Ÿæ›´æ”¹ä¹‹å‰ä» DOM ä¸­æ•è·ä¸€äº›ä¿¡æ¯ï¼ˆå¦‚æ»šåŠ¨ä½ç½®ç­‰ï¼‰</li><li>åº”è¿”å› snapshot çš„å€¼ï¼ˆæˆ– nullï¼‰</li></ul><blockquote><p>componentDidUpdateï¼ˆprevProps, prevState, snapshotï¼‰</p></blockquote><p>æ­¤é’©å­é¦–æ¬¡æ¸²æŸ“è°ƒç”¨ render çš„æ—¶å€™ä¸ä¼šè¢«è§¦å‘ï¼Œåœ¨æ›´æ–°åè¢«ç«‹å³è°ƒç”¨</p><ul><li>å½“ç»„ä»¶æ›´æ–°åï¼Œå¯ä»¥åœ¨æ­¤å¤„å¯¹ DOM è¿›è¡Œæ“ä½œ</li><li>å¦‚æœä½ å¯¹æ›´æ–°å‰åçš„ props è¿›è¡Œäº†æ¯”è¾ƒï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åœ¨æ­¤å¤„è¿›è¡Œç½‘ç»œè¯·æ±‚</li><li>å¯ä»¥åœ¨æ­¤é’©å­ä¸­ç›´æ¥è°ƒç”¨ setState()ï¼Œä½†è¯·æ³¨æ„å®ƒå¿…é¡»è¢«åŒ…è£¹åœ¨ä¸€ä¸ªæ¡ä»¶è¯­ä»¶é‡Œï¼Œå¦åˆ™ä¼šé€ æˆæ­»å¾ªç¯ã€‚å®ƒè¿˜ä¼šé€ æˆé¢å¤–çš„é‡æ–°æ¸²æŸ“ï¼Œå½±å“æ€§èƒ½ã€‚</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å…¸å‹ç”¨æ³•ï¼ˆä¸è¦å¿˜è®°æ¯”è¾ƒ propsï¼‰ï¼š</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>userID <span class="token operator">!==</span> prevProps<span class="token punctuation">.</span>userID<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>userID<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ›´æ–°é˜¶æ®µå³å°†åºŸå¼ƒçš„é’©å­å‡½æ•°</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * componentWillReceivePropså’Œ componentWillUpdate * ä» 15 æ›´æ–°åˆ° 16 åä¸å»ºè®®ä½¿ç”¨ï¼Œè¯¥åç§°å°†ç»§ç»­ä½¿ç”¨è‡³ React 17 * componentWillReceiveProps ç»„ä»¶æ”¶åˆ°æ–°çš„å±æ€§å¯¹è±¡æ—¶è°ƒç”¨ï¼Œé¦–æ¬¡æ¸²æŸ“ä¸ä¼šè§¦å‘ * componentWillUpdate ç»„ä»¶æ›´æ–°ä¹‹å‰è°ƒç”¨çš„é’©å­å‡½æ•° */</span>componentWillReceiveProps <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>componentWillUpdate <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å¸è½½é˜¶æ®µï¼ˆUnmountingï¼‰"><a href="#å¸è½½é˜¶æ®µï¼ˆUnmountingï¼‰" class="headerlink" title="å¸è½½é˜¶æ®µï¼ˆUnmountingï¼‰"></a>å¸è½½é˜¶æ®µï¼ˆUnmountingï¼‰<hr></h3><p>ç»„ä»¶å¸è½½ä¹‹å‰è°ƒç”¨æ­¤é’©å­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>componentWillUnmount()</p></blockquote><p>æ­¤é’©å­ä¼šåœ¨ç»„ä»¶å¸è½½åŠé”€æ¯ä¹‹å‰ç›´æ¥è°ƒç”¨ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­æ‰§è¡Œå¿…è¦çš„æ¸…ç†æ“ä½œï¼Œä¾‹å¦‚ï¼Œæ¸…é™¤ timerï¼Œå–æ¶ˆç½‘ç»œè¯·æ±‚æˆ–æ¸…é™¤åœ¨ componentDidMount() ä¸­åˆ›å»ºçš„è®¢é˜…ç­‰</p><ul><li>æ­¤é’©å­ä¸åº”è°ƒç”¨ setState()ï¼Œå› ä¸ºè¯¥ç»„ä»¶å°†æ°¸è¿œä¸ä¼šé‡æ–°æ¸²æŸ“ã€‚ç»„ä»¶å®ä¾‹å¸è½½åï¼Œå°†æ°¸è¿œä¸ä¼šå†æŒ‚è½½å®ƒ</li></ul><h3 id="å…¶ä»–é’©å­"><a href="#å…¶ä»–é’©å­" class="headerlink" title="å…¶ä»–é’©å­"></a>å…¶ä»–é’©å­<hr></h3><p>å½“æ¸²æŸ“è¿‡ç¨‹ï¼Œç”Ÿå‘½å‘¨æœŸï¼Œæˆ–å­ç»„ä»¶çš„æ„é€ å‡½æ•°ä¸­æŠ›å‡ºé”™è¯¯æ—¶ï¼Œä¼šè°ƒç”¨å¦‚ä¸‹æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ä¸¤ä¸ªé’©å­ç”¨å…¶ä¸­ä¸€ä¸ªå°±å¯ä»¥</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Error boundaries ç»„ä»¶ä¼šæ•è·åœ¨æ¸²æŸ“æœŸé—´ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»¥åŠå…¶æ•´ä¸ªæ ‘çš„æ„é€ å‡½æ•°ä¸­å‘ç”Ÿçš„é”™è¯¯</li><li>Error boundaries ä»…æ•è·ç»„ä»¶æ ‘ä¸­ä»¥ä¸‹ç»„ä»¶ä¸­çš„é”™è¯¯ã€‚ä½†å®ƒæœ¬èº«çš„é”™è¯¯æ— æ³•æ•è·ã€‚</li><li>å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œä½ å¯ä»¥é€šè¿‡è°ƒç”¨ setState ä½¿ç”¨ componentDidCatch() æ¸²æŸ“é™çº§ UIï¼Œä½†åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å°†ä¸æ¨èè¿™æ ·åšã€‚ å¯ä»¥ä½¿ç”¨é™æ€ getDerivedStateFromError() æ¥å¤„ç†é™çº§æ¸²æŸ“ã€‚</li></ul><blockquote><p>static getDerivedStateFromError() ä¼šåœ¨æ¸²æŸ“é˜¶æ®µè°ƒç”¨ï¼Œå› æ­¤ä¸å…è®¸å‡ºç°å‰¯ä½œç”¨ã€‚ å¦‚é‡æ­¤ç±»æƒ…å†µï¼Œè¯·æ”¹ç”¨ componentDidCatch()ã€‚</p></blockquote><p>æ­¤é’©å­ä¼šåœ¨åä»£ç»„ä»¶æŠ›å‡ºé”™è¯¯åè¢«è°ƒç”¨ã€‚ å®ƒå°†æŠ›å‡ºçš„é”™è¯¯ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå€¼ä»¥æ›´æ–° state</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ›´æ–° state ä½¿ä¸‹ä¸€æ¬¡æ¸²æŸ“å¯ä»¥é™çº§ UI</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ä½ å¯ä»¥æ¸²æŸ“ä»»ä½•è‡ªå®šä¹‰çš„é™çº§  UI</span>      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">></span>Something went wrong<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>componentDidCatch(error, info) ä¼šåœ¨ â€œæäº¤â€ é˜¶æ®µè¢«è°ƒç”¨ï¼Œå› æ­¤å…è®¸æ‰§è¡Œå‰¯ä½œç”¨ã€‚ ç”¨äºè®°å½•é”™è¯¯ä¹‹ç±»çš„æƒ…å†µ.</p></blockquote><p>æ­¤ç”Ÿå‘½å‘¨æœŸåœ¨åä»£ç»„ä»¶æŠ›å‡ºé”™è¯¯åè¢«è°ƒç”¨ã€‚ å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li>error â€”â€” æŠ›å‡ºçš„é”™è¯¯ã€‚</li><li>info â€”â€” å¸¦æœ‰ componentStack key çš„å¯¹è±¡ã€‚</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ›´æ–° state ä½¿ä¸‹ä¸€æ¬¡æ¸²æŸ“å¯ä»¥æ˜¾ç¤ºé™çº§ UI</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// "ç»„ä»¶å †æ ˆ" ä¾‹å­:</span>    <span class="token comment" spellcheck="true">//   in ComponentThatThrows (created by App)</span>    <span class="token comment" spellcheck="true">//   in ErrorBoundary (created by App)</span>    <span class="token comment" spellcheck="true">//   in div (created by App)</span>    <span class="token comment" spellcheck="true">//   in App</span>    <span class="token function">logComponentStackToMyService</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>componentStack<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ä½ å¯ä»¥æ¸²æŸ“ä»»ä½•è‡ªå®šä¹‰çš„é™çº§ UI</span>      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">></span>Something went wrong<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç‰ˆæœ¬å¯¹æ¯”å›¾"><a href="#ç‰ˆæœ¬å¯¹æ¯”å›¾" class="headerlink" title="ç‰ˆæœ¬å¯¹æ¯”å›¾"></a>ç‰ˆæœ¬å¯¹æ¯”å›¾<hr></h3><img src="/images/library-react-lifecycle01.png"><p>é€šè¿‡ä¸Šé¢ç‰ˆæœ¬å¯¹æ¯”å›¾æˆ‘ä»¬èƒ½å¤Ÿå¾ˆæ¸…æ™°çš„çœ‹åˆ°åœ¨ Mounting å’Œ Updation é˜¶æ®µ16ç‰ˆæœ¬å¢åŠ äº†æ·±è“è‰²éƒ¨åˆ†ã€‚ </p><ul><li>16ç‰ˆæœ¬ä¸­ componentWillMountã€componentWillReceivePropsã€componmentWillUpdate è¢«æ ‡è®°ä¸ºä¸å®‰å…¨çš„é’©å­ï¼Œåœ¨17ç‰ˆæœ¬ä¸­è¢«ç§»é™¤</li><li>å¢åŠ äº† getDeriveStateFromPropsã€getSnapshotBeforeUpdateã€‚</li><li>å¢åŠ äº†é”™è¯¯å¤„ç†çš„é’©å­åˆ†åˆ«ä¸º componentDidCatchã€getDerivedStateFromError</li></ul><h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾<hr></h3><img src="/images/library-react-lifecycle02.png"><h3 id="æ‰§è¡Œé¡ºåº"><a href="#æ‰§è¡Œé¡ºåº" class="headerlink" title="æ‰§è¡Œé¡ºåº"></a>æ‰§è¡Œé¡ºåº<hr></h3><p>ç”¨ä¸‹é¢çš„ä¾‹å­è¿›è¡Œæµ‹è¯•</p><p>çˆ¶ç»„ä»¶</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./ToDo.css'</span><span class="token punctuation">;</span><span class="token keyword">import</span> ToDoItem <span class="token keyword">from</span> <span class="token string">'./components/ToDoItem'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">ToDo</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// this is where the data goes</span>      list<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>          <span class="token string">'todo'</span><span class="token punctuation">:</span> <span class="token string">'clean the house'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>          <span class="token string">'todo'</span><span class="token punctuation">:</span> <span class="token string">'buy milk'</span>        <span class="token punctuation">}</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      todo<span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getDerivedStateFromPropsçˆ¶'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentDidMountçˆ¶'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'shouldComponentUpdateçˆ¶'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span>  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getSnapshotBeforeUpdateçˆ¶'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentDidUpdateçˆ¶'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentWillUnmountçˆ¶'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  createNewToDoItem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> list<span class="token punctuation">,</span> todo <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>      list<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token operator">...</span>list<span class="token punctuation">,</span>        <span class="token punctuation">{</span>          todo        <span class="token punctuation">}</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      todo<span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  handleKeyPress <span class="token operator">=</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">'Enter'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createNewToDoItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  handleInput <span class="token operator">=</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      todo<span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// this is now being emitted back to the parent from the child component</span>  deleteItem <span class="token operator">=</span> indexToDelete <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> list <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>      list<span class="token punctuation">:</span> list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>toDo<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> index <span class="token operator">!==</span> indexToDelete<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render çˆ¶"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDo"</span><span class="token operator">></span>        <span class="token operator">&lt;</span>h1 className<span class="token operator">=</span><span class="token string">"ToDo-Header"</span><span class="token operator">></span>React To Do<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDo-Container"</span><span class="token operator">></span>          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDo-Content"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>ToDoItem <span class="token operator">/</span><span class="token operator">></span>            <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>              <span class="token keyword">return</span> <span class="token operator">&lt;</span>ToDoItem                key<span class="token operator">=</span><span class="token punctuation">{</span>key<span class="token punctuation">}</span>                item<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>todo<span class="token punctuation">}</span>                deleteItem<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>deleteItem<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">}</span>              <span class="token operator">/</span><span class="token operator">></span>            <span class="token punctuation">}</span>            <span class="token punctuation">)</span><span class="token punctuation">}</span>          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>          <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>todo<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleInput<span class="token punctuation">}</span> onKeyPress<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleKeyPress<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDo-Add"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>createNewToDoItem<span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ToDo<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å­ç»„ä»¶</p><pre class="line-numbers language-js"><code class="language-js">mport React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./ToDoItem.css'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">ToDoItem</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      item<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>item    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getDerivedStateFromPropså­'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentDidMountå­'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'shouldComponentUpdateå­'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span>  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getSnapshotBeforeUpdateå­'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentDidUpdateå­'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentWillUnmountå­'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render å­"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDoItem"</span><span class="token operator">></span>        <span class="token operator">&lt;</span>p className<span class="token operator">=</span><span class="token string">"ToDoItem-Text"</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>item<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDoItem-Delete"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>deleteItem<span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">-</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ToDoItem<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨çˆ¶ç»„ä»¶</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./index.css'</span><span class="token punctuation">;</span><span class="token keyword">import</span> ToDo <span class="token keyword">from</span> <span class="token string">'./ToDo'</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>ToDo <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç çœ‹çš„åˆå§‹åŒ–æ‰§è¡Œé¡ºåºæ˜¯</p><image src="/images/library-react-lifecycle03.jpg"><p>å¯ä»¥çœ‹åˆ°å…ˆæ‰§è¡Œ</p><ul><li>çˆ¶ç»„ä»¶çš„ getDerivedStateFromProps -&gt; render</li><li>å­ç»„ä»¶çš„ getDerivedStateFromProps -&gt; render</li><li>å­ç»„ä»¶çš„ componentDidMount</li><li>çˆ¶ç»„ä»¶çš„ componentDidMount</li></ul><p>æ›´æ–°é˜¶æ®µæ‰§è¡Œçš„é¡ºåºæ˜¯<br><image src="/images/library-react-lifecycle04.jpg"></image></p><ul><li>çˆ¶ç»„ä»¶çš„ getDerivedStateFromProps -&gt; shouldComponentUpdate -&gt; render</li><li>å­ç»„ä»¶çš„ getDerivedStateFromProps -&gt; shouldComponentUpdate -&gt; render</li><li>å­ç»„ä»¶ getSnapshotBeforeUpdate</li><li>çˆ¶ç»„ä»¶ getSnapshotBeforeUpdate</li><li>å­ç»„ä»¶ componentWillUnmountï¼ˆå› ä¸ºåˆ é™¤äº†å­ç»„ä»¶ï¼‰</li><li>å­ç»„ä»¶çš„ componentDidUpdate</li><li>çˆ¶ç»„ä»¶çš„ componentDidUpdate</li></ul><h3 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h3><p><a href="https://zh-hans.reactjs.org/docs/react-component.html" target="_blank" rel="noopener">ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ<a></a></a></p></image>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React åŸç†ä¹‹ JSX è½¬æ¢</title>
      <link href="/2019/10/01/react/library-react-jsx/"/>
      <url>/2019/10/01/react/library-react-jsx/</url>
      
        <content type="html"><![CDATA[<h2 id="JSX-è½¬æ¢"><a href="#JSX-è½¬æ¢" class="headerlink" title="JSX è½¬æ¢"></a>JSX è½¬æ¢</h2><p>åœ¨æˆ‘ä»¬å†™ react ç»„ä»¶çš„æ—¶å€™éƒ½ä¼šå»å†™ jsxï¼Œé‚£ä¹ˆ jsx åœ¨ react å†…éƒ¨åˆ°åº•æ˜¯æ€ä¹ˆè¿›è¡Œè½¬æ¢ç¼–è¯‘çš„å‘¢ï¼Ÿ</p><h3 id="babel-è½¬æ¢"><a href="#babel-è½¬æ¢" class="headerlink" title="babel è½¬æ¢"></a>babel è½¬æ¢<hr></h3><p>åœ¨è¿›è¡Œè½¬æ¢ç¼–è¯‘ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥é…ç½®ç¯å¢ƒã€‚è¿™æ ·æ–¹ä¾¿æˆ‘ä»¬æŸ¥çœ‹è½¬æ¢åçš„ä»£ç ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿä½¿ç”¨ babel å»ç¼–è¯‘ï¼Œä½†è¿™é‡Œåªæ˜¯ç®€å•çš„è¯´æ˜ jsx è½¬æ¢ï¼Œæ‰€ä»¥ä¸å»é…ç½® .babelrc æˆ–è€…å…¶ä»–é…ç½®æ–¹å¼ã€‚</p><p>æ‰§è¡Œä¸‹é¢æ­¥éª¤</p><ul><li>åˆ›å»ºå¹¶è¿›å…¥æ–‡ä»¶å¤¹</li><li>åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ npm init -y </li><li>åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ npm install babel-cli@6 babel-preset-react-app@3</li><li>åˆ›å»º demo.html,å¹¶å†™å…¥</li></ul><pre class="line-numbers language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, initial-scale<span class="token punctuation">=</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ie<span class="token punctuation">=</span>edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/react@16/umd/react.development.js<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/react-dom@16/umd/react-dom.development.js<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>demo.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>åˆ›å»º src æ–‡ä»¶å¤¹ï¼Œåœ¨ src æ–‡ä»¶ä¸­åˆ›å»º demo.jsxï¼Œå¹¶å†™å…¥</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">]</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>ul<span class="token operator">></span>      <span class="token punctuation">{</span>        arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span> <span class="token operator">></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>  <span class="token operator">&lt;</span>App key<span class="token operator">=</span><span class="token string">"app"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ‰§è¡Œ npx babel â€“watch src â€“out-dir . â€“presets react-app/prod</li></ul><p>ç»è¿‡ babel ç¼–è¯‘ä¹‹åçš„ä»£ç ä¸º</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>    <span class="token string">"ul"</span><span class="token punctuation">,</span>    <span class="token keyword">null</span><span class="token punctuation">,</span>    arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>        <span class="token string">"li"</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> key<span class="token punctuation">:</span> index <span class="token punctuation">}</span><span class="token punctuation">,</span>        item      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>App<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢ç¼–è¯‘å®Œæˆçš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ° jsx åªæ˜¯ä¸º <code>React.createElement(component, props, ...children)</code> æ–¹æ³•æä¾›çš„è¯­æ³•ç³–ï¼Œå®é™…ä¸Šå’Œç›´æ¥å†™ <code>React.createElementï¼ˆï¼‰</code> ç­‰ä»·ï¼Œåªæ˜¯ babel å¸®åŠ©æˆ‘ä»¬å®Œæˆäº†è¿™ä¸ªè½¬æ¢çš„è¿‡ç¨‹</p><p><em><code>æ³¨æ„ babel åœ¨ç¼–è¯‘æ—¶ä¼šåˆ¤æ–­ jsx ä¸­ç»„ä»¶çš„é¦–å­—æ¯ï¼Œå½“é¦–å­—æ¯ä¸ºå°å†™æ—¶ï¼Œå…¶è¢«è®¤å®šä¸ºåŸç”ŸDOMæ ‡ç­¾ï¼ŒcreateElement çš„ç¬¬ä¸€ä¸ªå˜é‡è¢«ç¼–è¯‘ä¸ºå­—ç¬¦ä¸²ï¼Œå½“é¦–å­—æ¯ä¸ºå¤§å†™æ—¶ï¼Œå…¶è¢«è®¤å®šä¸ºè‡ªå®šä¹‰ç»„ä»¶ï¼ŒcreateElement çš„ç¬¬ä¸€ä¸ªå˜é‡è¢«ç¼–è¯‘ä¸ºå¯¹è±¡ï¼›</code></em></p><h3 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement<hr></h3><p>åœ¨è¿›è¡Œç¼–è¯‘çš„æ—¶å€™ jsx ä¸»è¦è°ƒç”¨äº† React.createElement å‡½æ•°ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨ï¼ˆæ³¨æ„æœ¬æ–‡ä¸»è¦ä¾æ‰˜äºæºç  v16.9.0 ç‰ˆæœ¬)ï¼Œ å®šä¹‰åœ¨ <code>react/packages/react/src/React.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">import</span> <span class="token punctuation">{</span>  createElement<span class="token punctuation">,</span>  createFactory<span class="token punctuation">,</span>  cloneElement<span class="token punctuation">,</span>  isValidElement<span class="token punctuation">,</span>  jsx<span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactElement'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰¾åˆ° <code>react/packages/react/src/ReactElement.js</code> æ–‡ä»¶ä¸­å®šä¹‰çš„ ReactElement æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">const</span> ReactElement <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> self<span class="token punctuation">,</span> source<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// This tag allows us to uniquely identify this as a React Element</span>    $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> REACT_ELEMENT_TYPE<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// Built-in properties that belong on the element</span>    type<span class="token punctuation">:</span> type<span class="token punctuation">,</span>    key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>    ref<span class="token punctuation">:</span> ref<span class="token punctuation">,</span>    props<span class="token punctuation">:</span> props<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// Record the component responsible for creating this element.</span>    _owner<span class="token punctuation">:</span> owner<span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">return</span> element<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> propName<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Reserved names are extracted</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 1. å¤„ç† props</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 2. è·å–å¹¶å¤„ç† children èŠ‚ç‚¹</span>  <span class="token keyword">const</span> childrenLength <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 3. å¤„ç†é»˜è®¤ props</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// 4. è¿”å› ReactElement å¯¹è±¡</span>  <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>    type<span class="token punctuation">,</span>    key<span class="token punctuation">,</span>    ref<span class="token punctuation">,</span>    self<span class="token punctuation">,</span>    source<span class="token punctuation">,</span>    ReactCurrentOwner<span class="token punctuation">.</span>current<span class="token punctuation">,</span>    props<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ° createElement ä¸»è¦çš„ä½œç”¨å¾ˆç®€å•å°±æ˜¯å°† props å’Œå­å…ƒç´ è¿›è¡Œå¤„ç†ä¹‹åè¿”å›ä¸€ä¸ª ReactElement å¯¹è±¡ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æä¸Šé¢ä¸‰ä¸ªæ­¥éª¤</p><blockquote><p>1.å¤„ç† props</p></blockquote><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasValidRef</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      ref <span class="token operator">=</span> config<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasValidKey</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      key <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">+</span> config<span class="token punctuation">.</span>key<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    self <span class="token operator">=</span> config<span class="token punctuation">.</span>__self <span class="token operator">===</span> undefined <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span>    source <span class="token operator">=</span> config<span class="token punctuation">.</span>__source <span class="token operator">===</span> undefined <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Remaining properties are added to a new props object</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>propName <span class="token keyword">in</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> propName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token operator">!</span>RESERVED_PROPS<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ä» config ä¸­å–å‡ºrefï¼Œkey</li><li>ä» config ä¸­å–å‡º selfï¼Œsource</li><li>å°†é™¤ç‰¹æ®Šå±æ€§çš„å…¶ä»–å±æ€§å–å‡ºå¹¶èµ‹å€¼ç»™ props</li></ul><blockquote><p>2.è·å–å¹¶å¤„ç† children èŠ‚ç‚¹</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> childrenLength <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> childArray <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>childrenLength<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    childArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>freeze<span class="token punctuation">)</span> <span class="token punctuation">{</span>      Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>childArray<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  props<span class="token punctuation">.</span>children <span class="token operator">=</span> childArray<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è·å–ç¬¬äºŒä¸ªå‚æ•°åé¢çš„æ‰€æœ‰å‚æ•°</li><li>å¦‚æœåªæœ‰ä¸€ä¸ªå­å…ƒç´ ï¼Œç›´æ¥èµ‹å€¼ç»™ props.children</li><li>å¦‚æœæœ‰å¤šä¸ªå­å…ƒç´ ï¼Œå°†å­å…ƒç´ æ”¹å˜ä¸ºæ•°ç»„èµ‹å€¼ç»™ props.children</li></ul><blockquote><p>3.å¤„ç†é»˜è®¤ props</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> defaultProps <span class="token operator">=</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>propName <span class="token keyword">in</span> defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>        props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> defaultProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†ç»„ä»¶çš„é™æ€å±æ€§ defaultProps èµ‹å€¼ç»™å®šä¹‰çš„é»˜è®¤ props </p><blockquote><p>4.è¿”å› ReactElement</p></blockquote><p>å¯ä»¥çœ‹åˆ° ReactElement å‡½æ•°å°†å‡ ä¸ªå‚æ•°è¿›è¡Œé‡æ–°ç»„åˆï¼Œæœ€åè¿”å›ç»„åˆçš„å¯¹è±¡ elementï¼Œé‚£ä¹ˆè¿™å‡ ä¸ªå‚æ•°çš„æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿ</p><ul><li>typeï¼šå…ƒç´ çš„ç±»å‹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–è€…æ˜¯å‡½æ•°</li><li>keyï¼šç»„ä»¶çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºDiffç®—æ³•</li><li>refï¼šç”¨äºç›´æ¥è®¿é—®åŸç”Ÿçš„ DOM</li><li>propsï¼šç»„ä»¶é€šä¿¡çš„ props</li><li>ownerï¼šç»´æŠ¤åœ¨æ„å»ºè™šæ‹ŸDOMè¿‡ç¨‹ä¸­ï¼Œéšæ—¶ä¼šå˜åŠ¨çš„å˜é‡çš„ä¸´æ—¶ä¿å­˜ä½ç½®æ‰€åœ¨ï¼Œæ˜¯è¯†åˆ«è‡ªå®šä¹‰ç»„ä»¶çš„å…³é”®</li><li>$$typeofï¼š ä¸€ä¸ª Symbol ç±»å‹çš„å˜é‡ï¼Œé˜²æ­¢XSS</li></ul><p>$$typeof åœ¨ ReactElement ä¸­è¢«èµ‹å€¼ä¸º <code>REACT_ELEMENT_TYPE</code>ï¼Œå®šä¹‰åœ¨ <code>react/packages/shared/ReactSymbols.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> hasSymbol <span class="token operator">=</span> <span class="token keyword">typeof</span> Symbol <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> REACT_ELEMENT_TYPE <span class="token operator">=</span> hasSymbol  <span class="token operator">?</span> Symbol<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token string">'react.element'</span><span class="token punctuation">)</span>  <span class="token punctuation">:</span> <span class="token number">0xeac7</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢åˆ¤æ–­ï¼Œå¦‚æœå½“å‰ç¯å¢ƒæ”¯æŒ Symbolï¼Œ é‚£ä¹ˆå°±æ˜¯ç”¨ Symbol.for æ¥è¿›è¡Œç»„ä»¶çš„æ ‡ç¤ºï¼Œå¦åˆ™ $$typeof è¢«èµ‹å€¼ä¸º 0xeac7ã€‚è‡³äºä¸ºä»€ä¹ˆ React å¼€å‘è€…ç»™å‡ºäº†ç­”æ¡ˆï¼š0xeac7çœ‹èµ·æ¥æœ‰ç‚¹åƒ React ğŸ˜„ğŸ˜„ğŸ˜„ ï¼ˆå¦‚æœä¸ç†Ÿæ‚‰ Symbol.forï¼Œè¯·å‚è€ƒ<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Symbol/for" target="_blank" rel="noopener">MDN</a>ã€‚ï¼‰<br>å½“ React æ¸²æŸ“æ—¶ä¼šæŠŠæ²¡æœ‰ $$typeof æ ‡è¯†çš„ä»¥åŠè§„åˆ™æ ¡éªŒä¸é€šè¿‡çš„ç»„ä»¶è¿‡æ»¤æ‰ï¼Œè¿™æ ·å°±çŸ¥é“äº† React ç»„ä»¶æ˜¯å¦æ˜¯æœ‰æ•ˆçš„</p><pre class="line-numbers language-js"><code class="language-js">ReactElement<span class="token punctuation">.</span>isValidElement <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">typeof</span> object <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> object <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> object<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> REACT_ELEMENT_TYPE<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“<hr></h3><p>é€šè¿‡ä¸Šè¿°åˆ†ææˆ‘ä»¬çŸ¥é“äº† React.createElement å®é™…ä¸Šè¿”å›çš„æ˜¯ä¸€ä¸ªç‰¹å®šæ ¼å¼çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¤§è‡´å¦‚ä¸‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>  $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span>  key<span class="token punctuation">:</span> <span class="token keyword">null</span>  props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  ref<span class="token punctuation">:</span> <span class="token keyword">null</span>  type<span class="token punctuation">:</span> Æ’ <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  _owner<span class="token punctuation">:</span> <span class="token keyword">null</span>  _store<span class="token punctuation">:</span> <span class="token punctuation">{</span>validated<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>  _self<span class="token punctuation">:</span> <span class="token keyword">null</span>  _source<span class="token punctuation">:</span> <span class="token keyword">null</span>  __proto__<span class="token punctuation">:</span> Object<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="React-Children-åŸç†"><a href="#React-Children-åŸç†" class="headerlink" title="React.Children åŸç†"></a>React.Children åŸç†</h2><p>åœ¨ createElement æ–¹æ³•ä¸­æ‰§è¡Œäº† props.childrenï¼Œé‚£å®ƒåˆ°åº•åœ¨é‚£è¿›è¡Œå¤„ç†çš„å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç» React.Children æ–¹æ³•ï¼Œå®šä¹‰åœ¨<code>react/packages/react/src/React.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">import</span> <span class="token punctuation">{</span>forEach<span class="token punctuation">,</span> map<span class="token punctuation">,</span> count<span class="token punctuation">,</span> toArray<span class="token punctuation">,</span> only<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactChildren'</span><span class="token punctuation">;</span><span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>  Children<span class="token punctuation">:</span> <span class="token punctuation">{</span>    map<span class="token punctuation">,</span>    forEach<span class="token punctuation">,</span>    count<span class="token punctuation">,</span>    toArray<span class="token punctuation">,</span>    only<span class="token punctuation">,</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åŸç†æµç¨‹å›¾"><a href="#åŸç†æµç¨‹å›¾" class="headerlink" title="åŸç†æµç¨‹å›¾"></a>åŸç†æµç¨‹å›¾<hr></h3><p>React.Children.map è°ƒåº¦çš„æ—¶å€™åˆ›å»º children èŠ‚ç‚¹é˜²â½Œå­èŠ‚ç‚¹å†…å­˜æŠ–åŠ¨ï¼Œç”±äºä»£ç é‡æ¯”è¾ƒå¤§æ‰€ä»¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æµç¨‹å›¾</p><img src="/images/react-jsx-children.png"><h3 id="map"><a href="#map" class="headerlink" title="map "></a>map <hr></h3><p>æ¥çœ‹ä¸€ä¸‹ç®€åŒ–åçš„ map ä»£ç </p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">/** * The provided mapFunction(child, key, index) will be called for each * leaf child. * * @param {?*} children Children tree container. * @param {function(*, int)} func The map function. * @param {*} context Context for mapFunction. * @return {object} Object containing the ordered map of results. */</span><span class="token keyword">function</span> <span class="token function">mapChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> children<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">mapIntoWithKeyPrefixInternal</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">function</span> <span class="token function">mapIntoWithKeyPrefixInternal</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> array<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> escapedPrefix <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>prefix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    escapedPrefix <span class="token operator">=</span> <span class="token function">escapeUserProvidedKey</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> traverseContext <span class="token operator">=</span> <span class="token function">getPooledTraverseContext</span><span class="token punctuation">(</span>    array<span class="token punctuation">,</span>    escapedPrefix<span class="token punctuation">,</span>    func<span class="token punctuation">,</span>    context<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">traverseAllChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> mapSingleChildIntoContext<span class="token punctuation">,</span> traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">releaseTraverseContext</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token punctuation">{</span>  forEachChildren <span class="token keyword">as</span> forEach<span class="token punctuation">,</span>  mapChildren <span class="token keyword">as</span> map<span class="token punctuation">,</span>  countChildren <span class="token keyword">as</span> count<span class="token punctuation">,</span>  onlyChild <span class="token keyword">as</span> only<span class="token punctuation">,</span>  toArray<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="contextPool"><a href="#contextPool" class="headerlink" title="contextPool "></a>contextPool <hr></h3><p>ä»ä¸Šé¢çš„æµç¨‹å›¾èƒ½å¤Ÿçœ‹å‡ºè°ƒç”¨è¿‡ç¨‹å’Œå‡½æ•°çš„ä½œç”¨ï¼Œé‚£ä¹ˆ ContextPool çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ getPooledTraverseContext å’Œ releaseTraverseContext æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> POOL_SIZE <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">const</span> traverseContextPool <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è·å– contextPool </span><span class="token comment" spellcheck="true">// å®é™…ä¸Šç»´æŠ¤äº†ä¸€ä¸ª size ä¸º 10 çš„ç¼“å†²æ± </span><span class="token comment" spellcheck="true">// å¦‚æœ contextPool ä¸­æœ‰å¯¹è±¡, åˆ™ pop å‡ºä¸€ä¸ªè¿›è¡Œä½¿ç”¨. å¦‚æœ contextPool ä¸ºç©º, åˆ™ return ä¸€ä¸ªæ–°çš„å¯¹è±¡</span><span class="token keyword">function</span> <span class="token function">getPooledTraverseContext</span><span class="token punctuation">(</span>  mapResult<span class="token punctuation">,</span>  keyPrefix<span class="token punctuation">,</span>  mapFunction<span class="token punctuation">,</span>  mapContext<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseContextPool<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å¤ç”¨å¯¹è±¡</span>    <span class="token keyword">const</span> traverseContext <span class="token operator">=</span> traverseContextPool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>result <span class="token operator">=</span> mapResult<span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>keyPrefix <span class="token operator">=</span> keyPrefix<span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>func <span class="token operator">=</span> mapFunction<span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>context <span class="token operator">=</span> mapContext<span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> traverseContext<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡è·å– contextPool ä¸­çš„å¯¹è±¡</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      result<span class="token punctuation">:</span> mapResult<span class="token punctuation">,</span>      keyPrefix<span class="token punctuation">:</span> keyPrefix<span class="token punctuation">,</span>      func<span class="token punctuation">:</span> mapFunction<span class="token punctuation">,</span>      context<span class="token punctuation">:</span> mapContext<span class="token punctuation">,</span>      count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// traverseContext å¤ç”¨ä¹‹åï¼Œè¿›è¡Œæ¸…ç©ºæ“ä½œ</span><span class="token comment" spellcheck="true">// è¿™é‡Œé¢æœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœ traverseContextPool å°äº 10ï¼Œå°±å°† traverseContext push åˆ° traverseContextPool ä¸­ï¼Œè¿›è¡Œå¯¹è±¡çš„å¤ç”¨</span><span class="token keyword">function</span> <span class="token function">releaseTraverseContext</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>  traverseContext<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  traverseContext<span class="token punctuation">.</span>keyPrefix <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  traverseContext<span class="token punctuation">.</span>func <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  traverseContext<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  traverseContext<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseContextPool<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> POOL_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>    traverseContextPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢æåˆ°è¿‡ React.Children.map è°ƒåº¦çš„æ—¶å€™åˆ›å»º children èŠ‚ç‚¹ï¼Œé˜²â½Œå­èŠ‚ç‚¹å†…å­˜æŠ–åŠ¨ã€‚<br>å› ä¸ºæ¯æ¬¡æ„å»ºæ–°å¯¹è±¡çš„æ—¶å€™éƒ½ä¼šå¤ç”¨ contextPoolã€‚ä¼šç›´æ¥ä» contextPool é‡Œè·å–ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ traverseContextPool.pop()ï¼Œè¿›è¡Œé‡æ–°è¿›è¡Œèµ‹å€¼ã€‚<br>å½“ä½¿ç”¨å®Œä¹‹åè°ƒç”¨ releaseTraverseContext å†æ¸…ç©ºè¿™ä¸ªå¯¹è±¡ï¼Œæœ€å push traverseContextPoolï¼ˆcontextPoolï¼‰å¯¹è±¡ä¸­ï¼Œä»¥ä¾›ä¸‹æ¬¡ä½¿ç”¨ã€‚è¿™æ ·å°±å®Œæˆäº†å¯¹å†…å­˜çš„é‡å¤ä½¿ç”¨ï¼Œé˜²æ­¢èŠ‚ç‚¹å†…å­˜æŠ–åŠ¨ã€‚<br>å¦‚æœåœ¨æ¯æ¬¡æ„å»ºèŠ‚ç‚¹çš„æ—¶å€™éƒ½é‡æ–°æ„å»ºå¯¹è±¡ï¼Œé‚£ä¹ˆç”¨å®Œä¹‹åä¼šè¢«ç³»ç»Ÿåƒåœ¾å›æ”¶ï¼Œè¿™æ ·å¯¹äºå†…å­˜æ¥è®²å°±æ˜¯åå¤åˆ†é…ï¼Œé‡Šæ”¾çš„è¿‡ç¨‹ï¼Œä¼šé€ æˆå†…å­˜æŠ–åŠ¨ã€‚</p><h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“ "></a>å°ç»“ <hr></h3><p>è‡³æ­¤, React.Children.map å°±åˆ†æå®Œäº†ï¼Œå…¶å® mapChildren å°±æ˜¯è°ƒç”¨äº† mapIntoWithKeyPrefixInternal é€šè¿‡è¿™ä¸ªå‡½æ•°æ‰§è¡Œ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">mapIntoWithKeyPrefixInternal</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> array<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> escapedPrefix <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>prefix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    escapedPrefix <span class="token operator">=</span> <span class="token function">escapeUserProvidedKey</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å°† funcï¼ˆmapFunctionï¼‰ å¤„ç†å‡½æ•°å’Œ ä¸Šä¸‹æ–‡ï¼ˆmapContextï¼‰å°è£…æˆä¸€ä¸ªå¯¹è±¡ traverseContext </span>  <span class="token keyword">const</span> traverseContext <span class="token operator">=</span> <span class="token function">getPooledTraverseContext</span><span class="token punctuation">(</span>    array<span class="token punctuation">,</span>    escapedPrefix<span class="token punctuation">,</span>    func<span class="token punctuation">,</span>    context<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ·±åº¦éå†å­å…ƒç´ , å¹¶è°ƒç”¨å¤„ç†å‡½æ•°</span>  <span class="token function">traverseAllChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> mapSingleChildIntoContext<span class="token punctuation">,</span> traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// é‡Šæ”¾ traverseContext å¯¹è±¡</span>  <span class="token function">releaseTraverseContext</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h2><p><a href="http://www.que01.top/2019/06/28/react-ReactCurrentOwner/" target="_blank" rel="noopener">React ReactCurrentOwner</a><br><a href="http://js.walfud.com/React.Children.xxx%20%E7%9A%84%E4%BD%9C%E7%94%A8/" target="_blank" rel="noopener">React.Children.xxx çš„ä½œç”¨</a></p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†ä¹‹keep-alive</title>
      <link href="/2019/09/22/vue/vuekeepalive/"/>
      <url>/2019/09/22/vue/vuekeepalive/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æˆ‘ä»¬çš„å¹³æ—¶å¼€å‘å·¥ä½œä¸­ï¼Œæœ‰å¾ˆå¤šç»„ä»¶æ²¡æœ‰å¿…è¦å¤šæ¬¡åˆå§‹åŒ–ï¼Œé€šè¿‡ç¼“å­˜ç»„ä»¶çš„çŠ¶æ€å‡å°‘æ€§èƒ½ä¸Šçš„å¼€é”€ã€‚è€Œ vue çš„ç»„ä»¶ç¼“å­˜ä¼˜åŒ–åˆ™ä½¿ç”¨å†…ç½®ç»„ä»¶ <keep-alive></keep-alive></p><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive<span class="token operator">></span>  <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢ä»£ç ç¤ºä¾‹è¯´æ˜è¢« keep-alive åŒ…å«çš„ç»„ä»¶å·²ç»æˆä¸ºè¢«ç¼“å­˜çš„ç»„ä»¶ï¼Œåªæ¸²æŸ“ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´ç”Ÿå‘½å‘¨æœŸä¹Ÿä¸èµ·ä»»ä½•ä½œç”¨ã€‚ä½†æ˜¯å¦‚æœä½ æƒ³è¦é‡æ–°åœ¨æŸä¸€ä¸ªæ—¶æœºæƒ³è¦é‡æ–°æ¸²æŸ“ï¼Œkeep-alive å†…ç½®ç»„ä»¶æä¾›äº†ä¸¤ä¸ªé’©å­å‡½æ•°</p><ul><li>activated å½“ keepalive åŒ…å«çš„ç»„ä»¶å†æ¬¡æ¸²æŸ“çš„æ—¶å€™è§¦å‘</li><li>deactivated å½“ keepalive åŒ…å«çš„ç»„ä»¶é”€æ¯çš„æ—¶å€™è§¦å‘</li></ul><p>vue å¯¹ keep-alive å†…ç½®ç»„ä»¶è¿˜æä¾›äº† 3ä¸ªå±æ€§ä½œä¸ºå‚æ•°è¿›è¡ŒåŒ¹é…å¯¹åº”çš„ç»„ä»¶è¿›è¡Œç¼“å­˜</p><ul><li>include é€šè¿‡å­—ç¬¦ä¸²ã€æ•°ç»„ã€æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…åˆ°çš„ç»„ä»¶ä¼šè¿›è¡Œç¼“å­˜</li><li>exclude é€šè¿‡å­—ç¬¦ä¸²ã€æ•°ç»„ã€æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…åˆ°çš„ç»„ä»¶ä¸ä¼šè¿›è¡Œç¼“å­˜</li><li>max é€šè¿‡è®¾ç½®å­—ç¬¦æˆ–è€…æ•°å­—æ§åˆ¶ç»„ä»¶ç¼“å­˜çš„æœ€å¤§ä¸ªæ•°</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// åªç¼“å­˜aæˆ–è€…bç»„ä»¶</span><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive include<span class="token operator">=</span><span class="token string">"a,b"</span><span class="token operator">></span>   <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span class="token comment" spellcheck="true">// cç»„ä»¶ä¸è¢«ç¼“å­˜</span><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive exclude<span class="token operator">=</span><span class="token string">"c"</span><span class="token operator">></span>   <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span class="token comment" spellcheck="true">// ç¼“å­˜çš„æœ€å¤§ä¸ªæ•°</span><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive  max<span class="token operator">=</span><span class="token string">"5"</span><span class="token operator">></span>   <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span class="token comment" spellcheck="true">// å¦‚æœåŒæ—¶ä½¿ç”¨ exclude ä¼˜å…ˆçº§é«˜äº include æ‰€ä»¥åªç¼“å­˜ a,c ç»„ä»¶</span><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive include<span class="token operator">=</span><span class="token string">"a,b,c"</span> exclude<span class="token operator">=</span><span class="token string">"b"</span><span class="token operator">></span>   <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é…åˆ-router"><a href="#é…åˆ-router" class="headerlink" title="é…åˆ router"></a>é…åˆ router</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive <span class="token punctuation">:</span>include<span class="token operator">=</span><span class="token string">"cacheList"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>router<span class="token operator">-</span>view <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åªæœ‰è·¯å¾„åŒ¹é…åˆ°çš„ name æ˜¯ cacheList æ–¹æ³•ä¸­è¿”å›çš„ç»„ä»¶åç§°å°±ä¼šè¢«ç¼“å­˜ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ‰€æœ‰è·¯ç”±éƒ½ç¼“å­˜</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive<span class="token operator">></span>  <span class="token operator">&lt;</span>router<span class="token operator">-</span>view<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> æ‰€æœ‰è·¯å¾„åŒ¹é…åˆ°çš„è§†å›¾ç»„ä»¶éƒ½ä¼šè¢«ç¼“å­˜ï¼ <span class="token operator">--</span><span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>view<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ meta å±æ€§å•ç‹¬æ§åˆ¶è·¯ç”±çš„ç¼“å­˜</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// routes é…ç½®</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span>    path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>    name<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>    component<span class="token punctuation">:</span> Home<span class="token punctuation">,</span>    meta<span class="token punctuation">:</span> <span class="token punctuation">{</span>      keepAlive<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// éœ€è¦è¢«ç¼“å­˜</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    path<span class="token punctuation">:</span> <span class="token string">'/user-registration'</span><span class="token punctuation">,</span>    name<span class="token punctuation">:</span> <span class="token string">'user-registration'</span><span class="token punctuation">,</span>    component<span class="token punctuation">:</span> UserRegistrationManager<span class="token punctuation">,</span>    meta<span class="token punctuation">:</span> <span class="token punctuation">{</span>      keepAlive<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">// ä¸éœ€è¦è¢«ç¼“å­˜</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive<span class="token operator">></span>  <span class="token operator">&lt;</span>router<span class="token operator">-</span>view v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"$route.meta.keepAlive"</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> è¿™é‡Œæ˜¯ä¼šè¢«ç¼“å­˜çš„è§†å›¾ç»„ä»¶ï¼Œæ¯”å¦‚ Homeï¼ <span class="token operator">--</span><span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>view<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span class="token operator">&lt;</span>router<span class="token operator">-</span>view v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"!$route.meta.keepAlive"</span><span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>   <span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>view<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æºç ç†è§£"><a href="#æºç ç†è§£" class="headerlink" title="æºç ç†è§£"></a>æºç ç†è§£</h3><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å·²ç»åŸºæœ¬çš„äº†è§£äº† keep-alive çš„ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡æºç æ¥åˆ†æå®ƒçš„å®ç°ï¼Œå®ƒå®šä¹‰åœ¨<code>å®šä¹‰åœ¨ src/core/components/keep-alive.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> 'keep<span class="token operator">-</span>alive<span class="token punctuation">,</span>  abstract<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  props<span class="token punctuation">:</span> <span class="token punctuation">{</span>    include<span class="token punctuation">:</span> patternTypes<span class="token punctuation">,</span>    exclude<span class="token punctuation">:</span> patternTypes<span class="token punctuation">,</span>    max<span class="token punctuation">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> Number<span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  created <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  destroyed <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keys<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  mounted <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'include'</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token function">pruneCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name <span class="token operator">=</span><span class="token operator">></span> <span class="token function">matches</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'exclude'</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token function">pruneCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  render <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> slot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span><span class="token keyword">default</span>    <span class="token keyword">const</span> vnode<span class="token punctuation">:</span> VNode <span class="token operator">=</span> <span class="token function">getFirstComponentChild</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span>    <span class="token keyword">const</span> componentOptions<span class="token punctuation">:</span> <span class="token operator">?</span>VNodeComponentOptions <span class="token operator">=</span> vnode <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>componentOptions    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// check pattern</span>      <span class="token keyword">const</span> name<span class="token punctuation">:</span> <span class="token operator">?</span>string <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> include<span class="token punctuation">,</span> exclude <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        <span class="token comment" spellcheck="true">// not included</span>        <span class="token punctuation">(</span>include <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>include<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>        <span class="token comment" spellcheck="true">// excluded</span>        <span class="token punctuation">(</span>exclude <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>exclude<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> vnode      <span class="token punctuation">}</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> cache<span class="token punctuation">,</span> keys <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>      <span class="token keyword">const</span> key<span class="token punctuation">:</span> <span class="token operator">?</span>string <span class="token operator">=</span> vnode<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token keyword">null</span>        <span class="token comment" spellcheck="true">// same constructor may get registered as different local components</span>        <span class="token comment" spellcheck="true">// so cid alone is not enough (#3269)</span>        <span class="token operator">?</span> componentOptions<span class="token punctuation">.</span>Ctor<span class="token punctuation">.</span>cid <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span>tag <span class="token operator">?</span> <span class="token template-string"><span class="token string">`::</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentOptions<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span>        <span class="token punctuation">:</span> vnode<span class="token punctuation">.</span>key      <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance        <span class="token comment" spellcheck="true">// make current key freshest</span>        <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span>        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// prune oldest entry</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> vnode <span class="token operator">||</span> <span class="token punctuation">(</span>slot <span class="token operator">&amp;&amp;</span> slot<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é€šè¿‡ getFirstComponentChild å‡½æ•°è·å–ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œ<keep-alive> åªå¤„ç†ç¬¬ä¸€ä¸ªå­å…ƒç´ ï¼Œæ‰€ä»¥ä¸€èˆ¬å’Œå®ƒæ­é…ä½¿ç”¨çš„æœ‰ component åŠ¨æ€ç»„ä»¶æˆ–è€…æ˜¯ router-viewï¼Œä¹‹ååˆæ ¹æ®ä¼ çš„ include å’Œ excludeï¼Œ ç”¨ matches å»åšåŒ¹é…ï¼Œå¦‚æœå‘½ä¸­ç¼“å­˜åˆ™ç›´æ¥ä»ç¼“å­˜ä¸­æ‹¿ vnode ç»„ä»¶å®ä¾‹ï¼Œé‡æ–°è°ƒæ•´ key çš„é¡ºåºï¼Œæ”¾åœ¨æœ€åä¸€ä¸ªï¼Œå¦åˆ™é‡æ–°æ”¾è¿›ç¼“å­˜ï¼Œå¦‚æœé…ç½®äº† max å¹¶ä¸”ç¼“å­˜çš„é•¿åº¦è¶…è¿‡äº† this.max åˆ™è¦ä»ç¼“å­˜ä¸­åˆ é™¤ç¬¬ä¸€ä¸ª</keep-alive></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> pruneCacheEntry <span class="token punctuation">(</span>  cache<span class="token punctuation">:</span> VNodeCache<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  keys<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">></span><span class="token punctuation">,</span>  current<span class="token operator">?</span><span class="token punctuation">:</span> VNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> cached <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>current <span class="token operator">||</span> cached<span class="token punctuation">.</span>tag <span class="token operator">!==</span> current<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    cached<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>   <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é¦–æ¬¡æ¸²æŸ“"><a href="#é¦–æ¬¡æ¸²æŸ“" class="headerlink" title="é¦–æ¬¡æ¸²æŸ“"></a>é¦–æ¬¡æ¸²æŸ“</h3><p>æˆ‘ä»¬å‰é¢ä»‹ç»è¿‡æ¸²æŸ“æœ€ååœ¨ patch è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œ createComponent æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> createComponent <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> isReactivated <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>keepAlive    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* hydrating */</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// after calling the init hook, if the vnode is a child component</span>    <span class="token comment" spellcheck="true">// it should've created a child instance and mounted it. the child</span>    <span class="token comment" spellcheck="true">// component also has set the placeholder vnode's elm.</span>    <span class="token comment" spellcheck="true">// in that case we can just return the element and be done.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ vnode å·²ç»æ‰§è¡Œå®Œ patch åï¼Œæ‰§è¡Œ initComponent å‡½æ•°ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> initComponent <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pendingInsert<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    insertedVnodeQueue<span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>insertedVnodeQueue<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pendingInsert<span class="token punctuation">)</span>    vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pendingInsert <span class="token operator">=</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>$el  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">invokeCreateHooks</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token function">setScope</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// empty component root.</span>    <span class="token comment" spellcheck="true">// skip all element-related modules except for ref (#3455)</span>    <span class="token function">registerRef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// make sure to invoke the insert hook</span>    insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä¼šæœ‰ vnode.elm ç¼“å­˜äº† vnode åˆ›å»ºç”Ÿæˆçš„ DOM èŠ‚ç‚¹ã€‚æ‰€ä»¥å¯¹äºé¦–æ¬¡æ¸²æŸ“è€Œè¨€ï¼Œé™¤äº†åœ¨ <keep-alive> ä¸­å»ºç«‹ç¼“å­˜ï¼Œå’Œæ™®é€šç»„ä»¶æ¸²æŸ“æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚</keep-alive></p><h3 id="ç¼“å­˜æ¸²æŸ“"><a href="#ç¼“å­˜æ¸²æŸ“" class="headerlink" title="ç¼“å­˜æ¸²æŸ“"></a>ç¼“å­˜æ¸²æŸ“</h3><p>å½“æ•°æ®å‘é€å˜åŒ–ï¼Œåœ¨ patch æ‰§è¡Œ patchVnode çš„é€»è¾‘,å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹ä¹‹å‰ ä¼šæ‰§è¡Œ prepatch å‡½æ•°,å®šä¹‰åœ¨ <code>src/core/vdom/create-component</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>  prepatch <span class="token punctuation">(</span>oldVnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">,</span> vnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> options <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentOptions    <span class="token keyword">const</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>componentInstance    <span class="token function">updateChildComponent</span><span class="token punctuation">(</span>      child<span class="token punctuation">,</span>      options<span class="token punctuation">.</span>propsData<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// updated props</span>      options<span class="token punctuation">.</span>listeners<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// updated listeners</span>      vnode<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new parent vnode</span>      options<span class="token punctuation">.</span>children <span class="token comment" spellcheck="true">// new children</span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ƒä¼šæ‰§è¡Œ updateChildComponent æ–¹æ³•ï¼Œå®šä¹‰åœ¨ <code>src/core/instance/lifecycle.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> updateChildComponent <span class="token punctuation">(</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  propsData<span class="token punctuation">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>  listeners<span class="token punctuation">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>  parentVnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">,</span>  renderChildren<span class="token punctuation">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>VNode<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> hasChildren <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>    renderChildren <span class="token operator">||</span>              vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_renderChildren <span class="token operator">||</span>    parentVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>scopedSlots <span class="token operator">||</span>     vm<span class="token punctuation">.</span>$scopedSlots <span class="token operator">!==</span> emptyObject   <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>$slots <span class="token operator">=</span> <span class="token function">resolveSlots</span><span class="token punctuation">(</span>renderChildren<span class="token punctuation">,</span> parentVnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span>    vm<span class="token punctuation">.</span><span class="token function">$forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çœ‹åˆ°åœ¨æ‰§è¡Œè¿‡ä¸­ä¼š è§¦å‘ <keep-alive> ç»„ä»¶å®ä¾‹ $forceUpdate é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯é‡æ–°æ‰§è¡Œ <keep-alive> çš„ render æ–¹æ³•ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™å‘½ä¸­ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å› vnode.componentInstance ï¼Œå†æ¬¡æ‰§è¡Œ createComponent </keep-alive></keep-alive></p><pre class="line-numbers language-js"><code class="language-js">unction createComponent <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> isReactivated <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>keepAlive    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* hydrating */</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// after calling the init hook, if the vnode is a child component</span>    <span class="token comment" spellcheck="true">// it should've created a child instance and mounted it. the child</span>    <span class="token comment" spellcheck="true">// component also has set the placeholder vnode's elm.</span>    <span class="token comment" spellcheck="true">// in that case we can just return the element and be done.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªæ—¶å€™ isReactivated ä¸º trueï¼Œå°±ä¼šæ‰§è¡Œ reactivateComponent æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js">unction reactivateComponent <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i  <span class="token comment" spellcheck="true">// hack for #4339: a reactivated component with inner transition</span>  <span class="token comment" spellcheck="true">// does not trigger because the inner node's created hooks are not called</span>  <span class="token comment" spellcheck="true">// again. It's not ideal to involve module-specific logic in here but</span>  <span class="token comment" spellcheck="true">// there doesn't seem to be a better way to do it.</span>  <span class="token keyword">let</span> innerNode <span class="token operator">=</span> vnode  <span class="token keyword">while</span> <span class="token punctuation">(</span>innerNode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>    innerNode <span class="token operator">=</span> innerNode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>_vnode    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> innerNode<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>transition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>activate<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        cbs<span class="token punctuation">.</span>activate<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> innerNode<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>innerNode<span class="token punctuation">)</span>      <span class="token keyword">break</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// unlike a newly created component,</span>  <span class="token comment" spellcheck="true">// a reactivated keep-alive component doesn't insert itself</span>  <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªæ—¶å€™ä¼šæ‰§è¡Œ insert(parentElm, vnode.elm, refElm) å°±æŠŠç¼“å­˜çš„ DOM å¯¹è±¡ç›´æ¥æ’å…¥åˆ°ç›®æ ‡å…ƒç´ ä¸­ï¼Œæ‰€ä»¥å°±ä¸ä¼šåœ¨æ‰§è¡Œç»„ä»¶çš„ createdã€mounted ç­‰é’©å­å‡½æ•°äº†ã€‚</p><p><keep-alive> ç»„ä»¶çš„é’©å­å‡½æ•° activated å’Œ deactivated,åˆ™æ˜¯å®šä¹‰åœ¨ insert æ–¹æ³•ä¸­,å®šä¹‰åœ¨ <code>src/core/vdom/create-component.js</code> </keep-alive></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>  insert <span class="token punctuation">(</span>vnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> context<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span> <span class="token operator">=</span> vnode    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>      componentInstance<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token function">callHook</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// vue-router#1212</span>        <span class="token comment" spellcheck="true">// During updates, a kept-alive component's child components may</span>        <span class="token comment" spellcheck="true">// change, so directly walking the tree here may call activated hooks</span>        <span class="token comment" spellcheck="true">// on incorrect children. Instead we push them into a queue which will</span>        <span class="token comment" spellcheck="true">// be processed after the whole patch process ended.</span>        <span class="token function">queueActivatedComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">activateChildComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* direct */</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡åˆ¤æ–­åŒ…è£¹ç»„ä»¶æ˜¯å¦è¢« mounted åˆ†åˆ«æ‰§è¡Œ queueActivatedComponent(componentInstance) å’Œ activateChildComponent(componentInstance, true)</p><p>åœ¨ä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•ä¸­ä¼šæ‰§è¡Œ callHook(vm, â€˜activatedâ€™) é’©å­å‡½æ•°ï¼Œå”¯ä¸€ä¸åŒç‚¹æ˜¯ queueActivatedComponent æ˜¯ç­‰æ‰€æœ‰çš„æ¸²æŸ“å®Œæ¯•ï¼Œåœ¨ nextTickåä¼šæ‰§è¡Œ flushSchedulerQueueï¼Œé€šè¿‡é˜Ÿåˆ—çš„æ–¹å¼å°±æ˜¯æŠŠæ•´ä¸ª activated æ—¶æœºå»¶åçš„ï¼Œè€Œç»„ä»¶çš„ deactivated é’©å­ï¼Œä¹Ÿæ˜¯åŒç†è¿›è¡Œé€’å½’é”€æ¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†ä¹‹ç”Ÿå‘½å‘¨æœŸ</title>
      <link href="/2019/09/21/vue/vuelifecycle/"/>
      <url>/2019/09/21/vue/vuelifecycle/</url>
      
        <content type="html"><![CDATA[<p>æ¯ä¸€ä¸ª vue çš„å®ä¾‹åœ¨åˆ›å»ºçš„æ—¶å€™éƒ½ç»è¿‡ä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œï¼Œåœ¨æ¯ä¸€ä¸ªé˜¶æ®µéƒ½ä¼šæœ‰ç›¸å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œæ¥åœ¨ç‰¹å®šçš„åœºæ™¯å®ç°ä¸€äº›åŠŸèƒ½</p><h3 id="ç”Ÿå‘½å‘¨æœŸæ–¹æ³•"><a href="#ç”Ÿå‘½å‘¨æœŸæ–¹æ³•" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸæ–¹æ³•"></a>ç”Ÿå‘½å‘¨æœŸæ–¹æ³•<hr></h3><ul><li>beforeCreateï¼ˆå®ä¾‹åˆ›å»ºå‰ï¼‰</li><li>createdï¼ˆå®ä¾‹åˆ›å»ºåï¼‰</li><li>beforeMountï¼ˆæ¸²æŸ“ DOM å‰ï¼‰</li><li>mountedï¼ˆæ¸²æŸ“ DOM åï¼‰</li><li>beforeUpdateï¼ˆæ›´æ–°æ•°æ®å‰ï¼‰</li><li>updatedï¼ˆæ›´æ–°æ•°æ®åï¼‰</li><li>beforeDestroyï¼ˆé”€æ¯ç»„ä»¶å‰ï¼‰</li><li>destroyedï¼ˆé”€æ¯ç»„ä»¶åï¼‰</li></ul><h3 id="æ‰§è¡Œæµç¨‹"><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹ "></a>æ‰§è¡Œæµç¨‹ <hr></h3><p>é€šè¿‡ä¸Šé¢ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ¥è‡³å®˜ç½‘çš„ä¸€å¼ ç¥å›¾ï¼Œå‘Šè¯‰æˆ‘ä»¬å¤§è‡´çš„å·¥ä½œæµç¨‹ã€‚é€šè¿‡æ¯ä¸ªé˜¶æ®µçš„æºç æ¥åˆ†æï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­é‡åˆ°çš„é—®é¢˜ã€‚æ¯”å¦‚åˆ°åº•é‚£ä¸ªé˜¶æ®µåšè¯·æ±‚å¥½ï¼Œçˆ¶å­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸåœ¨ä¸åŒæƒ…å†µçš„ä¸‹æ‰§è¡Œé¡ºåºæ˜¯æ€æ ·çš„ã€‚</p><img src="/images/lifecycle.png" width="50%"><h3 id="callHook"><a href="#callHook" class="headerlink" title="callHook"></a>callHook<hr></h3><p>æˆ‘ä»¬åœ¨ä»‹ç» vue ä¸»æµç¨‹çš„æ—¶å€™çŸ¥é“é¦–å…ˆä¼šæ‰§è¡Œå®ä¾‹çš„ _init(options)ï¼Œç„¶åä¼šæ‰§è¡Œä¸€ä¸ª merge options çš„é€»è¾‘ï¼Œé€šè¿‡è°ƒç”¨ mergeOptions å¤„ç†ä¸åŒçš„åˆå¹¶ç­–ç•¥ï¼Œå…¶ä¸­ mergeHook å°±æ˜¯å…³äºç”Ÿå‘½å‘¨æœŸçš„</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> mergeHook <span class="token punctuation">(</span>  parentVal<span class="token punctuation">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token punctuation">,</span>  childVal<span class="token punctuation">:</span> <span class="token operator">?</span>Function <span class="token operator">|</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> childVal    <span class="token operator">?</span> parentVal      <span class="token operator">?</span> parentVal<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>      <span class="token punctuation">:</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>        <span class="token operator">?</span> childVal        <span class="token punctuation">:</span> <span class="token punctuation">[</span>childVal<span class="token punctuation">]</span>    <span class="token punctuation">:</span> parentVal<span class="token punctuation">}</span>LIFECYCLE_HOOKS<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>hook <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  strats<span class="token punctuation">[</span>hook<span class="token punctuation">]</span> <span class="token operator">=</span> mergeHook<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™å…¶ä¸­çš„ LIFECYCLE_HOOKS çš„å®šä¹‰åœ¨ <code>src/shared/constants.js</code> ä¸­ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> LIFECYCLE_HOOKS <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token string">'beforeCreate'</span><span class="token punctuation">,</span>  <span class="token string">'created'</span><span class="token punctuation">,</span>  <span class="token string">'beforeMount'</span><span class="token punctuation">,</span>  <span class="token string">'mounted'</span><span class="token punctuation">,</span>  <span class="token string">'beforeUpdate'</span><span class="token punctuation">,</span>  <span class="token string">'updated'</span><span class="token punctuation">,</span>  <span class="token string">'beforeDestroy'</span><span class="token punctuation">,</span>  <span class="token string">'destroyed'</span><span class="token punctuation">,</span>  <span class="token string">'activated'</span><span class="token punctuation">,</span>  <span class="token string">'deactivated'</span><span class="token punctuation">,</span>  <span class="token string">'errorCaptured'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†ç”Ÿå‘½å‘¨æœŸçš„é’©å­å‡½æ•°ï¼Œ ç„¶åå†é€šè¿‡ callHook å°±èƒ½è°ƒç”¨æŸä¸ªç”Ÿå‘½å‘¨æœŸé’©å­æ³¨å†Œçš„æ‰€æœ‰å›è°ƒå‡½æ•°äº†ï¼ŒcallHook å®šä¹‰åœ¨ <code>src/core/instance/lifecycle.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> callHook <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> hook<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> handlers <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">[</span>hook<span class="token punctuation">]</span>   <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hook<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> hook`</span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> handlers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">invokeWithErrorHandling</span><span class="token punctuation">(</span>handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_hasHookEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'hook:'</span> <span class="token operator">+</span> hook<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢ callHook ä¸»è¦æ‰§è¡Œäº† invokeWithErrorHandling å®šä¹‰åœ¨ <code>src/core/util/error.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> invokeWithErrorHandling <span class="token punctuation">(</span>  handler<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>  context<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  args<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  vm<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  info<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> res  <span class="token keyword">try</span> <span class="token punctuation">{</span>    res <span class="token operator">=</span> args <span class="token operator">?</span> handler<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">:</span> handler<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">.</span>_isVue <span class="token operator">&amp;&amp;</span> <span class="token function">isPromise</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">.</span>_handled<span class="token punctuation">)</span> <span class="token punctuation">{</span>      res<span class="token punctuation">.</span>_handled <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> res<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡è°ƒç”¨ handler.apply(context, args) : handler.call(context)ï¼Œæ”¹å˜äº†å½“å‰çš„ thisï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨å†™ç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™ä¸èƒ½ç”¨ç®­å¤´å‡½æ•°çš„åŸå› ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­æ¢è®¨ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œæ—¶æœºã€‚</p><h3 id="beforeCreate-amp-created"><a href="#beforeCreate-amp-created" class="headerlink" title="beforeCreate &amp; created"></a>beforeCreate &amp; created<hr></h3><p>è¿™ä¸¤ä¸ªé’©å­å‡½æ•°ä¸»è¦æ˜¯åœ¨ vue åˆå§‹åŒ–å®ä¾‹é˜¶æ®µï¼Œå®šä¹‰åœ¨ <code>src/core/instance/init.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_init <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>  <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// resolve injections before data/props</span>  <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// resolve provide after data/props</span>  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ° beforeCreate æ˜¯åœ¨åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸã€äº‹ä»¶ï¼Œæ¸²æŸ“å‡½æ•°ä¹‹åè°ƒç”¨ï¼Œé‚£ä¹ˆ created æ˜¯åœ¨åˆå§‹åŒ– initInjectionsã€initState ç­‰å‡½æ•°ä¹‹åï¼Œé‚£ä¹ˆè¿™é‡Œçš„ initState åœ¨å‰é¢çš„æ–‡ç« è¯´è¿‡ï¼Œä¸»è¦æ˜¯åˆå§‹åŒ– propsã€dataã€methodsã€watchã€computed ç­‰å±æ€§ï¼Œæ‰€ä»¥ beforeCreate ä¸­æ˜¯ä¸èƒ½å¤Ÿæ“ä½œ dataã€props ç­‰æ•°æ®ã€ä¹Ÿä¸èƒ½è°ƒç”¨ methods ä¸­å®šä¹‰çš„å‡½æ•°ã€‚ </p><h3 id="beforeMount-amp-mounted"><a href="#beforeMount-amp-mounted" class="headerlink" title="beforeMount &amp; mounted "></a>beforeMount &amp; mounted <hr></h3><p>åœ¨ mounted é˜¶æ®µä¸»è¦æ˜¯æ‰§è¡Œäº† mountComponent æ–¹æ³•ï¼Œæ ¸å¿ƒå°±æ˜¯å…ˆå®ä¾‹åŒ–ä¸€ä¸ªæ¸²æŸ“ Watcherï¼Œåœ¨å‰é¢ä¸»æµç¨‹ä¸­å’Œå“åº”å¼æ•°æ®ä¸­æˆ‘ä»¬ç»å¸¸æåˆ°ä¸¤ä¸ªæ ¸å‹æ–¹æ³• vm._render() å’Œ vm._update()ï¼Œç”¨äºç”Ÿæˆ DOMï¼ŒmountComponent æ–¹æ³•å®šä¹‰åœ¨ <code>src/core/instance/lifecycle</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> mountComponent <span class="token punctuation">(</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  el<span class="token punctuation">:</span> <span class="token operator">?</span>Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render <span class="token operator">=</span> createEmptyVNode    <span class="token operator">...</span>  <span class="token punctuation">}</span>  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeMount'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// beforeMount é’©å­</span>  <span class="token keyword">let</span> updateComponent  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>    updateComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//...</span>      <span class="token comment" spellcheck="true">// æ¸²æŸ“ VNode</span>      <span class="token keyword">const</span> vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// ...</span>      <span class="token comment" spellcheck="true">// æ¸²æŸ“çœŸå® DOM</span>      vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    updateComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>    before <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦ mouted å®Œæˆé˜¶æ®µå¹¶ä¸”æ²¡æœ‰è¢«é”€æ¯</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ•°æ®æ›´æ–°ä¹‹å‰</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* isRenderWatcher */</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// mounted é’©å­</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> vm<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º beforeMount é’©å­å‡½æ•°æ˜¯åœ¨æ‰§è¡Œ vm._render() å‡½æ•°æ¸²æŸ“ VNode ä¹‹å‰æ‰§è¡Œçš„ ï¼Œåœ¨æ‰§è¡Œå®Œ vm._update() æŠŠ VNode patch åˆ°çœŸå® DOM åï¼Œæ‰§è¡Œ mouted é’©å­ã€‚ä¸Šé¢æœ‰ä¸ªé€»è¾‘ <code>vm.$vnode == null</code> è¿™è¡¨æ˜ä¸æ˜¯ä¸€æ¬¡ç»„ä»¶çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡ new Vue() åˆ›å»ºçš„ã€‚å½“ç»„ä»¶çš„ VNode patch åˆ° DOM åï¼Œä¼šæ‰§è¡Œ invokeInsertHook å‡½æ•°ï¼ŒæŠŠ insertedVnodeQueue é‡Œä¿å­˜çš„é’©å­å‡½æ•°ä¾æ¬¡æ‰§è¡Œä¸€éï¼Œå®ƒçš„å®šä¹‰åœ¨ <code>src/core/vdom/patch.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> invokeInsertHook <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> initial<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// åœ¨çœŸæ­£æ’å…¥å…ƒç´ åè°ƒç”¨ï¼Œå»¶è¿Ÿç»„ä»¶æ ¹èŠ‚ç‚¹çš„æ’å…¥é’©å­ï¼Œ</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    vnode<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pendingInsert <span class="token operator">=</span> queue  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>      queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¥å‡½æ•°ä¼šæ‰§è¡Œ insert è¿™ä¸ªé’©å­å‡½æ•°ï¼Œå¯¹äºç»„ä»¶è€Œè¨€ï¼Œinsert é’©å­å‡½æ•°çš„å®šä¹‰åœ¨ <code>src/core/vdom/create-component.js</code> ä¸­çš„ componentVNodeHooks ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  insert <span class="token punctuation">(</span>vnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> context<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span> <span class="token operator">=</span> vnode    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>      componentInstance<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token function">callHook</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¯ä¸ªå­ç»„ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªé’©å­å‡½æ•°ä¸­æ‰§è¡Œ mounted é’©å­å‡½æ•°ï¼ŒinsertedVnodeQueue çš„æ·»åŠ é¡ºåºæ˜¯å…ˆå­åçˆ¶ï¼Œæ‰€ä»¥å¯¹äºåŒæ­¥æ¸²æŸ“çš„å­ç»„ä»¶è€Œè¨€ï¼Œmounted é’©å­å‡½æ•°çš„æ‰§è¡Œé¡ºåºä¹Ÿæ˜¯å…ˆå­åçˆ¶ã€‚</p><h3 id="beforeUpdate-amp-updated"><a href="#beforeUpdate-amp-updated" class="headerlink" title="beforeUpdate &amp; updated "></a>beforeUpdate &amp; updated <hr></h3><p>updated é˜¶æ®µä¹Ÿå°±æ˜¯æ•°æ®çš„ä¾èµ–æ”¶é›†æ›´æ–°é˜¶æ®µï¼Œåœ¨å“åº”å¼æ•°æ®ä¸­æˆ‘ä»¬å·²ç»æåˆ°ï¼Œåœ¨æ–‡ä»¶ <code>src/core/instance/lifecycle</code> ä¸­å®šä¹‰</p><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>    before <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦ mouted å®Œæˆé˜¶æ®µå¹¶ä¸”æ²¡æœ‰è¢«é”€æ¯</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// è°ƒç”¨ beforeUpdate é’©å­</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* isRenderWatcher */</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢å¯ä»¥çœ‹åˆ° beforeUpdate æ˜¯åœ¨æ»¡è¶³ vm._isMounted &amp;&amp; !vm._isDestroyed æ¡ä»¶æ‰ä¼šè¢«è°ƒç”¨çš„,é‚£ä¹ˆ updated è°ƒç”¨æ—¶æœºæ˜¯åœ¨å“ªé‡Œå‘¢ï¼Œå®ƒè¢«å®šä¹‰åœ¨ <code>src/core/observer/scheduler.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> callUpdatedHooks <span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> queue<span class="token punctuation">.</span>length  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> watcher <span class="token operator">=</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    <span class="token keyword">const</span> vm <span class="token operator">=</span> watcher<span class="token punctuation">.</span>vm    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher <span class="token operator">===</span> watcher <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'updated'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡Œ updated ä¹‹å‰ï¼Œå¯¹ watcher é˜Ÿåˆ—è¿›è¡Œäº†éå†ï¼Œåªæœ‰æ¡ä»¶æ»¡è¶³å½“å‰ watcher ä¸º vm._watcher å’Œ mounted é˜¶æ®µï¼Œæ‰ä¼šæ‰§è¡Œ updated é’©å­å‡½æ•°ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ watcher åˆ°åº•åšäº†ä»€ä¹ˆï¼Œå…¶å®åœ¨å“åº”å¼æ•°æ®ä¸­æˆ‘ä»¬å·²ç»åˆ†æè¿‡ï¼Œè¢«å®šä¹‰åœ¨ <code>src/instance/observer/watcher.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  constructor <span class="token punctuation">(</span>    vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>    expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>    cb<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>    options<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>    isRenderWatcher<span class="token operator">?</span><span class="token punctuation">:</span> boolean  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token punctuation">}</span>    vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token operator">...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ watcher å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­ä¼šä¼šåˆ¤æ–­ isRenderWatcherã€‚ æ¥ç€æŠŠå½“å‰ watcher çš„å®ä¾‹èµ‹å€¼ç»™ vm._watcher,åŒæ—¶å°† watcher çš„å®ä¾‹ push åˆ° vm._watchers ä¸­ã€‚é€šè¿‡ vm._watcher å¯¹ vm ä¸Šæ•°æ®å˜åŒ–çš„ç›‘æµ‹ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–å°±ä¼šé‡æ–°æ¸²æŸ“ã€‚æ‰€ä»¥åœ¨ callUpdatedHooks å‡½æ•°ä¸­ï¼Œåªæœ‰ vm._watcher çš„å›è°ƒæ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šæ‰§ updated é’©å­å‡½æ•°ã€‚æ‰€ä»¥æ˜¯é€šè¿‡ watcher ç›‘å¬å®ä¾‹ä¸Šçš„æ•°æ®å˜åŒ–æ¥æ§åˆ¶æ•´ä¸ª vue çš„æ¸²æŸ“æµç¨‹ã€‚</p><h3 id="beforeDestroy-amp-destroyed"><a href="#beforeDestroy-amp-destroyed" class="headerlink" title="beforeDestroy &amp; destroyed"></a>beforeDestroy &amp; destroyed<hr></h3><p>è¿™ä¸ªé˜¶æ®µä¹Ÿæ˜¯æœ€åä¸€ä¸ªé˜¶æ®µè¿›è¡Œç»„ä»¶çš„é”€æ¯ï¼Œå®ƒè¢«å®šä¹‰åœ¨ <code>src/core/instance/lifecycle.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$destroy <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isBeingDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeDestroy'</span><span class="token punctuation">)</span>    vm<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token comment" spellcheck="true">// ä» parent çš„ $children ä¸­åˆ æ‰è‡ªèº«</span>    <span class="token keyword">const</span> parent <span class="token operator">=</span> vm<span class="token punctuation">.</span>$parent    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parent<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>abstract<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">remove</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>$children<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// åˆ é™¤ watcher</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span>length    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token operator">...</span>    vm<span class="token punctuation">.</span>_isDestroyed <span class="token operator">=</span> <span class="token boolean">true</span>    vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_vnode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'destroyed'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// è°ƒç”¨ destroyed é’©å­</span>    <span class="token comment" spellcheck="true">// å…³é—­å®ä¾‹ä¾¦å¬å™¨ã€‚</span>    vm<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// åˆ é™¤ __vue__ å¼•ç”¨</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// é‡Šæ”¾å¾ªç¯å¼•ç”¨</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ $destroy çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå®ƒåˆä¼šæ‰§è¡Œ <code>vm.__patch__(vm._vnode, null)</code> è§¦å‘å®ƒå­ç»„ä»¶çš„é”€æ¯é’©å­å‡½æ•°ï¼Œè¿™æ ·ä¸€å±‚å±‚çš„é€’å½’è°ƒç”¨ï¼Œæ‰€ä»¥ destroy é’©å­å‡½æ•°æ‰§è¡Œé¡ºåºæ˜¯å…ˆå­åçˆ¶ï¼Œå’Œ mounted è¿‡ç¨‹ä¸€æ ·ã€‚</p><p>é€šè¿‡ä¸Šé¢å…«ç§é’©å­ï¼Œæˆ‘ä»¬äº†è§£äº†ç»„ä»¶é”€æ¯é˜¶æ®µçš„æ‹†å¸è¿‡ç¨‹ï¼Œé‚£ä¹ˆåœ¨å®˜ç½‘ä¸­é™¤äº†è¿™å…«ç§é’©å­å‡½æ•°å…¶å®è¿˜æœ‰é›†ä¸­ä¸å¸¸è§çš„é’©å­</p><h3 id="activated-amp-deactivated"><a href="#activated-amp-deactivated" class="headerlink" title="activated &amp; deactivated"></a>activated &amp; deactivated<hr></h3><p>è¿™ä¸¤ä¸ªé’©å­å‡½æ•°æ˜¯ keep-alive ç»„ä»¶ç‹¬æœ‰çš„ã€‚ç”¨ keep-alive åŒ…è£¹çš„ç»„ä»¶åœ¨åˆ‡æ¢æ—¶ä¸ä¼šè¿›è¡Œé”€æ¯ï¼Œè€Œæ˜¯ç¼“å­˜åˆ°å†…å­˜ä¸­å¹¶æ‰§è¡Œ deactivated é’©å­å‡½æ•°ï¼Œå‘½ä¸­ç¼“å­˜æ¸²æŸ“åä¼šæ‰§è¡Œ activated é’©å­å‡½æ•°ã€‚</p><h3 id="errorCaptured"><a href="#errorCaptured" class="headerlink" title="errorCaptured"></a>errorCaptured<hr></h3><p>é€šè¿‡ errorCaptured é’©å­å¯ä»¥æ•è·æ¥è‡ªå­å­™ç»„ä»¶çš„é”™è¯¯ï¼Œé€šè¿‡è®¾ç½®é’©å­çš„è¿”å›çŠ¶æ€ä¸º falseï¼Œé˜²æ­¢å½“ä¸€ä¸ªé”™è¯¯è¢«æ•è·æ—¶è¯¥ç»„ä»¶è¿›å…¥æ— é™çš„æ¸²æŸ“å¾ªç¯ï¼Œå¯¼è‡´ç¨‹åºå¤±è´¥ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“<hr></h3><p>é€šè¿‡å¯¹ä¸Šé¢çš„ç†è§£æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ vue ç”Ÿå‘½å‘¨æœŸåœ¨ä¸åŒåœºæ™¯çš„æ‰§è¡Œé¡ºåº</p><img src="/images/vue-lifecycle.png">]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†ä¹‹ç»„ä»¶åŒ–</title>
      <link href="/2019/09/21/vue/vuecomponents/"/>
      <url>/2019/09/21/vue/vuecomponents/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://www.studyfe.cn/2019/09/21/vue/vuelifecycle/">ç”Ÿå‘½å‘¨æœŸ</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/08/vue/vuecomponentregister/">ç»„ä»¶æ³¨å†Œ</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/10/vue/vueasync-component/">å¼‚æ­¥ç»„ä»¶</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/12/vue/vuevmodel/">v-model</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/22/vue/vuekeepalive/">keep-alive</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/07/vue/vuecomputedwatcher/">computed å’Œ watch</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†ä¹‹ç¼–è¯‘</title>
      <link href="/2019/09/19/vue/vuecompile/"/>
      <url>/2019/09/19/vue/vuecompile/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¼–è¯‘å…¥å£"><a href="#ç¼–è¯‘å…¥å£" class="headerlink" title="ç¼–è¯‘å…¥å£"></a>ç¼–è¯‘å…¥å£</h2><p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä»‹ç»æ•´ç†çš„æ‰§è¡Œè¿‡ç¨‹çš„æ—¶å€™é€šè¿‡ï¼Œåœ¨ $mount è¿™ä¸ªå‡½æ•°å†…è°ƒç”¨ compileToFunctions å—ï¼Ÿä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>    shouldDecodeNewlines<span class="token punctuation">,</span>    shouldDecodeNewlinesForHref<span class="token punctuation">,</span>    delimiters<span class="token punctuation">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>    comments<span class="token punctuation">:</span> options<span class="token punctuation">.</span>comments  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>  options<span class="token punctuation">.</span>render <span class="token operator">=</span> render  options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns<span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>compileToFunctions æ¥è‡³äº <code>src/compiler/index.js</code> ä¸­  createCompiler(baseOptions) </p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// createCompilerCreator å…è®¸åˆ›å»ºä½¿ç”¨alternativeçš„ç¼–è¯‘å™¨</span><span class="token comment" spellcheck="true">// parser/optimizer/codegen, e.g the SSR optimizing compiler.</span><span class="token comment" spellcheck="true">// è¿™é‡Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨é»˜è®¤éƒ¨åˆ†å¯¼å‡ºä¸€ä¸ªé»˜è®¤ç¼–è¯‘å™¨</span><span class="token keyword">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> baseCompile <span class="token punctuation">(</span>  template<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  options<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> CompiledResult <span class="token punctuation">{</span>  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    ast<span class="token punctuation">,</span>    render<span class="token punctuation">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>    staticRenderFns<span class="token punctuation">:</span> code<span class="token punctuation">.</span>staticRenderFns  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="createCompilerCreator"><a href="#createCompilerCreator" class="headerlink" title="createCompilerCreator "></a>createCompilerCreator <hr></h3><p>createCompilerCreator æ¥è‡³äº <code>src/compiler/create-compiler.js</code>ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> createCompilerCreator <span class="token punctuation">(</span>baseCompile<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> createCompiler <span class="token punctuation">(</span>baseOptions<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> compile <span class="token punctuation">(</span>      template<span class="token punctuation">:</span> string<span class="token punctuation">,</span>      options<span class="token operator">?</span><span class="token punctuation">:</span> CompilerOptions    <span class="token punctuation">)</span><span class="token punctuation">:</span> CompiledResult <span class="token punctuation">{</span>      <span class="token keyword">const</span> finalOptions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span>      <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token keyword">const</span> tips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      finalOptions<span class="token punctuation">.</span>warn <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> tip<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token punctuation">(</span>tip <span class="token operator">?</span> tips <span class="token punctuation">:</span> errors<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆå¹¶è‡ªå®šä¹‰æ¨¡å—</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>          finalOptions<span class="token punctuation">.</span>modules <span class="token operator">=</span>            <span class="token punctuation">(</span>baseOptions<span class="token punctuation">.</span>modules <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆå¹¶è‡ªå®šä¹‰æŒ‡ä»¤</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>directives<span class="token punctuation">)</span> <span class="token punctuation">{</span>          finalOptions<span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>            Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">.</span>directives <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            options<span class="token punctuation">.</span>directives          <span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¤åˆ¶å…¶ä»–å‚æ•°</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">'modules'</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">!==</span> <span class="token string">'directives'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            finalOptions<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">[</span>key<span class="token punctuation">]</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> finalOptions<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        errors<span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>errors<span class="token punctuation">,</span> <span class="token function">detectErrors</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>ast<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      compiled<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors      compiled<span class="token punctuation">.</span>tips <span class="token operator">=</span> tips      <span class="token keyword">return</span> compiled    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      compile<span class="token punctuation">,</span>      compileToFunctions<span class="token punctuation">:</span> <span class="token function">createCompileToFunctionFn</span><span class="token punctuation">(</span>compile<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¥æ–¹æ³•è¿”å›äº†ä¸€ä¸ª createCompiler çš„å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª baseOptions çš„å‚æ•°ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…æ‹¬ compile æ–¹æ³•å±æ€§å’Œ compileToFunctions å±æ€§ï¼Œè¿™ä¸ª compileToFunctions å¯¹åº”çš„å°±æ˜¯ $mount å‡½æ•°è°ƒç”¨çš„ compileToFunctions æ–¹æ³•ï¼Œå®ƒæ˜¯è°ƒç”¨ createCompileToFunctionFn æ–¹æ³•çš„è¿”å›å€¼ã€‚</p><h3 id="createCompileToFunctionFn"><a href="#createCompileToFunctionFn" class="headerlink" title="createCompileToFunctionFn "></a>createCompileToFunctionFn <hr></h3><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ createCompileToFunctionFn æ–¹æ³•ï¼Œå®ƒçš„å®šä¹‰åœ¨ <code>src/compiler/to-function/js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> createCompileToFunctionFn <span class="token punctuation">(</span>compile<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">const</span> cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> compileToFunctions <span class="token punctuation">(</span>    template<span class="token punctuation">:</span> string<span class="token punctuation">,</span>    options<span class="token operator">?</span><span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">,</span>    vm<span class="token operator">?</span><span class="token punctuation">:</span> Component  <span class="token punctuation">)</span><span class="token punctuation">:</span> CompiledFunctionResult <span class="token punctuation">{</span>    options <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token keyword">const</span> warn <span class="token operator">=</span> options<span class="token punctuation">.</span>warn <span class="token operator">||</span> baseWarn    <span class="token keyword">delete</span> options<span class="token punctuation">.</span>warn    <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// detect possible CSP restriction</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'return 1'</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/unsafe-eval|CSP/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">warn</span><span class="token punctuation">(</span>            <span class="token string">'It seems you are using the standalone build of Vue.js in an '</span> <span class="token operator">+</span>            <span class="token string">'environment with Content Security Policy that prohibits unsafe-eval. '</span> <span class="token operator">+</span>            <span class="token string">'The template compiler cannot work in this environment. Consider '</span> <span class="token operator">+</span>            <span class="token string">'relaxing the policy to allow unsafe-eval or pre-compiling your '</span> <span class="token operator">+</span>            <span class="token string">'templates into render functions.'</span>          <span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// check cache</span>    <span class="token keyword">const</span> key <span class="token operator">=</span> options<span class="token punctuation">.</span>delimiters      <span class="token operator">?</span> <span class="token function">String</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">)</span> <span class="token operator">+</span> template      <span class="token punctuation">:</span> template    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ç¼–è¯‘</span>    <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ£€æŸ¥ç¼–è¯‘é”™è¯¯/æç¤º</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>errors <span class="token operator">&amp;&amp;</span> compiled<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`Error compiling template:\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n`</span></span> <span class="token operator">+</span>          compiled<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>tips <span class="token operator">&amp;&amp;</span> compiled<span class="token punctuation">.</span>tips<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        compiled<span class="token punctuation">.</span>tips<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>msg <span class="token operator">=</span><span class="token operator">></span> <span class="token function">tip</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å°†ä»£ç è½¬æ¢ä¸ºå‡½æ•°</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">const</span> fnGenErrors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    res<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>render<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span>    res<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> compiled<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>code <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ£€æŸ¥å‡½æ•°ç”Ÿæˆé”™è¯¯.</span>    <span class="token comment" spellcheck="true">// åªæœ‰å½“ç¼–è¯‘å™¨æœ¬èº«å­˜åœ¨é”™è¯¯æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ</span>    <span class="token comment" spellcheck="true">// ä¸»è¦ç”¨äºcodegen å¼€å‘ä½¿ç”¨</span>    <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>compiled<span class="token punctuation">.</span>errors <span class="token operator">||</span> <span class="token operator">!</span>compiled<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fnGenErrors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`Failed to generate render function:\n\n`</span></span> <span class="token operator">+</span>          fnGenErrors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> err<span class="token punctuation">,</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> in\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile<hr></h3><p>é€šè¿‡ä¸Šé¢å‡½æ•°æˆ‘ä»¬çœ‹åˆ° compileToFunctions æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œç¼–è¯‘æ¨¡æ¿ templateï¼Œç¼–è¯‘é…ç½® options å’Œ Vue å®ä¾‹ vmã€‚æ ¸å¿ƒä»£ç åªæœ‰ä¸€è¡Œ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="baseCompile"><a href="#baseCompile" class="headerlink" title="baseCompile"></a>baseCompile<hr></h3><p>compile å‡½æ•°æ‰§è¡Œçš„é€»è¾‘æ˜¯å…ˆå¤„ç†é…ç½®å‚æ•°ï¼ŒçœŸæ­£æ‰§è¡Œç¼–è¯‘è¿‡ç¨‹å°±ä¸€è¡Œä»£ç ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> finalOptions<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>baseCompile æ˜¯åœ¨æ‰§è¡Œ createCompilerCreator æ–¹æ³•æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥çš„æ‰€ä»¥ç»•äº†ä¸€åœˆçœŸæ­£çš„å…¥å£å°±æ˜¯</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// `createCompilerCreator`å…è®¸åˆ›å»ºä½¿ç”¨alternativeçš„ç¼–è¯‘å™¨</span><span class="token comment" spellcheck="true">// parser/optimizer/codegen, e.g the SSR optimizing compiler.</span><span class="token comment" spellcheck="true">// è¿™é‡Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨é»˜è®¤éƒ¨åˆ†å¯¼å‡ºä¸€ä¸ªé»˜è®¤ç¼–è¯‘å™¨</span><span class="token keyword">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> baseCompile <span class="token punctuation">(</span>  template<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  options<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> CompiledResult <span class="token punctuation">{</span>  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    ast<span class="token punctuation">,</span>    render<span class="token punctuation">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>    staticRenderFns<span class="token punctuation">:</span> code<span class="token punctuation">.</span>staticRenderFns  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸»è¦æ‰§è¡Œæ­¥éª¤"><a href="#ä¸»è¦æ‰§è¡Œæ­¥éª¤" class="headerlink" title="ä¸»è¦æ‰§è¡Œæ­¥éª¤"></a>ä¸»è¦æ‰§è¡Œæ­¥éª¤<hr></h3><blockquote><p>è§£ææ¨¡æ¿å­—ç¬¦ä¸²ç”Ÿæˆ AST</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>ä¼˜åŒ–è¯­æ³•æ ‘</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>ç”Ÿæˆä»£ç </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="parse"><a href="#parse" class="headerlink" title="parse"></a>parse</h2><p>parse å®šä¹‰åœ¨ <code>src/compiler/parser/index.js</code> ä¸­ï¼Œç”±äºç¼–è¯‘æµç¨‹è¾ƒä¸ºå¤æ‚éš¾æ‡‚æ‰€ä»¥æˆ‘ä»¬åªäº†è§£å¤§æ¦‚çš„æµç¨‹</p><p>parse æ¥æ”¶ä¸¤ä¸ªå‚æ•° template å’Œ options å¯¹äº options ä¸å»ç ”ç©¶å¹³å°ç‰¹æ®Šæ€§ï¼Œtemplate æ¨¡æ¿çš„è§£æä¸»è¦æ˜¯é€šè¿‡ parseHTML å‡½æ•°å¾ªç¯è§£æ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯¹äºä¸åŒæƒ…å†µåˆ†åˆ«è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œåœ¨åŒ¹é…çš„è¿‡ç¨‹ä¸­ä¼šåˆ©ç”¨ advance å‡½æ•°ä¸æ–­å‰è¿›æ•´ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²ï¼Œç›´åˆ°å­—ç¬¦ä¸²æœ«å°¾ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> advance <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>  index <span class="token operator">+</span><span class="token operator">=</span> n  html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¯¹äºæ³¨é‡Šå’Œæ¡ä»¶æ³¨é‡ŠèŠ‚ç‚¹ï¼Œå‰è¿›è‡³å®ƒä»¬çš„æœ«å°¾ä½ç½®ï¼›å¯¹äºæ–‡æ¡£ç±»å‹èŠ‚ç‚¹ï¼Œåˆ™å‰è¿›å®ƒè‡ªèº«é•¿åº¦çš„è·ç¦»</li><li>é€šè¿‡ parseStartTag è§£æå¼€å§‹æ ‡ç­¾(é€šè¿‡ startTagOpené…ç½®å¼€å§‹æ ‡ç­¾ï¼Œç„¶åå®šä¹‰äº† match å¯¹è±¡ï¼Œé€šè¿‡ handleStartTag å¤„ç† match.attrs,æœ€åè°ƒç”¨ options.startå›è°ƒå‡½æ•°)</li><li>é€šè¿‡æ­£åˆ™ endTag åŒ¹é…åˆ°é—­åˆæ ‡ç­¾ï¼Œç„¶åå‰è¿›åˆ°é—­åˆæ ‡ç­¾æœ«å°¾ï¼Œç„¶åæ‰§è¡Œ parseEndTag æ–¹æ³•å¯¹é—­åˆï¼Œæœ€åè°ƒç”¨ options.end å›è°ƒå‡½æ•°</li><li>åˆ¤æ–­ textEnd æ˜¯å¦å¤§äºç­‰äº 0 è¯´æ˜ä»å½“å‰ä½ç½®åˆ° textEnd ä½ç½®éƒ½æ˜¯æ–‡æœ¬ï¼Œå¦‚æœ extEnd å°äº 0 çš„æƒ…å†µï¼Œåˆ™è¯´æ˜æ•´ä¸ª template è§£æå®Œæ¯•äº†ï¼Œå°†å‰©ä½™çš„ html éƒ½èµ‹å€¼ç»™äº† textï¼Œæœ€åè°ƒç”¨äº† options.chars å›è°ƒå‡½æ•°ï¼Œå¹¶ä¼  text å‚æ•°</li></ul><h3 id="options-start-å¤„ç†å¼€å§‹æ ‡ç­¾"><a href="#options-start-å¤„ç†å¼€å§‹æ ‡ç­¾" class="headerlink" title="options.start å¤„ç†å¼€å§‹æ ‡ç­¾"></a>options.start å¤„ç†å¼€å§‹æ ‡ç­¾<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span>start <span class="token punctuation">(</span>tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>  <span class="token function">processElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>  <span class="token function">treeManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>é€šè¿‡ createASTElement åˆ›å»º AST å…ƒç´ </li><li>å¤„ç† AST å…ƒç´ </li><li>AST æ ‘ç®¡ç†</li></ul><blockquote><p>createASTElement</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// æ¯ä¸€ä¸ª AST å…ƒç´ æ˜¯ä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡</span><span class="token comment" spellcheck="true">// type è¡¨ç¤º AST å…ƒç´ ç±»å‹</span><span class="token comment" spellcheck="true">// tag è¡¨ç¤ºæ ‡ç­¾å</span><span class="token comment" spellcheck="true">// attrsList è¡¨ç¤ºå±æ€§åˆ—è¡¨</span><span class="token comment" spellcheck="true">// attrsMap è¡¨ç¤ºå±æ€§æ˜ å°„è¡¨</span><span class="token comment" spellcheck="true">// parent è¡¨ç¤ºçˆ¶çš„ AST å…ƒç´ </span><span class="token comment" spellcheck="true">// children è¡¨ç¤ºå­ AST å…ƒç´ é›†åˆã€‚</span><span class="token keyword">export</span> <span class="token keyword">function</span> createASTElement <span class="token punctuation">(</span>  tag<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  attrs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Attr<span class="token operator">></span><span class="token punctuation">,</span>  parent<span class="token punctuation">:</span> ASTElement <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ASTElement <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    tag<span class="token punctuation">,</span>    attrsList<span class="token punctuation">:</span> attrs<span class="token punctuation">,</span>    attrsMap<span class="token punctuation">:</span> <span class="token function">makeAttrsMap</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">,</span>    parent<span class="token punctuation">,</span>    children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>processElement(element)</p></blockquote><p>è°ƒç”¨ preTransformsã€transformsã€postTransforms å‡½ï¼Œç„¶åé€šè¿‡å„ç§æŒ‡ä»¤ processXXX åšå¤„ç†ï¼Œå¤„ç†çš„ç»“æœå°±æ˜¯æ‰©å±• AST å…ƒç´ çš„å±æ€§ï¼Œå¦‚ processFor è§£æ v-for æŒ‡ä»¤å†…å®¹ï¼Œå°†è§£æçš„å±æ€§å€¼æ·»åŠ åˆ° AST çš„å…ƒç´ ä¸Š</p><blockquote><p>treeManagement()</p></blockquote><p>AST æ ‘ç®¡ç†çš„ç›®æ ‡æ˜¯æ„å»ºä¸€é¢— AST æ ‘ï¼Œæœ¬è´¨ä¸Šåˆ©ç”¨ stack æ ˆçš„æ•°æ®ç»“æ„æ¥ç»´æŠ¤ root æ ¹èŠ‚ç‚¹å’Œå½“å‰çˆ¶èŠ‚ç‚¹ currentParentã€‚</p><h3 id="options-end-å¤„ç†é—­åˆæ ‡ç­¾"><a href="#options-end-å¤„ç†é—­åˆæ ‡ç­¾" class="headerlink" title="options.end å¤„ç†é—­åˆæ ‡ç­¾"></a>options.end å¤„ç†é—­åˆæ ‡ç­¾<hr></h3><pre class="line-numbers language-js"><code class="language-js">end <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">treeManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">closeElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>é¦–å…ˆå¤„ç†äº†å°¾éƒ¨ç©ºæ ¼çš„æƒ…å†µ,ç„¶åæŠŠ stack çš„å…ƒç´ å¼¹ä¸€ä¸ªå‡ºæ ˆï¼Œå¹¶æŠŠ stack æœ€åä¸€ä¸ªå…ƒç´ èµ‹å€¼ç»™ currentParentï¼Œè¿™æ ·å°±ç»´æŠ¤äº†æ•´ä¸ª AST æ ‘ã€‚</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// remove trailing whitespace</span><span class="token keyword">const</span> element <span class="token operator">=</span> stack<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token keyword">const</span> lastNode <span class="token operator">=</span> element<span class="token punctuation">.</span>children<span class="token punctuation">[</span>element<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token keyword">if</span> <span class="token punctuation">(</span>lastNode <span class="token operator">&amp;&amp;</span> lastNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> lastNode<span class="token punctuation">.</span>text <span class="token operator">===</span> <span class="token string">' '</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inPre<span class="token punctuation">)</span> <span class="token punctuation">{</span>  element<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// pop stack</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span><span class="token operator">=</span> <span class="token number">1</span>currentParent <span class="token operator">=</span> stack<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token function">closeElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>closeElement æ›´æ–°ä¸€ä¸‹ inVPre å’Œ inPre çš„çŠ¶æ€ï¼Œä»¥åŠæ‰§è¡Œ postTransforms å‡½æ•° </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> closeElement <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// check pre state</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token punctuation">{</span>    inVPre <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">platformIsPreTag</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    inPre <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// apply post-transforms</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> postTransforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    postTransforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="options-chars-å¤„ç†æ–‡æœ¬å†…å®¹"><a href="#options-chars-å¤„ç†æ–‡æœ¬å†…å®¹" class="headerlink" title="options.chars å¤„ç†æ–‡æœ¬å†…å®¹"></a>options.chars å¤„ç†æ–‡æœ¬å†…å®¹<hr></h3><pre class="line-numbers language-js"><code class="language-js">chars <span class="token punctuation">(</span>text<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">handleText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">createChildrenASTOfText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡æ‰§è¡Œ parseText(text, delimiters) å¯¹æ–‡æœ¬è§£æ, å®šä¹‰åœ¨ <code>src/compiler/parser/text-parsre.js</code> ä¸­ï¼Œä¸»è¦æµç¨‹å°±æ˜¯</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// å…ˆæ ¹æ®åˆ†éš”ç¬¦ï¼ˆé»˜è®¤æ˜¯ `{{}}`ï¼‰æ„é€ äº†æ–‡æœ¬åŒ¹é…çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç„¶åå†å¾ªç¯åŒ¹é…æ–‡æœ¬</span><span class="token comment" spellcheck="true">// é‡åˆ°æ™®é€šæ–‡æœ¬å°± push åˆ° rawTokens å’Œ tokens ä¸­</span><span class="token comment" spellcheck="true">// å¦‚æœæ˜¯è¡¨è¾¾å¼å°±è½¬æ¢æˆ `_s(${exp})` push åˆ° tokens ä¸­</span><span class="token comment" spellcheck="true">// è½¬æ¢æˆ `{@binding:exp}` push åˆ° rawTokens ä¸­</span><span class="token keyword">const</span> defaultTagRE <span class="token operator">=</span> <span class="token regex">/\{\{((?:.|\n)+?)\}\}/g</span><span class="token keyword">const</span> regexEscapeRE <span class="token operator">=</span> <span class="token regex">/[-.*+?^${}()|[\]\/\\]/g</span><span class="token keyword">const</span> buildRegex <span class="token operator">=</span> <span class="token function">cached</span><span class="token punctuation">(</span>delimiters <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> open <span class="token operator">=</span> delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regexEscapeRE<span class="token punctuation">,</span> <span class="token string">'\\$&amp;'</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> close <span class="token operator">=</span> delimiters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regexEscapeRE<span class="token punctuation">,</span> <span class="token string">'\\$&amp;'</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>open <span class="token operator">+</span> <span class="token string">'((?:.|\\n)+?)'</span> <span class="token operator">+</span> close<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">function</span> parseText <span class="token punctuation">(</span>  text<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  delimiters<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">,</span> string<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> TextParseResult <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> tagRE <span class="token operator">=</span> delimiters <span class="token operator">?</span> <span class="token function">buildRegex</span><span class="token punctuation">(</span>delimiters<span class="token punctuation">)</span> <span class="token punctuation">:</span> defaultTagRE  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tagRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> rawTokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> tagRE<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">let</span> match<span class="token punctuation">,</span> index<span class="token punctuation">,</span> tokenValue  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> tagRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    index <span class="token operator">=</span> match<span class="token punctuation">.</span>index    <span class="token comment" spellcheck="true">// push text token</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>      rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tokenValue <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span>      tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// tag token</span>    <span class="token keyword">const</span> exp <span class="token operator">=</span> <span class="token function">parseFilters</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`_s(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">)</span>    rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'@binding'</span><span class="token punctuation">:</span> exp <span class="token punctuation">}</span><span class="token punctuation">)</span>    lastIndex <span class="token operator">=</span> index <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastIndex <span class="token operator">&lt;</span> text<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>    rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tokenValue <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span>    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    expression<span class="token punctuation">:</span> tokens<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    tokens<span class="token punctuation">:</span> rawTokens  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“ "></a>å°ç»“ <hr></h3><ul><li>parse çš„ä½œç”¨å°±æ˜¯å°† template æ¨¡ç‰ˆå­—ç¬¦ä¸²è½¬æ¢æˆ AST æ ‘ã€‚å…¶å®æ˜¯ç”¨å¯¹è±¡çš„å½¢å¼æ¥æè¿°æ•´ä¸ªæ¨¡ç‰ˆï¼Œç”¨æ­£åˆ™é¡ºåºè§£ææ¨¡ç‰ˆï¼Œè¾¾åˆ°æ„å»º AST æ ‘çš„ç›®çš„</li><li>AST å…ƒç´ èŠ‚ç‚¹æ€»å…±æœ‰ 3 ç§ç±»å‹ï¼Œtype ä¸º 1 è¡¨ç¤ºæ˜¯æ™®é€šå…ƒç´ ï¼Œä¸º 2 è¡¨ç¤ºæ˜¯è¡¨è¾¾å¼ï¼Œä¸º 3 è¡¨ç¤ºæ˜¯çº¯æ–‡æœ¬</li></ul><h2 id="optimize"><a href="#optimize" class="headerlink" title="optimize"></a>optimize</h2><p>optimize æ–¹æ³•çš„å®šä¹‰ï¼Œåœ¨ <code>src/compiler/optimizer.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> optimize <span class="token punctuation">(</span>root<span class="token punctuation">:</span> <span class="token operator">?</span>ASTElement<span class="token punctuation">,</span> options<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token keyword">return</span>  isStaticKey <span class="token operator">=</span> <span class="token function">genStaticKeysCached</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>staticKeys <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span>  isPlatformReservedTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isReservedTag <span class="token operator">||</span> no  <span class="token comment" spellcheck="true">// first pass: mark all non-static nodes.</span>  <span class="token function">markStatic</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// second pass: mark static roots.</span>  <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> genStaticKeys <span class="token punctuation">(</span>keys<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">makeMap</span><span class="token punctuation">(</span>    <span class="token string">'type,tag,attrsList,attrsMap,plain,parent,children,attrs'</span> <span class="token operator">+</span>    <span class="token punctuation">(</span>keys <span class="token operator">?</span> <span class="token string">','</span> <span class="token operator">+</span> keys <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ optimize å‡½æ•°æˆ‘ä»¬çœ‹åˆ°ä¼˜åŒ–ä¸»è¦å°±åšäº†ä¸¤ä»¶äº‹æƒ…</p><h3 id="markStatic-root-æ ‡è®°é™æ€èŠ‚ç‚¹"><a href="#markStatic-root-æ ‡è®°é™æ€èŠ‚ç‚¹" class="headerlink" title="markStatic(root) æ ‡è®°é™æ€èŠ‚ç‚¹"></a>markStatic(root) æ ‡è®°é™æ€èŠ‚ç‚¹<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> markStatic <span class="token punctuation">(</span>node<span class="token punctuation">:</span> ASTNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>  node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// do not make component slot content static. this avoids</span>    <span class="token comment" spellcheck="true">// 1. components not able to mutate slot nodes</span>    <span class="token comment" spellcheck="true">// 2. static slot content fails for hot-reloading</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>      <span class="token operator">!</span><span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">'slot'</span> <span class="token operator">&amp;&amp;</span>      node<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'inline-template'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span>    <span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>      <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">=</span> <span class="token boolean">false</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> block <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block        <span class="token function">markStatic</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> isStatic <span class="token punctuation">(</span>node<span class="token punctuation">:</span> ASTNode<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// expression</span>    <span class="token keyword">return</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// text</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>pre <span class="token operator">||</span> <span class="token punctuation">(</span>    <span class="token operator">!</span>node<span class="token punctuation">.</span>hasBindings <span class="token operator">&amp;&amp;</span> <span class="token comment" spellcheck="true">// no dynamic bindings</span>    <span class="token operator">!</span>node<span class="token punctuation">.</span><span class="token keyword">if</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>node<span class="token punctuation">.</span><span class="token keyword">for</span> <span class="token operator">&amp;&amp;</span> <span class="token comment" spellcheck="true">// not v-if or v-for or v-else</span>    <span class="token operator">!</span><span class="token function">isBuiltInTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment" spellcheck="true">// not a built-in</span>    <span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment" spellcheck="true">// not a component</span>    <span class="token operator">!</span><span class="token function">isDirectChildOfTemplateFor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isStaticKey<span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>é€šè¿‡ isStatic å‡½æ•°åˆ¤æ–­ AST æ˜¯å¦æ˜¯é™æ€</li><li>type === 2 ä¸ºè¡¨è¾¾å¼ä¸æ˜¯é™æ€</li><li>type === 3 æ˜¯çº¯æ–‡æœ¬æ˜¯é™æ€</li><li>æ™®é€šå…ƒç´ ï¼Œå¦‚æœæœ‰ pre å±æ€§ æ˜¯é™æ€</li><li>æ²¡æœ‰ä½¿ç”¨ v-ifã€ v-for ã€æ²¡æœ‰ä½¿ç”¨å…¶å®ƒæŒ‡ä»¤ï¼ˆä¸åŒ…æ‹¬ v-onceï¼‰ã€éå†…ç½®ç»„ä»¶ã€æ˜¯å¹³å°ä¿ç•™çš„æ ‡ç­¾ã€èŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§çš„ key éƒ½æ»¡è¶³é™æ€ keyï¼Œè¿™äº›éƒ½æ»¡è¶³åˆ™è¿™ä¸ª AST èŠ‚ç‚¹æ˜¯ä¸€ä¸ªé™æ€èŠ‚ç‚¹</li><li>é€’å½’éå†æ™®é€šå…ƒç´ ï¼Œå¦‚æœä¸€æ—¦å­èŠ‚ç‚¹æœ‰ä¸æ˜¯é™æ€çš„æƒ…å†µï¼Œåˆ™çˆ¶èŠ‚ç‚¹çš„ static å˜ä¸º false</li></ul><h3 id="markStaticRoots-root-false-æ ‡è®°é™æ€æ ¹"><a href="#markStaticRoots-root-false-æ ‡è®°é™æ€æ ¹" class="headerlink" title="markStaticRoots(root, false) æ ‡è®°é™æ€æ ¹"></a>markStaticRoots(root, false) æ ‡è®°é™æ€æ ¹<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> markStaticRoots <span class="token punctuation">(</span>node<span class="token punctuation">:</span> ASTNode<span class="token punctuation">,</span> isInFor<span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>      node<span class="token punctuation">.</span>staticInFor <span class="token operator">=</span> isInFor    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// For a node to qualify as a static root, it should have children that</span>    <span class="token comment" spellcheck="true">// are not just static text. Otherwise the cost of hoisting out will</span>    <span class="token comment" spellcheck="true">// outweigh the benefits and it's better off to just always render it fresh.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>      node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>      node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isInFor <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>node<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">,</span> isInFor<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¯¹äºå·²ç»æ˜¯ static çš„èŠ‚ç‚¹æˆ–è€…æ˜¯ v-once æŒ‡ä»¤çš„èŠ‚ç‚¹ï¼Œnode.staticInFor = isInFor</li><li>æœ¬èº«æ˜¯ä¸€ä¸ªé™æ€èŠ‚ç‚¹å¤–ï¼Œæ»¡è¶³æ‹¥æœ‰ childrenï¼Œå¹¶ä¸” children ä¸èƒ½åªæ˜¯ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼Œæ‰æœ‰èµ„æ ¼æˆä¸º staticRoot çš„èŠ‚ç‚¹</li><li>é€’å½’éå†æ™®é€šå…ƒç´ ï¼Œå¦‚æœä¸€æ—¦å­èŠ‚ç‚¹æœ‰ä¸æ˜¯é™æ€çš„æƒ…å†µï¼Œåˆ™çˆ¶èŠ‚ç‚¹çš„ static å˜ä¸º false</li></ul><h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“<hr></h3><p>optimize çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æ·±åº¦éå†è¿™ä¸ª AST æ ‘ï¼Œæ£€æµ‹å®ƒçš„æ¯ä¸€é¢—å­æ ‘æ˜¯ä¸æ˜¯é™æ€èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯é™æ€èŠ‚ç‚¹åˆ™å®ƒä»¬ç”Ÿæˆ DOM æ°¸è¿œä¸éœ€è¦æ”¹å˜ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ patch çš„è¿‡ç¨‹å°±ä¸ä¼šå¯¹æ¯”ä¸ºé™æ€å±æ€§çš„èŠ‚ç‚¹</p><h2 id="codegen"><a href="#codegen" class="headerlink" title="codegen"></a>codegen</h2><p>æœ€åä¸€æ­¥å°±æ˜¯å°†ä¼˜åŒ–è¿‡åçš„ AST æ ‘è½¬åŒ–æˆæ‰§è¡Œçš„ä»£ç </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>generate å‡½æ•°çš„å®šä¹‰åœ¨ src/compiler/codegen/index.js ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> generate <span class="token punctuation">(</span>  ast<span class="token punctuation">:</span> ASTElement <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>  options<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> CodegenResult <span class="token punctuation">{</span>  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodegenState</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>  <span class="token keyword">const</span> code <span class="token operator">=</span> ast <span class="token operator">?</span> <span class="token function">genElement</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">'_c("div")'</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    render<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`with(this){return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span><span class="token punctuation">,</span>    staticRenderFns<span class="token punctuation">:</span> state<span class="token punctuation">.</span>staticRenderFns  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="CodegenState"><a href="#CodegenState" class="headerlink" title="CodegenState "></a>CodegenState <hr></h3><p>è°ƒç”¨ CodegenState å‡½æ•°ï¼Œè·å–æ‰€æœ‰ modules ä¸­çš„ genData å‡½æ•°</p><h3 id="genElement"><a href="#genElement" class="headerlink" title="genElement "></a>genElement <hr></h3><p>è°ƒç”¨ genElement å‡½æ•°ç”Ÿæˆ code</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> genElement <span class="token punctuation">(</span>el<span class="token punctuation">:</span> ASTElement<span class="token punctuation">,</span> state<span class="token punctuation">:</span> CodegenState<span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>staticRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>staticProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genStatic</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>once <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>onceProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genOnce</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span><span class="token keyword">for</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>forProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genFor</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span><span class="token keyword">if</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>ifProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genIf</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'template'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>slotTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'void 0'</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'slot'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genSlot</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// component or element</span>    <span class="token keyword">let</span> code    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>      code <span class="token operator">=</span> <span class="token function">genComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">,</span> el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> data <span class="token operator">=</span> el<span class="token punctuation">.</span>plain <span class="token operator">?</span> undefined <span class="token punctuation">:</span> <span class="token function">genData</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>      <span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span>inlineTemplate <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>      code <span class="token operator">=</span> <span class="token template-string"><span class="token string">`_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'${        data ? `</span></span><span class="token punctuation">,</span>$<span class="token punctuation">{</span>data<span class="token punctuation">}</span><span class="token template-string"><span class="token string">` : '' // data      }${        children ? `</span></span><span class="token punctuation">,</span>$<span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token template-string"><span class="token string">` : '' // children      })`</span></span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// module transforms</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      code <span class="token operator">=</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> code<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> code  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¹æ® AST çš„å±æ€§æ‰§è¡Œä¸åŒçš„ä»£ç ç”Ÿæˆå‡½æ•°ï¼Œè¿™é‡Œé¢æœ‰ genStaticã€genOnceã€genForã€genIfã€genChildrenã€genSlotã€genDataã€genComponent</p><h3 id="æ‰§è¡Œ-code"><a href="#æ‰§è¡Œ-code" class="headerlink" title="æ‰§è¡Œ code "></a>æ‰§è¡Œ code <hr></h3><p>ç”¨ <code>with(this){return ${code}}</code> å°† code ä¼ å…¥ render ä¸­æ‰§è¡Œ new Function()</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span>res<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>render<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span><span class="token keyword">function</span> createFunction <span class="token punctuation">(</span>code<span class="token punctuation">,</span> errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> err<span class="token punctuation">,</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> noop  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><img src="/images/vue-dom-diff12.png"></p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†ä¹‹ç»„ä»¶æ›´æ–°</title>
      <link href="/2019/09/18/vue/vuecomupdate/"/>
      <url>/2019/09/18/vue/vuecomupdate/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬å¯¹å“åº”å¼åŸç†è¿›è¡Œäº†æ¢³ç†ï¼ŒçŸ¥é“äº†å½“æ•°æ®å‘ç”Ÿå˜åŒ–ä¼šè§¦å‘ watcher çš„å›è°ƒï¼Œè¿›è¡Œç»„ä»¶æ›´æ–°ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹æ›´æ–°çš„æ“ä½œæ˜¯æ€ä¹ˆè¿›è¡Œäº†ã€‚<code>src/core/instance/lifecycle.js</code> ä¸­ <code>vm._update</code> æ–¹æ³•</p><h3 id="vm-update"><a href="#vm-update" class="headerlink" title="vm._update "></a>vm._update <hr></h3><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_update <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">:</span> VNode<span class="token punctuation">,</span> hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">const</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// initial render</span>    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* removeOnly */</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// updates</span>    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="vm-patch"><a href="#vm-patch" class="headerlink" title="vm.patch "></a>vm.<strong>patch</strong> <hr></h3><p><code>vm._update</code> æ–¹æ³•ä¸»è¦é€šè¿‡èŠ‚ç‚¹æ¥åˆ¤æ–­ä¼ å…¥çš„å‚æ•°ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ–¹æ³•éƒ½æ˜¯ <code>vm.__patch__</code>,æ¥ä¸‹æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>src/core/vdom/patch.js</code> ä¸­ patch å‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">return</span> <span class="token keyword">function</span> patch <span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> isInitialPatch <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token keyword">const</span> insertedVnodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// empty mount (likely as component), create new root element</span>    isInitialPatch <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> isRealElement <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRealElement <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// patch existing root node</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>isRealElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">// ...</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// replacing existing element</span>      <span class="token keyword">const</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm      <span class="token keyword">const</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// create new node</span>      <span class="token function">createElm</span><span class="token punctuation">(</span>        vnode<span class="token punctuation">,</span>        insertedVnodeQueue<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// extremely rare edge case: do not insert if old element is in a</span>        <span class="token comment" spellcheck="true">// leaving transition. Only happens when combining transition +</span>        <span class="token comment" spellcheck="true">// keep-alive + HOCs. (#4590)</span>        oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> parentElm<span class="token punctuation">,</span>        nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>      <span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// update parent placeholder node element, recursively</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> ancestor <span class="token operator">=</span> vnode<span class="token punctuation">.</span>parent        <span class="token keyword">const</span> patchable <span class="token operator">=</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>            cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>          <span class="token punctuation">}</span>          ancestor<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm          <span class="token keyword">if</span> <span class="token punctuation">(</span>patchable<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>              cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> ancestor<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// #6513</span>            <span class="token comment" spellcheck="true">// invoke insert hooks that may have been merged by create hooks.</span>            <span class="token comment" spellcheck="true">// e.g. for directives that uses the "inserted" hook.</span>            <span class="token keyword">const</span> insert <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span>insert            <span class="token keyword">if</span> <span class="token punctuation">(</span>insert<span class="token punctuation">.</span>merged<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">// start at index 1 to avoid re-invoking component mounted hook</span>              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insert<span class="token punctuation">.</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                insert<span class="token punctuation">.</span>fns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">registerRef</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>          <span class="token punctuation">}</span>          ancestor <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>parent        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// destroy old node</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> isInitialPatch<span class="token punctuation">)</span>  <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> å¯ä»¥çœ‹åˆ° patch çš„é€»è¾‘è¿›æ¥é€šè¿‡åˆ¤æ–­æ˜¯å¦æœ‰ oldVnode æ¥åŒºåˆ†æ˜¯å¦æ˜¯é¦–æ¬¡æ¸²æŸ“ï¼Œè¿›è¡Œä¸åŒçš„é€»è¾‘ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡  <code>sameVNode(oldVnode, vnode)</code> </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> sameVnode <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    a<span class="token punctuation">.</span>key <span class="token operator">===</span> b<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>      <span class="token punctuation">(</span>        a<span class="token punctuation">.</span>tag <span class="token operator">===</span> b<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span>        a<span class="token punctuation">.</span>isComment <span class="token operator">===</span> b<span class="token punctuation">.</span>isComment <span class="token operator">&amp;&amp;</span>        <span class="token function">isDef</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">isDef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">sameInputType</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>        <span class="token function">isTrue</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>isAsyncPlaceholder<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        a<span class="token punctuation">.</span>asyncFactory <span class="token operator">===</span> b<span class="token punctuation">.</span>asyncFactory <span class="token operator">&amp;&amp;</span>        <span class="token function">isUndef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>asyncFactory<span class="token punctuation">.</span>error<span class="token punctuation">)</span>      <span class="token punctuation">)</span>    <span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¹æ® vnode çš„ key è¿›è¡Œåˆ¤æ–­æ˜¯å¦æ˜¯ç›¸åŒçš„ï¼Œå†ç»§ç»­æ ¹æ® isCommentã€dataã€sameInputType çš„ç±»å‹æ˜¯å¦ç›¸åŒæ¥åˆ¤æ–­åŒæ­¥ç»„ä»¶ï¼Œå¯¹äºå¼‚æ­¥ç»„ä»¶åˆ™é€šè¿‡åˆ¤æ–­ asyncFactory æ˜¯å¦ç›¸åŒï¼Œæ‰€ä»¥æ˜¯æ ¹æ®åˆ¤æ–­å®ƒä»¬æ˜¯å¦æ˜¯ç›¸åŒçš„ vnode æ¥åŒºåˆ†ä¸åŒçš„æ›´æ–°é€»è¾‘</p><h3 id="æ–°æ—§èŠ‚ç‚¹ä¸åŒ"><a href="#æ–°æ—§èŠ‚ç‚¹ä¸åŒ" class="headerlink" title="æ–°æ—§èŠ‚ç‚¹ä¸åŒ"></a>æ–°æ—§èŠ‚ç‚¹ä¸åŒ<hr></h3><p>å¦‚æœæ–°æ—§èŠ‚ç‚¹ä¸åŒ,é‚£ä¹ˆå°±æ˜¯æ›¿æ¢å·²ç»å­˜åœ¨çš„èŠ‚ç‚¹å¤§è‡´æµç¨‹ä¸º</p><ul><li>åˆ›å»ºæ–°èŠ‚ç‚¹</li><li>æ›´æ–°çˆ¶çš„å ä½ç¬¦èŠ‚ç‚¹</li><li>åˆ é™¤æ—§èŠ‚ç‚¹</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token keyword">const</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// create new node</span><span class="token function">createElm</span><span class="token punctuation">(</span>  vnode<span class="token punctuation">,</span>  insertedVnodeQueue<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// extremely rare edge case: do not insert if old element is in a</span>  <span class="token comment" spellcheck="true">// leaving transition. Only happens when combining  transition +</span>  <span class="token comment" spellcheck="true">// keep-alive + HOCs. (#4590)</span>  oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> parentElm<span class="token punctuation">,</span>  nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºæ–°èŠ‚ç‚¹è°ƒç”¨çš„æ˜¯ createElm æ–¹æ³•ï¼Œ ä»¥å½“å‰æ—§èŠ‚ç‚¹ä¸ºå‚è€ƒï¼Œåˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼Œå¹¶æ’å…¥åˆ° DOM ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// update parent placeholder node element, recursively</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> ancestor <span class="token operator">=</span> vnode<span class="token punctuation">.</span>parent  <span class="token keyword">const</span> patchable <span class="token operator">=</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>      cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    ancestor<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchable<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> ancestor<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// #6513</span>      <span class="token comment" spellcheck="true">// invoke insert hooks that may have been merged by create hooks.</span>      <span class="token comment" spellcheck="true">// e.g. for directives that uses the "inserted" hook.</span>      <span class="token keyword">const</span> insert <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span>insert      <span class="token keyword">if</span> <span class="token punctuation">(</span>insert<span class="token punctuation">.</span>merged<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// start at index 1 to avoid re-invoking component mounted hook</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insert<span class="token punctuation">.</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          insert<span class="token punctuation">.</span>fns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">registerRef</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    ancestor <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>parent  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰¾åˆ°å½“å‰çš„ vnode çš„ çˆ¶çš„å ä½ç¬¦èŠ‚ç‚¹ï¼Œå…ˆæ‰§è¡Œ cbs.destroy é’©å­å‡½æ•°ï¼Œå¦‚æœå½“å‰å ä½ç¬¦æ˜¯ä¸€ä¸ªå¯æŒ‚è½½çš„èŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡Œ cbs.create é’©å­å‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// destroy old node</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°† oldVnode ä»å½“å‰ DOM æ ‘ä¸­åˆ é™¤ï¼Œå¦‚æœå­˜åœ¨çˆ¶èŠ‚ç‚¹ï¼Œæ‰§è¡Œ removeVnodes æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> removeVnodes <span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodes<span class="token punctuation">,</span> startIdx<span class="token punctuation">,</span> endIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">removeAndInvokeRemoveHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Text node</span>        <span class="token function">removeNode</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> removeAndInvokeRemoveHook <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> rm<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>rm<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> i    <span class="token keyword">const</span> listeners <span class="token operator">=</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>rm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// we have a recursively passed down rm callback</span>      <span class="token comment" spellcheck="true">// increase the listeners count</span>      rm<span class="token punctuation">.</span>listeners <span class="token operator">+</span><span class="token operator">=</span> listeners    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// directly removing</span>      rm <span class="token operator">=</span> <span class="token function">createRmCb</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// recursively invoke hooks on child component root node</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">removeAndInvokeRemoveHook</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> rm<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>      cbs<span class="token punctuation">.</span>remove<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> rm<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>remove<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> rm<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">rm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">removeNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> invokeDestroyHook <span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i<span class="token punctuation">,</span> j  <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>destroy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>éå†å¾…åˆ é™¤çš„ vnodes åšåˆ é™¤ï¼Œ</li><li>è°ƒç”¨ removeAndInvokeRemoveHook æ‰§è¡Œ cbs.remove é’©å­è¿›è¡Œåˆ é™¤ã€‚å¦‚æœå­˜åœ¨å­èŠ‚ç‚¹åˆ™è¿›è¡Œé€’å½’è°ƒç”¨ removeAndInvokeRemoveHook</li><li>è°ƒç”¨ invokeDestroyHook æ‰§è¡Œ cbs.destroy é’©å­ï¼Œè¿›è¡Œé”€æ¯ã€‚å¦‚æœå­˜åœ¨å­èŠ‚ç‚¹åˆ™è¿›è¡Œé€’å½’è°ƒç”¨ invokeDestroyHook</li><li>æ‰§è¡Œ removeNode è°ƒç”¨å¹³å°çš„ DOM API åˆ é™¤çœŸæ­£çš„ DOM èŠ‚ç‚¹</li></ul><h3 id="æ–°æ—§èŠ‚ç‚¹ç›¸åŒ"><a href="#æ–°æ—§èŠ‚ç‚¹ç›¸åŒ" class="headerlink" title="æ–°æ—§èŠ‚ç‚¹ç›¸åŒ"></a>æ–°æ—§èŠ‚ç‚¹ç›¸åŒ<hr></h3><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRealElement <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// patch existing root node</span>    <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“æ–°æ—§èŠ‚ç‚¹ç›¸åŒçš„æ—¶å€™,ä¼šè°ƒç”¨ patchVnode æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> patchVnode <span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isAsyncPlaceholder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>asyncFactory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">hydrate</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      vnode<span class="token punctuation">.</span>isAsyncPlaceholder <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// reuse element for static trees.</span>  <span class="token comment" spellcheck="true">// note we only do this if the vnode is cloned -</span>  <span class="token comment" spellcheck="true">// if the new node is not cloned it means the render functions have been</span>  <span class="token comment" spellcheck="true">// reset by the hot-reload-api and we need to do a proper re-render.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    vnode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVnode<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>    <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isCloned<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isOnce<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>componentInstance    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> i  <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children  <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>      <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>    nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>postpatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>patchVnode å°† vnode patch åˆ°æ—§çš„ vnode ä¸Šå°†æ‰§è¡Œä»¥ä¸‹ä¸»è¦è¿‡ç¨‹</p><ul><li>å¦‚æœä¸¤ä¸ªvnodeç›¸ç­‰ï¼Œä¸éœ€è¦ patch</li><li>å¦‚æœæ˜¯å¼‚æ­¥å ä½ï¼Œæ‰§è¡Œ hydrate æ–¹æ³•æˆ–è€…å®šä¹‰ isAsyncPlaceholder ä¸º true</li><li>å½“æ›´æ–°çš„ vnode æ˜¯ç»„ä»¶ vnode çš„æ—¶å€™ï¼Œ æ‰§è¡Œ i.prepatch é’©å­å‡½æ•°ï¼Œæ‹¿åˆ°æœ€æ–°çš„ vnode ç»„ä»¶é…ç½®ä»¥åŠç»„ä»¶çš„å®ä¾‹åï¼Œæ‰§è¡Œ updateChildComponent æ–¹æ³•æ›´æ–° vm å®ä¾‹ä¸Šä¸€ç³»åˆ—çš„å±æ€§å’Œæ–¹æ³•</li><li>æ‰§è¡Œ cbs.update é’©å­å‡½æ•°</li><li>å®Œæˆ patch è¿‡ç¨‹</li><li>æ‰§è¡Œ postpatch é’©å­å‡½æ•°</li></ul><p>ä¸Šé¢æ‰§è¡Œçš„æ­¥éª¤æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸€ä¸‹å®Œæˆ patch çš„è¿‡ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯ vnode diff æœ€å¤æ‚çš„åœ°æ–¹</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>      <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>    nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¦‚æœ vnode æ˜¯ä¸ªæ–‡æœ¬èŠ‚ç‚¹ä¸”æ–°æ—§æ–‡æœ¬ä¸ç›¸åŒï¼Œåˆ™ç›´æ¥æ›¿æ¢æ–‡æœ¬å†…å®¹ï¼Œå¦åˆ™æ ¹æ®ä¸åŒæƒ…å†µå¤„ç†é€»è¾‘</li><li>oldCh ä¸ ch éƒ½å­˜åœ¨ä¸”ä¸ç›¸åŒæ—¶ï¼Œè°ƒç”¨ updateChildren æ¥æ›´æ–°å­èŠ‚ç‚¹</li><li>å½“åªæœ‰ ch å­˜åœ¨ï¼Œåˆ¤æ–­æ—§çš„èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹åˆ™å…ˆå°†èŠ‚ç‚¹çš„æ–‡æœ¬æ¸…é™¤ï¼Œç„¶åé€šè¿‡ addVnodes å°† ch æ‰¹é‡æ’å…¥åˆ°æ–°èŠ‚ç‚¹ elm ä¸‹ï¼Œè¡¨ç¤ºä¸éœ€è¦æ—§èŠ‚ç‚¹äº†</li><li>å½“åªæœ‰ oldCh å­˜åœ¨ï¼Œå°†æ—§çš„èŠ‚ç‚¹é€šè¿‡ removeVnodes å…¨éƒ¨æ¸…é™¤ï¼Œè¡¨ç¤ºæ›´æ–°çš„æ˜¯ç©ºèŠ‚ç‚¹</li><li>å½“åªæœ‰æ—§èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹çš„æ—¶å€™ï¼Œåˆ™æ¸…é™¤å…¶èŠ‚ç‚¹æ–‡æœ¬å†…å®¹</li></ul><h3 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren "></a>updateChildren <hr></h3><p>ä¸Šé¢åœ¨åˆ¤æ–­ oldCh ä¸ ch éƒ½å­˜åœ¨ä¸”ä¸ç›¸åŒæ—¶è°ƒç”¨ updateChildren æ¥æ›´æ–°å­èŠ‚ç‚¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> updateChildren <span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>  <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>   <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span>   <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>   <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span>  <span class="token keyword">let</span> oldKeyToIdx<span class="token punctuation">,</span> idxInOld<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">,</span> refElm  <span class="token comment" spellcheck="true">// removeOnly æ˜¯ä¸€ä¸ªåªç”¨äº &lt;transition-group> çš„ç‰¹æ®Šæ ‡ç­¾ï¼Œ</span>  <span class="token comment" spellcheck="true">// ç¡®ä¿ç§»é™¤å…ƒç´ è¿‡ç¨‹ä¸­ä¿æŒä¸€ä¸ªæ­£ç¡®çš„ç›¸å¯¹ä½ç½®ã€‚</span>  <span class="token keyword">const</span> canMove <span class="token operator">=</span> <span class="token operator">!</span>removeOnly  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">checkDuplicateKeys</span><span class="token punctuation">(</span>newCh<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¼€å§‹è€ vnode å‘å³ä¸€ä½</span>      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// Vnode has been moved left</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ç»“æŸè€ vnode å‘å·¦ä¸€ä½</span>      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// æ–°æ—§å¼€å§‹ vnode ç›¸ä¼¼ï¼Œè¿›è¡Œpacthã€‚å¼€å§‹ vnode å‘å³ä¸€ä½</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// æ–°æ—§ç»“æŸ vnode ç›¸ä¼¼ï¼Œè¿›è¡Œpatchã€‚ç»“æŸ vnode å‘å·¦ä¸€ä½</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Vnode moved right</span>      <span class="token comment" spellcheck="true">// æ–°ç»“æŸ vnode å’Œè€å¼€å§‹ vnode ç›¸ä¼¼ï¼Œè¿›è¡Œpatchã€‚</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// è€å¼€å§‹ vnode æ’å…¥åˆ°çœŸå® DOM ä¸­ï¼Œè€å¼€å§‹ vnode å‘å³ä¸€ä½ï¼Œæ–°ç»“æŸ vnode å‘å·¦ä¸€ä½</span>      canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span>      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Vnode moved left</span>     <span class="token comment" spellcheck="true">// è€ç»“æŸ vnode å’Œæ–°å¼€å§‹ vnode ç›¸ä¼¼ï¼Œè¿›è¡Œ patchã€‚</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// è€ç»“æŸ vnode æ’å…¥åˆ°çœŸå® DOM ä¸­ï¼Œè€ç»“æŸ vnode å‘å·¦ä¸€ä½ï¼Œæ–°å¼€å§‹ vnode å‘å³ä¸€ä½</span>      canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// è·å–è€ Idx çš„ key</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// ç»™è€ idx èµ‹å€¼</span>      idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>        <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>        <span class="token punctuation">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// New element</span>        <span class="token comment" spellcheck="true">// å¦‚æœè€ idx ä¸º undefinedï¼Œè¯´æ˜æ²¡æœ‰è¿™ä¸ªå…ƒç´ ï¼Œåˆ›å»ºæ–° DOM å…ƒç´ ã€‚</span>        <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è·å– vnode</span>        vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// å¦‚æœç”Ÿæˆçš„ vnode å’Œæ–°å¼€å§‹ vnode ç›¸ä¼¼ï¼Œæ‰§è¡Œ patchã€‚</span>          <span class="token function">patchVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">// èµ‹å€¼ undefinedï¼Œæ’å…¥ vnodeToMove å…ƒç´ </span>          oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> undefined          canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// ç›¸åŒçš„keyä¸åŒçš„å…ƒç´ ï¼Œè§†ä¸ºæ–°å…ƒç´ </span>          <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// æ–°å¼€å§‹ vnode å‘å³ä¸€ä½</span>      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å¦‚æœè€å¼€å§‹ idx å¤§äºè€ç»“æŸ idxï¼Œå¦‚æœæ˜¯æœ‰æ•ˆæ•°æ®åˆ™æ·»åŠ  vnode åˆ°æ–° vnode ä¸­ã€‚</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">></span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm    <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">></span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­å…ˆæ¥çœ‹ä¸€ä¸‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"app"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>div<span class="token operator">></span>    <span class="token operator">&lt;</span>ul<span class="token operator">></span>      <span class="token operator">&lt;</span>li v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"item in items"</span> <span class="token punctuation">:</span>key<span class="token operator">=</span><span class="token string">"item.id"</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">{</span> item<span class="token punctuation">.</span>val <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">"change"</span><span class="token operator">></span>ç‚¹å‡»æˆ‘<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span>  <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    el<span class="token punctuation">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>      items<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'A'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'B'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'C'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'D'</span> <span class="token punctuation">}</span>      <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'E'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ä»£ç å¾ˆç®€å•å°±æ˜¯åˆå§‹åŒ–çš„æ—¶å€™æ¸²æŸ“åˆ—è¡¨ä¸º Aã€Bã€Cã€Dï¼Œå½“ç‚¹å‡»çš„æ—¶å€™å°†æ•°æ®ä¸­ push ä¸€ä¸ª E å¹¶ä¸”è¿›è¡Œåè½¬ï¼Œç»“æœä¸º Dã€Cã€Bã€Aã€E é‚£ä¹ˆå…·ä½“æ€ä¹ˆæ›´æ–°çš„å‘¢ï¼Œçœ‹ä¸€ä¸‹ä¸‹é¢çš„æµç¨‹</p><p>ç¬¬ä¸€æ­¥:<br><img src="/images/vue-dom-diff01.png"></p><p>ç¬¬äºŒæ­¥:<br><img src="/images/vue-dom-diff02.png"></p><p>ç¬¬ä¸‰æ­¥:<br><img src="/images/vue-dom-diff03.png"></p><p>ç¬¬å››æ­¥:<br><img src="/images/vue-dom-diff04.png"></p><p>ç¬¬äº”æ­¥:<br><img src="/images/vue-dom-diff05.png"></p><p>ç¬¬å…­æ­¥:<br><img src="/images/vue-dom-diff06.png"></p><p>é€šè¿‡ä¸Šé¢æµç¨‹å›¾ï¼Œæˆ‘ä»¬å¾ˆæ¸…æ™°çš„çŸ¥é“å®é™…ä¸Šå°±æ˜¯æ–°æ—§èŠ‚ç‚¹å¯¹æ¯”ç§»åŠ¨çš„è¿‡ç¨‹é‚£ä¹ˆæˆ‘ä»¬æ‹†åˆ† updateChildren å‡½æ•°</p><blockquote><p>åˆå§‹åŒ–å…¨å±€å˜é‡</p></blockquote><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment" spellcheck="true">// æ—§èŠ‚ç‚¹ç´¢å¼•å¼€å§‹ä½ç½®</span>  <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">// æ–°èŠ‚ç‚¹ç´¢å¼•å¼€å§‹ä½ç½®</span>  <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment" spellcheck="true">// æ—§èŠ‚ç‚¹ç´¢å¼•ç»ˆç‚¹ä½ç½®</span>  <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">//  æ—§èŠ‚ç‚¹å¼€å§‹å€¼</span>  <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// æ—§èŠ‚ç‚¹æœ€åä¸€ä½çš„å€¼</span>  <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment" spellcheck="true">// æ–°èŠ‚ç‚¹ç´¢å¼•ç»“æŸä½ç½®</span>  <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// æ–°èŠ‚ç‚¹å¼€å§‹å€¼</span>  <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// æ–°èŠ‚ç‚¹ç»“æŸçš„å€¼</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å®šä¹‰å¾ªç¯ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­ï¼ŒoldStartIdx å’Œ newStartIdx é€’å¢ï¼ŒoldEndIdx å’Œ newEndIdx é€’å‡ã€‚å½“æ¡ä»¶ä¸ç¬¦åˆè·³å‡ºéå†å¾ªç¯</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>æ£€æµ‹ oldStartVnodeã€oldEndVnodeã€‚å¦‚æœ oldStartVnode ä¸å­˜åœ¨ï¼ŒoldCh èµ·å§‹ç‚¹å‘åç§»åŠ¨ã€‚å¦‚æœ oldEndVnode ä¸å­˜åœ¨ï¼ŒoldCh ç»ˆæ­¢ç‚¹å‘å‰ç§»åŠ¨ã€‚</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å¯¹æ¯” oldStartVnode å’Œ newStartVnode å¦‚æœä¸ºçœŸåˆ™æ‰§è¡Œ patchVnode åŒæ—¶å½¼æ­¤å‘åç§»åŠ¨ä¸€ä½</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>  newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> å¯¹æ¯” oldEndVnode å’Œ newEndVnode å¦‚æœä¸ºçœŸåˆ™æ‰§è¡Œ patchVnode åŒæ—¶å½¼æ­¤å‘å‰ç§»åŠ¨ä¸€ä½</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>  newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å¯¹æ¯” oldStartVnode å’Œ newEndVnode å¦‚æœä¸ºçœŸåˆ™æ‰§è¡Œ patchVnodeï¼Œç„¶åå°†è¯¥èŠ‚ç‚¹ç§»åŠ¨åˆ° vnode æ•°ç»„æœ€åä¸€ä½</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Vnode moved right</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span>  oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>  newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å¯¹æ¯” oldEndVnode å’Œ newStartVnode å¦‚æœä¸ºçœŸåˆ™æ‰§è¡Œ patchVnodeï¼Œç„¶åå°†è¯¥èŠ‚ç‚¹ç§»åŠ¨åˆ° vnode æ•°ç»„ç¬¬ä¸€ä½</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Vnode moved left</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>  oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>  newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å¯¹æ¯” idx å¦‚æœæ²¡æœ‰ç›¸åŒçš„ idx åˆ™æ‰§è¡Œ createElm åˆ›å»ºå…ƒç´ ã€‚</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>  <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>  <span class="token punctuation">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// New element</span>  <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> å¯¹æ¯” idx å¦‚æœä¸¤ä¸ª vnode ç›¸ä¼¼ï¼Œåˆ™å…ˆæ‰§è¡Œ patchVnodeï¼ŒèŠ‚ç‚¹ç§»åŠ¨åˆ° vnode æ•°ç»„ç¬¬ä¸€ä½ã€‚å¦‚æœä¸¤ä¸ª vnode ä¸ç›¸ä¼¼ï¼Œè§†ä¸ºæ–°å…ƒç´ ï¼Œæ‰§è¡Œ createElm åˆ›å»º</p></blockquote><pre class="line-numbers language-js"><code class="language-js">vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> undefined  canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// same key but different element. treat as new element</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">}</span>newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> å¦‚æœè€ vnode æ•°ç»„çš„å¼€å§‹ç´¢å¼•å¤§äºç»“æŸç´¢å¼•ï¼Œè¯´æ˜æ–° node æ•°ç»„é•¿åº¦å¤§äºè€ vnode æ•°ç»„ï¼Œæ‰§è¡Œ addVnodes æ–¹æ³•æ·»åŠ è¿™äº›æ–° vnode åˆ° DOM ä¸­</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">></span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm  <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å¦‚æœè€ vnode æ•°ç»„çš„å¼€å§‹ç´¢å¼•å°äºç»“æŸç´¢å¼•ï¼Œè¯´æ˜è€ node æ•°ç»„é•¿åº¦å¤§äºæ–° vnode æ•°ç»„ï¼Œæ‰§è¡Œ removeVnodes æ–¹æ³•ä» DOM ä¸­ç§»é™¤è€ vnode æ•°ç»„ä¸­å¤šä½™çš„ vnode</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">></span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç»è¿‡ä¸Šé¢çš„ä»£ç è§£ææˆ‘ä»¬çŸ¥é“ vue çš„ diff å¯¹é»˜è®¤çš„ diff æ‰§è¡Œäº†ä¼˜åŒ–ï¼ŒæŸ¥æ‰¾çš„åŒä¸€çº§çš„èŠ‚ç‚¹é€šè¿‡å”¯ä¸€çš„ key å»åŒºåˆ†ã€‚å¦‚æœèŠ‚ç‚¹ç±»å‹ç›¸åŒé‡æ–°è®¾ç½®è¯¥èŠ‚ç‚¹çš„å±æ€§ï¼Œç›´æ¥æ›´æ–°ã€‚å¦‚æœä¸åŒï¼Œç›´æ¥å¹²æ‰å‰é¢çš„èŠ‚ç‚¹ï¼Œåˆ›å»ºå¹¶æ’å…¥æ–°çš„èŠ‚ç‚¹ï¼Œä¸å†æ¯”è¾ƒè¿™ä¸ªèŠ‚ç‚¹ä»¥åçš„å­èŠ‚ç‚¹ã€‚è€Œä¸æ˜¯åŒä¸€çº§åˆ«æ¯ä¸€ä¸ªå»æ¯”è¾ƒå¹¶æ›´æ–°æ›¿æ¢ã€‚å¦‚ä¸‹å›¾<br><img src="/images/vue-dom-diff08.png"></p><p>å¦‚ä¸Šå›¾æˆ‘ä»¬å¸Œæœ›åœ¨ A å’Œ B ä¹‹é—´åŠ ä¸€ä¸ª Fï¼Œé‚£é»˜è®¤çš„ diff ç®—æ³•æ˜¯è¿™æ ·çš„<br><img src="/images/vue-dom-diff09.png"></p><p>vue é€šè¿‡æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„ key æ ‡è¯†ç¬¦æ˜¯è¿™æ ·çš„<br><img src="/images/vue-dom-diff10.png"></p><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ ä¸€å¼ å›¾æ¥å¤§è‡´æ€»ç»“ patchVnode çš„æµç¨‹<br><img src="/images/vue-dom-diff11.png"></p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†ä¹‹ v-model</title>
      <link href="/2019/09/12/vue/vuevmodel/"/>
      <url>/2019/09/12/vue/vuevmodel/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­æˆ‘ä»¬ä½¿ç”¨ v-model æ¥å®ç°æ•°æ®çš„åŒå‘ç»‘å®šï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€å¼ æµç¨‹å›¾æ¥å¤§æ¦‚çš„çœ‹çœ‹å®ƒå®ç°çš„æµç¨‹ã€‚å…·ä½“æºç è§£æè¯·å‚è€ƒ<a href="https://ustbhuangyi.github.io/vue-analysis/extend/v-model.html" target="_blank" rel="noopener">Vue.js æŠ€æœ¯æ­ç§˜</a><br><img src="/images/vue-vmodel.png"></p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†ä¹‹å¼‚æ­¥ç»„ä»¶</title>
      <link href="/2019/09/10/vue/vueasync-component/"/>
      <url>/2019/09/10/vue/vueasync-component/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æˆ‘ä»¬å¹³æ—¶çš„å¼€å‘å·¥ä½œä¸­ï¼Œä¸ºäº†å‡å°‘é¦–å±ä»£ç ä½“ç§¯ï¼Œå¾€å¾€ä¼šæŠŠä¸€äº›éé¦–å±çš„ç»„ä»¶è®¾è®¡æˆå¼‚æ­¥ç»„ä»¶ï¼ŒæŒ‰éœ€åŠ è½½ã€‚Vue ä¹ŸåŸç”Ÿæ”¯æŒäº†å¼‚æ­¥ç»„ä»¶çš„èƒ½åŠ›ï¼Œæœ‰ä¸‰ç§å®ç°æ–¹å¼</p><ul><li>æ™®é€šçš„å¼‚æ­¥ç»„ä»¶</li></ul><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'async-example'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// è¿™ä¸ªç‰¹æ®Šçš„ require è¯­æ³•å‘Šè¯‰ webpack</span>   <span class="token comment" spellcheck="true">// è‡ªåŠ¨å°†ç¼–è¯‘åçš„ä»£ç åˆ†å‰²æˆä¸åŒçš„å—ï¼Œ</span>   <span class="token comment" spellcheck="true">// è¿™äº›å—å°†é€šè¿‡ Ajax è¯·æ±‚è‡ªåŠ¨ä¸‹è½½ã€‚</span>   <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./my-async-component'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Promise å¼‚æ­¥ç»„ä»¶</li></ul><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>  <span class="token string">'async-webpack-example'</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// è¯¥ `import` å‡½æ•°è¿”å›ä¸€ä¸ª `Promise` å¯¹è±¡ã€‚</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./my-async-component'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>é«˜çº§å¼‚æ­¥ç»„ä»¶</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> AsyncComp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// éœ€è¦åŠ è½½çš„ç»„ä»¶ã€‚åº”å½“æ˜¯ä¸€ä¸ª Promise</span>  component<span class="token punctuation">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./MyComp.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// åŠ è½½ä¸­åº”å½“æ¸²æŸ“çš„ç»„ä»¶</span>  loading<span class="token punctuation">:</span> LoadingComp<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// å‡ºé”™æ—¶æ¸²æŸ“çš„ç»„ä»¶</span>  error<span class="token punctuation">:</span> ErrorComp<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// æ¸²æŸ“åŠ è½½ä¸­ç»„ä»¶å‰çš„ç­‰å¾…æ—¶é—´ã€‚é»˜è®¤ï¼š200msã€‚</span>  delay<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// æœ€é•¿ç­‰å¾…æ—¶é—´ã€‚è¶…å‡ºæ­¤æ—¶é—´åˆ™æ¸²æŸ“é”™è¯¯ç»„ä»¶ã€‚é»˜è®¤ï¼šInfinity</span>  timeout<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'async-example'</span><span class="token punctuation">,</span> AsyncComp<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬çŸ¥é“å¼‚æ­¥ç»„ä»¶çš„æ³¨å†Œä¸å†æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œ Vue.extend çš„é€»è¾‘æŠŠå®ƒå˜æˆä¸€ä¸ªç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œä½†æ˜¯å®ƒä»ç„¶å¯ä»¥æ‰§è¡Œåˆ° createComponent å‡½æ•°ï¼Œé€šè¿‡createComponent æ–¹æ³•æ‰§è¡Œ <code>Ctor = resolveAsyncComponent(asyncFactory, baseCtor, context)</code>, å®ƒçš„å®šä¹‰åœ¨ <code>src/core/vdom/helpers/resolve-async-component.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> resolveAsyncComponent <span class="token punctuation">(</span>  factory<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>  baseCtor<span class="token punctuation">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span><span class="token punctuation">,</span>  context<span class="token punctuation">:</span> Component<span class="token punctuation">)</span><span class="token punctuation">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>errorComp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>errorComp  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>resolved  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>loadingComp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>loadingComp  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>contexts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// already pending</span>    factory<span class="token punctuation">.</span>contexts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> contexts <span class="token operator">=</span> factory<span class="token punctuation">.</span>contexts <span class="token operator">=</span> <span class="token punctuation">[</span>context<span class="token punctuation">]</span>    <span class="token keyword">let</span> sync <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">const</span> forceRender <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> contexts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        contexts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">$forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">:</span> Object <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// cache resolved</span>      factory<span class="token punctuation">.</span>resolved <span class="token operator">=</span> <span class="token function">ensureCtor</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> baseCtor<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// invoke callbacks only if this is not a synchronous resolve</span>      <span class="token comment" spellcheck="true">// (async resolves are shimmed as synchronous during SSR)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">forceRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> reject <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span>reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>        <span class="token template-string"><span class="token string">`Failed to resolve async component: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token operator">+</span>        <span class="token punctuation">(</span>reason <span class="token operator">?</span> <span class="token template-string"><span class="token string">`\nReason: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>errorComp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        factory<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token function">forceRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// () => Promise</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> res<span class="token punctuation">.</span>component<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        res<span class="token punctuation">.</span>component<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          factory<span class="token punctuation">.</span>errorComp <span class="token operator">=</span> <span class="token function">ensureCtor</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error<span class="token punctuation">,</span> baseCtor<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          factory<span class="token punctuation">.</span>loadingComp <span class="token operator">=</span> <span class="token function">ensureCtor</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>loading<span class="token punctuation">,</span> baseCtor<span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>delay <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            factory<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                factory<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span>                <span class="token function">forceRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>delay <span class="token operator">||</span> <span class="token number">200</span><span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">reject</span><span class="token punctuation">(</span>                process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span>                  <span class="token operator">?</span> <span class="token template-string"><span class="token string">`timeout (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms)`</span></span>                  <span class="token punctuation">:</span> <span class="token keyword">null</span>              <span class="token punctuation">)</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    sync <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token comment" spellcheck="true">// return in case resolved synchronously</span>    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>loading      <span class="token operator">?</span> factory<span class="token punctuation">.</span>loadingComp      <span class="token punctuation">:</span> factory<span class="token punctuation">.</span>resolved  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬å¾ˆç›´è§‚çš„å¯ä»¥çœ‹åˆ°å¼‚æ­¥ç»„ä»¶å®šä¹‰äº† forceRenderã€resolve å’Œ reject å‡½æ•°æ¥æ‰§è¡Œå¼‚æ­¥ç»„ä»¶ã€‚å¦‚æœå¼‚æ­¥ç»„ä»¶æ‰§è¡ŒæˆåŠŸå°±ä¼šæ‰§è¡Œ resolve å‡½æ•°ï¼Œå†é€šè¿‡ forceUpdate çš„é€»è¾‘è°ƒç”¨æ¸²æŸ“ watcher çš„ update æ–¹æ³•ï¼Œè®©æ¸²æŸ“ watcher å¯¹åº”çš„å›è°ƒå‡½æ•°æ‰§è¡Œï¼Œå¼ºåˆ¶è§¦å‘äº†ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚å› ä¸ºå¼‚æ­¥ç»„ä»¶åŠ è½½è¿‡ç¨‹ä¸­æ˜¯æ²¡æœ‰æ•°æ®å‘ç”Ÿå˜åŒ–çš„ï¼Œæ‰€ä»¥é€šè¿‡æ‰§è¡Œ $forceUpdate å¯ä»¥å¼ºåˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“ä¸€æ¬¡ã€‚è¿™æ ·å…¶å®å¼‚æ­¥ç»„ä»¶æœ¬è´¨æ˜¯ä¸¤æ¬¡æ¸²æŸ“ã€‚å¦‚æœå¤±è´¥æˆ–è€…æ˜¯é”™è¯¯åˆ™æ‰§è¡Œ reject å‡½æ•°</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†ä¹‹ç»„ä»¶æ³¨å†Œ</title>
      <link href="/2019/09/08/vue/vuecomponentregister/"/>
      <url>/2019/09/08/vue/vuecomponentregister/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸ä¼šç”¨åˆ°è®¸å¤šè‡ªå®šä¹‰çš„ç»„ä»¶ï¼Œé™¤äº†å†…ç½®ç»„ä»¶è‡ªå®šä¹‰ç»„ä»¶ç”¨çš„æ—¶å€™å¿…é¡»æ³¨å†Œï¼Œå¦åˆ™ä¼šæç¤ºå¦‚ä¸‹ä¿¡æ¯</p><pre class="line-numbers language-md"><code class="language-md">'Unknown custom element: <xxx> - did you register the component correctly? For recursive components, make sure to provide the "name" option.'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åœ¨<a href="https://cn.vuejs.org/v2/guide/components-registration.html" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸­æåˆ°ç»„ä»¶ç»„å†Œçš„æ–¹å¼åˆ†ä¸ºå…¨å±€å’Œå±€éƒ¨</p><h3 id="å…¨å±€æ³¨å†Œ"><a href="#å…¨å±€æ³¨å†Œ" class="headerlink" title="å…¨å±€æ³¨å†Œ"></a>å…¨å±€æ³¨å†Œ</h3><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'my-component-name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ... é€‰é¡¹ ...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¿™æ ·ä¸€å¥è¯ <strong>å…¨å±€æ³¨å†Œçš„è¡Œä¸ºå¿…é¡»åœ¨æ ¹ Vue å®ä¾‹ (é€šè¿‡ new Vue) åˆ›å»ºä¹‹å‰å‘ç”Ÿ</strong> ï¼Œé‚£ä¹ˆä»£ç è¢«å®šä¹‰åœ¨ <code>src/core/global-api/assets.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> ASSET_TYPES <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared/constants'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> isPlainObject<span class="token punctuation">,</span> validateComponentName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span><span class="token keyword">export</span> <span class="token keyword">function</span> initAssetRegisters <span class="token punctuation">(</span>Vue<span class="token punctuation">:</span> GlobalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// åˆ›å»ºæ³¨å†Œçš„æ–¹æ³•</span>  ASSET_TYPES<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>type <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    Vue<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>      id<span class="token punctuation">:</span> string<span class="token punctuation">,</span>      definition<span class="token punctuation">:</span> Function <span class="token operator">|</span> Object    <span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">===</span> <span class="token string">'component'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">validateComponentName</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'component'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          definition<span class="token punctuation">.</span>name <span class="token operator">=</span> definition<span class="token punctuation">.</span>name <span class="token operator">||</span> id          definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'directive'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> definition <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          definition <span class="token operator">=</span> <span class="token punctuation">{</span> bind<span class="token punctuation">:</span> definition<span class="token punctuation">,</span> update<span class="token punctuation">:</span> definition <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> definition        <span class="token keyword">return</span> definition      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éå† ASSET_TYPESï¼Œå¾—åˆ° type åæŒ‚è½½åˆ° Vue ä¸Šï¼Œå®šä¹‰åœ¨ <code>src/shared/constants.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> ASSET_TYPES <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token string">'component'</span><span class="token punctuation">,</span>  <span class="token string">'directive'</span><span class="token punctuation">,</span>  <span class="token string">'filter'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®é™…ä¸Š vue æ˜¯åˆå§‹åŒ–äº†3ä¸ªå…¨å±€å‡½æ•°ï¼Œé‚£ä¹ˆå¯¹äº component æ¥è¯´æ˜¯ä½¿ç”¨ Vue.extend æŠŠè¿™ä¸ªå¯¹è±¡è½¬æ¢æˆä¸€ä¸ªç»§æ‰¿äº Vue çš„æ„é€ å‡½æ•°ï¼Œæœ€åé€šè¿‡ <code>this.options[type + &#39;s&#39;][id] = definition</code> æŠŠå®ƒæŒ‚è½½åˆ° <code>Vue.options.components</code> ä¸Šã€‚ç„¶ååœ¨é€šè¿‡ mergeOptions è¿›è¡Œå‚æ•°åˆå¹¶ï¼Œæœ€ååœ¨åˆ›å»º vnode çš„æ—¶å€™æ‰§è¡Œ _createElement æ–¹æ³•ï¼Œå®šä¹‰åœ¨ <code>src/core/vdom/create-element.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> _createElement <span class="token punctuation">(</span>  context<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  tag<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span> <span class="token operator">|</span> Function <span class="token operator">|</span> Object<span class="token punctuation">,</span>  data<span class="token operator">?</span><span class="token punctuation">:</span> VNodeData<span class="token punctuation">,</span>  children<span class="token operator">?</span><span class="token punctuation">:</span> any<span class="token punctuation">,</span>  normalizationType<span class="token operator">?</span><span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> VNode <span class="token operator">|</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">let</span> vnode<span class="token punctuation">,</span> ns  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> Ctor    ns <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>ns<span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">getTagNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>Ctor <span class="token operator">=</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token string">'components'</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// component</span>      vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// direct component options / constructor</span>    vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ _createElement  æ–¹æ³•ä¸­çš„ resolveAsset æ‹¿åˆ°è¿™ä¸ªç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œå¹¶ä½œä¸º createComponent çš„é’©å­çš„å‚æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> resolveAsset <span class="token punctuation">(</span>  options<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>  type<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  id<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  warnMissing<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> any <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ç»„ä»¶åç§°å¿…é¡»æ˜¯å­—ç¬¦ä¸²</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> assets <span class="token operator">=</span> options<span class="token punctuation">[</span>type<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">// æ£€æŸ¥æœ¬åœ°çš„æ³¨å†Œå˜é‡</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> assets<span class="token punctuation">[</span>id<span class="token punctuation">]</span>  <span class="token keyword">const</span> camelizedId <span class="token operator">=</span> <span class="token function">camelize</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> camelizedId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> assets<span class="token punctuation">[</span>camelizedId<span class="token punctuation">]</span>  <span class="token keyword">const</span> PascalCaseId <span class="token operator">=</span> <span class="token function">capitalize</span><span class="token punctuation">(</span>camelizedId<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> PascalCaseId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> assets<span class="token punctuation">[</span>PascalCaseId<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">// å¦‚æœæ¡ä»¶éƒ½æ»¡è¶³é‚£ä¹ˆè¿”å›æ ‡å¿—ï¼Œè¿›è¡Œ createComponent</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> assets<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> assets<span class="token punctuation">[</span>camelizedId<span class="token punctuation">]</span> <span class="token operator">||</span> assets<span class="token punctuation">[</span>PascalCaseId<span class="token punctuation">]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> warnMissing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">warn</span><span class="token punctuation">(</span>      <span class="token string">'Failed to resolve '</span> <span class="token operator">+</span> type<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">': '</span> <span class="token operator">+</span> id<span class="token punctuation">,</span>      options    <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> res<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢ä»£ç å¾ˆç›´è§‚çš„åˆ†æåˆ°å…³äºæˆ‘ä»¬å…³äºç»„ä»¶åå­—çš„æ³¨æ„äº‹é¡¹</p><ul><li>ç›´æ¥ä½¿ç”¨ id æ‹¿ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æŠŠ id å˜æˆé©¼å³°çš„å½¢å¼å†æ‹¿</li><li>å¦‚æœä»ç„¶ä¸å­˜åœ¨åˆ™åœ¨é©¼å³°çš„åŸºç¡€ä¸ŠæŠŠé¦–å­—æ¯å†å˜æˆå¤§å†™çš„å½¢å¼å†æ‹¿</li><li>å¦‚æœä»ç„¶æ‹¿ä¸åˆ°åˆ™æŠ¥é”™</li></ul><p>è¿™æ ·è¯´æ˜äº†æˆ‘ä»¬åœ¨ä½¿ç”¨ Vue.component(id, definition) å…¨å±€æ³¨å†Œç»„ä»¶çš„æ—¶å€™ï¼Œid å¯ä»¥æ˜¯è¿å­—ç¬¦ã€é©¼å³°æˆ–é¦–å­—æ¯å¤§å†™çš„å½¢å¼ã€‚é‚£ä¹ˆåœ¨åœ¨<a href="https://cn.vuejs.org/v2/guide/components-registration.html" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸­å…³äºç»„ä»¶çš„å‘½ä»¤ä¹Ÿå†™åˆ°ä½¿ç”¨ kebab-case æ–¹å¼ æˆ–è€… ä½¿ç”¨ PascalCase æ–¹å¼</p><h3 id="å±€éƒ¨æ³¨å†Œ"><a href="#å±€éƒ¨æ³¨å†Œ" class="headerlink" title="å±€éƒ¨æ³¨å†Œ"></a>å±€éƒ¨æ³¨å†Œ</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> ComponentA <span class="token keyword">from</span> <span class="token string">'./ComponentA.vue'</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  components<span class="token punctuation">:</span> <span class="token punctuation">{</span>    ComponentA  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶å®é€šè¿‡ä¸Šé¢å…¨å±€ç»„ä»¶çš„æ³¨å†Œï¼Œå±€éƒ¨ç»„ä»¶å°±å¾ˆå¥½ç†è§£äº†ï¼Œä¹Ÿæ˜¯ç»è¿‡å‚æ•°åˆå¹¶ï¼Œé€šè¿‡ resolveAsset æ‹¿åˆ°ç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œå¹¶ä½œä¸ºcreateComponent é’©å­çš„å‚æ•°ï¼ŒåŒºåˆ«æ˜¯å±€éƒ¨ç»„ä»¶åªæœ‰è¯¥ç±»å‹çš„ç»„ä»¶æ‰å¯ä»¥è®¿é—®å±€éƒ¨æ³¨å†Œçš„å­ç»„ä»¶ï¼Œè€Œå…¨å±€æ³¨å†Œæ˜¯æ‰©å±•åˆ° Vue.options ä¸‹ï¼Œæ‰€ä»¥åœ¨æ‰€æœ‰ç»„ä»¶åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šä»å…¨å±€çš„ Vue.options.components æ‰©å±•åˆ°å½“å‰ç»„ä»¶çš„ vm.$options.components ä¸‹ï¼Œè¿™å°±æ˜¯å…¨å±€æ³¨å†Œçš„ç»„ä»¶èƒ½è¢«ä»»æ„ä½¿ç”¨çš„åŸå› ã€‚</p><h3 id="Vue-use"><a href="#Vue-use" class="headerlink" title="Vue.use"></a>Vue.use</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ä½¿ç”¨æ’ä»¶çš„è¯ vue æä¾›ä¸€ä¸ª Vue.use æ–¹æ³•ï¼Œå…·ä½“ç”¨æ³•è§<a href="https://cn.vuejs.org/v2/api/#Vue-use" target="_blank" rel="noopener">å®˜ç½‘æ–‡æ¡£</a>  </p><p>é‚£ä¹ˆå®ƒçš„åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®šä¹‰åœ¨ <code>vue/src/core/index.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// åˆå§‹åŒ–å…¨å±€API</span><span class="token keyword">import</span> <span class="token punctuation">{</span> initGlobalAPI <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./global-api/index'</span><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">//åˆå§‹åŒ–å…¨å±€APIå˜é‡</span><span class="token function">initGlobalAPI</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">default</span> Vue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>initGlobalAPI å®šä¹‰åœ¨ <code>/src/core/global-api/index.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> initGlobalAPI <span class="token punctuation">(</span>Vue<span class="token punctuation">:</span> GlobalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// åˆå§‹åŒ–use()</span>  <span class="token function">initUse</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>initUse(Vue) å®šä¹‰åœ¨ <code>vue/src/core/global-api/use.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> initUse <span class="token punctuation">(</span>Vue<span class="token punctuation">:</span> GlobalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Vue<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">:</span> Function <span class="token operator">|</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// installedPlugins å­˜å‚¨ install åçš„æ’ä»¶</span>    <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// åŒä¸€ä¸ªæ’ä»¶åªä¼šå®‰è£…ä¸€æ¬¡</span>      <span class="token keyword">return</span> <span class="token keyword">this</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ’ä»¶ä»¥å¤–çš„å…¶ä»–å‚æ•° Vue.use(MyPlugin, { someOption: true })</span>    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¦‚æœæ’ä»¶æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»æä¾› install æ–¹æ³•</span>      plugin<span class="token punctuation">.</span>install<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> args<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¦‚æœæ’ä»¶æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¼šè¢«ä½œä¸º install æ–¹æ³•</span>      plugin<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// install ä¹‹åé€šè¿‡é˜Ÿåˆ—å‚¨å­˜æ’ä»¶å†æ¬¡å®‰è£…æ—¶åŒ¹é…åˆ¤æ–­é¿å…é‡å¤å®‰è£…</span>    installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">this</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢æˆ‘ä»¬æ€»ç»“åˆ°</p><ul><li>Vue.use å¯¹è±¡çš„åŸç†æ˜¯ä½¿ç”¨ install å­—æ®µï¼Œæ¥è¿›è¡Œæ’ä»¶å®‰è£…</li><li>Vue.use è°ƒç”¨å¿…é¡»åœ¨ new Vue ä¹‹å‰</li><li>åŒä¸€ä¸ªæ’ä»¶å¤šæ¬¡ä½¿ç”¨ Vue.use åªä¼šè¢«è¿è¡Œä¸€æ¬¡</li></ul>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>computed å’Œ watcher</title>
      <link href="/2019/09/07/vue/vuecomputedwatcher/"/>
      <url>/2019/09/07/vue/vuecomputedwatcher/</url>
      
        <content type="html"><![CDATA[<p>vue çš„ computed å’Œ watch æ˜¯æˆ‘ä»¬åœ¨å¼€å‘ä¸­ç»å¸¸ç”¨çš„æ–¹æ³•ï¼Œä»è€Œå®ç°æ•°æ®çš„å“åº”ä¸ç›‘å¬ï¼Œä¸‹é¢æˆ‘ä»¬ä»ä½¿ç”¨å’Œæºç æ¥åˆ†æä¸€ä¸‹è¿™ä¸¤ä¸ªå±æ€§çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆã€‚</p><h3 id="computed-å’Œ-watch-ä½¿ç”¨"><a href="#computed-å’Œ-watch-ä½¿ç”¨" class="headerlink" title="computed å’Œ watch ä½¿ç”¨"></a>computed å’Œ watch ä½¿ç”¨<hr></h3><blockquote><p>computed è®¡ç®—å±æ€§ï¼Œæ ¹æ®ä¾èµ–çš„æ•°æ®åŠ¨æ€æ˜¾ç¤ºæ–°çš„è®¡ç®—ç»“æœã€‚å½“ä¾èµ–çš„å±æ€§å€¼æ”¹å˜ä¹‹åï¼Œé€šè¿‡è°ƒç”¨å¯¹åº”çš„ getter æ¥è®¡ç®—å¹¶è¿›è¡Œç¼“å­˜ï¼Œè®¡ç®—çš„å±æ€§åç§°ä¸èƒ½åœ¨ç»„ä»¶çš„ props å’Œ data ä¸­å®šä¹‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>template<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hello"</span><span class="token operator">></span>    <span class="token punctuation">{</span><span class="token punctuation">{</span>fullName<span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token punctuation">{</span>        firstName<span class="token punctuation">:</span> <span class="token string">'ren'</span><span class="token punctuation">,</span>        lastName<span class="token punctuation">:</span> <span class="token string">"bo"</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token function">fullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastName      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>watcher ä¾¦å¬å±æ€§ï¼Œå½“ä¾èµ–çš„ data çš„æ•°æ®å˜åŒ–ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­ä¼ å…¥ newVal å’Œ oldValã€‚Vue å®ä¾‹å°†ä¼šåœ¨å®ä¾‹åŒ–æ—¶è°ƒç”¨ $watch()ï¼Œéå† watch å¯¹è±¡çš„æ¯ä¸€ä¸ªå±æ€§ã€‚æ¥å®ç°æ•°æ®çš„ç›‘å¬å’Œè§‚å¯Ÿï¼Œå¹¶åœ¨ä½¿ç”¨watch çš„æ—¶å€™å¯ä»¥æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œè®¾ç½®ä¸­é—´çŠ¶æ€ç­‰ã€‚</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>template<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hello"</span><span class="token operator">></span>    <span class="token punctuation">{</span><span class="token punctuation">{</span>fullName<span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">"handleChangName"</span><span class="token operator">></span>æ”¹å˜å§“å<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      firstName<span class="token punctuation">:</span> <span class="token string">'ren'</span><span class="token punctuation">,</span>      lastName<span class="token punctuation">:</span> <span class="token string">"bo"</span><span class="token punctuation">,</span>      fullName<span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token function">handleChangName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">"zhang"</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">"san"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>    firstName<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token function">handler</span><span class="token punctuation">(</span>newval<span class="token punctuation">,</span> oldval<span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newval<span class="token punctuation">)</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>oldval<span class="token punctuation">)</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>fullName <span class="token operator">=</span> newval <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastName      <span class="token punctuation">}</span><span class="token punctuation">,</span>      immediate<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>watch åªæœ‰åœ¨æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œä½†æ˜¯åˆå§‹åŒ–çš„æ—¶å€™ä¹Ÿå¯ä»¥æ‰§è¡Œï¼Œå¦‚ä¸Šé¢çš„ firstName æ–¹æ³•ä¸­å¢åŠ  handler å’Œ immediate ç«‹å³æ‰§è¡Œï¼Œå…·ä½“ä¸ºä»€ä¹ˆä¼šç«‹å³æ‰§è¡Œï¼Œç¨ååœ¨åšåˆ†æï¼Œå¦‚æœæˆ‘ä»¬è¦ç›‘å¬å¯¹è±¡ä¸­å±æ€§çš„æ·»åŠ å’Œåˆ é™¤é‚£ä¹ˆæˆ‘ä»¬å¿…é¡»ä¸º watch ä¸­æ·»åŠ  deep æ¥è¿›è¡Œå¯¹è±¡æ·±åº¦éå†ï¼Œè¿›è¡Œç›‘å¬ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>template<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hello"</span><span class="token operator">></span>    <span class="token punctuation">{</span><span class="token punctuation">{</span>fullName<span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">"handleChangName"</span><span class="token operator">></span>æ”¹å˜å§“å<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      person<span class="token punctuation">:</span> <span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span>        age<span class="token punctuation">:</span> <span class="token number">26</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      fullName<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token function">handleChangName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"zhangsan"</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">27</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>    person<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token function">handler</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>fullName <span class="token operator">=</span> newVal<span class="token punctuation">.</span>name <span class="token operator">+</span> newVal<span class="token punctuation">.</span>age      <span class="token punctuation">}</span><span class="token punctuation">,</span>      immediate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      deep<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="computed-å’Œ-watch-çš„å¼‚åŒ"><a href="#computed-å’Œ-watch-çš„å¼‚åŒ" class="headerlink" title="computed å’Œ watch çš„å¼‚åŒ"></a>computed å’Œ watch çš„å¼‚åŒ<hr></h3><p>é€šè¿‡ä¸Šé¢çš„ä½¿ç”¨å¯¹æ¯”</p><p>ç›¸åŒç‚¹</p><ul><li>computed å’Œwatch éƒ½èƒ½èµ·åˆ°ç›‘å¬å’Œä¾èµ–å¤„ç†æ•°æ®</li><li>éƒ½æ˜¯é€šè¿‡ vue çš„ç›‘å¬å™¨å®ç°çš„</li></ul><p>ä¸åŒç‚¹</p><ul><li>computed ä¸»è¦ç”¨äºå¯¹åŒæ­¥æ•°æ®çš„å¤„ç†</li><li>watch åˆ™ä¸»è¦ç”¨äºç›‘å¬æŸä¸ªå€¼çš„å˜åŒ–å»å®Œæˆå¼€é”€è¾ƒå¤§çš„å¤æ‚ä¸šåŠ¡é€»è¾‘</li></ul><p>ä¸»è¦çš„åº”ç”¨åœºæ™¯å°±æ˜¯å¦‚æœä¸€ä¸ªæ•°æ®ä¾èµ–å¦ä¸€ä¸ªæ•°æ®é‚£ä¹ˆå°±ç”¨ computedï¼Œå¦‚æœåœ¨ç›‘å¬æ•°æ®å‘ç”Ÿå˜åŒ–å»å®ç°æŸä¸€äº›åŠŸèƒ½ï¼ŒçŠ¶æ€ï¼Œå¼‚æ­¥ç­‰é‚£å°±å°±ç”¨ watchï¼Œä½†æ˜¯ç”±äº watch ä½¿ç”¨deepè¿›è¡Œæ·±åº¦éå†ç›‘å¬ä¼šæ¶ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥è¿˜æ˜¯å°½é‡å°‘ç”¨ </p><h3 id="computed-æœ¬è´¨-â€“-computed-watch"><a href="#computed-æœ¬è´¨-â€“-computed-watch" class="headerlink" title="computed æœ¬è´¨ â€“ computed watch"></a>computed æœ¬è´¨ â€“ computed watch<hr></h3><p>å‰é¢åˆ†æè¿‡ new Vue() çš„æ—¶å€™ä¼šè°ƒç”¨ _init æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸï¼Œåˆå§‹åŒ–äº‹ä»¶ï¼Œåˆå§‹åŒ–renderï¼Œåˆå§‹åŒ–dataï¼Œcomputedï¼Œmethodsï¼Œwactherç­‰ç­‰ï¼Œä¸æ¸…æ¥šå¤§è‡´æµç¨‹çš„è¯·å‚è€ƒå¦ä¸€ç¯‡æ–‡ç«  <a href="https://www.studyfe.cn/2019/08/27/vue/vueprinciple/#toc-heading-12">vue çš„ä¸»çº¿æµç¨‹</a>ã€‚è®¡ç®—å±æ€§çš„åˆå§‹åŒ–æ˜¯å‘ç”Ÿåœ¨ vue å®ä¾‹åˆå§‹åŒ–é˜¶æ®µçš„ initState å‡½æ•°ä¸­</p><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">export</span> <span class="token keyword">function</span> initState <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* asRootData */</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢è¿›è¡Œäº†åˆ¤æ–­ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ opts.computed å­˜åœ¨çš„æƒ…å†µæ‰§è¡Œ initComputed æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å®šä¹‰åœ¨<code>src/core/instance/state.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ç”¨äºä¼ å…¥ Watcher å®ä¾‹çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå³computed watcher</span><span class="token keyword">const</span> computedWatcherOptions <span class="token operator">=</span> <span class="token punctuation">{</span> lazy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token keyword">function</span> initComputed <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> computed<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å£°æ˜ watchersï¼ŒåŒæ—¶åœ¨å®ä¾‹ä¸ŠæŒ‚è½½ _computedWatchers</span>  <span class="token keyword">const</span> watchers <span class="token operator">=</span> vm<span class="token punctuation">.</span>_computedWatchers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// è®¡ç®—å±æ€§åœ¨ ssr æ¨¡å¼åœ¨åªèƒ½ä½¿ç”¨ getter æ–¹æ³•</span>  <span class="token keyword">const</span> isSSR <span class="token operator">=</span> <span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// éå†å–å‡º computed å¯¹è±¡ä¸­çš„æ¯ä¸ªæ–¹æ³•å¹¶èµ‹å€¼ç»™ userDef</span>    <span class="token keyword">const</span> userDef <span class="token operator">=</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> userDef <span class="token punctuation">:</span> userDef<span class="token punctuation">.</span><span class="token keyword">get</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> getter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">warn</span><span class="token punctuation">(</span>        <span class="token template-string"><span class="token string">`Getter is missing for computed property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">".`</span></span><span class="token punctuation">,</span>        vm      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSSR<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯SSRæœåŠ¡ç«¯æ¸²æŸ“ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªwatcherå®ä¾‹</span>      watchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>        vm<span class="token punctuation">,</span>        getter <span class="token operator">||</span> noop<span class="token punctuation">,</span>        noop<span class="token punctuation">,</span>        computedWatcherOptions      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ç»„ä»¶å®šä¹‰çš„è®¡ç®—å±æ€§å·²ç»åœ¨ç»„ä»¶åŸå‹ä¸Šå®šä¹‰ã€‚æˆ‘ä»¬åªéœ€è¦å®šä¹‰åœ¨å®ä¾‹åŒ–æ—¶å®šä¹‰çš„è®¡ç®—å±æ€§ã€‚</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¦‚æœcomputed ä¸­çš„ key æ²¡æœ‰è®¾ç½®åˆ° vm ä¸­ï¼Œé€šè¿‡defineComputedå‡½æ•°æŒ‚è½½ä¸Šå»</span>      <span class="token function">defineComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> userDef<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// props å’Œ data ä¸­ä¸èƒ½å’Œ computed çš„ key åŒå</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`The computed property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is already defined in data.`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`The computed property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is already defined as a prop.`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢æºç æˆ‘ä»¬å‘ç°å®ƒå…ˆå£°æ˜äº†ä¸€ä¸ªåä¸º watchers çš„ç©ºå¯¹è±¡ï¼ŒåŒæ—¶åœ¨ vm ä¸Šä¹ŸæŒ‚è½½äº†è¿™ä¸ªç©ºå¯¹è±¡ã€‚æ¥ç€å¯¹ computed å¯¹è±¡åšéå†ï¼Œæ‹¿åˆ°æ¯ä¸ª userDefï¼Œå¦‚æœ userDef æ˜¯ function çš„è¯å°±èµ‹ç»™ getterï¼Œå¦‚æœä¸æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå°±ä¼šä¸ºè¿™ä¸ª getter åˆ›å»ºä¸€ä¸ª watcherï¼Œè¿™ä¸ª watcher å’Œæ¸²æŸ“ watcher æœ‰ä¸€ç‚¹å¾ˆå¤§çš„ä¸åŒï¼Œæˆ‘ä»¬åœ¨æ–°å»ºå®ä¾‹çš„æ—¶å€™ä¼ å…¥äº†ç¬¬å››ä¸ªå‚æ•° computedWatcherOptionsï¼Œå…¶å®ä¹Ÿå°±æ˜¯åœ¨ä»£ç çš„ç¬¬ä¸€è¡Œï¼Œ<code>const computedWatcherOptions = { lazy: true }</code>ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯å®ç°computed watcherçš„å…³é”®ï¼Œè¿™æ ·watcher ä¸­å°±å‡ºç°äº†å˜åŒ–ï¼Œwatcher å®šä¹‰åœ¨ <code>src/core/observer/watcher.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// options</span><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>deep  <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>user  <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy  <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>sync  <span class="token keyword">this</span><span class="token punctuation">.</span>before <span class="token operator">=</span> options<span class="token punctuation">.</span>before<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb<span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>uid <span class="token comment" spellcheck="true">// uid for batching</span><span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token comment" spellcheck="true">// for lazy watchers</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ this.lazy å®é™…ä¸Šå°±æ˜¯ computedWatcherOptions ä¼ é€’è¿‡æ¥çš„ï¼Œå°† dirty çŠ¶æ€æ”¹ä¸º true ä¹‹ååœ¨ createComputedGetter æ–¹æ³•ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> createComputedGetter <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> computedGetter <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>        watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        watcher<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> watcher<span class="token punctuation">.</span>value    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ä¹‹åæ‰§è¡Œäº† watcher.evaluate()ï¼Œé€šè¿‡è°ƒç”¨ this.get() æ–¹æ³•å®é™…ä¸Šå°±æ˜¯åœ¨æ‰§è¡Œ <code>value = this.getter.call(vm, vm)</code>ï¼Œè¿™æ ·å°±èƒ½æ‰§è¡Œè®¡ç®—å±æ€§å®šä¹‰çš„ getter å‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js">  evaluate <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹ååœ¨æ‰§è¡Œ watcher.depend() æŠŠè‡ªèº«æŒæœ‰çš„ dep æ·»åŠ åˆ°å½“å‰æ­£åœ¨è®¡ç®—çš„ watcher ä¸­ï¼Œè¿™ä¸ªæ—¶å€™ Dep.target å°±æ˜¯è¿™ä¸ª computed watcherï¼Œæœ€åæ‹¿åˆ°å½“å‰ watcher çš„ valueï¼Œå½“è®¡ç®—å±æ€§ä¾èµ–çš„æ•°æ®å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä¼šè§¦å‘ setter è¿‡ç¨‹ï¼Œé€šçŸ¥æ‰€æœ‰è®¢é˜…å®ƒå˜åŒ–çš„ watcher è¿›è¡Œæ›´æ–°ï¼Œæ‰§è¡Œ watcher.update() æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js">update <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="watch-çš„å·¥ä½œåŸç†"><a href="#watch-çš„å·¥ä½œåŸç†" class="headerlink" title="watch çš„å·¥ä½œåŸç†"></a>watch çš„å·¥ä½œåŸç†<hr></h3><p>å’Œ computed ä¸€æ ·ä¹Ÿæ˜¯åœ¨æ‰§è¡Œ initState çš„æ—¶å€™æ‰§è¡Œäº† <code>initWatch(vm, opts.watch)</code></p><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">export</span> <span class="token keyword">function</span> initState <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>initWatch æ–¹æ³•å®šä¹‰åœ¨ <code>src/core/instance/state.js</code> ä¸­ </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> initWatch <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> watch<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> watch<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// éå† watch å–åˆ° key </span>    <span class="token keyword">const</span> handler <span class="token operator">=</span> watch<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å› ä¸º Vue æ˜¯æ”¯æŒ watch çš„åŒä¸€ä¸ª key å¯¹åº”å¤šä¸ª handlerï¼Œæ‰€ä»¥å¦‚æœ handler æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™éå†è¿™ä¸ªæ•°ç»„</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handler<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> createWatcher <span class="token punctuation">(</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>  handler<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  options<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    options <span class="token operator">=</span> handler    handler <span class="token operator">=</span> handler<span class="token punctuation">.</span>handler  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    handler <span class="token operator">=</span> vm<span class="token punctuation">[</span>handler<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡å¯¹ hanlder çš„ç±»å‹åšåˆ¤æ–­ï¼Œæ‹¿åˆ°å®ƒæœ€ç»ˆçš„å›è°ƒå‡½æ•°ï¼Œæœ€åè°ƒç”¨ <code>vm.$watch(keyOrFn, handler, options)</code> å‡½æ•°ï¼Œvm.$watch å®é™…ä¸Šæ˜¯æ‰§è¡Œäº† Vue.prototype.$watch</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$watch <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>    expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>    cb<span class="token punctuation">:</span> any<span class="token punctuation">,</span>    options<span class="token operator">?</span><span class="token punctuation">:</span> Object  <span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        cb<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`callback for immediate watcher "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> unwatchFn <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä¾¦å¬å±æ€§ watch æœ€ç»ˆä¼šè°ƒç”¨ $watch æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é¦–å…ˆåˆ¤æ–­ cb å¦‚æœæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™è°ƒç”¨ createWatcher æ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸º $watch æ–¹æ³•æ˜¯ç”¨æˆ·å¯ä»¥ç›´æ¥è°ƒç”¨çš„ï¼Œå®ƒå¯ä»¥ä¼ é€’ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ä¼ é€’å‡½æ•°ã€‚æ¥ç€æ‰§è¡Œ const watcher = new Watcher(vm, expOrFn, cb, options) å®ä¾‹åŒ–äº†ä¸€ä¸ª watcherï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹è¿™æ˜¯ä¸€ä¸ª user watcherï¼Œå› ä¸º options.user = trueã€‚é€šè¿‡å®ä¾‹åŒ– watcher çš„æ–¹å¼ï¼Œä¸€æ—¦æˆ‘ä»¬ watch çš„æ•°æ®å‘é€å˜åŒ–ï¼Œå®ƒæœ€ç»ˆä¼šæ‰§è¡Œ watcher çš„ run æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•° cbï¼Œä¸Šé¢è¿˜æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ å¦‚æœå‚æ•°ä¼ é€’çš„ deep ï¼Œè¿™æ ·å°±åˆ›å»ºäº†ä¸€ä¸ª deep watcher åˆ™ä¼šæ‰§è¡Œ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œ traverse å‡½æ•°è¿›è¡Œæ·±å±‚é€’å½’éå†ï¼Œé‚£ä¹ˆè¿™æ ·å°±è§£å†³äº†æˆ‘ä»¬å¼€ç¯‡æ—¶ä½¿ç”¨ watch è§‚å¯Ÿæ”¹å˜ä¸€ä¸ªå¤æ‚å¯¹è±¡ä¸èµ·ä½œç”¨çš„é—®é¢˜ï¼Œé‚£ä¹ˆæ˜¯ watch ç«‹å³æ‰§è¡Œæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    cb<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`callback for immediate watcher "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡è®¾ç½® immediate ä¸º trueï¼Œåˆ™ç›´æ¥ä¼šæ‰§è¡Œå›è°ƒå‡½æ•° cbã€‚è¿™æ ·å°±ä¼šç«‹å³æ‰§è¡Œ watch å±æ€§</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“<hr></h3><p>é€šè¿‡ä»¥ä¸Šçš„åˆ†æï¼Œæˆ‘ä»¬å¤§æ¦‚äº†è§£äº†è®¡ç®—å±æ€§æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªcomputed watchï¼Œä¾¦å¬å±æ€§æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªuser watchã€‚è®¡ç®—å±æ€§é€‚åˆåœ¨æ¨¡ç‰ˆæ¸²æŸ“ä¸­æŸä¸€ä¸ªå€¼ä¾èµ–äº†å…¶ä»–å“åº”å¯¹è±¡ç”šè‡³æ˜¯è®¡ç®—å±æ€§è®¡ç®—è€Œæ¥ï¼Œè€Œä¾¦å¬å±æ€§é€‚ç”¨äºè§‚æµ‹æŸä¸ªå€¼çš„å˜åŒ–å»å®Œæˆä¸€æ®µå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†è§£æä¹‹å“åº”å¼</title>
      <link href="/2019/09/05/vue/vueobserve/"/>
      <url>/2019/09/05/vue/vueobserve/</url>
      
        <content type="html"><![CDATA[<h2 id="å“åº”å¼å¯¹è±¡"><a href="#å“åº”å¼å¯¹è±¡" class="headerlink" title="å“åº”å¼å¯¹è±¡"></a>å“åº”å¼å¯¹è±¡</h2><p>æåˆ° vue çš„åŒå‘æ•°æ®ç»‘å®šåŸç†ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ˜¯åˆ©ç”¨äº† <code>Object.defineProperty</code> ç»™æ•°æ®æ·»åŠ  getter å’Œ setterï¼Œæ¥è¿›è¡Œä¾èµ–æ”¶é›†å’Œæ•°æ®æ´¾å‘æ›´æ–°ï¼Œé¦–å…ˆæˆ‘ä»¬å†æ¥ç†Ÿæ‚‰ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•</p><h3 id="Object-defineProperty"><a href="#Object-defineProperty" class="headerlink" title="Object.defineProperty "></a>Object.defineProperty <hr></h3><p>MDN ä¸­å†™åˆ° <code>Object.defineProperty()</code> æ–¹æ³•ä¼šç›´æ¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ç°æœ‰å±æ€§ï¼Œ å¹¶è¿”å›è¿™ä¸ªå¯¹è±¡</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Person <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'sayHello'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token keyword">set</span><span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> value  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'renbo'</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>sayHello<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// my name is renbo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬åœ¨å®ç°ä¸€ä¸ªæç®€ç‰ˆåŒå‘ç»‘å®š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>è¯·è¾“å…¥:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>input<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>Object<span class="token punctuation">.</span><span class="token function">definePerperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  <span class="token keyword">get</span><span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'è·å¾—çš„å€¼'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token keyword">set</span><span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'è®¾ç½®çš„å€¼'</span><span class="token punctuation">)</span>    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> newVal    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> newVal<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">const</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>  obj<span class="token punctuation">.</span>text <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>set æä¾› setter æ–¹æ³•ï¼Œå½“æˆ‘ä»¬å¯¹ p.name åšä¿®æ”¹çš„æ—¶å€™ä¼šè§¦å‘ setter æ–¹æ³•ï¼Œ æˆ‘ä»¬è®¿é—® sayHello çš„æ—¶å€™ä¼šè§¦å‘ getter æ–¹æ³•ï¼Œå–åˆ°å¯¹åº”çš„å€¼ï¼Œé‚£ä¹ˆä¸€æ—¦å¯¹è±¡æ‹¥æœ‰äº† getter å’Œ setterï¼Œå°±æŠŠè¿™ä¸ªå¯¹è±¡å˜ä¸ºè‡ªåŠ¨å­˜å–çš„å“åº”å¯¹è±¡</p><h3 id="initState"><a href="#initState" class="headerlink" title="initState "></a>initState <hr></h3><p>åœ¨ vue _init é˜¶æ®µæˆ‘ä»¬è¿˜æ‰§è¡Œäº† initState(vm) æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸Šç¯‡æ–‡ç« å†™åˆ°è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å¯¹ propsã€methodsã€dataã€computed å’Œ wathcer ç­‰å±æ€§åšäº†åˆå§‹åŒ–æ“ä½œ,åœ¨ <code>src/core/instance/state.js ä¸­å®šä¹‰</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> initState <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* asRootData */</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="initProps"><a href="#initProps" class="headerlink" title="initProps "></a>initProps <hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> initProps <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> propsOptions<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> propsData <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>propsData <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>_props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// cache prop keys so that future props updates can iterate using Array</span>  <span class="token comment" spellcheck="true">// instead of dynamic object key enumeration.</span>  <span class="token keyword">const</span> keys <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_propKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> isRoot <span class="token operator">=</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>$parent  <span class="token comment" spellcheck="true">// root instance props should be converted</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> propsOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>    keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">validateProp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> propsOptions<span class="token punctuation">,</span> propsData<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> hyphenatedKey <span class="token operator">=</span> <span class="token function">hyphenate</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReservedAttribute</span><span class="token punctuation">(</span>hyphenatedKey<span class="token punctuation">)</span> <span class="token operator">||</span>          config<span class="token punctuation">.</span><span class="token function">isReservedAttr</span><span class="token punctuation">(</span>hyphenatedKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hyphenatedKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is a reserved attribute and cannot be used as component prop.`</span></span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token function">defineReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isUpdatingChildComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">warn</span><span class="token punctuation">(</span>            <span class="token template-string"><span class="token string">`Avoid mutating a prop directly since the value will be `</span></span> <span class="token operator">+</span>            <span class="token template-string"><span class="token string">`overwritten whenever the parent component re-renders. `</span></span> <span class="token operator">+</span>            <span class="token template-string"><span class="token string">`Instead, use a data or computed property based on the prop's `</span></span> <span class="token operator">+</span>            <span class="token template-string"><span class="token string">`value. Prop being mutated: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">,</span>            vm          <span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">defineReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// static props are already proxied on the component's prototype</span>    <span class="token comment" spellcheck="true">// during Vue.extend(). We only need to proxy props defined at</span>    <span class="token comment" spellcheck="true">// instantiation here.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`_props`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»ä¸Šé¢ä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ° props è¿‡ç¨‹ï¼Œä¸»è¦å°±æ˜¯éå† propsOptions ï¼Œè°ƒç”¨ defineReactive æ–¹æ³•å’Œ proxyï¼Œä½†æ˜¯ä¸Šé¢åœ¨å¼€å‘ç¯å¢ƒä¸­è°ƒç”¨ defineReactive ç»™ä¸€ä¸ªè­¦å‘Šï¼Œå¹³æ—¶æˆ‘ä»¬é€šè¿‡ props æ–¹æ³•æ¥æ¥å—çˆ¶ç»„ä»¶æ‰€ä¼ è¿‡æ¥çš„å€¼ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹æ˜¯å•é¡¹çš„ï¼Œçˆ¶ç»„ä»¶å¯ä»¥æ”¹å˜ä¼ ç»™å­ç»„ä»¶çš„å€¼ï¼Œä½†æ˜¯å¦‚æœå­ç»„ä»¶æƒ³æ”¹å˜æ‰€æ¥å—çš„å€¼å¹¶ä¼ ç»™çˆ¶ç»„ä»¶æ˜¯ä¸å¯ä»¥çš„ï¼Œä¼šæ”¶åˆ°è¿™ä¸ªè­¦å‘Š</p><p>è¿™ä¸ªé”™è¯¯å‘Šè¯‰æˆ‘ä»¬é¿å…å»ç›´æ¥æ›´æ”¹ props å› ä¸ºå½“çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼Œè¯¥å€¼å°±ä¼šè¢«è¦†ç›–ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°è®¡ç®—å±æ€§æˆ–è€…ä¾¦å¬å±æ€§äº†ã€‚</p><p>defineReactive æ–¹æ³•å’Œ proxy å…·ä½“ä½œç”¨æˆ‘ä»¬åœ¨åé¢ä»‹ç»ã€‚</p><h3 id="initData"><a href="#initData" class="headerlink" title="initData"></a>initData<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> initData <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span>    <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>    <span class="token punctuation">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>      <span class="token string">'data functions should return an object:\n'</span> <span class="token operator">+</span>      <span class="token string">'https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function'</span><span class="token punctuation">,</span>      vm    <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// proxy data on instance</span>  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>methods<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`Method "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" has already been defined as a data property.`</span></span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>        <span class="token template-string"><span class="token string">`The data property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is already declared as a prop. `</span></span> <span class="token operator">+</span>        <span class="token template-string"><span class="token string">`Use prop default value instead.`</span></span><span class="token punctuation">,</span>        vm      <span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`_data`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// observe data</span>  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>initData ä¸»è¦æ˜¯éå†dataï¼Œå–åˆ°å¯¹åº”çš„key è°ƒç”¨ proxy ï¼›å¦ä¸€ä¸ªæ˜¯è°ƒç”¨ observe æ–¹æ³•</p><h3 id="proxy"><a href="#proxy" class="headerlink" title="proxy"></a>proxy<hr></h3><p>å¹³æ—¶æˆ‘ä»¬å†™ vue çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨æ–¹æ³•ä¸­è®¿é—® props å’Œ dataï¼Œçœ‹ä¸‹é¢ä¾‹å­</p><pre class="line-numbers language-js"><code class="language-js">props<span class="token punctuation">:</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>    <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token string">'renbo'</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>data<span class="token punctuation">:</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>     age<span class="token punctuation">:</span> <span class="token number">26</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>  sayHello <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™å°±æ˜¯é€šè¿‡ proxy å°† props å’Œ data ä¸Šçš„å±æ€§ä»£ç†åˆ° vm å®ä¾‹ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ this è®¿é—®åˆ°</p><p>é‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹ proxy æ˜¯å¦‚ä½•å®šä¹‰çš„å‘¢</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> proxy <span class="token punctuation">(</span>target<span class="token punctuation">:</span> Object<span class="token punctuation">,</span> sourceKey<span class="token punctuation">:</span> string<span class="token punctuation">,</span> key<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>  sharedPropertyDefinition<span class="token punctuation">.</span><span class="token keyword">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> proxyGetter <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  sharedPropertyDefinition<span class="token punctuation">.</span><span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> proxySetter <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val  <span class="token punctuation">}</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sharedPropertyDefinition<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ Object.defineProperty æŠŠ target[sourceKey][key] çš„è¯»å†™å˜æˆäº†å¯¹ target[key] çš„è¯»å†™ï¼Œæ‰€ä»¥å¯¹äº props å’Œ data è€Œè¨€å°±æ˜¯</p><pre class="line-numbers language-js"><code class="language-js">vm<span class="token punctuation">.</span>_props<span class="token punctuation">.</span>xxx <span class="token operator">-</span><span class="token operator">></span> vm<span class="token punctuation">.</span>xxxvm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>xxx <span class="token operator">-</span><span class="token operator">></span> vm<span class="token punctuation">.</span>xxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="observe"><a href="#observe" class="headerlink" title="observe"></a>observe<hr></h3><p>ä¸Šé¢åœ¨ initDataä¸­è°ƒç”¨äº† observe å‡½æ•°ï¼Œè¿›å…¥æ–‡ä»¶ <code>src/core/observer/index.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">**</span> <span class="token operator">*</span> Attempt to create an observer instance <span class="token keyword">for</span> a value<span class="token punctuation">,</span> <span class="token operator">*</span> returns the <span class="token keyword">new</span> <span class="token class-name">observer</span> <span class="token keyword">if</span> successfully observed<span class="token punctuation">,</span> <span class="token operator">*</span> or the existing observer <span class="token keyword">if</span> the value already has one<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span><span class="token keyword">export</span> <span class="token keyword">function</span> observe <span class="token punctuation">(</span>value<span class="token punctuation">:</span> any<span class="token punctuation">,</span> asRootData<span class="token punctuation">:</span> <span class="token operator">?</span>boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Observer <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> ob<span class="token punctuation">:</span> Observer <span class="token operator">|</span> <span class="token keyword">void</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__ob__ <span class="token keyword">instanceof</span> <span class="token class-name">Observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ob <span class="token operator">=</span> value<span class="token punctuation">.</span>__ob__  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>    shouldObserve <span class="token operator">&amp;&amp;</span>    <span class="token operator">!</span><span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token operator">!</span>value<span class="token punctuation">.</span>_isVue  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>asRootData <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ob<span class="token punctuation">.</span>vmCount<span class="token operator">++</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> ob<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>observe å°±æ˜¯ç»™é™¤äº† vnode çš„å¯¹è±¡ç±»å‹çš„æ•°æ®æ·»åŠ ä¸€ä¸ªè§‚å¯Ÿè€…å®ä¾‹</p><p>å¦‚æœå·²ç»æ·»åŠ è¿‡åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™åœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶ä¸‹å» new Observer</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Observer çš„ä½œç”¨</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> any<span class="token punctuation">;</span>  dep<span class="token punctuation">:</span> Dep<span class="token punctuation">;</span>  vmCount<span class="token punctuation">:</span> number<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// number of vms that have this object as root $data</span>  constructor <span class="token punctuation">(</span>value<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span>    <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProto<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">protoAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">copyAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Walk through all properties and convert them into   * getter/setters. This method should only be called when   * value type is Object.   */</span>  walk <span class="token punctuation">(</span>obj<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Observe a list of Array items.   */</span>  observeArray <span class="token punctuation">(</span>items<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Observer æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°</p><ul><li>åœ¨constructor ä¸­å®ä¾‹åŒ–äº† Dep å¯¹è±¡</li><li>æ‰§è¡Œäº† <code>def(value, &#39;__ob__&#39;, this)</code></li><li>å¯¹ value è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯æ•°ç»„è°ƒç”¨ observeArrayï¼Œå¦‚æœæ˜¯çº¯å¯¹è±¡è°ƒç”¨ walk </li><li>observeArray æ–¹æ³•ä¸­éå†æ•°ç»„å†æ¬¡è°ƒç”¨ observerï¼Œè€Œ walk éå†å¯¹è±¡çš„ key è°ƒç”¨ defineReactive</li></ul><p>Dep ä¸»è¦çš„ä½œç”¨å°±æ˜¯è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œæ˜¯æ•´ä¸ª getter çš„æ ¸å¿ƒï¼Œåœ¨åé¢ä¼šä»‹ç»ï¼Œdef å‡½æ•°æ˜¯é€šè¿‡ Object.defineProperty çš„å°è£…çš„ï¼Œä½œç”¨æ˜¯å°†è‡ªèº«å®ä¾‹æ·»åŠ åˆ°æ•°æ®å¯¹è±¡ value çš„ <code>__ob__</code> å±æ€§ä¸Šï¼Œè¿™æ ·æˆ‘ä»¬åœ¨å¼€å‘ä¸­å°±ä¼šçœ‹åˆ° data ä¸Šå¯¹è±¡ç±»å‹çš„æ•°æ®å¤šäº†ä¸€ä¸ª <code>__ob__</code>çš„å±æ€§</p><h3 id="defineReactive"><a href="#defineReactive" class="headerlink" title="defineReactive"></a>defineReactive<hr></h3><p>defineReactive çš„ä½œç”¨å°±æ˜¯å®šä¹‰ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œç»™å¯¹è±¡åŠ¨æ€æ·»åŠ  getter å’Œ setter</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * Define a reactive property on an Object. */</span><span class="token keyword">export</span> <span class="token keyword">function</span> defineReactive <span class="token punctuation">(</span>  obj<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  val<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  customSetter<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>  shallow<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// cater for pre-defined getter/setters</span>  <span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span><span class="token keyword">get</span>  <span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span><span class="token keyword">set</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>getter <span class="token operator">||</span> setter<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> reactiveGetter <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">:</span> val      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>          childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> value    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> reactiveSetter <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">:</span> val      <span class="token comment" spellcheck="true">/* eslint-disable no-self-compare */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/* eslint-enable no-self-compare */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// #7981: for accessor properties without setter</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>getter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span> <span class="token keyword">return</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        setter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        val <span class="token operator">=</span> newVal      <span class="token punctuation">}</span>      childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>defineReactive å‡½æ•°</p><ul><li>new Dep()</li><li>é€šè¿‡ Object.getOwnPropertyDescriptor æ‹¿åˆ° obj çš„å±æ€§æè¿°ç¬¦</li><li>å¯¹å­å¯¹è±¡é€’å½’è°ƒç”¨ observe æ–¹æ³•ï¼ŒæŠŠæ‰€æœ‰å­å±æ€§å˜æˆå“åº”å¼å¯¹è±¡</li><li>åˆ©ç”¨ Object.defineProperty ç»™ obj çš„å±æ€§ key æ·»åŠ  getter å’Œ setter</li></ul><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„é€»è¾‘æ­¥éª¤æ•´ç†ä¸‹é¢ä¸€å¼ å›¾</p><img src="/images/vue-observer.png"><p>é€šè¿‡ä¸Šé¢çš„é€»è¾‘å’Œæ€»ç»“å‘ç°å“åº”å¼å¯¹è±¡çš„æ ¸å¿ƒå…¶å®å°±æ˜¯åˆ©ç”¨ Object.defineProperty ç»™æ•°æ®æ·»åŠ äº† getter å’Œ setterï¼Œæ¥è¿›è¡Œä¾èµ–æ”¶é›†<code>dep.depend()</code> å’Œæ´¾å‘æ›´æ–° <code>dep.notify()</code></p><h2 id="ä¾èµ–æ”¶é›†"><a href="#ä¾èµ–æ”¶é›†" class="headerlink" title="ä¾èµ–æ”¶é›†"></a>ä¾èµ–æ”¶é›†</h2><p>é€šè¿‡å“åº”å¼å¯¹è±¡æˆ‘ä»¬çŸ¥é“åœ¨ defineReactive å‡½æ•°å†…çš„ Object.defineProperty å®šä¹‰çš„ get å†…éƒ¨å®ä¾‹äº† Dep</p><h3 id="dep"><a href="#dep" class="headerlink" title="dep"></a>dep<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å‰æ–‡è¯´è¿‡ Dep æ˜¯æ•´ä¸ª getter ä¾èµ–æ”¶é›†çš„æ ¸å¿ƒï¼Œæ‰“å¼€æ–‡ä»¶åœ¨ <code>src/core/observer/dep.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">/** * A dep is an observable that can have multiple * directives subscribing to it. */</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> target<span class="token punctuation">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">;</span>  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>  subs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Watcher<span class="token operator">></span><span class="token punctuation">;</span>  constructor <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span>  addSub <span class="token punctuation">(</span>sub<span class="token punctuation">:</span> Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  removeSub <span class="token punctuation">(</span>sub<span class="token punctuation">:</span> Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  depend <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  notify <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// stabilize the subscriber list first</span>    <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// subs aren't sorted in scheduler if not running async</span>      <span class="token comment" spellcheck="true">// we need to sort them now to make sure they fire in correct</span>      <span class="token comment" spellcheck="true">// order</span>      subs<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// the current target watcher being evaluated.</span><span class="token comment" spellcheck="true">// this is globally unique because there could be only one</span><span class="token comment" spellcheck="true">// watcher being evaluated at any time.</span>Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">export</span> <span class="token keyword">function</span> pushTarget <span class="token punctuation">(</span>_target<span class="token punctuation">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> _target<span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> popTarget <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="watcher"><a href="#watcher" class="headerlink" title="watcher"></a>watcher<hr></h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Dep ä¸­ä¸»è¦å°±æ˜¯å¯¹ Watcher çš„ä¸€ç§ç®¡ç†ï¼Œå…¶ä¸­ <code>subs: Array&lt;Watcher&gt;;</code> å°±æ˜¯è®¢é˜…è€…åˆ—è¡¨,åœ¨Watcher ä¸­è¿›è¡Œå®šä¹‰</p><p>æŸ¥çœ‹ <code>src/core/observer/watcher.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span><span class="token comment" spellcheck="true">/** * A watcher parses an expression, collects dependencies, * and fires callback when the expression value changes. * This is used for both the $watch() api and directives. */</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">;</span>  expression<span class="token punctuation">:</span> string<span class="token punctuation">;</span>  cb<span class="token punctuation">:</span> Function<span class="token punctuation">;</span>  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>  deep<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  user<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  computed<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  sync<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  dirty<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  active<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  dep<span class="token punctuation">:</span> Dep<span class="token punctuation">;</span>  deps<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Dep<span class="token operator">></span><span class="token punctuation">;</span>  newDeps<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Dep<span class="token operator">></span><span class="token punctuation">;</span>  depIds<span class="token punctuation">:</span> SimpleSet<span class="token punctuation">;</span>  newDepIds<span class="token punctuation">:</span> SimpleSet<span class="token punctuation">;</span>  before<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">;</span>  getter<span class="token punctuation">:</span> Function<span class="token punctuation">;</span>  value<span class="token punctuation">:</span> any<span class="token punctuation">;</span>  constructor <span class="token punctuation">(</span>    vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>    expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>    cb<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>    options<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>    isRenderWatcher<span class="token operator">?</span><span class="token punctuation">:</span> boolean  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token punctuation">}</span>    vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// options</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>deep      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>user      <span class="token keyword">this</span><span class="token punctuation">.</span>computed <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>computed      <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>sync      <span class="token keyword">this</span><span class="token punctuation">.</span>before <span class="token operator">=</span> options<span class="token punctuation">.</span>before    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>uid <span class="token comment" spellcheck="true">// uid for batching</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed <span class="token comment" spellcheck="true">// for computed watchers</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span>      <span class="token operator">?</span> expOrFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token comment" spellcheck="true">// parse expression for getter</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`Failed watching path: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expOrFn<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" `</span></span> <span class="token operator">+</span>          <span class="token string">'Watcher only accepts simple dot-delimited paths. '</span> <span class="token operator">+</span>          <span class="token string">'For full control, use a function instead.'</span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> undefined      <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Evaluate the getter, and re-collect dependencies.   */</span>  <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> value    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm    <span class="token keyword">try</span> <span class="token punctuation">{</span>      value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`getter for watcher "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> e      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// "touch" every property so they are all tracked as</span>      <span class="token comment" spellcheck="true">// dependencies for deep watching</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> value  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Add a dependency to this directive.   */</span>  addDep <span class="token punctuation">(</span>dep<span class="token punctuation">:</span> Dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Clean up for dependency collection.   */</span>  cleanupDeps <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        dep<span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depIds    <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> tmp    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> tmp    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¾èµ–æ”¶é›†è¿‡ç¨‹"><a href="#ä¾èµ–æ”¶é›†è¿‡ç¨‹" class="headerlink" title="ä¾èµ–æ”¶é›†è¿‡ç¨‹"></a>ä¾èµ–æ”¶é›†è¿‡ç¨‹<hr></h3><p>å½“æˆ‘ä»¬åœ¨ mount è¿‡ç¨‹ä¸­è°ƒç”¨ mountComponent å‡½æ•°çš„æ—¶å€™å®ä¾‹åŒ–äº† <code>new Watcher</code>, ç„¶åæ‰§è¡Œäº† <code>this.get()</code> æ–¹æ³•<br>è¿›å…¥ get å‡½æ•° ä¼šæ‰§è¡Œ <code>pushTarget(this)</code></p><p>æ‰“å¼€æ–‡ä»¶ <code>src/core/observer/dep.js</code> </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> pushTarget <span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>  targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>pushTarget ä¸»è¦ä¸¤ä¸ªä½œç”¨ </p><ul><li>æŠŠ Dep.target èµ‹å€¼ä¸ºå½“å‰çš„ Watcher</li><li>å°† target è¿›è¡Œå‹æ ˆæ“ä½œ</li></ul><p>æ¥ç€æ‰§è¡Œ</p><pre class="line-numbers language-js"><code class="language-js">value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>this.getter å¯¹åº”å°±æ˜¯ updateComponent å‡½æ•°ï¼Œè¿™å®é™…ä¸Šå°±æ˜¯åœ¨æ‰§è¡Œï¼š</p><pre class="line-numbers language-js"><code class="language-js">vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®ƒä¼šå…ˆæ‰§è¡Œ vm._render() æ–¹æ³•ï¼Œç”Ÿæˆæ¸²æŸ“ VNodeï¼Œè®¿é—® vm ä¸Šçš„æ•°æ®ï¼Œè¿™æ ·å°±è§¦å‘äº†æ•°æ®å¯¹è±¡çš„ getterã€‚<br>æ¯ä¸ªgetter ä¸Šéƒ½æœ‰ä¸€ä¸ª dep ï¼Œè¿™æ ·å°±æ˜¯è°ƒç”¨ dep.depend() è¿›è¡Œä¾èµ–æ”¶é›†</p><pre class="line-numbers language-js"><code class="language-js">addDep <span class="token punctuation">(</span>dep<span class="token punctuation">:</span> Dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¿è¯æ·»åŠ çš„æ•°æ®çš„å”¯ä¸€æ€§ åæ‰§è¡Œ <code>dep.addSub(this)</code></p><p>ä¹Ÿå°±æ˜¯æ‰§è¡Œäº†<code>this.subs.push(sub)</code></p><p>é€šè¿‡ä¸Šé¢çš„æ‰§è¡Œé¡ºåºï¼Œå½“å‰çš„ watcher å·²ç»è®¢é˜…åˆ°äº†æ•°æ® dep çš„ subs æ•°ç»„ä¸­ï¼Œå½“æ•°æ®æ”¾ç”Ÿæ”¹å˜åœ¨è¿›è¡Œ dep.notify</p><p>æ¥ä¸‹æ¥æ‰§è¡Œé€’å½’å»è®¿é—® valueï¼Œè§¦å‘å®ƒæ‰€æœ‰å­é¡¹çš„ getter</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¹‹åæ‰§è¡Œ popTarget(),æ‰“å¼€æ–‡ä»¶ <code>src/core/observer/dep.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> popTarget <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">[</span>targetStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªæ—¶å€™ vm çš„æ•°æ®ä¾èµ–æ”¶é›†å·²ç»å®Œæˆéœ€è¦å°† Dep.target æ”¹å˜æˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼Œå®Œæˆ  Dep.target æ¸²æŸ“ï¼Œæœ€åæ‰§è¡Œ<code>this.cleanupDeps()</code> è¿›è¡Œä¾èµ–æ¸…ç©º</p><pre class="line-numbers language-js"><code class="language-js">cleanupDeps <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      dep<span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depIds  <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds  <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> tmp  <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps  <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps  <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> tmp  <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æ‰§è¡Œ cleanupDeps å‡½æ•°ï¼Œé¦–å…ˆéå† depsï¼Œç§»é™¤å¯¹ dep.subs æ•°ç»„ä¸­ Wathcer çš„è®¢é˜…ï¼ŒæŠŠ newDepIds å’Œ depIds äº¤æ¢ï¼ŒnewDeps å’Œ deps äº¤æ¢ï¼Œå¹¶æŠŠ newDepIds å’Œ newDeps æ¸…ç©ºï¼Œå› ä¸º newDeps æ˜¯æ–°æ·»åŠ çš„ Dep å®ä¾‹æ•°ç»„ï¼Œè€Œ deps è¡¨ç¤ºä¸Šä¸€æ¬¡æ·»åŠ çš„ Dep å®ä¾‹æ•°ç»„ï¼Œæ‰€ä»¥æ¯æ¬¡è®¢é˜…ï¼Œåœ¨subs ä¸­éƒ½æ˜¯æœ€æ–°çš„ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•´ä¸ªä¾èµ–æ”¶é›†</p><h2 id="æ´¾å‘æ›´æ–°"><a href="#æ´¾å‘æ›´æ–°" class="headerlink" title="æ´¾å‘æ›´æ–°"></a>æ´¾å‘æ›´æ–°</h2><p>é€šè¿‡ sub è¿™ä¸ªæ•°ç»„ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ›´æ–° sub æ•°ç»„ è¿›è¡Œæ´¾å‘æ›´æ–°ï¼Œä¸‹é¢åœ¨è¿›è¡Œä»£ç åˆ†æè¿™ä¸ªè¿‡ç¨‹</p><h3 id="setter-é€»è¾‘"><a href="#setter-é€»è¾‘" class="headerlink" title="setter é€»è¾‘"></a>setter é€»è¾‘<hr></h3><p>é€šè¿‡ <code>defineReactive</code> å‡½æ•°ä¸­ï¼Œå®šä¹‰å“åº”å¼çš„ setter è°ƒç”¨äº† <code>dep.notify()</code> æ¥é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…ï¼Œæˆ‘ä»¬è¦æ›´æ–°äº†ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> defineReactive <span class="token punctuation">(</span>  obj<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  val<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  customSetter<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>  shallow<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// cater for pre-defined getter/setters</span>  <span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span><span class="token keyword">get</span>  <span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span><span class="token keyword">set</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>getter <span class="token operator">||</span> setter<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> reactiveSetter <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">:</span> val      <span class="token comment" spellcheck="true">/* eslint-disable no-self-compare */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/* eslint-enable no-self-compare */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        setter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        val <span class="token operator">=</span> newVal      <span class="token punctuation">}</span>      childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ´¾å‘æ›´æ–°è¿‡ç¨‹"><a href="#æ´¾å‘æ›´æ–°è¿‡ç¨‹" class="headerlink" title="æ´¾å‘æ›´æ–°è¿‡ç¨‹"></a>æ´¾å‘æ›´æ–°è¿‡ç¨‹<hr></h3><p>å½“æˆ‘ä»¬ä¿®æ”¹äº†æ•°æ®ï¼Œè§¦å‘äº† setter ï¼Œè°ƒç”¨ <code>dep.notify()</code> ,éå†æ‰€æœ‰ subsï¼Œè°ƒç”¨ watcher çš„ update æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/core/observer/dep.js</span><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  notify <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// stabilize the subscriber list first</span>    <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/core/observer/watcher.js</span><span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  update <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// A computed property watcher has two modes: lazy and activated.</span>      <span class="token comment" spellcheck="true">// It initializes as lazy by default, and only becomes activated when</span>      <span class="token comment" spellcheck="true">// it is depended on by at least one subscriber, which is typically</span>      <span class="token comment" spellcheck="true">// another computed property or a component's render function.</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">.</span>subs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// In lazy mode, we don't want to perform computations until necessary,</span>        <span class="token comment" spellcheck="true">// so we simply mark the watcher as dirty. The actual computation is</span>        <span class="token comment" spellcheck="true">// performed just-in-time in this.evaluate() when the computed property</span>        <span class="token comment" spellcheck="true">// is accessed.</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// In activated mode, we want to proactively perform the computation</span>        <span class="token comment" spellcheck="true">// but only notify our subscribers when the value has indeed changed.</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAndInvoke</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿›è¡Œ update çš„æ—¶å€™ä¼šæ ¹æ®ä¸åŒåœºæ™¯å»æ´¾å‘æ›´æ–°ï¼Œcomputed ä¸ sync æˆ‘ä»¬æ”¾åœ¨åé¢æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªçŠ¶æ€ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è®¡ç®—å±æ€§ï¼ˆcomputedï¼‰å’Œä¾¦å¬å±æ€§ï¼ˆwatchï¼‰ï¼Œå…ˆçœ‹ä¸€ä¸‹ queueWatcher </p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/core/observer/scheduler.js</span><span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">let</span> has<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> number<span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">let</span> waiting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token keyword">let</span> flushing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token comment" spellcheck="true">/** * Push a watcher into the watcher queue. * Jobs with duplicate IDs will be skipped unless it's * pushed when the queue is being flushed. */</span><span class="token keyword">export</span> <span class="token keyword">function</span> queueWatcher <span class="token punctuation">(</span>watcher<span class="token punctuation">:</span> Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id  <span class="token keyword">if</span> <span class="token punctuation">(</span>has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushing<span class="token punctuation">)</span> <span class="token punctuation">{</span>      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// if already flushing, splice the watcher based on its id</span>      <span class="token comment" spellcheck="true">// if already past its id, it will be run next immediately.</span>      <span class="token keyword">let</span> i <span class="token operator">=</span> queue<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">></span> index <span class="token operator">&amp;&amp;</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">></span> watcher<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        i<span class="token operator">--</span>      <span class="token punctuation">}</span>      queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> watcher<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// queue the flush</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waiting<span class="token punctuation">)</span> <span class="token punctuation">{</span>      waiting <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token function">nextTick</span><span class="token punctuation">(</span>flushSchedulerQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”¨ has ä¿è¯åœ¨åŒä¸€ä¸ª watcher åªæ·»åŠ ä¸€æ¬¡ï¼Œå¹¶ä¸”åœ¨æ´¾å‘æ›´æ–°çš„æ—¶å€™æ¯æ¬¡æ•°æ®æ”¹å˜å¹¶ä¸ä¼šéƒ½è§¦å‘ watcher ï¼Œè€Œæ˜¯æŠŠwatcheræ·»åŠ åˆ°é˜Ÿåˆ—é‡Œé¢é€šè¿‡æ‰§è¡Œ nextTickï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹ <code>flushSchedulerQueue</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/core/observer/scheduler.js</span><span class="token keyword">let</span> flushing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token comment" spellcheck="true">/** * Flush both queues and run the watchers. */</span><span class="token keyword">function</span> flushSchedulerQueue <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  flushing <span class="token operator">=</span> <span class="token boolean">true</span>  <span class="token keyword">let</span> watcher<span class="token punctuation">,</span> id  <span class="token comment" spellcheck="true">// Sort queue before flush.</span>  <span class="token comment" spellcheck="true">// This ensures that:</span>  <span class="token comment" spellcheck="true">// 1. Components are updated from parent to child. (because parent is always</span>  <span class="token comment" spellcheck="true">//    created before the child)</span>  <span class="token comment" spellcheck="true">// 2. A component's user watchers are run before its render watcher (because</span>  <span class="token comment" spellcheck="true">//    user watchers are created before the render watcher)</span>  <span class="token comment" spellcheck="true">// 3. If a component is destroyed during a parent component's watcher run,</span>  <span class="token comment" spellcheck="true">//    its watchers can be skipped.</span>  queue<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// do not cache length because more watchers might be pushed</span>  <span class="token comment" spellcheck="true">// as we run existing watchers</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    watcher <span class="token operator">=</span> queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>      watcher<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>    watcher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// in dev build, check and stop circular updates.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">></span> MAX_UPDATE_COUNT<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token string">'You may have an infinite update loop '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>            watcher<span class="token punctuation">.</span>user              <span class="token operator">?</span> <span class="token template-string"><span class="token string">`in watcher with expression "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span>              <span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`in a component render function.`</span></span>          <span class="token punctuation">)</span><span class="token punctuation">,</span>          watcher<span class="token punctuation">.</span>vm        <span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// keep copies of post queues before resetting state</span>  <span class="token keyword">const</span> activatedQueue <span class="token operator">=</span> activatedChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> updatedQueue <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">resetSchedulerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// call component updated and activated hooks</span>  <span class="token function">callActivatedHooks</span><span class="token punctuation">(</span>activatedQueue<span class="token punctuation">)</span>  <span class="token function">callUpdatedHooks</span><span class="token punctuation">(</span>updatedQueue<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// devtool hook</span>  <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>devtools <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>devtools<span class="token punctuation">)</span> <span class="token punctuation">{</span>    devtools<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'flush'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆæ‰§è¡Œå¯¹é˜Ÿåˆ—åšäº†ä»å°åˆ°å¤§çš„æ’åº</p><ol><li><p>ç»„ä»¶çš„æ›´æ–°ç”±çˆ¶åˆ°å­ï¼›å› ä¸ºçˆ¶ç»„ä»¶çš„åˆ›å»ºè¿‡ç¨‹æ˜¯å…ˆäºå­çš„ï¼Œæ‰€ä»¥ watcher çš„åˆ›å»ºä¹Ÿæ˜¯å…ˆçˆ¶åå­ï¼Œæ‰§è¡Œé¡ºåºä¹Ÿåº”è¯¥ä¿æŒå…ˆçˆ¶åå­ã€‚</p></li><li><p>ç”¨æˆ·çš„è‡ªå®šä¹‰ watcher è¦ä¼˜å…ˆäºæ¸²æŸ“ watcher æ‰§è¡Œï¼›å› ä¸ºç”¨æˆ·è‡ªå®šä¹‰ watcher æ˜¯åœ¨æ¸²æŸ“ watcher ä¹‹å‰åˆ›å»ºçš„ã€‚</p></li><li><p>å¦‚æœä¸€ä¸ªç»„ä»¶åœ¨çˆ¶ç»„ä»¶çš„ watcher æ‰§è¡ŒæœŸé—´è¢«é”€æ¯ï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„ watcher æ‰§è¡Œéƒ½å¯ä»¥è¢«è·³è¿‡ï¼Œæ‰€ä»¥çˆ¶ç»„ä»¶çš„ watcher åº”è¯¥å…ˆæ‰§è¡Œã€‚</p></li></ol><p>å…¶æ¬¡è¿›è¡Œé˜Ÿåˆ—éå†</p><p>æ‹¿åˆ°å¯¹åº”çš„ watcherï¼Œæ‰§è¡Œ watcher.run()ã€‚å¦‚æœåœ¨éå†çš„æ—¶å€™ï¼Œç”¨æˆ·æœ‰å†æ·»åŠ æ–°çš„ watcher åŠ¨ä½œï¼Œ é‚£ä¹ˆå°±åœ¨é˜Ÿåˆ—ä¸­ä»åå¾€å‰æ‰¾ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ²¡æœ‰æ’å…¥çš„ watcher çš„ id æ¯”å½“å‰é˜Ÿåˆ—ä¸­ watcher çš„ id çš„å¤§çš„ä½ç½®ï¼Œæ”¾åˆ°é˜Ÿåˆ—ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> queueWatcher <span class="token punctuation">(</span>watcher<span class="token punctuation">:</span> Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id  <span class="token keyword">if</span> <span class="token punctuation">(</span>has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushing<span class="token punctuation">)</span> <span class="token punctuation">{</span>      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// if already flushing, splice the watcher based on its id</span>      <span class="token comment" spellcheck="true">// if already past its id, it will be run next immediately.</span>      <span class="token keyword">let</span> i <span class="token operator">=</span> queue<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">></span> index <span class="token operator">&amp;&amp;</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">></span> watcher<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        i<span class="token operator">--</span>      <span class="token punctuation">}</span>      queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> watcher<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ ·åœ¨æ‰§è¡Œ <code>watcher.run()</code> æ—¶å€™ï¼Œé€šè¿‡ <code>this.get()</code> å°±èƒ½å¾—åˆ° watcher å½“å‰çš„å€¼ï¼Œç„¶åé€šè¿‡åˆ¤æ–­ æ–°æ—§å€¼ä¸ç­‰ã€æ–°å€¼æ˜¯å¯¹è±¡ç±»å‹ã€deep æ¨¡å¼ä¸­çš„ä»»ä½•ä¸€ä¸ªæ¡ä»¶æˆç«‹éƒ½ä¼šè§¦å‘ watcher å›è°ƒï¼Œä¼ å…¥æ–°çš„ value å’Œ æ—§çš„ valueï¼Œè¿™æ ·æˆ‘ä»¬åœ¨æˆ‘ä»¬è‡ªå®šä¹‰ watcher çš„æ—¶å€™å°±å¯ä»¥åœ¨å›è°ƒå‡½æ•°ä¸­æ‹¿åˆ°ä¸¤ä¸ªå€¼ã€‚</p><p>å½“æˆ‘ä»¬æ•°æ®å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œè§¦å‘setter ï¼Œå› ä¸º watcher æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé€šè¿‡è°ƒåº¦è¿›è¡Œäº†ä¼˜åŒ– åœ¨ nextTick åæ‰§è¡Œæ‰€æœ‰ <code>watcher</code> çš„ run ç„¶åè§¦å‘æ‰€æœ‰ watcher çš„ update è¿›è¡Œè¿›è¡Œ patch</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“ "></a>æ€»ç»“ <hr></h3><img src="/images/vue-dep.png"><p>é€šè¿‡ä¸Šé¢å‡ ä¸ªæ¨¡å—çš„åˆ†ææˆ‘ä»¬åŸºæœ¬çŸ¥é“äº† vue çš„å“åº”å¼è¿‡ç¨‹ï¼Œåœ¨ç”Ÿæˆå“åº”å¯¹è±¡çš„æ—¶å€™éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œvue æ›´æ–°å¯¹è±¡æ•°ç»„å¿…é¡»ç”¨ä»–çš„å…¨å±€æ–¹æ³•ä¹Ÿå°±æ˜¯ <code>vue.set,vue.get,vue.del</code> ç­‰ï¼Œå¦åˆ™æ˜¯ä¸ä¼šè§¦å‘setterï¼Œå¯¼è‡´è§†å›¾æ›´æ–°å¤±è´¥ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue åŸç†è§£æä¹‹ä¸»çº¿æµç¨‹</title>
      <link href="/2019/08/27/vue/vueprinciple/"/>
      <url>/2019/08/27/vue/vueprinciple/</url>
      
        <content type="html"><![CDATA[<div align="middle">  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=436394160&auto=1&height=66">  </iframe></div><h2 id="æºç æ¶æ„"><a href="#æºç æ¶æ„" class="headerlink" title="æºç æ¶æ„"></a>æºç æ¶æ„</h2><p>vue ä¸€ç›´ä»¥ç®€å•ï¼Œå¿«é€Ÿè‘—ç§°ï¼Œä¹Ÿè‡ªç§°ä¸ºæ¸è¿›å¼æ¡†æ¶ä»Šå¤©æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹vueçš„æºç ï¼Œè¿™æ ·æˆ‘ä»¬ä¹Ÿèƒ½äº†è§£å…¶ä¸­çš„æ€æƒ³ï¼Œå¸®åŠ©æˆ‘ä»¬åœ¨å·¥ä½œä¸­å¾ˆå¥½çš„åº”ç”¨å’Œè§£å†³é—®é¢˜ã€‚å½“ç„¶æˆ‘ä»¬å¹¶ä¸å¯èƒ½æŠŠæºç å¾ˆç»†è‡´çš„åˆ†æä¸ªéï¼Œé‚£æ ·æ²¡ä»€ä¹ˆæ„ä¹‰ã€‚<br>é™„ä¸Š git ä»“åº“<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vueæºç </a>åœ°å€ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ vue æºç çš„æ ¸å¿ƒç›®å½•æ–¹ä¾¿å¤§å®¶å»å¯¹åº”æŸ¥æ‰¾</p><pre class="line-numbers language-md"><code class="language-md">srcâ”œâ”€â”€ compiler/        # æ¨¡ç‰ˆç¼–è¯‘ç›®å½• â”œâ”€â”€ core/            # æ ¸å¿ƒä»£ç  â”œâ”€â”€ platforms/       # è·¨å¹³å°çš„æ”¯æŒâ”œâ”€â”€ server/          # å¤„ç†æœåŠ¡ç«¯æ¸²æŸ“â”œâ”€â”€ sfc/             # .vue æ–‡ä»¶çš„è§£æâ”œâ”€â”€ shared/          # å…¨å±€ç”¨åˆ°çš„å·¥å…·å‡½æ•°<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="compiler"><a href="#compiler" class="headerlink" title="compiler"></a>compiler<hr></h3><p>vue æ‰€æœ‰ç¼–è¯‘ç›¸å…³çš„ä»£ç ã€‚åŒ…æ‹¬æŠŠæ¨¡ç‰ˆè§£ææˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰,ç¼–è¯‘ã€ç”Ÿæˆç­‰åŠŸèƒ½</p><h3 id="core"><a href="#core" class="headerlink" title="core"></a>core<hr></h3><p>vue æ ¸å¿ƒä»£ç ï¼ŒåŒ…æ‹¬å†…ç½®ç»„ä»¶ï¼ŒæŒ‡ä»¤ã€å…¨å±€APIã€Observerã€è™šæ‹ŸDOMã€å…¨å±€å·¥å…·å‡½æ•°ç­‰ï¼Œè¿™ä¸ªç›®å½•ä¹Ÿæ˜¯vueçš„çµé­‚ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬é‡ç‚¹å…³æ³¨åˆ†æçš„åœ°æ–¹ï¼Œcompiler ä¼šåœ¨åç»­æ–‡ç« ä¸­åˆ†æ</p><h3 id="platform"><a href="#platform" class="headerlink" title="platform"></a>platform<hr></h3><p>æœ€åˆ vue æ˜¯è·‘åœ¨ web ä¸Šçš„mvvmæ¶æ„, åæœŸå¢åŠ äº† é˜¿é‡Œå›¢é˜Ÿçš„ weex å…¥å£ï¼Œé…åˆ weex ä¹Ÿå¯ä»¥è¿è¡Œåœ¨ native å®¢æˆ·ç«¯ä¸Š</p><h3 id="server"><a href="#server" class="headerlink" title="server "></a>server <hr></h3><p>æœåŠ¡ç«¯æ¸²æŸ“å…¥å£ï¼Œè¿™æ˜¯æ˜¯vue2.0 ä¹‹åæ›´æ–°çš„åŠŸèƒ½ï¼Œæ‰€è°“çš„æœåŠ¡ç«¯æ¸²æŸ“æ˜¯æŠŠç›¸å¯¹åº”çš„ç»„ä»¶æ¸²æŸ“ä¸ºæœåŠ¡ç«¯çš„ html å­—ç¬¦ä¸²ï¼Œç„¶åå‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¿›è¡Œå¤„ç†ã€‚è¿™æ ·åšèƒ½æé«˜å®¢æˆ·ä½“éªŒ</p><h3 id="sfc"><a href="#sfc" class="headerlink" title="sfc"></a>sfc<hr></h3><p>å°† .vue æ–‡ä»¶å†…å®¹è§£ææˆJavaScriptçš„å¯¹è±¡</p><h2 id="æºç æ„å»º"><a href="#æºç æ„å»º" class="headerlink" title="æºç æ„å»º"></a>æºç æ„å»º</h2><p>vue æºç æ˜¯åŸºäº <a href="https://rollupjs.org/guide/en/" target="_blank" rel="noopener">Rollup </a>æ„å»ºçš„ï¼Œæ„å»ºçš„é…ç½®åœ¨ scripts ç›®å½•ä¸‹</p><pre class="line-numbers language-md"><code class="language-md">scriptsâ”œâ”€â”€ git-hook/           # git-hooké…ç½®æ–‡ä»¶â”œâ”€â”€ alias               # æ··å…¥æ–‡ä»¶ç›®å½•åˆ«åé…ç½®â”œâ”€â”€ build               # æ„å»ºçš„å…¥å£æ–‡ä»¶â”œâ”€â”€ config              # æ„å»ºå…¨å±€é…ç½®æ–‡ä»¶â”œâ”€â”€ feature-flags       # weex ç¯å¢ƒ flagâ”œâ”€â”€ gen-release-note    # ç”Ÿæˆ Change logâ”œâ”€â”€ get-weex-version    # ç”Ÿæˆ weexBaseVersionâ”œâ”€â”€ release-weex        # weexå‘å¸ƒçš„è„šæœ¬â”œâ”€â”€ release             # å‘å¸ƒè„šæœ¬â”œâ”€â”€ verify-commit-msg   # æ£€æŸ¥ Commit message æ˜¯å¦ç¬¦åˆæ ¼å¼<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ„å»ºè„šæœ¬"><a href="#æ„å»ºè„šæœ¬" class="headerlink" title="æ„å»ºè„šæœ¬"></a>æ„å»ºè„šæœ¬<hr></h3><p>åŸºäº npm æ‰˜ç®¡çš„é¡¹ç›®éƒ½ä¼šæœ‰ä¸€ä¸ª package.json æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å½“ä¸­çš„ script æè¿°ç¬¦ä¸­ä¸€èˆ¬é…ç½®çš„åŸºæœ¬éƒ½æ˜¯å¯åŠ¨é¡¹ç›®ã€æ‰“åŒ…ã€æµ‹è¯•ç­‰ç›¸å…³å‘½ä»¤, çœ‹ä¸€ä¸‹ vue é¡¹ç›®æ ¹ç›®å½•çš„ package.json,ç”±äºåªåš build ç¯å¢ƒä¸­çš„åˆ†æï¼Œæ‰€ä»¥æˆ‘ä»¬å»æ‰ devã€testç­‰æ‰§è¡Œå‘½ä»¤</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node scripts/build.js"</span><span class="token punctuation">,</span>    <span class="token property">"build:ssr"</span><span class="token operator">:</span> <span class="token string">"npm run build -- web-runtime-cjs,web-server-renderer"</span><span class="token punctuation">,</span>    <span class="token property">"build:weex"</span><span class="token operator">:</span> <span class="token string">"npm run build -- weex"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢ä¸‰ä¸ªå‘½ä»¤åœ¨æ‰§è¡Œçš„æ—¶å€™é€šè¿‡ç¯å¢ƒå‚æ•°æ¥åŒºåˆ†ä¸åŒçš„å¹³å°ï¼Œå½“æ‰§è¡Œ <code>npm run build</code> å‘½ä»¤çš„æ—¶å€™å°±ä¼šæ‰§è¡Œ <code>node scripts/build.js</code> è¿™ä¸ªæ–‡ä»¶</p><h3 id="æ„å»ºè¿‡ç¨‹"><a href="#æ„å»ºè¿‡ç¨‹" class="headerlink" title="æ„å»ºè¿‡ç¨‹"></a>æ„å»ºè¿‡ç¨‹<hr></h3><p>æ¥ä¸‹æ¥æ¥æŸ¥çœ‹ä¸€ä¸‹ <code>node scripts/build.js</code> è¿™ä¸ªæ–‡ä»¶çœ‹çœ‹æ‰§è¡Œè¿‡ç¨‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> builds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllBuilds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// filter builds via command line arg</span><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> filters <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>  builds <span class="token operator">=</span> builds<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>b <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> filters<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>f <span class="token operator">=</span><span class="token operator">></span> b<span class="token punctuation">.</span>output<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> b<span class="token punctuation">.</span>_name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// filter out weex builds by default</span>  builds <span class="token operator">=</span> builds<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>b <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> b<span class="token punctuation">.</span>output<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'weex'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token function">build</span><span class="token punctuation">(</span>builds<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ç‰‡æ®µäº†è§£åˆ°ä¸»è¦å¼•ç”¨äº† <code>./config</code> getAllBuilds æ–‡ä»¶ä¸‹é¢çš„æ–¹æ³•ï¼Œè¿›å…¥è¿™ä¸ªæ–‡ä»¶</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> builds <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">const</span> aliases <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./alias'</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> resolve <span class="token operator">=</span> p <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> base <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>aliases<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// Runtime only (CommonJS). Used by bundlers e.g. Webpack &amp; Browserify</span>  <span class="token string">'web-runtime-cjs-prod'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    dest<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.runtime.common.prod.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    format<span class="token punctuation">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>    env<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>    banner  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// runtime-only production build (Browser)</span>  <span class="token string">'web-runtime-prod'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    dest<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.runtime.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    format<span class="token punctuation">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>    env<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>    banner  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// Runtime+compiler CommonJS build (CommonJS)</span>  <span class="token string">'web-full-prod'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    dest<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    format<span class="token punctuation">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>    env<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>    alias<span class="token punctuation">:</span> <span class="token punctuation">{</span> he<span class="token punctuation">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    banner  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token keyword">function</span> genConfig <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> opts <span class="token operator">=</span> builds<span class="token punctuation">[</span>name<span class="token punctuation">]</span>  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>    input<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>entry<span class="token punctuation">,</span>    external<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>external<span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token function">flow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">alias</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> aliases<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>alias<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>plugins <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>      file<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>dest<span class="token punctuation">,</span>      format<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>format<span class="token punctuation">,</span>      banner<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>banner<span class="token punctuation">,</span>      name<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>moduleName <span class="token operator">||</span> <span class="token string">'Vue'</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'_name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    enumerable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    value<span class="token punctuation">:</span> name  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> config<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡è¿™é‡Œçš„ä»£ç ç‰‡é¢å¤§æ¦‚äº†è§£åˆ° vue é€šè¿‡å½“å‰webã€æœåŠ¡ç«¯æ¸²æŸ“ã€webpackæ’ä»¶ã€weexç­‰é…ç½®æ¥è¿›è¡Œæ‰“åŒ…ï¼Œæ¯ä¸€ä¸ªé…ç½®éƒ½éµå¾ª rollup çš„æ„å»ºè§„åˆ™</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"entry"</span><span class="token operator">:</span> <span class="token string">"æ„å»ºçš„å…¥å£æ–‡ä»¶"</span><span class="token punctuation">,</span>  <span class="token property">"dest"</span><span class="token operator">:</span> <span class="token string">"æ„å»ºåçš„æ–‡ä»¶åœ°å€"</span><span class="token punctuation">,</span>  <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"æ„å»ºè§„èŒƒ"</span><span class="token punctuation">,</span>  <span class="token property">"alias"</span><span class="token operator">:</span> <span class="token string">"åˆ«åè®¾ç½®"</span>   // ...<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‚£ä¹ˆåœ¨æ‰“åŒ…çš„è¿‡ç¨‹ä¸­è¿›è¡Œäº†è·¯å¾„åˆ«åè®¾ç½®ï¼Œé€šè¿‡åˆ«åè®¾ç½®èƒ½ä»£ç èƒ½å¤Ÿæ›´æ¸…æ™°æ•´æ´ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token keyword">const</span> resolve <span class="token operator">=</span> p <span class="token operator">=</span><span class="token operator">></span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  vue<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/platforms/web/entry-runtime-with-compiler'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  compiler<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/compiler'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  core<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/core'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  shared<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/shared'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  web<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/platforms/web'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  weex<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/platforms/weex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  server<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  sfc<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/sfc'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹åˆ°è¿™ä¸ªåˆ«åè®¾ç½®ï¼Œæˆ‘ä»¬å°±åº”è¯¥å¾ˆæ¸…æ¥š vue çš„æ ¸å¿ƒæ„å»ºæ–‡ä»¶éƒ½åœ¨ src ç›®å½•ï¼Œå…·ä½“ä½œç”¨åœ¨æ–‡ç« å¼€å¤´å°±å·²ç»ä»‹ç»è¿‡äº†ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸»è¦çœ‹ web åˆ«åä¸‹çš„ç›®å½•ï¼Œå…¶å®ƒçš„ç›®å½•æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸€ä¸‹å®ç°è§„åˆ™</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'core/index'</span><span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">'core/config'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> extend<span class="token punctuation">,</span> noop <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared/util'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> mountComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/instance/lifecycle'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> devtools<span class="token punctuation">,</span> inBrowser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/util/index'</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">import</span> <span class="token punctuation">{</span> patch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./patch'</span><span class="token keyword">import</span> platformDirectives <span class="token keyword">from</span> <span class="token string">'./directives/index'</span><span class="token keyword">import</span> platformComponents <span class="token keyword">from</span> <span class="token string">'./components/index'</span><span class="token comment" spellcheck="true">// install platform runtime directives &amp; components</span><span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> platformDirectives<span class="token punctuation">)</span><span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> platformComponents<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// install platform patch function</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__patch__ <span class="token operator">=</span> inBrowser <span class="token operator">?</span> patch <span class="token punctuation">:</span> noop<span class="token comment" spellcheck="true">// public mount method</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>  el<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">:</span> undefined  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»ˆäºçœ‹åˆ°äº† Vue æ„é€ å‡½æ•°å’Œæ ¸å¿ƒä»£ç çš„å…¥å£<code>core/index</code>ï¼Œå¹¶åœ¨æ„é€ å‡½æ•°å’ŒåŸå‹ä¸Šé¢æŒ‚è½½äº†ä¸€äº›æ–¹æ³•ï¼Œé€šè¿‡æ‰§è¡Œçš„ä¸Šè¿°æ„å»ºè¿‡ç¨‹æˆ‘ä»¬æ€»ç»“åˆ°</p><p>Vue.js çš„ç»„æˆæ˜¯ç”± core + å¯¹åº”çš„ â€˜å¹³å°â€™ è¡¥å……ä»£ç æ„æˆ(ç‹¬ç«‹æ„å»ºå’Œè¿è¡Œæ—¶æ„å»º åªæ˜¯ platforms ä¸‹ web å¹³å°çš„ä¸¤ç§é€‰æ‹©)</p><img src="/images/vue-init.png" width="50%"><h2 id="new-Vue"><a href="#new-Vue" class="headerlink" title="new Vue"></a>new Vue</h2><p>é€šè¿‡ vue çš„æ ¸å¿ƒç›®å½•ï¼Œæˆ‘ä»¬çŸ¥é“ Vue å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œä¸Šé¢æŒ‚æ»¡äº†å¤§å¤§å°å°çš„å„ç§æ–¹æ³•æˆ‘ä»¬åœ¨ç”¨çš„æ—¶å€™ä¼ ä¸€å®šçš„å‚æ•°å³å¯</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> <span class="token string">'xxxx'</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> xxxx<span class="token punctuation">,</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="initGlobalAPI"><a href="#initGlobalAPI" class="headerlink" title="initGlobalAPI"></a>initGlobalAPI<hr></h3><p>é‚£ä¹ˆåœ¨ vue å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæ‰“å¼€æ ¸å¿ƒä»£ç  <code>src/core</code> ç›®å½•ä¸‹é¢çš„ index</p><pre class="line-numbers language-js"><code class="language-js">src<span class="token operator">/</span>core<span class="token operator">/</span>index<span class="token punctuation">.</span>js<span class="token comment" spellcheck="true">// vueåˆå§‹åŒ–çš„æ ¸å¿ƒæ–‡ä»¶--åˆ›å»ºVueæ„é€ å‡½æ•°ï¼Œå°†æ„é€ å‡½æ•°ä¼ å…¥äº”ä¸ªæ–¹æ³•ä¸­</span><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'./instance/index'</span><span class="token comment" spellcheck="true">// åˆå§‹åŒ–å…¨å±€API</span><span class="token keyword">import</span> <span class="token punctuation">{</span> initGlobalAPI <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./global-api/index'</span><span class="token comment" spellcheck="true">// è·å¾—ä¸€äº›ç¯å¢ƒåˆ¤æ–­ï¼Œå’Œæ˜¯å¦æ˜¯æœåŠ¡ç«¯æ¸²æŸ“</span><span class="token keyword">import</span> <span class="token punctuation">{</span> isServerRendering <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/util/env'</span><span class="token comment" spellcheck="true">// ssr ç¯å¢ƒåŠ è½½æ­¤æ–¹æ³•</span><span class="token keyword">import</span> <span class="token punctuation">{</span> FunctionalRenderContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/vdom/create-functional-component'</span><span class="token comment" spellcheck="true">//åˆå§‹åŒ–å…¨å±€APIå˜é‡</span><span class="token function">initGlobalAPI</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//ä¸ºvueçš„åŸå‹å®šä¹‰$isServerå±æ€§</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$isServer'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  <span class="token keyword">get</span><span class="token punctuation">:</span> isServerRendering<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//ä¸ºvueçš„åŸå‹å®šä¹‰$ssrContext</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$ssrContext'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* istanbul ignore next */</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>ssrContext  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//ä¸ºvueåŸå‹å®šä¹‰å½“ä¸ºssrç¯å¢ƒæ—¶åŠ è½½FunctionalRenderContextæ–¹æ³•</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">,</span> <span class="token string">'FunctionalRenderContext'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> FunctionalRenderContext<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//æ·»åŠ ç‰ˆæœ¬å·</span>Vue<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">'__VERSION__'</span><span class="token keyword">export</span> <span class="token keyword">default</span> Vue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€»ç»“ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶åŠ è½½çš„æ–¹æ³•</p><pre class="line-numbers language-md"><code class="language-md">core/indexâ”œâ”€â”€ Vue            # åˆå§‹åŒ–æ„é€ å‡½æ•°â”œâ”€â”€ initGlobalAPI  # åˆå§‹åŒ–å…¨å±€APIâ”œâ”€â”€ $isServer      # åˆ¤æ–­ç¯å¢ƒçš„å·¥å…·å‡½æ•°â”œâ”€â”€ $ssrContext    # ssr ç¯å¢ƒåŠ è½½æ­¤æ–¹æ³•ä¹Ÿå¯ç”¨äºæ“ä½œçŠ¶æ€â”œâ”€â”€ FunctionalRenderContext  # ssr ç¯å¢ƒåŠ è½½æ­¤æ–¹æ³•â”œâ”€â”€ æ·»åŠ ç‰ˆæœ¬å·<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="new-Vue-1"><a href="#new-Vue-1" class="headerlink" title="new Vue "></a>new Vue <hr></h3><p>åˆå§‹åŒ–æ–‡ä»¶åï¼Œè¿›å…¥å¯¼å‡º Vue æ„é€ å‡½æ•°çš„æ–‡ä»¶ <code>src/core/instance/index.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Vue <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>    <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Vue</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Vue is a constructor and should be called with the `new` keyword'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº† Vue å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªç”¨ Function å®ç°çš„ç±»ï¼Œé€šè¿‡ new å…³é”®å­—åˆå§‹åŒ–ï¼Œç„¶åä¼šè°ƒç”¨ this._init æ–¹æ³•ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span> Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_init <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token comment" spellcheck="true">// a uid</span>    vm<span class="token punctuation">.</span>_uid <span class="token operator">=</span> uid<span class="token operator">++</span>    <span class="token keyword">let</span> startTag<span class="token punctuation">,</span> endTag    <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>      startTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-start:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>      endTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-end:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>      <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯Vueçš„å®ä¾‹ï¼Œåˆ™ä¸éœ€è¦è¢«observe</span>    vm<span class="token punctuation">.</span>_isVue <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token comment" spellcheck="true">// å¯¹å‚æ•°è¿›è¡Œ merge æ“ä½œ  </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// optimize internal component instantiation</span>      <span class="token comment" spellcheck="true">// since dynamic options merging is pretty slow, and none of the</span>      <span class="token comment" spellcheck="true">// internal component options needs special treatment.</span>      <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>        <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>        options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        vm      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// é€šè¿‡åˆ¤æ–­ Proxy ä¸º vueçš„å®ä¾‹å±æ€§èµ‹å€¼</span>    <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">initProxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_renderProxy <span class="token operator">=</span> vm    <span class="token punctuation">}</span>    vm<span class="token punctuation">.</span>_self <span class="token operator">=</span> vm    <span class="token comment" spellcheck="true">// åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸç›¸å…³</span>    <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// è¾“åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ç›¸å…³</span>    <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// åˆå§‹åŒ–ç¼–è¯‘render</span>    <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨beforeCreateé’©å­å‡½æ•°å¹¶ä¸”è§¦å‘beforeCreateé’©å­äº‹ä»¶</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>    <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// åˆå§‹åŒ–propsã€methodsã€dataã€computedä¸watch</span>    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨createdé’©å­å‡½æ•°å¹¶ä¸”è§¦å‘createdé’©å­äº‹ä»¶</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// æ ¼å¼åŒ–ç»„ä»¶å</span>      vm<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token function">formatComponentName</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>      <span class="token function">mark</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>      <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> init`</span></span><span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æŒ‚è½½ç»„ä»¶æ–¹æ³•è§¦å‘ç»„ä»¶çš„DOMæ¸²æŸ“</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç çš„æ³¨é‡Šäº†è§£åˆ° Vue åˆå§‹åŒ–ä¸»è¦å°±å¹²äº†å‡ ä»¶äº‹æƒ…ï¼Œåˆå¹¶é…ç½®æ“ä½œï¼Œåˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸï¼Œåˆå§‹åŒ–äº‹ä»¶ç›‘å¬ï¼Œåˆå§‹åŒ–renderï¼Œåˆå§‹åŒ– dataã€propsã€computedã€watcher ç­‰ï¼Œåœ¨æœ€åè°ƒç”¨vm.$mount æ–¹æ³•æŒ‚è½½ vm ï¼ŒæŠŠæ¨¡ç‰ˆæ¸²æŸ“æˆDOMã€‚å½“ç„¶è¿™é‡Œé¢è¿˜æœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦çŸ¥é“ä¾‹å¦‚ä¸Šé¢åˆå§‹åŒ–åˆå¹¶é…ç½®ï¼Œç”Ÿå‘½å‘¨æœŸåˆå§‹åŒ–ç­‰ï¼Œä¼šåœ¨åé¢æ¸…æ¥šçš„æ¢³ç† vue æ•´ç†æµç¨‹ä¹‹åï¼Œè¿›å…¥ç»†èŠ‚</p><h2 id="vm-mount"><a href="#vm-mount" class="headerlink" title="vm.$mount"></a>vm.$mount</h2><p>é€šè¿‡ $mount å®ä¾‹æ–¹æ³•å»æŒ‚è½½ vm ï¼Œä½† $mount æ–¹æ³•æ˜¯ç”±äºå¤šå¹³å°ç¼–è¯‘å¤„ç†ä¸å¤ªä¸€æ ·ï¼Œæ‰€ä»¥åœ¨å¤šä¸ªæ–‡ä»¶ä¸­å®šä¹‰ã€‚æˆ‘ä»¬è¿›å…¥ <code>src/platform</code> è¿™ä¸ªç›®å½•å¯ä»¥è§‚å¯Ÿåˆ°æœ‰ web å’Œ weex ç›®å½•ï¼Œæˆ‘ä»¬ç›´æ¥æŠ›æ‰ weexï¼Œåªåˆ†æ web ç›®å½•ï¼Œåœ¨ vue å®˜ç½‘æ•™ç¨‹ä¸­ä»‹ç»äº†vueçš„å®Œæ•´ç‰ˆ<code>web/entry-runtime-with-compiler.js</code>å’Œruntimeç‰ˆæœ¬<code>web/runtime/index.js</code></p><p>å®Œæ•´ç‰ˆ</p><ul><li>åŒ…å«ç¼–è¯‘å’Œè¿è¡Œæ˜¯çš„ç‰ˆæœ¬</li><li>htmlå­—ç¬¦ä¸² â†’ renderå‡½æ•° â†’ vnode â†’ çœŸå®domèŠ‚ç‚¹</li></ul><p>runtimeç‰ˆæœ¬</p><ul><li>åˆ›å»º Vue å®ä¾‹ã€renderã€æ›´æ–° DOM ç­‰çš„æ“ä½œçš„ä»£ç ï¼Œæ²¡æœ‰ç¼–è¯‘å™¨ç¼–è¯‘æ¨¡ç‰ˆå­—ç¬¦ä¸²ä»£ç </li><li>renderå‡½æ•° â†’ vnode â†’ çœŸå®domèŠ‚ç‚¹</li></ul><h3 id="å®Œæ•´ç‰ˆ-mount"><a href="#å®Œæ•´ç‰ˆ-mount" class="headerlink" title="å®Œæ•´ç‰ˆ $mount"></a>å®Œæ•´ç‰ˆ $mount<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">const</span> mount <span class="token operator">=</span> Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mountVue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>  el<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">===</span> document<span class="token punctuation">.</span>body <span class="token operator">||</span> el <span class="token operator">===</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>      <span class="token template-string"><span class="token string">`Do not mount Vue to &lt;html> or &lt;body> - mount to normal elements instead.`</span></span>    <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">this</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options  <span class="token comment" spellcheck="true">// resolve template/el and convert to render function</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> template <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          template <span class="token operator">=</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">warn</span><span class="token punctuation">(</span>              <span class="token template-string"><span class="token string">`Template element not found or is empty: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>              <span class="token keyword">this</span>            <span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>        template <span class="token operator">=</span> template<span class="token punctuation">.</span>innerHTML      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'invalid template option:'</span> <span class="token operator">+</span> template<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">this</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>      template <span class="token operator">=</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>        outputSourceRange<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">,</span>        shouldDecodeNewlines<span class="token punctuation">,</span>        shouldDecodeNewlinesForHref<span class="token punctuation">,</span>        delimiters<span class="token punctuation">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>        comments<span class="token punctuation">:</span> options<span class="token punctuation">.</span>comments      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>      options<span class="token punctuation">.</span>render <span class="token operator">=</span> render      options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns      <span class="token comment" spellcheck="true">// ..</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> mount<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢ä»£ç é€»è¾‘å¾ˆæ¸…æ™°ï¼Œå°†æ‰§è¡Œä»¥ä¸‹è¿‡ç¨‹</p><ul><li>é¦–å…ˆåœ¨åŸå‹ä¸Šå®šä¹‰äº† $mount è¿™ä¸ªæ–¹æ³•</li><li>å¯¹ä¼ å…¥çš„ el åšé™åˆ¶ä¸èƒ½å°†èŠ‚ç‚¹æŒ‚è½½åœ¨ body å’Œ html è¿™ç§è·ŸèŠ‚ç‚¹ä¸Š</li><li>å¦‚æœæ²¡æœ‰å®šä¹‰ render æ–¹æ³•ï¼Œåˆ™ä¼šæŠŠ el æˆ–è€… template å­—ç¬¦ä¸²è½¬æ¢æˆ render æ–¹æ³•</li><li>æ¨¡ç‰ˆæˆ–å­—ç¬¦ä¸²è½¬æ¢ render æ–¹æ³•ï¼ˆè°ƒç”¨ compileToFunctions è¿›è¡Œç¼–è¯‘è½¬æ¢ï¼‰</li></ul><h3 id="runtime-ç‰ˆæœ¬-mount"><a href="#runtime-ç‰ˆæœ¬-mount" class="headerlink" title="runtime ç‰ˆæœ¬ $mount"></a>runtime ç‰ˆæœ¬ $mount<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// public mount method</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>  el<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">:</span> undefined  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œè¿‡ç¨‹</p><ul><li>æŒ‚è½½çš„å…ƒç´ ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯DOMå¯¹è±¡ï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²é€šè¿‡ query æ–¹æ³•è½¬æ¢æˆDOM</li><li>æ‰§è¡Œ mountComponent å‡½æ•°ä¼ å…¥ä¸‰ä¸ªå‚æ•°</li></ul><p>é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºå¹¶æ²¡æœ‰ç»è¿‡ compileToFunctionsæ–¹æ³• è¿›è¡Œè½¬æ¢ç¼–è¯‘é˜¶æ®µï¼Œè€Œç›´æ¥æ˜¯ render â€“&gt; VNode è¿‡ç¨‹ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€æŸ¥çœ‹ mountComponentæ–¹æ³•è°ƒç”¨ï¼Œæ‰“å¼€æ–‡ä»¶<code>src/core/instance/lifecycle.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> mountComponent <span class="token punctuation">(</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  el<span class="token punctuation">:</span> <span class="token operator">?</span>Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render <span class="token operator">=</span> createEmptyVNode    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeMount'</span><span class="token punctuation">)</span>  <span class="token keyword">let</span> updateComponent  <span class="token comment" spellcheck="true">// ...</span>  updateComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// we set this to vm._watcher inside the watcher's constructor</span>  <span class="token comment" spellcheck="true">// since the watcher's initial patch may call $forceUpdate (e.g. inside child</span>  <span class="token comment" spellcheck="true">// component's mounted hook), which relies on vm._watcher being already defined</span>  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>    before <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* isRenderWatcher */</span><span class="token punctuation">)</span>  hydrating <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token comment" spellcheck="true">// manually mounted instance, call mounted on self</span>  <span class="token comment" spellcheck="true">// mounted is called for render-created child components in its inserted hook</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> vm<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç å¾ˆç›´è§‚çš„çœ‹è§ mountComponent æ–¹æ³•ä¸»è¦ä½œç”¨</p><ul><li>åˆ¤æ–­ render å‡½æ•°æ˜¯ä¸æ˜¯å­˜åœ¨å¦‚æœä¸å­˜åœ¨è°ƒç”¨åˆ›å»º createEmptyVNode æ–¹æ³•åˆ›å»ºä¸€ä¸ªç©ºVNodeèŠ‚ç‚¹</li><li>æ£€æµ‹å®Œ render å¼€å§‹æŒ‚è½½ beforeMount é’©å­</li><li>æ‰§è¡Œ new Watcheræ–¹æ³•()</li><li>_isMountedçŠ¶æ€è®¾ç½®trueï¼Œ å¼€å§‹æŒ‚è½½mounted</li></ul><p>Watcher åœ¨å®ƒçš„å›è°ƒå‡½æ•°ä¸­ä¼šè°ƒç”¨ updateComponent æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­è°ƒç”¨ vm._render æ–¹æ³•ç”Ÿæˆè™šæ‹Ÿ NodeèŠ‚ç‚¹ï¼Œæœ€åè°ƒç”¨ vm._update æ›´æ–° DOM</p><p>Watcher åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå½“ vm å®ä¾‹ä¸­çš„ç›‘æµ‹çš„æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¯´çš„è§‚å¯Ÿè€…è¿›è¡Œä¾èµ–æ”¶é›†çš„è¿‡ç¨‹,å½“ç„¶è¿™ä¹Ÿæ˜¯ vue æ ¸å¿ƒåŸç†çš„ä¸€éƒ¨åˆ†ã€‚new Watcheråˆ°åº•åšäº†ä»€ä¹ˆæˆ‘ä»¬åœ¨åé¢çš„å•ç‹¬æ•´ç†ï¼Œå…ˆä»¥ä¸»çº¿ç¨‹ä¸ºä¸»</p><h2 id="vm-render"><a href="#vm-render" class="headerlink" title="vm._render"></a>vm._render</h2><p>ä¸Šæ–‡ä¸­æåˆ° Watcher åœ¨å®ƒçš„å›è°ƒå‡½æ•°ä¸­ä¼šè°ƒç”¨ updateComponent æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­è°ƒç”¨ vm._render æ–¹æ³•ç”Ÿæˆè™šæ‹Ÿ NodeèŠ‚ç‚¹ï¼Œæœ€åè°ƒç”¨ vm._update æ›´æ–° DOMï¼Œé‚£ä¹ˆå°±å‡ºç° ç§æœ‰æ–¹æ³• vm._render å’Œ vm._update ä¸¤ä¸ªæœ€æ ¸å¿ƒçš„æ–¹æ³•ã€‚</p><p>_render å®šä¹‰åœ¨ <code>src/core/instance/render.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// ...</span>  Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_render <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> VNode <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> _parentVnode <span class="token punctuation">}</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options    <span class="token keyword">if</span> <span class="token punctuation">(</span>_parentVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$scopedSlots <span class="token operator">=</span> <span class="token function">normalizeScopedSlots</span><span class="token punctuation">(</span>        _parentVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>scopedSlots<span class="token punctuation">,</span>        vm<span class="token punctuation">.</span>$slots<span class="token punctuation">,</span>        vm<span class="token punctuation">.</span>$scopedSlots      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// set parent vnode. this allows render functions to have access</span>    <span class="token comment" spellcheck="true">// to the data on the placeholder node.</span>    vm<span class="token punctuation">.</span>$vnode <span class="token operator">=</span> _parentVnode    <span class="token comment" spellcheck="true">// render self</span>    <span class="token keyword">let</span> vnode    <span class="token keyword">try</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// There's no need to maintain a stack because all render fns are called</span>      <span class="token comment" spellcheck="true">// separately from one another. Nested component's render fns are called</span>      <span class="token comment" spellcheck="true">// when parent component is patched.</span>      currentRenderingInstance <span class="token operator">=</span> vm      vnode <span class="token operator">=</span> render<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`render`</span></span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// return error render result,</span>      <span class="token comment" spellcheck="true">// or previous vnode to prevent render error causing blank component</span>      <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>renderError<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>          vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>renderError<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">,</span> e<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`renderError`</span></span><span class="token punctuation">)</span>          vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>      currentRenderingInstance <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// if the returned array contains only a single node, allow it</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      vnode <span class="token operator">=</span> vnode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// return empty vnode in case the render function errored out</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>vnode <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token string">'Multiple root nodes returned from render function. Render function '</span> <span class="token operator">+</span>          <span class="token string">'should return a single root node.'</span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>      vnode <span class="token operator">=</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// set parent</span>    vnode<span class="token punctuation">.</span>parent <span class="token operator">=</span> _parentVnode    <span class="token keyword">return</span> vnode  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢è¿™æ®µä»£ç æœ€å…³é”®çš„åœ°æ–¹å°±æ˜¯è°ƒç”¨ render æ–¹æ³• <code>render.call(vm._renderProxy, vm.$createElement)</code>ï¼Œåœ¨ä¸Šé¢è¯´è¿‡åœ¨ mounted æ–¹æ³•ä¸­ä¼šæŠŠ template å’Œ string ç»è¿‡ compileToFunctions ç¼–è¯‘æœ€åå½¢æˆ renderæ–¹æ³•è¿›è¡Œæ¸²æŸ“ï¼Œä½†æ˜¯è¿™æ˜¯ç”¨å­—ç¬¦ä¸²æ¨¡ç‰ˆçš„å½¢å¼ï¼Œå¦‚æœç”¨å­—ç¬¦ä¸²æ¨¡æ¿çš„ä»£æ›¿æ–¹æ¡ˆ render æ–¹æ³•å‘¢</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  render<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>createElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>     attrs<span class="token punctuation">:</span> <span class="token punctuation">{</span>        id<span class="token punctuation">:</span> <span class="token string">'app'</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  renderError<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>createElement<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'pre'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token punctuation">:</span> <span class="token punctuation">{</span> color<span class="token punctuation">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºrender æ–¹æ³•çš„å‚æ•° createElement å®é™…ä¸Šå°±æ˜¯ vm.$createElement,ç„¶è€Œ vm.$createElement åœ¨åˆå§‹åŒ–ä¸­å°±å·²ç»æ‰§è¡Œè¿‡äº†</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> initRender <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  vm<span class="token punctuation">.</span>_c <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">createElement</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// normalization is always applied for the public version, used in</span>  <span class="token comment" spellcheck="true">// user-written render functions.</span>  vm<span class="token punctuation">.</span>$createElement <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">createElement</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// $attrs &amp; $listeners are exposed for easier HOC creation.</span>  <span class="token comment" spellcheck="true">// they need to be reactive so that HOCs using them are always updated</span>  <span class="token keyword">const</span> parentData <span class="token operator">=</span> parentVnode <span class="token operator">&amp;&amp;</span> parentVnode<span class="token punctuation">.</span>data  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥åœ¨ initRender æ–¹æ³•çš„æ—¶å€™ï¼Œé™¤äº† vm.$createElement æ–¹æ³•ï¼Œè¿˜æœ‰ä¸€ä¸ª vm._c æ–¹æ³•ï¼Œå®ƒæ˜¯è¢«æ¨¡æ¿ç¼–è¯‘æˆçš„ render å‡½æ•°ä½¿ç”¨ï¼Œä½† vm.$createElement æ˜¯æˆ‘ä»¬ç”¨åŸç”Ÿå†™çš„ render æ–¹æ³•ä½¿ç”¨çš„ï¼Œ è¿™ä¿©ä¸ªæ–¹æ³•æ”¯æŒçš„å‚æ•°ç›¸åŒï¼Œå¹¶ä¸”å†…éƒ¨éƒ½è°ƒç”¨äº† createElement æ–¹æ³•ã€‚</p><p>å®˜ç½‘ä¸­ä¸€å¥è¯è¯´çš„å¾ˆæ¸…æ¥š <strong>Vue é€‰é¡¹ä¸­çš„ render å‡½æ•°è‹¥å­˜åœ¨ï¼Œåˆ™ Vue æ„é€ å‡½æ•°ä¸ä¼šä» template é€‰é¡¹æˆ–é€šè¿‡ el é€‰é¡¹æŒ‡å®šçš„æŒ‚è½½å…ƒç´ ä¸­æå–å‡ºçš„ HTML æ¨¡æ¿ç¼–è¯‘æ¸²æŸ“å‡½æ•°ã€‚</strong></p><p>é€šè¿‡ä¸Šè¿°æ€»ç»“åˆ° render å‡½æ•°æœ€ç»ˆæ˜¯æ‰§è¡Œ createElement æ–¹æ³• è¿”å› vnode èŠ‚ç‚¹ï¼Œè¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿ node è€Œ vue2.0 çš„ å¦ä¸€ä¸ªæ ¸å¿ƒå°±æ˜¯åˆ©ç”¨äº†Virtual DOMï¼Œå®é™…ä¸Š Vue.js ä¸­ Virtual DOM æ˜¯å€Ÿé‰´äº†å¼€æºåº“ <a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener">snabbdom</a> çš„å®ç°ï¼Œç„¶ååŠ å…¥äº†ä¸€äº› Vue.js ç‰¹è‰²çš„ä¸œè¥¿, è¿™éƒ¨åˆ†æºç å°±åœ¨ <code>src/core/vdom/vnode.js</code> ä¸­æˆ‘ä»¬æš‚æ—¶ä¸å»æŸ¥çœ‹ï¼Œå¾…åç»­æ–‡ç« å†™åˆ° Virtual DOM çš„æ—¶å€™æˆ‘ä»¬åœ¨åšåˆ†æã€‚ </p><p>é‚£ä¹ˆåœ¨é¢è¯•ä¸­æˆ‘ä»¬ç»å¸¸è¢«é—®åˆ°æ˜¯ æ“ä½œ Virtual DOM å¿«è¿˜æ˜¯çœŸå® DOM å¿«</p><p>ç­”æ¡ˆæ˜¯ç›¸å¯¹çš„åœ¨æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹ï¼Œè‚¯å®šæ˜¯ Virtual DOM å¿«ï¼Œå› ä¸ºé€šè¿‡å¯¹æ¯” node å‡å°‘é¢‘ç¹çš„å»æ›´æ–°DOMï¼Œ å¦‚æœæ•°æ®é‡ç›¸å¯¹è¾ƒå°çš„æƒ…å†µè¿˜æ˜¯ç›´æ¥æ“ä½œ DOM è¾ƒå¿«ï¼Œå› ä¸ºå°‘äº†ç¼–è¯‘ã€éå†ã€å¯¹æ¯”çš„è¿‡ç¨‹</p><h2 id="vm-createElement"><a href="#vm-createElement" class="headerlink" title="vm.$createElement"></a>vm.$createElement</h2><p>ä¸Šé¢æ–‡ç« æåˆ° render çš„æ—¶å€™å†…éƒ¨è°ƒç”¨äº† createElement æ–¹æ³•ï¼Œåˆ›å»ºäº†vnodeï¼Œè¯¥æ–¹æ³•å®šä¹‰åœ¨ src/core/vdom/create-elemenet.js ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">function</span> _createElement <span class="token punctuation">(</span>  context<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  tag<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span> <span class="token operator">|</span> Function <span class="token operator">|</span> Object<span class="token punctuation">,</span>  data<span class="token operator">?</span><span class="token punctuation">:</span> VNodeData<span class="token punctuation">,</span>  children<span class="token operator">?</span><span class="token punctuation">:</span> any<span class="token punctuation">,</span>  normalizationType<span class="token operator">?</span><span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> VNode <span class="token operator">|</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">/**   * å¦‚æœå­˜åœ¨data.__ob__ï¼Œè¯´æ˜dataæ˜¯è¢«Observerè§‚å¯Ÿçš„æ•°æ®   * ä¸èƒ½ç”¨ä½œè™šæ‹ŸèŠ‚ç‚¹çš„data   * éœ€è¦æŠ›å‡ºè­¦å‘Šï¼Œå¹¶è¿”å›ä¸€ä¸ªç©ºèŠ‚ç‚¹   *   * è¢«ç›‘æ§çš„dataä¸èƒ½è¢«ç”¨ä½œvnodeæ¸²æŸ“çš„æ•°æ®çš„åŸå› æ˜¯ï¼š   * dataåœ¨vnodeæ¸²æŸ“è¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¢«æ”¹å˜ï¼Œè¿™æ ·ä¼šè§¦å‘ç›‘æ§ï¼Œå¯¼è‡´ä¸ç¬¦åˆé¢„æœŸçš„æ“ä½œ   */</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>      <span class="token template-string"><span class="token string">`Avoid using observed data object as vnode data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n`</span></span> <span class="token operator">+</span>      <span class="token string">'Always create fresh vnode data objects in each render!'</span><span class="token punctuation">,</span>      context    <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å½“é€šè¿‡ :is åŠ¨æ€è®¾ç½®ç»„ä»¶æ—¶</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    tag <span class="token operator">=</span> data<span class="token punctuation">.</span>is  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// in case of component :is set to falsy value</span>    <span class="token keyword">return</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// ä½œç”¨åŸŸæ’æ§½</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token keyword">typeof</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    data <span class="token operator">=</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    data<span class="token punctuation">.</span>scopedSlots <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>    children<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizationType <span class="token operator">===</span> ALWAYS_NORMALIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>    children <span class="token operator">=</span> <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizationType <span class="token operator">===</span> SIMPLE_NORMALIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>    children <span class="token operator">=</span> <span class="token function">simpleNormalizeChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> vnode<span class="token punctuation">,</span> ns  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> Ctor    ns <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>ns<span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">getTagNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// platform built-in elements</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>nativeOn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`The .native modifier for v-on is only valid on components but it was used on &lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">>.`</span></span><span class="token punctuation">,</span>          context        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>      vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>        config<span class="token punctuation">.</span><span class="token function">parsePlatformTagName</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span>        undefined<span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> context      <span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>Ctor <span class="token operator">=</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token string">'components'</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// component</span>      vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// unknown or unlisted namespaced elements</span>      <span class="token comment" spellcheck="true">// check at runtime because it may get assigned a namespace when its</span>      <span class="token comment" spellcheck="true">// parent normalizes children</span>      vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>        tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span>        undefined<span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> context      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// direct component options / constructor</span>    vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> vnode  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">applyNS</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> ns<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">registerDeepBindings</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token keyword">return</span> vnode  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬çœ‹åˆ° ä¸»è¦è°ƒç”¨äº†å‡ ä¸ªæ–¹æ³• createEmptyVNode å’Œ createComponentã€normalizeChildrenã€simpleNormalizeChildren</p><p>æˆ‘ä»¬ç®€å•çš„çœ‹ä¸€ä¸‹æ‰§è¡Œæ­¥éª¤</p><p>é¦–å…ˆåˆ¤æ–­äº† tag æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è°ƒç”¨ <code>src/core/vdom/vnode.js</code>ç›®å½•ä¸‹çš„ createEmptyVNode æ–¹æ³•åˆ›å»ºç©ºçš„ vnode èŠ‚ç‚¹</p><p>å¦‚æœä¼ é€’äº†childrenï¼Œç”±äºå…¶æ˜¯ä»»æ„ç±»å‹ï¼Œæ‰€ä»¥æ ¹æ® normalizationType å»è°ƒç”¨<code>src/core/vdom/helpers/normalzie-children.js</code> ç›®å½•ä¸‹çš„ normalizeChildren(children) å’Œ simpleNormalizeChildren(children) æ–¹æ³•è¿›è¡Œé€’å½’éå†ï¼ŒæŠŠæ•´ä¸ª children æ‰“å¹³ï¼Œè®©å®ƒå˜æˆæ·±åº¦åªæœ‰ä¸€å±‚çš„ vnode æ•°ç»„</p><p>æœ€åé€šè¿‡ å¯¹å‚æ•° tag çš„åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ™®é€šçš„ html æ ‡ç­¾ï¼Œåˆ™å®ä¾‹åŒ–ä¸€ä¸ªæ™®é€š vnode èŠ‚ç‚¹ï¼Œå¦åˆ™é€šè¿‡ <code>src/core/vdom/create-component.js</code>ç›®å½•ä¸‹çš„ createComponent æ–¹æ³•åˆ›å»ºä¸€ä¸ªç»„ä»¶çš„ vnode</p><p>å› ä¸ºé™¤äº†ç»„ä»¶çš„ vnode æ²¡æœ‰ childrenï¼Œå…¶ä»–é€šè¿‡ createElement åˆ›å»ºçš„æ¯ä¸ª vnode éƒ½æœ‰ childrenï¼Œchildren æ¯ä¸ªå…ƒç´ ä¹Ÿæ˜¯ä¸€ä¸ª vnodeï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ª vnode treeï¼Œè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“ vm._render é˜¶æ®µæ˜¯å¦‚ä½•åˆ›å»ºçš„ vnodeï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡ vm._updateï¼Œå°† vnode æ¸²æŸ“æˆçœŸå®çš„ domã€‚</p><h2 id="vm-update"><a href="#vm-update" class="headerlink" title="vm._update"></a>vm._update</h2><p>vm._update ä¹Ÿæ˜¯ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œä½œç”¨æ˜¯æŠŠ vnode æ¸²æŸ“æˆçœŸå®çš„ dom åœ¨ <code>src/core/instance/lifecycle.js</code> æ–‡ä»¶ä¸­å®šä¹‰</p><h3 id="update"><a href="#update" class="headerlink" title="_update "></a>_update <hr></h3><pre class="line-numbers language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// ...</span>  Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_update <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">:</span> VNode<span class="token punctuation">,</span> hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">const</span> prevEl <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el    <span class="token keyword">const</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode    <span class="token keyword">const</span> restoreActiveInstance <span class="token operator">=</span> <span class="token function">setActiveInstance</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    vm<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode    <span class="token comment" spellcheck="true">// Vue.prototype.__patch__ is injected in entry points</span>    <span class="token comment" spellcheck="true">// based on the rendering backend used.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// initial render</span>      vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* removeOnly */</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// updates</span>      vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">restoreActiveInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// update __vue__ reference</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevEl<span class="token punctuation">)</span> <span class="token punctuation">{</span>      prevEl<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> vm    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// if parent is an HOC, update its $el as well</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$vnode <span class="token operator">===</span> vm<span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// updated hook is called by the scheduler to ensure that children are</span>    <span class="token comment" spellcheck="true">// updated in a parent's updated hook.</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬çŸ¥é“ vm.<em>update çš„æ ¸å¿ƒå°±æ˜¯é€šè¿‡ vm.<strong>patch</strong>å‡½æ•°æ¥å®ç°å°† vnode è½¬æ¢æˆçœŸå®çš„ node èŠ‚ç‚¹ï¼Œè€Œ vm.<em>_patch</em></em> çš„å®ç°æ˜¯å¤šå¹³å°çš„æœ‰weexã€ssrã€inBrowserï¼Œæˆ‘ä»¬åªæŸ¥çœ‹åœ¨æµè§ˆå™¨ç¯å¢ƒå†…çš„å®ç°</p><p>åœ¨ <code>src/platforms/web/runtime/index.js</code> é€šè¿‡åˆ¤æ–­å¦‚æœæ˜¯æµè§ˆå™¨ç¯å¢ƒè°ƒç”¨ patchï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡</p><h3 id="patch"><a href="#patch" class="headerlink" title="patch "></a><strong>patch</strong> <hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// install platform patch function</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__patch__ <span class="token operator">=</span> inBrowser <span class="token operator">?</span> patch <span class="token punctuation">:</span> noop<span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡å¼•ç”¨æˆ‘ä»¬åˆ° <code>src/platforms/web/runtime/patch.js</code> ç›®å½•çœ‹åˆ°è°ƒç”¨äº† createPatchFunction æ–¹æ³•çš„è¿”å›å€¼</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> patch<span class="token punctuation">:</span> Function <span class="token operator">=</span> <span class="token function">createPatchFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nodeOps<span class="token punctuation">,</span> modules <span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="createPatchFunction"><a href="#createPatchFunction" class="headerlink" title="createPatchFunction "></a>createPatchFunction <hr></h3><p>åœ¨é€šè¿‡æŸ¥æ‰¾æ–‡ä»¶ <code>src/core/vdom/patch.js</code> ä¸­å®šä¹‰çš„ createPatchFunction æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">function</span> createPatchFunction <span class="token punctuation">(</span>backend<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> patch <span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å¦‚æœ vnode ä¸å­˜åœ¨ä½† oldVnode å­˜åœ¨ï¼Œè°ƒç”¨ invokeDestroyHook(oldVnode) æ¥è¿›è¡Œé”€æ¯æ—§èŠ‚ç‚¹</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">let</span> isInitialPatch <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">const</span> insertedVnodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment" spellcheck="true">// å¦‚æœoldVnodeä¸å­˜åœ¨ï¼Œvnodeå­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°èŠ‚ç‚¹  </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// empty mount (likely as component), create new root element</span>      isInitialPatch <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> isRealElement <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// å¦‚æœ oldVnode ä¸ vnode éƒ½å­˜åœ¨åˆ¤æ–­æ˜¯åŒä¸€èŠ‚ç‚¹è°ƒç”¨ patchVnode å¤„ç†å»æ¯”è¾ƒä¸¤ä¸ªèŠ‚ç‚¹çš„å·®å¼‚</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRealElement <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// patch existing root node</span>        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRealElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// å¦‚æœå­˜åœ¨çœŸå®çš„èŠ‚ç‚¹ï¼Œå­˜åœ¨data-server-renderedå±æ€§ï¼Œå°† hydrating å˜ä¸ºtrue</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> oldVnode<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span>SSR_ATTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            oldVnode<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>SSR_ATTR<span class="token punctuation">)</span>            hydrating <span class="token operator">=</span> <span class="token boolean">true</span>          <span class="token punctuation">}</span>          <span class="token comment" spellcheck="true">// ç”¨hydrateå‡½æ•°å°†è™šæ‹ŸDOMå’ŒçœŸå®DOMè¿›è¡Œæ˜ å°„</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>hydrating<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hydrate</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>              <span class="token keyword">return</span> oldVnode            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// ...</span>          <span class="token punctuation">}</span>          <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯server-rendered æˆ–è€…hydrationå¤±è´¥</span>          <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªç©ºVNodeï¼Œä»£æ›¿oldVnode</span>          oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å°†oldVnodeè®¾ç½®ä¸ºå¯¹åº”çš„è™šæ‹Ÿdomï¼Œæ‰¾åˆ°oldVnode.elmçš„çˆ¶èŠ‚ç‚¹</span>        <span class="token comment" spellcheck="true">// æ ¹æ®vnodeåˆ›å»ºä¸€ä¸ªçœŸå®domèŠ‚ç‚¹å¹¶æ’å…¥åˆ°è¯¥çˆ¶èŠ‚ç‚¹ä¸­oldVnode.elmçš„ä½ç½®</span>        <span class="token keyword">const</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm        <span class="token keyword">const</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>        <span class="token function">createElm</span><span class="token punctuation">(</span>          vnode<span class="token punctuation">,</span>          insertedVnodeQueue<span class="token punctuation">,</span>          oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> parentElm<span class="token punctuation">,</span>          nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>        <span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// é€’å½’æ›´æ–°çˆ¶çº§å ä½èŠ‚ç‚¹å…ƒç´ ï¼Œ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">let</span> ancestor <span class="token operator">=</span> vnode<span class="token punctuation">.</span>parent          <span class="token keyword">const</span> patchable <span class="token operator">=</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>          <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>              cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            ancestor<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm            <span class="token keyword">if</span> <span class="token punctuation">(</span>patchable<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> ancestor<span class="token punctuation">)</span>              <span class="token punctuation">}</span>              <span class="token comment" spellcheck="true">// #6513</span>              <span class="token comment" spellcheck="true">// invoke insert hooks that may have been merged by create hooks.</span>              <span class="token comment" spellcheck="true">// e.g. for directives that uses the "inserted" hook.</span>              <span class="token keyword">const</span> insert <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span>insert              <span class="token keyword">if</span> <span class="token punctuation">(</span>insert<span class="token punctuation">.</span>merged<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// start at index 1 to avoid re-invoking component mounted hook</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insert<span class="token punctuation">.</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  insert<span class="token punctuation">.</span>fns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>              <span class="token function">registerRef</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            ancestor <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>parent          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// é”€æ¯æ—§èŠ‚ç‚¹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> isInitialPatch<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// è¿”å›èŠ‚ç‚¹</span>    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çœ‹åˆ° patch æ–¹æ³•æœ¬èº«</p><p>æ¥æ”¶ 4ä¸ªå‚æ•°</p><ul><li>oldVnode è¡¨ç¤ºæ—§çš„ VNode èŠ‚ç‚¹æˆ–è€…æˆ–è€…æ˜¯ä¸€ä¸ª DOM å¯¹è±¡</li><li>vnode è¡¨ç¤ºæ‰§è¡Œ _render åè¿”å›çš„ VNode çš„èŠ‚ç‚¹</li><li>hydrating è¡¨ç¤ºæ˜¯å¦æ˜¯æœåŠ¡ç«¯æ¸²æŸ“</li><li>removeOnly æ˜¯ç»™ transition-group ç”¨çš„ï¼Œé˜²æ­¢åœ¨ updateChildren é˜¶æ®µï¼Œç§»åŠ¨ vnode èŠ‚ç‚¹</li></ul><p>å…³é”®è°ƒç”¨ä¸‰ä¸ªæ–¹æ³•</p><ul><li>createElm ä»¥å½“å‰æ—§èŠ‚ç‚¹ä¸ºå‚è€ƒèŠ‚ç‚¹ï¼Œåˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼Œæ‰§è¡Œç›¸å…³çš„ insert é’©å­å‡½æ•°ï¼Œå¹¶æ’å…¥åˆ° DOM ä¸­ï¼Œ</li><li>sameVnode é€šè¿‡å¯¹æ¯” key æ˜¯å¦ç›¸åŒã€tagã€æ³¨é‡Šã€dataæ˜¯å¦å­˜åœ¨ç­‰åˆ¤æ–­2ä¸ªèŠ‚ç‚¹ï¼Œæ˜¯å¦æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹</li><li>patchVnode vdom æ ¸å¿ƒæ›´æ–° node </li></ul><p>patchVode ä¸­çš„å‡ ä¸ªæ ¸å¿ƒæ–¹æ³• addVnodesã€ removeVnodesï¼ŒupdateChildrenï¼Œå…·ä½“æ˜¯æ€ä¹ˆå¢åŠ ã€åˆ é™¤ï¼Œæ›´æ–° vnode å’Œ dom èŠ‚ç‚¹çš„ï¼Œdom-diff æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¼šåœ¨åˆ†æå“åº”å¼åŸç†çš„æ—¶å€™å…·ä½“æŸ¥çœ‹ç»†èŠ‚</p><h3 id="ä¸»æµç¨‹æ€»ç»“"><a href="#ä¸»æµç¨‹æ€»ç»“" class="headerlink" title="ä¸»æµç¨‹æ€»ç»“"></a>ä¸»æµç¨‹æ€»ç»“<hr></h3><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€å¼ å›¾æ¥æ€»ç»“ vue ä¸»çº¿æµç¨‹</p><img src="/images/vue-process.png"><p>ä¸Šé¢çš„å›¾ä¸­èƒ½å¤Ÿç›´è§‚çš„çœ‹åˆ° vue ä¸»å¹²çš„æ‰§è¡Œæµç¨‹ï¼Œä½†æ˜¯ç¼ºå°‘æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯ vue çš„å“åº”å¼åŸç†ï¼Œä¸‹ç¯‡æ–‡ç« æˆ‘ä»¬ä¹Ÿæ˜¯é€šè¿‡æ–‡ä»¶çš„æ‰§è¡Œè¿‡ç¨‹æ¥åˆ†æ vue å“åº”å¼åŸç†çš„å®ç°</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>generator ä¸ async</title>
      <link href="/2019/08/26/javascript/generator-async/"/>
      <url>/2019/08/26/javascript/generator-async/</url>
      
        <content type="html"><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>åœ¨å‰ç«¯ä¸­å¼‚æ­¥ç¼–ç¨‹ä¸€ç›´æ˜¯å‰ç«¯å¼€å‘çš„ä¸€ä¸ªç—›ç‚¹ï¼Œå› ä¸º JavaScript è¯­æ³•çš„çµæ´»æ€§å’Œç‰¹æ®Šæ€§å¯¼è‡´å‰ç«¯å¼€å‘çš„å›°éš¾ï¼ˆå› ä¸º JavaScript æ˜¯å•çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰å¼‚æ­¥çš„ä¸–ç•Œå¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå°†æ— æ³•æ‰§è¡Œå¡æ­»æ“ä½œï¼‰</p><h3 id="ä»€ä¹ˆæ˜¯å¼‚æ­¥ç¼–ç¨‹"><a href="#ä»€ä¹ˆæ˜¯å¼‚æ­¥ç¼–ç¨‹" class="headerlink" title="ä»€ä¹ˆæ˜¯å¼‚æ­¥ç¼–ç¨‹"></a>ä»€ä¹ˆæ˜¯å¼‚æ­¥ç¼–ç¨‹</h3><p>æ‰€è°“â€å¼‚æ­¥â€ï¼Œä¸€ä¸ªä»»åŠ¡ä¸æ˜¯è¿ç»­å®Œæˆçš„ï¼Œå…ˆæ‰§è¡Œç¬¬ä¸€æ®µï¼Œç„¶åæ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œç­‰åšå¥½äº†å‡†å¤‡ï¼Œå›è¿‡å¤´æ‰§è¡Œç¬¬äºŒæ®µ</p><p>æ‰€è°“â€åŒæ­¥â€ï¼Œå°±æ˜¯ä¸é—´æ–­çš„è¿ç»­æ‰§è¡Œä¸€ä¸ªä»»åŠ¡</p><h3 id="å¼‚æ­¥ç¼–ç¨‹ç¤ºä¾‹"><a href="#å¼‚æ­¥ç¼–ç¨‹ç¤ºä¾‹" class="headerlink" title="å¼‚æ­¥ç¼–ç¨‹ç¤ºä¾‹"></a>å¼‚æ­¥ç¼–ç¨‹ç¤ºä¾‹</h3><p>æˆ‘ä»¬ç†Ÿæ‚‰çš„å¼‚æ­¥ç¼–ç¨‹æœ‰å¾ˆå¤šç§ä¾‹å¦‚ <code>ä»£ç çš„æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—</code>,<code>setTimeout</code>, <code>setInterval</code>, <code>callback</code>, <code>promise</code> ç­‰</p><p>å›è°ƒå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Fun</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>  callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>å†ä¾‹å¦‚æ•°ç»„çš„æ“ä½œæ–¹æ³•<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> i<span class="token operator">+</span><span class="token string">':'</span><span class="token operator">+</span>v<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Promise</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> readFile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-readfile-promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">readFile</span><span class="token punctuation">(</span>fileB<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Generatoræ¦‚å¿µ"><a href="#Generatoræ¦‚å¿µ" class="headerlink" title="Generatoræ¦‚å¿µ"></a>Generatoræ¦‚å¿µ</h3><p>ES6 æä¾›çš„ä¸€ç§å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆï¼Œæ‰§è¡Œ Generator å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒGenerator å‡½æ•°é™¤äº†çŠ¶æ€æœºï¼Œè¿˜æ˜¯ä¸€ä¸ªéå†å™¨å¯¹è±¡ç”Ÿæˆå‡½æ•°ã€‚è¿”å›çš„éå†å™¨å¯¹è±¡ï¼Œå¯ä»¥ä¾æ¬¡éå† Generator å‡½æ•°å†…éƒ¨çš„æ¯ä¸€ä¸ªçŠ¶æ€ã€‚</p><h3 id="Generatorç‰¹å¾"><a href="#Generatorç‰¹å¾" class="headerlink" title="Generatorç‰¹å¾"></a>Generatorç‰¹å¾</h3><ul><li>functionå…³é”®å­—ä¸å‡½æ•°åä¹‹é—´æœ‰ä¸€ä¸ªæ˜Ÿå·</li><li>å‡½æ•°ä½“å†…éƒ¨ä½¿ç”¨yieldè¡¨è¾¾å¼ï¼Œå®šä¹‰ä¸åŒçš„å†…éƒ¨çŠ¶æ€</li><li>æ‰§è¡Œå‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œåªæœ‰è°ƒç”¨äº†nextæ–¹æ³•æ‰ä¼šæ‰§è¡Œ</li><li>å¦‚æœå‡½æ•°å†…éƒ¨ä¸å†™ yield è¡¨è¾¾å¼ï¼Œåˆ™æ­¤å‡½æ•°å°±æ˜¯å•çº¯çš„æš‚ç¼“æ‰§è¡Œå‡½æ•°</li><li>æ¯æ¬¡è°ƒç”¨éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•ï¼Œè¿”å›valueå’Œdoneä¸¤ä¸ªå±æ€§çš„å¯¹è±¡</li><li>valueå±æ€§è¡¨ç¤ºå½“å‰çš„å†…éƒ¨çŠ¶æ€çš„å€¼ï¼Œæ˜¯yieldè¡¨è¾¾å¼åé¢é‚£ä¸ªè¡¨è¾¾å¼çš„å€¼</li><li>doneå±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦éå†ç»“æŸ</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">funGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">yield</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>  <span class="token keyword">yield</span> <span class="token string">'my name is renbo'</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token string">'ending'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> fun <span class="token operator">=</span> <span class="token function">funGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fun<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// { value: 'hello', done: false }</span>fun<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// { value: 'my name is renbo', done: false }</span>fun<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// { value: 'ending', done: true }</span>fun<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// { value: undefined, done: true }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ§åˆ¶æµç®¡ç†"><a href="#æ§åˆ¶æµç®¡ç†" class="headerlink" title="æ§åˆ¶æµç®¡ç†"></a>æ§åˆ¶æµç®¡ç†</h3><p>å›è°ƒ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">step1</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value1<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">step2</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">step3</span><span class="token punctuation">(</span>value2<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value3<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">step4</span><span class="token punctuation">(</span>value3<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value4<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Do something with value4</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>promise</p><pre class="line-numbers language-js"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>step1<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step2<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step3<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step4<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value4<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Do something with value4</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Handle any error from step1 through step4</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Generator</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">longRunningTask</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> value2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step1</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> value3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step2</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> value4 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step3</span><span class="token punctuation">(</span>value3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> value5 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step4</span><span class="token punctuation">(</span>value4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Do something with value4</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Handle any error from step1 through step4</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å•ä¸ªå¼‚æ­¥ä»»åŠ¡"><a href="#å•ä¸ªå¼‚æ­¥ä»»åŠ¡" class="headerlink" title="å•ä¸ªå¼‚æ­¥ä»»åŠ¡"></a>å•ä¸ªå¼‚æ­¥ä»»åŠ¡</h3><p>Generator + Promise</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// è°ƒç”¨</span><span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>result<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°çš„æ‰§è¡Œè¿‡ç¨‹è°ƒç”¨ gen ä¼šè¿”å›éå†å™¨ï¼Œç„¶åé€šè¿‡éå†å™¨çš„ next æ–¹æ³•è¿”å› fetch çš„ promise å®ä¾‹<code>{ value: Promise { &lt;pending&gt; }, done: false }</code>ï¼Œé€šè¿‡è°ƒç”¨ then æ–¹æ³•æ‰§è¡Œç»“æœ</p><h3 id="å¤šä¸ªå¼‚æ­¥ä»»åŠ¡"><a href="#å¤šä¸ªå¼‚æ­¥ä»»åŠ¡" class="headerlink" title="å¤šä¸ªå¼‚æ­¥ä»»åŠ¡"></a>å¤šä¸ªå¼‚æ­¥ä»»åŠ¡</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/repos'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r1<span class="token punctuation">.</span>bio<span class="token punctuation">,</span> r2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>login<span class="token punctuation">,</span> r3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>full_name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·å¾—æ‰§è¡Œç»“æœ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> result1 <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>result1<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ©ç”¨é€’å½’å°è£…ä¸Šè¿°æ‰§è¡Œç»“æœ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    result<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å¯åŠ¨å™¨å‡½æ•°-ï¼ˆGenerator-Promiseï¼‰"><a href="#å¯åŠ¨å™¨å‡½æ•°-ï¼ˆGenerator-Promiseï¼‰" class="headerlink" title="å¯åŠ¨å™¨å‡½æ•° ï¼ˆGenerator + Promiseï¼‰"></a>å¯åŠ¨å™¨å‡½æ•° ï¼ˆGenerator + Promiseï¼‰</h3><p>ç”±äº fetch æ–¹æ³•è¿”å› promise æœ‰ json æ–¹æ³•ï¼Œæ‰€ä»¥ä¸Šè¿°ä¾‹å­æˆç«‹ï¼Œå¦‚æœ yield ç›´æ¥ç»“åˆ promise å‡½æ•°é‚£ä¹ˆå°±ä¼šå˜æˆå¯åŠ¨å™¨å‡½æ•°ã€‚ç”±äº Generator ä¸èƒ½åƒæ™®é€šå‡½æ•°ä¸€æ ·è‡ªåŠ¨æ‰§è¡Œå’Œè‡ªå·±æš‚ç¼“æ‰§è¡Œçš„ç‰¹æ€§ï¼Œæ‰€ä»¥å¢åŠ è‡ªæ‰§è¡Œå¯åŠ¨å‡½æ•°ï¼Œè¿™ä¹Ÿæ˜¯ co æ¨¡å—çš„åˆè¡·ï¼ˆï¼‰</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> json1 <span class="token operator">=</span> <span class="token keyword">yield</span> r1<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> json2 <span class="token operator">=</span> <span class="token keyword">yield</span> r2<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/repos'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> json3 <span class="token operator">=</span> <span class="token keyword">yield</span> r3<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>json1<span class="token punctuation">.</span>bio<span class="token punctuation">,</span> json2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>login<span class="token punctuation">,</span> json3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>full_name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å¯åŠ¨å™¨å‡½æ•°-ï¼ˆGenerator-å›è°ƒï¼‰"><a href="#å¯åŠ¨å™¨å‡½æ•°-ï¼ˆGenerator-å›è°ƒï¼‰" class="headerlink" title="å¯åŠ¨å™¨å‡½æ•° ï¼ˆGenerator + å›è°ƒï¼‰"></a>å¯åŠ¨å™¨å‡½æ•° ï¼ˆGenerator + å›è°ƒï¼‰</h3><p>å›è°ƒå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">{</span>status<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> url<span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Generatorå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r1<span class="token punctuation">.</span>data<span class="token punctuation">,</span> r2<span class="token punctuation">.</span>data<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·å¾—ç»“æœ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> r1 <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>r1<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> r2 <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  r2<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>      g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ä»£ç æˆ‘ä»¬è§‚å¯Ÿåˆ°å›è°ƒå‡½æ•°ä¾ç„¶è§£å†³ä¸äº†å¤šä¸ª yield æ—¶ä»£ç ä¼šå¾ªç¯åµŒå¥—ã€‚è¿˜çš„å€ŸåŠ©é€’å½’</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><p>é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡º Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œéœ€è¦ä¸€ç§æœºåˆ¶ï¼Œå½“å¼‚æ­¥æ“ä½œæœ‰äº†ç»“æœï¼Œæ‰èƒ½è‡ªåŠ¨äº¤å›æ‰§è¡Œæƒ</p><ul><li>å›è°ƒå‡½æ•°ã€‚ å°†å¼‚æ­¥æ“ä½œè¿›è¡ŒåŒ…è£…ï¼Œæš´éœ²å‡ºå›è°ƒå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°é‡Œé¢äº¤å›æ‰§è¡Œæƒ</li><li>Promiseå¯¹è±¡ã€‚å°†å¼‚æ­¥æ“ä½œåŒ…è£…æˆ Promise å¯¹è±¡ï¼Œç”¨ then æ–¹æ³•äº¤å›æ‰§è¡Œæƒ</li></ul><p>ä¸Šé¢ä¸¤ç§æ–¹æ³•å†™äº†ä¸€ä¸ª run çš„å¯åŠ¨å™¨å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä¸¤ç§å°è£…åœ¨ä¸€èµ·ï¼Œè¿”å›äº†ä¸€ä¸ª Promiseï¼Œè·å¾— Generator å‡½æ•°çš„è¿”å›å€¼ï¼Œå¹¶ä¸”æ•è·é”™è¯¯</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> gen <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> gen <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¦‚æœ gen ä¸æ˜¯ä¸€ä¸ªè¿­ä»£å™¨</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gen <span class="token operator">||</span> <span class="token keyword">typeof</span> gen<span class="token punctuation">.</span>next <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span>        <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">function</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> ret<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                ret <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">next</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">function</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> ret<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                ret <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token keyword">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">next</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token function">toPromise</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token function">isPromise</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You may only yield a function, promise '</span> <span class="token operator">+</span>                <span class="token string">'but the following object was passed: "'</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">isPromise</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">'function'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">.</span>then<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">toPromise</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'function'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">thunkToPromise</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> obj<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">thunkToPromise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> run<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="co"><a href="#co" class="headerlink" title="co"></a>co</h3><p>co æ˜¯å¤§ç¥ TJ Holowaychuk äº 2013 å¹´ 6 æœˆå‘å¸ƒçš„ä¸€ä¸ªå°æ¨¡å—ï¼Œç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œã€‚</p><p>å¦‚æœç›´æ¥ä½¿ç”¨ co æ¨¡å—ï¼Œè¿™ä¸¤ç§ä¸åŒçš„ä¾‹å­å¯ä»¥ç®€å†™ä¸º</p><p>yield åæ˜¯ä¸€ä¸ª Promise</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json1 <span class="token operator">=</span> <span class="token keyword">yield</span> r1<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json2 <span class="token operator">=</span> <span class="token keyword">yield</span> r2<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/repos'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json3 <span class="token operator">=</span> <span class="token keyword">yield</span> r3<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>json1<span class="token punctuation">.</span>bio<span class="token punctuation">,</span> json2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>login<span class="token punctuation">,</span> json3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>full_name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">co</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yield åæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> url <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r1<span class="token punctuation">.</span>data<span class="token punctuation">,</span> r2<span class="token punctuation">.</span>data<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">co</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="async-æœ‰ç‚¹"><a href="#async-æœ‰ç‚¹" class="headerlink" title="async æœ‰ç‚¹"></a>async æœ‰ç‚¹</h3><p> async å‡½æ•°ï¼Œä½¿å¾—å¼‚æ­¥æ“ä½œå˜å¾—æ›´åŠ æ–¹ä¾¿,å®ƒä¹Ÿæ˜¯ Generator å‡½æ•°çš„è¯­æ³•ç³–ã€‚</p><p>å½“ä½¿ç”¨ Generator å‡½æ•°çš„æ—¶å€™</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json1 <span class="token operator">=</span> <span class="token keyword">yield</span> r1<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json1<span class="token punctuation">.</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">co</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ä½¿ç”¨ async æ—¶å€™</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> fetchData <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json1 <span class="token operator">=</span> <span class="token keyword">await</span> r1<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json1<span class="token punctuation">.</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢è§‚å¯Ÿåˆ°ä»£ç åŸºæœ¬ä¸€æ ·ï¼Œæ‰€ä»¥ async çš„åŸç†å°±æ˜¯å°† Generator å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œé¢</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ç­‰åŒäº</span><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>async å‡½æ•°è¿”å›ä¸€ä¸ª Promise å¯¹è±¡æ‰€ä»¥ä¹Ÿå¯ä»¥ç†è§£ä¸º async å‡½æ•°æ˜¯åŸºäº Promise å’Œ Generator çš„ä¸€å±‚å°è£…<br>éšæ„å¤„ç†åˆæ­¥æµç¨‹ async ä¼šæ¯”ä½¿ç”¨ Promise æ›´ä¼˜é›…</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token string">"done"</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token string">"done"</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>moreData<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">fetchAnotherData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>moreData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> moreData      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> data    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>moreData<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> moreData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchAnotherData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> moreData  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> data  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value1 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">fetchMoreData</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value2 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">fetchMoreData2</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> value1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> value2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchMoreData</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">fetchMoreData2</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="async-ç¼ºç‚¹"><a href="#async-ç¼ºç‚¹" class="headerlink" title="async ç¼ºç‚¹"></a>async ç¼ºç‚¹</h3><ul><li>ç”¨tryâ€¦catch å¤„ç†ä¸Šæ˜¯åŸæœ¬çš„ä¼˜é›…ä»£ç å˜å¾—ä¸å†ä¼˜é›…</li><li>è¯­æ³•çš„ç®€æ´è®©åŸæœ¬å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„å†…å®¹å˜æˆäº†é¡ºåºæ‰§è¡Œï¼Œä»è€Œå½±å“äº†æ€§èƒ½</li></ul><p>awaitç”±äºè¿”å› promise å¯¹è±¡ï¼Œæ‰€ä»¥ç»“æœå¯èƒ½æ˜¯rejectedï¼Œæ‰€ä»¥æœ€å¥½æŠŠawaitå‘½ä»¤æ”¾åœ¨tryâ€¦catchä»£ç å—ä¸­<br>ä½†æ˜¯å¦‚æœæƒ³æ•è· JSON.parse ä¸­çš„é”™è¯¯é‚£ä¹ˆå°±éœ€è¦å†æ·»åŠ ä¸€å±‚ tryâ€¦catch</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> data <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŸæœ¬æ²¡æœ‰ä¾èµ–å…³ç³»çš„ä¸¤ä¸ªå‡½æ•°ï¼Œå´åªèƒ½ç­‰å¾… getList è¿”å›æ‰èƒ½æ‰§è¡Œ getAnotherListï¼Œå¯¼è‡´è¯·æ±‚æ—¶é—´å¤šäº†ä¸€å€</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> getList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> getAnotherList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å°†ä¸Šé¢çš„å‡½æ•°æ”¹ä¸ºå¦‚ä¸‹å‡½æ•°å¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> listPromise <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> anotherListPromise <span class="token operator">=</span> <span class="token function">getAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">await</span> listPromise<span class="token punctuation">;</span>  <span class="token keyword">await</span> anotherListPromise<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ Promse.all</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¹¶å‘æ‰§è¡Œ async å‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> listPromise <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">await</span> <span class="token function">submit</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> anotherListPromise <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">await</span> <span class="token function">submit</span><span class="token punctuation">(</span>anotherListData<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// æ–¹æ³•ä¸€</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> handleListPromise <span class="token operator">=</span> <span class="token function">handleList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> handleAnotherListPromise <span class="token operator">=</span> <span class="token function">handleAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">await</span> handleListPromise  <span class="token keyword">await</span> handleAnotherListPromise<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// æ–¹æ³•äºŒ</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">handleList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">handleAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>global.d.ts</title>
      <link href="/2019/08/15/typescript/global.d.ts/"/>
      <url>/2019/08/15/typescript/global.d.ts/</url>
      
        <content type="html"><![CDATA[<pre><code>// Type definitions for [~THE LIBRARY NAME~] [~OPTIONAL VERSION NUMBER~]// Project: [~THE PROJECT NAME~]// Definitions by: [~YOUR NAME~] &lt;[~A URL FOR YOU~]&gt;/*~ If this library is callable (e.g. can be invoked as myLib(3)), *~ include those call signatures here. *~ Otherwise, delete this section. */declare function myLib(a: string): string;declare function myLib(a: number): number;/*~ If you want the name of this library to be a valid type name, *~ you can do so here. *~ *~ For example, this allows us to write &#39;var x: myLib&#39;; *~ Be sure this actually makes sense! If it doesn&#39;t, just *~ delete this declaration and add types inside the namespace below. */interface myLib {    name: string;    length: number;    extras?: string[];}/*~ If your library has properties exposed on a global variable, *~ place them here. *~ You should also place types (interfaces and type alias) here. */declare namespace myLib {    //~ We can write &#39;myLib.timeout = 50;&#39;    let timeout: number;    //~ We can access &#39;myLib.version&#39;, but not change it    const version: string;    //~ There&#39;s some class we can create via &#39;let c = new myLib.Cat(42)&#39;    //~ Or reference e.g. &#39;function f(c: myLib.Cat) { ... }    class Cat {        constructor(n: number);        //~ We can read &#39;c.age&#39; from a &#39;Cat&#39; instance        readonly age: number;        //~ We can invoke &#39;c.purr()&#39; from a &#39;Cat&#39; instance        purr(): void;    }    //~ We can declare a variable as    //~   &#39;var s: myLib.CatSettings = { weight: 5, name: &quot;Maru&quot; };&#39;    interface CatSettings {        weight: number;        name: string;        tailLength?: number;    }    //~ We can write &#39;const v: myLib.VetID = 42;&#39;    //~  or &#39;const v: myLib.VetID = &quot;bob&quot;;&#39;    type VetID = string | number;    //~ We can invoke &#39;myLib.checkCat(c)&#39; or &#39;myLib.checkCat(c, v);&#39;    function checkCat(c: Cat, s?: VetID);}</code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>function.d.ts</title>
      <link href="/2019/08/15/typescript/module-function.d.ts/"/>
      <url>/2019/08/15/typescript/module-function.d.ts/</url>
      
        <content type="html"><![CDATA[<p>// Type definitions for [<del>THE LIBRARY NAME</del>] [<del>OPTIONAL VERSION NUMBER</del>]<br>// Project: [<del>THE PROJECT NAME</del>]<br>// Definitions by: [<del>YOUR NAME</del>] &lt;[<del>A URL FOR YOU</del>]&gt;</p><p>/*~ This is the module template file for function modules.<br> *~ You should rename it to index.d.ts and place it in a folder with the same name as the module.<br> *~ For example, if you were writing a file for â€œsuper-greeterâ€, this<br> *~ file should be â€˜super-greeter/index.d.tsâ€™<br> */</p><p>/*~ Note that ES6 modules cannot directly export callable functions.<br> *~ This file should be imported using the CommonJS-style:<br> *~   import x = require(â€˜someLibraryâ€™);<br> *~<br> *~ Refer to the documentation to understand common<br> *~ workarounds for this limitation of ES6 modules.<br> */</p><p>/*~ If this module is a UMD module that exposes a global variable â€˜myFuncLibâ€™ when<br> *~ loaded outside a module loader environment, declare that global here.<br> *~ Otherwise, delete this declaration.<br> */<br>export as namespace myFuncLib;</p><p>/*~ This declaration specifies that the function<br> *~ is the exported object from the file<br> */<br>export = MyFunction;</p><p>/*~ This example shows how to have multiple overloads for your function */<br>declare function MyFunction(name: string): MyFunction.NamedReturnType;<br>declare function MyFunction(length: number): MyFunction.LengthReturnType;</p><p>/*~ If you want to expose types from your module as well, you can<br> *~ place them in this block. Often you will want to describe the<br> *~ shape of the return type of the function; that type should<br> *~ be declared in here, as this example shows.<br> */<br>declare namespace MyFunction {<br>    export interface LengthReturnType {<br>        width: number;<br>        height: number;<br>    }<br>    export interface NamedReturnType {<br>        firstName: string;<br>        lastName: string;<br>    }</p><pre><code>/*~ If the module also has properties, declare them here. For example, *~ this declaration says that this code is legal: *~   import f = require(&#39;myFuncLibrary&#39;); *~   console.log(f.defaultName); */export const defaultName: string;export let defaultLength: number;</code></pre><p>}</p>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>class.d.ts</title>
      <link href="/2019/08/15/typescript/module-class.d.ts/"/>
      <url>/2019/08/15/typescript/module-class.d.ts/</url>
      
        <content type="html"><![CDATA[<p>// Type definitions for [<del>THE LIBRARY NAME</del>] [<del>OPTIONAL VERSION NUMBER</del>]<br>// Project: [<del>THE PROJECT NAME</del>]<br>// Definitions by: [<del>YOUR NAME</del>] &lt;[<del>A URL FOR YOU</del>]&gt;</p><p>/*~ This is the module template file for class modules.<br> *~ You should rename it to index.d.ts and place it in a folder with the same name as the module.<br> *~ For example, if you were writing a file for â€œsuper-greeterâ€, this<br> *~ file should be â€˜super-greeter/index.d.tsâ€™<br> */</p><p>/*~ Note that ES6 modules cannot directly export class objects.<br> *~ This file should be imported using the CommonJS-style:<br> *~   import x = require(â€˜someLibraryâ€™);<br> *~<br> *~ Refer to the documentation to understand common<br> *~ workarounds for this limitation of ES6 modules.<br> */</p><p>/*~ If this module is a UMD module that exposes a global variable â€˜myClassLibâ€™ when<br> *~ loaded outside a module loader environment, declare that global here.<br> *~ Otherwise, delete this declaration.<br> */<br>export as namespace myClassLib;</p><p>/*~ This declaration specifies that the class constructor function<br> *~ is the exported object from the file<br> */<br>export = MyClass;</p><p>/*~ Write your moduleâ€™s methods and properties in this class */<br>declare class MyClass {<br>    constructor(someParam?: string);</p><pre><code>someProperty: string[];myMethod(opts: MyClass.MyClassMethodOptions): number;</code></pre><p>}</p><p>/*~ If you want to expose types from your module as well, you can<br> *~ place them in this block.<br> */<br>declare namespace MyClass {<br>    export interface MyClassMethodOptions {<br>        width?: number;<br>        height?: number;<br>    }<br>}</p>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>module.d.ts</title>
      <link href="/2019/08/15/typescript/module.d.ts/"/>
      <url>/2019/08/15/typescript/module.d.ts/</url>
      
        <content type="html"><![CDATA[<pre><code>// Type definitions for [~THE LIBRARY NAME~] [~OPTIONAL VERSION NUMBER~]// Project: [~THE PROJECT NAME~]// Definitions by: [~YOUR NAME~] &lt;[~A URL FOR YOU~]&gt;/*~ This is the module template file. You should rename it to index.d.ts *~ and place it in a folder with the same name as the module. *~ For example, if you were writing a file for &quot;super-greeter&quot;, this *~ file should be &#39;super-greeter/index.d.ts&#39; *//*~ If this module is a UMD module that exposes a global variable &#39;myLib&#39; when *~ loaded outside a module loader environment, declare that global here. *~ Otherwise, delete this declaration. */export as namespace myLib;/*~ If this module has methods, declare them as functions like so. */export function myMethod(a: string): string;export function myOtherMethod(a: number): number;/*~ You can declare types that are available via importing the module */export interface someType {    name: string;    length: number;    extras?: string[];}/*~ You can declare properties of the module using const, let, or var */export const myField: number;/*~ If there are types, properties, or methods inside dotted names *~ of the module, declare them inside a &#39;namespace&#39;. */export namespace subProp {    /*~ For example, given this definition, someone could write:     *~   import { subProp } from &#39;yourModule&#39;;     *~   subProp.foo();     *~ or     *~   import * as yourMod from &#39;yourModule&#39;;     *~   yourMod.subProp.foo();     */    export function foo(): void;}</code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TypeScriptç¼–è¯‘åŸç†</title>
      <link href="/2019/08/05/typescript/compilationprinciple/"/>
      <url>/2019/08/05/typescript/compilationprinciple/</url>
      
        <content type="html"><![CDATA[<p>TypeScript ç¼–è¯‘å™¨æºæ–‡ä»¶ä½äº <a href="https://github.com/Microsoft/TypeScript/tree/master/src/compiler" target="_blank" rel="noopener">src/compiler </a> ç›®å½•ä¸‹</p><p>ä¸»è¦çš„åº”ç”¨æ–‡ä»¶</p><image src="/images/TypeScript ç¼–è¯‘åŸç†.png"><h3 id="ç¼–è¯‘å™¨çš„å¤§æ¦‚å·¥ä½œæµ"><a href="#ç¼–è¯‘å™¨çš„å¤§æ¦‚å·¥ä½œæµ" class="headerlink" title="ç¼–è¯‘å™¨çš„å¤§æ¦‚å·¥ä½œæµ"></a>ç¼–è¯‘å™¨çš„å¤§æ¦‚å·¥ä½œæµ</h3><pre><code>SourceCodeï¼ˆæºç ï¼‰ ~~ æ‰«æå™¨ ~~&gt; Token æµ</code></pre><pre><code>Token æµ ~~ è§£æå™¨ ~~&gt; ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰</code></pre><pre><code>AST ~~ ç»‘å®šå™¨ ~~&gt; Symbolsï¼ˆç¬¦å·ï¼‰</code></pre><pre><code>AST + ç¬¦å· ~~ æ£€æŸ¥å™¨ ~~&gt; ç±»å‹éªŒè¯</code></pre><pre><code>AST + æ£€æŸ¥å™¨ ~~ å‘å°„å™¨ ~~&gt; JavaScript ä»£ç </code></pre></image>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡½æ•°å¼ç¼–ç¨‹-Point Free</title>
      <link href="/2019/07/25/javascript/functionalpoint/"/>
      <url>/2019/07/25/javascript/functionalpoint/</url>
      
        <content type="html"><![CDATA[<h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>Point-free æ˜¯ä¸€ç§ç¼–ç¨‹é£æ ¼ï¼Œå…¶ä¸­å‡½æ•°å®šä¹‰ä¸å¼•ç”¨å‡½æ•°çš„å‚æ•°ã€‚ä¸ç”¨å…³å¿ƒå°†è¦æ“ä½œçš„æ•°æ®æ˜¯ä»€æ ·çš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ JavaScript ä¸­çš„å‡½æ•°å®šä¹‰</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// è¡¨è¾¾å¼</span><span class="token keyword">function</span> foo <span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* parameters are declared here*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// å£°æ˜å¼</span><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* parameters are declared here */</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token comment" spellcheck="true">// ...</span><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* parameters are declared here */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚ä½•åœ¨ä¸å¼•ç”¨æ‰€éœ€å‚æ•°çš„æƒ…å†µä¸‹åœ¨ JavaScript ä¸­å®šä¹‰å‡½æ•°ï¼Ÿæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ functionkeywordï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨ç®­å¤´å‡½æ•°ï¼ˆ=&gt;ï¼‰ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦å£°æ˜å½¢å‚ï¼ˆè¿™å°†å¼•ç”¨å®ƒçš„å‚æ•°ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçš„æ˜¯è°ƒç”¨ä¸€ä¸ªè¿”å›å‡½æ•°çš„å‡½æ•°<br></p><h3 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// é Point-free. å› ä¸ºå‡½æ•°å¼•ç”¨äº†å‚æ•°name</span><span class="token keyword">var</span> greet <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">'hello '</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Point-free å…ˆå®šä¹‰åŸºæœ¬çš„å‡½æ•°ï¼Œä¸ç”¨å…³å¿ƒä¸­é—´å˜é‡stræ˜¯ä»€ä¹ˆï¼ŒæŠ½è±¡åŸºæœ¬ç»“æ„</span><span class="token keyword">var</span> toUpperCase <span class="token operator">=</span> str <span class="token operator">=</span><span class="token operator">></span> str<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> hello <span class="token operator">=</span> str <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>str<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span> <span class="token keyword">var</span> greet <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>hello<span class="token punctuation">,</span> toUpperCase<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">greet</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h3><p>è¿™ä¸ªä¾‹å­æ¥è‡ªäº<a href="https://fr.umio.us/favoring-curry/" target="_blank" rel="noopener">Favoring Curry</a><br><br>å‡è®¾æˆ‘ä»¬ä»æœåŠ¡å™¨è·å–è¿™æ ·çš„æ•°æ®ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>  result<span class="token punctuation">:</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">,</span>  tasks<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">104</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            priority<span class="token punctuation">:</span> <span class="token string">"high"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-29"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Scott"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Do something"</span><span class="token punctuation">,</span>      created<span class="token punctuation">:</span> <span class="token string">"9/22/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">105</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            priority<span class="token punctuation">:</span> <span class="token string">"medium"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-22"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Lena"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Do something else"</span><span class="token punctuation">,</span> created<span class="token punctuation">:</span> <span class="token string">"9/22/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">107</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             priority<span class="token punctuation">:</span> <span class="token string">"high"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-22"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Mike"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Fix the foo"</span><span class="token punctuation">,</span>       created<span class="token punctuation">:</span> <span class="token string">"9/22/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">108</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            priority<span class="token punctuation">:</span> <span class="token string">"low"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-15"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Punam"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Adjust the bar"</span><span class="token punctuation">,</span>    created<span class="token punctuation">:</span> <span class="token string">"9/25/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">110</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            priority<span class="token punctuation">:</span> <span class="token string">"medium"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-15"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Scott"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Rename everything"</span><span class="token punctuation">,</span> created<span class="token punctuation">:</span> <span class="token string">"10/2/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">112</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             priority<span class="token punctuation">:</span> <span class="token string">"high"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-27"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Lena"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Alter all quuxes"</span><span class="token punctuation">,</span>  created<span class="token punctuation">:</span> <span class="token string">"10/5/2013"</span><span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="getIncompleteTaskSummaries-å‡½æ•°"><a href="#getIncompleteTaskSummaries-å‡½æ•°" class="headerlink" title="getIncompleteTaskSummaries å‡½æ•°"></a>getIncompleteTaskSummaries å‡½æ•°</h3><p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåä¸º getIncompleteTaskSummaries çš„å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ª username ä½œä¸ºå‚æ•°ï¼Œä»æœåŠ¡å™¨è·å–æ•°æ®ä¹‹åç­›é€‰å‡ºè¿™ä¸ªç”¨æˆ·æœªå®Œæˆçš„ä»»åŠ¡çš„ idsã€prioritiesã€titlesã€å’Œ dueDate æ•°æ®ï¼Œå¹¶ä¸”æŒ‰ç…§æ—¥æœŸå‡åºæ’åºã€‚<br></p><p>ä»¥ Scott ä¸ºä¾‹ï¼Œæœ€ç»ˆç­›é€‰å‡ºçš„æ•°æ®ä¸º<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">110</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"Rename everything"</span><span class="token punctuation">,</span>         dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-15"</span><span class="token punctuation">,</span> priority<span class="token punctuation">:</span> <span class="token string">"medium"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">104</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"Do something"</span><span class="token punctuation">,</span>         dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-29"</span><span class="token punctuation">,</span> priority<span class="token punctuation">:</span> <span class="token string">"high"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> data<span class="token punctuation">.</span>tasks<span class="token punctuation">;</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token keyword">return</span> task<span class="token punctuation">.</span>username <span class="token operator">==</span> membername             <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token keyword">return</span> <span class="token operator">!</span>task<span class="token punctuation">.</span>complete             <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token keyword">return</span> <span class="token punctuation">{</span>                     id<span class="token punctuation">:</span> task<span class="token punctuation">.</span>id<span class="token punctuation">,</span>                     dueDate<span class="token punctuation">:</span> task<span class="token punctuation">.</span>dueDate<span class="token punctuation">,</span>                     title<span class="token punctuation">:</span> task<span class="token punctuation">.</span>title<span class="token punctuation">,</span>                     priority<span class="token punctuation">:</span> task<span class="token punctuation">.</span>priority                 <span class="token punctuation">}</span>             <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token keyword">var</span> a <span class="token operator">=</span> first<span class="token punctuation">.</span>dueDate<span class="token punctuation">,</span>                     b <span class="token operator">=</span> second<span class="token punctuation">.</span>dueDate<span class="token punctuation">;</span>                 <span class="token keyword">return</span> a <span class="token operator">&lt;</span> b <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> a <span class="token operator">></span> b <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>             console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">getIncompleteTaskSummaries</span><span class="token punctuation">(</span><span class="token string">'Scott'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Point-free-æ¨¡å¼"><a href="#Point-free-æ¨¡å¼" class="headerlink" title="Point-free æ¨¡å¼"></a>Point-free æ¨¡å¼<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// æ‹†åˆ†åŸºç¡€å‡½æ•°</span>curry ä¸ºå°è£…çš„é€šç”¨ curry éŸ©å¼<span class="token keyword">var</span> prop <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> obj<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> propEq <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> obj<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">===</span> val<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> filter <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> pick <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        result<span class="token punctuation">[</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> sortBy <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span>            b <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> a <span class="token operator">&lt;</span> b <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> a <span class="token operator">></span> b <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// æ‹¼è£…</span><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> membername<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'complete'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'dueDate'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">sortBy</span><span class="token punctuation">(</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'dueDate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">getIncompleteTaskSummaries</span><span class="token punctuation">(</span><span class="token string">'Scott'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åˆ©ç”¨-ramda-js-å®ç°-getIncompleteTaskSummarie"><a href="#åˆ©ç”¨-ramda-js-å®ç°-getIncompleteTaskSummarie" class="headerlink" title="åˆ©ç”¨ ramda.js å®ç° getIncompleteTaskSummarie"></a>åˆ©ç”¨ ramda.js å®ç° getIncompleteTaskSummarie</h3><p>å¦‚æœç›´æ¥ä½¿ç”¨ ramda.jsï¼Œä½ å¯ä»¥çœå»ç¼–å†™åŸºæœ¬å‡½æ•°<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> membername<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'complete'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'dueDate'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">sortBy</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'dueDate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">getIncompleteTaskSummaries</span><span class="token punctuation">(</span><span class="token string">'Scott'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åˆ©ç”¨-compose-å®ç°-getIncompleteTaskSummaries"><a href="#åˆ©ç”¨-compose-å®ç°-getIncompleteTaskSummaries" class="headerlink" title="åˆ©ç”¨ compose å®ç° getIncompleteTaskSummaries"></a>åˆ©ç”¨ compose å®ç° getIncompleteTaskSummaries</h3><p>å¯ä»¥ä»å·¦åˆ°å³</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span>            R<span class="token punctuation">.</span><span class="token function">sortBy</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'dueDate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            R<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'dueDate'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'complete'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> membername<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">getIncompleteTaskSummaries</span><span class="token punctuation">(</span><span class="token string">'Scott'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åˆ©ç”¨-ramda-js-æä¾›çš„-R-pipe-å‡½æ•°"><a href="#åˆ©ç”¨-ramda-js-æä¾›çš„-R-pipe-å‡½æ•°" class="headerlink" title="åˆ©ç”¨ ramda.js æä¾›çš„ R.pipe å‡½æ•°"></a>åˆ©ç”¨ ramda.js æä¾›çš„ R.pipe å‡½æ•°</h3><p>å¯ä»¥ä»å·¦åˆ°å³</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>          R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> membername<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'complete'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          R<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'dueDate'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          R<span class="token punctuation">.</span><span class="token function">sortBy</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'dueDate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> å‡½æ•°å¼ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‡½æ•°å¼ç¼–ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡½æ•°å¼ç¼–ç¨‹-å‡½æ•°ç»„åˆ</title>
      <link href="/2019/07/22/javascript/functionalcombination/"/>
      <url>/2019/07/22/javascript/functionalcombination/</url>
      
        <content type="html"><![CDATA[<h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>å‡½æ•°ç»„åˆæ˜¯å°†ä¸¤ä¸ªæˆ–å¤šä¸ªå‡½æ•°ç»„åˆä»¥äº§ç”Ÿæ–°å‡½æ•°çš„è¿‡ç¨‹ã€‚å°†åŠŸèƒ½ç»„åˆåœ¨ä¸€èµ·å°±åƒå°†ä¸€ç³»åˆ—ç®¡é“æ‹¼å‡‘åœ¨ä¸€èµ·ï¼Œä»¥ä¾¿æˆ‘ä»¬çš„æ•°æ®æµè¿‡<br></p><p>ç®€è€Œè¨€ä¹‹ï¼Œå‡½æ•°<code>f</code>å’Œ<code>g</code>çš„ç»„åˆå¯ä»¥å®šä¹‰ä¸º<code>fï¼ˆgï¼ˆxï¼‰ï¼‰</code>ï¼Œå®ƒä»å†…åˆ°å¤– - ä»å³åˆ°å·¦è¿›è¡Œæ±‚å€¼<br></p><h3 id="demo-toSlug"><a href="#demo-toSlug" class="headerlink" title="demo toSlug"></a>demo toSlug</h3><p>ä¸¾ä¾‹å­ï¼Œæƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼Œæƒ³è¦å°†ç”¨æˆ·çš„å…¨åè½¬æ¢ä¸ºURL slugsï¼Œä»¥ä¾¿ä¸ºæ¯ä¸ªç”¨æˆ·æä¾›ä¸ªäººèµ„æ–™é¡µé¢ã€‚ä¸ºæ­¤ï¼Œéœ€è¦å®Œæˆä¸€ç³»åˆ—æ­¥éª¤ï¼š</p><ol><li>å°†åç§°æ‹†åˆ†ä¸ºç©ºæ ¼ä¸­çš„æ•°ç»„</li><li>å°†åç§°æ˜ å°„åˆ°å°å†™</li><li>åŠ å…¥ç ´æŠ˜å·</li><li>ç¼–ç URIç»„ä»¶</li></ol><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// toslug.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> input <span class="token operator">=</span><span class="token operator">></span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>  input<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>str <span class="token operator">=</span><span class="token operator">></span> str<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç»„åˆåŠŸèƒ½"><a href="#ç»„åˆåŠŸèƒ½" class="headerlink" title="ç»„åˆåŠŸèƒ½"></a>ç»„åˆåŠŸèƒ½</h3><p>ä¸é”™â€¦â€¦ä½†å¦‚æœæˆ‘å‘Šè¯‰ä½ å®ƒå¯èƒ½æ›´å…·å¯è¯»æ€§å‘¢ï¼Ÿæƒ³è±¡ä¸€ä¸‹ï¼Œè¿™äº›æ“ä½œä¸­çš„æ¯ä¸€ä¸ªéƒ½å…·æœ‰ç›¸åº”çš„å¯ç»„åˆåŠŸèƒ½ã€‚å¯ä»¥å†™æˆ<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// nesting-composition.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> input <span class="token operator">=</span><span class="token operator">></span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">(</span>      <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">(</span>        input      <span class="token punctuation">)</span>    <span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç®€å•çš„ååº”ç”¨å‡½æ•°"><a href="#ç®€å•çš„ååº”ç”¨å‡½æ•°" class="headerlink" title="ç®€å•çš„ååº”ç”¨å‡½æ•°"></a>ç®€å•çš„ååº”ç”¨å‡½æ•°</h3><p>è¿™çœ‹èµ·æ¥æ¯”æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡å°è¯•æ›´éš¾é˜…è¯»ï¼Œä½†å…ˆæ”¾åœ¨è¿™ï¼Œæˆ‘ä»¬ç»§ç»­ä»¥å¯ç»„åˆå½¢å¼çš„å¸¸ç”¨å®ç”¨ç¨‹åºï¼Œå¦‚<code>splitï¼ˆï¼‰</code>ï¼Œ<code>joinï¼ˆï¼‰</code>å’Œ<code>mapï¼ˆï¼‰</code>ã€‚æ¥å®ç°<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// composables.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> curry <span class="token operator">=</span> fn <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> fn<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> join <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> toLowerCase <span class="token operator">=</span> str <span class="token operator">=</span><span class="token operator">></span> str<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> split <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>splitOn<span class="token punctuation">,</span> str<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>splitOn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ä¾‹å­åœ¨æŠ€æœ¯ä¸Šå¹¶ä¸æ˜¯çœŸçš„æŸ¯é‡ŒåŒ–ï¼Œå®ƒæ€»èƒ½äº§ç”Ÿä¸€å…ƒå‡½æ•°ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸€ä¸ªç®€å•çš„ååº”ç”¨å‡½æ•°ã€‚è¯·å‚è€ƒ<a href="https://medium.com/javascript-scene/curry-or-partial-application-8150044c78b8" target="_blank" rel="noopener">æœ‰å…³ååº”ç”¨å‡½æ•°å’ŒæŸ¯é‡ŒåŒ–çš„åŒºåˆ«</a> <br></p><p>å›åˆ°æˆ‘ä»¬çš„<code>toSlugï¼ˆï¼‰</code>å®ç°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// nesting-composition.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> input <span class="token operator">=</span><span class="token operator">></span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">(</span>      <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">(</span>        input      <span class="token punctuation">)</span>    <span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="composeï¼ˆï¼‰"><a href="#composeï¼ˆï¼‰" class="headerlink" title="composeï¼ˆï¼‰"></a>composeï¼ˆï¼‰</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè‡ªåŠ¨ç»„åˆè¿™äº›å‡½æ•°çš„å‡½æ•°æ¥å±•å¹³åµŒå¥—ï¼Œè¿™æ„å‘³ç€å®ƒå°†ä»ä¸€ä¸ªå‡½æ•°è·å–è¾“å‡ºå¹¶è‡ªåŠ¨å°†å…¶åˆ°ä¸‹ä¸€ä¸ªå‡½æ•°çš„è¾“å…¥ï¼Œç›´åˆ°å®ƒè¾“å‡ºæœ€ç»ˆå€¼<br><br>æƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬å®ç°å‡½æ•° <code>reduceï¼ˆï¼‰</code> çš„åŠŸèƒ½ï¼Œä½†ä¸ºäº†åŒ¹é…ä¸Šé¢çš„composeè¡Œä¸ºï¼Œæˆ‘ä»¬éœ€è¦å®ƒä»å³åˆ°å·¦ï¼Œè€Œä¸æ˜¯ä»å·¦åˆ°å³<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// compose.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> compose <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>fns<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">=</span><span class="token operator">></span> fns<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">f</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> compose <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>fns<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">=</span><span class="token operator">></span> fns<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">f</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ <code>.reduceRight()</code> ä¸<code>.reduceï¼ˆï¼‰</code>ä¸€æ ·ï¼Œæ•°ç»„<code>.reduceRightï¼ˆï¼‰</code>æ–¹æ³•é‡‡ç”¨reducerå‡½æ•°å’Œåˆå§‹å€¼ï¼ˆ<code>x</code>ï¼‰ã€‚æˆ‘ä»¬è¿­ä»£æ•°ç»„å‡½æ•°ï¼ˆä»å³åˆ°å·¦ï¼‰ï¼Œä¾æ¬¡å°†æ¯ä¸ªå‡½æ•°åº”ç”¨äºç´¯åŠ å€¼ï¼ˆ<code>v</code>ï¼‰<br></p><p>ä½¿ç”¨composeï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ²¡æœ‰åµŒå¥—çš„æƒ…å†µä¸‹é‡å†™ toSlug çš„ç»„åˆ<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// using-compose.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>  encodeURIComponent<span class="token punctuation">,</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="pipeï¼ˆï¼‰"><a href="#pipeï¼ˆï¼‰" class="headerlink" title="pipeï¼ˆï¼‰"></a>pipeï¼ˆï¼‰</h3><p>è¿˜æœ‰å¦ä¸€ç§é€šå¸¸ç§°ä¸ºâ€œpipeï¼ˆï¼‰â€çš„å½¢å¼ã€‚ Lodashç§°ä¹‹ä¸º<code>flowï¼ˆï¼‰</code><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// pipe.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> pipe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>fns<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">=</span><span class="token operator">></span> fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">f</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> fn1 <span class="token operator">=</span> s <span class="token operator">=</span><span class="token operator">></span> s<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> fn2 <span class="token operator">=</span> s <span class="token operator">=</span><span class="token operator">></span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> fn3 <span class="token operator">=</span> s <span class="token operator">=</span><span class="token operator">></span> s <span class="token operator">+</span> <span class="token string">'!'</span><span class="token keyword">const</span> newFunc <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fn1<span class="token punctuation">,</span> fn2<span class="token punctuation">,</span> fn3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">newFunc</span><span class="token punctuation">(</span><span class="token string">'Time'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// emit!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬çœ‹çœ‹ç”¨<code>pipeï¼ˆï¼‰</code>å®ç°çš„<code>toSlugï¼ˆï¼‰</code>å‡½æ•°<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// using-pipe.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>  <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  encodeURIComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨å‘½ä»¤å¼ç¼–ç¨‹ä¸­ï¼Œå½“æ‚¨å¯¹æŸä¸ªå˜é‡æ‰§è¡Œè½¬æ¢æ—¶ï¼Œæ‚¨å°†åœ¨è½¬æ¢çš„æ¯ä¸ªæ­¥éª¤ä¸­æ‰¾åˆ°å¯¹è¯¥å˜é‡çš„å¼•ç”¨ã€‚ä¸Šé¢çš„<code>pipeï¼ˆï¼‰</code>å®ç°æ˜¯ä»¥æ— ç‚¹çš„æ–¹å¼ç¼–å†™çš„ï¼Œè¿™æ„å‘³ç€å®ƒæ ¹æœ¬ä¸è¯†åˆ«å®ƒè¿è¡Œçš„å‚æ•°ã€‚<br></p><h3 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h3><p>æˆ‘ç»å¸¸åœ¨å•å…ƒæµ‹è¯•å’ŒReduxçŠ¶æ€ä¹‹ç±»çš„ä¸œè¥¿ä¸­ä½¿ç”¨ç®¡é“æ¥æ¶ˆé™¤å¯¹ä¸­é—´å˜é‡çš„éœ€è¦ï¼Œè¿™äº›ä¸­é—´å˜é‡åªå­˜åœ¨äºä¸€ä¸ªæ“ä½œå’Œä¸‹ä¸€ä¸ªæ“ä½œä¹‹é—´çš„ç¬æ€å€¼ã€‚<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// using-trace.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> trace <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`== </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> label <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> x <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'after map'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  encodeURIComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// '== input:  JS Cheerleader'</span><span class="token comment" spellcheck="true">// '== after map:  js,cheerleader'</span><span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>traceï¼ˆï¼‰</code>åªæ˜¯æ›´é€šç”¨çš„<code>tapï¼ˆï¼‰</code>çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œå®ƒå…è®¸ä½ ä¸ºæµç»ç®¡é“çš„æ¯ä¸ªå€¼æ‰§è¡Œä¸€äº›æ“ä½œ<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// tap.js hosted with â¤ by GitHub</span><span class="token keyword">const</span> tap <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">fn</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç°åœ¨å¯ä»¥çœ‹åˆ°<code>traceï¼ˆï¼‰</code>æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„<code>tapï¼ˆï¼‰</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> trace <span class="token operator">=</span> label <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">tap</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`== </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> label <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> x <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> å‡½æ•°å¼ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‡½æ•°å¼ç¼–ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è£…é¥°å™¨</title>
      <link href="/2019/07/18/typescript/decorators/"/>
      <url>/2019/07/18/typescript/decorators/</url>
      
        <content type="html"><![CDATA[<p>è£…é¥°å™¨æ˜¯ä¸€ç§ä¸ºç±»å£°æ˜å’Œæˆå‘˜æ·»åŠ æ³¨é‡Šå’Œå…ƒç¼–ç¨‹è¯­æ³•çš„æ–¹æ³•ï¼Œç”¨äºåœ¨ç¼–è¯‘æ—¶å¯¹ç±»ã€ç±»çš„æ–¹æ³•ã€ç±»çš„å±æ€§ã€ç±»çš„æ–¹æ³•çš„å‚æ•°è¿›è¡Œå¤„ç†ï¼Œé€šä¿—çš„è®²å°±æ˜¯åœ¨åŸæœ‰ä»£ç å¤–å±‚åŒ…è£…äº†ä¸€å±‚å¤„ç†é€»è¾‘ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸æ”¹å˜åŸæ–¹æ³•ã€å‡½æ•°ç­‰é€»è¾‘åŠŸèƒ½çš„åŸºç¡€ä¸Šå¢åŠ é¢å¤–çš„å¤„ç†è¡Œä¸º</p><h3 id="ä½¿ç”¨è£…é¥°å™¨"><a href="#ä½¿ç”¨è£…é¥°å™¨" class="headerlink" title="ä½¿ç”¨è£…é¥°å™¨"></a><strong>ä½¿ç”¨è£…é¥°å™¨</strong></h3><p>è¦å¯ç”¨è£…é¥°å™¨åŠŸèƒ½éœ€è¦å¼€å§‹experimentalDecoratorsé€‰é¡¹ï¼Œä¸¤ç§æ–¹å¼</p><p>å‘½ä»¤è¡Œ</p><pre><code>tsc --target ES5 --experimentalDecorators</code></pre><p>tsconfig.jsoné…ç½®</p><pre><code>{    &quot;compilerOptions&quot;: {        &quot;target&quot;: &quot;ES5&quot;,        &quot;experimentalDecorators&quot;: true    }}</code></pre><h3 id="è£…é¥°å™¨çš„ç®€å•åº”ç”¨"><a href="#è£…é¥°å™¨çš„ç®€å•åº”ç”¨" class="headerlink" title="è£…é¥°å™¨çš„ç®€å•åº”ç”¨"></a><strong>è£…é¥°å™¨çš„ç®€å•åº”ç”¨</strong></h3><p>å®šä¹‰ä¸€ä¸ªè£…é¥°å™¨</p><pre><code>function people (target) {  console.log(target)}</code></pre><p>åœ¨ç±»ä¸­ä½¿ç”¨è£…é¥°å™¨ï¼ˆ@Decoratorçš„è¯­æ³•æ˜¯é€šè¿‡ @ ç¬¦å·åè¾¹è·Ÿä¸€ä¸ªè£…é¥°å™¨å‡½æ•°çš„å¼•ç”¨ï¼‰</p><pre><code>@peopleclass People {  constructor(){}} </code></pre><h3 id="è£…é¥°å™¨å·¥å‚"><a href="#è£…é¥°å™¨å·¥å‚" class="headerlink" title="è£…é¥°å™¨å·¥å‚"></a>è£…é¥°å™¨å·¥å‚</h3><p>è§£å†³åœ¨ç±»ä¸­è°ƒç”¨è£…é¥°å™¨ä¼ å‚æ•°çš„åœºæ™¯</p><pre><code>// è£…é¥°å™¨å·¥å‚function people(name : string) {     // è£…é¥°å™¨  return function(target){           console.log(target);  }}// è°ƒç”¨è£…é¥°å™¨å·¥å‚@people(&#39;zhangsan&#39;)class People{  constructor(){}} </code></pre><h3 id="å¤šä¸ªè£…é¥°å™¨åº”ç”¨"><a href="#å¤šä¸ªè£…é¥°å™¨åº”ç”¨" class="headerlink" title="å¤šä¸ªè£…é¥°å™¨åº”ç”¨"></a>å¤šä¸ªè£…é¥°å™¨åº”ç”¨</h3><p>å½“åœ¨ä¸€ä¸ªç±»ä¸Šç”±å¤šä¸ªè£…é¥°å™¨è°ƒç”¨çš„æ—¶å€™ï¼Œç±»ä¼¼äº<a href="functionalCombination.md">å‡½æ•°ç»„åˆ</a></p><p>å®šä¹‰å¤šä¸ªè£…é¥°å™¨</p><pre><code>function decorator1() {  console.log(&quot;decorator1(): start&quot;);  return function (target) {    console.log(&quot;decorator1(): end&quot;);  }}function decorator2() {    console.log(&quot;decorator2(): start&quot;);    return function (target) {      console.log(&quot;decorator2(): end&quot;);    }}</code></pre><p>è°ƒç”¨è£…é¥°å™¨</p><pre><code>class C {  @decorator1()  @decorator2()  method() {}}</code></pre><p>è¾“å‡ºç»“æœä¸º(å¯ä»¥çœ‹ä½œç»„åˆå‡½æ•°è°ƒç”¨ decorator1(decorator2()))</p><pre><code>decorator1(): startdecorator2(): startdecorator2(): enddecorator1(): end</code></pre><h3 id="ç±»è£…é¥°å™¨ï¼ˆClassï¼‰"><a href="#ç±»è£…é¥°å™¨ï¼ˆClassï¼‰" class="headerlink" title="ç±»è£…é¥°å™¨ï¼ˆClassï¼‰"></a>ç±»è£…é¥°å™¨ï¼ˆClassï¼‰</h3><ul><li>ç±»è£…é¥°å™¨åº”ç”¨äºç±»çš„æ„é€ å‡½æ•°ï¼Œç”¨äºè§‚å¯Ÿï¼Œä¿®æ”¹æˆ–æ›¿æ¢ç±»å®šä¹‰ </li><li>ç±»ä¼šåœ¨classå®šä¹‰å‰è°ƒç”¨ï¼Œå¦‚æœå‡½æ•°æœ‰è¿”å›å€¼ï¼Œå®ƒå°†ä½¿ç”¨æä¾›çš„æ„é€ å‡½æ•°æ›¿æ¢ä¹‹å‰çš„æ„é€ å‡½æ•°</li><li>å‡½æ•°æ¥æ”¶ä¸€ä¸ªå‚æ•° <code>constructor</code> ä¹‹å‰çš„æ„é€ å‡½æ•°</li><li>å¦‚æœè¿”å›æ–°çš„æ„é€ å‡½æ•°ï¼Œåˆ™å¿…é¡»ç»´æŠ¤åŸå§‹åŸå‹</li></ul><p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç±»ï¼Œç»§æ‰¿åŸæœ‰çš„ç±»å¹¶å¯¹è¿™ä¸ªç±»å¢åŠ ä¸€äº›å±æ€§</p><pre><code>// å®šä¹‰ç±»è£…é¥°å™¨function personName&lt;T extends {new(...args:any[]):{}}&gt;(constructor:T){  return class extends constructor {    name = &quot;zhangsan&quot;;  }}// ä½¿ç”¨ç±»è£…é¥°å™¨@personNameclass Person { public name: string;  constructor (name: string) {    this.name = name    console.log(`Hi, my name is ${this.name}`) // Hi, my name is wangwu  }}console.log(new Person(&#39;wangwu&#39;)) // class_1 {name: &quot;zhangsan&quot;,__proto__:Person}</code></pre><h3 id="æ–¹æ³•è£…é¥°å™¨"><a href="#æ–¹æ³•è£…é¥°å™¨" class="headerlink" title="æ–¹æ³•è£…é¥°å™¨"></a>æ–¹æ³•è£…é¥°å™¨</h3><p>æ–¹æ³•ï¼Œå±æ€§ï¼Œgetã€setè®¿é—®å™¨ï¼Œéƒ½å¯ä»¥è®¤ä¸ºæ˜¯ç±»æˆå‘˜ã€‚æ‰€ä»¥è¢«åˆ†ä¸ºäº†Method Decoratorã€Accessor Decoratorå’ŒProperty Decorator è¿™ä¸‰ä¸ªå‚æ•° </p><p>æ–¹æ³•è£…é¥°åªæ˜¯ä¸€ä¸ªæ–¹æ³•å£°æ˜ä¹‹å‰å£°æ˜ï¼Œæ–¹æ³•è£…é¥°å™¨ä¸èƒ½ç”¨äºå£°æ˜æ–‡ä»¶ï¼Œé‡è½½æˆ–ä»»ä½•å…¶ä»–ç¯å¢ƒä¸Šä¸‹æ–‡ï¼ˆä¾‹å¦‚declareç±»ä¸­ï¼‰</p><p>æ–¹æ³•è£…é¥°å™¨çš„è¡¨è¾¾å¼å°†åœ¨è¿è¡Œæ—¶ä½œä¸ºå‡½æ•°è°ƒç”¨ï¼Œå…·æœ‰ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>å¦‚æœè£…é¥°å™¨æŒ‚è½½äºé™æ€æˆå‘˜ä¸Šï¼Œåˆ™ä¼šè¿”å›æ„é€ å‡½æ•°ï¼Œå¦‚æœæŒ‚è½½äºå®ä¾‹æˆå‘˜ä¸Šåˆ™ä¼šè¿”å›ç±»çš„åŸå‹</li><li>è£…é¥°å™¨æŒ‚è½½çš„æˆå‘˜åç§°</li><li>æ–¹æ³•æˆå‘˜çš„å±æ€§æè¿°å¯¹è±¡ï¼ˆObject.getOwnPropertyDescriptor çš„è¿”å›å€¼ï¼‰</li></ul><p>æ‰€è°“çš„è®¿é—®å™¨ä¹Ÿå°±æ˜¯æœ‰ get set å‰ç¼€çš„å‡½æ•°ï¼Œæ–¹æ³•æ˜¯æ§åˆ¶å±æ€§çš„èµ‹å€¼åŠå–å€¼ï¼Œè®¿é—®å™¨è£…é¥°å™¨å’Œæ–¹æ³•è£…é¥°å™¨ä¸€æ ·å› ä¸ºå’Œä¸‹é¢è¦è¯´åˆ°çš„å±æ€§è£…é¥°å™¨ä¸€æ ·éƒ½æ˜¯ç±»çš„æˆå‘˜å…·æœ‰ä¸‰ä¸ªå‚æ•°</p><p>Method Decoratorã€Accessor Decoratorå’ŒProperty Decorator<br>ä½¿ç”¨æ–¹æ³•è£…é¥°å™¨</p><pre><code>class Greeter {  greeting: string;  constructor(message: string) {    this.greeting = message;  }  @enumerable(false)  greet() {    return &quot;Hello, &quot; + this.greeting;  }}</code></pre><pre><code>function enumerable(value: boolean) {  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor{    descriptor.enumerable = value;  };}</code></pre><p>æ˜ç¡®ä¸€ä¸‹é™æ€æˆå‘˜ä¸å®ä¾‹æˆå‘˜åœ¨è¿”å›å€¼ä¸Šçš„åŒºåˆ«</p><pre><code>class Func {  // é™æ€æˆå‘˜  static method1 () {}  static method2 = () =&gt; {}  // å®ä¾‹æˆå‘˜  method3 () {}  method4 = () =&gt; {}}</code></pre><p>é™æ€æˆå‘˜ method1 å’Œ method2 éƒ½æ˜¯å®šä¹‰åœ¨ Func æ„é€ å‡½æ•°ä¸Šï¼Œmethod3 å’Œ method4 åŒºåˆ«åœ¨äº method3 å®šä¹‰åœ¨åŸå‹é“¾ä¹‹ä¸Š method4 åªæœ‰åœ¨ Func ç±»å®ä¾‹åŒ–å¯¹è±¡ä¹‹åæ‰æœ‰ï¼Œè½¬åŒ–ES5ä»£ç ä¹‹åçš„æ ·å­</p><pre><code>var Func = /** @class */ (function () {    function Func() {      this.method4 = function () { };    }    // é™æ€æˆå‘˜    Func.method1 = function () { };    // å®ä¾‹æˆå‘˜    Func.prototype.method3 = function () { };    Func.method2 = function () { };    return Func;}());</code></pre><p>é€šè¿‡å‡½æ•°å¯ä»¥è¯æ˜ä¸Šè¿°è®ºç‚¹è£…é¥°å™¨æŒ‚è½½äºé™æ€æˆå‘˜ä¸Šï¼Œåˆ™ä¼šè¿”å›æ„é€ å‡½æ•°ï¼Œå¦‚æœæŒ‚è½½äºå®ä¾‹æˆå‘˜ä¸Šåˆ™ä¼šè¿”å›ç±»çš„åŸå‹ è€Œä¸” method4 åœ¨å®ä¾‹åŒ–ä¹‹å‰æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§æ‰€ä»¥æ²¡æœ‰ descriptorï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆTSåœ¨é’ˆå¯¹Property Decoratorä¸ä¼ é€’ç¬¬ä¸‰ä¸ªå‚æ•°çš„åŸå› </p><h3 id="è®¿é—®å™¨è£…é¥°å™¨ï¼ˆget-setï¼‰"><a href="#è®¿é—®å™¨è£…é¥°å™¨ï¼ˆget-setï¼‰" class="headerlink" title="è®¿é—®å™¨è£…é¥°å™¨ï¼ˆget setï¼‰"></a>è®¿é—®å™¨è£…é¥°å™¨ï¼ˆget setï¼‰</h3><p>è®¿é—®å™¨è£…é¥°å™¨å°±æ˜¯æœ‰getã€setå‰ç¼€çš„å‡½æ•°ï¼Œç”¨äºæ§åˆ¶å±æ€§çš„èµ‹å€¼åŠå–å€¼æ“ä½œã€‚ä¸Šé¢è¯´åˆ°å’Œæ–¹æ³•è£…é¥°å™¨ä¸€æ ·æœ‰ä¸‰ä¸ªå‚æ•°</p><p>å®šä¹‰è£…é¥°å™¨ä¸‰ä¸ªå‚æ•°</p><pre><code>function configurable(value: boolean) {  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {    descriptor.configurable = value;  };}</code></pre><p>å®šä¹‰å¸¦æœ‰getï¼Œsetçš„ç±»</p><pre><code>class Point {  private _x: number;  private _y: number;  constructor(x: number, y: number) {      this._x = x;      this._y = y;  }  @configurable(false)  get x() { return this._x; }  @configurable(false)  get y() { return this._y; }}</code></pre><h3 id="å±æ€§è£…é¥°å™¨"><a href="#å±æ€§è£…é¥°å™¨" class="headerlink" title="å±æ€§è£…é¥°å™¨"></a>å±æ€§è£…é¥°å™¨</h3><p>å±æ€§è£…é¥°å™¨ç”±äºæ²¡æœ‰è¿”å› descriptor æ‰€ä»¥åªæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œæ²¡æœ‰æ–¹æ³•æˆå‘˜çš„å±æ€§æè¿°å¯¹è±¡ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹æŸä¸€ä¸ªé™æ€å±æ€§ï¼Œå¯ä»¥é€šè¿‡ Object.getOwnPropertyDescriptor è·å– descriptor</p><p><em>æ³¨æ„åœ¨TypeScriptä¸­å¦‚ä½•åˆå§‹åŒ–å±æ€§ä¿®é¥°ç¬¦ï¼Œå› æ­¤ä¸æä¾›å±æ€§æè¿°ç¬¦ä½œä¸ºå±æ€§ä¿®é¥°ç¬¦çš„å‚æ•°ã€‚è¿™æ˜¯å› ä¸ºå½“å®šä¹‰åŸå‹çš„æˆå‘˜æ—¶ï¼Œå½“å‰æ²¡æœ‰æœºåˆ¶æ¥æè¿°å®ä¾‹å±æ€§ï¼Œä¹Ÿæ— æ³•è§‚å¯Ÿæˆ–ä¿®æ”¹å±æ€§çš„åˆå§‹åŒ–å™¨ã€‚è¿”å›å€¼ä¹Ÿè¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œå±æ€§è£…é¥°å™¨åªèƒ½ç”¨äºè§‚å¯Ÿå·²ä¸ºç±»å£°æ˜ç‰¹å®šåç§°çš„å±æ€§ã€‚</em></p><p>å®šä¹‰ç±»</p><pre><code>class Point {  @configurable  static x = 1;}</code></pre><p>å®šä¹‰å±æ€§è£…é¥°å™¨è·å–ç±»å±æ€§ä¸Šçš„å€¼è¿›è¡Œæ›´æ”¹</p><pre><code>function configurable(target,x) {  let descriptor = Object.getOwnPropertyDescriptor(target, x)  Object.defineProperty(target, x, {    ...descriptor,    value: 2  })}console.log(Point.x) // 2 </code></pre><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ reflect-metadata è¿™ä¸ªåº“å®ƒä¸»è¦ç”¨æ¥åœ¨å£°æ˜çš„æ—¶å€™æ·»åŠ å’Œè¯»å–å…ƒæ•°æ®<br>ä½¿ç”¨çš„æ—¶å€™éœ€è¦å®‰è£…</p><pre><code>npm i reflect-metadata --save</code></pre><p>ä¹‹ååœ¨tsconfig.json ä¸­é…ç½®emitDecoratorMetadataé€‰é¡¹</p><pre><code>{  &quot;compilerOptions&quot;: {    &quot;target&quot;: &quot;ES5&quot;,    &quot;experimentalDecorators&quot;: true,    &quot;emitDecoratorMetadata&quot;: true  }}</code></pre><p>å®šä¹‰ç±»</p><pre><code>class Greeter {    @format(&quot;Hello, %s&quot;)    greeting: string;    constructor(message: string) {        this.greeting = message;    }    greet() {        let formatString = getFormat(this, &quot;greeting&quot;);        return formatString.replace(&quot;%s&quot;, this.greeting);    }}</code></pre><p>// åˆ©ç”¨ reflect-metadata å®šä¹‰è£…é¥°å™¨</p><p>Reflect.metadata å½“ä½œ Decorator ä½¿ç”¨ï¼Œå½“ä¿®é¥°ç±»æ—¶ï¼Œåœ¨ç±»ä¸Šæ·»åŠ å…ƒæ•°æ®ï¼Œå½“ä¿®é¥°ç±»å±æ€§æ—¶ï¼Œåœ¨ç±»åŸå‹çš„å±æ€§ä¸Šæ·»åŠ å…ƒæ•°æ®</p><p>Reflect.getMetadata èƒ½è·å–å±æ€§</p><pre><code>import &quot;reflect-metadata&quot;;const formatMetadataKey = Symbol(&quot;format&quot;);function format(formatString: string) {  return Reflect.metadata(formatMetadataKey, formatString);}function getFormat(target: any, propertyKey: string) {  return Reflect.getMetadata(formatMetadataKey, target, propertyKey);}</code></pre><h3 id="å‚æ•°è£…é¥°å™¨"><a href="#å‚æ•°è£…é¥°å™¨" class="headerlink" title="å‚æ•°è£…é¥°å™¨"></a>å‚æ•°è£…é¥°å™¨</h3><p>å‚æ•°è£…é¥°å™¨å’Œå±æ€§è£…é¥°å™¨ä¸€æ ·éƒ½æ˜¯åœ¨å‡½æ•°è¿è¡Œæ—¶è°ƒç”¨çš„ï¼Œå®ƒæ¥æ”¶3ä¸ªå‚æ•°</p><ul><li>å¦‚æœè£…é¥°å™¨æŒ‚è½½äºé™æ€æˆå‘˜ä¸Šï¼Œåˆ™ä¼šè¿”å›æ„é€ å‡½æ•°ï¼Œå¦‚æœæŒ‚è½½äºå®ä¾‹æˆå‘˜ä¸Šåˆ™ä¼šè¿”å›ç±»çš„åŸå‹</li><li>å‚æ•°æ‰€å¤„çš„å‡½æ•°åç§°</li><li>å‚æ•°åœ¨å‡½æ•°ä¸­å½¢å‚ä¸­çš„ä½ç½®</li></ul><pre><code>const obj = []function require (value : string) {  return function (target : any , propertyKey : string ,parameterIndex : number) {    obj[parameterIndex] = value  }}class Hello{  method(@require(&#39;lisi&#39;) name : string){    console.log(name)  }}console.log(obj) // [&#39;lisi&#39;]</code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ååº”ç”¨å‡½æ•°ã€å‡½æ•°çš„æŸ¯é‡ŒåŒ–</title>
      <link href="/2019/07/17/javascript/functioncurrying/"/>
      <url>/2019/07/17/javascript/functioncurrying/</url>
      
        <content type="html"><![CDATA[<p>ååº”ç”¨å‡½æ•°ç®€ç§°åå‡½æ•°ï¼Œåœ¨æ¨¡æ‹Ÿ bind çš„æ—¶å€™å·²ç»è¯´æ˜å…¶æ¦‚å¿µå’Œä½œä¸ºä¸»è¦ bind çš„å®ç°<br></p><p>å‡½æ•°æŸ¯é‡ŒåŒ–ä¸»è¦æ˜¯é€šè¿‡ååº”ç”¨å‡½æ•°çš„å®ç°ï¼ŒæŠŠæ¥å—å¤šä¸ªå‚æ•°çš„å‡½æ•°å˜æ¢æˆæ¥å—ä¸€ä¸ªå•ä¸€å‚æ•°çš„å‡½æ•°ï¼Œå¹¶ä¸”è¿”å›æ¥å—ä½™ä¸‹çš„å‚æ•°è€Œä¸”è¿”å›ç»“æœçš„æ–°å‡½æ•°<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// æŸ¯é‡ŒåŒ–ä¹‹å‰</span><span class="token keyword">function</span> add <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// æŸ¯é‡ŒåŒ–ä¹‹å</span><span class="token keyword">function</span> add <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> a<span class="token operator">+</span>b  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ç­‰åŒäº</span><span class="token keyword">const</span> add <span class="token operator">=</span> a <span class="token operator">=</span><span class="token operator">></span> b <span class="token operator">=</span><span class="token operator">></span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// => 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>é¦–å…ˆå‡½æ•°æ¥å— a å‚æ•° ç„¶åè¿”å›ä¸€ä¸ªæ–°çš„åŒ¿åå‡½æ•°ä½“ç¡®å®šäº†æ–°çš„è¯æ³•ä½œç”¨åŸŸ,åœ¨è¯¥è¯æ³•ä½œç”¨åŸŸä¸­ä¹Ÿæ‹¥æœ‰ a å‚æ•°</li><li>è¯¥åŒ¿åå‡½æ•°è°ƒç”¨ä¼ å…¥å‚æ•° 3 è¿”å› a+b çš„å’Œ</li><li>é€šè¿‡ä¸Šé¢ç¨‹åºäº†è§£åˆ°æŸ¯é‡ŒåŒ–å‡½æ•°çš„ç‰¹ç‚¹æ˜¯æ€»æ˜¯è¿”å›ä¸€ä¸ªä¸€å…ƒçš„å‡½æ•°ï¼šä¸€ä¸ªå¸¦æœ‰ä¸€ä¸ªå‚æ•°çš„æ–°å‡½æ•°ï¼Œä¸åŒçš„æ˜¯æ™®é€šå‡½æ•°å¯ä»¥æ ¹æ®éœ€è¦ä¸€æ¬¡è·å–å°½å¯èƒ½å¤šçš„å‚æ•°</li></ol><h3 id="ä¸ºä»€ä¹ˆè¦æŸ¯é‡ŒåŒ–"><a href="#ä¸ºä»€ä¹ˆè¦æŸ¯é‡ŒåŒ–" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æŸ¯é‡ŒåŒ–"></a>ä¸ºä»€ä¹ˆè¦æŸ¯é‡ŒåŒ–</h3><ol><li>æŸ¯é‡ŒåŒ–åœ¨å‡½æ•°ç»„åˆçš„ä¸Šä¸‹æ–‡ä¸­èµ·åˆ°å…³é”®çš„ä½œç”¨,èƒ½å¤Ÿè®©ä½ é‡æ–°ç»„åˆä½ çš„åº”ç”¨ï¼Œå°†å¤æ‚çš„åŠŸèƒ½æ‹†åˆ†æˆä¸€ä¸ªä¸ªç®€å•çš„éƒ¨åˆ†ï¼Œè¿™æ ·å®¹æ˜“æ›´æ”¹ï¼Œç†è§£</li><li>æŸ¯é‡ŒåŒ–ä¹Ÿæ˜¯ä¸€ç§å‡½æ•°é¢„åŠ è½½çš„æ–¹æ³•ï¼Œé€šè¿‡ä¼ é€’è¾ƒå°‘çš„å‚æ•°å¾—åˆ°ä¸€ä¸ªåœ¨ç›¸åŒè¯æ³•ä½œç”¨åŸŸå½“ä¸­ç¼“å­˜äº†è¿™äº›å‚æ•°çš„æ–°å‡½æ•°ï¼Œå…¶å®è¿™ä¹Ÿæ˜¯ä¸€ç§å¯¹å‚æ•°çš„ç¼“å­˜</li></ol><h3 id="å¦‚ä½•æŸ¯é‡ŒåŒ–"><a href="#å¦‚ä½•æŸ¯é‡ŒåŒ–" class="headerlink" title="å¦‚ä½•æŸ¯é‡ŒåŒ–"></a>å¦‚ä½•æŸ¯é‡ŒåŒ–</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// æ™®é€š</span><span class="token keyword">const</span> sayName <span class="token operator">=</span> name <span class="token operator">=</span><span class="token operator">></span> age <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, Im years old </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">;</span><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> age <span class="token operator">=</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// åˆ©ç”¨bind</span><span class="token keyword">function</span> person <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I,m years old </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, my height is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>height<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> meters`</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">let</span> info <span class="token operator">=</span> person<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">175</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æŸ¯é‡ŒåŒ–å‡½æ•°çš„åº”ç”¨åœºæ™¯"><a href="#æŸ¯é‡ŒåŒ–å‡½æ•°çš„åº”ç”¨åœºæ™¯" class="headerlink" title="æŸ¯é‡ŒåŒ–å‡½æ•°çš„åº”ç”¨åœºæ™¯"></a>æŸ¯é‡ŒåŒ–å‡½æ•°çš„åº”ç”¨åœºæ™¯</h3><ol><li>å»¶è¿Ÿè®¡ç®—</li><li>å‚æ•°å¤ç”¨</li><li>åŠ¨æ€åˆ›å»ºå‡½æ•°</li></ol><p>å»¶è¿Ÿè®¡ç®—<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// æ™®é€šå®ç°</span><span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> a<span class="token operator">+</span>b  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 15</span><span class="token comment" spellcheck="true">// æŸ¯é‡ŒåŒ–å®ç°</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> adder <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// åˆ©ç”¨é—­åŒ…ç‰¹æ€§ä¿å­˜_argsçš„å€¼</span>      <span class="token keyword">var</span> _adder <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_args<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> _adder<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// åˆ©ç”¨éšå¼è½¬æ¢çš„ç‰¹æ€§ï¼Œè®¡ç®—æœ€ç»ˆçš„å€¼è¿”å›</span>      _adder<span class="token punctuation">.</span>toString <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> _args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> _adder<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> adder<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 15</span>ä¼˜ç‚¹ï¼šè°ƒç”¨çµæ´»ï¼Œå‚æ•°å®šä¹‰éšæ„å……åˆ†åˆ©ç”¨äº†æŸ¯é‡ŒåŒ–æå»¶è¿Ÿæ‰§è¡Œçš„ç‰¹ç‚¹å»¶è¿Ÿæ‰§è¡Œ â€“ è¿”å›æ–°å‡½æ•°å¯ä»¥è¿›è¡Œä»»æ„è°ƒç”¨<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>DOMæ“ä½œä¸­çš„äº‹ä»¶ç»‘å®š(åŠ¨æ€åˆ›å»ºå‡½æ•°)<br><br>å½“åœ¨å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”ä¼ é€’çš„å‚æ•°ç»å¤§å¤šæ•°æ˜¯ç›¸åŒçš„ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// æ™®é€šç‰ˆæœ¬</span><span class="token keyword">var</span> addEvent <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> capture<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>      el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> capture<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>      el<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">"on"</span> <span class="token operator">+</span> type<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// æŸ¯é‡ŒåŒ–ç‰ˆæœ¬</span> <span class="token keyword">var</span> addEvent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> capture<span class="token punctuation">)</span> <span class="token punctuation">{</span>        el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>          fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>capture<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> capture<span class="token punctuation">)</span> <span class="token punctuation">{</span>        el<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">"on"</span> <span class="token operator">+</span> type<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ä¼˜ç‚¹ï¼šä¸ç”¨æ¯æ¬¡è°ƒç”¨è¿›è¡Œ <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> åˆ¤æ–­å…¼å®¹æ€§é—®é¢˜å……åˆ†åˆ©ç”¨äº†æŸ¯é‡ŒåŒ–æå‰è¿”å›å’Œå»¶è¿Ÿæ‰§è¡Œçš„ç‰¹ç‚¹æå‰è¿”å› â€“ ä½¿ç”¨å‡½æ•°ç«‹å³è°ƒç”¨è¿›è¡Œäº†ä¸€æ¬¡å…¼å®¹åˆ¤æ–­ï¼ˆéƒ¨åˆ†æ±‚å€¼ï¼‰ï¼Œè¿”å›å…¼å®¹çš„äº‹ä»¶ç»‘å®šæ–¹æ³•å»¶è¿Ÿæ‰§è¡Œ â€“ è¿”å›æ–°å‡½æ•°ï¼Œåœ¨æ–°å‡½æ•°è°ƒç”¨å…¼å®¹çš„äº‹ä»¶æ–¹æ³•ã€‚ç­‰å¾…addEventæ–°å‡½æ•°è°ƒç”¨ï¼Œå»¶è¿Ÿæ‰§è¡Œ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ç„¶åº”ç”¨åœºæ™¯è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚æˆ‘ä»¬ç»å¸¸æåˆ°çš„é˜²æŠ–å’ŒèŠ‚æµé—®é¢˜ï¼Œå……åˆ†çš„åˆ©ç”¨äº†å‡½æ•°å¼ç¼–ç¨‹çš„å»¶è¿Ÿæ‰§è¡Œç‰¹æ€§ï¼Œå°†å¤šä¸ªé—´éš”æ¥è¿‘çš„å‡½æ•°æ‰§è¡Œåˆå¹¶æˆä¸€æ¬¡å‡½æ•°æ‰§è¡Œæ¥æé«˜æ€§èƒ½é—®é¢˜ã€‚<br><br>å…³äºäº‹ä»¶èŠ‚æµå’Œé˜²æŠ–åŠ¨å°†ä¼šåœ¨åç»­çš„ä¸“é¢˜ä¸­å•ç‹¬æŒ‡å‡º<br></p>]]></content>
      
      
      <categories>
          
          <category> å‡½æ•°å¼ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‡½æ•°å¼ç¼–ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tsconfig.json</title>
      <link href="/2019/07/15/typescript/tsconfig/"/>
      <url>/2019/07/15/typescript/tsconfig/</url>
      
        <content type="html"><![CDATA[<p>## </p><p>å¦‚æœä¸€ä¸ªç›®å½•ä¸‹å­˜åœ¨ä¸€ä¸ªtsconfig.jsonæ–‡ä»¶ï¼Œå®ƒä¼šæŠŠä¸€ä¸ªæ–‡ä»¶å¤¹è½¬æ¢ä¸ºé¡¹ç›®ï¼Œä¹Ÿæ„å‘³ç€è¿™ä¸ªç›®å½•æ˜¯TypeScripté¡¹ç›®çš„æ ¹ç›®å½•</p><h3 id="ä½¿ç”¨tsconfig-json"><a href="#ä½¿ç”¨tsconfig-json" class="headerlink" title="ä½¿ç”¨tsconfig.json"></a>ä½¿ç”¨tsconfig.json</h3><p>åˆå§‹åŒ– tsconfig.json æˆ–è€…æ‰‹åŠ¨å»ºç«‹æ–‡ä»¶tsconfig.json</p><pre><code>tsc --init</code></pre><p>å¦‚æœé¡¹ç›®é…ç½®äº†tsconfig.jsonï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œè½¬æ¢çš„æ—¶å€™å¯ä»¥åœ¨å‘½ä»¤è¡Œç›´æ¥è¾“å…¥</p><pre><code>tsc </code></pre><p>ç¼–è¯‘å™¨ä¼šä»å½“å‰ç›®å½•å¼€å§‹å»æŸ¥æ‰¾tsconfig.jsonæ–‡ä»¶ï¼Œé€çº§å‘ä¸Šæœç´¢çˆ¶ç›®å½•</p><p>å¦åˆ™å°±éœ€è¦åœ¨ç¼–è¯‘æ—¶åŠ ä¸Šæ–‡ä»¶åŠç›®å½•</p><pre><code>tsc test.ts</code></pre><p>é»˜è®¤åœ¨å½“å‰ç›®å½•ç”Ÿæˆtest.js</p><h3 id="ç¼–å†™éœ€è¦çš„é…ç½®é¡¹"><a href="#ç¼–å†™éœ€è¦çš„é…ç½®é¡¹" class="headerlink" title="ç¼–å†™éœ€è¦çš„é…ç½®é¡¹"></a>ç¼–å†™éœ€è¦çš„é…ç½®é¡¹</h3><p>ä¸‹é¢è¿™ä¸ªä¾‹å­æ˜¯åˆ—ä¸¾äº†åœ¨é¡¹ç›®ä¸­ç»å¸¸ç”¨åˆ°çš„é…ç½®ï¼Œå½“å‰æ ¹æ®é¡¹ç›®çš„ä¸åŒä¼šæœ‰åŒºåˆ«</p><pre><code>{  &quot;compileOnSave&quot;: true, //è®©IDEåœ¨ä¿å­˜æ–‡ä»¶çš„æ—¶å€™æ ¹æ®tsconfig.jsoné‡æ–°ç”Ÿæˆæ–‡ä»¶  &quot;compilerOptions&quot;: {    &quot;target&quot;: &quot;ES5&quot;, // ç›®æ ‡ä»£ç ç±»å‹ç‰ˆæœ¬    &quot;outDir&quot;:&quot;build/&quot;, // é‡å®šå‘è¾“å‡ºç›®å½•    &quot;baseUrl&quot;:  &quot;https://test.file.com&quot;, // è§£æéç›¸å¯¹æ¨¡å—åçš„åŸºå‡†ç›®å½•    &quot;noImplicitAny&quot;:true, // åœ¨è¡¨è¾¾å¼å’Œå£°æ˜ä¸Šæœ‰éšå«çš„&#39;any&#39;ç±»å‹æ—¶æŠ¥é”™    &quot;removeComments&quot;:true, //ç¼–è¯‘ js çš„æ—¶å€™ï¼Œåˆ é™¤æ‰æ³¨é‡Š    &quot;preserveConstEnums&quot;:true, // ä¿ç•™constå’Œenumå£°æ˜    &quot;experimentalDecorators&quot;: true, // ä½¿ç”¨è£…é¥°å™¨è¦å¼€å§‹æ­¤é€‰é¡¹    &quot;emitDecoratorMetadata&quot;: true, // åœ¨ä½¿ç”¨reflect-metadataåº“æ—¶å€™éœ€è¦æ·»åŠ ï¼Œç»™æºç é‡Œçš„è£…é¥°å™¨å£°æ˜åŠ ä¸Šè®¾è®¡ç±»å‹å…ƒæ•°æ®    &quot;declaration&quot;: true, // ç¼–è¯‘æ—¶å€™æ˜¯å¦åŒæ—¶äº§ç”Ÿä¸€ä»½ å£°æ˜æ–‡ä»¶    &quot;strict&quot;: true, // ç¼–è¯‘æ—¶å¼€å¯ä¸¥æ ¼æ¨¡å¼    &quot;sourceMap&quot;: true, // ç”Ÿæˆç›¸åº”çš„.mapæ–‡ä»¶    &quot;module&quot;: &quot;commonjs&quot;, //ç”Ÿæˆå“ªç§æ¨¡å—ç³»ç»Ÿä»£ç     &quot;watch&quot;: true, //ä¼šåœ¨æ–‡ä»¶æ”¹å˜æ—¶å€™ç›‘è§†è¾“å‡ºæ–‡ä»¶ï¼Œé‡æ–°è¿›è¡Œç¼–è¯‘  },  &quot;include&quot;: [ // ç¼–è¯‘æ—¶åŒ…å«çš„ç›®å½•åŠæ–‡ä»¶    &quot;test.ts&quot;   ],  &quot;exclude&quot;: [ // ç¼–è¯‘æ—¶æ’é™¤çš„ç›®å½•åŠæ–‡ä»¶    &quot;node_modules&quot;,     &quot;dist&quot;,      &quot;mock&quot;    &quot;build&quot;  ],  &quot;lib&quot;: [ // éœ€ç¼–è¯‘è¿‡ç¨‹ä¸­éœ€è¦å¼•å…¥çš„åº“æ–‡ä»¶çš„åˆ—è¡¨ï¼Œä¸ç„¶ç¼–è¯‘å™¨è¯†åˆ«é”™è¯¯æŠ¥é”™    &quot;es2017&quot;,    &quot;dom&quot;  ]}</code></pre><p><em>æ³¨æ„ä½¿ç”¨â€includeâ€å¼•å…¥çš„æ–‡ä»¶å¯ä»¥ä½¿ç”¨â€excludeâ€å±æ€§è¿‡æ»¤ã€‚ ç„¶è€Œï¼Œé€šè¿‡ â€œfilesâ€å±æ€§æ˜ç¡®æŒ‡å®šçš„æ–‡ä»¶ä¸ç®¡â€excludeâ€å¦‚ä½•è®¾ç½®å´æ€»æ˜¯ä¼šè¢«åŒ…å«åœ¨å†…ã€‚ å¦‚æœæ²¡æœ‰ç‰¹æ®ŠæŒ‡å®šï¼Œ â€œexcludeâ€é»˜è®¤æƒ…å†µä¸‹ä¼šæ’é™¤node_modulesï¼Œbower_componentsï¼Œjspm_packageså’ŒoutDirç›®å½•ã€‚</em></p><p>æ›´å¤šå‚æ•°è¯·å‚è€ƒå®˜ç½‘<a href="https://www.tslang.cn/docs/handbook/compiler-options.html" target="_blank" rel="noopener"> tsconfigé…ç½®åˆ—è¡¨ </a></p>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡½æ•°å¼ç¼–ç¨‹-çº¯å‡½æ•°</title>
      <link href="/2019/07/15/javascript/functionalpurity/"/>
      <url>/2019/07/15/javascript/functionalpurity/</url>
      
        <content type="html"><![CDATA[<h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>è¯´çº¯å‡½æ•°æ¦‚å¿µä¹‹å‰æˆ‘ä»¬å†æ¥å¤ä¹ ä¸€ä¸‹ä»€ä¹ˆæ˜¯å‡½æ•°</p><p>å‡½æ•°æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œæœ‰ä¸€äº›è¾“å…¥ï¼Œç§°ä¸ºå˜é‡ï¼Œå¹¶äº§ç”Ÿä¸€äº›è¾“å‡ºç§°ä¸ºè¿”å›å€¼</p><p>å‡½æ•°å¯ä»¥ç”¨äºä»¥ä¸‹ç›®çš„</p><ol><li>æ˜ å°„ï¼šæ ¹æ®ç»™å®šçš„è¾“å…¥ç”Ÿæˆä¸€äº›è¾“å‡ºï¼Œå‡½æ•°å°†è¾“å…¥å€¼æ˜ å°„åˆ°è¾“å‡ºå€¼ä¸Š</li><li>è¿‡ç¨‹ï¼šè°ƒç”¨å‡½æ•°æŒ‰ç…§ä¸€ç³»åˆ—çš„æ­¥éª¤æ¥æ‰§è¡Œã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¯´çš„è¿‡ç¨‹ç¼–ç¨‹</li><li>I/Oï¼šä¸ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†é€šä¿¡çš„åŠŸèƒ½ã€‚å¦‚å­˜å‚¨ç³»ç»Ÿæ—¥å¿—ï¼Œç½‘ç»œç­‰</li></ol><p>çº¯å‡½æ•°éƒ½æ˜¯å…³äºæ˜ å°„çš„æ‰€ä»¥å¯¹äºç›¸åŒçš„è¾“å…¥ï¼Œæ°¸è¿œä¼šå¾—åˆ°ç›¸åŒçš„è¾“å‡ºï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•å¯è§‚å¯Ÿçš„å‰¯ä½œç”¨ï¼Œä¹Ÿä¸ä¾èµ–å¤–éƒ¨ç¯å¢ƒçš„çŠ¶æ€ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// çº¯å‡½æ•°</span><span class="token keyword">const</span> double <span class="token operator">=</span> x <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span>logï¼ˆdoubleï¼ˆ<span class="token number">5</span>ï¼‰ï¼‰<span class="token comment" spellcheck="true">// ä¸çº¯</span><span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">const</span> double <span class="token operator">=</span> x <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">*</span> val<span class="token punctuation">;</span>console<span class="token punctuation">.</span>logï¼ˆdoubleï¼ˆ<span class="token number">5</span>ï¼‰ï¼‰<span class="token comment" spellcheck="true">// ä¸çº¯</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å‡½æ•°å¼ç¼–ç¨‹-çº¯å‡½æ•°"><a href="#å‡½æ•°å¼ç¼–ç¨‹-çº¯å‡½æ•°" class="headerlink" title="å‡½æ•°å¼ç¼–ç¨‹-çº¯å‡½æ•°"></a>å‡½æ•°å¼ç¼–ç¨‹-çº¯å‡½æ•°</h3><p>çº¯å‡½æ•°çš„ä¼˜ç‚¹<br></p><ol><li>ç‹¬ç«‹äºå¤–éƒ¨çŠ¶æ€ï¼Œæ‰€ä»¥ä¸ä¼šå—å¤–éƒ¨å…¨å±€ç¯å¢ƒçš„å½±å“è€Œäº§ç”Ÿçš„é”™è¯¯æˆ–è€…å‰¯ä½œç”¨</li><li>ç”±äºå…¶ç‹¬ç«‹ï¼Œæ‰€ä»¥æ˜“äºé‡æ„å’Œé‡ç»„å’Œé‡ç”¨ï¼Œä½¿ç¨‹åºæ›´åŠ çµæ´»</li></ol><h3 id="å‡½æ•°å¼ç¼–ç¨‹-å¹‚ç­‰æ€§"><a href="#å‡½æ•°å¼ç¼–ç¨‹-å¹‚ç­‰æ€§" class="headerlink" title="å‡½æ•°å¼ç¼–ç¨‹-å¹‚ç­‰æ€§"></a>å‡½æ•°å¼ç¼–ç¨‹-å¹‚ç­‰æ€§</h3><p>æ‰§è¡Œå¤šæ¬¡æ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œä¸€æ¬¡å’Œæ‰§è¡Œå¤šæ¬¡å¯¹ç³»ç»Ÿå†…éƒ¨çš„çŠ¶æ€å½±å“æ˜¯ä¸€æ ·çš„ <br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  sayName <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>my name is <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>zhangsan<span class="token punctuation">)</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="çº¯å‡½æ•°å’Œå¹‚ç­‰æ€§çš„åŒºåˆ«"><a href="#çº¯å‡½æ•°å’Œå¹‚ç­‰æ€§çš„åŒºåˆ«" class="headerlink" title="çº¯å‡½æ•°å’Œå¹‚ç­‰æ€§çš„åŒºåˆ«"></a>çº¯å‡½æ•°å’Œå¹‚ç­‰æ€§çš„åŒºåˆ«</h3><ol><li>æ³•è°ƒç”¨å¤šæ¬¡å¯¹å†…éƒ¨çš„çŠ¶æ€å½±å“æ˜¯ä¸€æ ·çš„ï¼Œåˆ™è¿™ä¹ˆæ–¹æ³•å°±å…·æœ‰å¹‚ç­‰æ€§ï¼Œåœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­ï¼Œçº¯å‡½æ•°ä¹Ÿå…·æœ‰å¹‚ç­‰æ€§ï¼Œä½†å…·æœ‰å¹‚ç­‰æ€§çš„å‡½æ•°å´ä¸ä¸€å®šæ˜¯çº¯å‡½æ•°ã€‚</li><li>çº¯å‡½æ•°ä¸»è¦å¼ºè°ƒç›¸åŒçš„è¾“å…¥ï¼Œå¤šæ¬¡è°ƒç”¨ï¼Œè¾“å‡ºä¹Ÿç›¸åŒä¸”æ— å‰¯ä½œç”¨ï¼Œè€Œå¹‚ç­‰ä¸»è¦å¼ºè°ƒå¤šæ¬¡è°ƒç”¨ï¼Œå¯¹å†…éƒ¨çš„çŠ¶æ€çš„å½±å“æ˜¯ä¸€æ ·çš„ï¼Œè°ƒç”¨è¿”å›å€¼å¯èƒ½ä¸åŒã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> å‡½æ•°å¼ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‡½æ•°å¼ç¼–ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡½æ•°å¼ç¼–ç¨‹-åŸºæœ¬ç†è®º</title>
      <link href="/2019/07/12/javascript/functionalbase/"/>
      <url>/2019/07/12/javascript/functionalbase/</url>
      
        <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹"><a href="#ä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹" class="headerlink" title="ä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹"></a>ä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹</h3><p>å‡½æ•°å¼ç¼–ç¨‹ä¸»è¦æ˜¯èŒƒç•´è®ºæ•°å­¦ä¸­çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒè®¤ä¸ºæ‰€æœ‰çš„æ¦‚å¿µä½“ç³»éƒ½å¯ä»¥æŠ½è±¡æˆä¸€ä¸ªä¸ªèŒƒç•´ï¼Œå±äºç»“æ„åŒ–ç¼–ç¨‹çš„ä¸€ç§ã€‚è¿ç®—è¿‡ç¨‹å°½é‡å†™æˆä¸€ç³»åˆ—åµŒå¥—çš„å‡½æ•°è°ƒç”¨ <br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//  å‡½æ•°å¼ç¼–ç¨‹</span><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">subtract</span><span class="token punctuation">(</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è¿‡ç¨‹ç¼–ç¨‹</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">multiply</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">subtract</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸ºä»€ä¹ˆå­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹"><a href="#ä¸ºä»€ä¹ˆå­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹" class="headerlink" title="ä¸ºä»€ä¹ˆå­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹"></a>ä¸ºä»€ä¹ˆå­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹</h3><p>å…¶å®ä¸ªäººè§‰çš„å­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹å°±æ˜¯ä¸ºäº†æ›´å¥½çš„æ¨¡å—åŒ–ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´ç®€æ´ã€‚è¿™ä¹Ÿæ˜¯<a href="http://en.wikipedia.org/wiki/Programming_paradigm" target="_blank" rel="noopener">èŒƒå¼ç¼–ç¨‹</a>å’Œ<a href="http://en.wikipedia.org/wiki/Structured_programming" target="_blank" rel="noopener">ç»“æ„åŒ–ç¼–ç¨‹</a>çš„ä¸»è¦æ€æƒ³</p><h3 id="å‡½æ•°å¼ç¼–ç¨‹ç‰¹ç‚¹"><a href="#å‡½æ•°å¼ç¼–ç¨‹ç‰¹ç‚¹" class="headerlink" title="å‡½æ•°å¼ç¼–ç¨‹ç‰¹ç‚¹"></a>å‡½æ•°å¼ç¼–ç¨‹ç‰¹ç‚¹</h3><ol><li>å‡½æ•°æ˜¯â€ç¬¬ä¸€ç­‰å…¬æ°‘â€</li><li>åªç”¨è¡¨è¾¾å¼ï¼Œä¸ç”¨è¯­å¥</li><li>æ²¡æœ‰å‰¯ä½œç”¨ï¼ˆå‡½æ•°è¦ä¿æŒç‹¬ç«‹ï¼Œæ‰€æœ‰åŠŸèƒ½å°±æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„å€¼ï¼Œæ²¡æœ‰å…¶ä»–è¡Œä¸ºï¼Œæ›´ä¸èƒ½ä¿®æ”¹å¤–éƒ¨çŠ¶æ€çš„å€¼ï¼‰</li><li>ä¸ä¿®æ”¹çŠ¶æ€ï¼ˆå¯ä»¥ä½¿ç”¨å‚æ•°æ¥ä¿å­˜çŠ¶æ€ï¼Œä¸å¯ä»¥ä½¿ç”¨å˜é‡æ¥ä¿å­˜çŠ¶æ€ï¼‰</li><li>å¼•ç”¨é€æ˜ï¼ˆå‡½æ•°è¿è¡Œåªé å‚æ•°ï¼‰</li></ol><h3 id="å‡½æ•°å¼ç¼–ç¨‹çš„ä¼˜ç‚¹"><a href="#å‡½æ•°å¼ç¼–ç¨‹çš„ä¼˜ç‚¹" class="headerlink" title="å‡½æ•°å¼ç¼–ç¨‹çš„ä¼˜ç‚¹"></a>å‡½æ•°å¼ç¼–ç¨‹çš„ä¼˜ç‚¹</h3><ol><li>ä»£ç æ›´ç®€æ´ï¼Œæ˜“äºç†è§£ï¼Œç»´æŠ¤æ›´æ–¹ä¾¿</li><li>æ˜“äºå¹¶å‘ç¼–ç¨‹ï¼ˆç”±äºä¸ä¿®æ”¹å˜é‡æ‰€ä»¥ä¸å­˜åœ¨é”çº¿ç¨‹çš„é—®é¢˜ï¼‰</li><li>ä»£ç çš„çƒ­å‡çº§</li></ol>]]></content>
      
      
      <categories>
          
          <category> å‡½æ•°å¼ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‡½æ•°å¼ç¼–ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mixinx</title>
      <link href="/2019/07/02/typescript/mixinx/"/>
      <url>/2019/07/02/typescript/mixinx/</url>
      
        <content type="html"><![CDATA[<p> ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†ç”¨é¢å‘å¯¹è±¡çš„ç»§æ‰¿æ–¹å¼ï¼Œæ¯”å¦‚åœ¨ JS ES5ä¸­ç”¨ prototypeï¼Œ åœ¨ ES6 å’Œ TS ä¸­ ç”¨extends,ç„¶è€Œç”¨ mixinx ä¹Ÿæ˜¯ä¸€ç§é€šè¿‡å¯é‡ç”¨ç»„ä»¶åˆ›å»ºç±»çš„æ–¹å¼ï¼Œæ¥è¿›è¡Œæ··ç”¨ï¼Œæ··åˆå¤šä¸ªç±»çš„æ–¹æ³•åˆ°ä¸€ä¸ªç±»ä¸Š</p><h3 id="åº”ç”¨ä¾‹å­"><a href="#åº”ç”¨ä¾‹å­" class="headerlink" title="åº”ç”¨ä¾‹å­"></a>åº”ç”¨ä¾‹å­</h3><pre><code>// Disposable Mixinclass Disposable {    isDisposed!: boolean;    dispose() {    console.log(this.isDisposed);    }}// Activatable Mixinclass Activatable {    isActive!: boolean;    activate() {       console.log(this.isActive)    }}// æ²¡ä½¿ç”¨ extends è€Œæ˜¯ä½¿ç”¨ implementsclass SmartObject implements Disposable,Activatable {    // Disposable    isDisposed: boolean = false;    dispose!: () =&gt; void;    // Activatable    isActive: boolean = false;    activate!: () =&gt; void;}// mixinsæ··å…¥å®šä¹‰çš„ç±»ï¼Œå®Œæˆå…¨éƒ¨å®ç°éƒ¨åˆ†applyMixins(SmartObject, [Disposable, Activatable]);// åˆ›å»º applyMixins æ··ç”¨å‡½æ•°ï¼Œä½œç”¨æ˜¯éå†mixinsä¸Šçš„æ‰€æœ‰å±æ€§ï¼Œå¹¶å¤åˆ¶åˆ°ç›®æ ‡ä¸Šå»ï¼ŒæŠŠä¹‹å‰çš„å ä½å±æ€§æ›¿æ¢æˆçœŸæ­£çš„å®ç°ä»£ç ã€‚function applyMixins(derivedCtor: any, baseCtors: any[]) {    baseCtors.forEach(baseCtor =&gt; {        Object.getOwnPropertyNames(baseCtor.prototype).forEach(name =&gt; {            derivedCtor.prototype[name] = baseCtor.prototype[name];        });    });}let smartObject = new SmartObject()smartObject.dispose() // falsesmartObject.activate() // false</code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å£°æ˜æ–‡ä»¶</title>
      <link href="/2019/06/20/typescript/declarefile/"/>
      <url>/2019/06/20/typescript/declarefile/</url>
      
        <content type="html"><![CDATA[<h2 id="å£°æ˜æ–‡ä»¶"><a href="#å£°æ˜æ–‡ä»¶" class="headerlink" title="å£°æ˜æ–‡ä»¶"></a>å£°æ˜æ–‡ä»¶</h2><h3 id="è¯†åˆ«åº“çš„ç±»å‹"><a href="#è¯†åˆ«åº“çš„ç±»å‹" class="headerlink" title="è¯†åˆ«åº“çš„ç±»å‹"></a>è¯†åˆ«åº“çš„ç±»å‹</h3><p>å…¨å±€åº“(å…¨å±€å‘½åç©ºé—´ä¸‹èƒ½è®¿é—®)</p><ul><li>é¡¶çº§çš„varè¯­å¥æˆ–functionå£°æ˜</li><li>ä¸€ä¸ªæˆ–å¤šä¸ªèµ‹å€¼è¯­å¥åˆ°windowä¸Š</li><li>å‡è®¾DOMåŸå§‹å€¼åƒdocumentæˆ–windowæ˜¯å­˜åœ¨çš„</li></ul><pre><code>&lt;script src=&quot;jquery.js&quot;&gt;&lt;/script&gt;window.test = function(){    console.log(&#39;1111&#39;)}</code></pre><p>æ¨¡å—åŒ–åº“ï¼ˆåªèƒ½å·¥ä½œåœ¨æ¨¡å—åŠ è½½å™¨çš„ç¯å¢ƒä¸‹ï¼‰</p><ul><li>æ— æ¡ä»¶çš„è°ƒç”¨requireæˆ–define</li><li>åƒimport * as a from â€˜bâ€™; or export c;è¿™æ ·çš„å£°æ˜</li><li>èµ‹å€¼ç»™exportsæˆ–module.exports</li></ul><p>UMDæ¨¡å—æ˜¯æŒ‡é‚£äº›æ—¢å¯ä»¥ä½œä¸ºæ¨¡å—ä½¿ç”¨ï¼ˆé€šè¿‡å¯¼å…¥ï¼‰åˆå¯ä»¥ä½œä¸ºå…¨å±€ï¼ˆåœ¨æ²¡æœ‰æ¨¡å—åŠ è½½å™¨çš„ç¯å¢ƒé‡Œï¼‰ä½¿ç”¨çš„æ¨¡å—</p><pre><code>import moment = require(&quot;moment&quot;);console.log(moment.format());</code></pre><p>åœ¨æµè§ˆå™¨ç¯å¢ƒå†…ä¹Ÿå¯ä»¥è¿™æ ·ä½¿ç”¨</p><pre><code>console.log(moment.format());</code></pre><p>è¯†åˆ«UMDåº“</p><pre><code>(function (root, factory) {    if (typeof define === &quot;function&quot; &amp;&amp; define.amd) {        define([&quot;libName&quot;], factory);    } else if (typeof module === &quot;object&quot; &amp;&amp; module.exports) {        module.exports = factory(require(&quot;libName&quot;));    } else {        root.returnExports = factory(root.libName);    }}(this, function (b) {}))</code></pre><h3 id="ä½¿ç”¨ä¾èµ–"><a href="#ä½¿ç”¨ä¾èµ–" class="headerlink" title="ä½¿ç”¨ä¾èµ–"></a>ä½¿ç”¨ä¾èµ–</h3><p>ä¾èµ–å…¨å±€åº“</p><pre><code>/// &lt;reference types=&quot;someLib&quot; /&gt;function getThing(): someLib.thing;</code></pre><p>ä¾èµ–æ¨¡å—</p><pre><code>import * as moment from &quot;moment&quot;;function getThing(): moment;</code></pre><p>ä¾èµ–UMDåº“</p><pre><code>// &lt;reference types=&quot;moment&quot; /&gt;function getThing(): moment;</code></pre><p>å¦‚æœä½ çš„æ¨¡å—æˆ–UMDåº“ä¾èµ–äºä¸€ä¸ªUMDåº“</p><p>ä¸è¦ä½¿ç”¨/// &lt;referenceæŒ‡ä»¤å»å£°æ˜UMDåº“çš„ä¾èµ–ï¼</p><pre><code>import * as someLib from &#39;someLib&#39;;</code></pre><h3 id="é˜²æ­¢å‘½åå†²çª"><a href="#é˜²æ­¢å‘½åå†²çª" class="headerlink" title="é˜²æ­¢å‘½åå†²çª"></a>é˜²æ­¢å‘½åå†²çª</h3><p>åœ¨ä¹¦å†™å…¨å±€å£°æ˜æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨åº“å®šä¹‰çš„å…¨å±€å˜é‡åæ¥å£°æ˜å‘½åç©ºé—´ç±»å‹</p><pre><code>declare namespace cats {    interface KittySettings { }}</code></pre><h3 id="å®šä¹‰å…¨å±€åº“æ¨¡ç‰ˆ"><a href="#å®šä¹‰å…¨å±€åº“æ¨¡ç‰ˆ" class="headerlink" title="å®šä¹‰å…¨å±€åº“æ¨¡ç‰ˆ"></a>å®šä¹‰å…¨å±€åº“æ¨¡ç‰ˆ</h3><p>æ¨¡ç‰ˆæ–‡ä»¶<a href="global.d.ts.md"> global.d.ts </a>å®šä¹‰äº†myLibåº“ä½œä¸ºä¾‹å­</p><h3 id="å®šä¹‰æ¨¡å—åŒ–åº“æ¨¡ç‰ˆ"><a href="#å®šä¹‰æ¨¡å—åŒ–åº“æ¨¡ç‰ˆ" class="headerlink" title="å®šä¹‰æ¨¡å—åŒ–åº“æ¨¡ç‰ˆ"></a>å®šä¹‰æ¨¡å—åŒ–åº“æ¨¡ç‰ˆ</h3><p>é’ˆå¯¹æ¨¡å—æœ‰ä¸‰ç§å¯ç”¨çš„æ¨¡å—ï¼Œ module.d.ts, module-class.d.ts and module-fun</p><p><a href="module.d.ts.md"> module.d.ts </a> ä½œä¸ºå‡½æ•°è°ƒç”¨</p><pre><code>var x = require(&quot;foo&quot;);// Note: calling &#39;x&#39; as a functionvar y = x(42);</code></pre><p><a href="module-class.d.ts.md">module-class.d.ts </a>ä½¿ç”¨newæ¥æ„é€ è°ƒç”¨</p><pre><code>var x = require(&quot;bar&quot;);// Note: using &#39;new&#39; operator on the imported variablevar y = new x(&quot;hello&quot;);</code></pre><p>å¦‚æœæ¨¡å—ä¸èƒ½è¢«è°ƒç”¨æˆ–æ„é€ ï¼Œä½¿ç”¨<a href="module.d.ts.md"> module.d.ts </a>æ–‡ä»¶</p><h3 id="ä½¿ç”¨åº“"><a href="#ä½¿ç”¨åº“" class="headerlink" title="ä½¿ç”¨åº“"></a>ä½¿ç”¨åº“</h3><p>åœ¨TypeScript 2.0ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œè·å–ç±»å‹å£°æ˜æ–‡ä»¶åªéœ€è¦ä½¿ç”¨npmã€‚</p><pre><code>npm install --save @types/lodashimport * as _ from &quot;lodash&quot;;_.padStart(&quot;Hello TypeScript!&quot;, 20, &quot; &quot;);</code></pre><p>å¦‚æœnpmåŒ…æ²¡æœ‰åŒ…å«å®ƒçš„å£°æ˜æ–‡ä»¶ï¼Œé‚£å°±å¿…é¡»ä¸‹è½½ç›¸åº”çš„@typesåŒ…</p><p>å¤§å¤šæ•°ç±»å‹å£°æ˜åŒ…çš„åå­—æ€»æ˜¯ä¸å®ƒä»¬åœ¨npmä¸Šçš„åŒ…çš„åå­—ç›¸åŒï¼Œä½†æ˜¯æœ‰@types/å‰ç¼€</p><p>æŸ¥æ‰¾æ›´å¤štypeScript åº“è¯·å‰å¾€ <a href="https://aka.ms/types" target="_blank" rel="noopener">https://aka.ms/types</a></p>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¨¡å—ä¸å‘½åç©ºé—´</title>
      <link href="/2019/06/15/typescript/module/"/>
      <url>/2019/06/15/typescript/module/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ JS ä¸­ æœ‰ module æ¨¡å—æœºåˆ¶ï¼Œå’Œ TS ç±»ä¼¼ï¼Œåœ¨ TS ä¸­å†…éƒ¨æ¨¡å—å‘½åç©ºé—´ä¸ºå…³é”®å­—namespacesã€‚å¤–éƒ¨æ¨¡å—ç°åœ¨åªæ˜¯modules</p><h3 id="ä½¿ç”¨å‘½åç©ºé—´"><a href="#ä½¿ç”¨å‘½åç©ºé—´" class="headerlink" title="ä½¿ç”¨å‘½åç©ºé—´ "></a>ä½¿ç”¨å‘½åç©ºé—´ <br></h3><ul><li>å‘½åç©ºé—´åªæ˜¯å…¨å±€å‘½åç©ºé—´ä¸­çš„JavaScriptå¯¹è±¡</li><li>ä½¿ç”¨ namespace å…³é”®å­—</li><li>è·¨å¤šä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨è¿æ¥â€“outFile</li><li>ä¸ä½¿ç”¨requireå…³é”®å­—</li></ul><p><strong>1.å•æ–‡ä»¶å‘½åç©ºé—´</strong></p><pre><code>  namespace Validation {    export interface StringValidator {      isAcceptable(s: string): boolean;    }    const lettersRegexp = /^[A-Za-z]+$/;    const numberRegexp = /^[0-9]+$/;    export class LettersOnlyValidator implements StringValidator {        isAcceptable(s: string) {            return lettersRegexp.test(s);        }    }    export class ZipCodeValidator implements StringValidator {        isAcceptable(s: string) {            return s.length === 5 &amp;&amp; numberRegexp.test(s);        }    }  }</code></pre><p><strong>2.å¤šæ–‡ä»¶å‘½åç©ºé—´åŠå¼•å…¥</strong></p><p>Validation.ts</p><pre><code>namespace Validation {  export interface StringValidator {    isAcceptable(s: string): boolean;  }}</code></pre><p>LettersOnlyValidator.ts</p><pre><code>/// &lt;reference path=&quot;Validation.ts&quot; /&gt;namespace Validation {    const lettersRegexp = /^[A-Za-z]+$/;    export class LettersOnlyValidator implements StringValidator {        isAcceptable(s: string) {            return lettersRegexp.test(s);        }    }}</code></pre><p>ZipCodeValidator.ts</p><pre><code>/// &lt;reference path=&quot;Validation.ts&quot; /&gt;namespace Validation {    const numberRegexp = /^[0-9]+$/;    export class ZipCodeValidator implements StringValidator {        isAcceptable(s: string) {            return s.length === 5 &amp;&amp; numberRegexp.test(s);        }    }}</code></pre><p>Test.ts</p><pre><code>/// &lt;reference path=&quot;Validation.ts&quot; /&gt;/// &lt;reference path=&quot;LettersOnlyValidator.ts&quot; /&gt;/// &lt;reference path=&quot;ZipCodeValidator.ts&quot; /&gt;// Some samples to trylet strings = [&quot;Hello&quot;, &quot;98052&quot;, &quot;101&quot;];// Validators to uselet validators: { [s: string]: Validation.StringValidator; } = {};validators[&quot;ZIP code&quot;] = new Validation.ZipCodeValidator();validators[&quot;Letters only&quot;] = new Validation.LettersOnlyValidator();// Show whether each string passed each validatorfor (let s of strings) {  for (let name in validators) {    console.log(`&quot;${ s }&quot; - ${ validators[name].isAcceptable(s) ? &quot;matches&quot; : &quot;does not match&quot; } ${ name }`);  }}</code></pre><p>æ¶‰åŠå¤šä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åŠ è½½æ‰€æœ‰å·²ç¼–è¯‘çš„ä»£ç ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><ol><li><strong>â€“outFile ç¼–è¯‘å™¨å°†æ ¹æ®æ–‡ä»¶ä¸­å­˜åœ¨çš„å¼•ç”¨æ ‡è®°è‡ªåŠ¨æ’åºè¾“å‡ºæ–‡ä»¶</strong><pre><code>tsc --outFile sample.js Test.ts</code></pre></li><li><strong>ä¸ºæ¯ä¸€ä¸ªæ–‡ä»¶ç¼–è¯‘ä¸€ä¸ª JS æ–‡ä»¶åˆ©ç”¨ Script æŒ‰ç…§é¡ºåºå¼•å…¥</strong><pre><code>&lt;script src=&quot;Validation.js&quot; type=&quot;text/javascript&quot; /&gt;&lt;script src=&quot;LettersOnlyValidator.js&quot; type=&quot;text/javascript&quot; /&gt;&lt;script src=&quot;ZipCodeValidator.js&quot; type=&quot;text/javascript&quot; /&gt;&lt;script src=&quot;Test.js&quot; type=&quot;text/javascript&quot; /&gt;</code></pre></li></ol><h3 id="ä½¿ç”¨æ¨¡å—"><a href="#ä½¿ç”¨æ¨¡å—" class="headerlink" title="ä½¿ç”¨æ¨¡å— "></a>ä½¿ç”¨æ¨¡å— <br></h3><ul><li>æ¨¡å—åœ¨è‡ªå·±çš„èŒƒå›´å†…æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨å…¨å±€èŒƒå›´å†…æ‰§è¡Œ</li><li>æ¨¡å—ä¸­å£°æ˜çš„å˜é‡ï¼Œå‡½æ•°ï¼Œç±»ç­‰åœ¨æ¨¡å—å¤–éƒ¨ä¸å¯è§,é™¤éä½¿ç”¨å…¶ä¸­ä¸€ä¸ªexportæ˜¾å¼å¯¼å‡º</li><li>æ¨¡å—æ˜¯å£°æ˜æ€§çš„; æ¨¡å—ä¹‹é—´çš„å…³ç³»æ˜¯æ ¹æ®æ–‡ä»¶çº§åˆ«çš„å¯¼å…¥å’Œå¯¼å‡ºæ¥æŒ‡å®šçš„</li><li>æ¨¡å—æ–‡ä»¶ä¹‹é—´å¼•ç”¨ç”¨å…³é”®å­— import æˆ–è¢« export</li></ul><p><strong>1.ä½¿ç”¨ export å…³é”®å­—æ¥å¯¼å‡ºå£°æ˜</strong></p><p>å•æ¨¡å—å¯¼å‡º</p><pre><code>export interface StringValidator {  isAcceptable(s: string): boolean;}</code></pre><p>é‡å‘½åå¯¼å‡º</p><pre><code>class ZipCodeValidator implements StringValidator {  isAcceptable(s: string) {    return s.length === 5 &amp;&amp; numberRegexp.test(s);  }}export { ZipCodeValidator };export { ZipCodeValidator as mainValidator };</code></pre><p>å¯¼å‡ºæ‰€æœ‰æ¨¡å—</p><pre><code>export * from &quot;./StringValidator&quot;;export * from &quot;./ZipCodeValidator&quot;;</code></pre><p><strong>2.ä½¿ç”¨ import å…³é”®å­—æ¥å¯¼å…¥å£°æ˜</strong></p><p>ä»æ¨¡å—å¯¼å…¥å•ä¸ªå¯¼å‡º</p><pre><code>import { ZipCodeValidator } from &quot;./ZipCodeValidator&quot;;let myValidator = new ZipCodeValidator();</code></pre><p>é‡å‘½åå¯¼å…¥</p><pre><code>import { ZipCodeValidator as ZCV } from &quot;./ZipCodeValidator&quot;;let myValidator = new ZCV();</code></pre><p>å°†æ•´ä¸ªæ¨¡å—å¯¼å…¥å•ä¸ªå˜é‡ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥è®¿é—®æ¨¡å—å¯¼å‡º</p><pre><code>import * as validator from &quot;./ZipCodeValidator&quot;;let myValidator = new validator.ZipCodeValidator();</code></pre><p>ä»…ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶</p><pre><code>import &quot;./my-module.js&quot;;</code></pre><p><strong>3.æ¨¡å—çš„ä»£ç ç”Ÿæˆ</strong></p><p>ç¼–è¯‘å™¨å°†ä¸ºNode.jsï¼ˆCommonJSï¼‰ï¼Œrequire.jsï¼ˆAMDï¼‰ï¼ŒUMDï¼ŒSystemJSæˆ–ECMAScript 2015æœ¬æœºæ¨¡å—ï¼ˆES6ï¼‰æ¨¡å—åŠ è½½ç³»ç»Ÿç”Ÿæˆé€‚å½“çš„ä»£ç </p><p>ç¼–è¯‘ commonjs è§„èŒƒ</p><pre><code>tsc --module commonjs Test.ts</code></pre><p>ç¼–è¯‘ amd è§„èŒƒ</p><pre><code>tsc --module amd Test.ts</code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>promise</title>
      <link href="/2019/06/11/javascript/promise/"/>
      <url>/2019/06/11/javascript/promise/</url>
      
        <content type="html"><![CDATA[<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦æ˜¯å®ç° Promise çš„åŸç†, å…·ä½“ API ç”¨æ³•ä¸åœ¨æœ¬æ–‡ä¸­åšä»‹ç»ã€‚å¯ä»¥æŸ¥çœ‹é˜®ä¸€å³°è€å¸ˆçš„ <a href="http://es6.ruanyifeng.com/#docs/promise" target="_blank" rel="noopener">ES6 Promiseæ•™ç¨‹</a><br></p><p>å®ç° Promise é¦–å…ˆè¦çŸ¥é“å®ƒçš„æ‰§è¡Œç‰¹ç‚¹<br></p><ol><li>Promise æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæ¥å—å‡½æ•°ä½œä¸ºå‚æ•°(resolve(),reject()) </li><li>Promise å¯¹è±¡æœ‰ä¸‰ç§çŠ¶æ€ pending(è¿›è¡Œä¸­), fulfilled(æˆåŠŸ), rejected(å¤±è´¥)</li><li>Promise ä» pending å˜ä¸º fulfilled è¿‡ç¨‹æ˜¯æˆåŠŸçš„è¿‡ç¨‹å¯ä»¥æ‰§è¡Œå›è°ƒå‡½æ•° resolve() </li><li>Promise ä» pending å˜ä¸º rejected è¿‡ç¨‹æ˜¯å¤±è´¥çš„è¿‡ç¨‹å¯ä»¥æ‰§è¡Œå›è°ƒå‡½æ•° reject()</li><li>Promise çŠ¶æ€æ— æ³•ä¸­é€”å–æ¶ˆï¼Œä¸€æ—¦å»ºç«‹ç«‹å³æ‰§è¡Œï¼Œä¼šä¸€ç›´ä¿æŒè¿™ä¸ªç»“æœï¼Œè¿™æ—¶ä¹Ÿå« resolved(å·²å®šå‹çŠ¶æ€)</li><li>Promise çŠ¶æ€æ”¹å˜æ—¶ then æ–¹æ³•æ”¯æŒå¤šæ¬¡é“¾å¼è°ƒç”¨ </li><li>Promise å¦‚æœä¸è®¾ç½®å›è°ƒå‡½æ•°å†…éƒ¨ä¼šæŠ›å¼‚å¸¸</li></ol><h3 id="å®šä¹‰æ„é€ å‡½æ•°"><a href="#å®šä¹‰æ„é€ å‡½æ•°" class="headerlink" title="å®šä¹‰æ„é€ å‡½æ•°"></a>å®šä¹‰æ„é€ å‡½æ•°</h3><p>æ„é€ å‡½æ•° Promise å¿…é¡»æ¥å—å‡½æ•°ä½œä¸ºå‚æ•°</p><ol><li>å®šä¹‰æ„é€ å‡½æ•°</li><li>åˆ¤æ–­ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸ºå‡½æ•°</li></ol><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * å°è£…åˆ¤æ–­å‚æ•°æ˜¯å¤Ÿæ˜¯å‡½æ•° */</span><span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * å®šä¹‰æ„é€ å‡½æ•° * @param {*} fn  */</span><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®šä¹‰-resolve"><a href="#å®šä¹‰-resolve" class="headerlink" title="å®šä¹‰ resolve"></a>å®šä¹‰ resolve</h3><p>åœ¨å†…éƒ¨å®šä¹‰ resolve æ–¹æ³•ä½œä¸ºå‚æ•°ä¼ åˆ° fn ä¸­ï¼Œfn è°ƒç”¨æˆåŠŸåä¼šè°ƒç”¨ resolve æ–¹æ³•ï¼Œä¹‹ååœ¨æ‰§è¡Œ then ä¸­æ³¨å†Œçš„å›è°ƒå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * å®šä¹‰æ„é€ å‡½æ•° * @param {*} fn  */</span><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æ˜¯å‡½æ•°</span>  <span class="token keyword">var</span> _isFunction <span class="token operator">=</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯å‡½æ•°æŠ›å‡ºå¼‚å¸¸</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å®šä¹‰å›è°ƒçŠ¶æ€</span>  <span class="token keyword">var</span> __callback  <span class="token keyword">this</span><span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>    __callback <span class="token operator">=</span> status  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å®šä¹‰ resolve å‡½æ•°ä¼ å…¥æˆåŠŸçš„æ•°æ®</span>  <span class="token keyword">function</span> resolve <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">__callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒç”¨ä¾‹å­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> request <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"renbo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// è¾“å‡º</span>renbosuccess<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å·²ç»ç®€å•çš„å®ç°äº† promise çš„åŸºç¡€å›è°ƒï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å®Œæˆé“¾å¼è¯­æ³•è°ƒç”¨ä»¥åŠthené˜Ÿåˆ—ç®¡ç†</p><h3 id="é“¾å¼è¯­æ³•åŠé˜Ÿåˆ—ç®¡ç†"><a href="#é“¾å¼è¯­æ³•åŠé˜Ÿåˆ—ç®¡ç†" class="headerlink" title="é“¾å¼è¯­æ³•åŠé˜Ÿåˆ—ç®¡ç†"></a>é“¾å¼è¯­æ³•åŠé˜Ÿåˆ—ç®¡ç†</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Promise <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _isFunction <span class="token operator">=</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>      _value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      _this<span class="token punctuation">.</span>_resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>    _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å°† resolve ä¸­æ‰§ï¨ˆå›è°ƒçš„é€»è¾‘æ”¾ç½®åˆ° JS ä»»åŠ¡é˜Ÿåˆ—ï¦œæœ«å°¾</span>  <span class="token keyword">function</span> resolve <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _value <span class="token operator">=</span> val        <span class="token function">callback</span><span class="token punctuation">(</span>_value<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  fn <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åŠ å…¥çŠ¶æ€å¹¶ä¸²è¡ŒPromise"><a href="#åŠ å…¥çŠ¶æ€å¹¶ä¸²è¡ŒPromise" class="headerlink" title="åŠ å…¥çŠ¶æ€å¹¶ä¸²è¡ŒPromise"></a>åŠ å…¥çŠ¶æ€å¹¶ä¸²è¡ŒPromise</h3><p>Promise å¯¹è±¡æœ‰ä¸‰ç§çŠ¶æ€ <br></p><ol><li>pending(è¿›è¡Œä¸­) ç«‹å³æ‰§è¡Œ</li><li>ä» pending å˜ä¸º fulfilled è¿‡ç¨‹æ˜¯æˆåŠŸçš„è¿‡ç¨‹å¯ä»¥æ‰§è¡Œå›è°ƒå‡½æ•° resolve(â€˜fulfilledâ€™) </li><li>ä» pending å˜ä¸º rejected è¿‡ç¨‹æ˜¯å¤±è´¥çš„è¿‡ç¨‹å¯ä»¥æ‰§è¡Œå›è°ƒå‡½æ•° reject(â€˜rejectedâ€™)</li></ol><p><code>promsieçŠ¶æ€ åªèƒ½ç”± pending =&gt; fulfilled/rejected, ä¸€æ—¦ä¿®æ”¹å°±ä¸èƒ½å†å˜</code></p><p>æˆ‘ä»¬åŠ å…¥ä¸Šé¢çš„çŠ¶æ€å¹¶ä¸²è¡ŒPromise</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Promise <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> _isFunction <span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>      _val <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      _this<span class="token punctuation">.</span>_resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// handle å‡½æ•°å¯¹ä¸Šä¸€ä¸ª promise çš„ then ä¸­å›è°ƒè¿›ï¨ˆäº†å¤„ç†ï¼Œå¹¶ä¸”è°ƒç”¨å½“å‰çš„ promise ä¸­çš„ resolve æ–¹æ³•ã€‚</span>      <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span>_val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_val<span class="token punctuation">)</span> <span class="token operator">||</span> _val        <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯â¼€ä¸€ä¸ª promise å¯¹è±¡ï¼Œå°±ä¼šè°ƒâ½¤ then æ–¹æ³•ï¼Œå½¢æˆä¸€ä¸ªåµŒå¥—</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token string">'then'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          ret<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_status <span class="token operator">===</span> <span class="token string">'PENDING'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>promise<span class="token punctuation">.</span>_status <span class="token operator">===</span> <span class="token string">'FULFILLED'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å°† resolve ä¸­æ‰§ï¨ˆå›è°ƒçš„é€»è¾‘æ”¾ç½®åˆ° JS ä»»åŠ¡é˜Ÿåˆ—ï¦œæœ«å°¾</span>  <span class="token keyword">function</span> resolve <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"FULFILLED"</span><span class="token punctuation">;</span>      _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _val <span class="token operator">=</span> val        <span class="token function">callback</span><span class="token punctuation">(</span>_val<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  fn <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é”™è¯¯å¤„ç†reject"><a href="#é”™è¯¯å¤„ç†reject" class="headerlink" title="é”™è¯¯å¤„ç†reject"></a>é”™è¯¯å¤„ç†reject</h3><p>åœ¨å¼‚æ­¥æ“ä½œä¸­ï¼Œæ“ä½œå¯èƒ½å¤±è´¥ï¼Œæ‰§è¡Œå¤±è´¥çš„å›è°ƒå‡½æ•°ï¼Œä¸Šé¢å·²ç»è¯´åˆ°ä» pending å˜ä¸º rejected è¿‡ç¨‹æ˜¯å¤±è´¥çš„è¿‡ç¨‹å¯ä»¥æ‰§è¡Œå›è°ƒå‡½æ•° reject()</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/**   * å·¥å…·å‡½æ•°åˆ¤æ–­æ˜¯å¦æ˜¯ function   * @param {*} func    */</span>  <span class="token keyword">function</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_value<span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_reason<span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_rejects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token string">"PENDING"</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**   * promise thenå›è°ƒ   * @onFulfilled æ‰§è¡ŒæˆåŠŸçŠ¶æ€çš„å¤„ç†å‡½æ•°   * @onRejected æ‰§è¡Œå¤±è´¥çŠ¶æ€å¤„ç†å‡½æ•°   */</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/**       * å¯¹ä¸Šä¸€ä¸ª promise çš„ then ä¸­å›è°ƒè¿›ï¨ˆäº†å¤„ç†       * å¹¶ä¸”è°ƒç”¨å½“å‰çš„ promise ä¸­çš„ resolve æ–¹æ³•       */</span>      <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token string">'then'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          ret<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>            <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token keyword">function</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>          <span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/**       * é”™è¯¯å¤„ç†å›è°ƒå‡½æ•°       */</span>      <span class="token keyword">function</span> <span class="token function">errback</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        reason <span class="token operator">=</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">||</span> reason<span class="token punctuation">;</span>        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/**       * æ ¹æ®å½“å‰å¼‚æ­¥çŠ¶æ€æ‰§è¡Œæ“ä½œ       */</span>      <span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">'PENDING'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>          _this<span class="token punctuation">.</span>_rejects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>errback<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">'FULFILLED'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">'REJECTED'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">errback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_reason<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      config<span class="token punctuation">[</span>_this<span class="token punctuation">.</span>_status<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * æˆåŠŸçš„å›è°ƒå‡½æ•°   * setTimeoutä½œç”¨æ˜¯å°†resolve    * æ‰§ï¨ˆå›è°ƒçš„é€»è¾‘æ”¾ç½®åˆ° JS ä»»åŠ¡é˜Ÿåˆ—ï¦œæœ«å°¾   * é˜²æ­¢thenæ‰§è¡Œåœ¨resolveä¹‹å‰   * @FULFILLED çŠ¶æ€   * @param {*} value    */</span>  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"FULFILLED"</span>      _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>       _this<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * é”™è¯¯å¤„ç†å›è°ƒå‡½æ•°   * @REJECTED çŠ¶æ€   * @param {*} value    */</span>  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token string">"REJECTED"</span>      _this<span class="token punctuation">.</span>_rejects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _this<span class="token punctuation">.</span>_reason <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®ç°Promise-all"><a href="#å®ç°Promise-all" class="headerlink" title="å®ç°Promise.all"></a>å®ç°Promise.all</h3><p>å®ç°Promise.allå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * Promise.all * æ¥æ”¶ä¸€ä¸ªå…ƒç´ ä¸º Promise å¯¹è±¡çš„æ•°ç»„ä½œä¸ºå‚æ•° * è¿”å›ä¸€ä¸ªPromiseå®ä¾‹ * å½“è¿™ä¸ªæ•°ç»„é‡Œçš„æ‰€æœ‰promiseå¯¹è±¡éƒ½å˜ä¸ºresolveçŠ¶æ€çš„æ—¶å€™ï¼Œæ‰ä¼šè¿”å› */</span>Promise<span class="token punctuation">.</span>all <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You must pass an array to all.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// è¿”å› promise å®ä¾‹</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">.</span>length<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>    promiseArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>      promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">done</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>reject<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">gen</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">===</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®ç°Promise-race"><a href="#å®ç°Promise-race" class="headerlink" title="å®ç°Promise.race"></a>å®ç°Promise.race</h3><p>å®ç°Promise.raceå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * Promise.race * æ¥æ”¶ä¸€ä¸ªå…ƒç´ ä¸º Promise å¯¹è±¡çš„æ•°ç»„ä½œä¸ºå‚æ•° * è¿”å›ä¸€ä¸ªPromiseå®ä¾‹ * åªè¦è¯¥æ•°ç»„ä¸­çš„ä»»æ„ä¸€ä¸ª Promise å¯¹è±¡çš„çŠ¶æ€å‘â½£å˜åŒ–(æ— è®ºæ˜¯ resolve è¿˜æ˜¯ reject)è¯¥â½…æ³•éƒ½ä¼šè¿”å› */</span>Promise<span class="token punctuation">.</span>race <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You must pass an array to all.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// è¿”å› promise å®ä¾‹</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">{</span>    promiseArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>      promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®ç°-catch"><a href="#å®ç°-catch" class="headerlink" title="å®ç° catch "></a>å®ç° catch <br></h3><p>å®ç° catch </p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * é“¾å¼å†™æ³•ä¸­å¯ä»¥æ•è·å‰é¢thenä¸­å‘é€çš„å¼‚å¸¸ */</span><span class="token keyword">function</span> Promise <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>  <span class="token operator">...</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> _this<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä»£ç å°è£…"><a href="#ä»£ç å°è£…" class="headerlink" title="ä»£ç å°è£…"></a>ä»£ç å°è£…</h3><p>ç»è¿‡ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤æˆ‘ä»¬åŸºæœ¬å®ç°äº† promise çš„å‡ ä¸ªé‡è¦ç‰¹æ€§ï¼Œä¸‹é¢æˆ‘ä»¬å°†ä»£ç æ•´ç†ä¸€ä¸‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/* * @Description: promise  * @Author: renbo * @Date: 2019-08-12 15:13:40 * @LastEditTime: 2019-08-15 10:34:44 */</span><span class="token keyword">var</span> Promise <span class="token operator">=</span> <span class="token comment" spellcheck="true">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> Promise <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>    _this<span class="token punctuation">.</span>_value <span class="token operator">=</span> undefined<span class="token punctuation">;</span>    _this<span class="token punctuation">.</span>_reason <span class="token operator">=</span> undefined<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//å­˜å‚¨çŠ¶æ€</span>    _this<span class="token punctuation">.</span>_resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    _this<span class="token punctuation">.</span>_rejects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¼‚å¸¸å¤„ç†</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//ç”±æ–¼applyåƒæ•¸æ˜¯æ•¸çµ„</span>      _this<span class="token punctuation">.</span>final<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'FULFILLED'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>final<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'REJECTED'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>reason<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * ç”¨äºresolve å’Œ reject    * å¼‚æ­¥è°ƒç”¨ï¼Œä¿è¯thenæ˜¯å…ˆæ‰§è¡Œçš„   * @param {*} status    * @param {*} value    */</span>  Promise<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>final <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>status<span class="token punctuation">,</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span> st<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_status <span class="token operator">!==</span> <span class="token string">'PENDING'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> status<span class="token punctuation">;</span>      st <span class="token operator">=</span> _this<span class="token punctuation">.</span>_status <span class="token operator">===</span> <span class="token string">'FULFILLED'</span>      queue <span class="token operator">=</span> _this<span class="token punctuation">[</span>st <span class="token operator">?</span> <span class="token string">'_resolves'</span> <span class="token punctuation">:</span> <span class="token string">'_rejects'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">while</span><span class="token punctuation">(</span>fn <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        value <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">||</span> value<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      _this<span class="token punctuation">[</span>st <span class="token operator">?</span> <span class="token string">'_value'</span> <span class="token punctuation">:</span> <span class="token string">'_reason'</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>      _this<span class="token punctuation">[</span><span class="token string">'_resolves'</span><span class="token punctuation">]</span> <span class="token operator">=</span> _this<span class="token punctuation">[</span><span class="token string">'_rejects'</span><span class="token punctuation">]</span> <span class="token operator">=</span> undefined<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * then    * @params onFulfilled   * @params onRejected   */</span>  Promise<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ¯æ¬¡è¿”å›ä¸€ä¸ªpromiseï¼Œä¿è¯æ˜¯å¯thenableçš„</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// é€™ä¸€æ­¥å¾ˆé—œéµï¼Œåªæœ‰é€™æ¨£æ‰å¯ä»¥å°‡å€¼å‚³éçµ¦ä¸‹ä¸€å€‹resolve</span>        <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//åˆ¤æ–­æ˜¯ä¸æ˜¯promise å¯¹è±¡</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> ret <span class="token punctuation">[</span><span class="token string">'then'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ret<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">function</span> <span class="token function">errback</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>        reason <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">||</span> reason<span class="token punctuation">;</span>        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// æ ¹æ®å½“å‰å¼‚æ­¥çŠ¶æ€æ‰§è¡Œæ“ä½œ</span>      <span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">'PENDING'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>          _this<span class="token punctuation">.</span>_rejects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>errback<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">'FULFILLED'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">'REJECTED'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">errback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_reason<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      config<span class="token punctuation">[</span>_this<span class="token punctuation">.</span>_status<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * é“¾å¼å†™æ³•ä¸­å¯ä»¥æ•è·å‰é¢thenä¸­å‘é€çš„å¼‚å¸¸   */</span>  Promise<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token keyword">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>undefined<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Promise.race   * æ¥æ”¶ä¸€ä¸ªå…ƒç´ ä¸º Promise å¯¹è±¡çš„æ•°ç»„ä½œä¸ºå‚æ•°   * è¿”å›ä¸€ä¸ªPromiseå®ä¾‹   * åªè¦è¯¥æ•°ç»„ä¸­çš„ä»»æ„ä¸€ä¸ª Promise å¯¹è±¡çš„çŠ¶æ€å‘â½£å˜åŒ–(æ— è®ºæ˜¯ resolve è¿˜æ˜¯ reject)è¯¥â½…æ³•éƒ½ä¼šè¿”å›   */</span>  Promise<span class="token punctuation">.</span>race <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You must pass an array to all.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è¿”å› promise å®ä¾‹</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">{</span>      promiseArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Promise.all   * æ¥æ”¶ä¸€ä¸ªå…ƒç´ ä¸º Promise å¯¹è±¡çš„æ•°ç»„ä½œä¸ºå‚æ•°   * è¿”å›ä¸€ä¸ªPromiseå®ä¾‹   * å½“è¿™ä¸ªæ•°ç»„é‡Œçš„æ‰€æœ‰promiseå¯¹è±¡éƒ½å˜ä¸ºresolveçŠ¶æ€çš„æ—¶å€™ï¼Œæ‰ä¼šè¿”å›   */</span>  Promise<span class="token punctuation">.</span>all <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You must pass an array to all.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è¿”å› promise å®ä¾‹</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">.</span>length<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>      promiseArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">done</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>reject<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­ promise çŠ¶æ€æ˜¯å¦å…¨éƒ¨ resolve</span>    <span class="token keyword">function</span> <span class="token function">gen</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">===</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  Promise<span class="token punctuation">.</span>resolve <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  Promise<span class="token punctuation">.</span>reject <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token function">reject</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> Promise<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºæœ¬æ•°æ®ç±»å‹</title>
      <link href="/2019/05/23/typescript/basedatatype/"/>
      <url>/2019/05/23/typescript/basedatatype/</url>
      
        <content type="html"><![CDATA[<p>æ¯ç§è¯­è¨€éƒ½ä¼šæœ‰å±äºè‡ªå·±çš„æ•°æ®ç±»å‹ï¼Œtsçš„åŸºæœ¬æ•°æ®ç±»å‹åŸºæœ¬ä¸Šæ˜¯ç»§æ‰¿äº†jsï¼Œä½†ä¹Ÿåœ¨åŸºç¡€ä¹‹ä¸Šå¢åŠ äº†å‡ ä¸ªä¸ä¸€æ ·çš„ç±»å‹</p><h3 id="å¸ƒå°”å‹-trueï¼false"><a href="#å¸ƒå°”å‹-trueï¼false" class="headerlink" title="å¸ƒå°”å‹ trueï¼false "></a>å¸ƒå°”å‹ trueï¼false <br></h3><pre><code>//åœ¨jsä¸­å£°æ˜booleanå‹çš„æ–¹æ³•å’Œtsä¸­çš„ä¸åŒä¹‹å¤„let flag = true;let flag: boolean = true;</code></pre><h3 id="float-æ•°å€¼å‹ï¼ˆåœ¨jså’Œtsä¸­æ•°å­—å‹éƒ½æ˜¯floatï¼‰"><a href="#float-æ•°å€¼å‹ï¼ˆåœ¨jså’Œtsä¸­æ•°å­—å‹éƒ½æ˜¯floatï¼‰" class="headerlink" title="float,æ•°å€¼å‹ï¼ˆåœ¨jså’Œtsä¸­æ•°å­—å‹éƒ½æ˜¯floatï¼‰"></a>float,æ•°å€¼å‹ï¼ˆåœ¨jså’Œtsä¸­æ•°å­—å‹éƒ½æ˜¯floatï¼‰<br></h3><pre><code>//åœ¨jsä¸­å£°æ˜numberå‹çš„æ–¹æ³•å’Œtsä¸­çš„ä¸åŒä¹‹å¤„let age = 26;let age: number = 26;</code></pre><h3 id="å­—ç¬¦å‹-String"><a href="#å­—ç¬¦å‹-String" class="headerlink" title="å­—ç¬¦å‹ String "></a>å­—ç¬¦å‹ String <br></h3><pre><code>//åœ¨jsä¸­å£°æ˜numberå‹çš„æ–¹æ³•å’Œtsä¸­çš„ä¸åŒä¹‹å¤„let name = &#39;boren&#39;;let name: string = &#39;boren&#39;;</code></pre><h3 id="æ•°ç»„-Array"><a href="#æ•°ç»„-Array" class="headerlink" title="æ•°ç»„ Array "></a>æ•°ç»„ Array <br></h3><pre><code>//åœ¨jsä¸­å£°æ˜æ•°ç»„çš„æ–¹æ³•å’Œtsä¸­çš„ä¸åŒä¹‹å¤„//1.jsä¸­å£°æ˜æ•°ç»„çš„ä¸¤ç§æ–¹å¼let city = [];let city = new Array();//2.tsä¸­å£°æ˜æ•°ç»„çš„ä¸¤ç§æ–¹å¼let city: string[] = [];let city:Array&lt;string&gt; = []//åœ¨tsä¸­å£°æ˜æ•°ç»„å¿…é¡»æå‰æŒ‡å®šå…¶æ•°æ®ç±»å‹ï¼Œå¦‚æœå…¶æ•°ç»„ä¸­çš„å…ƒç´ å…¶æ•°æ®ç±»å‹ä¸ç›¸åŒï¼Œå£°æ˜çš„æ–¹å¼ä¼šåœ¨åé¢ä»‹ç»</code></pre><h3 id="å…ƒç»„-Tuple"><a href="#å…ƒç»„-Tuple" class="headerlink" title="å…ƒç»„ Tuple "></a>å…ƒç»„ Tuple <br></h3><pre><code>//å¯ä»¥å®šä¹‰æ•°ç»„ä¸­å…ƒç´ ä¸ç›¸åŒçš„æ•°æ®ç±»å‹let people = [&#39;boren&#39;,26];//jslet people:[string,number];people = [&#39;boren&#39;,26];//ts</code></pre><h3 id="æšä¸¾-Enum"><a href="#æšä¸¾-Enum" class="headerlink" title="æšä¸¾ Enum "></a>æšä¸¾ Enum <br></h3><pre><code>//jsä¸­æ²¡æœ‰æ­¤æ–¹æ³•ï¼Œéƒ½æ˜¯ä»¥objectæˆ–è€…jsonçš„å½¢å¼å»å®ç°æšä¸¾çš„ç‰¹æ€§å¦‚ï¼šlet school = {     teacherOne : &#39;Mars&#39;,     teacherTwo:&#39;yupeng&#39;,     teacherThree:&#39;luxuesong&#39;} console.log(school.teacherOne)//Marsåœ¨ECMA2015ï¼Œç®€ç§°es5ä¸­Object.getOwnPropertyDescriptoræ–¹æ³•å¯ä»¥è·å–è¯¥å±æ€§çš„æè¿°å¯¹è±¡Object.getOwnPropertyDescriptorï¼ˆschool,â€˜teacherOneâ€™ï¼‰// {// value: Mars,// writable: true,// enumerable: true,// configurable: true// }å…¶ä¸­è¿™ä¹ˆæ–¹æ³•æ‰“å°å‡ºæ¥çš„å¯¹è±¡ä¸­key enumerableå±æ€§ï¼Œä¸ºå¯æšä¸¾æ€§ï¼Œåœ¨js es5ä¸­æœ‰ä¸‰ä¸ªæ“ä½œä¼šå¿½ç•¥æšä¸¾ä¸º falseï¼Œfor...inã€ Object...keys()ã€ JSON.stringify()ï¼›åœ¨es6ä¸­æ–°å¢ä¸€ä¸ªæ–¹æ³•Object.assign()ä¼šå¿½ç•¥enumerableä¸ºfalseçš„å±æ€§ï¼Œåªæ‹·è´å¯¹è±¡è‡ªèº«çš„å¯æšä¸¾çš„å±æ€§ã€‚å…³äºæ›´å¤šjsä¸­å¯¹æšä¸¾å±æ€§çš„æ”¯æŒï¼Œåœ¨è¿™é‡Œå°±ä¸ä¸€ä¸€ä»‹ç»ï¼Œä¾‹å¦‚toString()å’Œlengthç­‰ç­‰å…¶æšä¸¾å±æ€§ä¸ºfalse//tsä¸­æšä¸¾ç±»å‹çš„ç”¨æ³•enum classMember = {chenchao,rongbin,chenhua,liurui,luxuesong};let teacher:classMember = classMember.luxuesongæˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™æšä¸¾ä¸­çš„æˆå‘˜è¿›è¡Œç¼–å·ç­‰ç­‰ï¼Œä»¥ä¾¿äºæ›´æ–¹ä¾¿çš„å»æ‰¾åˆ°ç›¸åº”çš„å¯¹è±¡å…ƒç´ </code></pre><h3 id="é€šç”¨æ•°æ®ç±»å‹-Any"><a href="#é€šç”¨æ•°æ®ç±»å‹-Any" class="headerlink" title="é€šç”¨æ•°æ®ç±»å‹ Any"></a>é€šç”¨æ•°æ®ç±»å‹ Any<br></h3><pre><code>è¿™ç§æ•°æ®ç±»å‹ä¸ªäººè®¤ä¸ºæ˜¯ä¸‡èƒ½çš„ï¼Œå®ƒå¯ä»¥åœ¨ä½ ä¸çŸ¥é“è¿™ä¸ªå˜é‡ä¸ºä»€ä¹ˆæ•°æ®ç±»å‹çš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸”é¡¹ç›®æ¯”è¾ƒæ€¥çš„æ—¶å€™æ ‡æ³¨ä¸ºAnyï¼Œå®ƒå¯ä»¥é€šè¿‡ç¼–è¯‘æ—¶çš„ç±»å‹æ£€æŸ¥ï¼Œæœ‰äººä¼šè¯´é‚£æˆ‘æ‰€æœ‰çš„ç±»å‹éƒ½å†™Anyï¼Œå¦‚æœä½ éè¦è¿™ä¹ˆå¹²ï¼Œä¹Ÿæ— å¦¨ï¼Œé‚£å°±å¤±å»äº†tsè¿™ä¹ˆè¯­è¨€æœ¬èº«çš„æ„ä¹‰æ‰€åœ¨ï¼Œå¯ä»¥ç”¨è¿™ç§æ–¹æ³•å»è§£å†³ä¸€ä¸ªä¸Šè¿°å£°æ˜æ•°ç»„ç±»å‹æ—¶å¾ˆéº»çƒ¦çš„é—®é¢˜let lists: any[] = [&#39;boren&#39;,26,&#39;body&#39;]; let age: any = 26;let name: any = &#39;boren&#39;;</code></pre><h3 id="ç©ºå€¼Void"><a href="#ç©ºå€¼Void" class="headerlink" title="ç©ºå€¼Void "></a>ç©ºå€¼Void <br></h3><pre><code>åœ¨jsä¸­æˆ‘ä»¬å…¶å®å¯¹voidä¸æ˜¯é‚£ä¹ˆçš„é™Œç”Ÿï¼Œå®ƒè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ“ä½œç¬¦ï¼Œè¿™ä¸ªæ“ä½œç¬¦å¯ä»¥è®¡ç®—è¡¨è¾¾å¼ä½†ä¸ä¼šè¿”å›ä»»ä½•å€¼ï¼Œåœ¨jsä¸­å¸¸å¸¸å‡ºç°çš„ä½ç½®å°±æ˜¯åœ¨aæ ‡ç­¾çš„é“¾æ¥ä¸­ï¼Œæˆ‘ä»¬ä¸æƒ³è®©é¡µé¢åˆ·æ–°ï¼Œæ›´ä¸æƒ³é“¾æ¥åˆ°æŸäº›ä½ç½®åªæ˜¯ç®€ç®€å•å•çš„aæ ‡ç­¾ï¼Œæœ‰æ—¶å€™ä¼šè°ƒç”¨ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œä»…æ­¤è€Œå·²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼š&lt;a href=&quot;javascript:void(0)&quot; onclick=&quot;people()&quot;&gt;ç‚¹æˆ‘&lt;/a&gt;//åœ¨tsä¸­ï¼Œvoidç±»å‹åƒæ˜¯ä¸anyç±»å‹ç›¸åï¼Œå®ƒè¡¨ç¤ºæ²¡æœ‰ä»»ä½•ç±»å‹ã€‚function student(): void{   console.log(&#39;my name is renbo&#39;)}åœ¨ä¸Šè¿°å‡½æ•°ä¸­æ²¡æœ‰è¿”å›ä»»ä½•å€¼ï¼Œæ‰€ä»¥ç±»å‹ä¸ºvoidï¼Œå…¶å®voidçš„å˜é‡æ²¡ä»€ä¹ˆç”¨å¤„å’Œnull,undefinedä¸€æ ·èŒèƒ½ä½œä¸ºæ•°æ®çš„ç±»å‹çš„åˆ¤æ–­ã€‚</code></pre><h3 id="æ°¸ä¸å­˜åœ¨å€¼çš„ç±»å‹Never"><a href="#æ°¸ä¸å­˜åœ¨å€¼çš„ç±»å‹Never" class="headerlink" title="æ°¸ä¸å­˜åœ¨å€¼çš„ç±»å‹Never"></a>æ°¸ä¸å­˜åœ¨å€¼çš„ç±»å‹Never<br></h3><pre><code>å®˜ç½‘è§£é‡Šnever is the return type for a function expression or an arrow function expression that always throws an exception or one that never returns;Variables also acquire the type never when narrowed by any type guards that can never be true. neverç±»å‹æ˜¯é‚£äº›æ€»æ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸æˆ–æ ¹æœ¬å°±ä¸ä¼šæœ‰è¿”å›å€¼çš„å‡½æ•°è¡¨è¾¾å¼æˆ–ç®­å¤´å‡½æ•°è¡¨è¾¾å¼çš„è¿”å›å€¼ç±»å‹ï¼› å˜é‡ä¹Ÿå¯èƒ½æ˜¯neverç±»å‹ï¼Œå½“å®ƒä»¬è¢«æ°¸ä¸ä¸ºçœŸçš„ç±»å‹ä¿æŠ¤æ‰€çº¦æŸæ—¶ã€‚ä¸ªäººè§‰å¾—æ²¡ä»€ä¹ˆå¤ªå¤§ç”¨è¿™é‡Œå°±ä¸åšæ·±ç©¶ã€‚</code></pre><h3 id="ç±»å‹æ–­è¨€"><a href="#ç±»å‹æ–­è¨€" class="headerlink" title="ç±»å‹æ–­è¨€ "></a>ç±»å‹æ–­è¨€ <br></h3><pre><code>åœ¨tsä¸­ç±»å‹æ–­è¨€è¿™ç§æ–¹å¼è¿˜æ˜¯æ¯”è¾ƒæœ‰ç”¨å¤„çš„ï¼Œå…¶ç›¸å½“äºjsä¸­çš„ç±»å‹è½¬æ¢ã€‚ä½†æ˜¯åªåœ¨ç¼–è¯‘çš„æ—¶å€™èµ·ä½œç”¨ã€‚å¹¶ä¸ä¼šæ”¹å˜å…¶æ•°æ®çš„æœ¬èº«ç»“æ„ã€‚let city: any = &quot;beijing&quot;;let strLength: number = (city as string).length;å¦å¤–ä¸€ç§å†™æ³•ï¼šlet city: any = &quot;beijing&quot;;let strLength: number = (&lt;string&gt;city).length;</code></pre><hr>æ€»ç»“ï¼šé€šè¿‡ä»¥ä¸Šçš„ä»‹ç»ç›¸ä¿¡å¤§å®¶å¯¹tsçš„æ•°æ®ç±»å‹å·²ç»æœ‰äº†å¤§æ¦‚çš„äº†è§£ï¼Œå…¶å®ç›¸å¯¹äºjs,tsçš„æ•°æ®ç±»å‹å¹¶æ²¡æœ‰åšä»€ä¹ˆå˜æ›´ï¼Œåªæ˜¯åœ¨å£°æ˜å…¶æ•°æ®ç±»å‹çš„æ—¶å€™å¿…é¡»æ˜ç¡®çš„æŒ‡å®šå…¶ç›¸åº”çš„æ•°æ®ç±»å‹ï¼Œå¦åˆ™ä»£ç ç¼–è¯‘ä¼šæŠ¥é”™ã€‚è™½ç„¶ tsçš„æ–‡ä»¶æ˜¯xxx.ts ä½†ç”±äºç¼–è¯‘è¿‡åå’Œjs æ²¡æœ‰ä»€ä¹ˆå¤§çš„ä¸åŒç‚¹ï¼Œèƒ½å¤Ÿå¾ˆå¥½çš„è¿è¡Œåœ¨æµè§ˆå™¨ç«¯ï¼Œå…¶ä¸­classã€publicç­‰ç­‰å‡½æ•°åŠæ¨¡å—ç¼–è¯‘è¿‡åçš„jsèƒ½åè®©ä½ æ›´æ·±å…¥çš„äº†è§£js]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ³›å‹</title>
      <link href="/2019/05/22/typescript/generics/"/>
      <url>/2019/05/22/typescript/generics/</url>
      
        <content type="html"><![CDATA[<p>æ³›å‹ï¼ˆGenericsï¼‰å°±æ˜¯ä¸æå‰æŒ‡å®šæ¥å£ã€å˜é‡ã€å‡½æ•°ç­‰çš„ç±»å‹ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™å†æŒ‡å®šç±»å‹</p><h3 id="å®šä¹‰æ³›å‹"><a href="#å®šä¹‰æ³›å‹" class="headerlink" title="å®šä¹‰æ³›å‹ "></a>å®šä¹‰æ³›å‹ <br></h3><pre><code>// å®šä¹‰ç±»å‹function identity(arg: number): number {  return arg;}// å®šä¹‰ any ç±»å‹function identity(arg: any): any {  return arg;}</code></pre><p>å¦‚æœæ‰€æœ‰çš„æ¥å£ã€å˜é‡ã€å‡½æ•°ç­‰éƒ½ç”¨ any ç±»å‹ï¼Œé‚£ä¹ˆå†™ TS å’Œå†™ JS ä¸€æ ·å°†å¤±å»æ„ä¹‰ï¼Œå› ä¸ºä½ å¯èƒ½åƒ JS ä¸€æ ·é€ æˆè®¸å¤šæœªçŸ¥çš„é”™è¯¯ï¼Œé‚£ä¹ˆè§£å†³è¿™æ ·çš„é—®é¢˜æˆ‘ä»¬ä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„å˜é‡Tï¼Œæ¥è¡¨ç¤ºè¿”å›çš„å†…å®¹ã€‚</p><pre><code>function identity&lt;T&gt;(arg: T): T {  return arg;}</code></pre><h3 id="è°ƒç”¨æ³›å‹"><a href="#è°ƒç”¨æ³›å‹" class="headerlink" title="è°ƒç”¨æ³›å‹"></a>è°ƒç”¨æ³›å‹<br></h3><pre><code>let output = identity&lt;string&gt;(&quot;myString&quot;);</code></pre><h3 id="æ³›å‹çº¦æŸ"><a href="#æ³›å‹çº¦æŸ" class="headerlink" title="æ³›å‹çº¦æŸ"></a>æ³›å‹çº¦æŸ<br></h3><p>åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨æ³›å‹å˜é‡çš„æ—¶å€™ï¼Œå› ä¸ºä¸çŸ¥é“å®ƒæ˜¯å“ªç§ç±»å‹ï¼Œæ‰€ä»¥ä¸èƒ½éšæ„çš„æ“ä½œå®ƒçš„å±æ€§æˆ–æ–¹æ³•</p><pre><code>function loggingIdentity&lt;T&gt;(arg: T): T {  console.log(arg.length);  // Error: T doesn&#39;t have .length  return arg;}</code></pre><p>ç”±äºä¸Šé¢çš„æ³›å‹ T ä¸­ä¸ä¸€å®šåŒ…å«å±æ€§.length, æ‰€ä»¥ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><p>è¿™æ—¶æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå…·æœ‰å•ä¸ª.lengthå±æ€§çš„æ¥å£ï¼Œç„¶åæˆ‘ä»¬å°†ä½¿ç”¨æ­¤æ¥å£å’Œextendså…³é”®å­—æ¥è¡¨ç¤ºæˆ‘ä»¬çš„çº¦æŸï¼š</p><pre><code>interface Lengthwise {    length: number;}function loggingIdentity&lt;T extends Lengthwise&gt;(arg: T): T {  console.log(arg.length);   return arg;}</code></pre><p>ä¸Šé¢çš„ä¾‹å­å¦‚æœåœ¨è°ƒç”¨çš„æ—¶å€™ä¼ å…¥çš„å‚æ•°ä¸ç¬¦åˆå®šä¹‰çš„çº¦æŸï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡ºå¼‚å¸¸</p><pre><code>interface Lengthwise {    length: number;}function loggingIdentity&lt;T extends Lengthwise&gt;(arg: T): T {  console.log(arg.length);   return arg;}loggingIdentity(5) // Argument of type &#39;5&#39; is not assignable to parameter of type &#39;Lengthwise&#39;</code></pre><p>ç›¸åå¦‚æœå®šä¹‰äº†æ­£ç¡®çš„ç±»å‹</p><pre><code>interface Lengthwise {    length: number;}function loggingIdentity&lt;T extends Lengthwise&gt;(arg: T): T {  console.log(arg.length);   return arg;}loggingIdentity([1,2]) // 2loggingIdentity({length: 5, value: 1}) // 5</code></pre><h3 id="æ³›å‹æ¥å£"><a href="#æ³›å‹æ¥å£" class="headerlink" title="æ³›å‹æ¥å£"></a>æ³›å‹æ¥å£<br></h3><pre><code>// å®šä¹‰æ³›å‹ç»“æ„interface CreatePeopleFunc {  &lt;T&gt;(name: string, age: T): Array&lt;T&gt;;}// åˆ›å»ºæ³›å‹let createPeople:CreatePeopleFunc;createPeople = function&lt;T&gt;(name: string, age: T): Array&lt;T&gt; {  let people: T[] = []  let temp:any = {    name : name,    age: age  }  people.push(temp)  return people}// è°ƒç”¨å‡½æ•°createPeople(&#39;zhangsan&#39;, 28)</code></pre><p>ä¸Šé¢ä¾‹å­æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ³›å‹ï¼Œåˆ›å»ºäº†å‡½æ•°ï¼Œåœ¨å‡½æ•°å†…åˆ›å»ºæ•°ç»„å¹¶æ·»åŠ äº†ä¸€ä¸ªå…ƒç´  name, age</p><h3 id="æ³›å‹ç±»"><a href="#æ³›å‹ç±»" class="headerlink" title="æ³›å‹ç±»"></a>æ³›å‹ç±»<br></h3><p>æ³›å‹ç±»å…·æœ‰ä¸é€šç”¨æ¥å£ç±»ä¼¼çš„å½¢çŠ¶ã€‚æ³›å‹ç±»&lt;&gt;åœ¨ç±»åç§°åé¢çš„å°–æ‹¬å·ï¼ˆï¼‰ä¸­æœ‰ä¸€ä¸ªæ³›å‹ç±»å‹å‚æ•°åˆ—è¡¨</p><pre><code>class GenericNumber&lt;T&gt; {    zeroValue: T;    add: (x: T, y: T) =&gt; T;}let myGenericNumber = new GenericNumber&lt;number&gt;();myGenericNumber.zeroValue = 0;myGenericNumber.add = function(x, y) { return x + y; };</code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¥å£</title>
      <link href="/2019/05/18/typescript/interfaces/"/>
      <url>/2019/05/18/typescript/interfaces/</url>
      
        <content type="html"><![CDATA[<p>##</p><p>åœ¨é¢å‘å¯¹è±¡è¯­è¨€ä¸­æ¥å£ (Interfaces) æ˜¯å¯¹ç±»çš„è¡Œä¸ºçš„æŠ½è±¡ï¼Œåœ¨TypeScriptä¸­ä¹Ÿå¸¸ç”¨äºå®šä¹‰ç»“æ„å­ç±»å‹ï¼Œæ–¹ä¾¿è¿›è¡Œç±»å‹æ£€æŸ¥</p><h3 id="å®šä¹‰ä¸€ä¸ªç®€å•çš„æ¥å£"><a href="#å®šä¹‰ä¸€ä¸ªç®€å•çš„æ¥å£" class="headerlink" title="å®šä¹‰ä¸€ä¸ªç®€å•çš„æ¥å£"></a>å®šä¹‰ä¸€ä¸ªç®€å•çš„æ¥å£<br></h3><pre><code>interface IPeople {  name: string;  age: number}let zhangsan: IPeople = {  name: &#39;zhangsan&#39;,  age: 25};</code></pre><p>ä¸Šé¢çš„ä¾‹å­æˆ‘å®šä¹‰äº†ä¸€ä¸ªæ¥å£ IPeopleï¼Œå¹¶ä¸”å®šä¹‰äº†ä¸€ä¸ªå˜é‡ zhangsanï¼Œå®ƒçš„ç±»å‹æ˜¯ IPersonï¼Œzhangsançš„æ•°æ®ç»“æ„ç±»å‹å¿…é¡»ä¸ IPeople ä¸€è‡´å¦åˆ™ä¼šæŠ¥é”™ä¾‹å¦‚ä¸‹é¢</p><pre><code>interface IPeople {  name: string;  age: number}let zhangsan: IPeople = {  name: &#39;zhangsan&#39;,};Property &#39;age&#39; is missing in type &#39;{ name: string; }&#39; but required in type &#39;IPeople&#39;</code></pre><h3 id="å¯é€‰å±æ€§"><a href="#å¯é€‰å±æ€§" class="headerlink" title="å¯é€‰å±æ€§ "></a>å¯é€‰å±æ€§ <br></h3><p>å½“æˆ‘ä»¬å®šä¹‰æ¥å£å±æ€§çš„æ—¶å€™ä¸æ˜¯å¿…é¡»çš„é‚£ä¹ˆå¯é€‰å±æ€§å°±èµ·åˆ°äº†ä½œç”¨</p><pre><code>interface IPeople {  name: string;  age?: number}let zhangsan: IPeople = {  name: &#39;zhangsan&#39;,};</code></pre><h3 id="ä»»æ„å±æ€§"><a href="#ä»»æ„å±æ€§" class="headerlink" title="ä»»æ„å±æ€§"></a>ä»»æ„å±æ€§<br></h3><p>å½“æˆ‘ä»¬éœ€è¦å®šä¹‰æˆ–å¢åŠ ä¸€äº›æœªçŸ¥çš„å±æ€§ï¼Œé‚£ä¹ˆä»»æ„å±æ€§å°±èµ·åˆ°äº†ä½œç”¨</p><pre><code>interface IPeople {  name: string;  age?: number  [propName: string]: any;}let zhangsan: IPeople = {  name: &#39;zhangsan&#39;,  age: 28,  gender: &#39;m&#39;};</code></pre><p>ä¸Šè¿°ä¾‹å­ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦å®šä¹‰äº†ä»»æ„å±æ€§ï¼Œé‚£ä¹ˆå¯é€‰å±æ€§å’Œç¡®å®šå±æ€§çš„ç±»å‹å¿…é¡»æ˜¯å®ƒçš„çš„ç±»å‹çš„å­é›†ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œä¾‹å¦‚</p><pre><code>interface IPeople {  name: string;  age?: number  [propName: string]: string;}let zhangsan: IPeople = {  name: &#39;zhangsan&#39;,  age: 28,  gender: &#39;m&#39;};Type &#39;{ name: string; age: number; gender: string; }&#39; is not assignable to type &#39;IPeople&#39;.Property &#39;age&#39; is incompatible with index signature.Type &#39;number&#39; is not assignable to type &#39;string&#39;.</code></pre><h3 id="åªè¯»å±æ€§"><a href="#åªè¯»å±æ€§" class="headerlink" title="åªè¯»å±æ€§"></a>åªè¯»å±æ€§<br></h3><p>å½“æˆ‘ä»¬éœ€è¦å¯¹è±¡ä¸­å­—æ®µåªèƒ½åœ¨åˆ›å»ºçš„æ—¶å€™è¢«èµ‹å€¼ï¼Œé‚£ä¹ˆåªè¯»å±æ€§å°±èµ·åˆ°äº†ä½œç”¨</p><pre><code>interface IPerson {  readonly id: number;  name: string;  age?: number;  [propName: string]: any;}let zhangsan: IPerson = {  id: 1,  name: &#39;zhangsan&#39;,  gender: &#39;m&#39;};zhangsan.id = 2;Cannot assign to &#39;id&#39; because it is a read-only property.</code></pre><h3 id="å¯ä»¥ä¸ºæ¥å£å®šä¹‰å‡½æ•°ç±»å‹"><a href="#å¯ä»¥ä¸ºæ¥å£å®šä¹‰å‡½æ•°ç±»å‹" class="headerlink" title="å¯ä»¥ä¸ºæ¥å£å®šä¹‰å‡½æ•°ç±»å‹"></a>å¯ä»¥ä¸ºæ¥å£å®šä¹‰å‡½æ•°ç±»å‹<br></h3><pre><code>interface IPeople {  (name: string, age: number): string;}let hello: IPeople;hello = function(name: string, age: number): string {  return `my name is ${name} I,m years old ${age}`}hello(&#39;zhangsan&#39;, 28) //my name is zhangsan I,m years old 28</code></pre><p>ä¸Šé¢ç®€å•çš„ä»‹ç»äº†æ¥å£çš„åŸºæœ¬ç”¨æ³•ï¼Œä¹Ÿå°±æ˜¯å¯¹å¯¹è±¡çš„ç»“æ„è¿›è¡Œæ€§çº¦å®šï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç”¨ Interface å¯¹ç±»çš„è¡Œä¸ºè¿›è¡ŒæŠ½è±¡</p><h3 id="ç”¨ç±»å®ç°æ¥å£"><a href="#ç”¨ç±»å®ç°æ¥å£" class="headerlink" title="ç”¨ç±»å®ç°æ¥å£"></a>ç”¨ç±»å®ç°æ¥å£<br></h3><p>ç”¨ç±»å®ç°æ¥å£ä¸»è¦åº”ç”¨çš„åœºæ™¯å°±æ˜¯ç±»ä¸ç±»ä¹‹é—´æœ‰ä¸€äº›å…¬æœ‰çš„åŠŸèƒ½åŠç‰¹æ€§ï¼Œè¦å®ç°é«˜åº¦æŠ½è±¡è¿™ä¹Ÿæ˜¯é¢å‘å¯¹è±¡çš„åŸºæœ¬ã€‚åœ¨ TypeScript ä¸­ç”¨å…³é”®å­— implements å»å®ç°ã€‚</p><pre><code>// å®šä¹‰æ¥å£ï¼Œæ¥å£ä¸­æœ‰ä¸€ä¸ªå…¬å…±çš„æ–¹æ³•eatinterface People{  eat(food: string)}// å®ç°æ¥å£çš„æ–¹æ³•class Boy implements People {  constructor () {}  eat (food: string): string {   return food   }}// å®ç°æ¥å£æ–¹æ³•class Girl implements People {  constructor () {}  eat (food: string):string {    return food  }}let boy = new Boy()console.log(boy.eat(&#39;apple&#39;))let girl = new Girl()console.log(girl.eat(&#39;banana&#39;))</code></pre><p>ä¸€ä¸ªç±»ä¹Ÿå¯ä»¥å®ç°å¤šä¸ªæ¥å£</p><pre><code>interface Eat{  food (food: string)}interface Drink{  drink()}// å®ç°æ¥å£çš„æ–¹æ³•class People implements Eat, Drink {  constructor () {}  food (food: string): string {   return food   }  drink ():string {    return `å°æ˜è·‘æ­¥ä¸­åƒ${this.food(&#39;apple&#39;)}æ˜¯ä¸å¥åº·çš„`  }}let people = new People()console.log(people.drink())</code></pre><h3 id="æ¥å£çš„ç»§æ‰¿"><a href="#æ¥å£çš„ç»§æ‰¿" class="headerlink" title="æ¥å£çš„ç»§æ‰¿"></a>æ¥å£çš„ç»§æ‰¿<br></h3><p>åœ¨ JS ECMA6 ä¸­ç±»çš„ç»§æ‰¿ç”¨ extends å…³é”®å­—ï¼Œ é‚£ä¹ˆåœ¨ TS ä¸­æˆ‘ä»¬ä¾ç„¶åŒæ ·ç”¨è¿™ä¸ªå…³é”®å­—</p><pre><code>interface Eat {  eat ()}interface People extends Eat {  eat()  run ()}</code></pre><h3 id="æ··åˆç±»å‹"><a href="#æ··åˆç±»å‹" class="headerlink" title="æ··åˆç±»å‹"></a>æ··åˆç±»å‹<br></h3><p>æ··åˆç±»å‹å®é™…ä¸Šå°±æ˜¯åœ¨æ¥å£ä¸­å­˜åœ¨å¤šç§è§„åˆ™ï¼Œåˆ©ç”¨è¿™ç§è§„åˆ™å»å®ç°è‡ªå·±çš„å±æ€§å’Œæ–¹æ³•</p><pre><code>// å®šä¹‰è§„åˆ™interface Counter {  (start: number): string;  interval: number;  reset(): void;}// å®ç°è§„åˆ™function getCounter(): Counter {  let counter = &lt;Counter&gt;function (start: number) {     console.log(start)  };  counter.interval = 0;  counter.reset = function () {    console.log(&#39;reset&#39;)  };  return counter;}let counter = getCounter()counter(20); // 20counter.reset(); // reset counter.interval = 5; // 5</code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç±»</title>
      <link href="/2019/05/17/typescript/class/"/>
      <url>/2019/05/17/typescript/class/</url>
      
        <content type="html"><![CDATA[<h2 id="TSåŸºç¡€ç³»åˆ—ä¹‹-ç±»"><a href="#TSåŸºç¡€ç³»åˆ—ä¹‹-ç±»" class="headerlink" title="TSåŸºç¡€ç³»åˆ—ä¹‹-ç±»"></a>TSåŸºç¡€ç³»åˆ—ä¹‹-ç±»</h2><p>åœ¨JavaScript é€šè¿‡æ„é€ å‡½æ•°å’ŒåŸå‹é“¾æ¥å®ç°ç±»å’Œç»§æ‰¿ã€‚è€Œåœ¨ ES6 ä¸­ï¼Œä¹Ÿç”¨è¯­æ³•ç³–å®ç°äº†classï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹åœ¨ ts ä¸­çš„ç±»ã€‚</p><h3 id="ç±»çš„æ¦‚å¿µ"><a href="#ç±»çš„æ¦‚å¿µ" class="headerlink" title="ç±»çš„æ¦‚å¿µ "></a>ç±»çš„æ¦‚å¿µ <br><hr></h3><p>ç±»æ˜¯é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ä¸­çš„æ¦‚å¿µï¼Œæ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„åŸºç¡€ï¼Œç”±äºæ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œè€Œä¸æ˜¯æ•°æ®ï¼Œæ‰€ä»¥ä¸å­˜åœ¨äºå†…å­˜ä¸­ã€‚</p><ul><li>ç±»(Class)ï¼šå®šä¹‰äº†ä¸€ä»¶äº‹ç‰©çš„æŠ½è±¡ç‰¹ç‚¹ï¼ŒåŒ…å«å®ƒçš„å±æ€§å’Œæ–¹æ³•</li><li>å¯¹è±¡ï¼ˆObjectï¼‰ï¼šç±»çš„å®ä¾‹ï¼Œé€šè¿‡ new ç”Ÿæˆï¼Œç±»æ˜¯æ¦‚å¿µï¼Œå¯¹è±¡æ˜¯å®ä½“</li><li>é¢å‘å¯¹è±¡ï¼ˆOOPï¼‰çš„ä¸‰å¤§ç‰¹æ€§ï¼šå°è£…ã€ç»§æ‰¿ã€å¤šæ€</li><li>å°è£…ï¼ˆEncapsulationï¼‰ï¼šå°†å¯¹æ•°æ®çš„æ“ä½œç»†èŠ‚éšè—èµ·æ¥ï¼Œåªæš´éœ²å¯¹å¤–çš„æ¥å£ã€‚å¤–ç•Œè°ƒç”¨ç«¯ä¸éœ€è¦ï¼ˆä¹Ÿä¸å¯èƒ½ï¼‰çŸ¥é“ç»†èŠ‚ï¼Œå°±èƒ½é€šè¿‡å¯¹å¤–æä¾›çš„æ¥å£æ¥è®¿é—®è¯¥å¯¹è±¡ï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†å¤–ç•Œæ— æ³•ä»»æ„æ›´æ”¹å¯¹è±¡å†…éƒ¨çš„æ•°æ®</li><li>ç»§æ‰¿ï¼ˆInheritanceï¼‰ï¼šå­ç±»ç»§æ‰¿çˆ¶ç±»ï¼Œå­ç±»é™¤äº†æ‹¥æœ‰çˆ¶ç±»çš„æ‰€æœ‰ç‰¹æ€§å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ›´å…·ä½“çš„ç‰¹æ€§</li><li>å¤šæ€ï¼ˆPolymorphismï¼‰ï¼šç”±ç»§æ‰¿è€Œäº§ç”Ÿäº†ç›¸å…³çš„ä¸åŒçš„ç±»ï¼Œå¯¹åŒä¸€ä¸ªæ–¹æ³•å¯ä»¥æœ‰ä¸åŒçš„å“åº”ã€‚</li><li>å­˜å–å™¨ï¼ˆgetter &amp; setterï¼‰ï¼šç”¨ä»¥æ”¹å˜å±æ€§çš„è¯»å–å’Œèµ‹å€¼è¡Œä¸º</li><li>ä¿®é¥°ç¬¦ï¼ˆModifiersï¼‰ï¼šä¿®é¥°ç¬¦æ˜¯ä¸€äº›å…³é”®å­—ï¼Œç”¨äºé™å®šæˆå‘˜æˆ–ç±»å‹çš„æ€§è´¨ã€‚æ¯”å¦‚ public è¡¨ç¤ºå…¬æœ‰å±æ€§æˆ–æ–¹æ³•</li><li>æŠ½è±¡ç±»ï¼ˆAbstract Classï¼‰ï¼šæŠ½è±¡ç±»æ˜¯ä¾›å…¶ä»–ç±»ç»§æ‰¿çš„åŸºç±»ï¼ŒæŠ½è±¡ç±»ä¸å…è®¸è¢«å®ä¾‹åŒ–ã€‚æŠ½è±¡ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•å¿…é¡»åœ¨å­ç±»ä¸­è¢«å®ç°</li><li>æ¥å£ï¼ˆInterfacesï¼‰ï¼šä¸åŒç±»ä¹‹é—´å…¬æœ‰çš„å±æ€§æˆ–æ–¹æ³•ï¼Œå¯ä»¥æŠ½è±¡æˆä¸€ä¸ªæ¥å£ã€‚æ¥å£å¯ä»¥è¢«ç±»å®ç°ï¼ˆimplementsï¼‰ã€‚ä¸€ä¸ªç±»åªèƒ½ç»§æ‰¿è‡ªå¦ä¸€ä¸ªç±»ï¼Œä½†æ˜¯å¯ä»¥å®ç°å¤šä¸ªæ¥å£</li></ul><h3 id="ES6ä¸­ç±»çš„ç”¨æ³•"><a href="#ES6ä¸­ç±»çš„ç”¨æ³•" class="headerlink" title="ES6ä¸­ç±»çš„ç”¨æ³• "></a>ES6ä¸­ç±»çš„ç”¨æ³• <br><hr></h3><ol><li><p><strong>å®šä¹‰å±æ€§å’Œæ–¹æ³•</strong></p><pre><code> // å®šä¹‰ç±» class Parent{   // å®šä¹‰æ„é€ å‡½æ•°   constructor(name=&#39;wang&#39;,age=&#39;27&#39;){     // å®šä¹‰å±æ€§     this.name = name;     this.age = age;   }   // å®šä¹‰æ–¹æ³•   eat(){     console.log(`${this.name} ${this.age} eat food`)   } }</code></pre></li><li><p><strong>åˆ©ç”¨å…³é”®å­—extends å’Œ super ç»§æ‰¿</strong></p><pre><code> class Child extends Parent{      constructor(name = &#39;ren&#39;,age = &#39;27&#39;){        //ç»§æ‰¿çˆ¶ç±»å±æ€§       super(name, age);      }        eat(){        //ç»§æ‰¿çˆ¶ç±»æ–¹æ³•         super.eat()        }    }    let child =new Child(&#39;xiaoxiami&#39;);    child.eat();</code></pre></li><li><p><strong>å­˜å‚¨å™¨getter,setteræ”¹å˜å±æ€§å’Œè¯»å–</strong></p><pre><code> class People{   // å®šä¹‰æ„é€ å‡½æ•°   constructor(name){     // å®šä¹‰å±æ€§     this.name = name;   }   get name () {     return &#39;renbo&#39;;   }   set name (value) {     console.log(&#39;setter: &#39; + value);   }   // å®šä¹‰æ–¹æ³•   eat(){     console.log(`${this.name}  eat food`)   } } let people = new People(&#39;lisi&#39;); // setter: lisi people.name = &#39;zhangsan&#39;; // setter: zhangsan console.log(people.name); // renbo</code></pre></li><li><p><strong>é™æ€æ–¹æ³•ä½¿ç”¨staticä¿®é¥°ç¬¦ï¼ˆç”±äºåˆ†é…åœ¨é™æ€å†…å­˜ç©ºé—´ä¸­ï¼Œæ‰€ä»¥ä¸éœ€è¦å®ä¾‹åŒ–ï¼Œåªéœ€è¦åŠå½±å³å¯ï¼‰</strong></p><pre><code> class People{   // å®šä¹‰é™æ€æ–¹æ³•   static eat(name){     console.log(`${name} eat food`)   } } console.log(People.eat(&#39;renbo&#39;)) // renbo eat food</code></pre></li></ol><h3 id="ES7ä¸­ç±»çš„ç”¨æ³•"><a href="#ES7ä¸­ç±»çš„ç”¨æ³•" class="headerlink" title="ES7ä¸­ç±»çš„ç”¨æ³• "></a>ES7ä¸­ç±»çš„ç”¨æ³• <br><hr></h3><ol><li><p><strong>å®šä¹‰å±æ€§å¯ä»¥ç›´æ¥åœ¨ç±»ä¸­å®šä¹‰</strong></p><pre><code> class People{   name = &#39;zhangsan&#39;   constructor () {     //    } } let people = new People(); console.log(npeople.name) // zhangsan</code></pre></li><li><p><strong>å®šä¹‰é™æ€å±æ€§</strong></p><pre><code>class People{static  name = &#39;zhangsan&#39; constructor () {   //  }}console.log(People.name) // zhangsan</code></pre></li></ol><h3 id="TypeScript-ä¸­ç±»çš„ç”¨æ³•"><a href="#TypeScript-ä¸­ç±»çš„ç”¨æ³•" class="headerlink" title="TypeScript ä¸­ç±»çš„ç”¨æ³• "></a>TypeScript ä¸­ç±»çš„ç”¨æ³• <br><hr></h3><ol><li><strong>è¯´èµ· ts ä¸­çš„ç±»ä¸å¾—ä¸è¯´è®¿é—®ä¿®é¥°ç¬¦ public private protected</strong></li></ol><ul><li>public è¯´æ˜å±æ€§æˆ–æ–¹æ³•æ˜¯å…¬æœ‰çš„ï¼Œåœ¨ä»»ä½•åœ°æ–¹è¢«è®¿é—®åˆ°ï¼Œåœ¨ ts ä¸­æ–¹æ³•å’Œå±æ€§é»˜è®¤çš„æ˜¯ public</li><li>private è¯´æ˜å±æ€§æˆ–æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œä¸èƒ½åœ¨ç±»çš„å¤–éƒ¨è®¿é—®</li><li>protected è¯´æ˜å±æ€§æˆ–æ–¹æ³•æ˜¯å—ä¿æŠ¤çš„ï¼Œå’Œ private ç±»ä¼¼ï¼Œä½†æ˜¯ protected ä¹Ÿå¯ä»¥åœ¨å­ç±»ä¸­è®¿é—®</li></ul><p><strong>public ä¿®é¥°ç¬¦</strong></p><pre><code>class People {  public name;  public constructor(name) {    this.name = name;  }}let people = new People(&#39;renbo&#39;);console.log(people.name); // renbo</code></pre><p><strong>private ä¿®é¥°ç¬¦</strong></p><pre><code>class People {  private  name;  public constructor(name) {    this.name = name;  }}let people = new People(&#39;renbo&#39;);console.log(people.name); // Property &#39;name&#39; is private and only accessible within class &#39;People&#39;.// åœ¨å­ç±»ä¸­ä¹Ÿä¸å…è®¸è®¿é—®ï¼Œåªæ˜¯ç§æœ‰class People {  private  name: string;  public constructor(name: string) {    this.name = name;  }}class SmilePeople extends People {  public constructor (name:string) {    super(name)    console.log(this.name); // Property &#39;name&#39; is private and only accessible within class &#39;People&#39;.  }}</code></pre><p><strong>protected ä¿®é¥°ç¬¦</strong></p><pre><code>class People {  protected  name;  public constructor(name) {    this.name = name;  }}let people = new People(&#39;renbo&#39;);console.log(people.name); // Property &#39;name&#39; is protected and only accessible within class &#39;People&#39; and its subclasses.ts</code></pre><p><strong>protected ä¿®é¥°ç¬¦(å­ç±»è®¿é—®)</strong></p><pre><code>class People {  protected  name: string;  public constructor(name: string) {    this.name = name;  }}class SmilePeople extends People {  public constructor (name:string) {    super(name)    console.log(this.name)  }}let people  = new People (&#39;zhangsna&#39;)let smilePeople = new SmilePeople(&#39;wangwu&#39;); // wangwu</code></pre><ol start="2"><li><strong>æŠ½è±¡ç±»ï¼ˆ abstract ç”¨äºå®šä¹‰æŠ½è±¡ç±»ä»¥åŠæŠ½è±¡ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼‰</strong></li></ol><ul><li>æŠ½è±¡ç±»å¯ä»¥ä½œä¸ºæ´¾ç”Ÿå…¶ä»–ç±»çš„åŸºç±»</li><li>æŠ½è±¡ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•å¿…é¡»è¢«å­ç±»å®ç°</li><li>æŠ½è±¡ç±»æ— æ³•ç›´æ¥å®ä¾‹åŒ–</li><li>ä¸æ¥å£ä¸åŒï¼ŒæŠ½è±¡ç±»å¯ä»¥åŒ…å«å…¶æˆå‘˜çš„å®ç°ç»†èŠ‚</li></ul><pre><code>// ä¸Šè¿°1ï¼Œ2abstract class People {  public name:string;  public constructor (name:string) {    this.name = name;  }  public abstract eat():string}// æ´¾ç”Ÿç±»class SmilePeople extends People {  static food: string = &#39;apple&#39;  // eat æ–¹æ³•å¿…é¡»åœ¨å­ç±»ä¸­å®ç°  public eat ():string {    return `my name is ${this.name} I,m eating ${SmilePeople.food}`  }}let smilePeople = new SmilePeople(&#39;zhangsan&#39;);smilePeople.eat()// æ— æ³•ç›´æ¥å®ä¾‹åŒ–abstract class People {  public name:string;  public constructor (name:string) {    this.name = name;  }  public abstract eat ():void}let people = new People(&#39;zhangsan&#39;) // Cannot create an instance of an abstract class.</code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡½æ•°</title>
      <link href="/2019/05/16/typescript/function/"/>
      <url>/2019/05/16/typescript/function/</url>
      
        <content type="html"><![CDATA[<h3 id="å‡½æ•°çš„åˆ›å»º"><a href="#å‡½æ•°çš„åˆ›å»º" class="headerlink" title="å‡½æ•°çš„åˆ›å»º "></a>å‡½æ•°çš„åˆ›å»º <br></h3><p>åœ¨ ts ä¸­å‡½æ•°åˆ›å»ºä¹Ÿæ°›å›´ä¸¤ç§åŒ¿åå‡½æ•°å’Œæœ‰å‘½åçš„å‡½æ•°</p><pre><code>// æœ‰åå­—çš„å‡½æ•°function people () {}// åŒ¿åå‡½æ•°const people = function () {}</code></pre><h3 id="å‡½æ•°çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹"><a href="#å‡½æ•°çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹" class="headerlink" title="å‡½æ•°çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ "></a>å‡½æ•°çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ <br></h3><ul><li>åªè¦å‚æ•°ç±»å‹æ˜¯åŒ¹é…çš„ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºå®ƒæ˜¯æœ‰æ•ˆçš„å‡½æ•°ç±»å‹ï¼Œè€Œä¸åœ¨ä¹å‚æ•°åæ˜¯å¦æ­£</li><li>è®¾å®šäº†ç±»å‹ä¹‹åå¿…é¡»è¦è¿”å›ç›¸å¯¹åº”çš„ç±»å‹ï¼Œå¦åˆ™ä¼šæŠ¥é”™</li><li>å¦‚æœå‡½æ•°æ²¡æœ‰è¿”å›ä»»ä½•å€¼ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šè¿”å›å€¼ç±»å‹ä¸º voidè€Œä¸èƒ½ç•™ç©º<pre><code>/*** * @param {*} x number* @param {*} y number*  return add number */</code></pre></li></ul><p>const add = (x: number, y: number): number =&gt; x + y;<br>// ä¹¦å†™å®Œæ•´çš„å‡½æ•°ç±»å‹<br>const add: (x: number, y: number) =&gt; number = (x: number, y: number):number =&gt; x + y </p><pre><code>### å‡½æ•°çš„å¯é€‰å‚æ•°å’Œé»˜è®¤å‚æ•°&lt;br/&gt;- ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ä¸ªæ•°å¿…é¡»ä¸å‡½æ•°æœŸæœ›çš„å‚æ•°ä¸ªæ•°ä¸€è‡´ï¼Œå¦åˆ™ä¼šæŠ¥é”™- å¯é€‰å‚æ•°ç”¨`?argname`è¡¨ç¤ºï¼Œå¿…é¡»è·Ÿåœ¨å¿…é¡»å‚æ•°åé¢- æ²¡æœ‰ä¼ é€’å‚æ•°æˆ–ä¼ é€’çš„å€¼æ˜¯undefinedï¼Œè¿™ç§å«åšé»˜è®¤åˆå§‹åŒ–å€¼çš„å‚æ•°- æ‰€æœ‰å¿…é¡»å‚æ•°**åé¢**çš„å¸¦é»˜è®¤åˆå§‹åŒ–çš„å‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œè°ƒç”¨æ—¶å¯çœç•¥- å¸¦é»˜è®¤å€¼çš„å‚æ•°å¦‚æœå‡ºç°åœ¨å¿…é¡»å‚æ•°**å‰é¢**ï¼Œç”¨æˆ·å¿…é¡»æ˜ç¡®çš„ä¼ å…¥ undefined å€¼æ¥è·å¾—é»˜è®¤å€¼- å½“ä¼ å…¥çš„å‚æ•°ä¸ªæ•°ä¸å›ºå®šæ—¶ï¼Œå°†æ‰€æœ‰å‚æ•°æ”¶é›†åˆ°ä¸€ä¸ªå˜é‡é‡Œå’Œ js ä¸­çš„ arguments ç±»ä¼¼ï¼Œå‰©ä½™å‚æ•°ä¼šè¢«å½“åšä¸ªæ•°ä¸é™çš„å¯é€‰å‚æ•°ã€‚ å¯ä»¥ä¸€ä¸ªéƒ½æ²¡æœ‰ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥æœ‰ä»»æ„ä¸ªè¡¨è¾¾æ–¹å¼ä¸ºï¼ˆ...ï¼‰</code></pre><p>// ä¸Šè¿°1<br>const add: (x: number, y: number) =&gt; number = (x: number, y: number):number =&gt; x + y<br>add(1, 2) // 3<br>add(1) // æŠ¥é”™<br>add(1,2,3) // æŠ¥é”™</p><p>// ä¸Šè¿°2<br>const yourName = (firstName: string, lastName?: string): string =&gt; <code>${firstName}+${lastName}</code>;<br>console.log(yourName(â€˜renâ€™, â€˜boâ€™)) //ren+bo<br>console.log(yourName(â€˜renâ€™)) // ren+undefined</p><p>// ä¸Šè¿°3<br>const yourName = (firstName: string, lastName?: string): string =&gt; <code>${firstName}+${lastName}</code>;<br>console.log(yourName(â€˜renâ€™, â€˜boâ€™)) //ren+bo<br>console.log(yourName(â€˜renâ€™, undefined)) // ren+undefined</p><p>//ä¸Šè¿°4<br>const yourName = (firstName: string, lastName=â€™boâ€™): string =&gt; <code>${firstName}+${lastName}</code>;<br>console.log(yourName(â€˜renâ€™, â€˜boâ€™)) //ren+bo<br>console.log(yourName(â€˜renâ€™)) // ren+bo</p><p>// ä¸Šè¿°5<br>const yourName = ( lastName=â€™boâ€™, firstName: string): string =&gt; <code>${firstName}+${lastName}</code>;<br>console.log(yourName(â€˜renâ€™, â€˜boâ€™)) //bo+ren<br>console.log(yourName(undefined, â€˜renâ€™)) // ren+bo</p><p>// ä¸Šè¿°6<br>const people = ( name: string, â€¦otherProperty: string[]): string =&gt; {<br>  return name + â€œ â€œ + otherProperty.join(â€œ â€œ);<br>}<br>console.log(people(â€˜renboâ€™, â€˜28â€™,â€™170â€™))  // renbo 28 170 </p><pre><code>### å‡½æ•°çš„é‡è½½ &lt;br/&gt;é‡è½½å…è®¸ä¸€ä¸ªå‡½æ•°æ¥å—ä¸åŒæ•°é‡æˆ–ç±»å‹çš„å‚æ•°æ—¶ï¼Œä½œå‡ºä¸åŒçš„å¤„ç†</code></pre><p>// æˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹é€šè¿‡ä¼ å…¥ä¸åŒçš„ type æ¥å®ç°å‡½æ•°çš„åŠ æ“ä½œå’Œä¹˜æ³•æ“ä½œå¹¶è¿”å›ç›¸åº”çš„ç±»å‹<br>const compute = (type: number, â€¦resetData: number[]):number | string =&gt; {<br>  if (type === 1 ) {<br>    return resetData.reduce((a:number, b:number):number =&gt; a + b);<br>  } else if (type === 2) {<br>    return String(resetData.reduce((a:number, b:number):number =&gt; a * b));<br>  }<br>}<br>console.log(compute(1, 3, 4, 5, 6)) // 18<br>console.log(compute(2, 3, 4, 5, 6)) // â€˜360â€™</p><p>// é€šè¿‡ä¸Šé¢çš„å®ç°å”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯ä¸èƒ½æ˜ç¡®é€šè¿‡typeè¿”å›çš„ç›¸å¯¹åº”çš„è®¡ç®—çš„å€¼å’Œç±»å‹</p><p>const compute = (type: number, â€¦resetData: number[]):number;<br>const compute = (type: number, â€¦resetData: number[]):string;<br>const compute = (type: number, â€¦resetData: number[]):number | string =&gt; {<br>  if (type === 1 ) {<br>    return resetData.reduce((a:number, b:number):number =&gt; a + b);<br>  } else if (type === 2) {<br>    return String(resetData.reduce((a:number, b:number):number =&gt; a * b));<br>  }<br>}<br>console.log(compute(1, 3, 4, 5, 6)) // 18<br>console.log(compute(2, 3, 4, 5, 6)) // â€˜360â€™</p><p>// ä¸Šä¾‹ä¸­ï¼Œæˆ‘ä»¬é‡å¤å®šä¹‰äº†å¤šæ¬¡å‡½æ•° computeï¼Œå‰å‡ æ¬¡éƒ½æ˜¯å‡½æ•°å®šä¹‰ï¼Œæœ€åä¸€æ¬¡æ˜¯å‡½æ•°å®ç°ã€‚</p><pre><code></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€ä¹‹æ¦‚è¿°å’Œç¯å¢ƒé…ç½®</title>
      <link href="/2019/05/15/typescript/envconfig/"/>
      <url>/2019/05/15/typescript/envconfig/</url>
      
        <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯TypeScriptï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯TypeScriptï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯TypeScriptï¼Ÿ"></a>ä»€ä¹ˆæ˜¯TypeScriptï¼Ÿ<br></h3><p>  tsæ˜¯ä¸€ç§çš„å¼€æºçš„ç¼–ç¨‹è¯­è¨€ï¼Œæ˜¯ç”±Microsoftä¸»å¯¼ç ”å‘ã€‚ä»å·¥ä½œæœºåˆ¶ä¸Šè®²ï¼Œå®ƒå°±åƒjavaScriptçš„è¶…é›†ã€‚è¿™ä¸ªè¯­è¨€æ·»åŠ äº†å¯é€‰çš„é™æ€ç±»å‹å’ŒåŸºäºç±»çš„é¢å‘å¯¹è±¡ç¼–ç¨‹ã€‚2012å¹´é¦–ä¸ªç‰ˆæœ¬å…¬å¸ƒ</p><h3 id="TypeScriptçš„ç‰¹ç‚¹"><a href="#TypeScriptçš„ç‰¹ç‚¹" class="headerlink" title="TypeScriptçš„ç‰¹ç‚¹?"></a>TypeScriptçš„ç‰¹ç‚¹?</h3><ul><li>JavaScriptå¯ä»¥ä½¿ç”¨TypeScriptã€‚æ‰€æœ‰TypeScriptä»£ç ä¹Ÿéƒ½è½¬æ¢ä¸ºå®ƒçš„JavaScriptç­‰æ•ˆä»£ç </li><li>TypeScriptæ”¯æŒå…¶ä»–JSåº“</li><li>TypeScriptæ˜¯å¯ç§»æ¤çš„ã€‚TypeScriptå¯è·¨æµè§ˆå™¨ï¼Œè®¾å¤‡å’Œæ“ä½œç³»ç»Ÿçš„ç§»æ¤</li><li>TypeScriptä¸ECMAScript6è§„èŒƒä¸€è‡´</li></ul><h3 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨TypeScriptï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨TypeScriptï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨TypeScriptï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨TypeScriptï¼Ÿ<br></h3><p>  ä½œä¸ºå‰ç«¯å¼€å‘äººå‘˜æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä»æœ¬è´¨ä¸Šè®²ï¼ŒJavaScriptæ˜¯ä¸€ç§è‡ªç”±è¯­è¨€ï¼Œä¹Ÿå«å¼±ç±»å‹çš„è¯­è¨€ï¼Œå®ƒçš„è¯­æ³•è§„åˆ™å¹¶ä¸æ˜¯é‚£ä¹ˆä¸¥æ ¼ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œæˆ‘ä»¬å°±æ›´å®¹æ˜“çŠ¯é”™ï¼Œè€Œä¸”ï¼Œå³ä½¿æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½æ‰¾åˆ°æ‰€æœ‰çš„é”™è¯¯ã€‚é‰´äºæ­¤ï¼ŒTypeScriptä½œä¸ºJavaScriptçš„è¶…é›†ï¼Œå®ƒçš„è¯­æ³•æ›´ä¸¥æ ¼ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™å°±èƒ½å¤Ÿå‘ç°å¤§éƒ¨åˆ†é”™è¯¯ã€‚ä¸ä»…å¦‚æ­¤ï¼ŒæŒ‰ç…§TypeScriptå®˜æ–¹çš„è¯´æ³•ï¼ŒTypeScriptä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä»¥JavaScriptçš„æ–¹å¼å®ç°è‡ªå·±çš„æ„æ€ã€‚TypeScriptå¯¹é¢å‘å¯¹è±¡çš„æ”¯æŒä¹Ÿéå¸¸å®Œå–„ï¼Œå®ƒæ‹¥æœ‰é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€çš„æ‰€æœ‰ç‰¹æ€§ã€‚å¦‚æœä½ æƒ³è¦è·å–æœ‰å…³TypeScriptçš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥å‰å¾€TypeScriptçš„å®˜æ–¹ç½‘ç«™: <a href="http://www.typescriptlang.org/" target="_blank" rel="noopener">TypeScript - JavaScript that scales.</a></p><h3 id="TypeScriptçš„ç»„æˆéƒ¨åˆ†"><a href="#TypeScriptçš„ç»„æˆéƒ¨åˆ†" class="headerlink" title="TypeScriptçš„ç»„æˆéƒ¨åˆ†?"></a>TypeScriptçš„ç»„æˆéƒ¨åˆ†?</h3><ul><li>è¯­è¨€å±‚ - å®ƒåŒ…æ‹¬è¯­æ³•ï¼Œå…³é”®å­—å’Œç±»å‹æ³¨é‡Š</li><li>ç¼–è¯‘å™¨å±‚ - TypeScriptç¼–è¯‘å™¨ï¼ˆTSCï¼‰å°†ä½¿ç”¨TypeScriptç¼–å†™çš„æŒ‡ä»¤è½¬æ¢ä¸ºå…¶ç­‰æ•ˆçš„JavaScript</li><li>è¯­è¨€æœåŠ¡å±‚ - â€œè¯­è¨€æœåŠ¡â€åœ¨æ ¸å¿ƒç¼–è¯‘ç®¡é“å‘¨å›´å…¬å¼€äº†ä¸€ä¸ªé¢å¤–çš„å±‚ï¼Œå®ƒæ˜¯ç±»ä¼¼ç¼–è¾‘å™¨çš„åº”ç”¨ç¨‹åºã€‚tsç¼–è¯‘æ ¸å¿ƒ(core.ts,program.ts,scanner.ts,parser.ts,checker,emitter.ts)<br><br><image src="images/ts-lang.png" width="350"></image></li></ul><h3 id="TypeScript-ç¯å¢ƒé…ç½®ï¼ˆæœ¬æ–‡ä¸è®¨è®º-windows-å®‰è£…è¿‡ç¨‹å’Œ-mac-ç±»ä¼¼ï¼‰"><a href="#TypeScript-ç¯å¢ƒé…ç½®ï¼ˆæœ¬æ–‡ä¸è®¨è®º-windows-å®‰è£…è¿‡ç¨‹å’Œ-mac-ç±»ä¼¼ï¼‰" class="headerlink" title="TypeScript ç¯å¢ƒé…ç½®ï¼ˆæœ¬æ–‡ä¸è®¨è®º windows å®‰è£…è¿‡ç¨‹å’Œ mac ç±»ä¼¼ï¼‰"></a>TypeScript ç¯å¢ƒé…ç½®ï¼ˆæœ¬æ–‡ä¸è®¨è®º windows å®‰è£…è¿‡ç¨‹å’Œ mac ç±»ä¼¼ï¼‰</h3><ul><li>ä¸‹è½½å¹¶å®‰è£… node <a href="https://nodejs.org/en/" target="_blank" rel="noopener">ç›¸å…³ node å®˜ç½‘</a></li><li>æŸ¥çœ‹ node æ˜¯å¦å®‰è£…æˆåŠŸï¼Œåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ <code>node -v</code> å¦‚æœå‡ºç°ç‰ˆæœ¬å·åˆ™è¯æ˜ node å®‰è£…æˆåŠŸ </li><li>é€šè¿‡ npm å®‰è£… typescript <code>npm install -g typescript</code> </li><li>åˆ›å»º filename.ts æ–‡ä»¶åœ¨æ–‡ä»¶ä¸­ä¹¦å†™ç›¸åº”tsä»£ç </li><li>æ‰§è¡Œ <code>tsc filename.ts</code> ç¼–è¯‘è¿‡åé»˜è®¤ä¼šåœ¨å½“å‰ç›®å½•äº§ç”Ÿjsæ–‡ä»¶,åœ¨é¡µé¢ä¸­å¼•å…¥jsæ–‡ä»¶å³å¯</li><li>åç»­åœ¨tsconfig.json ä¸­è®¨è®ºé…ç½®ç›‘å¬å±æ€§</li></ul>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡½æ•°èŠ‚æµä¸æŠ–åŠ¨</title>
      <link href="/2019/05/15/javascript/debounce/"/>
      <url>/2019/05/15/javascript/debounce/</url>
      
        <content type="html"><![CDATA[<h3 id="æµè§ˆå™¨å†…æ ¸"><a href="#æµè§ˆå™¨å†…æ ¸" class="headerlink" title="æµè§ˆå™¨å†…æ ¸"></a>æµè§ˆå™¨å†…æ ¸</h3><p>è¯´èµ·å‡½æ•°çš„èŠ‚æµä¸æŠ–åŠ¨è¿™ä¸ªè€ç”Ÿé•¿è°ˆçš„è¯é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦äº†è§£ä¸€ä¸‹å…³äºæµè§ˆå™¨çš„çŸ¥è¯†</p><p>æµè§ˆå™¨æœ‰å„ç§è¿›ç¨‹ï¼Œæ¥ä¿è¯æµè§ˆå™¨æ­£å¸¸çš„ã€æµç•…çš„å‘ˆç°åœ¨ç”¨æˆ·çš„çœ¼å‰ã€‚ä¾‹å¦‚æ¸²æŸ“è¿›ç¨‹ï¼ˆä¹Ÿå°±æ˜¯æµè§ˆå™¨çš„å†…æ ¸ï¼‰æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªè¿›ç¨‹ï¼Œå…¶ä¸­åŒ…å«äº†å¾ˆå¤šçš„çº¿ç¨‹</p><pre><code>GUIæ¸²æŸ“çº¿ç¨‹(è´Ÿè´£æ¸²æŸ“æµè§ˆå™¨ç•Œé¢ï¼Œè§£æHTML,CSS,æ„å»ºDOMæ ‘å’ŒRenderObjectæ ‘ï¼Œå¸ƒå±€å’Œç»˜åˆ¶ç­‰)JSå¼•æ“çº¿ç¨‹(JSå†…æ ¸ï¼Œè´Ÿè´£å¤„ç†JavaScriptè„šæœ¬ç¨‹åº)äº‹ä»¶è§¦å‘çº¿ç¨‹(å½’å±äºæµè§ˆå™¨è€Œä¸æ˜¯JSå¼•æ“ï¼Œç”¨æ¥æ§åˆ¶äº‹ä»¶å¾ªç¯)å®šæ—¶è§¦å‘å™¨çº¿ç¨‹(ä¼ è¯´ä¸­çš„setTimeoutå’ŒsetIntervalæ‰€åœ¨çš„çº¿ç¨‹)å¼‚æ­¥httpè¯·æ±‚çº¿ç¨‹(åœ¨XMLHttpRequeståœ¨è¿æ¥åæ˜¯é€šè¿‡æµè§ˆå™¨æ–°å‹ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚)</code></pre><p>è¿™é‡Œæˆ‘ä»¬å¤§æ¦‚äº†è§£ä¸€ä¸‹ç€å‡ ä¸ªæ¦‚å¿µï¼Œå…³äºæ›´è¿‡çš„ç›¸å…³çŸ¥è¯†ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­ä»‹ç»</p><h3 id="è¯·æ±‚è¿‡ç¨‹"><a href="#è¯·æ±‚è¿‡ç¨‹" class="headerlink" title="è¯·æ±‚è¿‡ç¨‹"></a>è¯·æ±‚è¿‡ç¨‹</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹é¢ä¸€å¼ æ¥è‡³ W3C çš„å›¾</p><p><img src="/images/timestamp-diagram.svg"></p><p>ä»å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°å¤„ç†æ¨¡å‹å¤§æ¦‚åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªé˜¶æ®µ</p><ul><li>DNS æŸ¥è¯¢</li><li>TCP è¿æ¥</li><li>HTTP è¯·æ±‚å³å“åº”</li><li>æœåŠ¡å™¨å“åº”</li><li>å®¢æˆ·ç«¯æ¸²æŸ“</li></ul><p>è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¸è®¨è®º Resource Timing é˜¶æ®µï¼Œä¼šåœ¨åç»­æ–‡ç« å‰ç«¯æ€§èƒ½çš„æ—¶å€™é‡æ–°æèµ·</p><h3 id="æ¸²æŸ“è¿‡ç¨‹"><a href="#æ¸²æŸ“è¿‡ç¨‹" class="headerlink" title="æ¸²æŸ“è¿‡ç¨‹"></a>æ¸²æŸ“è¿‡ç¨‹</h3><p>é€šè¿‡ç¬¬äº”ä¸ªé˜¶æ®µå®¢æˆ·ç«¯æ¸²æŸ“ç®€å•çš„å›å¿†ä¸€ä¸‹ç½‘é¡µçš„ç”Ÿæˆè¿‡ç¨‹ï¼Œå¤§è‡´åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤</p><ul><li>HTMLè§£æå™¨è§£ææˆDOM æ ‘</li><li>CSSè§£æå™¨è§£ææˆCSSOM æ ‘</li><li>ç»“åˆDOMæ ‘å’ŒCSSOMæ ‘ï¼Œç”Ÿæˆä¸€æ£µæ¸²æŸ“æ ‘(Render Tree)</li><li>ç”Ÿæˆå¸ƒå±€ï¼ˆLayoutï¼‰ï¼Œæ ¹æ®æ¸²æŸ“æ ‘æ¥å¸ƒå±€ï¼Œä»¥è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å‡ ä½•ä¿¡æ¯</li><li>æœ€åä¸€æ­¥æ˜¯ç»˜åˆ¶ï¼ˆPaintï¼‰ï¼Œä½¿ç”¨æœ€ç»ˆæ¸²æŸ“æ ‘å°†åƒç´ æ¸²æŸ“åˆ°åœ¨å±å¹•ä¸Š</li></ul><img src="/images/render-process.jpg"><p>é€šè¿‡ä¸Šé¢çš„æ€»ç»“æˆ‘ä»¬è§£ææ¯ä¸€ä¸ªæ­¥éª¤èƒ½æ›´åŠ æ·±å…¥çš„äº†è§£æµè§ˆå™¨æ¸²æŸ“è¿‡ç¨‹</p><h3 id="HTML-è§£æå™¨è§£æè¿‡ç¨‹"><a href="#HTML-è§£æå™¨è§£æè¿‡ç¨‹" class="headerlink" title="HTML è§£æå™¨è§£æè¿‡ç¨‹"></a>HTML è§£æå™¨è§£æè¿‡ç¨‹</h3><p>HTML è§£æå™¨æ„å»º DOM æ ‘ï¼Œå®é™…ä¸Šæ˜¯ç»è¿‡ä¸‹é¢å‡ ä¸ªæ­¥éª¤</p><pre><code>å­—èŠ‚ -&gt; å­—ç¬¦ -&gt; ä»¤ç‰Œ -&gt; èŠ‚ç‚¹å¯¹è±¡ -&gt; å¯¹è±¡æ¨¡å‹ç¼–ç é˜¶æ®µå°† HTML çš„åŸå§‹å­—èŠ‚æ•°æ®è½¬æ¢ä¸ºæ–‡ä»¶æŒ‡å®šç¼–ç ä»¤ç‰Œé˜¶æ®µæ ¹æ®HTMLè§„èŒƒæ¥å°†å­—ç¬¦ä¸²è½¬æ¢æˆå„ç§ä»¤ç‰Œä¹Ÿå°±æ˜¯æ ‡ç­¾èŠ‚ç‚¹ç”ŸæˆèŠ‚ç‚¹å¯¹è±¡é˜¶æ®µæ˜¯æ ¹æ®æ¯ä¸ªä»¤ç‰Œè½¬æ¢å®šä¹‰å…¶å±æ€§å’Œè§„åˆ™çš„å¯¹è±¡ï¼ˆèŠ‚ç‚¹å¯¹è±¡ï¼‰æœ€åé˜¶æ®µ DOM æ ‘æ„å»ºå®Œæˆï¼Œæ•´ä¸ªå¯¹è±¡é›†åˆå°±åƒæ˜¯ä¸€æ£µæ ‘å½¢ç»“æ„ï¼ˆå¯¹è±¡æ¨¡å‹ï¼‰</code></pre><p>ä¸‹é¢é€šè¿‡ä»£ç å’Œå›¾ç‰‡æ¥è§£é‡Šä¸Šé¢çš„æ­¥éª¤</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width,initial-scale<span class="token punctuation">=</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>style.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Hello <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>web performance<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span> students!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/dom-render.jpg"><h3 id="CSS-è§£æè¿‡ç¨‹"><a href="#CSS-è§£æè¿‡ç¨‹" class="headerlink" title="CSS è§£æè¿‡ç¨‹"></a>CSS è§£æè¿‡ç¨‹</h3><p>æµè§ˆå™¨è·å¾— CSS æ–‡ä»¶çš„æ•°æ®å CSS è§£æå™¨æ ¹æ®å…·ä½“çš„æ ·å¼å°†æ¸²æŸ“ CSSDOM æ ‘</p><img src="/images/css-dom-render.jpg"><h3 id="æ¸²æŸ“æ ‘æ¸²æŸ“"><a href="#æ¸²æŸ“æ ‘æ¸²æŸ“" class="headerlink" title="æ¸²æŸ“æ ‘æ¸²æŸ“"></a>æ¸²æŸ“æ ‘æ¸²æŸ“</h3><p>æ„å»º ä¸¤ä¸ªæ ‘ä¹‹åæ¸²æŸ“æ ‘å‡ºåœºï¼Œæµè§ˆå™¨ä¼šå…ˆä»DOMæ ‘çš„æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œå¯¹æ¯ä¸ªå¯è§èŠ‚ç‚¹ï¼Œæ‰¾åˆ°å¯¹åº”çš„ CSS æ ·å¼è§„åˆ™ï¼Œè¿›è¡ŒåŒ¹é…å½¢æˆæ„å»ºå®Œæˆçš„æ¸²æŸ“æ ‘</p><img src="/images/render-tree.jpg"><p>æ¸²æŸ“æ ‘æ„å»ºåæµè§ˆå™¨æ ¹æ®èŠ‚ç‚¹å¯¹è±¡çš„è§„åˆ™è¿›è¡Œflowï¼ˆå¸ƒå±€ï¼‰é˜¶æ®µï¼Œå¸ƒå±€é˜¶æ®µä¼šä»æ¸²æŸ“æ ‘çš„æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œç„¶åç¡®å®šæ¯ä¸ªèŠ‚ç‚¹å¯¹è±¡åœ¨é¡µé¢ä¸Šçš„ç¡®åˆ‡å¤§å°ä¸ä½ç½®æœ€åç”Ÿæˆæˆ‘ä»¬å¤§å®¶çŸ¥é“çš„æµè§ˆå™¨ç›’æ¨¡å‹</p><p>æœ€åå½“Layoutå¸ƒå±€äº‹ä»¶å®Œæˆåï¼Œæµè§ˆå™¨ä¼šç«‹å³å‘å‡ºPaint Setupä¸Paintäº‹ä»¶ï¼Œå¼€å§‹å°†æ¸²æŸ“æ ‘ç»˜åˆ¶æˆåƒç´ ï¼Œæœ€åæ¸²æŸ“åˆ°åœ¨å±å¹•ä¸Š</p><p>é€šè¿‡ä¸Šé¢å¤§è‡´çš„æµç¨‹æˆ‘ä»¬çŸ¥é“äº†æµè§ˆå™¨çš„æ¸²æŸ“è¿‡ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ç½‘é¡µåœ¨ç”Ÿæˆçš„æ—¶å€™ï¼Œè‡³å°‘ä¼šæ¸²æŸ“ä¸€æ¬¡æ‰§è¡Œcssä¹‹å load å¯¹åº” JS ä¹Ÿä¼šè¿›è¡Œé‡æ–°æ¸²æŸ“</p><p>é‡æ–°æ¸²æŸ“å°±å¯èƒ½ä¼š reflow + repaint</p><h3 id="é‡ç»˜ä¸å›æµ"><a href="#é‡ç»˜ä¸å›æµ" class="headerlink" title="é‡ç»˜ä¸å›æµ"></a>é‡ç»˜ä¸å›æµ</h3><p>å›æµ(reflow)ï¼š å½“render treeä¸­çš„ä¸€éƒ¨åˆ†(æˆ–å…¨éƒ¨)å› ä¸ºå…ƒç´ çš„è§„æ¨¡å°ºå¯¸ã€å¸ƒå±€ã€éšè—ç­‰æ”¹å˜è€Œéœ€è¦é‡æ–°æ„å»º</p><p>é‡ç»˜(repaint): å½“ä¸€ä¸ªå…ƒç´ çš„å¤–è§‚å‘ç”Ÿæ”¹å˜ï¼Œä½†æ²¡æœ‰æ”¹å˜å¸ƒå±€,é‡æ–°æŠŠå…ƒç´ å¤–è§‚ç»˜åˆ¶å‡ºæ¥çš„è¿‡ç¨‹ï¼Œå«åšé‡ç»˜</p><p>å›æµå¿…å®šä¼šå‘ç”Ÿé‡ç»˜ï¼Œé‡ç»˜ä¸ä¸€å®šä¼šå¼•å‘å›æµ</p><p>æµè§ˆå™¨çš„reflow + repaint åœ¨æˆ‘ä»¬è®¾ç½®èŠ‚ç‚¹æ ·å¼æ—¶é¢‘ç¹å‡ºç°ï¼Œå¯¹æ€§èƒ½æ˜¯ä¸ªå·¨å¤§çš„æ¶ˆè€—ï¼Œå› ä¸ºå›æµæ‰€éœ€çš„æˆæœ¬æ¯”é‡ç»˜é«˜çš„å¤šï¼Œæ”¹å˜çˆ¶èŠ‚ç‚¹é‡Œçš„å­èŠ‚ç‚¹å¾ˆå¯èƒ½ä¼šå¯¼è‡´çˆ¶èŠ‚ç‚¹çš„ä¸€ç³»åˆ—å›æµï¼Œæ‰€ä»¥æˆ‘ä»¬ç»å¸¸è¯´å°½å¯èƒ½çš„å‡å°‘é‡æ’æ¬¡æ•°ã€é‡æ’èŒƒå›´ï¼Œè¿™æ ·å°±èƒ½å‘ˆç°ç»™ç”¨æˆ·æ›´æ”¹çš„æ„Ÿå®˜ï¼ˆå…³äºä¼˜åŒ–æ‰‹æ®µä¼šåœ¨åç»­çš„æ€§èƒ½ä¼˜åŒ–æ–‡ç« ä¸­ä»‹ç»ï¼‰</p><p>æ ¹æ®ä¸Šé¢è¯´äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ¥è¿›å…¥æ–‡ç« çš„ä¸»é¢˜<strong>é˜²æŠ–å’ŒèŠ‚æµ</strong>å½“æˆ‘ä»¬çª—å£å‘ç”Ÿæ”¹å˜ï¼Œæµè§ˆå™¨çš„æ»šåŠ¨æ¡æ‰§è¡Œscrollï¼Œè¾“å…¥æ¡†æ ¡éªŒï¼Œæœç´¢è¯·æ±‚æ¥å£ç­‰è¿™äº›éƒ½ä¼šä½¿é¡µé¢é¢‘ç¹é‡æ–°æ¸²æŸ“ï¼ŒåŠ é‡æµè§ˆå™¨çš„è´Ÿæ‹…ï¼Œè¿™æ˜¯æˆ‘ä»¬é€šè¿‡<strong>é˜²æŠ–å’ŒèŠ‚æµ</strong>çš„æ–¹å¼å‡å°‘è§¦å‘é¢‘ç‡ï¼Œè¿™æ ·å°±ä¼šå¤§å¤§çš„æé«˜ç”¨æˆ·ä½“éªŒ</p><h3 id="debounceï¼ˆé˜²æŠ–ï¼‰"><a href="#debounceï¼ˆé˜²æŠ–ï¼‰" class="headerlink" title="debounceï¼ˆé˜²æŠ–ï¼‰"></a>debounceï¼ˆé˜²æŠ–ï¼‰</h3><p>åŠ¨ä½œå‘ç”Ÿä¸€å®šæ—¶é—´åè§¦å‘äº‹ä»¶ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå¦‚æœè¯¥åŠ¨ä½œåˆå‘ç”Ÿï¼Œåˆ™é‡æ–°ç­‰å¾…ä¸€å®šæ—¶é—´å†è§¦å‘äº‹ä»¶ã€‚</p><p>html </p><pre class="line-numbers language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ie<span class="token punctuation">=</span>edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>é˜²æŠ–<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">    <span class="token selector"><span class="token id">#container</span></span><span class="token punctuation">{</span>      <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100%</span><span class="token punctuation">;</span>       <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span>       <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode">#000</span><span class="token punctuation">;</span>       <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">50</span>px<span class="token punctuation">;</span>      <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#fff</span><span class="token punctuation">;</span>      <span class="token property">line-height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span>       <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>     <span class="token punctuation">}</span>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>debounce.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">getContent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>      container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> count<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// container.onmousemove = getContent</span>    container<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span>getContent<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>debounce.js </p><pre class="line-numbers language-js"><code class="language-js">@underscore<span class="token punctuation">.</span>js<span class="token keyword">var</span> debounce <span class="token operator">=</span> <span class="token comment" spellcheck="true">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/**   * @desc å‡½æ•°é˜²æŠ–   * @param {*} func å›è°ƒå‡½æ•°   * @param {*} wait å»¶è¿Ÿæ‰§è¡Œæ¯«ç§’æ•°   * @param {*} immediate  true è¡¨ç«‹å³æ‰§è¡Œï¼Œfalse è¡¨éç«‹å³æ‰§è¡Œ   */</span>  <span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªæ ‡è®°ç”¨æ¥å­˜æ”¾å®šæ—¶å™¨çš„è¿”å›å€¼</span>    <span class="token keyword">var</span> timeout<span class="token punctuation">,</span>result<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// æŒ‡å®šthis ä½œç”¨åŸŸ</span>      <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// event å¯¹è±¡</span>      <span class="token keyword">var</span> args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// å†æ¬¡æ‰§è¡Œäº‹ä»¶çš„æ—¶å€™ï¼Œæ¸…é™¤ä¸Šä¸€ä¸ªå®šæ—¶å™¨</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœå·²ç»æ‰§è¡Œè¿‡ï¼Œå°†ä¸å†æ‰§è¡Œ</span>        <span class="token keyword">var</span> callNow <span class="token operator">=</span> <span class="token operator">!</span>timeout<span class="token punctuation">;</span>        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>callNow<span class="token punctuation">)</span> result <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">else</span> <span class="token punctuation">{</span>        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// func è¿™ä¸ªå‡½æ•°ï¼Œå¯èƒ½æœ‰è¿”å›å€¼</span>      <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> debounce<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h3><p>åŠ¨ä½œæ‰§è¡Œä¸€æ®µæ—¶é—´åè§¦å‘äº‹ä»¶ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå¦‚æœåŠ¨ä½œåˆå‘ç”Ÿï¼Œåˆ™æ— è§†è¯¥åŠ¨ä½œï¼Œç›´åˆ°äº‹ä»¶æ‰§è¡Œå®Œåï¼Œæ‰èƒ½é‡æ–°æ‰§è¡Œ</p><p>å…³äºèŠ‚æµçš„å®ç°ï¼Œæœ‰ä¸¤ç§ä¸»æµçš„å®ç°æ–¹å¼ï¼Œä¸€ç§æ˜¯ä½¿ç”¨æ—¶é—´æˆ³ï¼Œä¸€ç§æ˜¯è®¾ç½®å®šæ—¶å™¨</p><p>ä½¿ç”¨æ—¶é—´æˆ³</p><p>å½“è§¦å‘äº‹ä»¶çš„æ—¶å€™ï¼Œå–å‡ºå½“å‰çš„æ—¶é—´æˆ³ï¼Œä¹‹åå‡å»ä¹‹å‰çš„æ—¶é—´æˆ³(æœ€ä¸€å¼€å§‹å€¼è®¾ä¸º 0 )ï¼Œå¦‚æœå¤§äºè®¾ç½®çš„æ—¶é—´å‘¨æœŸï¼Œæ‰§è¡Œå‡½æ•°å¹¶æ›´æ–°å½“å‰æ—¶é—´æˆ³ï¼Œåä¹‹å°±ä¸æ‰§è¡Œã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> throttle <span class="token operator">=</span> <span class="token comment" spellcheck="true">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> args<span class="token punctuation">;</span>    <span class="token keyword">var</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> now <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> previous <span class="token operator">></span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>        func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        previous <span class="token operator">=</span> now<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> throttle<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨å®šæ—¶å™¨</p><p>äº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¦‚æœå®šæ—¶å™¨å­˜åœ¨ï¼Œå°±ä¸æ‰§è¡Œï¼Œç­‰å®šæ—¶å™¨åˆ°æŒ‡å®šçš„æ—¶é—´ï¼Œæ¸…ç©ºå®šæ—¶å™¨ï¼Œæ‰§è¡Œäº‹ä»¶</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> timeout<span class="token punctuation">;</span>  <span class="token keyword">var</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>      timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹æ¯”ä¸¤ç§å®ç°æ–¹å¼</p><ul><li>ç¬¬ä¸€ç§ä¼šç«‹åˆ»æ‰§è¡Œï¼Œç¬¬äºŒç§ä¼šåœ¨è®¾å®šçš„æ—¶é—´åç¬¬ä¸€æ¬¡æ‰§è¡Œ</li><li>ç¬¬ä¸€ç§åœæ­¢è§¦å‘åä¸ä¼šå†æ‰§è¡Œï¼Œç¬¬äºŒç§åœæ­¢è§¦å‘åä¾ç„¶ä¼šå†æ‰§è¡Œä¸€æ¬¡</li></ul><p>ç°åœ¨æˆ‘ä»¬è¦ç»“åˆä¸Šé¢ä¸¤ç§æ–¹å¼å®ç°ä¸€ä¸ªå¼€å§‹è§¦å‘ç«‹åˆ»æ‰§è¡Œï¼Œåœæ­¢è§¦å‘çš„æ—¶å€™è¿˜èƒ½å†æ‰§è¡Œä¸€æ¬¡</p><pre class="line-numbers language-js"><code class="language-js">@underscore<span class="token punctuation">.</span>js<span class="token keyword">var</span> throttle <span class="token operator">=</span> <span class="token comment" spellcheck="true">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/**   * throttle èŠ‚æµ   * @param {*} func  å›è°ƒå‡½æ•°   * @param {*} wait  æ‰§è¡Œæ—¶é—´é—´éš”   * @param {*} options  å¦‚æœæƒ³å¿½ç•¥å¼€å§‹å‡½æ•°çš„çš„è°ƒç”¨ï¼Œä¼ å…¥{leading: false}   *                     å¦‚æœæƒ³å¿½ç•¥ç»“å°¾å‡½æ•°çš„è°ƒç”¨ï¼Œä¼ å…¥{trailing: false}   *                     ä¸¤è€…ä¸èƒ½å…±å­˜ï¼Œå¦åˆ™å‡½æ•°ä¸èƒ½æ‰§è¡Œ   */</span>  <span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> timeout<span class="token punctuation">,</span> context<span class="token punctuation">,</span> args<span class="token punctuation">;</span>    <span class="token keyword">var</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> later <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¦‚æœè®¾ç½®äº† leadingï¼Œå°±å°† previous è®¾ä¸º 0</span>      previous <span class="token operator">=</span> options<span class="token punctuation">.</span>leading <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// ç½®ç©ºä¸€æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜æ³„æ¼ï¼ŒäºŒæ˜¯ä¸ºäº†ä¸‹é¢çš„å®šæ—¶å™¨åˆ¤æ–­</span>      timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> context <span class="token operator">=</span> args <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> throttled <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previous <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>leading <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> previous <span class="token operator">=</span> now<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// è®¡ç®—å‰©ä½™æ—¶é—´</span>      <span class="token keyword">var</span> remaining <span class="token operator">=</span> wait <span class="token operator">-</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> previous<span class="token punctuation">)</span><span class="token punctuation">;</span>      context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>      args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> remaining <span class="token operator">></span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœå­˜åœ¨å®šæ—¶å™¨å°±æ¸…ç†æ‰å¦åˆ™ä¼šè°ƒç”¨äºŒæ¬¡å›è°ƒ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>          timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        previous <span class="token operator">=</span> now<span class="token punctuation">;</span>        func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> context <span class="token operator">=</span> args <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>trailing <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†å®šæ—¶å™¨å’Œ trailingï¼Œæ²¡æœ‰å°±å¼€å¯ä¸€ä¸ªå®šæ—¶å™¨</span>        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>later<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> throttled<span class="token punctuation">;</span><span class="token punctuation">}</span>  <span class="token keyword">return</span> throttle<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒç”¨ä¾‹å­</p><pre class="line-numbers language-js"><code class="language-js">ontainer<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span>getContent<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>container<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span>getContent<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  leading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>container<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span>getContent<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  trailing<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä¸Šé¢çš„å°±æ˜¯å‡½æ•°çš„èŠ‚æµä¸æŠ–åŠ¨çš„å…¨éƒ¨ï¼Œæˆ‘ä»¬åœ¨é¢è¯•å’Œå·¥ä½œä¸­ä¼šç»å¸¸çš„é‡åˆ°ã€‚è¿™ä¹Ÿæ˜¯æ€§èƒ½ä¼˜åŒ–çš„ä¸€ç§æ–¹æ¡ˆã€‚å½“ç„¶è¿˜æœ‰å¾ˆå¤šç‰ˆæœ¬æ¯”å¦‚å¤š promise ç‰ˆæœ¬çš„å°±ä¸å†è¿™é‡Œå™è¿°äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æ‰¾æ‰¾æŠ€æœ¯è®ºå›</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>json å¯¹è±¡</title>
      <link href="/2019/05/11/javascript/json/"/>
      <url>/2019/05/11/javascript/json/</url>
      
        <content type="html"><![CDATA[<h2 id="JSON-stringify"><a href="#JSON-stringify" class="headerlink" title="JSON.stringify"></a>JSON.stringify</h2><ul><li>å°†å€¼è½¬æ¢ä¸ºç›¸åº”çš„JSONæ ¼å¼</li><li>å¸ƒå°”å€¼ã€æ•°å­—ã€å­—ç¬¦ä¸²åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨è½¬æ¢æˆå¯¹åº”çš„åŸå§‹å€¼ (å­—ç¬¦ä¸²éœ€è¦å•ç‹¬å¤„ç†)</li><li>NaNå’ŒInfinityæ ¼å¼çš„æ•°å€¼åŠnulléƒ½ä¼šè¢«å½“åšnull</li><li>ä¸å¯æšä¸¾çš„å±æ€§ä¼šè¢«å¿½ç•¥</li><li>undefinedã€ä»»æ„çš„å‡½æ•°ä»¥åŠ symbol å€¼ï¼Œåœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šè¢«å¿½ç•¥ï¼ˆå‡ºç°åœ¨éæ•°ç»„å¯¹è±¡çš„å±æ€§å€¼ä¸­æ—¶ï¼‰æˆ–è€…è¢«è½¬æ¢æˆ nullï¼ˆå‡ºç°åœ¨æ•°ç»„ä¸­æ—¶ï¼‰</li><li>å‡½æ•°ã€undefine,Sysmbolè¢«å•ç‹¬è½¬æ¢æ—¶ï¼Œä¼šè¿”å›undefined</li><li>å¯¹åŒ…å«å¾ªç¯å¼•ç”¨çš„å¯¹è±¡ï¼ˆå¯¹è±¡ä¹‹é—´ç›¸äº’å¼•ç”¨ï¼Œå½¢æˆæ— é™å¾ªç¯ï¼‰æ‰§è¡Œæ­¤æ–¹æ³•ï¼Œä¼šæŠ›å‡ºé”™è¯¯</li></ul><h3 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><pre class="line-numbers language-js"><code class="language-js">JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token punctuation">,</span> replacer <span class="token punctuation">[</span><span class="token punctuation">,</span> space<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>é€šè¿‡ä¸Šè¿°è¯´æ˜å¤„ç†ä¸åŒæƒ…å†µä¸‹çš„æ•°æ®æƒ…å†µï¼Œæ­¤å®ç°ä¸åŒ…æ‹¬ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">jsonStringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> dataType <span class="token operator">=</span> <span class="token keyword">typeof</span> data  <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType <span class="token operator">!==</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> isString <span class="token operator">=</span> dataType <span class="token operator">===</span> <span class="token string">'string'</span>    <span class="token keyword">let</span> isNull <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span> data <span class="token operator">===</span> <span class="token number">Infinity</span>    <span class="token keyword">let</span> isUndefined <span class="token operator">=</span> dataType <span class="token operator">===</span> <span class="token string">"undefined"</span> <span class="token operator">||</span> dataType <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">||</span> dataType <span class="token operator">===</span> <span class="token string">"symbol"</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isNull<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"null"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isUndefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> undefined    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isString<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">'"'</span> <span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">'"'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType <span class="token operator">===</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token string">"null"</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>toJSON <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> data<span class="token punctuation">.</span>toJSON <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">jsonStringify</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> isNull <span class="token operator">=</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">"undefined"</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">"symbol"</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isNull<span class="token punctuation">)</span> <span class="token punctuation">{</span>          result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"null"</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">jsonStringify</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      result <span class="token operator">=</span> <span class="token string">"["</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">"]"</span>      <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token string">'/g, '</span>"'<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> dataType <span class="token operator">=</span> <span class="token keyword">typeof</span> data<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"undefined"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> data<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> data<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"symbol"</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item <span class="token operator">!==</span> <span class="token string">"symbol"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType<span class="token punctuation">)</span> <span class="token punctuation">{</span>            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'"'</span> <span class="token operator">+</span> item <span class="token operator">+</span> <span class="token string">'"'</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token function">jsonStringify</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">"{"</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">"}"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token string">'/g, '</span>"'<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="JSON-pase"><a href="#JSON-pase" class="headerlink" title="JSON.pase"></a>JSON.pase</h2><p>è§£æ JSON å­—ç¬¦ä¸²</p><h3 id="è¯­æ³•-1"><a href="#è¯­æ³•-1" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><pre class="line-numbers language-js"><code class="language-js">JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>text<span class="token punctuation">[</span><span class="token punctuation">,</span> reviver<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="evel-ç‰ˆæœ¬å®ç°"><a href="#evel-ç‰ˆæœ¬å®ç°" class="headerlink" title="evel ç‰ˆæœ¬å®ç°"></a>evel ç‰ˆæœ¬å®ç°</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> jsonPase <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">evel</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç›´æ¥è°ƒç”¨å­˜åœ¨ xss æ¼æ´ï¼Œæ•°æ®ä¸­å¯èƒ½ä¸æ˜¯json æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> rx_one <span class="token operator">=</span> <span class="token regex">/^[\],:{}\s]*$/</span><span class="token punctuation">;</span><span class="token keyword">var</span> rx_two <span class="token operator">=</span> <span class="token regex">/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g</span><span class="token punctuation">;</span><span class="token keyword">var</span> rx_three <span class="token operator">=</span> <span class="token regex">/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g</span><span class="token punctuation">;</span><span class="token keyword">var</span> rx_four <span class="token operator">=</span> <span class="token regex">/(?:^|:|,)(?:\s*\[)+/g</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>    rx_one<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>        json            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rx_two<span class="token punctuation">,</span> <span class="token string">"@"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rx_three<span class="token punctuation">,</span> <span class="token string">"]"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rx_four<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"("</span> <span class="token operator">+</span>json <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Function-ç‰ˆæœ¬å®ç°"><a href="#Function-ç‰ˆæœ¬å®ç°" class="headerlink" title="Function ç‰ˆæœ¬å®ç°"></a>Function ç‰ˆæœ¬å®ç°</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> jsonStr <span class="token operator">=</span> <span class="token string">'{ "age": 20, "name": "renbo" }'</span><span class="token keyword">var</span> json <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'return '</span> <span class="token operator">+</span> jsonStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>new è¿ç®—ç¬¦</title>
      <link href="/2019/04/27/javascript/new/"/>
      <url>/2019/04/27/javascript/new/</url>
      
        <content type="html"><![CDATA[<p>å®ç° new è¿ç®—ç¬¦ä¹Ÿç®—æ˜¯ JS ä¸­ç»å…¸çš„é¢è¯•é¢˜äº†ã€‚åœ¨å®é™…åº”ç”¨ä¸­å…¶å® new è¿ç®—ç¬¦çš„åº”ç”¨åœºæ™¯æ˜¯å®šä¹‰å¯¹è±¡ç±»å‹çš„å®ä¾‹</p><h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * å®šä¹‰æ„é€ å‡½æ•° * @param {*} name  * @param {*} age  */</span><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I'm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> years old`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>study <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I'm learning to swim`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// è°ƒç”¨å†…ç½®å‡½æ•°</span><span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ¨¡æ‹Ÿå®ç°"><a href="#æ¨¡æ‹Ÿå®ç°" class="headerlink" title="æ¨¡æ‹Ÿå®ç°"></a>æ¨¡æ‹Ÿå®ç°</h3><p>ç”¨æ„é€ å‡½æ•°å®é™…ä¸Šä¼šç»å†ä»¥ä¸‹4ä¸ªæ­¥éª¤ï¼ˆå®ç°æ€è·¯ï¼‰</p><ul><li>åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡</li><li>å°†æ„é€ å‡½æ•°çš„ä½œç”¨åŸŸèµ‹ç»™æ–°å¯¹è±¡ï¼ˆå› æ­¤thiså°±æŒ‡å‘äº†è¿™ä¸ªå¯¹è±¡ï¼‰</li><li>æ‰§è¡Œæ„é€ å‡½æ•°ä¸­çš„ä»£ç ï¼ˆä¸ºè¿™ä¸ªæ–°å¯¹è±¡æ·»åŠ å±æ€§ï¼‰</li><li>è¿”å›æ–°å¯¹è±¡</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> newFun <span class="token punctuation">(</span>constructor<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å°† o çš„åŸå‹æŒ‡å‘æ„é€ å‡½æ•°ï¼Œè¿™æ · o å°±å¯ä»¥è®¿é—®åˆ°æ„é€ å‡½æ•°åŸå‹ä¸­çš„å±æ€§</span>  o<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ”¹å˜æ„é€ å‡½æ•° this çš„æŒ‡å‘åˆ°æ–°å»ºçš„å¯¹è±¡ï¼Œè¿™æ · o å°±å¯ä»¥è®¿é—®åˆ°æ„é€ å‡½æ•°ä¸­çš„å±æ€§</span>  <span class="token keyword">var</span> ret <span class="token operator">=</span> constructor<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// éœ€è¦åˆ¤æ–­è¿”å›çš„å€¼æ˜¯å¦æ˜¯å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯å¯¹è±¡è¿”å›æ­£å¸¸æ•°æ®ç±»å‹</span>  <span class="token keyword">return</span> <span class="token keyword">typeof</span> ret <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> ret <span class="token punctuation">:</span> o<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// å†æ¬¡ä½¿ç”¨ä¸Šé¢çš„ä¾‹å­</span><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I'm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> years old`</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>study <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I'm learning to swim`</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> person <span class="token operator">=</span>  <span class="token function">newFun</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// my name is renbo, I'm 28 years old</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// my name is renbo, I'm learning to swim</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>call å’Œ apply</title>
      <link href="/2019/04/22/javascript/call/"/>
      <url>/2019/04/22/javascript/call/</url>
      
        <content type="html"><![CDATA[<p>è°ˆèµ· call å’Œ apply è¿™ä¸¤ä¸ª Function.prototype ä¸Šçš„æ–¹æ³•å¯èƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œå®ƒåœ¨ç»§æ‰¿ï¼Œæ”¹å˜thisæŒ‡é’ˆä¸Šæœ‰å¾ˆå¤šçš„åº”ç”¨åœºæ™¯ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•çš„æ¥é‡æ–°å›å¿†ä¸€ä¸‹ call å’Œ apply è¿™ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½ <br></p><h3 id="ä¾‹å­ä¸€"><a href="#ä¾‹å­ä¸€" class="headerlink" title="ä¾‹å­ä¸€"></a>ä¾‹å­ä¸€</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value <span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token keyword">function</span> fun <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¾‹å­äºŒ"><a href="#ä¾‹å­äºŒ" class="headerlink" title="ä¾‹å­äºŒ"></a>ä¾‹å­äºŒ</h3><pre class="line-numbers language-js"><code class="language-js">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span> <span class="token string">'element'</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">let</span> func <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       console<span class="token punctuation">.</span>log <span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// æŒ‡å‘elementå…ƒç´ </span>  <span class="token punctuation">}</span>   func<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¾‹å­ä¸‰"><a href="#ä¾‹å­ä¸‰" class="headerlink" title="ä¾‹å­ä¸‰"></a>ä¾‹å­ä¸‰</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> FunA <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> FunB <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  FunA<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>FunB<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getValue <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token keyword">let</span> funb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FunB</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>funb<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»è¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥ç›´è§‚çš„çŸ¥é“call apply çš„ä½œç”¨å¤§éƒ¨åˆ†éƒ½æ˜¯ç”¨ä½œæ”¹å˜thisçš„æŒ‡é’ˆã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ¨¡æ‹Ÿ call apply å®ç°ç®€å•çš„ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°<br></p><h3 id="æ¨¡æ‹Ÿå®ç°ç¬¬ä¸€æ­¥"><a href="#æ¨¡æ‹Ÿå®ç°ç¬¬ä¸€æ­¥" class="headerlink" title="æ¨¡æ‹Ÿå®ç°ç¬¬ä¸€æ­¥"></a>æ¨¡æ‹Ÿå®ç°ç¬¬ä¸€æ­¥</h3><p>å®ç°æ€è·¯<br><br>1ã€å°†å‡½æ•°è®¾ä¸ºå¯¹è±¡çš„å±æ€§ç”¨æ¥æ”¹å˜ this æŒ‡å‘<br><br>2ã€è°ƒç”¨å¯¹åº”å‡½æ•°<br><br>3ã€åˆ é™¤å¯¹è±¡çš„å‡½æ•°<br></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ”¹é€ ä¸€ä¸‹ä¾‹å­ä¸€çš„å‡½æ•°<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>  fun<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>value  <span class="token punctuation">}</span><span class="token punctuation">}</span>obj<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 20</span><span class="token keyword">delete</span> obj<span class="token punctuation">.</span>funconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 20}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥ç®€å•çš„æŠŠä¸Šé¢çš„å‡½æ•°å°è£…ä¸€ä¸‹<br></p><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newCall <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  context<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  context<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">delete</span> context<span class="token punctuation">.</span>fn<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// é€šè¿‡ä¾‹å­ä¸€æµ‹è¯•</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value <span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token keyword">function</span> fun <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>fun<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ¨¡æ‹Ÿå®ç°ç¬¬äºŒæ­¥"><a href="#æ¨¡æ‹Ÿå®ç°ç¬¬äºŒæ­¥" class="headerlink" title="æ¨¡æ‹Ÿå®ç°ç¬¬äºŒæ­¥"></a>æ¨¡æ‹Ÿå®ç°ç¬¬äºŒæ­¥</h3><p>ç¬¬ä¸€æ­¥çš„æˆ‘ä»¬åªå®ç°äº†åŸºç¡€ã€‚æ²¡æœ‰è€ƒè™‘å‚æ•°çš„æƒ…å†µã€‚callï¼Œapply çš„åŸºæœ¬åŒºåˆ«å°±æ˜¯åœ¨å‚æ•°ä¸Š call å‚æ•°æ•°é‡ä¸ç¡®å®šï¼Œapply åªæ¥å—ä¸¤ä¸ªå‚æ•°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­ä¼˜åŒ–ä¸Šé¢çš„ä¾‹å­</p><p>1ã€å°†å‡½æ•°è®¾ä¸ºå¯¹è±¡çš„å±æ€§ç”¨æ¥æ”¹å˜ this æŒ‡å‘<br><br>2ã€è°ƒç”¨å¯¹åº”å‡½æ•°<br><br>3ã€åˆ é™¤å¯¹è±¡çš„å‡½æ•°<br><br>4ã€å–å‡ºä¸å®šé•¿çš„å‚æ•°æ”¾åˆ°æ‰§è¡Œçš„å‡½æ•°é‡Œé¢<br></p><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newCall <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å¦‚æœä¼ å…¥å‚æ•° this ä¸º nullï¼Œåˆ™é»˜è®¤ä¸ºå½“å‰å®¿ä¸»ç¯å¢ƒ</span>  <span class="token keyword">let</span> ec <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> window <span class="token punctuation">:</span> global<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// é˜²æ­¢æ–¹æ³•å†²çªè¦†ç›–</span>  <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  context <span class="token operator">=</span> context <span class="token operator">||</span> ec<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ”¹å˜ this</span>  context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å°†å‚æ•°æ”¾å…¥å‡½æ•°å†…</span>  <span class="token keyword">let</span> result <span class="token operator">=</span> context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åˆ é™¤å¯¹è±¡ä¸­çš„å‡½æ•°</span>  <span class="token keyword">delete</span> context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// æµ‹è¯•ä¸€ä¸‹</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>bar<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä»¥ä¸Š call çš„å®ç°æˆ‘ä»¬å¯¹applyçš„å®ç°åº”è¯¥è¯´ä¹Ÿæ¸…æ¥šäº†ï¼Œ ä¸Šè¿°è¯´è¿‡call å’Œ apply çš„åŒºåˆ«å°±åœ¨ä¸å‚æ•°ä¸Šé¢ï¼Œé€šè¿‡ES6å®ç°çš„æ–¹æ³•å®é™…ä¸Š call, apply ä¸€æ ·<br></p><h3 id="æ¨¡æ‹Ÿå®ç°-apply"><a href="#æ¨¡æ‹Ÿå®ç°-apply" class="headerlink" title="æ¨¡æ‹Ÿå®ç° apply"></a>æ¨¡æ‹Ÿå®ç° apply</h3><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newApply <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å¦‚æœä¼ å…¥å‚æ•° this ä¸º nullï¼Œåˆ™é»˜è®¤ä¸ºå½“å‰å®¿ä¸»ç¯å¢ƒ</span>  <span class="token keyword">let</span> ec <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> window <span class="token punctuation">:</span> global<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// é˜²æ­¢æ–¹æ³•å†²çªè¦†ç›–</span>  <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  context <span class="token operator">=</span> context <span class="token operator">||</span> ec<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ”¹å˜ this</span>  context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å°†å‚æ•°æ”¾å…¥å‡½æ•°å†…</span>  <span class="token keyword">let</span> result <span class="token operator">=</span> context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åˆ é™¤å¯¹è±¡ä¸­çš„å‡½æ•°</span>  <span class="token keyword">delete</span> context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// æµ‹è¯•ä¸€ä¸‹</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>bar<span class="token punctuation">.</span><span class="token function">newApply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bind å‡½æ•°</title>
      <link href="/2019/04/21/javascript/bind/"/>
      <url>/2019/04/21/javascript/bind/</url>
      
        <content type="html"><![CDATA[<p>bind æ–¹æ³•å…¶å®å’Œ call apply åŠŸèƒ½ä¸Šå·®ä¸å¤šï¼Œåªä¸è¿‡ bind() æ–¹æ³•ä¼šç»‘å®šä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œé€šè¿‡è¿™ä¸ªæ–°çš„å‡½æ•°æˆ‘ä»¬å¯ä»¥å½“ä½œæ„é€ å‡½æ•°ã€åå‡½æ•°ç­‰ç­‰å»ä½¿ç”¨</p><h3 id="ä½œä¸ºç»‘å®šå‡½æ•°ä½¿ç”¨"><a href="#ä½œä¸ºç»‘å®šå‡½æ•°ä½¿ç”¨" class="headerlink" title="ä½œä¸ºç»‘å®šå‡½æ•°ä½¿ç”¨"></a>ä½œä¸ºç»‘å®šå‡½æ•°ä½¿ç”¨</h3><p>demo1</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span>  getValue<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ç›´æ¥è°ƒç”¨ this æŒ‡å‘ obj</span>obj<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 29</span><span class="token comment" spellcheck="true">// obj.getValue æ˜¯ä¸€ä¸ªå‡½æ•°ä½“ï¼Œåœ¨å…¨å±€ä½œç”¨åŸŸä¸­è°ƒç”¨ï¼Œæ‰€ä»¥ this æŒ‡å‘ window</span><span class="token keyword">let</span> valFun <span class="token operator">=</span> obj<span class="token punctuation">.</span>getValue<span class="token punctuation">;</span><span class="token function">valFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 20</span><span class="token comment" spellcheck="true">// ä½¿ç”¨ bind å°†å½“å‰çš„ this æŒ‡é’ˆæŒ‡å‘ obj å¯¹è±¡ä¸Š</span><span class="token keyword">let</span> boundGetValue <span class="token operator">=</span> valFun<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">boundGetValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 29</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>demo2</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * obj.getValue() è¿”å›çš„æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•° * obj.getValue()() ç«‹å³æ‰§è¡Œå‡½æ•° * åŒ¿åå‡½æ•°ä¸Šä¸‹æ–‡æ‰§è¡Œç¯å¢ƒå…·æœ‰å…¨å±€æ€§ï¼Œæ‰€ä»¥ this é€šå¸¸æŒ‡å‘ window */</span><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span>  getValue<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>obj<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 20</span><span class="token comment" spellcheck="true">// åˆ©ç”¨bindæˆ‘ä»¬å¯ä»¥ä½¿åŒ¿åå‡½æ•°çš„ this æŒ‡é’ˆæŒ‡å‘å½“å‰å¯¹è±¡ï¼ˆå½“ç„¶è¿˜æœ‰å¾ˆå¤šæ–¹æ³•æ¯”å¦‚åœ¨åŒ¿åå‡½æ•°å†…å¢åŠ å˜é‡ _this = thisï¼‰</span><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span>  getValue<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>obj<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 29</span><span class="token comment" spellcheck="true">// å½“ç„¶è¦æ˜¯æ”¹å˜ä¸Šè¿° this æŒ‡é’ˆä¸åªç”¨ bind å¯ä»¥å¦‚ä¸‹æ–¹æ³•(è¿˜æœ‰å¾ˆå¤šæ–¹æ³• æ¯”å¦‚ apply call)</span><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span>  getValue<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> _this<span class="token punctuation">.</span>value    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>obj<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 29</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä½œä¸ºåå‡½æ•°ä½¿ç”¨"><a href="#ä½œä¸ºåå‡½æ•°ä½¿ç”¨" class="headerlink" title="ä½œä¸ºåå‡½æ•°ä½¿ç”¨"></a>ä½œä¸ºåå‡½æ•°ä½¿ç”¨</h3><p>ä½¿ä¸€ä¸ªå‡½æ•°æ‹¥æœ‰é¢„è®¾çš„åˆå§‹å‚æ•°ï¼Œè¿™å°±æ˜¯åå‡½æ•°ã€‚æ¯”å¦‚å‡½æ•°Aå·²ç»æ‹¥æœ‰å‚æ•°æˆ–è€…å˜é‡ï¼Œæ­¤æ—¶æˆ‘ä»¬é€šè¿‡è°ƒç”¨å‡½æ•°Aï¼Œäº§ç”Ÿå‡½æ•°Bï¼Œæˆ‘ä»¬å°±è¯´Bä¸ºåå‡½æ•°</p><p>åœ¨è¿™é‡Œæˆ‘ä»¬ä¸å±•å¼€è¯´æ˜åå‡½æ•°ï¼ŒæŸ¯é‡ŒåŒ–ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹çš„æ¦‚å¿µï¼Œåœ¨ <strong>JS é«˜çº§ç³»åˆ—</strong> å‡½æ•°å¼ç¼–ç¨‹ä¸­ä¼šæœ‰è¯¦ç»†ä»‹ç»</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * æ’å…¥åˆ°ç›®æ ‡å‡½æ•°çš„å‚æ•°åˆ—è¡¨çš„å¼€å§‹ä½ç½® * ä¼ é€’ç»™ç»‘å®šå‡½æ•°çš„å‚æ•°ä¼šè·Ÿåœ¨å®ƒä»¬åé¢ */</span><span class="token keyword">function</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// åå‡½æ•°</span><span class="token keyword">let</span> listArr <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">listArr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [28]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">listArr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [28, 1, 2, 3]</span><span class="token comment" spellcheck="true">/** * å¤šæ¬¡ bind æ— æ•ˆ åªèƒ½æ‰§è¡Œä¸€æ¬¡ * bind å†…éƒ¨ ä½¿ç”¨call apply å®ç° */</span><span class="token keyword">function</span> bar <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token keyword">let</span> foo1 <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token keyword">let</span> func <span class="token operator">=</span> bar<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>foo1<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ¨¡æ‹Ÿç¬¬ä¸€æ­¥"><a href="#æ¨¡æ‹Ÿç¬¬ä¸€æ­¥" class="headerlink" title="æ¨¡æ‹Ÿç¬¬ä¸€æ­¥"></a>æ¨¡æ‹Ÿç¬¬ä¸€æ­¥</h3><p>é€šè¿‡ä¸Šé¢çš„åº”ç”¨æˆ‘ä»¬å®ç° bind æœ‰å‡ ä¸ªæ¡ä»¶</p><ul><li>bind ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°</li><li>å¯ä»¥ä¼ é€’ä»»æ„å‚æ•°</li><li>ç»‘å®š bind çš„å‡½æ•°å¯ä»¥æœ‰è¿”å›å€¼</li></ul><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newBind <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// è·å– bind çš„å‚æ•°ï¼Œå¦‚ä¸Šé¢åå‡½æ•°çš„ä¾‹å­</span>  <span class="token keyword">var</span> _args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// è¿”å›æ–°å‡½æ•°</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// bind è¿”å›å‡½æ•°ä¼ å…¥çš„å‚æ•°</span>    <span class="token keyword">var</span> _bindArgs <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆå¹¶å‚æ•°è¿”å›</span>    <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> _args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>_bindArgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ¨¡æ‹Ÿç¬¬äºŒæ­¥"><a href="#æ¨¡æ‹Ÿç¬¬äºŒæ­¥" class="headerlink" title="æ¨¡æ‹Ÿç¬¬äºŒæ­¥"></a>æ¨¡æ‹Ÿç¬¬äºŒæ­¥</h3><p>é€šè¿‡ç¬¬ä¸€æ­¥å…¶å®æˆ‘ä»¬å·²ç»æ¨¡æ‹Ÿäº† bind çš„å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨ JS ä¸­ä¹Ÿå¯ä»¥æŠŠå‡½æ•°å½“æˆæ„é€ å‡½æ•°æ¥ç”¨ å¯ä»¥ä½¿ç”¨ new å…³é”®å­—ï¼Œ è¿™ä¸ªæ—¶å€™ bind ç»‘å®šçš„å‡½æ•°çš„ this å°±ä¼šå¤±æ•ˆï¼Œå› ä¸ºåœ¨æ„é€ å‡½æ•°ä¸­ this æ°¸è¿œæŒ‡å‘çš„æ˜¯å®ƒçš„å®ä¾‹ï¼Œå…³äº new ä¼šåœ¨ä¸‹ç¯‡æ–‡ç« ä¸­ä½œå‡ºè§£é‡Š<br></p><ul><li>é€šè¿‡ä¿®æ”¹è¿”å›çš„å‡½æ•°çš„åŸå‹ï¼Œæ¥æ”¹å˜ this æŒ‡å‘é—®é¢˜</li><li>è°ƒç”¨ bind ä¸€å®šæ˜¯å‡½æ•°ï¼Œå¦åˆ™æç¤ºé”™è¯¯</li></ul><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newBind  <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// æç¤ºé”™è¯¯ä¿¡æ¯</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Function.prototype.bind - what is trying to be bound is not callable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// è·å–å‚æ•°</span>  <span class="token keyword">var</span> _args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åˆ©ç”¨ç©ºå‡½æ•°æ¥é˜²æ­¢ä¿®æ”¹ç»‘å®šå‡½æ•°çš„åŸå‹ï¼Œå…³äº prototype è¯·æŸ¥çœ‹ prototype ç« èŠ‚</span>  <span class="token keyword">var</span> _fNOP <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// bind è¿”å›çš„æ–°å‡½æ•°</span>  <span class="token keyword">var</span> _fBound <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> _bindArgs <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœè¿”å›çš„ _fBound è¢«å½“åš new çš„æ„é€ å‡½æ•°è°ƒç”¨</span>    <span class="token keyword">return</span> _this<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">_fBound</span> <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token punctuation">:</span> context<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>_bindArgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// è®© _fBound æ„é€ çš„å®ä¾‹ç»§æ‰¿ç»‘å®šå‡½æ•°åŸå‹ä¸­çš„å€¼ï¼Œå¦åˆ™ä¼šä¿®æ”¹ç»‘å®šå‡½æ•°çš„åŸå‹çš„å€¼</span>  _fNOP<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>  _fBound<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_fNOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> _fBound<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Error å¼‚å¸¸æ¨¡å—</title>
      <link href="/2019/04/14/node/error/"/>
      <url>/2019/04/14/node/error/</url>
      
        <content type="html"><![CDATA[<p>é”™è¯¯å¤„ç†æ˜¯æ‰€æœ‰åº”ç”¨ç¨‹åºçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚è¦æŠ›å‡ºå¼‚å¸¸ï¼Œè¯·ä½¿ç”¨ JavaScript çš„ throw  å…³é”®å­—ã€‚åœ¨ JavaScript ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ Error å¯¹è±¡å’Œæ¶ˆæ¯æ¥è¡¨ç¤ºé”™è¯¯<br></p><p><strong>æ•è·å¼‚å¸¸try/catch</strong><br></p><pre><code>  function fun () {    throw new Error(&quot;error!&quot;);  }  try {    fun();  } catch (e) {    console.log(e.message);  }</code></pre><p><strong>finallyå…³é”®å­—</strong><br></p><p>catchéƒ¨åˆ†åªæœ‰åœ¨æŠ›å‡ºé”™è¯¯æ—¶æ‰æ‰§è¡Œã€‚finallyéƒ¨åˆ†ä»ç„¶æ‰§è¡Œï¼Œå°½ç®¡åœ¨tryéƒ¨åˆ†ä¸­æŠ›å‡ºäº†ä»»ä½•é”™è¯¯<br></p><pre><code>try {   throw new Error(&quot;throw error&quot;); } catch (e) {   console.log(e.message); } finally {   console.log(&quot;ä¸è®ºæŠ›å‡ºä»€ä¹ˆé”™è¯¯ï¼Œæˆ‘ä¾ç„¶ä¼šæ‰§è¡Œ&quot;); } </code></pre>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>processè¿›ç¨‹</title>
      <link href="/2019/04/12/node/process/"/>
      <url>/2019/04/12/node/process/</url>
      
        <content type="html"><![CDATA[<p>process å¯¹è±¡æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒæä¾›æœ‰å…³å½“å‰ Node.js è¿›ç¨‹çš„ä¿¡æ¯å¹¶å¯¹å…¶è¿›è¡Œæ§åˆ¶ã€‚ ä½œä¸ºä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒå§‹ç»ˆå¯ä¾› Node.js åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œæ— éœ€ä½¿ç”¨ require()<br></p><p>ä¸Šæ–‡ä¸­æåˆ°è¿‡äº‹ä»¶é˜Ÿåˆ—è°ƒåº¦å¯ä»¥é€šè¿‡processçš„.nextTick()æ¥å®ç°<br></p><p>ä¸Šè¿°æ–‡ç« ä¸­è¯´åˆ°è¿‡ Node æ˜¯å•è¿›ç¨‹å•çº¿ç¨‹æ¶æ„ï¼Œå¯¹å¤šæ ¸ä½¿ç”¨ä¸è¶³ï¼Œæ‰€ä»¥å¯åŠ¨å¤šè¿›ç¨‹ã€‚æ¯ä¸ªè¿›ç¨‹ä¸€ä¸ª CPU ä»¥æ­¤å®ç°å¤šæ ¸ CPU çš„åˆ©ç”¨<br></p><p><strong>Master-Workeræ¨¡å¼ï¼ˆä¸»ä»æ¨¡å¼ï¼‰</strong></p><p>ä¸»ä»æ¨¡å¼ä¸»è¦ç”¨äºåœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­å¹¶è¡Œå¤„ç†ä¸šåŠ¡çš„æ¨¡å¼ï¼Œå…·å¤‡è‰¯å¥½çš„å¯ä¼¸ç¼©æ€§å’Œç¨³å®šæ€§ï¼Œä¸»è¿›ç¨‹ï¼ˆmasterï¼‰è´Ÿè´£å’Œç®¡ç†å·¥ä½œè¿›ç¨‹ï¼ˆworkerï¼‰ï¼Œå·¥ä½œè¿›ç¨‹ï¼ˆworkerï¼‰è´Ÿè´£å…·ä½“çš„ä¸šåŠ¡é€»è¾‘<br></p><p><img src="/images/master-worker.png"><br></p><pre><code>/** * åˆ›å»ºå·¥ä½œè¿›ç¨‹ * worker.js */// å¼•å…¥æ ¸å¿ƒæ¨¡å—httplet http = require(&#39;http&#39;);// åˆ›å»ºæœåŠ¡let server = http.createServer(function (req, res) {  res.writeHead(200, {&#39;Content-Type&#39; : &#39;text/plain&#39;});  res.end(&#39;Hello World !&#39;)})// æŒ‡å®šåŸŸålet domain = &#39;127.0.0.1&#39;;// éšæœºåˆ›å»ºç«¯å£let port = Math.round((1 + Math.random()) * 1000);// ç›‘å¬å¯åŠ¨æœåŠ¡server.listen(port, domain)</code></pre><pre><code>/** * åˆ›å»ºä¸»è¿›ç¨‹ * master.js */// å¼•å…¥æ ¸å¿ƒæ¨¡å—child_process åˆ›å»ºå­è¿›ç¨‹let childProcess = require(&#39;child_process&#39;);å¼•å…¥æ ¸å¿ƒæ¨¡å—osï¼Œå¾—åˆ°cpuæ•°é‡let cpus = require(&#39;os&#39;).cpus();// æ ¹æ®cpuæ•°é‡å–å¤åˆ¶å¯¹åº”çš„ node çš„è¿›ç¨‹æ•°é‡for (let i = 0; i &lt; cpus.length; i++) {  childProcess.fork(&#39;./worker.js&#39;)}</code></pre><p><strong>è¿›ç¨‹é—´é€šä¿¡</strong><br></p><p>è¯´èµ·è¿›ç¨‹é€šä¿¡ï¼Œå…¶å®æˆ‘ä»¬éƒ½ç†Ÿæ‚‰æµè§ˆå™¨çš„ Javascript ä¸»çº¿ç¨‹ä¸ UI æ¸²æŸ“ï¼Œå…±ç”¨ä¸€ä¸ªçº¿ç¨‹ã€‚ä¸¤ä¸ªæ˜¯äº’æ–¥å…³ç³»ï¼Œå½“ UI æ¸²æŸ“æ—¶Jså¼•æ“çº¿ç¨‹æš‚æ—¶æŒ‚èµ·ã€‚æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ HTML5 æå‡ºWebWork API ä¸»çº¿ç¨‹ä¸å·¥ä½œçº¿ç¨‹ä¹‹é—´é€šè¿‡onmessage()å’ŒpostMessage()è¿›è¡Œé€šè®¯ï¼Œä½¿ JS é˜»å¡è¾ƒä¸ºä¸¥é‡çš„è®¡ç®—ä¸å½±å“ä¸»çº¿ç¨‹ä¸Šçš„UIæ¸²æŸ“<br></p><p>åœ¨ node ä¸­ä¸ºäº†å®ç°çˆ¶å­è¿›ç¨‹é€šè®¯ï¼Œçˆ¶å­ä¹‹é—´å°†ä¼šåˆ›å»ºIPCé€šé“ï¼Œé€šè¿‡IPCé€šé“ï¼Œçˆ¶å­è¿›ç¨‹æ‰èƒ½é€šè¿‡messageå’Œsend()ä¼ é€’å‡½æ•°<br></p><p>IPCåŸç†åˆ›å»ºå®ç°ç¤ºæ„å›¾<br></p><p><img src="/images/ipc.png"><br></p><p>IPCé€šé“åˆ›å»ºã€è¿æ¥<br></p><p>1ã€çˆ¶è¿›ç¨‹åœ¨å®é™…åˆ›å»ºå­è¿›ç¨‹ä¹‹å‰ï¼Œé¦–å…ˆåˆ›å»ºIPCé€šé“å¹¶ç›‘å¬ï¼Œç„¶ååœ¨åˆ›å»ºå­è¿›ç¨‹<br><br>2ã€é€šè¿‡ç¯å¢ƒå˜é‡ï¼ˆNODE_CHAMMEL_FDï¼‰é€šçŸ¥å­è¿›ç¨‹ IPC é€šé“çš„æ–‡ä»¶æè¿°ç¬¦<br><br>3ã€å­è¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­é€šè¿‡æ–‡ä»¶æè¿°ç¬¦è¿æ¥å·²ç»å­˜åœ¨çš„ IPC é€šé“<br><br>4ã€å»ºç«‹è¿æ¥åå°±å¯ä»¥åœ¨å†…æ ¸ä¸­å®ŒæˆåŒå‘é€šä¿¡ï¼Œä¸ç»è¿‡ç½‘ç»œå±‚<br><br>5ã€åœ¨ Node ä¸­ï¼ŒIPC è¢«æŠ½è±¡æˆä¸º Stream å¯¹è±¡ï¼Œè°ƒç”¨ sendï¼ˆï¼‰å‘é€æ•°æ®ï¼Œé€šè¿‡ message äº‹ä»¶æ¥æ”¶æ•°æ®<br></p><p><img src="/images/ipc-create.png"><br></p><pre><code>/** * åˆ›å»ºçˆ¶çº¿ç¨‹ * master.js */// å¼•å…¥æ ¸å¿ƒæ¨¡å—child_process åˆ›å»ºå­è¿›ç¨‹let childProcess = require(&#39;child_process&#39;);// å¤åˆ¶è¿›ç¨‹let n = childProcess.fork(__dirname + &#39;/worker.js&#39;);// ç›‘å¬messagen.on(&#39;messge&#39;, function (m) {  console.log(m)})// å‘é€æ•°æ®n.send({hello: &#39;&#39;world});</code></pre><pre><code>/** * åˆ›å»ºå­çº¿ç¨‹ * worker.js */// ç›‘å¬messageprocess.on(&#39;message&#39;, function (m) {  console.log(m)});// å‘é€æ•°æ®process.send({foo: &#39;bar&#39;});</code></pre><p><strong>å¥æŸ„ä¼ é€’</strong><br></p><p>é€šè¿‡ä¸Šè¿°æˆ‘ä»¬ç®€å•çš„äº†è§£åˆ°è¿›ç¨‹ä¹‹é—´é€šä¿¡åŸç†ï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³è¦é€šè¿‡ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œä¸»è¿›ç¨‹å°†æ‰€æœ‰çš„è¯·æ±‚äº¤ç”±å­è¿›ç¨‹å¤„ç†ï¼Œä¸Šè¿°é€šä¿¡è¿œè¿œä¸å¤Ÿçš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ <strong>Nodeå¥æŸ„ä¼ é€’</strong> æ¥å®ç°<br></p><p>ä¸»è¿›ç¨‹å°†è¯·æ±‚å‘é€ç»™å·¥ä½œè¿›ç¨‹<br></p><p><img src="/images/process-send.png"><br></p><p>ä¸»è¿›ç¨‹å‘é€å®Œå¥æŸ„å¹¶å…³é—­ç›‘å¬<br></p><p><img src="/images/process-on.png"><br></p><pre><code>/** * åˆ›å»ºä¸»è¿›ç¨‹ * master.js */// å¼•å…¥æ ¸å¿ƒæ¨¡å—child_process åˆ›å»ºå­è¿›ç¨‹let cp = require(&#39;child_process&#39;);// å¤åˆ¶è¿›ç¨‹let child1 = cp.fork(__dirname + &#39;/worker.js&#39;);let child2 = cp.fork(__dirname + &#39;/worker.js&#39;);// æ‰“å¼€æœåŠ¡ä½¿ç”¨å¾—æœåŠ¡å¯¹è±¡å‘é€æ•°æ®let server = require(&#39;net&#39;).createServer();server.listen(1337 ,function () {  child1.send(&#39;server&#39;, server);  child2.send(&#39;server&#39;, server);  // ä¸»è¿›ç¨‹å‘é€å®Œæˆå¥æŸ„å…³é—­ç›‘å¬  server.close();});</code></pre><pre><code>/** * åˆ›å»ºå­è¿›ç¨‹ * worker.js */// å¼•å…¥æ ¸å¿ƒæ¨¡å—httplet http = require(&#39;http&#39;);// åˆ›å»ºæœåŠ¡let server = http.createServer(function (req, res) {  res.writeHead(200, {&#39;Content-Type&#39; : &#39;text/plain&#39;});  res.end(&#39;pid is&#39; + process.pid)});// å­è¿›ç¨‹ç›‘å¬ç«¯å£process.on(&#39;message&#39;, function (m, tcp) {  if (m === &#39;server&#39;) {    tcp.on(&#39;connection&#39;, function (socket) {      server.emit(&#39;connection&#39;, socket);    });  }}};</code></pre><p>é€šè¿‡ä¸Šè¿°å‡ ä¸ªä¾‹å­æˆ‘ä»¬åŸºæœ¬åŸºæœ¬äº†è§£ Node çš„è¿›ç¨‹ã€‚å½“ç„¶è¿˜æœ‰å¾ˆå¤šéœ€è¦åœ¨äº‹ä»¶ä¸­æ‘¸ç´¢ä¾‹å¦‚é›†ç¾¤çš„ç¨³å®šï¼ŒåŒ…æ‹¬è‡ªåŠ¨é‡å¯ï¼Œè´Ÿè½½å‡è¡¡ï¼ŒçŠ¶æ€å…±äº«ç­‰ç­‰ã€‚å½“ç„¶åˆ›å»º Node é›†ç¾¤ä¹Ÿå¯ä»¥ç”¨clusteræ¨¡å—ï¼Œå®ç°èµ·æ¥æ›´è½»æ¾æ–¹ä¾¿<br></p><h2 id="æ›´å¤šæ–¹æ³•å‚è€ƒ"><a href="#æ›´å¤šæ–¹æ³•å‚è€ƒ" class="headerlink" title="æ›´å¤šæ–¹æ³•å‚è€ƒ"></a>æ›´å¤šæ–¹æ³•å‚è€ƒ<br></h2><p><a href="http://nodejs.cn/api/process.html" target="_blank" rel="noopener">Node Api process</a><br><br><a href="http://nodejs.cn/api/child_process.html" target="_blank" rel="noopener">Node Api child_process</a><br><br><a href="http://nodejs.cn/api/cluster.html" target="_blank" rel="noopener">Node Api cluster</a><br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>event äº‹ä»¶é©±åŠ¨æ¨¡å‹</title>
      <link href="/2019/04/10/node/event/"/>
      <url>/2019/04/10/node/event/</url>
      
        <content type="html"><![CDATA[<p>è¯´èµ·nodeçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹é¦–å…ˆæˆ‘ä»¬æ¥ææ¸…æ¥šå‡ ä¸ªæ¦‚å¿µCPUï¼Œçº¿ç¨‹ã€è¿›ç¨‹ã€è°ƒåº¦ã€äº‹ä»¶é©±åŠ¨<br></p><p><strong>CPU</strong><br></p><p>1ã€CPU æ˜¯ä¸­å¤®å¤„ç†å™¨ï¼Œæ˜¯è®¡ç®—æœºçš„æ ¸å¿ƒ<br><br>2ã€CPU é€šè¿‡å’Œå¯„å­˜å™¨ï¼Œé«˜é€Ÿç¼“å­˜ï¼Œä»¥åŠå†…å­˜äº¤äº’æ¥æ‰§è¡Œç¨‹åº<br><br>3ã€32ä½ CPU æœ€å¤šå¯»å€4gå†…å­˜ï¼Œè€Œ64ä½ CPU ç›®å‰æ¥è¯´æ²¡æœ‰ä¸Šé™<br></p><p><strong>è¿›ç¨‹ï¼ˆProcessï¼‰</strong><br></p><p>1ã€è¿›ç¨‹æ˜¯èµ„æºåˆ†é…æœ€å°å•ä½ï¼Œå¯¹äºæ“ä½œç³»ç»Ÿè€Œè¨€æ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨å°±æ˜¯å¯åŠ¨ä¸€ä¸ªæµè§ˆå™¨è¿›ç¨‹ï¼Œæ‰“å¼€ QQ å°±æ˜¯ä¸€ä¸ª QQ è¿›ç¨‹<br><br>2ã€æ“ä½œç³»ç»Ÿä¸ºè¿›ç¨‹å¼€è¾Ÿä¸€æ®µå†…å­˜ç©ºé—´ï¼Œæ¯ä¸ªè¿›ç¨‹å ç”¨ä¸€ä¸ªè¿›ç¨‹è¡¨é¡¹ï¼ŒåŒ…å«äº†è¿›ç¨‹çŠ¶æ€çš„é‡è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€å †æ ˆæŒ‡é’ˆã€å†…å­˜åˆ†é…çŠ¶å†µã€æ‰€æ‰“å¼€æ–‡ä»¶çš„çŠ¶æ€ã€å¸å·å’Œè°ƒåº¦ä¿¡æ¯ç­‰ï¼Œcpuæ ¹æ®è¿™äº›ä¿¡æ¯é…åˆå¯„å­˜å™¨è¿›è¡Œå‡½æ•°è°ƒç”¨å’Œç¨‹åºæ‰§è¡Œ<br></p><p>3ã€ CPUåˆ©ç”¨ç‡=1ï¼pâ¿<br></p><ul><li>ä¸€ä¸ªè¿›ç¨‹ç­‰å¾…I/Oæ“ä½œçš„æ—¶é—´ä¸å…¶åœç•™åœ¨å†…å­˜ä¸­çš„æ—¶é—´æ¯”ä¸ºp<br></li><li>å†…å­˜ä¸­åŒæ—¶æœ‰nä¸ªè¿›ç¨‹<br></li></ul><p><strong>çº¿ç¨‹ï¼ˆThreadï¼‰</strong><br></p><p>çº¿ç¨‹æ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œæ¯”å¦‚æ‰“å¼€ä¸€ä¸ª QQ è¿›ç¨‹åœ¨é‡Œé¢å¯ä»¥æ‰“å­—ï¼Œå‘è¡¨æƒ…åŒæ—¶å’Œå¾ˆå¤šäººèŠå¤©ã€‚åŒæ—¶è¿è¡Œå¤šä¸ªå­ä»»åŠ¡ï¼Œè¿™æ ·çš„å­ä»»åŠ¡å°±å¯ä»¥æˆä¸ºçº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹ä¸­è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚<br></p><p><strong>è°ƒåº¦</strong><br></p><p>1ã€ <em>è°ƒåº¦ç¨‹åºï¼ˆschedulerï¼‰</em>-å¤šè¿›ç¨‹åŒæ—¶ç«äº‰CPUæ—¶ï¼Œè¶…è¿‡ä¸¤ä¸ªçš„è¿›ç¨‹å¤„äºå°±ç»ªæ€ï¼Œé‚£ä¹ˆå•CPUå¿…é¡»é€‰æ‹©ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„è¿›ç¨‹ï¼Œå®Œæˆé€‰æ‹©å·¥ä½œçš„ç¨‹åºç§°ä¸ºè°ƒåº¦ç¨‹åºï¼ˆå¦ç§°CPUè°ƒåº¦å™¨ï¼‰<br><br>2ã€ <em>CPUåˆ†é…å™¨ï¼ˆDispatcher</em>- å†³å®šäº†å°†CPUåˆ†é…ç»™è°ï¼Œç„¶ååˆ†é…å™¨å°†CPUæ§åˆ¶æƒäº¤ç»™è¯¥è¿›ç¨‹<br><br>3ã€ <em>è¿›ç¨‹è¡Œä¸º</em> - ä¸€èˆ¬åˆ†ä¸ºI/Oå’Œè®¡ç®—ï¼ˆCPUï¼‰ï¼Œæ ¹æ®å ç”¨æ—¶é—´ä¸åŒï¼Œåˆ†ä¸ºI/Oå¯†é›†å‹ï¼ˆI/O burstï¼‰è¿›ç¨‹å’ŒCPUå¯†é›†å‹ï¼ˆCPU burstï¼‰è¿›ç¨‹<br><br>4ã€ å½“ç„¶è°ƒåº¦æ˜¯ä¸€ä¸ªå¤æ‚çš„æ“ä½œä¼šæœ‰è°ƒåº¦ç®—æ³•å…·ä½“è¯·å‚è€ƒ<a href="https://yq.aliyun.com/articles/278727" target="_blank" rel="noopener">é˜¿é‡Œäº‘ç¤¾åŒºåšå®¢</a></p><p><strong>è®¡ç®—å¯†é›†å‹å’ŒIOå¯†é›†å‹</strong><br></p><p>1ã€è®¡ç®—å¯†é›†å‹ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯è¦è¿›è¡Œå¤§é‡çš„è®¡ç®—ï¼Œæ¶ˆè€—CPUèµ„æºï¼Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡åŒæ—¶è¿›è¡Œçš„æ•°é‡åº”å½“ç­‰äºCPUçš„æ ¸å¿ƒæ•°<br></p><p>2ã€IOå¯†é›†å‹ç‰¹ç‚¹æ˜¯CPUæ¶ˆè€—å¾ˆå°‘ï¼Œä»»åŠ¡çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…IOæ“ä½œå®Œæˆï¼ˆå› ä¸ºIOçš„é€Ÿåº¦è¿œè¿œä½äºCPUå’Œå†…å­˜çš„é€Ÿåº¦ï¼‰ã€‚å¯¹äºIOå¯†é›†å‹ä»»åŠ¡ï¼Œä»»åŠ¡è¶Šå¤šï¼ŒCPUæ•ˆç‡è¶Šé«˜ï¼Œä½†ä¹Ÿæœ‰ä¸€ä¸ªé™åº¦ã€‚å¸¸è§çš„å¤§éƒ¨åˆ†ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œæ¯”å¦‚Webåº”ç”¨<br></p><p><strong>å¤šè¿›ç¨‹-å¤šçº¿ç¨‹</strong><br></p><p>1ã€å¤šè¿›ç¨‹æ¨¡å¼æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯ç¨³å®šæ€§é«˜ï¼Œå› ä¸ºå­è¿›ç¨‹å´©æºƒï¼Œä¸ä¼šå½±å“ä¸»è¿›ç¨‹å’Œå…¶ä»–å­è¿›ç¨‹ã€‚è‘—åçš„Apacheæœ€æ—©å°±æ˜¯é‡‡ç”¨å¤šè¿›ç¨‹æ¨¡å¼ï¼Œå¤šè¿›ç¨‹æ¨¡å¼çš„ç¼ºç‚¹æ˜¯åˆ›å»ºè¿›ç¨‹çš„ä»£ä»·å¤§<br></p><p>2ã€å¤šçº¿ç¨‹æ¨¡å¼è‡´å‘½çš„ç¼ºç‚¹å°±æ˜¯ä»»ä½•ä¸€ä¸ªçº¿ç¨‹æŒ‚æ‰éƒ½å¯èƒ½ç›´æ¥é€ æˆæ•´ä¸ªè¿›ç¨‹å´©æºƒï¼Œå› ä¸ºæ‰€æœ‰çº¿ç¨‹å…±äº«è¿›ç¨‹çš„å†…å­˜ï¼Œä½†åˆ›å»ºçº¿ç¨‹ç›¸å¯¹äºè¿›ç¨‹å¼€é”€è¾ƒå°ï¼Œï¼Œæ‰€ä»¥è¿è¡Œé€Ÿåº¦è¾ƒæ¯”å¤šè¿›ç¨‹å¿«ï¼Œå¹¶ä¸”çº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«æ•°æ®ã€‚å¯ä»¥æœ‰æ•ˆè§£å†³å¤šè¿›ç¨‹å†…å­˜æµªè´¹é—®é¢˜ã€‚ä½†ç”±äºæ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å †æ ˆï¼Œéœ€è¦å ç”¨ä¸€å®šçš„å†…å­˜ç©ºé—´ï¼Œè€Œä¸”æ“ä½œç³»ç»Ÿå†…æ ¸åœ¨åˆ‡æ¢çº¿ç¨‹æ—¶ä¹Ÿè¦åˆ‡æ¢çº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚æ‰€ä»¥åœ¨å¤§å¹¶å‘é‡æ—¶ï¼Œå¤šçº¿ç¨‹ç»“æ„æ— æ³•åšåˆ°å¼ºå¤§çš„ä¼¸ç¼©æ€§<br></p><p><strong>å¼‚æ­¥I/O</strong><br></p><p>1ã€ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾… I/O æ“ä½œï¼Œå•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹ä¼šå¯¼è‡´åˆ«çš„ä»»åŠ¡æ— æ³•å¹¶è¡Œæ‰§è¡Œ<br><br>2ã€å……åˆ†åˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„å¼‚æ­¥ I/O æ”¯æŒï¼Œå°±å¯ä»¥ç”¨å•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹æ¥æ‰§è¡Œå¤šä»»åŠ¡ï¼Œè¿™ç§æ¨¡å‹ç§°ä¸ºäº‹ä»¶é©±åŠ¨æ¨¡å‹<br><br>3ã€åœ¨å•æ ¸CPUä¸Šé‡‡ç”¨å•è¿›ç¨‹æ¨¡å‹å¯ä»¥é«˜æ•ˆåœ°æ”¯æŒå¤šä»»åŠ¡ã€‚åœ¨å¤šæ ¸CPUä¸Šï¼Œå¯ä»¥è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼ˆæ•°é‡ä¸CPUæ ¸å¿ƒæ•°ç›¸åŒï¼‰ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPUã€‚ç”±äºç³»ç»Ÿæ€»çš„è¿›ç¨‹æ•°é‡ååˆ†æœ‰é™ï¼Œå› æ­¤æ“ä½œç³»ç»Ÿè°ƒåº¦éå¸¸é«˜æ•ˆ<br></p><p><strong>äº‹ä»¶é©±åŠ¨æ¨¡å‹</strong><br></p><p>1ã€äº‹ä»¶é©±åŠ¨æ¨¡å‹æ˜¯ä¸ºäº†è§£å†³é«˜å¹¶å‘ï¼ˆå¦‚Nodeï¼ŒNginx)<br><br>2ã€æ“ä½œç³»ç»Ÿåœ¨è°ƒåº¦æ—¶è¾ƒå°‘çš„åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œæ²¡æœ‰çº¿ç¨‹åŒæ­¥ç­‰é—®é¢˜<br><br>3ã€æ‰€æœ‰å¤„ç†éƒ½åœ¨å•çº¿ç¨‹ä¸Šè¿›è¡Œï¼Œæ‰€ä»¥å½±å“æ€§èƒ½çš„ç‚¹éƒ½åœ¨ CPU çš„è®¡ç®—èƒ½åŠ›ä¸Šï¼Œç”±äºä¸å—å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹æ¨¡å¼ä¸­èµ„æºä¸Šçº¿çš„å½±å“ï¼Œå¯ä¼¸ç¼©æ€§è¾ƒå¼º<br></p><p><strong>Nodeäº‹ä»¶é©±åŠ¨æ¨¡å‹</strong></p><p>1ã€æ¯ä¸€ä¸ª I/O å·¥ä½œè¢«æ·»åŠ åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œçº¿ç¨‹å¾ªç¯åœ°å¤„ç†é˜Ÿåˆ—ä¸Šçš„å·¥ä½œä»»åŠ¡ï¼Œå½“æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°æ¥å µå¡(è¯»å–æ–‡ä»¶ã€æŸ¥è¯¢æ•°æ®åº“)æ—¶ï¼Œçº¿ç¨‹ä¸ä¼šåœä¸‹æ¥ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯ç•™ä¸‹ä¸€ä¸ªå¤„ç†ç»“æœçš„å›è°ƒå‡½æ•°ï¼Œè½¬è€Œç»§ç»­æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚è¿™ä¸ªä¼ é€’åˆ°é˜Ÿåˆ—ä¸­çš„å›è°ƒå‡½æ•°åœ¨å µå¡ä»»åŠ¡è¿è¡Œç»“æŸåæ‰è¢«çº¿ç¨‹è°ƒç”¨<br></p><p><img src="/images/event.png"><br></p><p>2ã€Node åœ¨å¯åŠ¨è¿›ç¨‹ä¸­ä¼šåˆ›å»ºä¸€ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯è¿è¡Œå°±æ˜¯ä¸€ä¸ªTickå‘¨æœŸï¼Œæ¯ä¸ªTickå‘¨æœŸä¸­ä¼šä»äº‹ä»¶é˜Ÿåˆ—æŸ¥çœ‹æ˜¯å¦æœ‰äº‹ä»¶éœ€è¦å¤„ç†ï¼Œç›´åˆ°äº‹ä»¶é˜Ÿåˆ—å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œnodeåº”ç”¨å°±ä¼šç»ˆ<br><br>3ã€Node å¯¹äºå µå¡ I/O ä½¿ç”¨çº¿ç¨‹æ± æ¥åœ¨æ“ä½œï¼Œé€šè¿‡å–å…¶ä¸­ä¸€ä¸ªå­çº¿ç¨‹çº¿ç¨‹æ¥æ‰§è¡Œå¤æ‚ä»»åŠ¡ï¼Œè€Œä¸å ç”¨ä¸»å¾ªç¯çº¿ç¨‹ã€‚å½“å µå¡ä»»åŠ¡æ‰§è¡Œå®Œæ¯•é€šè¿‡æ·»åŠ åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­çš„å›è°ƒå‡½æ•°æ¥å¤„ç†æ¥ä¸‹æ¥çš„å·¥ä½œï¼Œè¿™æ ·å°±é˜²æ­¢å µå¡ I/O å ç”¨ç©ºé—²èµ„æºï¼Œè¿™å°±æ˜¯æ‰€è°“çš„éé˜»å¡å¼ I/O<br></p><p><img src="/images/event-loop.png"><br></p><p><strong>äº‹ä»¶é˜Ÿåˆ—è°ƒåº¦ï¼ˆé€šè¿‡å›è°ƒå‡½æ•°å°†ä»»åŠ¡æ·»åŠ äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼‰</strong><br><br>1ã€å†…ç½®çš„äº‹ä»¶å’Œäº‹ä»¶ç›‘å¬å™¨ï¼ˆhttpã€serverçš„ä¸€äº›äº‹ä»¶ï¼‰<br><br>2ã€å¼‚æ­¥å µå¡ I/O åº“(dbå¤„ç†ã€fså¤„ç†ç­‰)<br><br>3ã€å®šæ—¶å™¨setTimeoutã€setInterval<br><br>4ã€å…¨å±€å¯¹è±¡processçš„.nextTick()API<br><br>5ã€è‡ªå®šä¹‰çš„äº‹ä»¶å’Œç›‘å¬å™¨<br></p><p><strong>å†…ç½®äº‹ä»¶(ä¸¾ä¾‹)</strong><br></p><pre><code>// å¼•å…¥ events æ¨¡å—let events = require(&#39;events&#39;);// åˆ›å»ºäº‹ä»¶å¯¹è±¡let eventEmitter = new events.EventEmitter();// åˆ›å»ºäº‹ä»¶å¤„ç†ç¨‹åºlet connectHandler = function connected() {   // å¼€å§‹è§¦å‘äº‹ä»¶    eventEmitter.emit(&#39;start&#39;);}// ç»‘å®šäº‹ä»¶å¤„ç†ç¨‹åºeventEmitter.on(&#39;connection&#39;, connectHandler);eventEmitter.on(&#39;start&#39;, function(){});// è§¦å‘äº‹ä»¶å¤„ç†ç¨‹åºeventEmitter.emit(&#39;connection&#39;);console.log(&quot;ç¨‹åºæ‰§è¡Œå®Œæ¯•ã€‚&quot;);</code></pre><p>ä»¥ä¸Šæ˜¯Node äº‹ä»¶é©±åŠ¨æ¨¡å‹çš„åŸºæœ¬æ¦‚å¿µã€‚åœ¨ä¸‹ç¯‡è¿›ç¨‹æ–‡ç« ä¸­ä¼šä»‹ç»åœ¨ Node ä¸­æ€æ ·åˆ›å»ºå¤šè¿›ç¨‹æ¶æ„ï¼Œä¹Ÿä¼šåœ¨<strong>nodeé«˜çº§ç³»åˆ—-v8ä¸å¼‚æ­¥I/O</strong>ä¸­è¯¦ç»†ä»‹ç» Nodeçš„å¼‚æ­¥ I/O <br></p><h2 id="æ›´å¤šæ–¹æ³•å‚è€ƒ"><a href="#æ›´å¤šæ–¹æ³•å‚è€ƒ" class="headerlink" title="æ›´å¤šæ–¹æ³•å‚è€ƒ"></a>æ›´å¤šæ–¹æ³•å‚è€ƒ<br></h2><p><a href="http://nodejs.cn/api/events.html" target="_blank" rel="noopener">Node Api events äº‹ä»¶æ¨¡å— </a></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸç”Ÿæ‹–æ‹½</title>
      <link href="/2019/04/09/javascript/drag/"/>
      <url>/2019/04/09/javascript/drag/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å®é™…å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°å…³äºå…ƒç´ æ‹–æ‹½çš„åœºæ™¯ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬ä»Šå¤©å®ç°ä¸€ä¸ªç®€å•çš„æ‹–æ‹½å…ƒç´ åŠŸèƒ½</p><h3 id="css"><a href="#css" class="headerlink" title="css "></a>css <hr></h3><pre class="line-numbers language-css"><code class="language-css">  <span class="token selector">* </span><span class="token punctuation">{</span>      <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token selector"><span class="token class">.demo-box</span> </span><span class="token punctuation">{</span>      <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>      <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>      <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>      <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode">#ccc</span><span class="token punctuation">;</span>      <span class="token property">border</span><span class="token punctuation">:</span> solid <span class="token number">1</span>px <span class="token hexcode">#ccc</span><span class="token punctuation">;</span>      <span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">5</span>px<span class="token punctuation">;</span>      <span class="token property">line-height</span><span class="token punctuation">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>      <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="html"><a href="#html" class="headerlink" title="html"></a>html<hr></h3><pre class="line-numbers language-html"><code class="language-html">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>demo<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>demo-box<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>æŒ‰ä½å·¦é”®æ‹–åŠ¨<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="js"><a href="#js" class="headerlink" title="js "></a>js <hr></h3><pre class="line-numbers language-js"><code class="language-js">  window<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//ç”¨äºç¡®å®šæ˜¯å¦æ˜¯æ‹–æ‹½çš„å¯¹è±¡</span>    <span class="token keyword">var</span> drag<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//é¼ æ ‡ä½äºç›®æ ‡å…ƒç´ ä¸Šçš„æ—¶å€™è·ç¦»ç›®æ ‡å…ƒç´ çš„ä½ç½®</span>    <span class="token keyword">var</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//å–å¾—å…ƒç´ </span>    <span class="token keyword">var</span> ele <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     *é¼ æ ‡æŒ‰äº‹ä»¶     *@param  evt äº‹ä»¶å½¢å‚     */</span>    ele<span class="token punctuation">.</span>onmousedown <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//å–å¾—äº‹ä»¶å¯¹è±¡</span>      _event <span class="token operator">=</span> evt <span class="token operator">||</span> window<span class="token punctuation">.</span>event<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//è®¾ç½®dragå…ƒç´ ,è®¡ç®—å½“å‰ä½ç½®</span>      _target <span class="token operator">=</span> _event<span class="token punctuation">.</span>target <span class="token operator">||</span> _event<span class="token punctuation">.</span>srcElement<span class="token punctuation">;</span>      x <span class="token operator">=</span> _event<span class="token punctuation">.</span>clientX <span class="token operator">-</span> _target<span class="token punctuation">.</span>offsetLeft<span class="token punctuation">;</span>      y <span class="token operator">=</span> _event<span class="token punctuation">.</span>clientY <span class="token operator">-</span> _target<span class="token punctuation">.</span>offsetTop<span class="token punctuation">;</span>      drag <span class="token operator">=</span> _target<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     *é¼ æ ‡ç§»åŠ¨äº‹ä»¶     * @param evt äº‹ä»¶å½¢å‚     */</span>    document<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//ç¡®å®šé¼ æ ‡æ˜¯åœ¨ç›®æ ‡å…ƒç´ ä¸ŠæŒ‰ä¸‹å»åæ‰å¼€å§‹ç§»åŠ¨</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>drag<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _event <span class="token operator">=</span> evt <span class="token operator">||</span> window<span class="token punctuation">.</span>event<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//è®¾ç½®è¾¹ç•Œå…¨å±€å˜é‡</span>        <span class="token keyword">var</span> _left <span class="token operator">=</span> _event<span class="token punctuation">.</span>clientX <span class="token operator">-</span> x<span class="token punctuation">;</span>        <span class="token keyword">var</span> _top <span class="token operator">=</span> _event<span class="token punctuation">.</span>clientY <span class="token operator">-</span> y<span class="token punctuation">;</span>        <span class="token keyword">var</span> _windowInnerWidth <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>        <span class="token keyword">var</span> _windowInnerHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight        <span class="token keyword">var</span> _dragOffWidth <span class="token operator">=</span> drag<span class="token punctuation">.</span>offsetWidth        <span class="token keyword">var</span> _dragOffHeight <span class="token operator">=</span> drag<span class="token punctuation">.</span>offsetHeight        <span class="token keyword">var</span> _windowWidth <span class="token operator">=</span> _windowInnerWidth <span class="token operator">-</span> _dragOffWidth        <span class="token keyword">var</span> _windowHeight <span class="token operator">=</span> _windowInnerHeight <span class="token operator">-</span> _dragOffHeight        <span class="token comment" spellcheck="true">//æ§åˆ¶æ‹–æ‹½ç‰©ä½“çš„èŒƒå›´åªèƒ½åœ¨æµè§ˆå™¨è§†çª—å†…ï¼Œä¸å…è®¸å‡ºç°æ»šåŠ¨æ¡  </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>_left <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          _left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_left <span class="token operator">></span> _windowWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>          _left <span class="token operator">=</span> _windowWidth<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>_top <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          _top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_top <span class="token operator">></span> _windowHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>          _top <span class="token operator">=</span> _windowHeight<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//è®¾ç½®æ ·å¼</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cursor <span class="token operator">=</span> <span class="token string">'move'</span><span class="token punctuation">;</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>border <span class="token operator">=</span> <span class="token string">'dashed 1px red'</span><span class="token punctuation">;</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> _left <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> _top <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**      * æ¾å¼€é¼ æ ‡äº‹ä»¶     * @param evt äº‹ä»¶å½¢å‚      */</span>    document<span class="token punctuation">.</span>onmouseup <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>drag<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//å¸è½½æ ·å¼</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cursor <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>border <span class="token operator">=</span> <span class="token string">'dashed 1px #ccc'</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      drag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>crypto åŠ å¯†æ¨¡å—</title>
      <link href="/2019/04/08/node/crypto/"/>
      <url>/2019/04/08/node/crypto/</url>
      
        <content type="html"><![CDATA[<p>crypto æ¨¡å—ä¹Ÿæ˜¯æ ¸å¿ƒæ¨¡å—ä¹‹ä¸€ï¼Œæä¾›äº†åŠ å¯†åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¯¹ OpenSSL çš„å“ˆå¸Œã€HMACã€åŠ å¯†ã€è§£å¯†ã€ç­¾åã€ä»¥åŠéªŒè¯åŠŸèƒ½çš„ä¸€æ•´å¥—å°è£…ã€‚ä¸Šæ–‡ä¸­æåˆ°è¿‡æ ¸å¿ƒ C/C++ æ¨¡å—è¿è¡Œé€Ÿåº¦æ¯”å…¶ä»–æ¨¡å—è¦å¿«ã€‚<br></p><p><strong>MD5å’ŒSHA1</strong><br><br>MD5æ˜¯ä¸€ç§å¸¸ç”¨çš„å“ˆå¸Œç®—æ³•ï¼Œç”¨äºç»™ä»»æ„æ•°æ®ä¸€ä¸ªâ€œç­¾åâ€ã€‚è¿™ä¸ªç­¾åé€šå¸¸ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼š<br></p><pre><code>// å¼•å…¥åŠ å¯†æ¨¡å—const crypto = require(&#39;crypto&#39;);// åˆ›å»º Hash å®ä¾‹const hash = crypto.createHash(&#39;md5&#39;);// è®¡ç®—åçš„HMACæ‘˜è¦ update() æ–¹æ³•é»˜è®¤å­—ç¬¦ä¸²ç¼–ç ä¸ºUTF-8ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥Bufferhash.update(&#39;Hello, nodejs!&#39;);// encoding å€¼å¯ä»¥æ˜¯ &#39;hex&#39;, &#39;latin1&#39; æˆ–è€… &#39;base64&#39;.   å¦‚æœencoding æ˜¯å­—ç¬¦ä¸²ä¼šè¢«ç›´æ¥è¿”å›ï¼Œå…¶å®ƒæƒ…å†µä¼šè¿”å›ä¸€ä¸ª a Buffer.console.log(hash.digest(&#39;hex&#39;));Hash å¯¹è±¡åœ¨ hash.digest() æ–¹æ³•è°ƒç”¨ä¹‹åä¸èƒ½å†æ¬¡è¢«ä½¿ç”¨ã€‚å¤šæ¬¡çš„è°ƒç”¨ä¼šå¼•å‘é”™è¯¯å¹¶æŠ›å‡º</code></pre><p><strong>Hmac</strong><br><br>Hmacç®—æ³•ä¹Ÿæ˜¯ä¸€ç§å“ˆå¸Œç®—æ³•ï¼Œå®ƒå¯ä»¥åˆ©ç”¨MD5æˆ–SHA1ç­‰å“ˆå¸Œç®—æ³•ã€‚ä¸åŒçš„æ˜¯ï¼ŒHmacè¿˜éœ€è¦ä¸€ä¸ªå¯†é’¥ï¼š<br></p><pre><code>// å¼•å…¥åŠ å¯†æ¨¡å—const crypto = require(&#39;crypto&#39;);// åˆ›å»º hmac å®ä¾‹const hmac = crypto.createHmac(&#39;sha256&#39;, &#39;secret-key&#39;);// è®¡ç®—åçš„HMACæ‘˜è¦ update() æ–¹æ³•é»˜è®¤å­—ç¬¦ä¸²ç¼–ç ä¸ºUTF-8ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥Bufferhmac.update(&#39;Hello, nodejs!&#39;);// encoding å€¼å¯ä»¥æ˜¯ &#39;hex&#39;, &#39;latin1&#39; æˆ–è€… &#39;base64&#39;.   å¦‚æœencoding æ˜¯å­—ç¬¦ä¸²ä¼šè¢«ç›´æ¥è¿”å›ï¼Œå…¶å®ƒæƒ…å†µä¼šè¿”å›ä¸€ä¸ª a Buffer.console.log(hmac.digest(&#39;hex&#39;));åªè¦å¯†é’¥å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆåŒæ ·çš„è¾“å…¥æ•°æ®ä¹Ÿä¼šå¾—åˆ°ä¸åŒçš„ç­¾åï¼Œå› æ­¤ï¼Œå¯ä»¥æŠŠHmacç†è§£ä¸ºç”¨éšæœºæ•°â€œå¢å¼ºâ€çš„å“ˆå¸Œç®—æ³•</code></pre><p><strong>AES</strong><br><br>AESæ˜¯ä¸€ç§å¸¸ç”¨çš„å¯¹ç§°åŠ å¯†ç®—æ³•ï¼ŒåŠ è§£å¯†éƒ½ç”¨åŒä¸€ä¸ªå¯†é’¥ã€‚cryptoæ¨¡å—æä¾›äº†AESæ”¯æŒï¼Œä½†æ˜¯éœ€è¦è‡ªå·±å°è£…å¥½å‡½æ•°ï¼Œä¾¿äºä½¿ç”¨ï¼š<br></p><pre><code>// å¼•å…¥åŠ å¯†æ¨¡å—const crypto = require(&#39;crypto&#39;);// åŠ å¯†å‡½æ•°function aesEncrypt(data, key) {  const cipher = crypto.createCipher(&#39;aes192&#39;, key);  let crypted = cipher.update(data, &#39;utf8&#39;, &#39;hex&#39;);  crypted += cipher.final(&#39;hex&#39;);  return crypted;}// è§£å¯†å‡½æ•°function aesDecrypt(encrypted, key) {  const decipher = crypto.createDecipher(&#39;aes192&#39;, key);  let decrypted = decipher.update(encrypted, &#39;hex&#39;, &#39;utf8&#39;);  decrypted += decipher.final(&#39;utf8&#39;);  return decrypted;}let data = &#39;Hello, this is a secret message!&#39;;let key = &#39;Password!&#39;;let encrypted = aesEncrypt(data, key);let decrypted = aesDecrypt(encrypted, key);console.log(&#39;Plain text: &#39; + data);console.log(&#39;Encrypted text: &#39; + encrypted);console.log(&#39;Decrypted text: &#39; + decrypted);</code></pre><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br></p><pre><code>Plain text: Hello, this is a secret message!Encrypted text: 8a944d97bdabc157a5b7a40cb180e7...Decrypted text: Hello, this is a secret message!</code></pre><p><strong>Diffie-Hellman</strong><br></p><p>DHç®—æ³•æ˜¯ä¸€ç§å¯†é’¥äº¤æ¢åè®®ï¼Œå®ƒå¯ä»¥è®©åŒæ–¹åœ¨ä¸æ³„æ¼å¯†é’¥çš„æƒ…å†µä¸‹åå•†å‡ºä¸€ä¸ªå¯†é’¥æ¥ã€‚DHç®—æ³•åŸºäºç¦»æ•£å¯¹æ•°æ•°å­¦åŸç†<br></p><pre><code>// å¼•å…¥åŠ å¯†æ¨¡å—const crypto = require(&#39;crypto&#39;);// è¿›è¡ŒåŠ å¯†äº¤æ¢ crypto_alet crypto_a = crypto.createDiffieHellman(512);let crypto_a_keys = crypto_a.generateKeys();let prime = crypto_a.getPrime();let generator = crypto_a.getGenerator();console.log(&#39;Prime: &#39; + prime.toString(&#39;hex&#39;));console.log(&#39;Generator: &#39; + generator.toString(&#39;hex&#39;));// è¿›è¡ŒåŠ å¯†äº¤æ¢ crypto_blet crypto_b = crypto.createDiffieHellman(prime, generator);let crypto_b_keys = crypto_b.generateKeys();// äº¤æ¢ç”Ÿæˆå¯†é’¥let a_secret = crypto_a.computeSecret(crypto_b_keys);let b_secret = crypto_b.computeSecret(crypto_a_keys);</code></pre><p><strong>RSA</strong></p><p>RSAç®—æ³•æ˜¯ä¸€ç§éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå³ç”±ä¸€ä¸ªç§é’¥å’Œä¸€ä¸ªå…¬é’¥æ„æˆçš„å¯†é’¥å¯¹ï¼Œé€šè¿‡ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†ï¼Œæˆ–è€…é€šè¿‡å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ã€‚å…¶ä¸­ï¼Œå…¬é’¥å¯ä»¥å…¬å¼€ï¼Œç§é’¥å¿…é¡»ä¿å¯†<br></p><p>1ã€ç”Ÿæˆä¸€ä¸ªRSAå¯†é’¥å¯¹ï¼š<br></p><pre><code>openssl genrsa -aes256 -out rsa-key.pem 2048</code></pre><p>2ã€é€šè¿‡ä¸Šé¢çš„rsa-key.pemåŠ å¯†æ–‡ä»¶ï¼Œå¯¼å‡ºåŸå§‹çš„ç§é’¥<br></p><pre><code>openssl rsa -in rsa-key.pem -outform PEM -out rsa-prv.pem</code></pre><p>3ã€å‘½ä»¤å¯¼å‡ºåŸå§‹çš„å…¬é’¥<br></p><pre><code>openssl rsa -in rsa-key.pem -outform PEM -pubout -out rsa-pub.pemè¿™æ ·ï¼Œæˆ‘ä»¬å°±å‡†å¤‡å¥½äº†åŸå§‹ç§é’¥æ–‡ä»¶rsa-prv.pemå’ŒåŸå§‹å…¬é’¥æ–‡ä»¶rsa-pub.pemï¼Œç¼–ç æ ¼å¼å‡ä¸ºPEM</code></pre><p>ä½¿ç”¨cryptoæ¨¡å—æä¾›çš„æ–¹æ³•ï¼Œå³å¯å®ç°éå¯¹ç§°åŠ è§£å¯†<br></p><pre><code>const fs = require(&#39;fs&#39;);const crypto = require(&#39;crypto&#39;);// ä»æ–‡ä»¶åŠ è½½key:function loadKey(file) {  // keyå®é™…ä¸Šå°±æ˜¯PEMç¼–ç çš„å­—ç¬¦ä¸²:  return fs.readFileSync(file, &#39;utf8&#39;);}let prvKey = loadKey(&#39;./rsa-prv.pem&#39;);let pubKey = loadKey(&#39;./rsa-pub.pem&#39;);let message = &#39;Hello, world!&#39;;// ä½¿ç”¨ç§é’¥åŠ å¯†:let enc_by_prv = crypto.privateEncrypt(prvKey, Buffer.from(message, &#39;utf8&#39;));console.log(&#39;encrypted by private key: &#39; + enc_by_prv.toString(&#39;hex&#39;));let dec_by_pub = crypto.publicDecrypt(pubKey, enc_by_prv);console.log(&#39;decrypted by public key: &#39; + dec_by_pub.toString(&#39;utf8&#39;));æ‰§è¡Œåï¼Œå¯ä»¥å¾—åˆ°è§£å¯†åçš„æ¶ˆæ¯ï¼Œä¸åŸå§‹æ¶ˆæ¯ç›¸åŒã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ï¼š// ä½¿ç”¨å…¬é’¥åŠ å¯†:let enc_by_pub = crypto.publicEncrypt(pubKey, Buffer.from(message, &#39;utf8&#39;));console.log(&#39;encrypted by public key: &#39; + enc_by_pub.toString(&#39;hex&#39;));// ä½¿ç”¨ç§é’¥è§£å¯†:let dec_by_prv = crypto.privateDecrypt(prvKey, enc_by_pub);console.log(&#39;decrypted by private key: &#39; + dec_by_prv.toString(&#39;utf8&#39;));æ‰§è¡Œå¾—åˆ°çš„è§£å¯†åçš„æ¶ˆæ¯ä»ä¸åŸå§‹æ¶ˆæ¯ç›¸åŒã€‚</code></pre><p><strong>è¯ä¹¦</strong><br>cryptoæ¨¡å—ä¹Ÿå¯ä»¥å¤„ç†æ•°å­—è¯ä¹¦ã€‚æ•°å­—è¯ä¹¦é€šå¸¸ç”¨åœ¨SSLè¿æ¥ï¼Œä¹Ÿå°±æ˜¯Webçš„httpsè¿æ¥ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œhttpsè¿æ¥åªéœ€è¦å¤„ç†æœåŠ¡å™¨ç«¯çš„å•å‘è®¤è¯ï¼Œå¦‚æ— ç‰¹æ®Šéœ€æ±‚ï¼ˆä¾‹å¦‚è‡ªå·±ä½œä¸ºRootç»™å®¢æˆ·å‘è®¤è¯è¯ä¹¦ï¼‰ï¼Œå»ºè®®ç”¨åå‘ä»£ç†æœåŠ¡å™¨å¦‚Nginxç­‰WebæœåŠ¡å™¨å»å¤„ç†è¯ä¹¦ã€‚<br></p><h2 id="æ›´å¤šå‚è€ƒ"><a href="#æ›´å¤šå‚è€ƒ" class="headerlink" title="æ›´å¤šå‚è€ƒ"></a>æ›´å¤šå‚è€ƒ<br></h2><p><a href="https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000/001434501504929883d11d84a1541c6907eefd792c0da51000" target="_blank" rel="noopener">å»–é›ªå³°è€å¸ˆçš„Crypto</a></p><p><a href="http://nodejs.cn/api/crypto.html" target="_blank" rel="noopener">Node Api crypto åŠ å¯†æ¨¡å— </a></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>module æ¨¡å—æœºåˆ¶</title>
      <link href="/2019/04/05/node/module/"/>
      <url>/2019/04/05/node/module/</url>
      
        <content type="html"><![CDATA[<p>æ¨¡å—æ˜¯Node.js åº”ç”¨ç¨‹åºçš„åŸºæœ¬ç»„æˆéƒ¨åˆ†ï¼Œæ–‡ä»¶å’Œæ¨¡å—æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚å‰ç«¯æ¨¡å—åŒ–ç»„ä»¶åŒ–ä¹Ÿæ˜¯åœ¨è¿™å‡ å¹´é€æ¸çš„æµè¡Œï¼Œåœ¨ web2.0 å‘å±•è¿‡ç¨‹å¦‚ä¸‹<br></p><p><image src="/images/module.png" width="300"></image><br></p><h3 id="CommonJS-è§„èŒƒ"><a href="#CommonJS-è§„èŒƒ" class="headerlink" title="CommonJS è§„èŒƒ"></a>CommonJS è§„èŒƒ<br></h3><p>CommonJSï¼ˆ<a href="http://www.commonjs.org" target="_blank" rel="noopener">http://www.commonjs.org</a>ï¼‰è§„èŒƒçš„å‡ºç°è§£å†³äº†JavaScript æ²¡æœ‰æ¨¡å—ç³»ç»Ÿï¼Œæ ‡å‡†åº“ç­‰ç­‰é—®é¢˜ï¼Œè€Œ Node.js è‡ªèº«å®ç°äº† require ä½œä¸ºå…¶å¼•å…¥æ¨¡å—çš„æ–¹æ³•ï¼ŒåŒæ—¶ NPM ä¹ŸåŸºäº CommonJS å®šä¹‰çš„åŒ…è§„èŒƒï¼Œå®ç°äº†ä¾èµ–ç®¡ç†å’Œæ¨¡å—è‡ªåŠ¨å®‰è£…ç­‰åŠŸèƒ½ã€‚ä¸‹å›¾å±•ç°Nodeä¸æµè§ˆå™¨ä»¥åŠW3Cç»„ç»‡ã€CommonJSç»„ç»‡ã€ECMAScriptä¹‹é—´çš„å…³ç³»<br></p><p><image src="/images/commonjs.png" width="550"></image><br></p><h3 id="CommonJS-æ¨¡å—"><a href="#CommonJS-æ¨¡å—" class="headerlink" title="CommonJS æ¨¡å—"></a>CommonJS æ¨¡å—</h3><p>1ã€æ¨¡å—å¼•ç”¨ require å…³é”®å­— <br></p><pre><code>const math = require(&#39;math&#39;); </code></pre><p>2ã€æ¨¡å—å®šä¹‰å¯¼å‡º exports å…³é”®å­—<br></p><pre><code>exports.area = function (r) {    return Math.PI * r * r;};</code></pre><p>3ã€æ¨¡å—æ ‡è¯†<br><br>æ¨¡å—æ ‡è¯†å…¶å®å°±æ˜¯ä¼ é€’ç»™require()æ–¹æ³•çš„å‚æ•°ï¼Œå®ƒå¿…é¡»æ˜¯ç¬¦åˆå°é©¼å³°å‘½åçš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…ä»¥.ã€..å¼€å¤´çš„ç›¸å¯¹è·¯å¾„ï¼Œæˆ–è€…ç»å¯¹è·¯å¾„ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æœ‰ç‹¬ç«‹çš„ç©ºé—´ã€‚é˜²æ­¢è™‘å˜é‡æ±¡æŸ“ã€‚<br></p><h3 id="Node-æ¨¡å—å®ç°"><a href="#Node-æ¨¡å—å®ç°" class="headerlink" title="Node æ¨¡å—å®ç°"></a>Node æ¨¡å—å®ç°<br></h3><p>1ã€å¼•å…¥æ¨¡å—ä¸‰ä¸ªæ­¥éª¤(åˆ†ä¸ºæ ¸å¿ƒæ¨¡å—å’Œæ–‡ä»¶æ¨¡å—)<br></p><pre><code>(1) è·¯å¾„åˆ†æ(2) æ–‡ä»¶å®šä½(3) ç¼–è¯‘æ‰§è¡Œ</code></pre><p>æ ¸å¿ƒæ¨¡å—å’Œæ–‡ä»¶æ¨¡å—çš„åŒºåˆ«åœ¨äºåŠ è½½çš„æ—¶æœºï¼Œæ ¸å¿ƒæ¨¡å—åœ¨ Node è¿›ç¨‹å¯åŠ¨æ—¶è¢«ç›´æ¥åŠ è½½åˆ°å†…å­˜ä¸­æ¯”æ–‡ä»¶æ¨¡å—çœç•¥äº†æ–‡ä»¶å®šä½å’Œç¼–è¯‘æ‰§è¡Œè¿‡ç¨‹<br></p><h3 id="Node-æ¨¡å—è½½å…¥ç­–ç•¥"><a href="#Node-æ¨¡å—è½½å…¥ç­–ç•¥" class="headerlink" title="Node æ¨¡å—è½½å…¥ç­–ç•¥"></a>Node æ¨¡å—è½½å…¥ç­–ç•¥<br></h3><p>1ã€ä¸è®ºæ˜¯æ ¸å¿ƒæ¨¡å—è¿˜æ˜¯æ–‡ä»¶æ¨¡å—ï¼Œrequire()æ–¹æ³•å¯¹ç›¸åŒæ¨¡å—çš„äºŒæ¬¡åŠ è½½éƒ½ä¸€å¾‹é‡‡ç”¨ç¼“å­˜ä¼˜å…ˆï¼Œä»¥å‡å°‘äºŒæ¬¡å¼•å…¥æ—¶çš„å¼€é”€<br><br>2ã€æ¨¡å—å¼•ç”¨çš„è¿‡ç¨‹ç”±äºæ ‡è¯†ç¬¦ä¸åŒåœ¨è·¯å¾„åˆ†æå’Œæ–‡ä»¶å®šä½ä¸­æœ‰ä¸€å®šçš„å·®å¼‚<br></p><pre><code>// è·¯å¾„åˆ†ææ ¸å¿ƒæ¨¡å—ï¼Œå¦‚httpã€fsã€pathç­‰(åŠ è½½æœ€å¿«).æˆ–..å¼€å§‹çš„ç›¸å¯¹è·¯å¾„æ–‡ä»¶æ¨¡å—(æ…¢äºæ ¸å¿ƒæ¨¡å—)ä»¥/å¼€å§‹çš„ç»å¯¹è·¯å¾„æ–‡ä»¶æ¨¡å—(æ…¢äºæ ¸å¿ƒæ¨¡å—)è‡ªå®šä¹‰æ¨¡å—ï¼ˆæœ€æ…¢-ç”±äºæ²¿è·¯å¾„å‘ä¸Šé€çº§é€’å½’ï¼Œç›´åˆ°æ ¹ç›®å½•ä¸‹çš„node_modulesç›®å½•ï¼Œå±‚çº§è¶Šå¤šè¶Šè€—æ—¶// æ–‡ä»¶å®šä½ç”±äºå…¶æ‰©å±•åä¸åŒ Node ä¼šæŒ‰ .jsã€.jsonã€.node çš„æ¬¡åºè¡¥ã€è¶³æ‰©å±•åï¼Œä¾æ¬¡å°è¯•è°ƒç”¨fsæ¨¡å—åŒæ­¥é˜»å¡å¼åœ°åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¦‚æœæ–‡ä»¶ä¸æ˜¯ .js å¯ä»¥åœ¨åŠ è½½çš„æ—¶å€™å†™ä¸Šæ–‡ä»¶çš„æ‰©å±•åï¼Œå¯ä»¥åŠ å¿«æ–‡ä»¶å®šä½é€Ÿåº¦ï¼Œé…åˆç¼“å­˜ï¼Œå¯ä»¥å¤§å¹…åº¦ç¼“è§£ Node å•çº¿ç¨‹ä¸­é˜»å¡å¼è°ƒç”¨çš„ç¼ºé™·</code></pre><p>3ã€æ¨¡å—ç¼–è¯‘</p><pre><code>function Module(id, parent) {  this.id = id;  this.exports = {};  this.parent = parent;  if (parent &amp;&amp; parent.children) {    parent.children.push(this);  }  this.filename = null;  this.loaded = false;  this.children = [];} å¯¹äºä¸åŒçš„æ–‡ä»¶æ‰©å±•åï¼Œå…¶è½½å…¥æ–¹æ³•ä¹Ÿæœ‰æ‰€ä¸åŒ.js æ–‡ä»¶  é€šè¿‡fsæ¨¡å—åŒæ­¥è¯»å–æ–‡ä»¶åç¼–è¯‘æ‰§è¡Œã€‚åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­è¿›è¡Œäº†å¤´å°¾åŒ…è£…ã€‚åœ¨å¤´éƒ¨æ·»åŠ äº†  (function (exports, require, module, __filename, __dirname) {    \nï¼Œåœ¨å°¾éƒ¨æ·»åŠ äº†\n  });ã€‚  é€šè¿‡vmåŸç”Ÿæ¨¡å—çš„runInThisContext()æ–¹æ³•æ‰§è¡Œï¼ˆç±»ä¼¼evalï¼Œåªæ˜¯å…·æœ‰æ˜ç¡®ä¸Šä¸‹æ–‡ï¼Œä¸æ±¡æŸ“å…¨å±€ï¼‰ï¼Œè¿”å›ä¸€ä¸ªå…·ä½“çš„  functionå¯¹è±¡ã€‚æœ€åï¼Œå°†å½“å‰æ¨¡å—å¯¹è±¡çš„exportså±æ€§ã€require()æ–¹æ³•ã€moduleï¼ˆæ¨¡å—å¯¹è±¡è‡ªèº«ï¼‰ï¼Œ  ä»¥åŠåœ¨æ–‡ä»¶å®šä½ä¸­å¾—åˆ°çš„å®Œæ•´æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶ç›®å½•ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿™ä¸ªfunction()æ‰§è¡Œã€‚.node æ–‡ä»¶ã€‚ç”¨C/C++ç¼–å†™çš„æ‰©å±•æ–‡ä»¶ï¼Œé€šè¿‡dlopen()æ–¹æ³•åŠ è½½æœ€åç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶ã€‚  Nodeè°ƒç”¨process.dlopen()æ–¹æ³•è¿›è¡ŒåŠ è½½å’Œæ‰§è¡Œã€‚åœ¨Nodeçš„æ¶æ„ä¸‹ï¼Œdlopen()æ–¹æ³•åœ¨Windows  å’Œ*nixå¹³å°ä¸‹åˆ†åˆ«æœ‰ä¸åŒçš„å®ç°ï¼Œé€šè¿‡libuvå…¼å®¹å±‚è¿›è¡Œäº†å°è£….json æ–‡ä»¶ã€‚é€šè¿‡fsæ¨¡å—åŒæ­¥è¯»å–æ–‡ä»¶åï¼Œç”¨JSON.parse()è§£æè¿”å›ç»“æœã€‚å…¶ä½™æ‰©å±•åæ–‡ä»¶ã€‚å®ƒä»¬éƒ½è¢«å½“åš.jsæ–‡ä»¶è½½å…¥ã€‚æ¯ä¸€ä¸ªç¼–è¯‘æˆåŠŸçš„æ¨¡å—éƒ½ä¼šå°†å…¶æ–‡ä»¶è·¯å¾„ä½œä¸ºç´¢å¼•ç¼“å­˜åœ¨Module._cacheå¯¹è±¡ä¸Šï¼Œä»¥æé«˜äºŒæ¬¡å¼•å…¥çš„æ€§èƒ½ã€‚</code></pre><h3 id="Node-æ ¸å¿ƒæ¨¡å—çš„ç¼–è¯‘ã€å¼•å…¥ã€åŠ è½½è¿‡ç¨‹"><a href="#Node-æ ¸å¿ƒæ¨¡å—çš„ç¼–è¯‘ã€å¼•å…¥ã€åŠ è½½è¿‡ç¨‹" class="headerlink" title="Node æ ¸å¿ƒæ¨¡å—çš„ç¼–è¯‘ã€å¼•å…¥ã€åŠ è½½è¿‡ç¨‹"></a>Node æ ¸å¿ƒæ¨¡å—çš„ç¼–è¯‘ã€å¼•å…¥ã€åŠ è½½è¿‡ç¨‹<br></h3><p><strong>æ¨¡å—è°ƒç”¨æ ˆ</strong><br></p><p>1ã€C/C++å†…å»ºæ¨¡å—å±äºæœ€åº•å±‚çš„æ¨¡å—ï¼Œå®ƒå±äºæ ¸å¿ƒæ¨¡å—ï¼Œä¸»è¦æä¾›APIç»™JavaScriptæ ¸å¿ƒæ¨¡å—å’Œç¬¬ä¸‰æ–¹JavaScriptæ–‡ä»¶æ¨¡å—è°ƒç”¨ã€‚<br><br>2ã€JavaScriptæ ¸å¿ƒæ¨¡å—ä¸»è¦æ‰®æ¼”çš„èŒè´£æœ‰ä¸¤ç±»ï¼šä¸€ç±»æ˜¯ä½œä¸ºC/C++å†…å»ºæ¨¡å—çš„å°è£…å±‚å’Œæ¡¥æ¥å±‚ï¼Œä¾›æ–‡ä»¶æ¨¡å—è°ƒç”¨ï¼›ä¸€ç±»æ˜¯çº¯ç²¹çš„åŠŸèƒ½æ¨¡å—ï¼Œå®ƒä¸éœ€è¦è·Ÿåº•å±‚æ‰“äº¤é“ï¼Œä½†æ˜¯åˆååˆ†é‡è¦<br></p><p><image src="/images/module-p.png" width="350"></image><br></p><p><strong>æ ¸å¿ƒæ¨¡å—è°ƒç”¨æµç¨‹</strong><br></p><p>1ã€ JavaScript æ ¸å¿ƒæ¨¡å—ç¼–è¯‘è¿‡ç¨‹<br></p><ul><li><p>è½¬å­˜ä¸ºè½¬å­˜ä¸ºC/C++ä»£ç ï¼ˆNodeé‡‡ç”¨äº†V8é™„å¸¦çš„js2c.pyå·¥å…·ï¼Œå°†æ‰€æœ‰å†…ç½®çš„JavaScriptä»£ç ï¼ˆsrc/node.jså’Œlib/*.jsï¼‰è½¬æ¢æˆC++é‡Œçš„æ•°ç»„ï¼Œç”Ÿæˆnode_natives.hå¤´æ–‡ä»¶ï¼Œä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜å‚¨åœ¨ node çš„å‘½ä»¤ç©ºé—´ä¸­ï¼‰<br></p></li><li><p>å¯åŠ¨ node è¿›ç¨‹ JavaScript ä»£ç ç›´æ¥åŠ è½½è¿›å†…å­˜ä¸­<br></p></li><li><p>ç¼–è¯‘ JavaScript æ ¸å¿ƒæ¨¡å—ï¼ˆlibç›®å½•ä¸‹çš„æ‰€æœ‰æ¨¡å—æ–‡ä»¶ä¹Ÿæ²¡æœ‰å®šä¹‰requireã€moduleã€exportsè¿™äº›å˜é‡ã€‚ä¸Šé¢è¯´è¿‡åœ¨å¼•å…¥ JavaScript æ ¸å¿ƒæ¨¡å—è¿‡ç¨‹è¿›è¡Œå¤´å°¾åŒ…è£…ï¼Œæ‰å¯ä»¥æ‰§è¡Œexportså¯¹è±¡ï¼‰<br></p><pre><code>// node_natives.h å¤´æ–‡ä»¶ä»£ç namespace node {const char node_native[] = { 47, 47, ..};const char dgram_native[] = { 47, 47, ..};const char console_native[] = { 47, 47, ..};const char buffer_native[] = { 47, 47, ..};const char querystring_native[] = { 47, 47, ..};const char punycode_native[] = { 47, 42, ..};...struct _native {  const char* name;  const char* source;  size_t source_len;};static const struct _native natives[] = {  { &quot;node&quot;, node_native, sizeof(node_native)-1 },  { &quot;dgram&quot;, dgram_native, sizeof(dgram_native)-1 },  ...};}// JavaScript æ ¸å¿ƒæ¨¡å—é€šè¿‡process.binding(&#39;natives&#39;)å–å‡ºï¼Œç¼–è¯‘æˆåŠŸçš„æ¨¡å—ç¼“å­˜åˆ° NativeModule._cache å¯¹è±¡ä¸Šï¼Œæ–‡ä»¶æ¨¡å—åˆ™ç¼“å­˜åˆ° Module._cache å¯¹è±¡ä¸Šfunction NativeModule(id) {this.filename = id + &#39;.js&#39;;this.id = id;this.exports = {};this.loaded = false;}NativeModule._source = process.binding(&#39;natives&#39;);NativeModule._cache = {}; </code></pre></li></ul><p>2ã€ C/C++æ ¸å¿ƒæ¨¡å—çš„ç¼–è¯‘è¿‡ç¨‹<br></p><ul><li><p>å®šä¹‰å†…å»ºæ¨¡å—å†…éƒ¨ç»“æ„</p></li><li><p>é€šè¿‡NODE_MODULEå®å°†æ¨¡å—å®šä¹‰åˆ°nodeå‘½åç©ºé—´ä¸­ï¼Œæ¨¡å—çš„å…·ä½“åˆå§‹åŒ–æ–¹æ³•æŒ‚è½½ä¸ºç»“æ„çš„register_funcæˆå‘˜<br></p></li><li><p>node_extensions.hæ–‡ä»¶å°†è¿™äº›æ•£åˆ—çš„å†…å»ºæ¨¡å—ç»Ÿä¸€æ”¾è¿›äº†ä¸€ä¸ªå«node_module_listçš„æ•°ç»„ä¸­<br></p></li><li><p>Node é€šè¿‡ get_builtin_module() æ–¹æ³•ä» node_module_list æ•°ç»„ä¸­å–å‡ºè¿™äº›æ¨¡å—<br></p><pre><code>// å†…å»ºæ¨¡å—çš„å†…éƒ¨ç»“æ„å®šä¹‰struct node_module_struct {int version;void *dso_handle;const char *filename;void (*register_func) (v8::Handle&lt;v8::Object&gt; target);const char *modname;};// æŒ‚è½½ä¸ºç»“æ„çš„register_funcæˆå‘˜#define NODE_MODULE(modname, regfunc) extern &quot;C&quot; {  NODE_MODULE_EXPORT node::node_module_struct modname ## _module =  {    NODE_STANDARD_MODULE_STUFF,    regfunc,    NODE_STRINGIFY(modname)  }; } </code></pre></li></ul><p>3ã€æ ¸å¿ƒæ¨¡å—çš„å¼•å…¥æµç¨‹<br><br>å¦‚ os åŸç”Ÿæ¨¡å—çš„å¼•å…¥æµç¨‹<br><br><image src="/images/module-os.png" width="350"></image><br></p><p>é€šè¿‡ä»¥ä¸Šæˆ‘ä»¬å¤§è‡´äº†è§£äº† Node ä¸­æ¨¡å—çš„ç¼–è¯‘ã€åŠ è½½ã€å¼•å…¥æµç¨‹ã€‚å½“ç„¶è¿˜æœ‰æ ¸å¿ƒæ¨¡å—çš„ç¼–å†™ï¼Œåœ¨è¿™é‡Œå°±ä¸è¿‡å¤šçš„é˜è¿°äº†ã€‚æ›´å¤šè¯·å‚è€ƒæœ´çµè€å¸ˆç¼–è‘—çš„ã€Šæ·±å…¥æµ…å‡º nodeã€‹ï¼Œç›¸ä¿¡ä¼šæœ‰æ›´å¤šçš„æ”¶è·ã€‚<br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>querystring è·¯å¾„æ“ä½œ</title>
      <link href="/2019/04/04/node/querystring/"/>
      <url>/2019/04/04/node/querystring/</url>
      
        <content type="html"><![CDATA[<p>querystring æ¨¡å—æä¾›ç”¨äºè§£æå’Œæ ¼å¼åŒ– URL æŸ¥è¯¢å­—ç¬¦ä¸²<br></p><h3 id="è§£æ-URL-å­—ç¬¦ä¸²-querystring-parse-str-sep-eq-options"><a href="#è§£æ-URL-å­—ç¬¦ä¸²-querystring-parse-str-sep-eq-options" class="headerlink" title="è§£æ URL å­—ç¬¦ä¸² querystring.parse(str[, sep[, eq[, options]]]) "></a>è§£æ URL å­—ç¬¦ä¸² querystring.parse(str[, sep[, eq[, options]]]) <br></h3><pre><code>// å¼•å…¥æ¨¡å—const querystring = require(&#39;querystring&#39;);querystring.parse(&#39;foo=bar&amp;abc=xyz&amp;abc=123&#39;)è¾“å‡ºä¸ºï¼š{  foo: &#39;bar&#39;,  abc: [&#39;xyz&#39;, &#39;123&#39;]}</code></pre><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå°†å‡å®šæŸ¥è¯¢å­—ç¬¦ä¸²ä¸­çš„ç™¾åˆ†æ¯”ç¼–ç å­—ç¬¦ä½¿ç”¨ UTF-8 ç¼–ç ã€‚ å¦‚æœä½¿ç”¨å…¶ä»–å­—ç¬¦ç¼–ç ï¼Œåˆ™éœ€è¦æŒ‡å®šå…¶ä»– decodeURIComponent é€‰é¡¹ï¼š<br></p><pre><code>// å‡è®¾ gbkEncodeURIComponent å‡½æ•°å·²å­˜åœ¨ã€‚querystring.parse(&#39;w=%D6%D0%CE%C4&amp;foo=bar&#39;, null, null,{ decodeURIComponent: gbkDecodeURIComponent });</code></pre><h3 id="åºåˆ—åŒ–-URL-å­—ç¬¦ä¸²-querystring-stringify-obj-sep-eq-options"><a href="#åºåˆ—åŒ–-URL-å­—ç¬¦ä¸²-querystring-stringify-obj-sep-eq-options" class="headerlink" title="åºåˆ—åŒ– URL å­—ç¬¦ä¸² querystring.stringify(obj[, sep[, eq[, options]]]) "></a>åºåˆ—åŒ– URL å­—ç¬¦ä¸² querystring.stringify(obj[, sep[, eq[, options]]]) <br></h3><pre><code>// å¼•å…¥æ¨¡å—const querystring = require(&#39;querystring&#39;);// è¾“å‡ºä¸º &#39;foo=bar&amp;baz=qux&amp;baz=quux&amp;corge=&#39;querystring.stringify({ foo: &#39;bar&#39;, baz: [&#39;qux&#39;, &#39;quux&#39;], corge: &#39;&#39; });// è¾“å‡ºä¸º &#39;foo:bar;baz:qux&#39;querystring.stringify({ foo: &#39;bar&#39;, baz: &#39;qux&#39; }, &#39;;&#39;, &#39;:&#39;);</code></pre><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢å­—ç¬¦ä¸²ä¸­éœ€è¦ç™¾åˆ†æ¯”ç¼–ç çš„å­—ç¬¦å°†ç¼–ç ä¸º UTF-8ã€‚ å¦‚æœéœ€è¦å…¶ä»–ç¼–ç ï¼Œåˆ™éœ€è¦æŒ‡å®šå…¶ä»– encodeURIComponent é€‰é¡¹ï¼š</p><pre><code>// å‡è®¾ gbkEncodeURIComponent å‡½æ•°å·²å­˜åœ¨ã€‚querystring.stringify({ w: &#39;ä¸­æ–‡&#39;, foo: &#39;bar&#39; }, null, null,{ encodeURIComponent: gbkEncodeURIComponent })</code></pre><p><a href="https://nodejs.org/docs/latest-v9.x/api/querystring.html" target="_blank" rel="noopener">å…¶ä»–æ–¹æ³•è¯·å‚è€ƒ Node Api </a><br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>path è·¯å¾„æ“ä½œ</title>
      <link href="/2019/04/02/node/path/"/>
      <url>/2019/04/02/node/path/</url>
      
        <content type="html"><![CDATA[<p>path æ¨¡å—æä¾›ç”¨äºå¤„ç†æ–‡ä»¶è·¯å¾„å’Œç›®å½•è·¯å¾„çš„å®ç”¨å·¥å…·<br></p><h3 id="pathä½¿ç”¨ç‰¹ç‚¹"><a href="#pathä½¿ç”¨ç‰¹ç‚¹" class="headerlink" title="pathä½¿ç”¨ç‰¹ç‚¹"></a>pathä½¿ç”¨ç‰¹ç‚¹</h3><p>path æ¨¡å—çš„é»˜è®¤æ“ä½œå›  Node.js åº”ç”¨ç¨‹åºè¿è¡Œæ‰€åœ¨çš„æ“ä½œç³»ç»Ÿè€Œå¼‚ã€‚ å…·ä½“æ¥è¯´ï¼Œå½“åœ¨ Windows æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œæ—¶ï¼Œ path æ¨¡å—å°†å‡å®šæ­£åœ¨ä½¿ç”¨ Windows é£æ ¼çš„è·¯å¾„ã€‚<br></p><h3 id="è·å–è·¯å¾„-path-dirname-p"><a href="#è·å–è·¯å¾„-path-dirname-p" class="headerlink" title="è·å–è·¯å¾„    path.dirname(p) "></a>è·å–è·¯å¾„    path.dirname(p) <br></h3><pre><code>// å¼•å…¥ path æ¨¡å—const path = require(&#39;path&#39;);// è¾“å‡º /demo/js/test.jsconsole.log(path.dirname(&#39;/demo/js/test.js&#39;));</code></pre><h3 id="è·å–æ–‡ä»¶å-path-basename-p"><a href="#è·å–æ–‡ä»¶å-path-basename-p" class="headerlink" title="è·å–æ–‡ä»¶å path.basename(p) "></a>è·å–æ–‡ä»¶å path.basename(p) <br></h3><pre><code>// å¼•å…¥ path æ¨¡å—const path = require(&#39;path&#39;);/ è¾“å‡ºï¼štest.jsconsole.log( path.basename(&#39;/demo/js/test.js&#39;) );// è¾“å‡ºï¼štestconsole.log( path.basename(&#39;/demo/js/test/&#39;) );// è¾“å‡ºï¼štestconsole.log( path.basename(&#39;/demo/js/test&#39;) );</code></pre><h3 id="è·å–æ–‡ä»¶æ‰©å±•å-path-extname-p"><a href="#è·å–æ–‡ä»¶æ‰©å±•å-path-extname-p" class="headerlink" title="è·å–æ–‡ä»¶æ‰©å±•å path.extname(p) "></a>è·å–æ–‡ä»¶æ‰©å±•å path.extname(p) <br></h3><pre><code>// å¼•å…¥ path æ¨¡å—const path = require(&#39;path&#39;);// è¾“å‡º .jsconsole.log(path.extname(&#39;/demo/js/test.js&#39;));</code></pre><h3 id="æ‹¼æ¥æ–‡ä»¶è·¯å¾„-path-join-â€¦paths"><a href="#æ‹¼æ¥æ–‡ä»¶è·¯å¾„-path-join-â€¦paths" class="headerlink" title="æ‹¼æ¥æ–‡ä»¶è·¯å¾„ path.join([â€¦paths])"></a>æ‹¼æ¥æ–‡ä»¶è·¯å¾„ path.join([â€¦paths])<br></h3><pre><code>// å¼•å…¥ path æ¨¡å—const path = require(&#39;path&#39;);// /demo/js/test.jsconsole.log(path.join(&#39;/demo&#39;, &#39;js&#39;, &#39;test.js&#39;));</code></pre><h3 id="è·å–çš„ç»å¯¹è·¯å¾„-æ–‡ä»¶å-path-reslove-from-â€¦-to"><a href="#è·å–çš„ç»å¯¹è·¯å¾„-æ–‡ä»¶å-path-reslove-from-â€¦-to" class="headerlink" title="è·å–çš„ç»å¯¹è·¯å¾„/æ–‡ä»¶å path.reslove([from â€¦], to)"></a>è·å–çš„ç»å¯¹è·¯å¾„/æ–‡ä»¶å path.reslove([from â€¦], to)<br></h3><pre><code>// å¼•å…¥ path æ¨¡å—const path = require(&#39;path&#39;);// è¾“å‡ºå½“å‰é¡¹ç›®çš„ç»å¯¹è·¯å¾„console.log(path.reslove(&#39;&#39;));// è¾“å‡ºå½“å‰é¡¹ç›®çš„ç»å¯¹è·¯å¾„console.log(path.reslove(&#39;.&#39;));// è¾“å‡º /foo/bar/bazconsole.log( path.resolve(&#39;/foo/bar&#39;, &#39;./baz&#39;) );// è¾“å‡º /baz/fileconsole.log(path.resolve(&#39;/foo/bar&#39;, &#39;/baz/file/&#39;);)</code></pre><h3 id="è·å–è·¯å¾„å­—ç¬¦ä¸²çš„å¯¹è±¡-path-parse-p"><a href="#è·å–è·¯å¾„å­—ç¬¦ä¸²çš„å¯¹è±¡-path-parse-p" class="headerlink" title="è·å–è·¯å¾„å­—ç¬¦ä¸²çš„å¯¹è±¡ path.parse(p)"></a>è·å–è·¯å¾„å­—ç¬¦ä¸²çš„å¯¹è±¡ path.parse(p)<br></h3><pre><code>// å¼•å…¥ path æ¨¡å—const path = require(&#39;path&#39;);path.parse(&#39;/home/user/dir/file.txt&#39;);// è¿”å›:// { root: &#39;/&#39;,//   dir: &#39;/home/user/dir&#39;,//   base: &#39;file.txt&#39;,//   ext: &#39;.txt&#39;,//   name: &#39;file&#39; }</code></pre><h3 id="è·å–è§„èŒƒåŒ–è·¯å¾„-path-normalize-p"><a href="#è·å–è§„èŒƒåŒ–è·¯å¾„-path-normalize-p" class="headerlink" title="è·å–è§„èŒƒåŒ–è·¯å¾„ path.normalize(p)"></a>è·å–è§„èŒƒåŒ–è·¯å¾„ path.normalize(p)<br></h3><pre><code>// å¼•å…¥ path æ¨¡å—const path = require(&#39;path&#39;);// è¾“å‡º &#39;/foo/bar/baz/asdf&#39;path.normalize(&#39;/foo/bar//baz/asdf/quux/..&#39;);</code></pre><p><a href="https://nodejs.org/docs/latest-v9.x/api/path.html" target="_blank" rel="noopener">å…¶ä»–æ–¹æ³•è¯·å‚è€ƒ Node Api </a><br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fs æ–‡ä»¶æ“ä½œ</title>
      <link href="/2019/04/01/node/fs/"/>
      <url>/2019/04/01/node/fs/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ node ä¸­æ–‡ä»¶äº¤äº’æ˜¯éå¸¸é‡è¦çš„ï¼Œä¾‹å¦‚æ–‡ä»¶çš„æ‰“å¼€ã€è¯»å–ã€å†™å…¥æ–‡ä»¶ã€ä»¥åŠä¸å…¶äº¤äº’ç­‰ç­‰ï¼Œè¿™å…¶ä¸­å›´ç»•ç€å¼‚æ­¥æ¨¡å¼å’ŒåŒæ­¥æ¨¡å¼è¯»å–çš„è¯é¢˜ã€‚ä¸‹é¢å°± node çš„ fs æ–‡ä»¶æ“ä½œæ¨¡ä¸¾ä¾‹è¯´æ˜<br></p><h3 id="fsä½¿ç”¨ç‰¹ç‚¹"><a href="#fsä½¿ç”¨ç‰¹ç‚¹" class="headerlink" title="fsä½¿ç”¨ç‰¹ç‚¹"></a>fsä½¿ç”¨ç‰¹ç‚¹</h3><p>1ã€åŒæ­¥çš„ç‰ˆæœ¬å°†é˜»å¡æ•´ä¸ªè¿›ç¨‹ï¼Œç›´åˆ°å®ƒä»¬å®Œæˆï¼ˆåœæ­¢æ‰€æœ‰è¿æ¥ï¼‰<br><br>2ã€å¼‚æ­¥æ–‡ä»¶ç³»ç»Ÿä¸ä¼šé˜»å¡ç¨‹åºçš„æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨æ“ä½œå®Œæˆæ—¶ï¼Œé€šè¿‡å›è°ƒå‡½æ•°å°†ç»“æœè¿”å›ï¼Œä½†æ˜¯æ— æ³•ä¿è¯æ“ä½œçš„çš„æ­£ç¡®æ€§å’Œæœ‰æ•ˆçš„é¡ºåº<br></p><h3 id="æ–‡ä»¶å†™å…¥"><a href="#æ–‡ä»¶å†™å…¥" class="headerlink" title="æ–‡ä»¶å†™å…¥"></a>æ–‡ä»¶å†™å…¥<br></h3><ol><li>å¼‚æ­¥æ–‡ä»¶å†™å…¥<br></li></ol><pre><code>// å¼•å…¥ fs æ¨¡å—const fs = require(&#39;fs&#39;);/** * @description * å¼‚æ­¥æ‰“å¼€æ–‡ä»¶æ“ä½œ fs.open * å¼‚æ­¥å†™å…¥æ–‡ä»¶æ“ä½œ fs.writeFile * å¼‚æ­¥å…³é—­æ–‡ä»¶æ“ä½œ fs.close */fs.open(&#39;file.txt&#39;, &#39;a&#39;, (err, fd)=&gt;{  if (err) throw err;  fs.writeFile(fd, &quot;nodeæ˜¯å¾ˆæœ‰æ„æ€çš„è¯­è¨€ï¼&quot;, (err)=&gt;{    if (err) throw err;    console.log(&#39;å†™å…¥æ–‡ä»¶æˆåŠŸ&#39;)    fs.close(fd, (err)=&gt;{      if (err) throw err;      console.log(&#39;æ–‡ä»¶ä»¥ä¿å­˜å¹¶å…³é—­&#39;)    })  })})</code></pre><ol start="2"><li>åŒæ­¥å†™å…¥æ–¹å¼<br><pre><code>// å¼•å…¥æ¨¡å— const fs = require(&#39;fs&#39;);</code></pre></li></ol><p>// æ‰“å¼€æ–‡ä»¶ åŒæ­¥<br>var fd=fs.openSync(â€˜file.txtâ€™, â€˜wâ€™);</p><p>// å†™å…¥å†…å®¹<br>fs.writeFileSync(fd,â€nodeæ˜¯å¾ˆæœ‰æ„æ€çš„è¯­è¨€!â€); </p><p>// ä¿å­˜å¹¶å…³é—­<br>fs.closeSync(fd);</p><pre><code>### è¯»å†™æ“ä½œ&lt;br/&gt;1. æ–‡ä»¶è¯»å†™æ“ä½œ&lt;br/&gt;</code></pre><p>// å¼•å…¥æ¨¡å—<br>const fs = require(â€˜fsâ€™);</p><p>/**</p><ul><li>@description</li><li>å¼‚æ­¥è¯»å–æ–‡ä»¶ fs.readFile</li><li>/<br>fs.readFile(â€˜source/file.txtâ€™,â€™utf8â€™,(err,data)=&gt;{<br>if (err) throw err;<br>console.log(data); //data é»˜è®¤è¯»å–çš„æ˜¯äºŒè¿›åˆ¶ ä½¿ç”¨toString() æ–¹æ³•è½¬æ¢æˆ<br>})<pre><code></code></pre></li></ul><ol start="2"><li>å›¾ç‰‡è¯»å†™æ“ä½œ<br></li></ol><pre><code>// å¼•å…¥æ¨¡å—const fs = require(&#39;fs&#39;);/** * @description * å¼‚æ­¥è¯»å–æ–‡ä»¶ fs.readFile * å¼‚æ­¥å†™å…¥æ–‡ä»¶ fs.writeFile */fs.readFile(&quot;source/a.jpg&quot;,(err,data) =&gt; {  if (err) throw err;  // æ–‡ä»¶å†™å…¥  fs.writeFile(&#39;b.jpg&#39;, data, (err) =&gt; {    if (err) throw err;    console.log(&#39;å†™å…¥æˆåŠŸï¼&#39;)  })});</code></pre><ol start="3"><li>è§†é¢‘è¯»å†™æ“ä½œ<br></li></ol><pre><code>// å¼•å…¥æ¨¡å—let fs= require(&#39;fs&#39;);/** * @description * å¼‚æ­¥è¯»å–æ–‡ä»¶ fs.readFile * å¼‚æ­¥å†™å…¥æ–‡ä»¶ fs.writeFile * åˆ›å»ºæ–‡ä»¶è¯»å–æµ fs.createReadStream * åˆ›å»ºæ–‡ä»¶å†™å…¥æµ fs.createWriteStream * åˆ›å»ºç®¡é“ fileStream.pipe * fs.readFile() å‡½æ•°ä¼šç¼“å†²æ•´ä¸ªæ–‡ä»¶ã€‚  * ä¸ºäº†æœ€å°åŒ–å†…å­˜æˆæœ¬ï¼Œå°½å¯èƒ½é€šè¿‡ fs.createReadStream() è¿›è¡Œæµå¼ä¼ è¾“ã€‚ */// æ–¹å¼ä¸€fs.readFile(&#39;source/a.mp4&#39;, (err, data) =&gt; {  if (err) throw err;  // æ–‡ä»¶å†™å…¥  fs.writeFile(&#39;b.mp4&#39;, data, (err) =&gt; {    if (err) throw err;    console.log(&#39;å†™å…¥æˆåŠŸï¼&#39;);  });});// æ–¹å¼äºŒlet rs = fs.createReadStream(&#39;source/a.mp4&#39;);let ws = fs.createWriteStream(&#39;new.mp4&#39;);re.pipe(ws);</code></pre><ol start="4"><li>ä½¿ç”¨åŒæ­¥æ–‡ä»¶æµå†™å…¥æ“ä½œ<br><pre><code>// å¼•å…¥æ¨¡å—let fs= require(&#39;fs&#39;);</code></pre></li></ol><p>// å»ºç«‹é€šé“<br>let ws = fs.createWriteStream(â€˜file.txtâ€™)</p><p>// æ‰“å¼€é€šé“<br>ws.once(â€˜openâ€™, () =&gt; {<br>    console.log(â€˜é€šé“æ‰“å¼€â€™);<br>})</p><p>ws.once(â€˜closeâ€™, () =&gt; {<br>    console.log(â€˜é€šé“å…³é—­â€™);<br>})</p><p>// å†™å…¥å†…å®¹<br>ws.write(â€˜nodeå¼€å§‹â€™);<br>ws.write(â€˜node1â€™);<br>ws.write(â€˜node2â€™);<br>ws.write(â€˜nodeç»“æŸâ€™);</p><pre><code>&lt;a href=&quot;https://nodejs.org/docs/latest-v9.x/api/fs.html&quot;&gt;å…¶ä»–æ–¹æ³•è¯·å‚è€ƒ Node Api &lt;/a&gt;&lt;br/&gt;</code></pre>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>url</title>
      <link href="/2019/03/28/node/url/"/>
      <url>/2019/03/28/node/url/</url>
      
        <content type="html"><![CDATA[<p>urlæ¨¡å—æä¾›ç”¨äºURLè§£æå’Œè§£æçš„å®ç”¨ç¨‹åº<br></p><pre><code>const url = require(&#39;url&#39;);</code></pre><p>è·å–å¹¶è®¾ç½®URLçš„ç‰‡æ®µéƒ¨åˆ†<strong>url.hash</strong><br></p><pre><code>const myURL = new URL(&#39;https://example.org/foo#bar&#39;);console.log(myURL.hash); //#barmyURL.hash = &#39;baz&#39;;console.log(myURL.href); //https://example.org/foo#baz</code></pre><p>è·å–å¹¶è®¾ç½®URLçš„ä¸»æœºéƒ¨åˆ†<strong>url.host</strong><br></p><pre><code>const myURL = new URL(&#39;https://example.org:81/foo&#39;);console.log(myURL.host);  //example.org:81console.log(myURL.hostname) //example.org</code></pre><p>è·å–å¹¶è®¾ç½®åºåˆ—åŒ–url<strong>url.href</strong><br></p><pre><code>const myURL = new URL(&#39;https://example.org:81/foo&#39;);console.log(myURL.href);  //https://example.org:81/foo</code></pre><p>è·å–å¹¶è®¾ç½®URLçš„è·¯å¾„éƒ¨åˆ†<strong>url.pathname</strong><br></p><pre><code>const myURL = new URL(&#39;https://example.org:81/foo/abc?name=123&#39;);console.log(myURL.pathname);  // /foo/abc</code></pre><p>è·å–å¹¶è®¾ç½®URLçš„ç«¯å£éƒ¨åˆ†<strong>url.port  0åˆ°65535</strong><br></p><pre><code>const myURL = new URL(&#39;https://example.org:81/foo/abc?name=123&#39;);console.log(myURL.port);  // 81</code></pre><p>è·å–å¹¶è®¾ç½®URLçš„åºåˆ—åŒ–æŸ¥è¯¢éƒ¨åˆ†<strong>url.search</strong><br></p><pre><code>const myURL = new URL(&#39;https://example.org:81/foo/abc?name=123&#39;);console.log(myURL.search);  // name=123</code></pre><p>è·å–URLSearchParamsè¡¨ç¤ºURLçš„æŸ¥è¯¢å‚æ•°çš„å¯¹è±¡<strong>url.serchParams</strong><br></p><pre><code>const myURL = new URL(&#39;https://example.org:81/foo/abc?name=123&#39;);console.log(myURL.searchParams);  // 123</code></pre><p><a href="https://nodejs.org/api/url.html" target="_blank" rel="noopener">æ›´å¤šæ–¹æ³•è¯·å‚è€ƒ Node Api </a><br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tcp udp http</title>
      <link href="/2019/03/23/node/http/"/>
      <url>/2019/03/23/node/http/</url>
      
        <content type="html"><![CDATA[<h3 id="æ„å»ºTCPæœåŠ¡"><a href="#æ„å»ºTCPæœåŠ¡" class="headerlink" title="æ„å»ºTCPæœåŠ¡"></a>æ„å»ºTCPæœåŠ¡<br></h3><p> tcpå…¨åä¸ºä¼ è¾“æ§åˆ¶åè®®ï¼Œåœ¨OSIæ¨¡å‹ä¸­å±äºä¼ è¾“å±‚åè®®å¦‚ä¸‹å›¾<br><br> &lt;image src=/images/tcp.pngâ€™ width=â€300pxâ€&gt;<br></p><p> tcpæ˜¯é¢å‘è¿æ¥çš„åè®®ï¼Œç‰¹ç‚¹æ˜¯åœ¨ä¼ è¾“ä¹‹å‰éœ€è¦3æ¬¡æ¡æ‰‹å½¢æˆä¼šè¯å¦‚ä¸‹å›¾<br><br> &lt;image src=/images/ack.pngâ€™ width=â€300pxâ€&gt;<br></p><p>  ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€synåŒ…(syn=j)åˆ°æœåŠ¡å™¨ï¼Œå¹¶è¿›å…¥SYN_SENDçŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨ç¡®è®¤<br><br>  ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡å™¨æ”¶åˆ°synåŒ…ï¼Œå¿…é¡»ç¡®è®¤å®¢æˆ·çš„SYN(ack=j+1)ï¼ŒåŒæ—¶è‡ªå·±ä¹Ÿå‘é€ä¸€ä¸ªSYNåŒ…(syn=k)ï¼Œå³SYN+ACKåŒ…ï¼Œæ­¤æ—¶æœåŠ¡å™¨è¿›å…¥SYN_RECVçŠ¶æ€<br><br>  ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„SYN+ACKåŒ…ï¼Œå‘æœåŠ¡å™¨å‘é€ç¡®è®¤åŒ…ACK(ack=k+1)ï¼Œæ­¤åŒ…å‘é€å®Œæ¯•ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹<br></p><p>  å½“ç„¶tcpä¹Ÿä¼šæœ‰å››æ¬¡æŒ¥æ‰‹ï¼Œåœ¨è¿™é‡Œå°±ä¸å…·ä½“è¯´æ˜äº†<br></p><h3 id="åˆ›å»ºTCPæœåŠ¡ç«¯"><a href="#åˆ›å»ºTCPæœåŠ¡ç«¯" class="headerlink" title="åˆ›å»ºTCPæœåŠ¡ç«¯"></a>åˆ›å»ºTCPæœåŠ¡ç«¯<br></h3><p>1ã€åˆ›å»ºTCPæœåŠ¡ç«¯æ¥å—ç½‘ç»œè¯·æ±‚<br><br>1.1æœåŠ¡å™¨äº‹ä»¶<br></p><pre><code>var net = require(&#39;net&#39;);var server = net.createServer(function(socket) {  // å¼€å§‹æ–°è¿æ¥  socket.on(&#39;data&#39;, function(data) {    socket.write(&#39;hello&#39;);  })  // æ–­å¼€è¿æ¥  socket.on(&#39;end&#39;, function() {    console.log(&#39;æ–­å¼€è¿æ¥&#39;);  }) })server.listen(8124, function() {  console.log(&#39;server start listen port 8124 !&#39;);});</code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç åˆ›å»ºä¸ºæœåŠ¡å™¨äº‹ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ª<strong>EventEmitter</strong>å®ä¾‹ï¼Œè‡ªå®šä¹‰äº‹ä»¶æœ‰ä¸€ä¸‹å‡ ç§<br></p><ul><li>listening ç»‘å®šçš„ç«¯å£</li><li>connection è¿æ¥åˆ°æœåŠ¡å™¨æ—¶å‡ºå‘æ­¤äº‹ä»¶</li><li>close æœåŠ¡å™¨å…³é—­æ—¶è§¦å‘</li><li>error æœåŠ¡å™¨å‘ç”Ÿå¼‚å¸¸æ—¶è§¦å‘<br></li></ul><p>1.2è¿æ¥äº‹ä»¶<br></p><pre><code>var net = require(&#39;net&#39;);var client = net.connect({ port: 8124 }, function () {  console.log(&#39;client connected !&#39;);  client.write(&#39;hello&#39;);})client.on(&#39;data&#39;, function (data) {  conosle.log(data);  client.end();})client.on(&#39;end&#39;, function () {  console.log(&#39;æ­¤è¿æ¥ç»“æŸ&#39;);})</code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç åˆ›å»ºè¿æ¥äº‹ä»¶ï¼ŒæœåŠ¡å™¨å¯ä»¥åŒæ—¶ä¸å¤šä¸ªå®¢æˆ·ç«¯ä¿æŒè¿æ¥ï¼Œå¯¹äºæ¯ä¸ªè¿æ¥å…¶å®éƒ½æ˜¯<strong>Stream</strong>å¯¹è±¡ï¼Œå®ƒç”¨äºæœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„é€šè®¯ï¼Œè‡ªå®šä¹‰äº‹ä»¶å¦‚ä¸‹<br></p><ul><li>data å½“ä¸€ç«¯è°ƒç”¨write()å‘é€æ•°æ®æ—¶ï¼Œå¦ä¸€ç«¯ä¼šè§¦å‘dataï¼Œäº‹ä»¶ä¼ é€’çš„æ•°æ®æ˜¯write()å‘é€çš„æ•°æ®</li><li>end å½“è¿æ¥ä¸­çš„ä»»æ„ä¸€ç«¯å‘é€<strong>FIN</strong> æ•°æ®æ—¶ï¼Œè§¦å‘æ­¤äº‹ä»¶</li><li>drain å½“ä¸€ç«¯è°ƒç”¨write()å‘é€æ•°æ®æ—¶ï¼Œè§¦å‘æ­¤äº‹ä»¶</li><li>close å½“æ‰€æœ‰è¿æ¥å®Œå…¨å…³é—­æ—¶è§¦å‘</li><li>error æœåŠ¡å™¨å‘ç”Ÿå¼‚å¸¸æ—¶è§¦å‘</li><li>timeout è¿æ¥è¶…æ—¶æ—¶è§¦å‘</li></ul><p><strong>nodeä¸­ TCPé»˜è®¤å¼€å¯Nagleç®—æ³•ï¼ˆä¼˜åŒ–ç½‘ç»œæ•°æ®åŒ…ï¼‰æ­¤ç®—æ³•ç”±äºè¦æ±‚ç¼“å†²æ•°æ®è¾¾åˆ°ä¸€å®šæ•°é‡æˆ–ä¸€å®šæ—¶é—´åæ‰å‘é€ï¼Œæ‰€ä»¥å¯èƒ½ä¼šé€ æˆå»¶è¿Ÿå‘é€</strong></p><h3 id="æ„å»ºUDPæœåŠ¡"><a href="#æ„å»ºUDPæœåŠ¡" class="headerlink" title="æ„å»ºUDPæœåŠ¡"></a>æ„å»ºUDPæœåŠ¡<br></h3><p>UDPç”¨æˆ·æ•°æ®åŒ…åè®®ï¼Œå’ŒTCPä¸€æ ·å±äºç½‘ç»œä¼ è¾“å±‚<br></p><h3 id="åˆ›å»ºUDPæœåŠ¡ç«¯"><a href="#åˆ›å»ºUDPæœåŠ¡ç«¯" class="headerlink" title="åˆ›å»ºUDPæœåŠ¡ç«¯"></a>åˆ›å»ºUDPæœåŠ¡ç«¯<br></h3><pre><code>var dgram = require(&#39;dgram&#39;);// åˆ›å»ºserverå¯¹è±¡var server  = dgram.createSocket(&#39;udp4&#39;);// æ¥åˆ°æ¶ˆæ¯æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶ï¼Œæºå¸¦çš„æ•°æ®ä¸ºæ¶ˆæ¯bufferå’Œè¿œç¨‹åœ°å€ä¿¡æ¯å¯¹è±¡server.on(&#39;message&#39; function (msg, rinfo) {  console.log(msg)  console.log(rinfo)});// ç»‘å®šç«¯å£ä¹‹åå¯åŠ¨ç›‘å¬æ—¶é—´server.on(&#39;listening&#39;, function () {  var address = server.address();  console.log(address);});// ç»‘å®šç«¯å£server.bind(41234);</code></pre><h3 id="åˆ›å»ºUDPå®¢æˆ·ç«¯"><a href="#åˆ›å»ºUDPå®¢æˆ·ç«¯" class="headerlink" title="åˆ›å»ºUDPå®¢æˆ·ç«¯"></a>åˆ›å»ºUDPå®¢æˆ·ç«¯<br></h3><pre><code>var dgram = require(&#39;dgram&#39;);var message = new Buffer(&#39;hello&#39;);var client = dgram.createSocket(&#39;udp4&#39;);client.send(message, 0, message.length, 41234, &#39;localhost&#39;, function (err, bytes) {  client.close();})</code></pre><h3 id="æ„å»ºHTTPæœåŠ¡"><a href="#æ„å»ºHTTPæœåŠ¡" class="headerlink" title="æ„å»ºHTTPæœåŠ¡"></a>æ„å»ºHTTPæœåŠ¡<br></h3><p>HTTPæ˜¯è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œæ˜¯æ„å»ºåœ¨TCPä¹‹ä¸Šçš„ï¼Œå±äºåº”ç”¨å±‚åè®®ï¼Œåœ¨HTTPçš„ä¸¤ç«¯æ˜¯æœåŠ¡ç«¯å’Œæµè§ˆå™¨ä¹Ÿå°±æ˜¯B/Sæ¨¡å¼<br></p><h3 id="HTTPæŠ¥æ–‡"><a href="#HTTPæŠ¥æ–‡" class="headerlink" title="HTTPæŠ¥æ–‡"></a>HTTPæŠ¥æ–‡<br></h3><p>æˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œåˆ©ç”¨curl -v <a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a> æ¥æ¨¡æ‹Ÿè¯·æ±‚ï¼Œäº§ç”Ÿå¦‚ä¸‹æŠ¥æ–‡ä¿¡æ¯<br></p><p>ç¬¬ä¸€éƒ¨åˆ†å…¶å®å°±æ˜¯æ ‡å‡†çš„TCP3æ¬¡æ¡æ‰‹è¿‡ç¨‹<br></p><pre><code>* About to connect() to localhost (127.0.0.1) port 8080 (#0)*   Trying 127.0.0.1...* TCP_NODELAY set* Connected to localhost (127.0.0.1) port 8080 (#0)</code></pre><p>ç¬¬äºŒéƒ¨åˆ†åœ¨æ¡æ‰‹å®Œæˆä¹‹åï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€çš„è¯·æ±‚æŠ¥æ–‡<br></p><pre><code>&gt; GET / HTTP/1.1&gt; Host: 127.0.0.1:8080&gt; User-Agent: curl/7.54.0&gt; Accept: */*&gt;</code></pre><p>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯æœåŠ¡ç«¯å¤„ç†ç»“æŸåï¼Œå‘å®¢æˆ·ç«¯å‘é€çš„å“åº”å†…å®¹åŒ…æ‹¬å“åº”å¤´å’Œå“åº”ä½“<br></p><pre><code>&lt; HTTP/1.1 200 OK&lt; X-Powered-By: Express&lt; Accept-Ranges: bytes&lt; Content-Type: text/html; charset=UTF-8&lt; Content-Length: 820&lt; ETag: W/&quot;334-dKswJvgc24O5QPXd939SLJD+BhM&quot;&lt; Date: Thu, 11 Apr 2019 10:33:03 GMT&lt; Connection: keep-alive&lt;hello</code></pre><p>ç¬¬å››éƒ¨åˆ†æ˜¯ç»“æŸæ­¤ä¼šè¯<br></p><pre><code>* Connection #0 to host 127.0.0.1 left intact* Closing connection #0</code></pre><p>é€šè¿‡ä¸Šé¢çš„ä¿¡æ¯ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè™½ç„¶æ˜¯åŸºäº TCPï¼Œä½†æ˜¯æœ¬èº«ç¡®å®åŸºäºè¯·æ±‚å“åº”å¼çš„ï¼Œä¸€é—®ä¸€ç­”æ¨¡å¼å¹¶ä¸æ˜¯ä¼šè¯æ¨¡å¼ã€‚<br></p><h3 id="HTTPæ¨¡å—"><a href="#HTTPæ¨¡å—" class="headerlink" title="HTTPæ¨¡å—"></a>HTTPæ¨¡å—<br></h3><p>node http æ¨¡å—æ‰¿ç»§ tcp æœåŠ¡å™¨ï¼ˆ net æ¨¡å—ï¼‰å®ƒèƒ½å¤Ÿä¸å¤šä¸ªå®¢æˆ·ç«¯ä¿æŒè¿æ¥ï¼Œé‡‡ç”¨äº‹ä»¶é©±åŠ¨ï¼Œä¸ä¼šä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºé¢å¤–çš„çº¿ç¨‹æˆ–è¿›ç¨‹ã€‚å ç”¨å†…å­˜ä½ï¼Œæ‰€ä»¥èƒ½å®ç°é«˜å¹¶å‘ï¼Œtcp æœåŠ¡ä»¥connectionè¿›è¡ŒæœåŠ¡ï¼Œhttpä»¥requestè¿›è¡ŒæœåŠ¡ã€‚node http æ¨¡å—å°†connectionå’Œrequestè¿›è¡Œå°è£…<br><br>&lt;image src=/images/request.pngâ€™ width=â€400pxâ€&gt;<br></p><p>httpæ¨¡å—å°†æ‰€æœ‰è¯»å†™æŠ½è±¡ä¸ºServerRequestå’ŒServerResponseå¯¹è±¡<br><br>&lt;image src=/images/http.pngâ€™ width=â€400pxâ€&gt;<br></p><pre><code>function (req, res) {  res.writeHead(200, {&#39;Content-Type&#39; : &#39;text/plain&#39;});  res.end(&#39;Hello Word&#39;);}</code></pre><h3 id="HTTPä»£ç†"><a href="#HTTPä»£ç†" class="headerlink" title="HTTPä»£ç†"></a>HTTPä»£ç†<br></h3><p>http æä¾›çš„ ClientRequest æ˜¯åŸºäº tcp å±‚å®ç°çš„ï¼Œåœ¨keepaliveæƒ…å†µä¸‹ï¼Œä¸€ä¸ªåº•å±‚ä¼šè¯èƒ½å¤Ÿè¿æ¥å¤šä¸ªè¯·æ±‚ã€‚<br><br>http æ¨¡å—åŒ…å«ä¸€ä¸ªé»˜è®¤çš„å®¢æˆ·ç«¯ä»£ç†å¯¹è±¡http.globalAgent<br><br>é€šè¿‡ ClientRequest å¯¹è±¡å¯¹ç”¨ä¸€ä¸ªæœåŠ¡å™¨å‘èµ·çš„ http æœ€å¤šå¯ä»¥åˆ›å»º5ä¸ªè¿æ¥ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªè¿æ¥æ± ã€‚å¦‚æœ http å®¢æˆ·ç«¯åŒæ—¶å¯¹ä¸€ä¸ªæœåŠ¡å™¨å‘èµ·è¶…è¿‡5ä¸ªè¯·æ±‚ï¼Œå…¶å®ä¹Ÿåªæœ‰5ä¸ªå¤„äºå¹¶å‘çŠ¶æ€ã€‚<br><br>&lt;image src=/images/httpä»£ç†.pngâ€™ width=â€400pxâ€&gt;<br></p><pre><code>// å¯ä»¥é€šè¿‡http.Agentä¿®æ”¹è¿æ¥æ•°é‡ï¼Œä½†è¿æ¥æ•°é‡è¿‡å¤§ä¼šå½±å“æœåŠ¡å™¨æ€§èƒ½var agent = new http.Agent({  maxSockets: 10})var option = {  hostname: &#39;127.0.0.1&#39;,  port: 1334,  path: &#39;/&#39;,  method: &#39;GET&#39;,  agent: agent}</code></pre><h3 id="æ„å»º-WebSocket-æœåŠ¡"><a href="#æ„å»º-WebSocket-æœåŠ¡" class="headerlink" title="æ„å»º WebSocket æœåŠ¡"></a>æ„å»º WebSocket æœåŠ¡<br></h3><p>Websocket åè®®è§£å†³äº†æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯å…¨åŒå·¥é€šä¿¡çš„é—®é¢˜,ä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„é•¿è¿æ¥<br></p><h3 id="WebSocketåè®®è§£æ"><a href="#WebSocketåè®®è§£æ" class="headerlink" title="WebSocketåè®®è§£æ"></a>WebSocketåè®®è§£æ<br></h3><p>WebSocketåè®®ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ç¬¬ä¸€éƒ¨åˆ† http <strong>æ¡æ‰‹</strong>è¿æ¥ï¼Œç¬¬äºŒéƒ¨åˆ†åè®®å‡çº§ä¸º WebSocket è¿›è¡Œ<strong>æ•°æ®ä¼ è¾“</strong><br><br>&lt;image src=/images/websocket.pngâ€™ width=â€400pxâ€&gt;<br></p><h3 id="TCP-UDP-HTTP-WebSocketåŒºåˆ«"><a href="#TCP-UDP-HTTP-WebSocketåŒºåˆ«" class="headerlink" title="TCP UDP HTTP WebSocketåŒºåˆ«"></a>TCP UDP HTTP WebSocketåŒºåˆ«</h3><ol><li>TCP UDP HTTP WebSocketéƒ½æ˜¯åè®®ï¼Œè€ŒTCP/IPæ˜¯ä¸åŒåè®®çš„ç»„åˆ <br></li><li>Socketçš„æœ¬è´¨æ˜¯APIï¼Œåªä¸è¿‡æ˜¯å¯¹TCP/IPåè®®æ—çš„æŠ½è±¡æˆ–è€…è¯´å°è£…<br></li><li>ä»åˆ†å±‚ä¸Šæ¥åŒºåˆ†ï¼ŒHTTPï¼ŒWebSocketæ˜¯åº”ç”¨å±‚åè®®ï¼ŒTCPï¼ŒUDPæ˜¯ä¼ è¾“å±‚åè®®ï¼ŒIPæ˜¯ç½‘ç»œå±‚åè®®<br></li></ol><p><strong>1.TCPå’ŒUDP</strong><br></p><p>TCPæ˜¯é¢å‘è¿æ¥çš„ä¼ è¾“æ§åˆ¶åè®®ã€‚TCPè¿æ¥ä¹‹åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥äº’ç›¸å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œåœ¨å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨æ²¡æœ‰ä¸»åŠ¨æ–­å¼€ä¹‹å‰ï¼Œè¿æ¥ä¸€ç›´å­˜åœ¨ï¼Œæ•…ç§°ä¸ºé•¿è¿æ¥ã€‚ç‰¹ç‚¹ï¼šè¿æ¥æœ‰è€—æ—¶ï¼Œä¼ è¾“æ•°æ®æ— å¤§å°é™åˆ¶ï¼Œå‡†ç¡®å¯é ï¼Œå…ˆå‘å…ˆè‡³<br><br>UDPæ˜¯æ— è¿æ¥çš„ç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼Œæ‰€è°“çš„æ— è¿æ¥å°±æ˜¯åœ¨ä¼ è¾“æ•°æ®ä¹‹å‰ä¸éœ€è¦äº¤æ¢ä¿¡æ¯ï¼Œæ²¡æœ‰æ¡æ‰‹å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œåªéœ€è¦ç›´æ¥å°†å¯¹åº”çš„æ•°æ®å‘é€åˆ°æŒ‡å®šçš„åœ°å€å’Œç«¯å£å°±è¡Œã€‚æ•…UDPçš„ç‰¹ç‚¹æ˜¯ä¸ç¨³å®šï¼Œé€Ÿåº¦å¿«ï¼Œå¯å¹¿æ’­ï¼Œä¸€èˆ¬æ•°æ®åŒ…é™å®š64KBä¹‹å†…ï¼Œå…ˆå‘æœªå¿…å…ˆè‡³<br></p><p><strong>2.HTTP</strong><br></p><p>HTTPæ˜¯åŸºäºTCPåè®®çš„åº”ç”¨ï¼Œè¯·æ±‚æ—¶éœ€å»ºç«‹TCPè¿æ¥ï¼Œè€Œä¸”è¯·æ±‚åŒ…ä¸­éœ€è¦åŒ…å«è¯·æ±‚æ–¹æ³•ï¼ŒURIï¼Œåè®®ç‰ˆæœ¬ç­‰ä¿¡æ¯ï¼Œè¯·æ±‚ç»“æŸåæ–­å¼€è¿æ¥ï¼Œå®Œæˆä¸€æ¬¡è¯·æ±‚/å“åº”æ“ä½œã€‚æ•…ç§°ä¸ºçŸ­è¿æ¥ã€‚<br>è€ŒHTTP/1.1ä¸­çš„keep-aliveæ‰€ä¿æŒçš„é•¿è¿æ¥åˆ™æ˜¯ä¸ºäº†ä¼˜åŒ–æ¯æ¬¡HTTPè¯·æ±‚ä¸­TCPè¿æ¥ä¸‰æ¬¡æ¡æ‰‹çš„éº»çƒ¦å’Œèµ„æºå¼€é”€ï¼Œåªå»ºç«‹ä¸€æ¬¡TCPè¿æ¥ï¼Œå¤šæ¬¡çš„åœ¨è¿™ä¸ªé€šé“ä¸Šå®Œæˆè¯·æ±‚/å“åº”æ“ä½œ<br></p><p><strong>3.WebSocket</strong><br></p><p>WebSocketä¹Ÿæ˜¯ä¸€ç§åè®®ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯åŸºäºTCPåè®®çš„ã€‚å…·ä½“æµç¨‹æ˜¯WebSocketé€šè¿‡HTTPå…ˆå‘é€ä¸€ä¸ªæ ‡è®°äº† Upgrade çš„è¯·æ±‚ï¼ŒæœåŠ¡ç«¯è§£æåå¼€å§‹å»ºç«‹TCPè¿æ¥ï¼Œçœå»äº†HTTPæ¯æ¬¡è¯·æ±‚éƒ½è¦ä¸Šä¼ headerçš„å†—ä½™ï¼Œå¯ä»¥ç†è§£ä¸ºWebSocketæ˜¯HTTPçš„ä¼˜åŒ–<br></p><p><strong>4.HTTPã€WebSocketä¸TCPçš„å…³ç³»</strong><br></p><p>HTTPé€šä¿¡è¿‡ç¨‹æ˜¯å®¢æˆ·ç«¯ä¸å‘è¯·æ±‚åˆ™æœåŠ¡å™¨æ°¸è¿œæ— æ³•å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œè€ŒWebSocketåˆ™åœ¨è¿›è¡Œç¬¬ä¸€æ¬¡HTTPè¯·æ±‚ä¹‹åï¼Œå…¶ä»–å…¨éƒ¨é‡‡ç”¨TCPé€šé“è¿›è¡ŒåŒå‘é€šè®¯<br><br>HTTPå’ŒWebSocketè™½éƒ½æ˜¯åŸºäºTCPåè®®<br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ“ä½œæ•°ç»„APIæ–¹æ³•</title>
      <link href="/2019/03/20/javascript/api/"/>
      <url>/2019/03/20/javascript/api/</url>
      
        <content type="html"><![CDATA[<h3 id="Arrayå¯¹è±¡çš„ä½œç”¨"><a href="#Arrayå¯¹è±¡çš„ä½œç”¨" class="headerlink" title="Arrayå¯¹è±¡çš„ä½œç”¨"></a>Arrayå¯¹è±¡çš„ä½œç”¨</h3><p>Array å¯¹è±¡ç”¨äºåœ¨å•ä¸ªçš„å˜é‡ä¸­å­˜å‚¨å¤šä¸ªå€¼</p><h3 id="åˆ›å»ºArrayå¯¹è±¡çš„æ–¹æ³•"><a href="#åˆ›å»ºArrayå¯¹è±¡çš„æ–¹æ³•" class="headerlink" title="åˆ›å»ºArrayå¯¹è±¡çš„æ–¹æ³•"></a>åˆ›å»ºArrayå¯¹è±¡çš„æ–¹æ³•</h3><p><code>var arrayObj = new Array()ï¼›</code><br><br><code>var arrayObj = []; //æœ¬äººä¹ æƒ¯ç”¨è¿™ç§</code><br><br>è¿”å›å€¼ï¼šè¿”å›æ–°åˆ›å»ºå¹¶è¢«åˆå§‹åŒ–äº†çš„æ•°ç»„ã€‚å¦‚æœè°ƒç”¨arrayObjæ—¶æ²¡æœ‰å‚æ•°æˆ–è€…æ²¡æœ‰æŒ‡å®š å€¼ï¼Œé‚£ä¹ˆè¿”å›çš„å€¼ä¸ºç©ºï¼Œæ•°ç»„çš„lengthä¸º0ã€‚<br></p><h3 id="Arrayå¯¹è±¡çš„ä¸‰ä¸ªå±æ€§"><a href="#Arrayå¯¹è±¡çš„ä¸‰ä¸ªå±æ€§" class="headerlink" title="Arrayå¯¹è±¡çš„ä¸‰ä¸ªå±æ€§"></a>Arrayå¯¹è±¡çš„ä¸‰ä¸ªå±æ€§</h3><p><code>constructor</code> //è¿”å›æ•°ç»„å‡½æ•°çš„å¼•ç”¨ã€‚<br><br><code>length</code> //è¿”å›æ•°ç»„å…ƒç´ çš„é•¿åº¦ï¼ˆæœ€å¸¸ç”¨ï¼‰<br><br><code>prototype</code> //å¯ä»¥å‘æ•°ç»„å¯¹è±¡æ·»åŠ å±æ€§å’Œæ–¹æ³•ã€‚<br></p><h3 id="concat"><a href="#concat" class="headerlink" title="concat()"></a>concat()</h3><p>è¯¥æ–¹æ³•ç”¨äºè¿æ¥æˆ–è€…åˆå¹¶æ•°ç»„ï¼Œå¹¶ä¸”ä¸ä¼šæ”¹å˜åŸæ•°ç»„ï¼Œè¿”å›ä¸€ä¸ªæ–°æ•°ç»„çš„å‰¯æœ¬</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arrObj1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arrObj<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arrObj1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,2,3,4,5,6,7,8]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="join"><a href="#join" class="headerlink" title="join()"></a>join()</h3><p>è¯¥æ–¹æ³•ç”¨äºæŠŠæ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ ç”¨æŒ‡å®šçš„åˆ†éš”ç¬¦åˆ†å‰²ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</p><pre class="line-numbers language-js"><code class="language-js">newArray<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//"1,2,3,4,5,6,7,8"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="pop"><a href="#pop" class="headerlink" title="pop()"></a>pop()</h3><p>è¯¥æ–¹æ³•ç”¨äºåˆ é™¤å¹¶è¿”å›æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ ,å¹¶å°†åŸæ•°ç»„çš„length -1</p><pre><code>arrObj.pop()//4console.log(arrObj); //[1,2,3]</code></pre><h3 id="push"><a href="#push" class="headerlink" title="push()"></a>push()</h3><p>è¯¥æ–¹æ³•å¯å‘æ•°ç»„çš„æœ«å°¾æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›æ–°çš„é•¿åº¦</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrObj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,2,3,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="shift"><a href="#shift" class="headerlink" title="shift()"></a>shift()</h3><p>è¯¥æ–¹æ³•ç”¨äºåˆ é™¤å¹¶è¿”å›æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ,å¹¶å°†åŸæ•°ç»„çš„length -1</p><pre><code>arrObj.shift() //1console.log(arrObj) //[2,3,4]</code></pre><h3 id="unshift"><a href="#unshift" class="headerlink" title="unshift()"></a>unshift()</h3><p>è¯¥æ–¹æ³•å¯å‘æ•°ç»„çš„å¼€å¤´æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›æ–°çš„é•¿åº¦</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrObj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,2,3,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="slice"><a href="#slice" class="headerlink" title="slice()"></a>slice()</h3><p>è¯¥æ–¹æ³•å¯ä»å·²æœ‰çš„æ•°ç»„ä¸­è¿”å›é€‰å®šçš„å…ƒç´ ,å½¢æˆä¸€ä¸ªæ–°çš„æ•°ç»„</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[2]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrObj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//[1,2,3,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="splice"><a href="#splice" class="headerlink" title="splice()"></a>splice()</h3><p>è¯¥æ³•å‘æ•°ç»„ä¸­æ·»åŠ /åˆ é™¤å…ƒç´ ï¼Œç„¶åè¿”å›è¢«åˆ é™¤çš„å…ƒç´ ã€‚è¯¥æ–¹æ³•ä¼šæ”¹å˜åŸæ•°ç»„</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[2,3]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrObj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,5,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="reverse"><a href="#reverse" class="headerlink" title="reverse()"></a>reverse()</h3><p>è¯¥æ–¹æ³•ç”¨äºé¢ å€’æ•°ç»„ä¸­å…ƒç´ çš„é¡ºåºï¼Œå¹¶ä¸”æ”¹å˜åŸæ¥çš„æ•°ç»„ï¼Œè€Œä¸ä¼šåˆ›å»ºæ–°çš„æ•°ç»„</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[4,5,1]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="sort"><a href="#sort" class="headerlink" title="sort()"></a>sort()</h3><p>è¯¥æ–¹æ³•ç”¨äºå¯¹æ•°ç»„çš„å…ƒç´ è¿›è¡Œæ’åº</p><p>æ³¨æ„ï¼šè¯¥æ–¹æ³•æ˜¯æŒ‰ç…§å­—ç¬¦ç¼–ç é¡ºåºè¿›è¡Œæ’åºï¼Œå¦‚æœæƒ³è¦å®ç°ä¸šåŠ¡é€»è¾‘æ’åºéœ€è¦è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrObjSort <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arrObjSort1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arrObjSort<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,2,3,4,5]</span>arrObjSort1<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1, 10, 2, 20, 3, 30, 4, 5, 50]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è‡ªå®šä¹‰æ’åº</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">__sortNumber</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token keyword">return</span> a<span class="token operator">-</span>b<span class="token punctuation">;</span><span class="token punctuation">}</span>arrObjSort1<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>__sortNumber<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1, 2, 3, 4, 5, 10, 20, 30, 50]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString()"></a>toString()</h3><p>è¯¥æ–¹æ³•å¯æŠŠæ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›ç»“æœï¼Œä¸ä¸å¸¦å‚æ•°çš„joinç›¸åŒ</p><pre class="line-numbers language-js"><code class="language-js">arrObjSort1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//"1,2,3,4,5,10,20,30,50"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>toLocaleString-è¯¥æ–¹æ³•å¯æ•°ç»„è½¬æ¢ä¸ºæœ¬åœ°å­—ç¬¦ä¸²ã€‚å’ŒtoStringåŸºæœ¬ç›¸åŒï¼Œä½†toLocaleStringè°ƒç”¨çš„æ˜¯åœ°åŒºç‰¹å®šçš„åˆ†éš”ç¬¦æŠŠç”Ÿæˆçš„å­—ç¬¦ä¸²è¿æ¥èµ·æ¥ã€‚<br></p><p>å¦‚æœä½ å¼€å‘çš„è„šæœ¬åœ¨ä¸–ç•ŒèŒƒå›´éƒ½æœ‰äººä½¿ç”¨,é‚£ä¹ˆå°†å¯¹è±¡è½¬æ¢æˆå­—ç¬¦ä¸²æ—¶è¯·ä½¿ç”¨toString()æ–¹æ³•<br></p><p>å› ä¸ºLocaleString()ä¼šæ ¹æ®ä½ æœºå™¨çš„æœ¬åœ°ç¯å¢ƒæ¥è¿”å›å­—ç¬¦ä¸²,å®ƒå’ŒtoString()è¿”å›çš„å€¼åœ¨ä¸åŒçš„æœ¬åœ°ç¯å¢ƒä¸‹ä½¿ç”¨çš„ç¬¦å·ä¼šæœ‰å¾®å¦™çš„å˜åŒ–<br></p><p>å¦‚æœæ˜¯ä¸ºäº†è¿”å›æ—¶é—´ç±»å‹çš„æ•°æ®,æ¨èä½¿ç”¨LocaleString().è‹¥æ˜¯åœ¨åå°å¤„ç†å­—ç¬¦ä¸²,è¯·åŠ¡å¿…ä½¿ç”¨toString()<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> myArr <span class="token operator">=</span> <span class="token punctuation">[</span>date<span class="token punctuation">,</span><span class="token string">'go home'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>myArr<span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//"2017/11/7 ä¸‹åˆ4:35:43,go home"</span>myArr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//"Tue Nov 07 2017 16:36:25 GMT+0800 (CST),go home"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="indexOf"><a href="#indexOf" class="headerlink" title="indexOf()"></a>indexOf()</h3><p>è¯¥æ–¹æ³•å¯ç¡®å®šæŸä¸ªå…ƒç´ åœ¨æ•°ç»„å®ä¾‹ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ä½ç½®ã€‚å¦‚æœæ²¡æ‰¾åˆ°è¿”å›-1,å¯ç”¨ç´¢å¼•å€¼è¿›è¡Œé€»è¾‘åˆ¤æ–­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//1</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//-1</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//-1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥æ‰¾å…ƒç´ å‡ºç°çš„ä½ç½®ç´¢å¼•<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>  index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨æ•°ç»„é‡Œï¼Œä¸åœ¨åˆ™å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ <br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">__upDataCollection</span><span class="token punctuation">(</span>arrCollection<span class="token punctuation">,</span>indicesEle<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> matchIndex <span class="token operator">=</span>  arrCollection<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>indicesEle<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>matchIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>indicesEle<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'å…ƒç´ ä¸­å­˜åœ¨ç›¸åŒçš„å€¼'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">__upDataCollection</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1, 2, 3, 4, 5, 6, 7, 8]</span><span class="token function">__upDataCollection</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//'å…ƒç´ ä¸­å­˜åœ¨ç›¸åŒçš„å€¼'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="forEach"><a href="#forEach" class="headerlink" title="forEach()"></a>forEach()</h3><p>è¯¥æ–¹æ³•æŒ‰å‡åºä¸ºæ•°ç»„ä¸­å«æœ‰æ•ˆå€¼çš„æ¯ä¸€é¡¹æ‰§è¡Œä¸€æ¬¡callback å‡½æ•°ï¼ˆéå†æ•°ç»„ï¼‰</p><p><code>forEach()</code> ä¸ºæ¯ä¸ªæ•°ç»„å…ƒç´ æ‰§è¡Œcallbackå‡½æ•°ï¼›ä¸åƒ<code>map()</code> æˆ–è€…<code>reduce()</code> ï¼Œå®ƒæ€»æ˜¯è¿”å› <code>undefined</code>å€¼ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•ç»ˆæ­¢æˆ–è·³å‡ºæ­£åœ¨è¿è¡Œå¾ªç¯çš„<code>forEach</code>ã€‚å¦‚æœå¸¸è§„çš„éå†æƒ³è¦æ£€æµ‹æ¡ä»¶è¿”å›bool , å¹¶ä¸”å¯ä»¥ç»ˆæ­¢å¾ªç¯ï¼Œå¯ä½¿ç”¨<code>Array.some,Ayyay.every</code>.æˆ–è€…es6æ–°æ–¹æ³•<code>Array.find()</code>ç­‰ç­‰</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arrayObj<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> index<span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">{</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"value["</span> <span class="token operator">+</span> index <span class="token operator">+</span> <span class="token string">"] = "</span> <span class="token operator">+</span> element<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//value[0] = 1</span><span class="token comment" spellcheck="true">//value[1] = 2</span><span class="token comment" spellcheck="true">//value[2] = 3</span><span class="token comment" spellcheck="true">//value[4] = 5</span><span class="token comment" spellcheck="true">//å¯ä»¥è§‚å¯Ÿåˆ°ä»¥ä¸Šéå†å¹¶æ²¡æœ‰å‡ºç°undefind</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="map"><a href="#map" class="headerlink" title="map()"></a>map()</h3><p>è¯¥æ–¹æ³•ä¼šç»™åŸæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æŒ‰é¡ºåºè°ƒç”¨ä¸€æ¬¡ callback å‡½æ•°ã€‚callback æ¯æ¬¡æ‰§è¡Œåçš„è¿”å›å€¼ï¼ˆåŒ…æ‹¬ undefinedï¼‰ç»„åˆèµ·æ¥å½¢æˆä¸€ä¸ªæ–°æ•°ç»„ï¼Œå¹¶ä¸”ä¸ä¿®æ”¹è°ƒç”¨å®ƒçš„åŸæ•°ç»„æœ¬èº«ï¼ˆå½“ç„¶å¯ä»¥åœ¨ callback æ‰§è¡Œæ—¶æ”¹å˜åŸæ•°ç»„ï¼‰</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//å¸¸ç”¨çš„æœ‰äº›ä¸šåŠ¡åœºæ™¯éœ€è¦é‡æ–°é‡ç»„æ•°ç»„å¯¹è±¡</span><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'wangwu'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">26</span><span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> newArrayObj <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> index<span class="token punctuation">,</span> array<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   newObj<span class="token punctuation">[</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">.</span>age<span class="token punctuation">;</span>   <span class="token keyword">return</span> newObj<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArrayObj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[{'zhangsan':20},{'lisi':30},{'wangwu':26}]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="filter"><a href="#filter" class="headerlink" title="filter()"></a>filter()</h3><p>è¯¥æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„,é€šè¿‡æ¬¡å‡½æ•°æ–¹æ³•ä¼šè¿”å›ç›¸åº”çš„è¿‡æ»¤åçš„æ•°æ®,å¹¶ä¸”ä¸ä¼šæ”¹å˜åŸæ•°ç»„</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> newArrayObj <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>index<span class="token punctuation">,</span>array<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token keyword">return</span> value <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArrayObj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[4, 5, 6]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce()"></a>reduce()</h3><p>ä¸ºæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ä¾æ¬¡æ‰§è¡Œcallbackå‡½æ•°ï¼Œä¸åŒ…æ‹¬æ•°ç»„ä¸­è¢«åˆ é™¤æˆ–ä»æœªè¢«èµ‹å€¼çš„å…ƒç´ ,è¿”å›å‡½æ•°ç´¯è®¡å¤„ç†çš„ç»“æœ</p><p><code>callback</code>æ‰§è¡Œæ•°ç»„ä¸­æ¯ä¸ªå€¼çš„å‡½æ•°ï¼ŒåŒ…å«å››ä¸ªå‚æ•°ï¼š<br></p><p><code>accumulator</code>ç´¯åŠ å™¨ç´¯åŠ å›è°ƒçš„è¿”å›å€¼; å®ƒæ˜¯ä¸Šä¸€æ¬¡è°ƒç”¨å›è°ƒæ—¶è¿”å›çš„ç´¯ç§¯å€¼ï¼Œæˆ–initialValueï¼ˆå¦‚ä¸‹æ‰€ç¤ºï¼‰ã€‚<br></p><p><code>currentValue</code>æ•°ç»„ä¸­æ­£åœ¨å¤„ç†çš„å…ƒç´ ã€‚<br></p><p><code>currentIndex</code>æ•°ç»„ä¸­æ­£åœ¨å¤„ç†çš„å½“å‰å…ƒç´ çš„ç´¢å¼•ã€‚<br></p><p>å¦‚æœæä¾›äº†initialValueï¼Œåˆ™ç´¢å¼•å·ä¸º0ï¼Œå¦åˆ™ä¸ºç´¢å¼•ä¸º1ã€‚arrayè°ƒç”¨reduceçš„æ•°ç»„initialValue[å¯é€‰] ç”¨ä½œç¬¬ä¸€ä¸ªè°ƒç”¨ callbackçš„ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼ã€‚<br></p><p>å¦‚æœæ²¡æœ‰æä¾›åˆå§‹å€¼ï¼Œåˆ™å°†ä½¿ç”¨æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚ åœ¨æ²¡æœ‰åˆå§‹å€¼çš„ç©ºæ•°ç»„ä¸Šè°ƒç”¨ reduce å°†æŠ¥é”™ã€‚<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> totalValue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>sum<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> sum <span class="token operator">+</span> value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// totalValue  6</span><span class="token comment" spellcheck="true">//å°†äºŒç»´æ•°ç»„è½¬åŒ–ä¸ºä¸€ç»´æ•°ç»„</span><span class="token keyword">var</span> flattened <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>    <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// flattened is [0, 1, 2, 3, 4, 5] </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="some"><a href="#some" class="headerlink" title="some()"></a>some()</h3><p>è¯¥æ–¹æ³•ç”¨äºæ£€æµ‹æ•°ç»„ä¸­çš„æŸäº›å…ƒç´ æ˜¯å¦é€šè¿‡callbackå‡½æ•°å®ç°çš„æ–¹æ³•ã€‚è¿”å›boolå€¼</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> flag <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>index<span class="token punctuation">,</span>array<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> element <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="every"><a href="#every" class="headerlink" title="every()"></a>every()</h3><p>è¯¥æ–¹æ³•ç”¨äºæ£€æµ‹æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ æ˜¯å¦é€šè¿‡callbackå‡½æ•°å®ç°çš„æ–¹æ³•ã€‚è¿”å›boolå€¼</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> flag <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>index<span class="token punctuation">,</span>array<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> element <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ‰©å±•è¿ç®—ç¬¦-â€¦"><a href="#æ‰©å±•è¿ç®—ç¬¦-â€¦" class="headerlink" title="æ‰©å±•è¿ç®—ç¬¦(â€¦)"></a>æ‰©å±•è¿ç®—ç¬¦(â€¦)</h3><p>è¯¥è¿ç®—ç¬¦å°†ä¸€ä¸ªæ•°ç»„è½¬ä¸ºç”¨é€—å·åˆ†éš”çš„å‚æ•°åºåˆ—</p><p>æ‰©å±•è¿ç®—ç¬¦å³å¯ä»¥å¤åˆ¶ï¼Œåˆå¹¶æ•°ç»„ï¼Œæ“ä½œåˆ†å‰²å­—ç¬¦ä¸²ä¸ç»“æ„èµ‹å€¼ç»“åˆè¿˜å¯ä»¥å½“å‡½æ•°çš„å½¢å‚<br></p><pre class="line-numbers language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//1 2 3 4 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆå¹¶æ•°ç»„ï¼š<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> arrayObj1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> newArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arrayObj<span class="token punctuation">,</span><span class="token operator">...</span>arrayObj1<span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArray<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//[1, 2, 3, 4, 5, 6, 7, 8, 9]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å¤åˆ¶æ•°ç»„ï¼š<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> arrayObjNew <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arrayObj<span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrayObjNew<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//[1,2,3,4,5];</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸ç»“æ„èµ‹å€¼ç»“åˆï¼š<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>variable<span class="token punctuation">,</span> <span class="token operator">...</span>array<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>variable<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[2,3,4,5]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å‡½æ•°å½¢å‚ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//ä¾‹å­1:</span><span class="token keyword">let</span> _arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> _arrayObj1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> __operationArr <span class="token operator">=</span> <span class="token punctuation">(</span>array<span class="token punctuation">,</span>items<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    array<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,1,2,3,4,5]</span><span class="token punctuation">}</span><span class="token function">__operationArr</span><span class="token punctuation">(</span>_arrayObj<span class="token punctuation">,</span>_arrayObj1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//ä¾‹å­2:</span><span class="token keyword">var</span> __add <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">,</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c <span class="token operator">+</span>d <span class="token operator">+</span> e<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">__add</span><span class="token punctuation">(</span><span class="token operator">...</span>_arrayObj1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//15</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ±‚å‡ºæ•°ç»„æœ€å¤§å…ƒç´ ï¼š<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>arrayObj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="form"><a href="#form" class="headerlink" title="form()"></a>form()</h3><p>è¯¥æ³•ä»ä¸€ä¸ªç±»ä¼¼æ•°ç»„æˆ–å¯è¿­ä»£å¯¹è±¡ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„å®ä¾‹ï¼Œç›¸å½“äºç›¸å½“äº[].slice.call()</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//ä¾‹å­1:</span><span class="token keyword">let</span> arrayItems <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>    <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span>    <span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token string">'wangwu'</span><span class="token punctuation">,</span>    length<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ES5çš„å†™æ³•</span><span class="token keyword">var</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arrayItems<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ['zhangsan', 'lisi', 'wangwu']</span><span class="token comment" spellcheck="true">// ES6çš„å†™æ³•</span><span class="token keyword">let</span> arr2 <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>arrayItems<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ['zhangsan', 'lisi', 'wangwu']</span>ä¾‹å­<span class="token number">2</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">// å¸¸è§çš„DOM NodeListå¯¹è±¡</span><span class="token keyword">let</span> ps <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> pElementArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>pElementArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†å­—ç¬¦ä¸²åˆ†å‰²å­—åå˜ä¸ºæ•°ç»„<br></p><pre class="line-numbers language-js"><code class="language-js">Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//['f','o','o']</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="of"><a href="#of" class="headerlink" title="of()"></a>of()</h3><p>è¯¥æ–¹æ³•åˆ›å»ºä¸€ä¸ªå…·æœ‰å¯å˜æ•°é‡å‚æ•°çš„æ–°æ•°ç»„å®ä¾‹ï¼Œè€Œä¸è€ƒè™‘å‚æ•°çš„æ•°é‡æˆ–ç±»å‹</p><p>Array.of() å’Œ Array æ„é€ å‡½æ•°ä¹‹é—´çš„åŒºåˆ«åœ¨äºå¤„ç†æ•´æ•°å‚æ•°ï¼šArray.of(7) åˆ›å»ºä¸€ä¸ªå…·æœ‰å•ä¸ªå…ƒç´  7 çš„æ•°ç»„ï¼Œè€Œ Array(7) åˆ›å»ºä¸€ä¸ªåŒ…å« 7 ä¸ª undefined å…ƒç´ çš„æ•°ç»„ã€‚<br></p><pre class="line-numbers language-js"><code class="language-js">Array<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// [7] </span>Array<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1, 2, 3]</span><span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// [ , , , , , , ]</span><span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// [1, 2, 3]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="copyWithin"><a href="#copyWithin" class="headerlink" title="copyWithin()"></a>copyWithin()</h3><p>è¯¥æ–¹æ³•æµ…å¤åˆ¶æ•°ç»„çš„ä¸€éƒ¨åˆ†åˆ°åŒä¸€æ•°ç»„ä¸­çš„å¦ä¸€ä¸ªä½ç½®ï¼Œå¹¶è¿”å›å®ƒï¼Œè€Œä¸ä¿®æ”¹å…¶å¤§å°</p><p>arr.copyWithin(target)<br></p><p>arr.copyWithin(target, start)<br></p><p>arr.copyWithin(target, start, end)<br></p><p>arr.copyWithin(ç›®æ ‡ç´¢å¼•, [æºå¼€å§‹ç´¢å¼•], [ç»“æŸæºç´¢å¼•])<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// [1, 2, 3, 1, 2]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// [4, 5, 3, 4, 5]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// [4, 2, 3, 4, 5]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// [1, 2, 3, 3, 4]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copyWithin<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span>length<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// {0: 1, 3: 1, length: 5}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="find"><a href="#find" class="headerlink" title="find()"></a>find()</h3><p>è¯¥æ–¹æ³•è¿”å›æ•°ç»„ä¸­æ»¡è¶³æä¾›çš„callbackçš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„å€¼ã€‚å¦åˆ™è¿”å› undefined</p><p>å¦‚æœä½ éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå…ƒç´ çš„ä½ç½®æˆ–è€…ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºæ•°ç»„ä¸­ï¼Œä½¿ç”¨<code>Array.prototype.indexOf()</code> æˆ– <code>Array.prototype.includes()</code>ã€‚</p><p>å¦‚æœä½ éœ€è¦æ‰¾åˆ°å…ƒç´ çš„ç´¢å¼•ï¼Œè€Œä¸æ˜¯å…¶å€¼<code>Array.prototype.findIndex()</code>;</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> backValue <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">return</span> element <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>backValue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//60</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="fill"><a href="#fill" class="headerlink" title="fill()"></a>fill()</h3><p>è¯¥æ–¹æ³•ç”¨ä¸€ä¸ªå›ºå®šå€¼å¡«å……ä¸€ä¸ªæ•°ç»„ä¸­ä»èµ·å§‹ç´¢å¼•åˆ°ç»ˆæ­¢ç´¢å¼•å†…çš„å…¨éƒ¨å…ƒç´ </p><p>è¯­æ³•ï¼š<br><br>arr.fill(value) <br><br>arr.fill(value, start) <br><br>arr.fill(value, start, end)<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// [4, 4, 4]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true">// [1, 4, 4]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// [1, 4, 3]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// [1, 2, 3]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// [4, 2, 3]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// [1, 2, 3]</span><span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// [4, 4, 4]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fill<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span>length<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {0: 4, 1: 4, 2: 4, length: 3}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="entries"><a href="#entries" class="headerlink" title="entries()"></a>entries()</h3><p>è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Array Iteratorå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«æ•°ç»„ä¸­æ¯ä¸ªç´¢å¼•çš„é”®/å€¼å¯¹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> iterator <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// undefined</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Array Iterator {}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [0, "a"]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1, "b"]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [2, "c"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="includes"><a href="#includes" class="headerlink" title="includes()"></a>includes()</h3><p>è¯¥æ–¹æ³•ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªæ•°ç»„æ˜¯å¦åŒ…å«ä¸€ä¸ªæŒ‡å®šçš„å€¼ï¼Œå¦‚æœæ˜¯ï¼Œé…Œæƒ…è¿”å› trueæˆ– false</p><p>è¯­æ³•ï¼š<br><br>arr.includes(searchElement)<br><br>arr.includes(searchElement, fromIndex)<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// true</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// false</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// false</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¢å‘å¯¹è±¡ä¹‹ç»§æ‰¿</title>
      <link href="/2019/03/15/javascript/inheritance/"/>
      <url>/2019/03/15/javascript/inheritance/</url>
      
        <content type="html"><![CDATA[<p>åŸå‹é“¾è™½ç„¶å¾ˆå¼ºå¤§ï¼Œä¹Ÿå¯ä»¥ç”¨å®ƒæ¥å®ç°ç»§æ‰¿ï¼Œä½†æ˜¯æ€»ä¼šæœ‰è¿™æ ·é‚£æ ·çš„é—®é¢˜ã€‚å…¶ä¸­æœ€ä¸»è¦çš„é—®é¢˜æ˜¯åŸå‹é“¾çš„å¼•ç”¨é—®é¢˜ã€‚ä¸‹é¢å€Ÿé‰´JSé«˜ç¨‹ä¸­çš„å‡ ç§æ–¹å¼æ¥å­¦ä¹ JSç»§æ‰¿,JSç»§æ‰¿ä¹Ÿæ˜¯é¢å‘å¯¹è±¡ï¼ˆooï¼‰ç¼–ç¨‹ï¼Œä½†ä¸ä½¿ç”¨ç±»æˆ–è€…æ¥å£ï¼Œè€Œæ˜¯ä½¿ç”¨åˆ›å»ºå¯¹è±¡çš„å½¢å¼ã€‚è™½ç„¶åœ¨ES6ä¸­å®ç°äº†Classä½†å…¶å®åªæ˜¯è¯­æ³•ç³–ï¼ŒåŸç†ä¾ç„¶æ˜¯<strong>proto</strong>ã€‚åœ¨JSè¶…é›†ä¸­ï¼ˆTypeScriptï¼‰ç”¨ç±»ä¸æ¥å£å®ç°ç»§æ‰¿ï¼Œä¼šåœ¨åç»­æ–‡ç« ä¸­å­¦ä¹ è®°å½•ã€‚</p><h3 id="åŸå‹é“¾ç»§æ‰¿"><a href="#åŸå‹é“¾ç»§æ‰¿" class="headerlink" title="åŸå‹é“¾ç»§æ‰¿"></a>åŸå‹é“¾ç»§æ‰¿</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Parent <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zhansan'</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> Child <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// zhangsan</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  é—®é¢˜</p><ul><li>å¼•ç”¨ç±»å‹çš„å€¼çš„åŸå‹å±æ€§ä¼šè¢«æ‰€æœ‰å®ä¾‹å…±äº«</li><li>åœ¨åˆ›å»ºå­ç±»å‹çš„å®ä¾‹æ—¶ä¸èƒ½å‘è¶…ç±»å‹çš„æ„é€ å‡½æ•°ä¼ å‚ï¼ˆæ²¡æ³•åŠåœ¨ä¸å½±å“æ‰€æœ‰å¯¹è±¡å®ä¾‹çš„æƒ…å†µä¸‹ä¼ å‚ï¼‰</li></ul><h3 id="å€Ÿç”¨æ„é€ å‡½æ•°ç»§æ‰¿ï¼ˆç»å…¸ç»§æ‰¿ï¼‰"><a href="#å€Ÿç”¨æ„é€ å‡½æ•°ç»§æ‰¿ï¼ˆç»å…¸ç»§æ‰¿ï¼‰" class="headerlink" title="å€Ÿç”¨æ„é€ å‡½æ•°ç»§æ‰¿ï¼ˆç»å…¸ç»§æ‰¿ï¼‰"></a>å€Ÿç”¨æ„é€ å‡½æ•°ç»§æ‰¿ï¼ˆç»å…¸ç»§æ‰¿ï¼‰</h3><p>åœ¨å­ç±»æ„é€ å‡½æ•°å†…éƒ¨è°ƒç”¨è¶…ç±»å‹æ„é€ å‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Parent <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> Child <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'wangyu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ['zhangsan', 'lisi' ,'wangyu']</span><span class="token keyword">var</span> child1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child1<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//  ['zhangsan', 'lisi']</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¼˜ç‚¹ï¼šè§£å†³äº†åŸå‹é“¾ç»§æ‰¿çš„é—®é¢˜</p><p>ç¼ºç‚¹ï¼šæ–¹æ³•éƒ½åœ¨æ„é€ å‡½æ•°ä¸­å®šä¹‰ï¼Œå‡½æ•°æ— æ³•å¤ç”¨ï¼Œåˆ›å»ºå®ä¾‹æ—¶æ–¹æ³•éƒ½ä¼šè¢«åˆ›å»ºä¸€é</p><h3 id="ç»„åˆç»§æ‰¿ï¼ˆä¼ªç»å…¸ç»§æ‰¿ï¼‰"><a href="#ç»„åˆç»§æ‰¿ï¼ˆä¼ªç»å…¸ç»§æ‰¿ï¼‰" class="headerlink" title="ç»„åˆç»§æ‰¿ï¼ˆä¼ªç»å…¸ç»§æ‰¿ï¼‰"></a>ç»„åˆç»§æ‰¿ï¼ˆä¼ªç»å…¸ç»§æ‰¿ï¼‰</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Parent <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> Child <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token string">'20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'black'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// zhangsan</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 20</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>colors<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ["red", "blue", "green", "black"]</span><span class="token keyword">var</span> child1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token string">'28'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// lisi</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 28</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span>colors<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ["red", "blue", "green"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¼˜ç‚¹ï¼šèåˆåŸå‹é“¾ç»§æ‰¿å’Œæ„é€ å‡½æ•°çš„ä¼˜</p><p>ç¼ºç‚¹ï¼šè°ƒç”¨å¤šæ¬¡è¶…ç±»æ„é€ å‡½æ•°</p><h3 id="åŸå‹å¼ç»§æ‰¿ï¼ˆé“æ ¼æ‹‰æ–¯ï¼‰"><a href="#åŸå‹å¼ç»§æ‰¿ï¼ˆé“æ ¼æ‹‰æ–¯ï¼‰" class="headerlink" title="åŸå‹å¼ç»§æ‰¿ï¼ˆé“æ ¼æ‹‰æ–¯ï¼‰"></a>åŸå‹å¼ç»§æ‰¿ï¼ˆé“æ ¼æ‹‰æ–¯ï¼‰</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createObj</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  F<span class="token punctuation">.</span>prototype <span class="token operator">=</span> o<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">'zhansan'</span><span class="token punctuation">,</span>  hobbies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'swimming'</span><span class="token punctuation">,</span> <span class="token string">'reading'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token function">createObj</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token function">createObj</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>person1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'person'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// zhangsan</span>person2<span class="token punctuation">.</span>hobbies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'running'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">.</span>hobbies<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ["swimming", "reading", "running"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¼ºç‚¹ï¼šå¼•ç”¨ç±»å‹çš„å€¼çš„åŸå‹å±æ€§ä¼šè¢«æ‰€æœ‰å®ä¾‹å…±äº«</p><h3 id="å¯„ç”Ÿå¼ç»§æ‰¿ï¼ˆé“æ ¼æ‹‰æ–¯å‡çº§ç‰ˆï¼‰"><a href="#å¯„ç”Ÿå¼ç»§æ‰¿ï¼ˆé“æ ¼æ‹‰æ–¯å‡çº§ç‰ˆï¼‰" class="headerlink" title="å¯„ç”Ÿå¼ç»§æ‰¿ï¼ˆé“æ ¼æ‹‰æ–¯å‡çº§ç‰ˆï¼‰"></a>å¯„ç”Ÿå¼ç»§æ‰¿ï¼ˆé“æ ¼æ‹‰æ–¯å‡çº§ç‰ˆï¼‰</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> createObj <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> clone <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>  clone<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> clone<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¼ºç‚¹ï¼šè·Ÿå€Ÿç”¨æ„é€ å‡½æ•°æ¨¡å¼ä¸€æ ·ï¼Œåˆ›å»ºå®ä¾‹æ—¶æ–¹æ³•éƒ½ä¼šè¢«åˆ›å»ºä¸€é</p><h3 id="å¯„ç”Ÿç»„åˆå¼ç»§æ‰¿"><a href="#å¯„ç”Ÿç»„åˆå¼ç»§æ‰¿" class="headerlink" title="å¯„ç”Ÿç»„åˆå¼ç»§æ‰¿"></a>å¯„ç”Ÿç»„åˆå¼ç»§æ‰¿</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">inheritPrototype</span><span class="token punctuation">(</span>Child<span class="token punctuation">,</span> Parent<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>  prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span>  Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> prototype<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"red"</span><span class="token punctuation">,</span> <span class="token string">"blue"</span><span class="token punctuation">,</span> <span class="token string">"green"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">{</span>  Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">inheritPrototype</span><span class="token punctuation">(</span>Child<span class="token punctuation">,</span> Parent<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//å®ç°ç»§æ‰¿</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayAge <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¼˜ç‚¹ï¼šä¿è¯äº†åŸå‹é“¾é“¾è·¯çš„æ­£ç¡®æ€§,æ²¡æœ‰å¤šä½™çš„å±æ€§ç­‰ä¼˜ç‚¹ï¼Œæ‰€ä»¥æœ€ä¸ºç†æƒ³çš„ES5ç»§æ‰¿</p><h3 id="ES6ç»§æ‰¿"><a href="#ES6ç»§æ‰¿" class="headerlink" title="ES6ç»§æ‰¿"></a>ES6ç»§æ‰¿</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//class ç›¸å½“äºes5ä¸­æ„é€ å‡½æ•°</span><span class="token comment" spellcheck="true">//classä¸­å®šä¹‰æ–¹æ³•æ—¶ï¼Œå‰åä¸èƒ½åŠ functionï¼Œå…¨éƒ¨å®šä¹‰åœ¨classçš„protopyteå±æ€§ä¸­</span><span class="token comment" spellcheck="true">//classä¸­å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•æ˜¯ä¸å¯æšä¸¾çš„</span><span class="token comment" spellcheck="true">//classä¸­åªèƒ½å®šä¹‰æ–¹æ³•ï¼Œä¸èƒ½å®šä¹‰å¯¹è±¡ï¼Œå˜é‡ç­‰</span><span class="token comment" spellcheck="true">//classå’Œæ–¹æ³•å†…é»˜è®¤éƒ½æ˜¯ä¸¥æ ¼æ¨¡å¼</span><span class="token comment" spellcheck="true">//es5ä¸­constructorä¸ºéšå¼å±æ€§</span><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'wang'</span><span class="token punctuation">,</span>age<span class="token operator">=</span><span class="token string">'27'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> eat food`</span></span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//ç»§æ‰¿çˆ¶ç±»</span><span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span><span class="token punctuation">{</span>   <span class="token function">constructor</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'ren'</span><span class="token punctuation">,</span>age <span class="token operator">=</span> <span class="token string">'27'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//ç»§æ‰¿çˆ¶ç±»å±æ€§</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>     <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//ç»§æ‰¿çˆ¶ç±»æ–¹æ³•</span>      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">let</span> child <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'xiaoxiami'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> child<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¼˜ç‚¹</p><ul><li>åœ¨è¯­æ³•ç³–ä¸‹ä»£ç é‡æ˜æ˜¾å‡å°‘ï¼Œå’ŒES6åŒºåˆ«ES5ç»§æ‰¿é¦–å…ˆæ˜¯åœ¨å­ç±»ä¸­åˆ›å»ºè‡ªå·±çš„thisæŒ‡å‘ï¼Œæœ€åå°†æ–¹æ³•æ·»åŠ åˆ°thisä¸­</li></ul><pre class="line-numbers language-js"><code class="language-js">Child<span class="token punctuation">.</span>prototype<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Parent<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">||</span> Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>es6ç»§æ‰¿æ˜¯ä½¿ç”¨å…³é”®å­—å…ˆåˆ›å»ºçˆ¶ç±»çš„å®ä¾‹å¯¹è±¡thisï¼Œæœ€ååœ¨å­ç±»classä¸­ä¿®æ”¹this</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸå‹åŠåŸå‹é“¾</title>
      <link href="/2019/03/10/javascript/prototype/"/>
      <url>/2019/03/10/javascript/prototype/</url>
      
        <content type="html"><![CDATA[<h3 id="æ™®é€šå¯¹è±¡å’Œå‡½æ•°å¯¹è±¡"><a href="#æ™®é€šå¯¹è±¡å’Œå‡½æ•°å¯¹è±¡" class="headerlink" title="æ™®é€šå¯¹è±¡å’Œå‡½æ•°å¯¹è±¡"></a>æ™®é€šå¯¹è±¡å’Œå‡½æ•°å¯¹è±¡</h3><pre class="line-numbers language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// æ™®é€šå¯¹è±¡</span>  <span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   <span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> obj3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å‡½æ•°å¯¹è±¡</span>  <span class="token keyword">function</span> <span class="token function">person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   <span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">,</span><span class="token string">'console.warn(aaaa)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Object<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Function<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> person1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function  </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// true </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//object </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//object </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//object</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj3 <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä»¥ä¸Šå®ä¾‹æˆ‘ä»¬çŸ¥é“ new Function æ„å»ºçš„éƒ½æ˜¯å‡½æ•°å¯¹è±¡(å…³äºæ™®é€šå‡½æ•°ä¸new Functionçš„åŒºåˆ«è¯·å‚è€ƒ <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank" rel="noopener">mozillaå¼€å‘è€…</a>), å…¶ä½™éƒ½æ˜¯æ™®é€šå¯¹è±¡,å…³äºObjectä¸Functionçš„åŒºåˆ«ä¼šåœ¨è¿™ç« èŠ‚æœ€åæ€»ç»“</p><h3 id="é€šè¿‡æ„é€ å‡½æ•°æ¨¡å¼åˆ›å»ºå¯¹è±¡"><a href="#é€šè¿‡æ„é€ å‡½æ•°æ¨¡å¼åˆ›å»ºå¯¹è±¡" class="headerlink" title="é€šè¿‡æ„é€ å‡½æ•°æ¨¡å¼åˆ›å»ºå¯¹è±¡"></a>é€šè¿‡æ„é€ å‡½æ•°æ¨¡å¼åˆ›å»ºå¯¹è±¡</h3><p>åœ¨jsé«˜ç¨‹ä¸­æˆ‘ä»¬çŸ¥é“åˆ›å»ºå¯¹è±¡æœ‰å¾ˆå¤šç§æ¨¡å¼å¦‚ä¸‹</p><ul><li>å·¥å‚æ¨¡å¼</li><li>æ„é€ å‡½æ•°æ¨¡å¼</li><li>åŸå‹æ¨¡å¼</li><li>ç»„åˆä½¿ç”¨æ„é€ å‡½æ•°å’ŒåŸå‹æ¨¡å¼</li><li>åŠ¨æ€åŸå‹æ¨¡å¼</li><li>å¯„ç”Ÿæ„é€ å‡½æ•°æ¨¡å¼</li><li>ç¨³å¦¥æ„é€ å‡½æ•°æ¨¡å¼</li></ul><p>å½“ç„¶è¿™å‡ ç§æ¨¡å¼åœ¨è¿™é‡Œæš‚æ—¶ä¸å±•å¼€è¯´æ˜ï¼Œåç»­ç»§æ‰¿çš„æ—¶å€™åœ¨åˆ†åˆ«ç”¨è®¨è®ºï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•çš„å›å¿†ä¸€ä¸‹ç”¨æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'zhansan'</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="proto-prototype-constructor"><a href="#proto-prototype-constructor" class="headerlink" title="proto,prototype,constructor"></a><strong>proto</strong>,prototype,constructor</h3><ul><li><code>__proto__</code>:åœ¨JavaScriptæƒå¨æŒ‡å—ä¸­æŒ‡å‡ºæ¯ä¸ªjså¯¹è±¡ä¸€å®šå¯¹åº”ä¸€ä¸ªåŸå‹å¯¹è±¡ï¼Œå¹¶ä»åŸå‹å¯¹è±¡ç»§æ‰¿å±æ€§å’Œæ–¹æ³•ã€‚</li><li><code>prototype</code>: å½“åˆ›å»ºå‡½æ•°å¯¹è±¡æ—¶ï¼Œjsä¼šè‡ªåŠ¨ä¸ºè¿™ä¸ªå‡½æ•°æ·»åŠ prototypeå±æ€§ï¼ˆ<strong>è¿™é‡Œæ˜ç¡®ä¸€ä¸‹åªæœ‰å‡½æ•°å¯¹è±¡æ‰ä¼šæœ‰æ­¤å±æ€§</strong>ï¼‰</li><li>æ¯ä¸ªåŸå‹éƒ½æœ‰ä¸€ä¸ª constructor å±æ€§æŒ‡å‘å…³è”çš„æ„é€ å‡½æ•°ã€‚</li></ul><p>é€šè¿‡ä¸Šè¿°ä¸‰ç‚¹æˆ‘ä»¬é’ˆå¯¹2ä¸­çš„ä»£ç è§£é‡Šä¸º</p><p>å½“åˆ›å»º<code>Person</code>å‡½æ•°æ—¶ï¼Œjsä¼šè‡ªåŠ¨ä¸ºè¯¥å‡½æ•°åˆ›å»º<code>prototype</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§æŒ‡å‘å‡½æ•°çš„åŸå‹å¯¹è±¡ï¼Œå‡½æ•°çš„åŸå‹å¯¹è±¡ï¼ˆ<code>Person.prototype</code>ï¼‰ä¼šè‡ªåŠ¨è·å–ä¸€ä¸ª<code>constructor</code>å±æ€§æŒ‡å‘å…³è”çš„Personã€‚å½“æˆ‘ä»¬é€šè¿‡newå…³é”®å­—è°ƒç”¨æ—¶ï¼Œjså°±ä¼šåˆ›å»ºè¯¥æ„é€ å‡½æ•°çš„å®ä¾‹<code>person1</code>æˆ–<code>person2</code>ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>prototype</code>æ¥å­˜å‚¨è¦å…±äº«çš„å±æ€§å’Œæ–¹æ³•</p><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡å›¾ä¾‹æ¥è¯´æ˜æˆ‘ä»¬ä¸Šé¢çš„æ–‡å­—</p><p><image src="/images/Person.png"></image></p><p>è¿™é‡Œæˆ‘ä»¬æ³¨æ„è™½ç„¶person1å’Œperson2è¿™ä¸¤ä¸ªä¸ªå®ä¾‹éƒ½ä¸åŒ…å«å±æ€§å’Œæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥æ‰¾å¯¹è±¡å±æ€§æ¥å®ç°è°ƒç”¨person1.sayName()</p><p>æ­¤æ—¶æˆ‘ä»¬æ¥ç¡®å®šä¸¤ä¸ªå®ä¾‹å¯¹è±¡è¿”å›çš„åŸå‹æŒ‡é’ˆæ˜¯å¦ä¸€æ ·(<strong>Object.getPrototypeOf æ­¤æ–¹æ³•å¯ä»¥è·å–å¯¹è±¡çš„åŸå‹</strong>)</p><pre class="line-numbers language-js"><code class="language-js">Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>person1<span class="token punctuation">)</span> <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototype <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>person1<span class="token punctuation">)</span> <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototype <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é€šè¿‡å¦‚ä¸Šè¾“å‡ºç»“æœå¾—çŸ¥ä»–ä»¬å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘Person.prototypeçš„æŒ‡é’ˆä¹Ÿå°±æ˜¯</p><pre class="line-numbers language-js"><code class="language-js">person1<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototypeperson2<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototype<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç»è¿‡ä¸Šé¢è§£é‡Šè¿™ä¹ˆå¤šæˆ‘ä»¬å¾—å‡ºçš„ç»“æœå°±æ˜¯å¦‚ä¸‹ </p><pre class="line-numbers language-js"><code class="language-js">person1<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototypePerson<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">==</span> Person<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><ul><li>jså‡ ä¹æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯Object; å…¸å‹å¯¹è±¡ç»§æ‰¿å±æ€§ï¼ˆåŒ…æ‹¬æ–¹æ³•ï¼‰</li><li>æ‰€æœ‰å¼•ç”¨ç±»å‹çš„åŸå‹é“¾ä¸Šå¿…ç„¶å­˜åœ¨Objectçš„åŸå‹</li><li>new Object å‡ºæ¥çš„å®ä¾‹æ˜¯æ™®é€šå¯¹è±¡æˆ‘ä»¬å‰é¢è¯´è¿‡åªæœ‰å‡½æ•°å¯¹è±¡æ‰æœ‰prototype</li><li>Object å®é™…æ˜¯function Objectè·Ÿfunction Function ç±»ä¼¼</li><li>Object.prototypeæ˜¯Objectæ„é€ å‡½æ•°çš„å±æ€§ã€‚å®ƒä¹Ÿæ˜¯åŸå‹é“¾çš„ç»ˆç»“</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Object <span class="token punctuation">(</span>name<span class="token punctuation">,</span>age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span>Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span>object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>object<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬é€šæ ·ä»¥å›¾ä¾‹çš„å½¢å¼æ¥è¯´æ˜Objectçš„<strong>proto</strong>,prototype,constructor</p><p><image src="/images/Object.png"></image></p><p>é€šè¿‡ä»¥ä¸Šå›¾ä¾‹æˆ‘ä»¬å¾—å‡ºç»“è®º<code>Object.prototype.__proto__ === null</code></p><p>è¿™é‡Œé¢æ‰©å±•ä¸€ä¸‹nullå’ŒundefinedåŒºåˆ«</p><ul><li>null === undefinedä¸ºfalseï¼Œnull == undefinedä¸ºtrue è¯´æ˜åªæ˜¯å€¼ç›¸ç­‰</li><li>nullæ˜¯ä¸€ä¸ªè¡¨ç¤ºâ€æ— â€çš„å¯¹è±¡ï¼Œè½¬ä¸ºæ•°å€¼æ—¶ä¸º0ï¼›undefinedæ˜¯ä¸€ä¸ªè¡¨ç¤ºâ€æ— â€çš„åŸå§‹å€¼ï¼Œè½¬ä¸ºæ•°å€¼æ—¶ä¸ºNaNã€‚</li><li>nullè¡¨ç¤ºå˜é‡æœªæŒ‡å‘ä»»ä½•å¯¹è±¡ï¼Œundefinedè¡¨ç¤ºå˜é‡è¢«å£°æ˜ä½†æ˜¯æ²¡æœ‰è¢«èµ‹å€¼</li></ul><h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><ul><li>åœ¨jsä¸­æ¯ä¸ªå‡½æ•°å®é™…ä¸Šéƒ½æ˜¯ä¸€ä¸ªFunctionå¯¹è±¡ã€‚</li><li>ä½¿ç”¨Functionæ„é€ å™¨ç”Ÿæˆçš„Functionå¯¹è±¡æ˜¯åœ¨å‡½æ•°åˆ›å»ºæ—¶è§£æçš„,è€Œå…¶ä»–å‡½æ•°æ–¹å¼æ˜¯è·Ÿå…¶ä»–ä»£ç ä¸€èµ·è§£æï¼Œæ‰€ä»¥è¾ƒä¸ºä½æ•ˆ</li><li>å…¨å±€çš„Functionå¯¹è±¡æ²¡æœ‰è‡ªå·±çš„å±æ€§å’Œæ–¹æ³•ï¼Œé€šè¿‡Function.prototypeä¸Šç»§æ‰¿éƒ¨åˆ†å±æ€§å’Œæ–¹æ³•ã€‚</li><li>æˆ‘ä»¬è¯´jsä¸­ä¸‡ç‰©çš†å¯¹è±¡ï¼ŒFunctionä¹Ÿä¹Ÿæ˜¯å¯¹è±¡ï¼Œåªä¸è¿‡æ˜¯å‡½æ•°å¯¹è±¡æ‰€ä»¥<code>Function.prototype.__proto__</code>æŒ‡é’ˆæŒ‡å‘<code>Object.prototype</code></li><li><code>Object.__proto__</code> æŒ‡é’ˆæŒ‡å‘<code>Function.prototype</code></li></ul><p><strong>Functionåˆ›å»ºçš„å‡½æ•°ä¸€èˆ¬åœ¨å…¨å±€ä½œç”¨åŸŸä¸­è¢«åˆ›å»ºï¼Œä½†å¹¶ä¸ä¼šåƒå…¶ä»–å‡½æ•°ä¸€æ ·äº§ç”Ÿé—­åŒ…ï¼Œæ‰€ä»¥åªèƒ½è‡ªå·±å†…éƒ¨å’Œå…¨å±€çš„å˜é‡</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Function <span class="token punctuation">(</span>name<span class="token punctuation">,</span>age<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name  <span class="token operator">=</span> name  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">}</span>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span>f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>f<span class="token punctuation">.</span>sayName <span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬åŒæ ·ä»¥å›¾ä¾‹çš„å½¢å¼æ¥è¯´æ˜Functionçš„<strong>proto</strong>,prototype,constructor</p><p><image src="/images/Function.png"></image></p><p>é€šè¿‡ä»¥ä¸Šå›¾ä¾‹æˆ‘ä»¬å¾—å‡ºç»“è®º<code>Object.prototype === Function.prototype.__proto__</code></p><h3 id="å°†Functionï¼ŒObjectï¼ŒPersoné“¾æ¥èµ·æ¥"><a href="#å°†Functionï¼ŒObjectï¼ŒPersoné“¾æ¥èµ·æ¥" class="headerlink" title="å°†Functionï¼ŒObjectï¼ŒPersoné“¾æ¥èµ·æ¥"></a>å°†Functionï¼ŒObjectï¼ŒPersoné“¾æ¥èµ·æ¥</h3><p>æ­¤æ—¶æˆ‘ä»¬åŒæ ·é€šè¿‡å›¾ä¾‹çš„å½¢å¼å°†ä¸Šé¢æ•´åˆèµ·æ¥ã€‚æ¥çœ‹çœ‹æ•´ä¸ªé“¾è·¯æ˜¯ä»€ä¹ˆæ ·å­</p><p><image src="/images/prototype.png"></image></p><p> é€šè¿‡ä»¥ä¸Šå›¾ä¾‹æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°å…¶å®jsåŸå‹é“¾å°±æ˜¯ç”±ç›¸äº’å…³è”çš„é“¾æ¡ç»„æˆï¼ŒæŸ¥æ‰¾å±æ€§æˆ–è€…æ–¹æ³•çš„è¿‡ç¨‹å°±æ˜¯å›¾ä¸­çº¢è‰²é“¾æ¡çš„è¿‡ç¨‹ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç»ˆæ­¢å¦åˆ™ç›´åˆ°è¿”å›null</p><p><code>person1</code> &gt; <code>person1.__proto__</code> &gt; <code>Person.prototype</code> &gt; <code>Person.prototype.__proto__</code> &gt; <code>Object.prototype</code> &gt; <code>Object.prototype.__proto__</code> &gt; <code>null</code></p><p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Objectå’ŒFunctionçš„å…³ç³»ï¼Œä¸Šé¢å·²ç»æåˆ°<code>Object.prototype === Function.prototype.__proto__</code></p><ul><li><code>Function.__proto__</code> &gt; <code>Function.prototype</code> &gt; <code>Function.prototype.__proto__</code> &gt; <code>Object.prototype</code> â€“&gt; <code>Object.prototype.__proto__</code> â€“&gt; â€˜nullâ€™;ç®€å†™ä¸º<code>Function.__proto__.__proto__.__proto__</code> &gt; <code>null</code></li><li><code>Object.__proto__</code> &gt; <code>Funtion.prototype</code> &gt; <code>Function.prototype.__proto__</code> &gt; <code>Object.prototype</code> &gt;<code>Object.prototype.__proto__</code> &gt; <code>null</code>;ç®€å†™ä¸º<code>Object.__proto__.__proto__.__proto__</code> &gt; <code>null</code></li></ul><p>é€šè¿‡ä¸Šé¢æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®º</p><ul><li>åªæœ‰å‡½æ•°å¯¹è±¡æ‰æœ‰ prototypeï¼Œä½†æ˜¯æ¯ä¸ªå¯¹è±¡ï¼ˆæ™®é€šå¯¹è±¡å’Œå‡½æ•°å¯¹è±¡ï¼‰éƒ½æ‹¥æœ‰<strong>proto</strong>å±æ€§</li><li>åŸå‹å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª constructor å±æ€§æŒ‡å‘å®ƒä»¬çš„æ„é€ å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯è‡ªå·±ï¼‰</li><li>åŸç”Ÿå¯¹è±¡æ—¢æ˜¯å¯¹è±¡ï¼Œä¹Ÿæ˜¯æ„é€ å‡½æ•°</li><li>å®ä¾‹å¯¹è±¡çš„éšå¼åŸå‹å§‹ç»ˆæŒ‡å‘æ„é€ å‡½æ•°çš„æ˜¾å¼åŸå‹ï¼ˆ<code>person1.__proto__</code> &gt; <code>Person.prototype</code>ï¼‰</li><li>åŸå‹é“¾çš„æŸ¥æ‰¾è¿‡ç¨‹é“¾æ¥ä¾èµ– <strong>proto</strong> æŒ‡é’ˆé€çº§å‘ä¸Šï¼Œå¹¶ä¸”åŸå‹é“¾çš„å°½å¤´å§‹ç»ˆä¸ºnull</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>this</title>
      <link href="/2019/03/05/javascript/this/"/>
      <url>/2019/03/05/javascript/this/</url>
      
        <content type="html"><![CDATA[<h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ<hr></h3><p>å½“ä¸€ä¸ªå‡½æ•°è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ´»åŠ¨å¯¹è±¡ï¼ˆæ‰§è¡Œä¸Šä¸‹æ–‡ECï¼‰ï¼Œè¿™é‡Œé¢åŒ…å«äº†å‡½æ•°çš„è°ƒç”¨æ ˆï¼Œå‡½æ•°çš„è°ƒç”¨æ–¹å¼ã€ä¼ å…¥çš„å‚æ•°ç­‰ä¿¡æ¯ï¼Œthiså°±æ˜¯æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¸€ä¸ªå±æ€§ï¼Œä¼šåœ¨å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ç”¨åˆ°</p><h3 id="ç»‘å®šè§„åˆ™"><a href="#ç»‘å®šè§„åˆ™" class="headerlink" title="ç»‘å®šè§„åˆ™"></a>ç»‘å®šè§„åˆ™<hr></h3><p>é»˜è®¤ç»‘å®šã€éšå¼ç»‘å®šã€apply,callã€newç»‘å®šã€‚ä¼˜å…ˆçº§ä»ä½åˆ°é«˜</p><h3 id="é»˜è®¤ç»‘å®š"><a href="#é»˜è®¤ç»‘å®š" class="headerlink" title="é»˜è®¤ç»‘å®š"></a>é»˜è®¤ç»‘å®š<hr></h3><pre class="line-numbers language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//window</span><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// éä¸¥æ ¼æ¨¡å¼ä¸‹1 ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹undefined</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="éšå¼è°ƒç”¨"><a href="#éšå¼è°ƒç”¨" class="headerlink" title="éšå¼è°ƒç”¨"></a>éšå¼è°ƒç”¨<hr></h3><p>ä½œä¸ºå¯¹è±¡æ–¹æ³•è°ƒç”¨ï¼Œthis æŒ‡ä»£ä¸Šä¸‹æ–‡å¯¹è±¡</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>   a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>  fun<span class="token punctuation">:</span> fun <span class="token punctuation">}</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span><span class="token keyword">var</span> c <span class="token operator">=</span> obj<span class="token punctuation">.</span>fun<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="apply-call"><a href="#apply-call" class="headerlink" title="apply,call"></a>apply,call<hr></h3><p>æ”¹å˜å¯¹è±¡çš„prototypeå…³è”å¯¹è±¡æ¥æ”¹å˜this,å¯¹äºnullï¼Œundefinedç»‘å®šä¼šå¤±æ•ˆ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>   a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>   a<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj2 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> undefined <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä½œä¸ºæ„é€ å‡½æ•°è°ƒç”¨"><a href="#ä½œä¸ºæ„é€ å‡½æ•°è°ƒç”¨" class="headerlink" title="ä½œä¸ºæ„é€ å‡½æ•°è°ƒç”¨"></a>ä½œä¸ºæ„é€ å‡½æ•°è°ƒç”¨<hr></h3><p>this æŒ‡ä»£new å‡ºçš„å¯¹è±¡<br>ä½¿ç”¨newæ¥è°ƒç”¨å‡½æ•°ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ã€‚</li><li>è¿™ä¸ªæ–°å¯¹è±¡ä¼šè¢«æ‰§è¡Œ[[åŸå‹]]è¿æ¥ã€‚</li><li>è¿™ä¸ªæ–°å¯¹è±¡ä¼šç»‘å®šåˆ°å‡½æ•°è°ƒç”¨çš„thisã€‚</li><li>å¦‚æœå‡½æ•°æ²¡æœ‰è¿”å›å…¶ä»–å¯¹è±¡,é‚£ä¹ˆnewè¡¨è¾¾å¼ä¸­çš„å‡½æ•°è°ƒç”¨ä¼šè‡ªåŠ¨è¿”å›è¿™ä¸ªæ–°å¯¹è±¡ã€‚<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fun</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fun</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="es6ä¸­ç®­å¤´å‡½æ•°thisæŒ‡å‘"><a href="#es6ä¸­ç®­å¤´å‡½æ•°thisæŒ‡å‘" class="headerlink" title="es6ä¸­ç®­å¤´å‡½æ•°thisæŒ‡å‘"></a>es6ä¸­ç®­å¤´å‡½æ•°thisæŒ‡å‘<hr></h3><p>  å–å†³äºå¤–å±‚ï¼ˆå‡½æ•°æˆ–å…¨å±€ï¼‰ä½œç”¨åŸŸã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>  thisåˆ¤æ–­æœºåˆ¶</p><ul><li>å‡½æ•°æ˜¯å¦åœ¨ new ä¸­è°ƒç”¨ï¼Œå¦‚æœæ˜¯é‚£ä¹ˆthis ç»‘å®šçš„æ˜¯æ–°åˆ›å»ºçš„å¯¹è±¡</li><li>å‡½æ•°æ˜¯å¦é€šè¿‡applyã€callï¼ˆæ˜¾ç¤ºç»‘å®šï¼‰ã€ç¡¬ç»‘å®šè°ƒç”¨ï¼Œå¦‚æœæ˜¯,thisæŒ‡å‘çš„æ˜¯æŒ‡å®šçš„å¯¹è±¡</li><li>å‡½æ•°å¦æ˜¯åœ¨æŸä¸ªä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ï¼ˆéšå¼ç»‘å®šï¼‰ï¼Œå¦‚æœæ˜¯thisç»‘å®šçš„å°±æ˜¯é‚£ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡</li><li>å¦‚æœéƒ½ä¸æ˜¯ this ä½¿ç”¨é»˜è®¤ç»‘å®šè§„åˆ™æ˜¯å½“å‰çš„å…¨å±€å¯¹è±¡ï¼Œä¸¥æ ¼æ¨¡å¼åˆ™æ˜¯ undefined</li><li>å¦‚æœ applyã€callã€bind ç­‰ä¼ å…¥çš„æ˜¯ null,æˆ–è€… undefined åˆ™ä½¿ç”¨é»˜è®¤ç»‘å®š</li><li>å¦‚æœæ˜¯ es6 é‚£ä¹ˆ this æ˜¯æ ¹æ®å¤–å±‚ä½œç”¨åŸŸæ¥å†³å®šçš„</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é—­åŒ…</title>
      <link href="/2019/02/25/javascript/closure/"/>
      <url>/2019/02/25/javascript/closure/</url>
      
        <content type="html"><![CDATA[<p>è¯´åˆ°é—­åŒ…æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ JS çš„ä½œç”¨åŸŸ</p><h3 id="ä»€ä¹ˆæ˜¯ä½œç”¨åŸŸ"><a href="#ä»€ä¹ˆæ˜¯ä½œç”¨åŸŸ" class="headerlink" title="ä»€ä¹ˆæ˜¯ä½œç”¨åŸŸ"></a>ä»€ä¹ˆæ˜¯ä½œç”¨åŸŸ<hr></h3><p>ä½œç”¨åŸŸæ˜¯æ ¹æ®åç§°æŸ¥æ‰¾å˜é‡çš„ä¸€å¥—è§„åˆ™ï¼Œè´Ÿè´£æ”¶é›†å¹¶ç»´æŠ¤æ•°æ®çš„å£°æ˜å’Œæ ‡è¯†ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„å£°æ˜å’Œæ ‡è¯†èƒ½å¤Ÿç»„æˆè®¿é—®æŸ¥è¯¢</p><h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»<hr></h3><ul><li>å…¨å±€ä½œç”¨åŸŸ</li><li>å±€éƒ¨ä½œç”¨åŸŸ</li><li>å—çº§ä½œç”¨åŸŸ</li></ul><p>é‚£ä¹ˆä½œç”¨åŸŸåˆ°åº•åœ¨å“ªé‡Œå‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹é™¤ä½œç”¨åŸŸå¤–åœ¨ JS ä¸­å¦å¤–ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä¸œè¥¿ç¼–è¯‘å™¨å’Œå¼•æ“</p><p>ç¼–è¯‘å™¨ï¼šè´Ÿè´£ä»£ç çš„ç¼–è¯‘ç­‰å·¥ä½œï¼Œå®ƒæœ‰ä¸‰ä¸ªé˜¶æ®µ</p><ul><li>è¯æ³•åˆ†æ: æŠŠå’±ä»¬çš„ä»£ç åˆ†ææˆè¯æ³•å•å…ƒï¼ˆtokenä»¤ç‰Œçš„å½¢å¼ï¼‰</li><li>è¯­æ³•åˆ†æ: å°†ä¸Šä¸€ä¸ªé˜¶æ®µç»„æˆçš„è¯æ³•å•å…ƒç»„æˆï¼Œè¯æ³•å•å…ƒæµçš„å½¢å¼ï¼Œå½¢æˆé€çº§åµŒå¥—çš„å½¢å¼è¿™ä¸ªé˜¶æ®µä¹Ÿå«ï¼ˆASTæŠ½è±¡è¯­æ³•æ ‘ï¼‰</li><li>ä»£ç ç”Ÿæˆ: å°†æŠ½è±¡è¯­æ³•æ ‘è¿›è¡Œå¯¹æ¯”ç”Ÿæˆæˆ‘ä»¬è¦æ‰§è¡Œçš„ä»£ç å—</li></ul><p>å¼•æ“ï¼šè´Ÿè´£ç¼–è¯‘å’Œä»£ç çš„æ‰§è¡Œç­‰å·¥ä½œï¼Œæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯</p><ul><li>åœ¨å…¨å±€ä»£ç æ‰§è¡Œå‰, jså¼•æ“å°±ä¼šåˆ›å»ºä¸€ä¸ªæ ˆæ¥å­˜å‚¨ç®¡ç†æ‰€æœ‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡</li><li>åœ¨å…¨å±€æ‰§è¡Œç¯å¢ƒ(window)ç¡®å®šå, å°†å…¶pushåˆ°æ ˆä¸­</li><li>åœ¨å‡½æ•°æ‰§è¡Œç¯å¢ƒåˆ›å»ºå, å°†å…¶pushåˆ°æ ˆä¸­</li><li>åœ¨å½“å‰å‡½æ•°æ‰§è¡Œå®Œå,å°†æ ˆé¡¶çš„å¯¹è±¡pop</li><li>å½“æ‰€æœ‰çš„ä»£ç æ‰§è¡Œå®Œå, æ ˆä¸­åªå‰©ä¸‹window</li></ul><p>jsåˆå§‹åŒ–æ‰§è¡Œçš„æ—¶å€™ä¼šé¦–å…ˆç”Ÿæˆ GC å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œï¼Œç”Ÿæˆå¿…è¦çš„å¯¹è±¡[objects] å’Œ [function]ã€‚ä¼šå¯¹ä»–è¿›è¡Œå‹æ ˆæ“ä½œï¼Œæ”¾åˆ°æ ˆåº•ã€‚å¦‚æœæœ‰å¾ˆå¤šå‡½æ•°ä¼šç”Ÿæˆå¾ˆå¤šä¸ª ECï¼ˆæ‰§è¡Œä¸Šä¸‹æ–‡ï¼‰ï¼Œæ¯ä¸€ä¸ª EC è¿›è¡Œå‹æ ˆæ“ä½œå½¢æˆ ESCï¼ˆä¸Šä¸‹æ‰§è¡Œæ ˆï¼‰ã€‚</p><h3 id="ä¸Šä¸‹æ–‡æ‰§è¡Œç¯å¢ƒï¼ˆECï¼‰"><a href="#ä¸Šä¸‹æ–‡æ‰§è¡Œç¯å¢ƒï¼ˆECï¼‰" class="headerlink" title="ä¸Šä¸‹æ–‡æ‰§è¡Œç¯å¢ƒï¼ˆECï¼‰"></a>ä¸Šä¸‹æ–‡æ‰§è¡Œç¯å¢ƒï¼ˆECï¼‰<hr></h3><p>æ¦‚å¿µï¼šæ‰§è¡Œç¯å¢ƒå®šä¹‰äº†å˜é‡æˆ–è€…å‡½æ•°æœ‰æƒè®¿é—®çš„å…¶ä»–æ•°æ®ï¼Œå†³å®šäº†å„è‡ªçš„è¡Œä¸º</p><p>ç»„æˆéƒ¨åˆ†ï¼š</p><ul><li>å˜é‡å¯¹è±¡ï¼ˆvarible objectï¼‰ï¼šå­˜æ”¾å½“å‰æ‰§è¡Œç¯å¢ƒä¸­å®šä¹‰çš„å˜é‡å’Œå‡½æ•°ï¼Œ<strong>å¦‚æœå½“å‰ç¯å¢ƒæ˜¯å‡½æ•°åˆ™å°†æ´»åŠ¨å¯¹è±¡ï¼ˆactivation objectï¼‰ä½œä¸ºå˜é‡å¯¹è±¡ï¼Œä½†ä¸åŒ…æ‹¬å‡½æ•°è¡¨è¾¾å¼</strong></li><li>ä½œç”¨åŸŸé“¾ï¼ˆscopeï¼‰ï¼šå½“ä»£ç åœ¨æ‰§è¡Œç¯å¢ƒä¸­è¿è¡Œæ—¶ï¼Œä¼šåˆ›å»º<strong>å˜é‡å¯¹è±¡</strong>çš„ä¸€ä¸ª<strong>ä½œç”¨åŸŸé“¾ï¼ˆè¯æ³•ä½œç”¨åŸŸï¼‰</strong>ï¼Œèƒ½å¤Ÿä¿è¯å¯¹æ‰§è¡Œç¯å¢ƒä¸­æ‰€æœ‰å˜é‡å’Œå‡½æ•°æœ‰åºè®¿é—®</li><li>thisæŒ‡å‘ï¼šæ ¹æ®è°ƒç”¨çš„è§„åˆ™ä¸åŒthisæŒ‡å‘ä¸åŒäº§ç”Ÿçš„æ‰§è¡Œç¯å¢ƒä¸Šä¸‹æ–‡ä¸åŒ</li></ul><p>EC çš„æ‰§è¡Œç”Ÿå‘½å‘¨æœŸï¼š</p><ul><li>åˆ›å»ºé˜¶æ®µ<ul><li>åˆ›å»ºå˜é‡å¯¹è±¡é˜¶æ®µï¼ˆå­˜å‚¨çš„ä¸ä¸Šä¸‹ç›¸å…³çš„æ•°æ®ä½œç”¨åŸŸï¼Œå®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡åŒ…å«ç€ä¸Šä¸‹æ–‡çš„å˜é‡ã€å‡½æ•°å£°æ˜ï¼ˆå‡½æ•°è¡¨è¾¾å¼ä¸å†voä¸­ï¼‰</li><li>åˆ›å»ºä½œç”¨åŸŸé“¾ï¼ˆscopeï¼‰</li><li>åˆ›å»º this æŒ‡å‘ï¼ˆthisValueï¼‰</li></ul></li><li>æ‰§è¡Œé˜¶æ®µ<br>åˆ›å»ºæ´»åŠ¨å¯¹è±¡ aoï¼ˆæ˜¯ä¸€ä¸ªæ´»åŠ¨å¯¹è±¡ï¼Œå½“å‡½æ•°è¢«è°ƒç”¨è€…æ¿€æ´»çš„æ—¶å€™ï¼Œè¿™ä¸ªç‰¹æ®Šçš„ ao å°±è¢«åˆ›å»ºäº†ï¼ˆå‡½æ•°è¡¨è¾¾å¼ä¸å†aoä¸­ï¼‰ï¼‰</li><li>å›æ”¶é˜¶æ®µ<br>æ‰§è¡Œå®Œæ¯•ååƒåœ¾å›æ”¶æœºåˆ¶è¿›è¡Œå›æ”¶</li></ul><p>EC å’Œ Scope çš„åŒºåˆ«ï¼š</p><ul><li>åˆ›å»ºæ—¶æœºä¸åŒï¼Œå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯åœ¨å…¨å±€ä½œç”¨åŸŸç¡®å®šåjsä»£ç æ‰§è¡Œå‰åˆ›å»ºçš„è€Œå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯åœ¨è°ƒç”¨å‡½æ•°æ—¶, å‡½æ•°ä½“ä»£ç æ‰§è¡Œä¹‹å‰åˆ›å»º</li><li>ä½œç”¨åŸŸæ˜¯é™æ€çš„ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯åŠ¨æ€çš„</li></ul><h3 id="ä½œç”¨åŸŸé“¾"><a href="#ä½œç”¨åŸŸé“¾" class="headerlink" title="ä½œç”¨åŸŸé“¾"></a>ä½œç”¨åŸŸé“¾<hr></h3><ul><li>ä»å†…åˆ°å¤–å¤šä¸ªä½œç”¨åŸŸå½¢æˆçš„é“¾</li><li>åŒ…å«çˆ¶çº§(<strong>[[scope]]</strong>)å˜é‡å¯¹è±¡ä¸ä½œç”¨åŸŸé“¾å’Œè‡ªèº«çš„å˜é‡å¯¹è±¡</li></ul><h3 id="é—­åŒ…æ¦‚å¿µ"><a href="#é—­åŒ…æ¦‚å¿µ" class="headerlink" title="é—­åŒ…æ¦‚å¿µ "></a>é—­åŒ…æ¦‚å¿µ <hr></h3><p>å½“å‡½æ•°å¯ä»¥è®°ä½å¹¶è®¿é—®æ‰€åœ¨çš„è¯æ³•ä½œç”¨åŸŸæ—¶å°±äº§ç”Ÿäº†é—­åŒ…ï¼Œå³ä½¿æ˜¯åœ¨ä½œç”¨åŸŸå¤–æ‰§è¡Œ</p><h3 id="é—­åŒ…ä½œç”¨"><a href="#é—­åŒ…ä½œç”¨" class="headerlink" title="é—­åŒ…ä½œç”¨ "></a>é—­åŒ…ä½œç”¨ <hr></h3><p>åŒ¿åè‡ªæ‰§è¡Œå‡½æ•°,å‡å°‘å†…å­˜æ¶ˆè€—</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>$<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>jQuery<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¼“å­˜è®¡ç®—ç»“æœ</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> fun1 <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      a<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token function">alert</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2       </span>  <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3           </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°è£…,ç®¡ç†ç§æœ‰æ–¹æ³•å’Œå˜é‡ï¼Œé¿å…å…¨å±€å˜é‡å†²çªæ±¡æŸ“</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">"renbo"</span><span class="token punctuation">;</span>           <span class="token keyword">return</span> <span class="token punctuation">{</span>          getName <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> name<span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>          setName <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>newName<span class="token punctuation">)</span><span class="token punctuation">{</span>            name <span class="token operator">=</span> newName<span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ç°ç±»å’Œç»§æ‰¿ç­‰ç­‰</p><h3 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯ "></a>åº”ç”¨åœºæ™¯ <hr></h3><ul><li>å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬å™¨ã€Ajax è¯·æ±‚ï¼Œè·¨çª—å£é€šä¿¡ï¼ŒDOMäº‹ä»¶çš„ç‚¹å‡»ç­‰</li><li>å¸¸ç”¨çš„å°±æ˜¯IIFE èƒ½å¤Ÿé˜²æ­¢å˜é‡æ±¡æŸ“ç­‰ä½œç”¨</li></ul><h3 id="é—­åŒ…ç¼ºç‚¹"><a href="#é—­åŒ…ç¼ºç‚¹" class="headerlink" title="é—­åŒ…ç¼ºç‚¹ "></a>é—­åŒ…ç¼ºç‚¹ <hr></h3><ul><li>ç”±äºå˜é‡å¯¹è±¡ï¼ˆaoï¼‰ä¸€ç›´åœ¨å†…å­˜ä¸­è¢«å¤–éƒ¨å˜é‡å¼•ç”¨ä¸èƒ½è¢«åƒåœ¾å›æ”¶æœºåˆ¶é‡Šæ”¾ï¼Œå¯¼è‡´å†…å­˜è¿‡é«˜ã€‚</li><li>ç”±äºå¤šä¸ªå‡½æ•°å…±äº«ä¸€ä¸ªçˆ¶çº§ï¼Œå½“çˆ¶çº§æœ‰å˜é‡æ›´æ”¹æ—¶ï¼Œæ‰€æœ‰å­å‡½æ•°å—å½±å“</li></ul><h3 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="æ¨èé˜…è¯»"></a>æ¨èé˜…è¯»</h3><p><a href="https://www.cnblogs.com/TomXu/archive/2012/01/12/2308594.html" target="_blank" rel="noopener">æ±¤å§†å¤§å”çš„åšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å˜é‡æå‡</title>
      <link href="/2019/02/20/javascript/variableascension/"/>
      <url>/2019/02/20/javascript/variableascension/</url>
      
        <content type="html"><![CDATA[<h2 id="å˜é‡æå‡"><a href="#å˜é‡æå‡" class="headerlink" title="å˜é‡æå‡"></a>å˜é‡æå‡</h2><h3 id="æ‰§è¡Œæ­¥éª¤"><a href="#æ‰§è¡Œæ­¥éª¤" class="headerlink" title="æ‰§è¡Œæ­¥éª¤"></a>æ‰§è¡Œæ­¥éª¤<hr></h3><p>jsä»£ç è™½ç„¶æ˜¯é€è¡Œå‘ä¸‹æ‰§è¡Œçš„ï¼Œä½†æ‰§è¡Œçš„æ—¶å€™åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤**</p><ul><li>ç¼–è¯‘é˜¶æ®µï¼ˆè¯æ³•è§£é‡Š/é¢„è§£é‡Šï¼‰</li><li>æ‰§è¡Œ</li></ul><h3 id="ç¼–è¯‘é˜¶æ®µ"><a href="#ç¼–è¯‘é˜¶æ®µ" class="headerlink" title="ç¼–è¯‘é˜¶æ®µ"></a>ç¼–è¯‘é˜¶æ®µ<hr></h3><p>å‡½æ•°å£°æ˜å’Œå˜é‡å£°æ˜æ€»æ˜¯ä¼šè¢«è§£é‡Šå™¨(ç¼–è¯‘é˜¶æ®µ)æ‚„æ‚„åœ°è¢«â€œæå‡â€åˆ°æœ€é¡¶éƒ¨ï¼Œæœ€åæ‰§è¡Œ</p><h3 id="è§£æé¡ºåº"><a href="#è§£æé¡ºåº" class="headerlink" title="è§£æé¡ºåº"></a>è§£æé¡ºåº</h3><ul><li>thiså’Œargumentsï¼ˆè¯­è¨€å†…ç½®ï¼‰</li><li>å‡½æ•°çš„å½¢å¼å‚æ•°</li><li>å‡½æ•°å£°æ˜</li><li>å˜é‡å£°æ˜</li></ul><h3 id="ä¼˜å…ˆçº§"><a href="#ä¼˜å…ˆçº§" class="headerlink" title="ä¼˜å…ˆçº§"></a>ä¼˜å…ˆçº§<hr></h3><p>å‡½æ•°çš„å£°æ˜æ¯”å˜é‡çš„å£°æ˜çš„ä¼˜å…ˆçº§è¦é«˜</p><h3 id="es6ä¸­letå…³é”®å­—åŠå—åŠä½œç”¨åŸŸ"><a href="#es6ä¸­letå…³é”®å­—åŠå—åŠä½œç”¨åŸŸ" class="headerlink" title="es6ä¸­letå…³é”®å­—åŠå—åŠä½œç”¨åŸŸ"></a>es6ä¸­letå…³é”®å­—åŠå—åŠä½œç”¨åŸŸ<hr></h3><pre class="line-numbers language-js"><code class="language-js">  a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> a<span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo</span>  <span class="token comment" spellcheck="true">// ç¼–è¯‘åçš„ä»£ç </span>  <span class="token keyword">var</span> a<span class="token punctuation">;</span>  a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// ç¼–è¯‘åçš„ä»£ç </span>  <span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a<span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo undefined zhangsan</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‡½æ•°æå‡"><a href="#å‡½æ•°æå‡" class="headerlink" title="å‡½æ•°æå‡"></a>å‡½æ•°æå‡</h2><pre class="line-numbers language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// ä¸¤ç§å‡½æ•°çš„ä¹¦å†™æ–¹å¼</span>  <span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//å‡½æ•°è¡¨è¾¾å¼</span>  <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//å‡½æ•°å£°æ˜æ–¹å¼ </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>  åªæœ‰å£°æ˜æ–¹å¼çš„å‡½æ•°æ‰ä¼šæœ‰å‡½æ•°æå‡</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ç¼–è¯‘å</span>  <span class="token keyword">function</span> test <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// åœ¨å‡½æ•°ä½œç”¨åŸŸå†…ï¼Œè¢«æå‡æœ€å‰é¢</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefined</span>    a <span class="token operator">=</span> renbo<span class="token punctuation">;</span>   <span class="token punctuation">}</span>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç±»å‹</title>
      <link href="/2019/02/12/javascript/type/"/>
      <url>/2019/02/12/javascript/type/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬æ•°æ®ç±»å‹"><a href="#åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="åŸºæœ¬æ•°æ®ç±»å‹"></a>åŸºæœ¬æ•°æ®ç±»å‹</h2><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ "></a>æ¦‚å¿µ <hr></h3><p>  åŸºæœ¬æ•°æ®ç±»å‹æ˜¯æŒ‰å€¼è¿›è¡Œè¿›è¡Œè®¿é—®ï¼Œå˜é‡æ˜¯æ”¾åœ¨æ ˆï¼ˆstackï¼‰å†…å­˜é‡Œ</p><h3 id="ç§ç±»"><a href="#ç§ç±»" class="headerlink" title="ç§ç±»"></a>ç§ç±»<hr></h3><p>  Undefinedã€Nullã€Booleanã€Stringã€Numberã€Symbolï¼ˆes6ï¼‰</p><p>  åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼æ˜¯ä¸å¯å˜çš„</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"renbo"</span><span class="token punctuation">;</span>  str<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// RENBO</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>  æŒ‰å€¼è¿›è¡Œæ¯”è¾ƒ</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">===</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>  è™½ç„¶æ•°æ®ç±»å‹ä¸ç›¸åŒï¼ˆtrueä¸ºbool,1ä¸ºNumber)ä½†åœ¨æ¯”è¾ƒä¹‹å‰jsè‡ªåŠ¨è¿›è¡Œäº†æ•°æ®ç±»å‹çš„éšå¼è½¬æ¢</p><p>  == æ˜¯è¿›è¡Œå€¼æ¯”è¾ƒæ‰€ä»¥ä¸ºtrue</p><p>  === ä¸ä»…æ¯”è¾ƒå€¼è¿˜è¦æ¯”è¾ƒæ•°æ®ç±»å‹æ‰€ä»¥ä¸ºfalse</p><p>  æ ˆå†…å­˜ä¸­ä¿å­˜äº†å˜é‡çš„æ ‡è¯†ç¬¦å’Œå˜é‡çš„å€¼</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a<span class="token punctuation">,</span>b<span class="token punctuation">;</span>  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  b <span class="token operator">=</span> a<span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>  a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  <image src="/images/javascript-stack.png"></image></p><h2 id="å¼•ç”¨æ•°æ®ç±»å‹"><a href="#å¼•ç”¨æ•°æ®ç±»å‹" class="headerlink" title="å¼•ç”¨æ•°æ®ç±»å‹"></a>å¼•ç”¨æ•°æ®ç±»å‹</h2><h3 id="æ¦‚å¿µ-1"><a href="#æ¦‚å¿µ-1" class="headerlink" title="æ¦‚å¿µ "></a>æ¦‚å¿µ <hr></h3><p>  å¼•ç”¨ç±»å‹çš„å€¼æ˜¯ä¿å­˜åœ¨å †å†…å­˜ï¼ˆHeapï¼‰ä¸­çš„å¯¹è±¡ï¼ˆObjectï¼‰</p><h3 id="ç§ç±»-1"><a href="#ç§ç±»-1" class="headerlink" title="ç§ç±»"></a>ç§ç±»<hr></h3><p>  ç»Ÿç§°ä¸ºObjectï¼Œç»†åˆ†æœ‰ï¼šObjectï¼ŒArrayï¼ŒFunctionï¼ŒDataï¼ŒRegExpç­‰</p><p>  å¼•ç”¨ç±»å‹çš„å€¼å¼å¯å˜åŒ–çš„</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'renbo'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>  obj<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  obj<span class="token punctuation">.</span>say <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">'My name is'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'Iâ€˜m'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token operator">+</span> <span class="token string">'years old'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  obj<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//My name is zhangsan Iâ€˜m 28 years old</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  æŒ‰å¼•ç”¨åœ°å€æ¯”è¾ƒ</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> obj1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj <span class="token operator">===</span> obj1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>  æ ˆå†…å­˜ä¸­ä¿å­˜äº†å˜é‡æ ‡è¯†ç¬¦å’ŒæŒ‡å‘å †å†…å­˜ä¸­è¯¥å¯¹è±¡çš„æŒ‡é’ˆ</p><p>  å †å†…å­˜ä¸­ä¿å­˜äº†å¯¹è±¡çš„å†…å®¹</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'renbo'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>  a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// zhangsan</span>  b<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>age<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 28</span>  b<span class="token punctuation">.</span>say <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">'My name is'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'Iâ€˜m'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token operator">+</span> <span class="token string">'years old'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//My name is zhangsan Iâ€˜m 28 years old</span>  <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">{</span>    name<span class="token punctuation">:</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span>    age<span class="token punctuation">:</span><span class="token number">28</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><image src="/images/javascript-stack1.png"></image></p><h2 id="ç±»å‹æ£€æµ‹"><a href="#ç±»å‹æ£€æµ‹" class="headerlink" title="ç±»å‹æ£€æµ‹"></a>ç±»å‹æ£€æµ‹</h2><h3 id="typeof"><a href="#typeof" class="headerlink" title="typeof"></a>typeof<hr></h3><p>  ç»å¸¸æ£€æŸ¥å˜é‡æ˜¯ä¸æ˜¯åŸºæœ¬æ•°æ®ç±»å‹</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a<span class="token punctuation">;</span>  a <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// string</span>  a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// boolean</span>  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// number </span>  a <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// object</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefined</span>  a <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// symbol</span>  a <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// function</span>  a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// object</span>  a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// object</span>  a <span class="token operator">=</span> <span class="token regex">/renbo/g</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// object   </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="instanceof"><a href="#instanceof" class="headerlink" title="instanceof"></a>instanceof<hr></h3><p>  ç»å¸¸ç”¨æ¥åˆ¤æ–­å¼•ç”¨ç±»å‹çš„å˜é‡å…·ä½“æ˜¯æŸç§ç±»å‹</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a<span class="token punctuation">;</span>  a <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  a <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  a <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  a <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  a <span class="token operator">=</span> <span class="token regex">/renbo/g</span><span class="token punctuation">;</span>  a <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span> <span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true    </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vuex åŸç†</title>
      <link href="/2018/09/10/vue/vuex/"/>
      <url>/2018/09/10/vue/vuex/</url>
      
        <content type="html"><![CDATA[<p>è¯´æˆ‘ Vuex å¤§å®¶ä¹Ÿéƒ½èƒ½å¤Ÿè€³ç†Ÿèƒ½è¯¦äº†ï¼Œå®ƒæ˜¯è¿›è¡ŒçŠ¶æ€ç®¡ç†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å…¨å±€æ•°æ®ç¼“å­˜ï¼Œé€šè®¯çš„ä½œç”¨ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-Vuex"><a href="#ä»€ä¹ˆæ˜¯-Vuex" class="headerlink" title="ä»€ä¹ˆæ˜¯ Vuex"></a>ä»€ä¹ˆæ˜¯ Vuex</h2><p>ç”¨ Vuex å®˜ç½‘çš„è¯è®² Vuex æ˜¯ Vue.js åº”ç”¨ç¨‹åºçš„çŠ¶æ€ç®¡ç†æ¨¡å¼+åº“ã€‚å®ƒå……å½“åº”ç”¨ç¨‹åºä¸­æ‰€æœ‰ç»„ä»¶çš„é›†ä¸­å­˜å‚¨ï¼Œå…¶è§„åˆ™ç¡®ä¿çŠ¶æ€åªèƒ½ä»¥å¯é¢„æµ‹çš„æ–¹å¼è¿›è¡Œæ›´æ”¹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€å¼ å¾ˆç†Ÿæ‚‰çš„å›¾æ¥ç†è§£ Vuex èƒŒåçš„åŸºæœ¬æ€æƒ³</p><img src="/images/vuex.png"><h2 id="Vuex-çš„æ ¸å¿ƒæ¦‚å¿µ"><a href="#Vuex-çš„æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="Vuex çš„æ ¸å¿ƒæ¦‚å¿µ"></a>Vuex çš„æ ¸å¿ƒæ¦‚å¿µ</h2><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡å‡ ä¸ªæ¦‚å¿µçš„è§£é‡Šæ¥ç†è§£ä¸Šé¢çš„å›¾</p><h3 id="State"><a href="#State" class="headerlink" title="State"></a>State<hr></h3><p>Vuex çš„å”¯ä¸€æ•°æ®æºï¼Œæˆ‘ä»¬æƒ³ä½¿ç”¨çš„æ•°æ®éƒ½å®šä¹‰åœ¨æ­¤å¤„ï¼Œå”¯ä¸€æ•°æ®æºç¡®ä¿æˆ‘ä»¬çš„æ•°æ®æŒ‰ç…§æˆ‘ä»¬æƒ³è¦çš„æ–¹å¼å»å˜åŠ¨ï¼Œå¯ä»¥é€šè¿‡ store.state æ¥å–å¾—å†…éƒ¨æ•°æ®</p><h3 id="Getter"><a href="#Getter" class="headerlink" title="Getter"></a>Getter<hr></h3><p>store çš„è®¡ç®—å±æ€§ï¼Œå½“æˆ‘ä»¬éœ€è¦å¯¹ state çš„æ•°æ®è¿›è¡Œä¸€äº›å¤„ç†çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆåœ¨ getters é‡Œè¿›è¡Œæ“ä½œï¼Œå¤„ç†å®Œçš„æ•°æ®å¯ä»¥é€šè¿‡ store.getters æ¥è·å–ã€‚</p><h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action<hr></h3><p>Action ç±»ä¼¼äº mutationï¼Œä¸åŒåœ¨äºï¼š</p><p>Action é€šè¿‡ commit æ–¹æ³•æäº¤ mutationï¼Œè€Œä¸æ˜¯ç›´æ¥å˜æ›´çŠ¶æ€ã€‚<br>Action å¯ä»¥åŒ…å«ä»»æ„å¼‚æ­¥æ“ä½œã€‚<br>Action é€šè¿‡ store.dispatch(action) æ¥è§¦å‘äº‹ä»¶</p><h3 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation<hr></h3><p>æ›´æ”¹ Vuex çš„ store ä¸­çš„çŠ¶æ€çš„å”¯ä¸€æ–¹æ³•æ˜¯æäº¤ mutationï¼Œé¿å…æˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­è¦†ç›– state é€ æˆæ•°æ®ä¸¢å¤±ã€‚</p><p>æ¯ä¸ª mutation éƒ½æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²çš„ äº‹ä»¶ç±»å‹ (type) å’Œ ä¸€ä¸ª å›è°ƒå‡½æ•° (handler)</p><p>å¦‚æœæˆ‘ä»¬ç›´æ¥é€šè¿‡ store.state æ¥ä¿®æ”¹æ•°æ®ï¼Œvue ä¼šæŠ›å‡ºè­¦å‘Šï¼Œå¹¶æ— æ³•è§¦å‘ mutation çš„ä¿®æ”¹ã€‚</p><h3 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module<hr></h3><p>ç”±äºä½¿ç”¨å•ä¸€çŠ¶æ€æ ‘ï¼Œåº”ç”¨çš„æ‰€æœ‰çŠ¶æ€ä¼šé›†ä¸­åˆ°ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å¯¹è±¡ã€‚å½“åº”ç”¨å˜å¾—éå¸¸å¤æ‚æ—¶ï¼Œstore å¯¹è±¡å°±æœ‰å¯èƒ½å˜å¾—ç›¸å½“è‡ƒè‚¿ã€‚<br>ä¸ºäº†è§£å†³ä»¥ä¸Šé—®é¢˜ï¼ŒVuex å…è®¸æˆ‘ä»¬å°† store åˆ†å‰²æˆæ¨¡å—ï¼ˆmoduleï¼‰ã€‚æ¯ä¸ªæ¨¡å—æ‹¥æœ‰è‡ªå·±çš„ stateã€mutationã€actionã€getterã€ç”šè‡³æ˜¯åµŒå¥—å­æ¨¡å—â€”â€”ä»ä¸Šè‡³ä¸‹è¿›è¡ŒåŒæ ·æ–¹å¼çš„åˆ†å‰²ã€‚</p><p>è¿˜æœ‰ä¸€äº›å…¶ä»–è¾…åŠ©å‡½æ•°çš„æ¦‚å¿µåœ¨è¿™ä¸ªå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œæ¯ä¸ªåç§°çš„æ›´å…¨é¢çš„æ¦‚å¿µä»¥åŠ demo è¯·æŸ¥çœ‹ vuex<a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener">å®˜ç½‘</a>æ–‡æ¡£</p><h2 id="vuex-çš„æºç åˆ†æ"><a href="#vuex-çš„æºç åˆ†æ" class="headerlink" title="vuex çš„æºç åˆ†æ"></a>vuex çš„æºç åˆ†æ</h2><p>å…³äºä½¿ç”¨æˆ‘ç›¸ä¿¡å¤§å®¶éƒ½ä¼šbuç”¨è¿‡å¤šçš„ä»‹ç»ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡å¯¹æºç çš„åˆ†ææ¥äº†è§£ vuex çš„åŸç†æ›´æœ‰åˆ©äºæˆ‘ä»¬åœ¨æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨ï¼Œå‡ºç°é—®é¢˜èƒ½å¤Ÿæ›´æ¸…æ¥šçš„çŸ¥é“é—®é¢˜å‡ºåœ¨å“ªé‡Œ</p><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–<hr></h3><p>å½“æˆ‘ä»¬åœ¨ä»£ç ä¸­é€šè¿‡å¼•å…¥å¦‚ä¸‹ä»£ç çš„æ—¶å€™</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®é™…ä¸Šæ˜¯å¼•ç”¨ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå®šä¹‰åœ¨ <code>src/index.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Store<span class="token punctuation">,</span> install <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./store'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> mapState<span class="token punctuation">,</span> mapMutations<span class="token punctuation">,</span> mapGetters<span class="token punctuation">,</span> mapActions<span class="token punctuation">,</span> createNamespacedHelpers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./helpers'</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  Store<span class="token punctuation">,</span>  install<span class="token punctuation">,</span>  version<span class="token punctuation">:</span> <span class="token string">'__VERSION__'</span><span class="token punctuation">,</span>  mapState<span class="token punctuation">,</span>  mapMutations<span class="token punctuation">,</span>  mapGetters<span class="token punctuation">,</span>  mapActions<span class="token punctuation">,</span>  createNamespacedHelpers<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç çœ‹è§åœ¨å¼•ç”¨çš„æ—¶å€™å®é™…ä¸Šå°±æš´éœ²äº†å¾ˆå¤šæ–¹æ³•ä¹Ÿæ˜¯æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰å¹¶ä¸”ç»å¸¸ç”¨çš„ã€‚</p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨<hr></h3><p>å½“æˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ä»£ç çš„æ—¶å€™</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å’Œ vue-router ä¸€æ ·ï¼ŒVue.use æ–¹æ³•ä¼šæ³¨å…¥ä¸€ä¸ªæ’ä»¶ï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ install æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å®šä¹‰åœ¨ <code>src/store.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> install <span class="token punctuation">(</span>_Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Vue <span class="token operator">&amp;&amp;</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>        <span class="token string">'[vuex] already installed. Vue.use(Vuex) should be called only once.'</span>      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  Vue <span class="token operator">=</span> _Vue  <span class="token function">applyMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬çœ‹åˆ°å…¶å®å’Œvue-router å·®ä¸å¤šä¹Ÿæ˜¯åšäº†å‡ ä»¶äº‹æƒ…</p><ul><li>å¯¹ vue å¯¹è±¡åšæ ¡éªŒé˜²æ­¢é‡å¤å®‰è£…</li><li>å°† vue å¯¹è±¡ä¼ é€’åˆ°æœ¬åœ°ä¸­</li><li>è°ƒç”¨ applyMixin æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ applyMixin æ–¹æ³•ï¼Œå®šä¹‰åœ¨ <code>src/mixin.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> beforeCreate<span class="token punctuation">:</span> vuexInit <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// Vuex inité’©å­ï¼Œæ³¨å…¥åˆ°æ¯ä¸ªå®ä¾‹ init é’©å­åˆ—è¡¨</span>  <span class="token keyword">function</span> vuexInit <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options    <span class="token comment" spellcheck="true">// è¿›è¡Œä¾èµ–æ³¨å…¥</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>store <span class="token operator">===</span> <span class="token string">'function'</span>        <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">:</span> options<span class="token punctuation">.</span>store    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>parent <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬çŸ¥é“åœ¨æ‰§è¡Œ applyMixin çš„æ—¶å€™å®é™…ä¸Šå°±æ˜¯åœ¨ Vue beforeCreate ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°é‡Œæ‰§è¡Œäº† vuexInit æ–¹æ³•ï¼Œå°†å®ä¾‹åŒ–çš„ Store å¯¹è±¡æŒ‚è½½åˆ° $store ä¸Šã€‚</p><h3 id="Store-å®ä¾‹åŒ–"><a href="#Store-å®ä¾‹åŒ–" class="headerlink" title="Store å®ä¾‹åŒ–"></a>Store å®ä¾‹åŒ–<hr></h3><p>å½“æˆ‘ä»¬æ‰§è¡Œ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  actions<span class="token punctuation">,</span>  getters<span class="token punctuation">,</span>  state<span class="token punctuation">,</span>  mutations<span class="token punctuation">,</span>  modules  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬çœ‹åˆ°å®é™…ä¸Š Store å¯¹è±¡çš„æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªå¯¹è±¡å‚æ•°å®ƒåŒ…å« actionsã€gettersã€stateã€mutationsã€modules ç­‰ Vuex çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒå®šä¹‰åœ¨ <code>src/store.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span>options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰æŒ‚åœ¨æˆåŠŸ Vue è¿™é‡Œé¢è‡ªåŠ¨åœ¨ window ä¸ŠæŒ‚è½½ Vue</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Vue <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">install</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span>      plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      strict <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span> <span class="token operator">=</span> options    <span class="token comment" spellcheck="true">// store çš„å†…éƒ¨çŠ¶æ€</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_actions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_mutations <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_wrappedGetters <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_modules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleCollection</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_modulesNamespaceMap <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_subscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_watcherVM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// ç»‘å®šã€æäº¤å’Œåˆ†å‘</span>    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> commit <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token keyword">function</span> boundDispatch <span class="token punctuation">(</span>type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> dispatch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>commit <span class="token operator">=</span> <span class="token keyword">function</span> boundCommit <span class="token punctuation">(</span>type<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> commit<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ä¸¥æ ¼æ¨¡å¼</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>strict <span class="token operator">=</span> strict    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">.</span>state    <span class="token comment" spellcheck="true">// åˆå§‹åŒ–æ¨¡å—ï¼Œé€’å½’åœ°æ³¨å†Œæ‰€æœ‰çš„å­æ¨¡å—ï¼Œå¹¶åœ¨ this. _wrappedge ä¸­æ”¶é›†æ‰€æœ‰çš„æ¨¡å— getter</span>    <span class="token function">installModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// åˆå§‹åŒ–è´Ÿè´£å“åº”çš„å­˜å‚¨vm(ä¹Ÿå°† _wrappedgeas ç™»è®°ä¸ºè®¡ç®—å±æ€§)</span>    <span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// apply plugins</span>    plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>plugin <span class="token operator">=</span><span class="token operator">></span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> useDevtools <span class="token operator">=</span> options<span class="token punctuation">.</span>devtools <span class="token operator">!==</span> undefined <span class="token operator">?</span> options<span class="token punctuation">.</span>devtools <span class="token punctuation">:</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>devtools    <span class="token keyword">if</span> <span class="token punctuation">(</span>useDevtools<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">devtoolPlugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢ä»£ç ä¸»è¦æ˜¯æ‰§è¡Œäº†ä»¥ä¸‹è¿‡ç¨‹</p><ul><li>å¦‚æœæ²¡æœ‰ä¼ å…¥ Vueï¼Œé‚£ä¹ˆè‡ªåŠ¨å®‰è£…ä¸€ä¸‹æ’ä»¶</li><li>åˆå§‹åŒ–æ¨¡å—ã€å®‰è£…æ¨¡å—æ”¶é›†æ‰€æœ‰æ¨¡å—çš„ getter</li><li>åˆå§‹åŒ– store._vm</li></ul><h3 id="è·å–æ¨¡å—"><a href="#è·å–æ¨¡å—" class="headerlink" title="è·å–æ¨¡å—"></a>è·å–æ¨¡å—<hr></h3><p>ç”±äºä½¿ç”¨å•ä¸€çŠ¶æ€æ ‘ï¼Œåº”ç”¨çš„æ‰€æœ‰çŠ¶æ€ä¼šé›†ä¸­åˆ°ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å¯¹è±¡ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å°† store åˆ†å‰²æˆæ¨¡å—ï¼ˆmoduleï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ‹¥æœ‰è‡ªå·±çš„ stateã€mutationã€actionã€getterï¼Œç”šè‡³æ˜¯åµŒå¥—å­æ¨¡å—ã€‚å¦‚ä¸‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> moduleA <span class="token operator">=</span> <span class="token punctuation">{</span>  state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  getters<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">const</span> moduleB <span class="token operator">=</span> <span class="token punctuation">{</span>  state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  getters<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  modules<span class="token punctuation">:</span> <span class="token punctuation">{</span>    a<span class="token punctuation">:</span> moduleA<span class="token punctuation">,</span>    b<span class="token punctuation">:</span> moduleB  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>a <span class="token comment" spellcheck="true">// -> moduleA çš„çŠ¶æ€</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>b <span class="token comment" spellcheck="true">// -> moduleB çš„çŠ¶æ€</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬æ‰“å¼€ <code>module/module-collection.js</code> æ–‡ä»¶ï¼Œæ‰¾åˆ° ModuleCollection ç±»</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ModuleCollection</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span>rawRootModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rawRootModule<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢æ‰§è¡Œäº† register æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js">register <span class="token punctuation">(</span>path<span class="token punctuation">,</span> rawModule<span class="token punctuation">,</span> runtime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> newModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> newModule  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newModule<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">forEachValue</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span>rawChildModule<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> rawChildModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>register æ¥æ”¶ 3 ä¸ªå‚æ•°</p><ul><li>path è¡¨ç¤ºè·¯å¾„ï¼Œå› ä¸ºæˆ‘ä»¬æ•´ä½“ç›®æ ‡æ˜¯è¦æ„å»ºä¸€é¢—æ¨¡å—æ ‘ï¼Œpath æ˜¯åœ¨æ„å»ºæ ‘çš„è¿‡ç¨‹ä¸­ç»´æŠ¤çš„è·¯å¾„</li><li>rawModule è¡¨ç¤ºå®šä¹‰æ¨¡å—çš„é…ç½®é¡¹</li><li>runtime è¡¨ç¤ºæ˜¯å¦æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶åˆ›å»ºçš„æ¨¡å—</li></ul><p>ä¸Šé¢å®é™…ä¸Šæ³¨å†Œäº† Module çš„å®ä¾‹ï¼ŒModule æ˜¯ç”¨æ¥æè¿°å•ä¸ªæ¨¡å—çš„ç±»ï¼Œå®ƒçš„å®šä¹‰åœ¨ <code>src/module/module.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span>rawModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>runtime <span class="token operator">=</span> runtime    <span class="token keyword">this</span><span class="token punctuation">.</span>_children <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_rawModule <span class="token operator">=</span> rawModule    <span class="token keyword">const</span> rawState <span class="token operator">=</span> rawModule<span class="token punctuation">.</span>state    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> rawState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">rawState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> rawState<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äºæ¯ä¸€ä¸ªæ¨¡å—è€Œè¨€ï¼Œ_children æ˜¯è¯¥æ¨¡å—çš„å­æ¨¡å—ï¼Œ_rawModule æ˜¯è¯¥æ¨¡å—çš„é…ç½®ï¼Œstate æ˜¯è¯¥æ¨¡å—çš„ stateã€‚</p><p>å›åˆ° registerï¼Œé‚£ä¹ˆåœ¨å®ä¾‹åŒ–ä¸€ä¸ª Module åï¼Œåˆ¤æ–­å½“å‰çš„ path çš„é•¿åº¦å¦‚æœä¸º 0ï¼Œåˆ™è¯´æ˜å®ƒæ˜¯ä¸€ä¸ªæ ¹æ¨¡å—ï¼Œæ‰€ä»¥æŠŠ newModule èµ‹å€¼ç»™äº† this.root</p><p>æ¥ç€åˆ¤æ–­æ˜¯å¦æœ‰ modules é¡¹ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ‰§è¡Œä¸‹é¢ä»£ç </p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">forEachValue</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span>rawChildModule<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> rawChildModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç ä¸»è¦æ˜¯éå† modulesï¼Œé€’å½’è°ƒç”¨ register æ–¹æ³•ï¼Œå°†é…ç½®é¡¹é‡Œçš„ modules çš„ key ä½œä¸ºè·¯å¾„ä¿å­˜åˆ° path ä¸­ï¼Œä¼ å…¥å­ module å’Œåˆ›å»ºçŠ¶æ€ã€‚</p><p>å¦‚æœ path çš„é•¿åº¦ä¸ä¸º 0ï¼Œé‚£ä¹ˆæ‰§è¡Œä»¥ä¸‹ä»£ç å»ºç«‹çˆ¶å­å…³ç³»</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newModule<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä¸Šé¢è°ƒç”¨äº† get</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">get</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> module<span class="token punctuation">.</span><span class="token function">getChild</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆè·å–çˆ¶æ¨¡å—ï¼Œè¿™é‡Œé€šè¿‡ get æ–¹æ³•ä¸­çš„ reduce æ–¹æ³•ä¸€å±‚å±‚å»æ‰¾åˆ°å¯¹åº”çš„æ¨¡å—ï¼ŒæŸ¥æ‰¾çš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œçš„æ˜¯ module.getChild(key) æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js">getChild <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_children<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¿”å›å½“å‰æ¨¡å—çš„ _children ä¸­å¯¹åº” key çš„æ¨¡å—ï¼Œé‚£ä¹ˆæ¯ä¸ªæ¨¡å—å½“ä¸­çš„ key æ˜¯å¦‚ä½•æ·»åŠ çš„å‘¢</p><pre class="line-numbers language-js"><code class="language-js">addChild <span class="token punctuation">(</span>key<span class="token punctuation">,</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_children<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¯¹äº root module çš„ä¸‹ä¸€å±‚ modules æ¥è¯´ï¼Œå®ƒä»¬çš„ parent å°±æ˜¯ root moduleï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šè¢«æ·»åŠ çš„ root module çš„ _children ä¸­ã€‚æ¯ä¸ªå­æ¨¡å—é€šè¿‡è·¯å¾„æ‰¾åˆ°å®ƒçš„çˆ¶æ¨¡å—ï¼Œç„¶åé€šè¿‡çˆ¶æ¨¡å—çš„ addChild æ–¹æ³•å»ºç«‹çˆ¶å­å…³ç³»ï¼Œé€’å½’æ‰§è¡Œè¿™æ ·çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆå°±å»ºç«‹ä¸€é¢—å®Œæ•´çš„æ¨¡å—æ ‘ã€‚</p><h3 id="å®‰è£…æ¨¡å—"><a href="#å®‰è£…æ¨¡å—" class="headerlink" title="å®‰è£…æ¨¡å—"></a>å®‰è£…æ¨¡å—</h3><p>å½“æˆ‘ä»¬æ„å»ºå¥½æ¨¡å—æ ‘ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦å»å®‰è£…è¿™äº›æ¨¡å—äº†ï¼Œçœ‹ä¸€ä¸‹ installModule æ–¹æ³•ä»£ç å¦‚ä¸‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> installModule <span class="token punctuation">(</span>store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">,</span> module<span class="token punctuation">,</span> hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isRoot <span class="token operator">=</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>length  <span class="token keyword">const</span> namespace <span class="token operator">=</span> store<span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// æ³¨å†Œå‘½åç©ºé—´ map</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>namespaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_modulesNamespaceMap<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[vuex] duplicate namespace </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>namespace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> for the namespaced module </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    store<span class="token punctuation">.</span>_modulesNamespaceMap<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> module  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// è·å–çˆ¶æ¨¡å—çš„ stateï¼Œè·å–å½“å‰æ¨¡å—çš„åç§°ï¼Œé€šè¿‡ Vue.set å°†å½“å‰æ¨¡å—çš„ state æŒ‚è½½åˆ°çˆ¶æ¨¡å—ä¸Šï¼Œkey æ˜¯æ¨¡å—åç§°ã€‚</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> parentState <span class="token operator">=</span> <span class="token function">getNestedState</span><span class="token punctuation">(</span>rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> moduleName <span class="token operator">=</span> path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>    store<span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      Vue<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>parentState<span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> module<span class="token punctuation">.</span>state<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// é€šè¿‡ makeLocalContext æ–¹æ³•åˆ›å»ºæœ¬åœ°ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œæ¥æ”¶ storeï¼ˆroot storeï¼‰ã€namespaceï¼ˆæ¨¡å—å‘½åç©ºé—´ï¼‰ã€pathï¼ˆæ¨¡å—è·¯å¾„ï¼‰ ä¸‰ä¸ªå‚æ•°</span>  <span class="token keyword">const</span> local <span class="token operator">=</span> module<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">makeLocalContext</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> path<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// è°ƒç”¨ registerMutation æ–¹æ³•è¿›è¡Œ Mutations æ³¨å†Œ</span>  module<span class="token punctuation">.</span><span class="token function">forEachMutation</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutation<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key    <span class="token function">registerMutation</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> mutation<span class="token punctuation">,</span> local<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// è°ƒç”¨ registerAction æ–¹æ³•è¿›è¡Œ Actions æ³¨å†Œ</span>  module<span class="token punctuation">.</span><span class="token function">forEachAction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> type <span class="token operator">=</span> action<span class="token punctuation">.</span>root <span class="token operator">?</span> key <span class="token punctuation">:</span> namespace <span class="token operator">+</span> key    <span class="token keyword">const</span> handler <span class="token operator">=</span> action<span class="token punctuation">.</span>handler <span class="token operator">||</span> action    <span class="token function">registerAction</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// è°ƒç”¨ registerGetter æ–¹æ³•è¿›è¡Œ Getter æ³¨å†Œ</span>  module<span class="token punctuation">.</span><span class="token function">forEachGetter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key    <span class="token function">registerGetter</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> getter<span class="token punctuation">,</span> local<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// å¼€å§‹éå†æ¨¡å—çš„å­æ¨¡å—ï¼Œç„¶åé€’å½’å®‰è£…ã€‚</span>  module<span class="token punctuation">.</span><span class="token function">forEachChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">installModule</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> hot<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„é€»è¾‘å°±æ˜¯åˆå§‹åŒ– stateã€gettersã€mutationsã€actionsï¼Œè¿™é‡Œæœ‰ 5 ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä»£è¡¨</p><ul><li>storeï¼šroot store</li><li>rootStateï¼šroot state</li><li>pathï¼šæ¨¡å—è®¿é—®è·¯å¾„</li><li>moduleï¼šå½“å‰æ¨¡å—</li><li>hotï¼šæ˜¯å¦çƒ­æ›´æ–°</li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¨¡å—å†…éƒ¨çš„ actionã€mutation å’Œ getter æ˜¯æ³¨å†Œåœ¨å…¨å±€å‘½åç©ºé—´çš„â€”â€”è¿™æ ·ä½¿å¾—å¤šä¸ªæ¨¡å—èƒ½å¤Ÿå¯¹åŒä¸€ mutation æˆ– action ä½œå‡ºå“åº”ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›æ¨¡å—å…·æœ‰æ›´é«˜çš„å°è£…åº¦å’Œå¤ç”¨æ€§ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ  namespaced: true çš„æ–¹å¼ä½¿å…¶æˆä¸ºå¸¦å‘½åç©ºé—´çš„æ¨¡å—ã€‚å½“æ¨¡å—è¢«æ³¨å†Œåï¼Œå®ƒçš„æ‰€æœ‰ getterã€action åŠ mutation éƒ½ä¼šè‡ªåŠ¨æ ¹æ®æ¨¡å—æ³¨å†Œçš„è·¯å¾„è°ƒæ•´å‘½åã€‚ä¾‹å¦‚ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  modules<span class="token punctuation">:</span> <span class="token punctuation">{</span>    account<span class="token punctuation">:</span> <span class="token punctuation">{</span>      namespaced<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// æ¨¡å—å†…å®¹ï¼ˆmodule assetsï¼‰</span>      state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// æ¨¡å—å†…çš„çŠ¶æ€å·²ç»æ˜¯åµŒå¥—çš„äº†ï¼Œä½¿ç”¨ `namespaced` å±æ€§ä¸ä¼šå¯¹å…¶äº§ç”Ÿå½±å“</span>      getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>        isAdmin <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> getters['account/isAdmin']</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>        login <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> dispatch('account/login')</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>        login <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> commit('account/login')</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// åµŒå¥—æ¨¡å—</span>      modules<span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ç»§æ‰¿çˆ¶æ¨¡å—çš„å‘½åç©ºé—´</span>        myPage<span class="token punctuation">:</span> <span class="token punctuation">{</span>          state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>          getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>            profile <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> getters['account/profile']</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// è¿›ä¸€æ­¥åµŒå¥—å‘½åç©ºé—´</span>        posts<span class="token punctuation">:</span> <span class="token punctuation">{</span>          namespaced<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>          state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>          getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>            popular <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> getters['account/posts/popular']</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å›åˆ° installModule æ–¹æ³•ï¼Œç¬¬ä¸€æ­¥æ ¹æ® path è·å– namespace</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> namespace <span class="token operator">=</span> store<span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>getNamespace çš„å®šä¹‰åœ¨ src/module/module-collection.js ä¸­</p><pre class="line-numbers language-js"><code class="language-js">getNamespace <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>root  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    module <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">getChild</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>    <span class="token keyword">return</span> namespace <span class="token operator">+</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>namespaced <span class="token operator">?</span> key <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä» root module å¼€å§‹ï¼Œé€šè¿‡ reduce æ–¹æ³•ä¸€å±‚å±‚æ‰¾å­æ¨¡å—ï¼Œå¦‚æœå‘ç°è¯¥æ¨¡å—é…ç½®äº† namespaced ä¸º trueï¼Œåˆ™æŠŠè¯¥æ¨¡å—çš„ key æ‹¼åˆ° namesapce ä¸­ï¼Œæœ€ç»ˆè¿”å›å®Œæ•´çš„ namespace å­—ç¬¦ä¸²</p><p>ä¸ºäº†æ–¹ä¾¿ä»¥åèƒ½æ ¹æ® namespace æŸ¥æ‰¾æ¨¡å—æ‰§è¡Œä»¥ä¸‹æ–¹æ³•æŠŠ namespace å¯¹åº”çš„æ¨¡å—ä¿å­˜ä¸‹æ¥</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>namespaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>  store<span class="token punctuation">.</span>_modulesNamespaceMap<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç¬¬äºŒæ­¥æ ¹æ® !isRoot &amp;&amp; !hot æ¥è·å–æ¨¡å—çš„åç§°ã€state ç­‰</p><p>ä» root state å¼€å§‹ï¼Œé€šè¿‡ path.reduce æ–¹æ³•ä¸€å±‚å±‚æŸ¥æ‰¾å­æ¨¡å— stateï¼Œæœ€ç»ˆæ‰¾åˆ°ç›®æ ‡æ¨¡å—çš„ stateã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> getNestedState <span class="token punctuation">(</span>state<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> path<span class="token punctuation">.</span>length    <span class="token operator">?</span> path<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> state<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>    <span class="token punctuation">:</span> state<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬ä¸‰æ­¥é€šè¿‡ makeLocalContext æ–¹æ³•åˆ›å»ºæœ¬åœ°ä¸Šä¸‹æ–‡ç¯å¢ƒ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> local <span class="token operator">=</span> module<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">makeLocalContext</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> makeLocalContext <span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> noNamespace <span class="token operator">=</span> namespace <span class="token operator">===</span> <span class="token string">''</span>  <span class="token keyword">const</span> local <span class="token operator">=</span> <span class="token punctuation">{</span>    dispatch<span class="token punctuation">:</span> noNamespace <span class="token operator">?</span> store<span class="token punctuation">.</span>dispatch <span class="token punctuation">:</span> <span class="token punctuation">(</span>_type<span class="token punctuation">,</span> _payload<span class="token punctuation">,</span> _options<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">unifyObjectStyle</span><span class="token punctuation">(</span>_type<span class="token punctuation">,</span> _payload<span class="token punctuation">,</span> _options<span class="token punctuation">)</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> payload<span class="token punctuation">,</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> args      <span class="token keyword">let</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> args      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options <span class="token operator">||</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>        type <span class="token operator">=</span> namespace <span class="token operator">+</span> type        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[vuex] unknown local action type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, global type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>          <span class="token keyword">return</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    commit<span class="token punctuation">:</span> noNamespace <span class="token operator">?</span> store<span class="token punctuation">.</span>commit <span class="token punctuation">:</span> <span class="token punctuation">(</span>_type<span class="token punctuation">,</span> _payload<span class="token punctuation">,</span> _options<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">unifyObjectStyle</span><span class="token punctuation">(</span>_type<span class="token punctuation">,</span> _payload<span class="token punctuation">,</span> _options<span class="token punctuation">)</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> payload<span class="token punctuation">,</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> args      <span class="token keyword">let</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> args      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options <span class="token operator">||</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>        type <span class="token operator">=</span> namespace <span class="token operator">+</span> type        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[vuex] unknown local mutation type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, global type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>          <span class="token keyword">return</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// getters and state object must be gotten lazily</span>  <span class="token comment" spellcheck="true">// because they will be changed by vm update</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>local<span class="token punctuation">,</span> <span class="token punctuation">{</span>    getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> noNamespace        <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> store<span class="token punctuation">.</span>getters        <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">makeLocalGetters</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    state<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">getNestedState</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>state<span class="token punctuation">,</span> path<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> local<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ²¡æœ‰å‘½åç©ºé—´çš„æƒ…å†µå°±æ˜¯ç›´æ¥ä½¿ç”¨ root store ä¸Šçš„ dispatch å’Œ commit æ–¹æ³•ï¼Œå¦åˆ™ä½¿ç”¨æ–°å®šä¹‰çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°</p><ul><li>_typeï¼šdispatchã€commit çš„ type</li><li>_payloadï¼šæäº¤çš„å‚æ•°</li><li>_optionsï¼šå…¶ä»–é€‰é¡¹ï¼Œä¾‹å¦‚ { root: true } è¿™ä¸ªåœ¨å­æ¨¡å—æ´¾å‘åˆ°æ ¹ä»“åº“çš„é…ç½®é¡¹</li></ul><p>æŠŠ type è‡ªåŠ¨æ‹¼æ¥ä¸Š namespaceï¼Œç„¶åæ‰§è¡Œ store ä¸Šå¯¹åº”çš„æ–¹æ³•ã€‚</p><p>å¯¹äº getters è€Œè¨€ï¼Œå¦‚æœæ²¡æœ‰ namespaceï¼Œåˆ™ç›´æ¥è¿”å› root store çš„ gettersï¼Œå¦åˆ™è¿”å› makeLocalGetters(store, namespace) çš„è¿”å›å€¼</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> makeLocalGetters <span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> gettersProxy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// è·å–äº† namespace çš„é•¿åº¦</span>  <span class="token keyword">const</span> splitPos <span class="token operator">=</span> namespace<span class="token punctuation">.</span>length  <span class="token comment" spellcheck="true">// éå† root store ä¸‹çš„æ‰€æœ‰ getters</span>  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>type <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­å®ƒçš„ç±»å‹æ˜¯å¦åŒ¹é… namespace,ä¸åŒ¹é…ç›´æ¥ç»“æŸ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> splitPos<span class="token punctuation">)</span> <span class="token operator">!==</span> namespace<span class="token punctuation">)</span> <span class="token keyword">return</span>    <span class="token comment" spellcheck="true">// è·å–æœ¬åœ° typeï¼Œä¹Ÿå°±æ˜¯ getNumberPlusOne</span>    <span class="token keyword">const</span> localType <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>splitPos<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// ç”¨ Object.defineProperty å®šä¹‰äº† gettersProxyï¼Œè·å– localType å®é™…ä¸Šå°±æ˜¯è®¿é—®äº† store.getters[type]</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>gettersProxy<span class="token punctuation">,</span> localType<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> store<span class="token punctuation">.</span>getters<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span>      enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// è®¿é—®ä»£ç†å¯¹è±¡</span>  <span class="token keyword">return</span> gettersProxy<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬å››æ­¥æ³¨å†Œ Mutations</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">forEachMutation</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutation<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key  <span class="token function">registerMutation</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> mutation<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">function</span> registerMutation <span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  entry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> wrappedMutationHandler <span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>    handler<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> local<span class="token punctuation">.</span>state<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡éå† module ä¸‹çš„æ¯ä¸€ä¸ª mutations å±æ€§çš„å€¼ï¼Œç„¶åè·å–å¸¦æœ‰å‘½åç©ºé—´çš„ typeï¼Œå†è°ƒç”¨ registerMutation æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼Œè¯¥æ–¹æ³•å®é™…ä¸Šå°±æ˜¯ç»™ root store ä¸Šçš„ _mutations[types] æ·»åŠ  wrappedMutationHandler æ–¹æ³•ï¼Œä»è€Œå…è®¸æˆ‘ä»¬ä¸€ä¸ª type å¯¹åº”å¤šä¸ª mutaionsã€‚</p><p>ç¬¬äº”æ­¥æ³¨å†Œ Actions</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">forEachAction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> type <span class="token operator">=</span> action<span class="token punctuation">.</span>root <span class="token operator">?</span> key <span class="token punctuation">:</span> namespace <span class="token operator">+</span> key  <span class="token keyword">const</span> handler <span class="token operator">=</span> action<span class="token punctuation">.</span>handler <span class="token operator">||</span> action  <span class="token function">registerAction</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">function</span> registerAction <span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  entry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> wrappedActionHandler <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> res <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">{</span>      dispatch<span class="token punctuation">:</span> local<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span>      commit<span class="token punctuation">:</span> local<span class="token punctuation">.</span>commit<span class="token punctuation">,</span>      getters<span class="token punctuation">:</span> local<span class="token punctuation">.</span>getters<span class="token punctuation">,</span>      state<span class="token punctuation">:</span> local<span class="token punctuation">.</span>state<span class="token punctuation">,</span>      rootGetters<span class="token punctuation">:</span> store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span>      rootState<span class="token punctuation">:</span> store<span class="token punctuation">.</span>state    <span class="token punctuation">}</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> cb<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPromise</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      res <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_devtoolHook<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        store<span class="token punctuation">.</span>_devtoolHook<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'vuex:error'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">throw</span> err      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> res    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡éå†æ¨¡å—ä¸­çš„ actions æ‹¿åˆ°æ¯ä¸€ä¸ª action å’Œ keyã€‚åˆ¤æ–­ action.rootï¼Œå¦‚æœå¦çš„æƒ…å†µæŠŠ key æ‹¼æ¥ä¸Š namespaceï¼Œç„¶åæ‰§è¡Œ registerAction æ–¹æ³•ã€‚registerAction æ¥æ”¶å››ä¸ªå‚æ•°</p><ul><li>storeï¼šstore å®ä¾‹</li><li>namespacedTypeï¼šå¸¦å‘½åç©ºé—´çš„ type</li><li>handlerï¼šå›è°ƒå‡½æ•°</li><li>localï¼šä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œroot ä¸º storeï¼Œmodule ä¸º local</li></ul><p>å¯ä»¥çœ‹åˆ° actions å›è°ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº† dispatchã€commitã€gettersã€stateã€rootGettersã€rootState å­—æ®µï¼Œæœ€å actions é‡Œé€šè¿‡ Promise çš„å¼‚æ­¥è¿‡ç¨‹ï¼Œåˆ¤æ–­ res çš„ç±»å‹è¿”å›å¯¹åº”çš„å€¼</p><p>ç¬¬äº”æ­¥æ³¨å†Œ Getters</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">forEachGetter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key  <span class="token function">registerGetter</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> getter<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">function</span> registerGetter <span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> rawGetter<span class="token punctuation">,</span> local<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_wrappedGetters<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[vuex] duplicate getter key: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  store<span class="token punctuation">.</span>_wrappedGetters<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> wrappedGetter <span class="token punctuation">(</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">rawGetter</span><span class="token punctuation">(</span>      local<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// local state</span>      local<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// local getters</span>      store<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// root state</span>      store<span class="token punctuation">.</span>getters <span class="token comment" spellcheck="true">// root getters</span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡éå†æ¨¡å—ä¸­çš„ getters çš„å®šä¹‰ï¼Œæ‹¿åˆ°æ¯ä¸€ä¸ª getter å’Œ keyï¼Œå¹¶æŠŠ key æ‹¼æ¥ä¸Š namespaceï¼Œç„¶åæ‰§è¡Œ registerGetter æ–¹æ³•ã€‚registerGetter é¦–å…ˆé€šè¿‡ store._wrappedGetters[type] æ–¹æ³• åˆ¤æ–­ getter key é‡å¤æ˜¯å¦é‡å¤ï¼Œæ¥ç€åœ¨ _wrappedGetters ä¸Šä»¥ type ä¸º keyï¼ŒæŒ‚è½½ wrappedGetter å‡½æ•°ï¼Œè¿”å› rawGetters å‡½æ•°æ‰§è¡Œçš„ç»“æœã€‚</p><p>ç¬¬å…­æ­¥å®‰è£…å­æ¨¡å—</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">forEachChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">installModule</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> hot<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¾ˆç®€å•å°±æ˜¯é€’å½’å®‰è£…çš„è¿‡ç¨‹</p><p>ä»¥ä¸Šå°±æ˜¯ installModule å‡½æ•°çš„ä½œç”¨è¿›è¡Œ stateã€gettersã€actionsã€mutations ç­‰æ¨¡å—çš„åˆå§‹åŒ–å’Œå®‰è£…å·¥ä½œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ Store å®ä¾‹åŒ–çš„æœ€åä¸€æ­¥ï¼Œå°±æ˜¯æ‰§è¡Œåˆå§‹åŒ– store._vm çš„é€»è¾‘</p><h3 id="åˆå§‹åŒ–-store-vm"><a href="#åˆå§‹åŒ–-store-vm" class="headerlink" title="åˆå§‹åŒ– store._vm"></a>åˆå§‹åŒ– store._vm<hr></h3><p>å…¥å£æ˜¯</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®šä¹‰</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> resetStoreVM <span class="token punctuation">(</span>store<span class="token punctuation">,</span> state<span class="token punctuation">,</span> hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> oldVm <span class="token operator">=</span> store<span class="token punctuation">.</span>_vm  <span class="token comment" spellcheck="true">// å»ºç«‹ getters å’Œ state çš„è”ç³»</span>  store<span class="token punctuation">.</span>getters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">const</span> wrappedGetters <span class="token operator">=</span> store<span class="token punctuation">.</span>_wrappedGetters  <span class="token keyword">const</span> computed <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// æ‰§è¡Œ computed[key] å¯¹åº”çš„å‡½æ•°çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œ rawGetter(local.state,...) æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šè®¿é—®åˆ° store.stateï¼Œè¿›è€Œè®¿é—®åˆ° store._vm._data.$$stateï¼Œè¿™æ ·å°±å»ºç«‹äº†ä¸€ä¸ªä¾èµ–å…³ç³»ã€‚å½“ store.state å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¸‹ä¸€æ¬¡å†è®¿é—® store.getters çš„æ—¶å€™ä¼šé‡æ–°è®¡ç®—ã€‚</span>  <span class="token function">forEachValue</span><span class="token punctuation">(</span>wrappedGetters<span class="token punctuation">,</span> <span class="token punctuation">(</span>fn<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//ä½¿ç”¨ computed æ¥åˆ©ç”¨å…¶å»¶è¿Ÿç¼“å­˜æœºåˆ¶</span>    computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">fn</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> store<span class="token punctuation">.</span>_vm<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>      enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// for local getters</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ä½¿ç”¨ä¸€ä¸ªVueå®ä¾‹æ¥å­˜å‚¨çŠ¶æ€æ ‘æŠ‘åˆ¶è­¦å‘Šï¼Œä»¥é˜²ç”¨æˆ·æ·»åŠ äº†ä¸€äº›å¥‡æ€ªçš„å…¨å±€æ··åˆ</span>  <span class="token keyword">const</span> silent <span class="token operator">=</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>silent  Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>silent <span class="token operator">=</span> <span class="token boolean">true</span>  <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–ä¸€ä¸ª Vue å®ä¾‹ store._vmï¼Œå¹¶æŠŠ computed è¿›å»</span>  store<span class="token punctuation">.</span>_vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>      $$state<span class="token punctuation">:</span> state    <span class="token punctuation">}</span><span class="token punctuation">,</span>    computed  <span class="token punctuation">}</span><span class="token punctuation">)</span>  Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>silent <span class="token operator">=</span> silent  <span class="token comment" spellcheck="true">// ä¸ºæ–°vmå¯ç”¨ä¸¥æ ¼æ¨¡å¼</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>strict<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">enableStrictMode</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVm<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å°†æ‰€æœ‰è®¢é˜…çš„è§‚å¯Ÿè€…çš„æ›´æ”¹å‘é€åˆ°å¼ºåˆ¶ getter é‡æ–°è¯„ä¼°ä»¥ä¾¿çƒ­é‡è½½</span>      <span class="token comment" spellcheck="true">// store._vm ä¼šæ·»åŠ ä¸€ä¸ª wathcer æ¥è§‚æµ‹ this._data.$$state çš„å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯å½“ store.state è¢«ä¿®æ”¹çš„æ—¶å€™, store._committing å¿…é¡»ä¸º trueï¼Œå¦åˆ™åœ¨å¼€å‘é˜¶æ®µä¼šæŠ¥è­¦å‘Š</span>      store<span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        oldVm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state <span class="token operator">=</span> <span class="token keyword">null</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> oldVm<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ–¹æ³•çš„ä¸»è¦æ˜¯å°† state ä¸ getters å»ºç«‹å¥½å…³ç³»ï¼Œå®ä¾‹åŒ–ä¸€ä¸ª Vue æŒ‚è½½åˆ° _vm å±æ€§ä¸Šï¼Œé€šè¿‡ computed å±æ€§å°† getters ä¸ state å…³è”èµ·æ¥å¹¶ç¼“å­˜ç»“æœã€‚</p><h3 id="è¾…åŠ©å‡½æ•°è¿‡ç¨‹åˆ†æ"><a href="#è¾…åŠ©å‡½æ•°è¿‡ç¨‹åˆ†æ" class="headerlink" title="è¾…åŠ©å‡½æ•°è¿‡ç¨‹åˆ†æ"></a>è¾…åŠ©å‡½æ•°è¿‡ç¨‹åˆ†æ<hr></h3><p>å½“ç„¶è¿˜æœ‰å¾ˆå¤š API çš„åˆ†æè¿‡ç¨‹æ¯”å¦‚æ€ä¹ˆæ‰§è¡Œçš„ commitã€dispatchï¼ŒmapState å’Œ mapGettersã€mapMutationsã€mapActions ç­‰è¾…åŠ©å‡½æ•°çš„å®ç°</p><p>æˆ‘ä»¬å¯ä»¥çœ‹ <a href="https://ustbhuangyi.github.io/vue-analysis/vuex/api.html#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a>ä¸­å…³äºè¿™äº›çš„è®²äº›</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨macä¸­é…ç½®å¤šä¸ªgithubè´¦å·sshå¯†é’¥</title>
      <link href="/2018/08/10/linux/git/"/>
      <url>/2018/08/10/linux/git/</url>
      
        <content type="html"><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>å¾ˆå¤šæ—¶å€™æˆ‘ä»¬æœ¬åœ°ç”Ÿæˆçš„åªæœ‰ä¸€ä¸ªè‡ªå·±çš„sshï¼Œä½†æ˜¯å¤šä¸ªsshé…ç½®çš„åœºæ™¯ä¹Ÿæ˜¯è›®å¤šçš„ï¼Œæ‰€ä»¥æƒ³è¦commitï¼Œpushç­‰æ“ä½œéœ€è¦é…ç½®ç§é’¥sshæˆ–è€…httpï¼Œæ‰èƒ½è¿æ¥è¿œç¨‹gitä»“åº“</p><h3 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><p>æˆ‘ä»¬å‡è®¾åŸæ¥åœ¨~/.sshç›®å½•ä¸‹å·²ç»ç”Ÿæˆäº†ä¸€å¯¹å¯†é’¥,æ­¤å¯†é’¥æ–‡ä»¶åå­—æ˜¯é»˜è®¤ç”Ÿæˆ</p><pre><code>id_rsaid_rsa.pub</code></pre><p>ç”Ÿæˆç¬¬äºŒä¸ªssh key</p><pre><code>ssh-keygen -t rsa -C &quot;yourmail@gmail.com&quot;</code></pre><p>è¿™é‡Œé¢ä¸è¦ä¸€è·¯å›è½¦ï¼Œç¬¬ä¸€æ­¥éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å¡«å†™ä¿å­˜æ–‡ä»¶çš„åå­—å’Œè·¯å¾„</p><pre><code>Generating public/private rsa key pair.Enter file in which to save the key (/Users/renbo/.ssh/id_rsa): /Users/renbo/.ssh/id_rsa_github&lt;å‰©ä¸‹ä¸¤ä¸ªç›´æ¥å›è½¦&gt;</code></pre><p>è¿™é‡Œæˆ‘ä»¬ç”¨id_rsa_githubæ¥åŒºåˆ«åŸæœ‰å¯†é’¥å¯¹ï¼Œé¿å…è¢«è¦†ç›–ã€‚<br>å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°~/.sshç›®å½•ä¸‹å¤šäº†ä¸¤ä¸ªæ–‡ä»¶ï¼Œå˜æˆï¼š</p><pre><code>id_rsaid_ras.pubid_rsa_githubid_rsa_github.pubknown_hosts</code></pre><p>æ‰“å¼€ssh-agent(å…³äºssh-agentåç»­ä»‹ç»)</p><p>è¿™é‡Œå¦‚æœä½ ç”¨çš„githubå®˜æ–¹çš„bashï¼Œç”¨ï¼š</p><pre><code>ssh-agent -s</code></pre><p>å¦‚æœæ˜¯å…¶ä»–çš„ï¼Œæ¯”å¦‚msysgitï¼Œç”¨ï¼š</p><pre><code>eval $(ssh-agent -s)</code></pre><p>ç•¥è¿‡è¿™ä¸€æ­¥çš„è¯ï¼Œä¸‹ä¸€æ­¥ä¼šæç¤ºè¿™æ ·çš„é”™è¯¯ï¼šCould not open a connection to your authentication agent.</p><h3 id="æ·»åŠ ç§é’¥"><a href="#æ·»åŠ ç§é’¥" class="headerlink" title="æ·»åŠ ç§é’¥"></a>æ·»åŠ ç§é’¥</h3><pre><code>ssh-add ~/.ssh/id_rsassh-add ~/.ssh/id_rsa_github</code></pre><h3 id="åˆ›å»ºconfigæ–‡ä»¶"><a href="#åˆ›å»ºconfigæ–‡ä»¶" class="headerlink" title="åˆ›å»ºconfigæ–‡ä»¶"></a>åˆ›å»ºconfigæ–‡ä»¶</h3><p>åœ¨~/.sshç›®å½•ä¸‹åˆ›å»ºåä¸ºconfigçš„æ–‡ä»¶ã€‚mkdir config</p><p>æ‰“å¼€æ–‡ä»¶sudo vim configæ·»åŠ ä¸€ä¸‹å†…å®¹ï¼š</p><pre><code># gitlab  Host gitlab.com  HostName gitlab.com  PreferredAuthentications publickey  IdentityFile ~/.ssh/id_rsa_gitlab# github  Host github.com  HostName github.com  PreferredAuthentications publickey  IdentityFile ~/.ssh/id_rsa_github</code></pre><p>å…¶ä¸­ï¼ŒHostå’ŒHostNameå¡«å†™gitæœåŠ¡å™¨çš„åŸŸåã€‚</p><p>IdentityFileæŒ‡å®šç§é’¥çš„è·¯å¾„ã€‚</p><p>å¦‚æœåœ¨Linuxç³»ç»Ÿä¸‹æç¤ºé”™è¯¯ï¼šBad owner or permissions on /home/gary/.ssh/config</p><p>è¯´æ˜configæƒé™è¿‡å¤§ï¼Œchmodå‘½ä»¤è°ƒæ•´ï¼š</p><pre><code>chmod 644 ~/.ssh/config</code></pre><p>ç„¶ååœ¨githubå’Œgitlabä¸Šæ·»åŠ å…¬é’¥å³å¯ã€‚githua åœ¨å³ä¸Šè§’çš„å¤´åƒçš„è®¾ç½®ä¸­</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ç„¶åç”¨sshå‘½ä»¤åˆ†åˆ«æµ‹è¯•ï¼š</p><pre><code>ssh -T git@github.com</code></pre><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>  å¦‚æœåˆ°è¿™é‡Œä½ æ²¡æœ‰æˆåŠŸçš„è¯ï¼Œåˆ«æ€¥ï¼Œæ•™ä½ è§£å†³é—®é¢˜çš„ç»ˆæåŠæ³•â€“debug</p><p>  æ¯”å¦‚æµ‹è¯•githubï¼š</p><pre><code>  ssh -vT git@github.com</code></pre><p>  -v æ˜¯è¾“å‡ºç¼–è¯‘ä¿¡æ¯ï¼Œç„¶åæ ¹æ®ç¼–è¯‘ä¿¡æ¯è‡ªå·±å»è§£å†³é—®é¢˜å§ã€‚</p><h3 id="å…³äºhttpsç”¨æˆ·å"><a href="#å…³äºhttpsç”¨æˆ·å" class="headerlink" title="å…³äºhttpsç”¨æˆ·å"></a>å…³äºhttpsç”¨æˆ·å</h3><p>  å¦‚æœä¹‹å‰æœ‰è®¾ç½®å…¨å±€ç”¨æˆ·åå’Œé‚®ç®±çš„è¯ï¼Œéœ€è¦unsetä¸€ä¸‹</p><pre><code>  git config --global --unset user.name  git config --global --unset user.email</code></pre><p>  ç„¶ååœ¨ä¸åŒçš„ä»“åº“ä¸‹è®¾ç½®å±€éƒ¨çš„ç”¨æˆ·åå’Œé‚®ç®±</p><p>  æ¯”å¦‚åœ¨å…¬å¸çš„repositoryä¸‹</p><pre><code>  git config user.name &quot;yourname&quot;   git config user.email &quot;youremail&quot;</code></pre><p>  åœ¨è‡ªå·±çš„githubçš„ä»“åº“åœ¨æ‰§è¡Œåˆšåˆšçš„å‘½ä»¤ä¸€éå³å¯ã€‚</p><p>  è¿™æ ·å°±å¯ä»¥åœ¨ä¸åŒçš„ä»“åº“ï¼Œå·²ä¸åŒçš„è´¦å·ç™»å½•ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue-router åŸç†</title>
      <link href="/2018/08/10/vue/vuerouter/"/>
      <url>/2018/08/10/vue/vuerouter/</url>
      
        <content type="html"><![CDATA[<p>è·¯ç”±çš„æ¦‚å¿µï¼Œåœ¨ç°åœ¨çš„å‰ç«¯é¢†åŸŸå…¶å®ä¸ç®—é™Œç”Ÿã€‚å®ƒçš„ä½œç”¨å°±æ˜¯æ ¹æ®ä¸ç”¨çš„è·¯å¾„å»æ˜ å°„åˆ°ä¸åŒçš„è§†å›¾ã€‚</p><h2 id="åç«¯è·¯ç”±"><a href="#åç«¯è·¯ç”±" class="headerlink" title="åç«¯è·¯ç”±"></a>åç«¯è·¯ç”±</h2><p>è·¯ç”±çš„æ¦‚å¿µå®é™…ä¸Šæ˜¯ä»åç«¯å¼€å§‹ç”±æ¥çš„ï¼Œåç«¯æ ¹æ®ä¸åŒçš„è·¯å¾„å»åŒ¹é…ä¸åŒçš„èµ„æºä¾‹å¦‚</p><pre class="line-numbers language-js"><code class="language-js">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>studyfe<span class="token punctuation">.</span>cn<span class="token operator">/</span>login<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¤§è‡´æµç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µ</p><ul><li>æµè§ˆå™¨å‘é€è¯·æ±‚</li><li>æœåŠ¡å™¨ç›‘å¬åˆ°è¯·æ±‚ï¼Œè§£æ url è·¯å¾„</li><li>æ ¹æ®è·¯ç”±é…ç½®ï¼Œè¿”å›èµ„æºä¿¡æ¯</li><li>æµè§ˆå™¨é€šè¿‡è§£æèµ„æºä¿¡æ¯ï¼Œå‘ˆç°åˆ°å‰ç«¯é¡µé¢</li></ul><h2 id="å‰ç«¯è·¯ç”±"><a href="#å‰ç«¯è·¯ç”±" class="headerlink" title="å‰ç«¯è·¯ç”±"></a>å‰ç«¯è·¯ç”±</h2><h3 id="hash-æ¨¡å¼"><a href="#hash-æ¨¡å¼" class="headerlink" title="hash æ¨¡å¼"></a>hash æ¨¡å¼<hr></h3><p>åœ¨ HTML5 çš„ history æ²¡æœ‰å‡ºæ¥ä¹‹å‰ï¼Œè¦å®ç°å‰ç«¯è·¯ç”±æœºåˆ¶è€Œä¸è¯·æ±‚åç«¯èµ„æºå°±åº”ç”¨åˆ°äº† hash æ¨¡å¼ï¼Œhash æ˜¯æŒ‡ url å°¾å·´åçš„ # å·åŠåé¢çš„å­—ç¬¦ã€‚ä¹Ÿè¢«å¸¸ç§°ä¸ºé”šç‚¹ã€‚hash æ”¹å˜ä¼šè§¦å‘ hashchange äº‹ä»¶ï¼Œä¹Ÿèƒ½å¯¹æµè§ˆå™¨çš„å‰è¿›åé€€è¿›è¡Œæ§åˆ¶</p><pre class="line-numbers language-js"><code class="language-js">window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token string">'#toc-heading-1'</span>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// æ ¹æ®ä¸šåŠ¡åœºæ™¯è¿›è¡Œæ§åˆ¶</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="history-æ¨¡å¼"><a href="#history-æ¨¡å¼" class="headerlink" title="history æ¨¡å¼"></a>history æ¨¡å¼<hr></h3><p>HTML5æ ‡å‡†å‘å¸ƒã€‚å¤šäº†ä¸¤ä¸ª APIï¼Œhistory.pushState å’Œ history.replaceState æ¥è¿›è¡Œè·¯ç”±æ§åˆ¶ã€‚é€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥æ”¹å˜ url ä¸”ä¸å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚æ¯”è¾ƒä¸¤ç§æ–¹æ³•</p><ul><li>history æ¯” hash æ›´ç¾è§‚ï¼Œurl åé¢ä¸ä¼šå¤šä¸€ä¸ª #ï¼Œ</li><li>history API å¯ä»¥æ˜¯æ›´çµæ´»çš„æ§åˆ¶å‰ç«¯è·¯ç”±ï¼Œä¾‹å¦‚å‰è¿›åé€€ç­‰ç­‰</li><li>history æ¨¡å¼åœ¨ç”¨æˆ·åˆ·æ–°çš„æ—¶å€™éœ€è¦æœåŠ¡ç«¯æ”¯æŒè¿›è¡Œé‡å®šå‘ï¼Œé¿å…å‡ºç°é”™è¯¯</li><li>hash ä¼ å‚æ˜¯åŸºäº url çš„å¦‚æœè¦ä¼ é€’å¤æ‚æ•°æ®ä¼šæœ‰ä½“ç§¯é™åˆ¶</li><li>hash å…¼å®¹åˆ° IE8ï¼Œ history å…¼å®¹åˆ° IE10</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * @param stateï¼šçŠ¶æ€å¯¹è±¡ï¼Œé€šè¿‡pushState () åˆ›å»ºæ–°çš„å†å²è®°å½•æ¡ç›®ã€‚å¤§å°ä¸èƒ½è¶…è¿‡640k * @param titleï¼šæ ‡é¢˜ï¼ŒåŸºæœ¬æ²¡ç”¨ï¼Œä¸€èˆ¬ä¼  nullã€‚Firefox ç›®å‰å¿½ç•¥è¿™ä¸ªå‚æ•° * @param urlï¼šè¯¥å‚æ•°å®šä¹‰äº†æ–°çš„å†å²URLè®°å½•ã€‚æ–°çš„ url ä¸å½“å‰ url çš„ origin å¿…é¡»ä¸€æ ·ï¼Œå¦åˆ™ä¼šæŠ›å‡ºé”™è¯¯ */</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ç¤ºä¾‹</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token string">'https://www.studyfe.cn/2018/08/10/vue/vueroute'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"/2019/08/27/vue/vueprinciple/"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ä¿®æ”¹å½“å‰å†å²è®°å½•ä¸ pushState ç±»ä¼¼</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ç›‘å¬æµè§ˆå™¨å‰è¿›åé€€äº‹ä»¶</span>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"popstate"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// åé€€</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// å‰è¿›</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// å‰è¿›ä¸€æ­¥</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>length <span class="token comment" spellcheck="true">// æŸ¥çœ‹å½“å‰è®°å½•çš„æ ˆçš„æ•°é‡</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="vue-router"><a href="#vue-router" class="headerlink" title="vue-router"></a>vue-router</h2><p>vue-router åœ¨å¼€å‘ä¸­ vue é¡¹ç›®ä¸­èµ·åˆ°äº†éå¸¸å¤§çš„ä½œç”¨ï¼Œå®ƒæ”¯æŒ hashã€historyã€abstract 3 ç§è·¯ç”±æ–¹å¼ï¼Œæä¾›äº†æä¾›äº† <router-link> å’Œ <router-view> 2 ç§ç»„ä»¶å’Œä¸€ç³»åˆ—çš„è·¯ç”±é…ç½®</router-view></router-link></p><p>ä½¿ç”¨ <router-link> å’Œ <router-view> ç»„ä»¶è¿›è¡Œè·¯ç”±æ“ä½œ</router-view></router-link></p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello App!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- ä½¿ç”¨ router-link ç»„ä»¶æ¥å¯¼èˆª. --></span>    <span class="token comment" spellcheck="true">&lt;!-- é€šè¿‡ä¼ å…¥ `to` å±æ€§æŒ‡å®šé“¾æ¥. --></span>    <span class="token comment" spellcheck="true">&lt;!-- &lt;router-link> é»˜è®¤ä¼šè¢«æ¸²æŸ“æˆä¸€ä¸ª `&lt;a>` æ ‡ç­¾ --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/foo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Go to Foo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/bar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Go to Bar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>  <span class="token comment" spellcheck="true">&lt;!-- è·¯ç”±å‡ºå£ --></span>  <span class="token comment" spellcheck="true">&lt;!-- è·¯ç”±åŒ¹é…åˆ°çš„ç»„ä»¶å°†æ¸²æŸ“åœ¨è¿™é‡Œ --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨ vue-cli æˆ‘ä»¬ç»å¸¸ä¼šåœ¨å…¥å£æ–‡ä»¶è¿›è¡Œé…ç½®</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span><span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span><span class="token comment" spellcheck="true">// 1. å®šä¹‰ï¼ˆè·¯ç”±ï¼‰ç»„ä»¶ã€‚</span><span class="token comment" spellcheck="true">// å¯ä»¥ä»å…¶ä»–æ–‡ä»¶ import è¿›æ¥</span><span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div>foo&lt;/div>'</span> <span class="token punctuation">}</span><span class="token keyword">const</span> Bar <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div>bar&lt;/div>'</span> <span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 2. å®šä¹‰è·¯ç”±</span><span class="token comment" spellcheck="true">// æ¯ä¸ªè·¯ç”±åº”è¯¥æ˜ å°„ä¸€ä¸ªç»„ä»¶ã€‚ å…¶ä¸­"component" å¯ä»¥æ˜¯</span><span class="token comment" spellcheck="true">// é€šè¿‡ Vue.extend() åˆ›å»ºçš„ç»„ä»¶æ„é€ å™¨ï¼Œ</span><span class="token comment" spellcheck="true">// æˆ–è€…ï¼Œåªæ˜¯ä¸€ä¸ªç»„ä»¶é…ç½®å¯¹è±¡ã€‚</span><span class="token comment" spellcheck="true">// æˆ‘ä»¬æ™šç‚¹å†è®¨è®ºåµŒå¥—è·¯ç”±ã€‚</span><span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/bar'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Bar <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// 3. åˆ›å»º router å®ä¾‹ï¼Œç„¶åä¼  `routes` é…ç½®</span><span class="token comment" spellcheck="true">// ä½ è¿˜å¯ä»¥ä¼ åˆ«çš„é…ç½®å‚æ•°, ä¸è¿‡å…ˆè¿™ä¹ˆç®€å•ç€å§ã€‚</span><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  routes <span class="token comment" spellcheck="true">// ï¼ˆç¼©å†™ï¼‰ç›¸å½“äº routes: routes</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 4. åˆ›å»ºå’ŒæŒ‚è½½æ ¹å®ä¾‹ã€‚</span><span class="token comment" spellcheck="true">// è®°å¾—è¦é€šè¿‡ router é…ç½®å‚æ•°æ³¨å…¥è·¯ç”±ï¼Œ</span><span class="token comment" spellcheck="true">// ä»è€Œè®©æ•´ä¸ªåº”ç”¨éƒ½æœ‰è·¯ç”±åŠŸèƒ½</span><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  router<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹åˆ° vue-router æ˜¯é€šè¿‡ Vue.use çš„æ–¹æ³•è¢«æ³¨å…¥è¿› Vue å®ä¾‹ä¸­ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡ Vue.use æ¥äº†è§£æ•´ä¸ª vue-router</p><h3 id="vue-router-å®ç°ä¹‹-install"><a href="#vue-router-å®ç°ä¹‹-install" class="headerlink" title="vue-router å®ç°ä¹‹ install"></a>vue-router å®ç°ä¹‹ install<hr></h3><p>Vue.use å®šä¹‰åœ¨ <code>vue/src/core/global-api/use.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">:</span> Function <span class="token operator">|</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    plugin<span class="token punctuation">.</span>install<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> args<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    plugin<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢æ–¹æ³•å¾ˆæ¸…æ™°çš„çœ‹åˆ° Vue.use å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œè¿™ä¸ª install æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ª install æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥æ‹¿åˆ° Vue å¯¹è±¡ã€‚Vue-Router çš„å…¥å£æ–‡ä»¶æ˜¯ <code>src/index.js</code>ï¼Œå…¶ä¸­å®šä¹‰äº† VueRouter ç±»ï¼Œä¹Ÿå®ç°äº† install çš„é™æ€æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js">VueRouter<span class="token punctuation">.</span>install <span class="token operator">=</span> install<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®ƒçš„å®šä¹‰åœ¨ src/install.js ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">function</span> install <span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// æ··å…¥ beforeCreate é’©å­</span>  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    beforeCreate <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// åœ¨optionä¸Šé¢å­˜åœ¨routeråˆ™ä»£è¡¨æ˜¯æ ¹ç»„ä»¶ </span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router        <span class="token comment" spellcheck="true">// æ‰§è¡Œ_routerå®ä¾‹çš„ init æ–¹æ³•</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// ä¸º vue å®ä¾‹å®šä¹‰æ•°æ®åŠ«æŒ</span>        Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// éæ ¹ç»„ä»¶åˆ™ç›´æ¥ä»çˆ¶ç»„ä»¶ä¸­è·å–</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>      <span class="token punctuation">}</span>      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    destroyed <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// è®¾ç½®ä»£ç†ï¼Œå½“è®¿é—® this.$router çš„æ—¶å€™ï¼Œä»£ç†åˆ° this._routerRoot._router</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$router'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_router <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// è®¾ç½®ä»£ç†ï¼Œå½“è®¿é—® this.$route çš„æ—¶å€™ï¼Œä»£ç†åˆ° this._routerRoot._route</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$route'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_route <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// æ³¨å†Œ router-view å’Œ router-link ç»„ä»¶</span>  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span> View<span class="token punctuation">)</span>  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span> Link<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// Vueé’©å­åˆå¹¶ç­–ç•¥</span>  <span class="token keyword">const</span> strats <span class="token operator">=</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>optionMergeStrategies  <span class="token comment" spellcheck="true">// use the same hook merging strategy for route hooks</span>  strats<span class="token punctuation">.</span>beforeRouteEnter <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteLeave <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteUpdate <span class="token operator">=</span> strats<span class="token punctuation">.</span>created  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä¼ªä»£ç æˆ‘ä»¬çœ‹åˆ° Vue-Router çš„ install æ–¹æ³• å®é™…ä¸Šå°±æ˜¯åˆå§‹åŒ–çš„è¿‡ç¨‹</p><ul><li>æ··å…¥äº† beforeCreateï¼Œåœ¨æ‰§è¡Œ <code>new Vue({router})</code> çš„æ—¶å€™ä¼ å…¥ router å¯¹è±¡ï¼ŒæŒ‚åœ¨åˆ° vue çš„æ ¹ç»„ä»¶ä¸Š</li><li>æ‰§è¡Œ <code>this._router.init(this)</code> </li><li>è°ƒç”¨äº† <code>Vue.util.defineReactive</code> æ–¹æ³•æ¥è¿›è¡Œå“åº”å¼æ•°æ®å®šä¹‰ï¼Œä¸»è¦æ˜¯ä¸ºäº†è·¯ç”±çš„å˜åŒ–èƒ½å¤Ÿå³ä½¿å“åº”é¡µé¢çš„æ›´æ–°</li><li>é€šè¿‡ registerInstance(this, this) è¿™ä¸ªæ–¹æ³•æ¥å®ç°å¯¹ router-view çš„æŒ‚è½½æ“ä½œ</li><li>é€šè¿‡ Object.defineProperty åœ¨ Vue çš„åŸå‹ä¸Šå®šä¹‰äº† $router å’Œ $route 2 ä¸ªå±æ€§çš„ get æ–¹æ³•</li><li>è¿›è¡Œç»„ä»¶çš„æ³¨å†Œé’©å­åˆå¹¶ç­‰æ“ä½œ</li></ul><h3 id="vue-router-å®ç°ä¹‹-new-VueRouter"><a href="#vue-router-å®ç°ä¹‹-new-VueRouter" class="headerlink" title="vue-router å®ç°ä¹‹ new VueRouter"></a>vue-router å®ç°ä¹‹ new VueRouter<hr></h3><p> ä¸ºäº†æ„é€ å‡º router å®ä¾‹å¯¹è±¡ï¼ŒVueRouter å®šä¹‰äº†ä¸€äº›å±æ€§å’Œæ–¹æ³•ï¼Œå½“æˆ‘ä»¬è¿›è¡Œ new VueRouter çš„æ—¶å€™ï¼Œå¦‚ä¸‹</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>  routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Home <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/bar/:id'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Bar <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ new VueRouter çš„æ—¶å€™åšäº†ä»€ä¹ˆ</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  constructor <span class="token punctuation">(</span>options<span class="token punctuation">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>apps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span> mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>      mode <span class="token operator">=</span> <span class="token string">'hash'</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>      mode <span class="token operator">=</span> <span class="token string">'abstract'</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode    <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token punctuation">:</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token punctuation">:</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token punctuation">:</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  match <span class="token punctuation">(</span>    raw<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>    current<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span>    redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location  <span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> current<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">get</span> currentRoute <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>Route <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>current  <span class="token punctuation">}</span>  init <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å¾—å‡º constructor ä¸­ ä¸»è¦æ˜¯é€šè¿‡å‚æ•° mode æ¥æŒ‡å®šè·¯ç”±æ¨¡å¼ï¼Œåœ¨æœ€åˆé˜¶æ®µè¿˜è¿›è¡Œäº†å…¼å®¹åˆ¤æ–­ã€‚å¦‚æœå½“å‰ç¯å¢ƒä¸æ”¯æŒ history æ¨¡å¼ï¼Œä¼šå¼ºåˆ¶åˆ‡æ¢åˆ° hash æ¨¡å¼ã€‚å¦‚æœå½“å‰ç¯å¢ƒä¸æ˜¯æµè§ˆå™¨ç¯å¢ƒï¼Œä¼šåˆ‡æ¢åˆ°abstractæ¨¡å¼ä¸‹ã€‚ç„¶åå†æ ¹æ®ä¸åŒæ¨¡å¼æ¥ç”Ÿæˆä¸åŒçš„ history æ“ä½œå¯¹è±¡ã€‚</p><p>å®ä¾‹åŒ– VueRouter åä¼šè¿”å›å®ƒçš„å®ä¾‹ routerï¼Œæˆ‘ä»¬åœ¨ new Vue çš„æ—¶å€™ä¼šæŠŠ router ä½œä¸ºé…ç½®çš„å±æ€§ä¼ å…¥ï¼Œåœ¨æ··å…¥ beforCreate é’©å­çš„æ—¶å€™æ‰§è¡Œäº†</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ init æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js">init <span class="token punctuation">(</span>app<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app  <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history  <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> setupHashListener <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>      history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      setupHashListener<span class="token punctuation">,</span>      setupHashListener    <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>route <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>init ä¸»è¦æ˜¯é€šè¿‡ history ä¸åŒæ‰§è¡Œ history.transitionTo åˆ‡æ¢è·¯ç”±ã€‚æœ€åé€šè¿‡ history.listen æ¥æ³¨å†Œè·¯ç”±å˜åŒ–çš„å“åº”å›è°ƒã€‚</p><h3 id="vue-router-å®ç°ä¹‹-HashHistory"><a href="#vue-router-å®ç°ä¹‹-HashHistory" class="headerlink" title="vue-router å®ç°ä¹‹ HashHistory"></a>vue-router å®ç°ä¹‹ HashHistory<hr></h3><p>åœ¨ä¸Šé¢ä»£ç ä¸­å¦‚æœ mode ä¸º hash åˆ™æ‰§è¡Œ new HashHistory å‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HashHistory</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span>router<span class="token punctuation">:</span> Router<span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token operator">?</span>string<span class="token punctuation">,</span> fallback<span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// check history fallback deeplinking</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fallback <span class="token operator">&amp;&amp;</span> <span class="token function">checkFallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ä¿è¯ hash æ˜¯ä»¥ / å¼€å¤´ï¼Œè€Œä¸æ˜¯ #/ï¼Œå¦‚æœæ˜¯ #/å°±ä¼šè§¦å‘ hashchange äº‹ä»¶ è¿™æ ·æ‰§è¡Œ beforeEnter é’©å­æ—¶å€™ä¼šè§¦å‘ä¸¤æ¬¡</span>    <span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token keyword">function</span> checkFallback <span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^\/#/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">cleanPath</span><span class="token punctuation">(</span>base <span class="token operator">+</span> <span class="token string">'/#'</span> <span class="token operator">+</span> location<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> ensureSlash <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span>  <span class="token function">replaceHash</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token operator">+</span> path<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> getHash <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ä¸»è¦æ˜¯å– hashï¼Œå› ä¸ºå…¼å®¹æ€§é—®é¢˜æ‰€ä»¥æ²¡æœ‰ç›´æ¥ä½¿ç”¨ window.location.hash</span>  <span class="token keyword">let</span> href <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href  <span class="token keyword">const</span> index <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span>  href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> searchIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>searchIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> hashIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hashIndex <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      href <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> hashIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashIndex<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> href <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>searchIndex <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      href <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> searchIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>searchIndex<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> href<span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ init çš„æ—¶å€™å¦‚æœæ˜¯ HashHistory åˆ™ä¼šæ‰§è¡Œ history.transitionTo</p><pre class="line-numbers language-js"><code class="language-js">history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>  history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  setupHashListener<span class="token punctuation">,</span>  setupHashListener<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js">transitionTo <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// é€šè¿‡ match åŒ¹é… URL çš„ router å¯¹è±¡ </span>    <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>      onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// fire ready cbs once</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>onAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>transitionTo é¦–å…ˆæ ¹æ®ç›®æ ‡ location å’Œå½“å‰è·¯å¾„ this.current æ‰§è¡Œ this.router.match æ–¹æ³•å»åŒ¹é…åˆ°ç›®æ ‡çš„è·¯å¾„ã€‚è¿™é‡Œ this.current æ˜¯ history ç»´æŠ¤çš„å½“å‰è·¯å¾„ï¼Œå®ƒçš„åˆå§‹å€¼æ˜¯åœ¨ history çš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çš„ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> START<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>START çš„å®šä¹‰åœ¨ src/util/route.js ä¸­ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">const</span> START <span class="token operator">=</span> <span class="token function">createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ ·æˆ‘ä»¬å°±åˆ›å»ºäº†åˆå§‹çš„ Routeï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¼šæ‰§è¡Œ confirmTransition åšçœŸæ­£çš„åˆ‡æ¢å¤„ç†</p><pre class="line-numbers language-js"><code class="language-js">confirmTransition <span class="token punctuation">(</span>route<span class="token punctuation">:</span> Route<span class="token punctuation">,</span> onComplete<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current  <span class="token keyword">const</span> abort <span class="token operator">=</span> err <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    onAbort <span class="token operator">&amp;&amp;</span> <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ç›¸åŒçš„è·¯ç”±å¹¶ä¸” matched.length ç›¸åŒï¼Œé‚£ä¹ˆè¿›è¡Œè·³è½¬ / ä¸”è®°è¿›è¡Œä¸­æ–­å¤„ç†</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> <span class="token punctuation">{</span>    updated<span class="token punctuation">,</span>    deactivated<span class="token punctuation">,</span>    activated  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// æ•´ä¸ªåˆ‡æ¢å‘¨æœŸçš„é˜Ÿåˆ—</span>  <span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>    <span class="token comment" spellcheck="true">// å¾—åˆ°å³å°†è¢«é”€æ¯ç»„å»ºçš„ beforeRouteLeave é’©å­å‡½æ•°</span>    <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// å…¨å±€ router before hooks</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// å¾—åˆ°ç»„ä»¶ updated é’©å­</span>    <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// å°†è¦æ›´æ–°çš„è·¯ç”±çš„ beforeEnter é’©å­</span>    activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// å¼‚æ­¥ç»„ä»¶çš„æ‰§è¡Œ</span>    <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>  <span class="token punctuation">)</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> route  <span class="token comment" spellcheck="true">// æ¯ä¸€ä¸ªé˜Ÿåˆ—æ‰§è¡Œçš„ iterator å‡½æ•°</span>  <span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// æ‰§è¡Œé˜Ÿåˆ— leave å’Œ beforeEnter ç›¸å…³é’©å­</span>  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢å‡½æ•°çš„å†…éƒ¨å®ç°æˆ‘ä»¬å°±ç•¥è¿‡é€šè¿‡æ³¨é‡Šæˆ‘ä»¬çŸ¥é“å®ƒçš„ä½œç”¨å°±å¯ä»¥äº†ï¼Œç°åœ¨æˆ‘ä»¬å±¡ä¸€ä¸‹ä¸Šé¢çš„æµç¨‹</p><ul><li>æ‰§è¡Œ transitionTo å‡½æ•°ï¼Œé€šè¿‡ match å‡½æ•°çš„åŒ¹é…å¾—åˆ° router å¯¹è±¡</li><li>æ‰§è¡Œ confirmTransition å‡½æ•°ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è·³è½¬ï¼Œå¦‚æœä¸éœ€è¦åˆ™è¿›è¡Œä¸­æ–­å¤„ç†ï¼Œå¦åˆ™å…ˆå¾—åˆ°é’©å­å‡½æ•°çš„ä»»åŠ¡é˜Ÿåˆ— queue</li><li>é€šè¿‡ runQueue å‡½æ•°æ¥æ‰¹æ¬¡æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªæ–¹æ³•</li><li>æ‰§è¡Œ queue çš„é’©å­å‡½æ•°çš„æ—¶å€™ï¼Œé€šè¿‡ iterator æ¥æ„é€ è¿­ä»£å™¨ç”±ç”¨æˆ·ä¼ å…¥ next æ–¹æ³•ï¼Œç¡®å®šæ‰§è¡Œçš„è¿‡ç¨‹</li><li>æ•´ä¸ªé˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•åï¼Œå¼€å§‹å¤„ç†å®Œæˆåçš„å›è°ƒå‡½æ•°ã€‚</li></ul><blockquote><p>å¯¼èˆªå®ˆå«</p></blockquote><p>å¯¼èˆªå®ˆå«ï¼Œå®é™…ä¸Šå°±æ˜¯å‘ç”Ÿåœ¨è·¯ç”±è·¯å¾„åˆ‡æ¢çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„ä¸€ç³»åˆ—é’©å­å‡½æ•°ã€‚</p><p>æˆ‘ä»¬å…ˆä»æ•´ä½“ä¸Šçœ‹ä¸€ä¸‹è¿™äº›é’©å­å‡½æ•°æ‰§è¡Œçš„é€»è¾‘ï¼Œé¦–å…ˆæ„é€ ä¸€ä¸ªé˜Ÿåˆ— queueï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼›ç„¶åå†å®šä¹‰ä¸€ä¸ªè¿­ä»£å™¨å‡½æ•° iteratorï¼›æœ€åå†æ‰§è¡Œ runQueue æ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªé˜Ÿåˆ—ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ runQueue çš„å®šä¹‰ï¼Œåœ¨ <code>src/util/async.js</code> ä¸­ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> runQueue <span class="token punctuation">(</span>queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">></span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> cb<span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> step <span class="token operator">=</span> index <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">fn</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ˜¯éå¸¸ç»å…¸çš„å¼‚æ­¥å‡½æ•°é˜Ÿåˆ—æ‰§è¡Œæ¨¡å¼ï¼Œfn å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ iterator å‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token punctuation">(</span>to<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>        <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>        <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>          <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>          <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>iterator å‡½æ•°å°±æ˜¯å»æ‰§è¡Œæ¯ä¸€ä¸ªå¯¼èˆªå®ˆå« hookï¼Œå¹¶ä¼ å…¥ routeã€current å’ŒåŒ¿åå‡½æ•°ï¼Œè¿™äº›å‚æ•°åˆ†åˆ«å¯¹åº”å¾—åˆ°æ˜¯æ–‡æ¡£ä¸­çš„ toã€fromã€next å½“æ‰§è¡Œäº†åŒ¿åå‡½æ•°ï¼Œä¼šæ ¹æ®ä¸€äº›æ¡ä»¶æ‰§è¡Œ abort æˆ– nextï¼Œåªæœ‰æ‰§è¡Œ next çš„æ—¶å€™ï¼Œæ‰ä¼šå‰è¿›åˆ°ä¸‹ä¸€ä¸ªå¯¼èˆªå®ˆå«é’©å­å‡½æ•°ä¸­ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå®˜æ–¹æ–‡æ¡£ä¼šè¯´åªæœ‰æ‰§è¡Œ next æ–¹æ³•æ¥ resolve è¿™ä¸ªé’©å­å‡½æ•°ã€‚</p><p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ queue æ˜¯æ€ä¹ˆæ„é€ çš„</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>  <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>  <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>  activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŒ‰ç…§é¡ºåºå¦‚ä¸‹ï¼š</p><ol><li><p>åœ¨å¤±æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ç¦»å¼€å®ˆå«ã€‚</p></li><li><p>è°ƒç”¨å…¨å±€çš„ beforeEach å®ˆå«ã€‚</p></li><li><p>åœ¨é‡ç”¨çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteUpdate å®ˆå«</p></li><li><p>åœ¨æ¿€æ´»çš„è·¯ç”±é…ç½®é‡Œè°ƒç”¨ beforeEnterã€‚</p></li><li><p>è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶ã€‚</p></li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†åˆ«ä»‹ç»è¿™ 5 æ­¥çš„å®ç°</p><p>ç¬¬ä¸€æ­¥æ‰§è¡Œ extractLeaveGuards(deactivated)ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ extractLeaveGuards çš„å®šä¹‰</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> extractLeaveGuards <span class="token punctuation">(</span>deactivated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">,</span> <span class="token string">'beforeRouteLeave'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å®ƒå†…éƒ¨è°ƒç”¨äº† extractGuards çš„é€šç”¨æ–¹æ³•ï¼Œå¯ä»¥ä» RouteRecord æ•°ç»„ä¸­æå–å„ä¸ªé˜¶æ®µçš„å®ˆå«</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> extractGuards <span class="token punctuation">(</span>  records<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">,</span>  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  bind<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>  reverse<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> guards <span class="token operator">=</span> <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token punctuation">(</span>def<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> guard <span class="token operator">=</span> <span class="token function">extractGuard</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> name<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span>        <span class="token operator">?</span> guard<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>guard <span class="token operator">=</span><span class="token operator">></span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>reverse <span class="token operator">?</span> guards<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> guards<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œç”¨åˆ°äº† flatMapComponents æ–¹æ³•å»ä» records ä¸­è·å–æ‰€æœ‰çš„å¯¼èˆªï¼Œå®ƒçš„å®šä¹‰åœ¨ <code>src/util/resolve-components.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> flatMapComponents <span class="token punctuation">(</span>  matched<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">,</span>  fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>matched<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>components<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>key <span class="token operator">=</span><span class="token operator">></span> <span class="token function">fn</span><span class="token punctuation">(</span>      m<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>      m<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>      m<span class="token punctuation">,</span> key    <span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> flatten <span class="token punctuation">(</span>arr<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>concat<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>flatMapComponents çš„ä½œç”¨å°±æ˜¯è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯ä» matched é‡Œè·å–åˆ°æ‰€æœ‰ç»„ä»¶çš„ keyï¼Œç„¶åè¿”å› fn å‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œflatten ä½œç”¨æ˜¯æŠŠäºŒç»´æ•°ç»„æ‹å¹³æˆä¸€ç»´æ•°ç»„ã€‚</p><p>é‚£ä¹ˆå¯¹äº extractGuards ä¸­ flatMapComponents çš„è°ƒç”¨ï¼Œæ‰§è¡Œæ¯ä¸ª fn çš„æ—¶å€™ï¼Œé€šè¿‡ extractGuard(def, name) è·å–åˆ°ç»„ä»¶ä¸­å¯¹åº” name çš„å¯¼èˆªå®ˆå«</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> extractGuard <span class="token punctuation">(</span>  def<span class="token punctuation">:</span> Object <span class="token operator">|</span> Function<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> NavigationGuard <span class="token operator">|</span> Array<span class="token operator">&lt;</span>NavigationGuard<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    def <span class="token operator">=</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>def<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> def<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·å–åˆ° guard åï¼Œè¿˜ä¼šè°ƒç”¨ bind æ–¹æ³•æŠŠç»„ä»¶çš„å®ä¾‹ instance ä½œä¸ºå‡½æ•°æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ç»‘å®šåˆ° guard ä¸Šï¼Œbind æ–¹æ³•çš„å¯¹åº”çš„æ˜¯ bindGuard</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> bindGuard <span class="token punctuation">(</span>guard<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span> instance<span class="token punctuation">:</span> <span class="token operator">?</span>_Vue<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>NavigationGuard <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> boundRouteGuard <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> guard<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‚£ä¹ˆå¯¹äº extractLeaveGuards(deactivated) è€Œè¨€ï¼Œè·å–åˆ°çš„å°±æ˜¯æ‰€æœ‰å¤±æ´»ç»„ä»¶ä¸­å®šä¹‰çš„ beforeRouteLeave é’©å­å‡½æ•°ã€‚</p><p>ç¬¬äºŒæ­¥æ˜¯ <code>this.router.beforeHooks</code>ï¼Œåœ¨æˆ‘ä»¬çš„ VueRouter ç±»ä¸­å®šä¹‰äº† beforeEach æ–¹æ³•ï¼Œåœ¨ <code>src/index.js</code> ä¸­ï¼š</p><pre class="line-numbers language-js"><code class="language-js">beforeEach <span class="token punctuation">(</span>fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> registerHook <span class="token punctuation">(</span>list<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ç”¨æˆ·ä½¿ç”¨ router.beforeEach æ³¨å†Œäº†ä¸€ä¸ªå…¨å±€å®ˆå«ï¼Œå°±ä¼šå¾€ router.beforeHooks æ·»åŠ ä¸€ä¸ªé’©å­å‡½æ•°ï¼Œè¿™æ · this.router.beforeHooks è·å–çš„å°±æ˜¯ç”¨æˆ·æ³¨å†Œçš„å…¨å±€ beforeEach å®ˆå«ã€‚</p><p>ç¬¬ä¸‰æ­¥æ‰§è¡Œäº† extractUpdateHooks(updated)ï¼Œæ¥çœ‹ä¸€ä¸‹ extractUpdateHooks çš„å®šä¹‰ï¼š</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> extractUpdateHooks <span class="token punctuation">(</span>updated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>updated<span class="token punctuation">,</span> <span class="token string">'beforeRouteUpdate'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å’Œ extractLeaveGuards(deactivated) ç±»ä¼¼ï¼ŒextractUpdateHooks(updated) è·å–åˆ°çš„å°±æ˜¯æ‰€æœ‰é‡ç”¨çš„ç»„ä»¶ä¸­å®šä¹‰çš„ beforeRouteUpdate é’©å­å‡½æ•°</p><p>ç¬¬å››æ­¥æ˜¯æ‰§è¡Œ activated.map(m =&gt; m.beforeEnter)ï¼Œè·å–çš„æ˜¯åœ¨æ¿€æ´»çš„è·¯ç”±é…ç½®ä¸­å®šä¹‰çš„ beforeEnter å‡½æ•°ã€‚</p><p>ç¬¬äº”æ­¥æ˜¯æ‰§è¡Œ resolveAsyncComponents(activated) è§£æå¼‚æ­¥ç»„ä»¶ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ resolveAsyncComponents çš„å®šä¹‰ï¼Œåœ¨ <code>src/util/resolve-components.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> resolveAsyncComponents <span class="token punctuation">(</span>matched<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> hasAsync <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>matched<span class="token punctuation">,</span> <span class="token punctuation">(</span>def<span class="token punctuation">,</span> _<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> def<span class="token punctuation">.</span>cid <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>        hasAsync <span class="token operator">=</span> <span class="token boolean">true</span>        pending<span class="token operator">++</span>        <span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span>resolvedDef <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isESModule</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            resolvedDef <span class="token operator">=</span> resolvedDef<span class="token punctuation">.</span><span class="token keyword">default</span>          <span class="token punctuation">}</span>          def<span class="token punctuation">.</span>resolved <span class="token operator">=</span> <span class="token keyword">typeof</span> resolvedDef <span class="token operator">===</span> <span class="token string">'function'</span>            <span class="token operator">?</span> resolvedDef            <span class="token punctuation">:</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span>          match<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> resolvedDef          pending<span class="token operator">--</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">const</span> reject <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span>reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token string">`Failed to resolve async component </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>          process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>            error <span class="token operator">=</span> <span class="token function">isError</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>              <span class="token operator">?</span> reason              <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>            <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">let</span> res        <span class="token keyword">try</span> <span class="token punctuation">{</span>          res <span class="token operator">=</span> <span class="token function">def</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">const</span> comp <span class="token operator">=</span> res<span class="token punctuation">.</span>component            <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> comp<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              comp<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasAsync<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>resolveAsyncComponents è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¼èˆªå®ˆå«å‡½æ•°ï¼Œæœ‰æ ‡å‡†çš„ toã€fromã€next å‚æ•°ã€‚å®ƒçš„å†…éƒ¨å®ç°å¾ˆç®€å•ï¼Œåˆ©ç”¨äº† flatMapComponents æ–¹æ³•ä» matched ä¸­è·å–åˆ°æ¯ä¸ªç»„ä»¶çš„å®šä¹‰ï¼Œåˆ¤æ–­å¦‚æœæ˜¯å¼‚æ­¥ç»„ä»¶ï¼Œåˆ™æ‰§è¡Œå¼‚æ­¥ç»„ä»¶åŠ è½½é€»è¾‘ï¼ŒåŠ è½½æˆåŠŸåä¼šæ‰§è¡Œ match.components[key] = resolvedDef æŠŠè§£æå¥½çš„å¼‚æ­¥ç»„ä»¶æ”¾åˆ°å¯¹åº”çš„ components ä¸Šï¼Œå¹¶ä¸”æ‰§è¡Œ next å‡½æ•°ã€‚</p><p>è¿™æ ·åœ¨ resolveAsyncComponents(activated) è§£æå®Œæ‰€æœ‰æ¿€æ´»çš„å¼‚æ­¥ç»„ä»¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸€æ¬¡æ‰€æœ‰æ¿€æ´»çš„ç»„ä»¶ã€‚è¿™æ ·æˆ‘ä»¬åœ¨åšå®Œè¿™ 5 æ­¥ååˆåšäº†ä¸€äº›äº‹æƒ…</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> isValid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route  <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>  <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li><p>åœ¨è¢«æ¿€æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteEnterã€‚</p></li><li><p>è°ƒç”¨å…¨å±€çš„ beforeResolve å®ˆå«ã€‚</p></li><li><p>è°ƒç”¨å…¨å±€çš„ afterEach é’©å­ã€‚</p></li></ol><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“å¤„ç†å®Œä»»åŠ¡é˜Ÿåˆ—ä¹‹åçš„å›è°ƒä¸»è¦æ˜¯æ¥å…¥è·¯ç”±ç»„ä»¶åæœŸçš„é’©å­å‡½æ•° beforeRouteEnter å’Œ beforeResolveï¼Œå¹¶è¿›è¡Œé˜Ÿåˆ—æ‰§è¡Œã€‚æœ€åæ‰§è¡Œå›è°ƒå‡½æ•° onComplete</p><p>åˆ°è¿™é‡Œï¼Œå·²ç»å®Œæˆäº†å¯¹å½“å‰ route çš„åˆ‡æ¢åŠ¨ä½œï¼Œåœ¨å®Œæˆè·¯ç”±åˆ‡æ¢åæ‰§è¡Œäº† <code>onComplete &amp;&amp; onComplete(route)</code> ï¼Œé‚£ä¹ˆä¸»è¦ä¼šå¼•èµ· url å’Œ ç»„ä»¶çš„å˜åŒ–æˆ‘ä»¬æ¥çœ‹çœ‹</p><p>å½“æˆ‘ä»¬ç‚¹å‡» router-link çš„æ—¶å€™ï¼Œå®é™…ä¸Šæœ€ç»ˆä¼šæ‰§è¡Œ router.pushï¼Œå¦‚ä¸‹</p><pre class="line-numbers language-js"><code class="language-js">push <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>this.history.push å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å­ç±»å®ç°çš„ï¼Œä¸åŒæ¨¡å¼ä¸‹è¯¥å‡½æ•°çš„å®ç°ç•¥æœ‰ä¸åŒï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¹³æ—¶ä½¿ç”¨æ¯”è¾ƒå¤šçš„ hash æ¨¡å¼è¯¥å‡½æ•°çš„å®ç°ï¼Œåœ¨ <code>src/history/hash.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js">push <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">{</span> current<span class="token punctuation">:</span> fromRoute <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> route <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">pushHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>    <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> fromRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>    onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>push å‡½æ•°ä¼šå…ˆæ‰§è¡Œ this.transitionTo åšè·¯å¾„åˆ‡æ¢ï¼Œåœ¨åˆ‡æ¢å®Œæˆçš„å›è°ƒå‡½æ•°ä¸­ï¼Œæ‰§è¡Œ pushHash å‡½æ•°</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> pushHash <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">pushState</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> path  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>supportsPushState çš„å®šä¹‰åœ¨ <code>src/util/push-state.js</code> ä¸­</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> supportsPushState <span class="token operator">=</span> inBrowser <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> ua <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent  <span class="token keyword">if</span> <span class="token punctuation">(</span>    <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 2.'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 4.0'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Mobile Safari'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>    ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Chrome'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>    ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Windows Phone'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> window<span class="token punctuation">.</span>history <span class="token operator">&amp;&amp;</span> <span class="token string">'pushState'</span> <span class="token keyword">in</span> window<span class="token punctuation">.</span>history<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ”¯æŒçš„è¯ï¼Œåˆ™è·å–å½“å‰å®Œæ•´çš„ urlï¼Œæ‰§è¡Œ pushState æ–¹æ³•</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> pushState <span class="token punctuation">(</span>url<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">,</span> replace<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">saveScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> history <span class="token operator">=</span> window<span class="token punctuation">.</span>history  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>      history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token punctuation">:</span> _key <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      _key <span class="token operator">=</span> <span class="token function">genKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token punctuation">:</span> _key <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>location<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">'replace'</span> <span class="token punctuation">:</span> <span class="token string">'assign'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>pushState ä¼šè°ƒç”¨æµè§ˆå™¨åŸç”Ÿçš„ history çš„ pushState æ¥å£æˆ–è€… replaceState æ¥å£ï¼Œæ›´æ–°æµè§ˆå™¨çš„ url åœ°å€ï¼Œå¹¶æŠŠå½“å‰ url å‹å…¥å†å²æ ˆä¸­ã€‚</p><p>ç„¶ååœ¨ history çš„åˆå§‹åŒ–ä¸­ï¼Œä¼šè®¾ç½®ä¸€ä¸ªç›‘å¬å™¨ï¼Œç›‘å¬å†å²æ ˆçš„å˜åŒ–</p><pre class="line-numbers language-js"><code class="language-js">setupListeners <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router  <span class="token comment" spellcheck="true">// å¤„ç†æ»šåŠ¨</span>  <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior  <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// é€šè¿‡ supportsPushState åˆ¤æ–­ç›‘å¬popstate è¿˜æ˜¯ hashchange</span>  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>supportsPushState <span class="token operator">?</span> <span class="token string">'popstate'</span> <span class="token punctuation">:</span> <span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current    <span class="token comment" spellcheck="true">// åˆ¤æ–­è·¯ç”±æ ¼å¼</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> route <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// å¦‚æœä¸æ”¯æŒ history æ¨¡å¼ï¼Œåˆ™æ¢æˆ hash æ¨¡å¼</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">replaceHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ç‚¹å‡»æµè§ˆå™¨è¿”å›æŒ‰é’®çš„æ—¶å€™ï¼Œå¦‚æœå·²ç»æœ‰ url è¢«å‹å…¥å†å²æ ˆï¼Œåˆ™ä¼šè§¦å‘ popstate äº‹ä»¶ï¼Œç„¶åæ‹¿åˆ°å½“å‰è¦è·³è½¬çš„ hashï¼Œæ‰§è¡Œ transtionTo æ–¹æ³•åšä¸€æ¬¡è·¯å¾„è½¬æ¢ã€‚</p><p>å¯ä»¥çœ‹åˆ° setupListeners è¿™é‡Œä¸»è¦åšäº† 2 ä»¶äº‹æƒ…ï¼Œä¸€ä¸ªæ˜¯å¯¹è·¯ç”±åˆ‡æ¢æ»šåŠ¨ä½ç½®çš„å¤„ç†ï¼Œå¦ä¸€ä¸ªæ˜¯å¯¹è·¯ç”±å˜åŠ¨åšäº†ä¸€æ¬¡ç›‘å¬ã€‚è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†å¯¹çœŸä¸ª hash çš„åˆ†æè¿‡ç¨‹</p><h3 id="vue-router-å®ç°ä¹‹-HTML5History"><a href="#vue-router-å®ç°ä¹‹-HTML5History" class="headerlink" title="vue-router å®ç°ä¹‹ HTML5History"></a>vue-router å®ç°ä¹‹ HTML5History<hr></h3><p>å½“åˆå§‹åŒ–çš„æ—¶å€™ mode ç­‰äº history æ¨¡å¼çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œ HTML5Historyï¼Œç„¶åä¼šæ‰§è¡Œ history å¯¹è±¡ä¸Šçš„ transitionTo æ–¹æ³•</p><p>åœ¨vue-routerå®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œå¯¹ HTML5History çš„å®ä¾‹åŒ–</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>çœ‹ä¸€ä¸‹ HTML5History å‡½æ•°çš„æ„é€ </p><pre class="line-numbers language-js"><code class="language-js">  constructor <span class="token punctuation">(</span>router<span class="token punctuation">:</span> Router<span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token operator">?</span>string<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å®ç° base åŸºç±»ä¸­çš„æ„é€ å‡½æ•°</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// æ»šåŠ¨ä¿¡æ¯å¤„ç†</span>    <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior    <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> initLocation <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current      <span class="token comment" spellcheck="true">// é¿å…åœ¨æœ‰çš„æµè§ˆå™¨ä¸­ç¬¬ä¸€æ¬¡åŠ è½½è·¯ç”±å°±ä¼šè§¦å‘ `popstate` äº‹ä»¶</span>      <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> START <span class="token operator">&amp;&amp;</span> location <span class="token operator">===</span> initLocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// æ‰§è¡Œè·³è½¬åŠ¨ä½œ</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> route <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">handleScroll</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåªæ˜¯è°ƒç”¨åŸºç±»æ„é€ å‡½æ•°ä»¥åŠåˆå§‹åŒ–ç›‘å¬äº‹ä»¶ã€‚ç”±äºåœ¨ä¸Šé¢å·²ç»ä»‹ç»äº† transitionTo å’Œ confirmTransitionã€‚è¿™é‡Œä¸å†è¿‡å¤šä»‹ç»äº†ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹å‡ ä¸ªä¹‹å‰æ²¡ä»‹ç»çš„ä¸€ä¸‹ API å§</p><pre class="line-numbers language-js"><code class="language-js">  push <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  replace <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  go <span class="token punctuation">(</span>n<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  back <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  forward <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ° vue-router è¿™ä¸ª API å®é™…ä¸Šéƒ½æ˜¯æ•ˆä»¿ window.history API çš„ï¼Œæ‰€ä»¥ä¹Ÿä¸ç”¨å¤šè¯´ã€‚è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†å¯¹ HTML5History çš„ä»‹ç»</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“<hr></h3><p>ä»ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°è·¯å¾„å˜åŒ–æ˜¯è·¯ç”±ä¸­æœ€é‡è¦çš„åŠŸèƒ½ï¼Œåœ¨è·¯ç”±è®°æ€§åˆ‡æ¢çš„æ—¶å€™ä¼šæŠŠå½“å‰çš„è·¯çº¿åˆ‡æ¢åˆ°ç›®æ ‡è·¯çº¿ï¼Œåˆ‡æ¢è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œä¸€ç³»åˆ—çš„å¯¼èˆªå®ˆå«é’©å­å‡½æ•°ï¼Œæ›´æ”¹ urlï¼ŒåŒæ—¶æ¸²æŸ“ç»„ä»¶ã€‚å…¶å®æœ€é‡è¦çš„å‡ ä¸ªå‡½æ•°å°±æ˜¯</p><ul><li>match è¿›è¡ŒåŒ¹é…è·¯ç”±å¾—åˆ°è·¯ç”±å¯¹è±¡</li><li>transitionTo åšè·¯å¾„åˆ‡æ¢</li><li>confirmTransition å¤„ç†é˜Ÿåˆ—çš„é’©å­å‡½æ•°ï¼Œåœ¨å¤„ç†é’©å­å‡½æ•°çš„æ—¶å€™ä¼šæŒ‰ç…§ä¸Šé¢ä»‹ç»çš„æ‰§è¡Œ 8 ä¸ªå°æ­¥éª¤çš„é¡ºåº</li><li>setupListeners ç›‘å¬å¯¼èˆªç­‰åŠŸèƒ½</li></ul>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux vimä½¿ç”¨</title>
      <link href="/2018/07/28/linux/vim/"/>
      <url>/2018/07/28/linux/vim/</url>
      
        <content type="html"><![CDATA[<h3 id="vimä¸‰ç§æ¨¡å¼"><a href="#vimä¸‰ç§æ¨¡å¼" class="headerlink" title="vimä¸‰ç§æ¨¡å¼"></a>vimä¸‰ç§æ¨¡å¼</h3><p>å‘½ä»¤æ¨¡å¼ã€æ’å…¥æ¨¡å¼ã€ç¼–è¾‘æ¨¡å¼ã€‚ä½¿ç”¨ESCæˆ–iæˆ–ï¼šæ¥åˆ‡æ¢æ¨¡å¼</p><h3 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h3><pre><code>:q  é€€å‡º:q! å¼ºåˆ¶é€€å‡º:wq ä¿å­˜å¹¶é€€å‡º:set number  æ˜¾ç¤ºè¡Œå·:set nonumber  éšè—è¡Œå·/host  åœ¨æ–‡æ¡£ä¸­æŸ¥æ‰¾host æŒ‰nè·³åˆ°æŸ¥æ‰¾ä¸‹ä¸€ä¸ªï¼Œshift+næŸ¥æ‰¾ä¸Šä¸€ä¸ªyyp  å¤åˆ¶å…‰æ ‡æ‰€åœ¨è¡Œï¼Œå¹¶ç²˜è´´h(å·¦ç§»ä¸€ä¸ªå­—ç¬¦â†)ã€j(ä¸‹ä¸€è¡Œâ†“)ã€k(ä¸Šä¸€è¡Œâ†‘)ã€l(å³ç§»ä¸€ä¸ªå­—ç¬¦â†’)</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ–‡ä»¶æƒé™</title>
      <link href="/2018/07/25/linux/fileauth/"/>
      <url>/2018/07/25/linux/fileauth/</url>
      
        <content type="html"><![CDATA[<h3 id="ä¸‰ç§åŸºæœ¬æƒé™"><a href="#ä¸‰ç§åŸºæœ¬æƒé™" class="headerlink" title="ä¸‰ç§åŸºæœ¬æƒé™"></a>ä¸‰ç§åŸºæœ¬æƒé™</h3><pre><code>R  è¯»  æ•°å€¼è¡¨ç¤ºä¸º4W  å†™  æ•°å€¼è¡¨ç¤ºä¸º2X  å¯æ‰§è¡Œ  æ•°å€¼è¡¨ç¤ºä¸º1</code></pre><p>1.æ‰§è¡Œls -alå‘½ä»¤è¡Œä¼šå‡ºç°<br></p><pre><code>drwxr-xr-x  19 renbo  staff   608B Mar 27 11:31 -notes-summarydrwxr-xr-x  41 renbo  staff   1.3K Mar 12 17:05 ant-design-prodrwxr-xr-x   7 renbo  staff   224B May 18  2018 canvasdrwxr-xr-x   8 renbo  staff   256B Sep 11  2017 doT-demodrwxr-xr-x  19 renbo  staff   608B May 24  2018 egg-exampledrwxr-xr-x   4 renbo  staff   128B Nov 21 13:52 expressdrwxr-xr-x   3 renbo  staff    96B Aug 13  2018 flutter</code></pre><p>2.è§£é‡Šï¼š</p><pre><code>d ï¼šç¬¬ä¸€ä½è¡¨ç¤ºæ–‡ä»¶ç±»å‹ï¼Œdæ˜¯ç›®å½•æ–‡ä»¶ã€læ˜¯é“¾æ¥æ–‡ä»¶ã€-æ˜¯æ™®é€šæ–‡ä»¶ã€pæ˜¯ç®¡é“rwx ï¼šç¬¬2-4ä½è¡¨ç¤ºè¿™ä¸ªæ–‡ä»¶çš„å±ä¸»æ‹¥æœ‰çš„æƒé™ã€‚ræ˜¯è¯»ã€wæ˜¯å†™ã€xæ˜¯æ‰§è¡Œr-x ï¼šç¬¬5-7ä½è¡¨ç¤ºå’Œè¿™ä¸ªæ–‡ä»¶å±ä¸»æ‰€åœ¨åŒä¸€ä¸ªç»„çš„ç”¨æˆ·æ‰€å…·æœ‰çš„æƒé™r-x ï¼šç¬¬8-10ä½è¡¨ç¤ºå…¶ä»–ç”¨æˆ·æ‰€å…·æœ‰çš„æƒé™r:readå°±æ˜¯è¯»æƒé™     --æ•°å­—4è¡¨ç¤ºw:writeå°±æ˜¯å†™æƒé™    --æ•°å­—2è¡¨ç¤ºx:excuteå°±æ˜¯æ‰§è¡Œæƒé™ --æ•°å­—1è¡¨ç¤º</code></pre><h3 id="æ›´æ”¹æƒé™"><a href="#æ›´æ”¹æƒé™" class="headerlink" title="æ›´æ”¹æƒé™"></a>æ›´æ”¹æƒé™</h3><pre><code>sudo chmod [uæ‰€å±ç”¨æˆ·  gæ‰€å±ç»„  oå…¶ä»–ç”¨æˆ·  aæ‰€æœ‰ç”¨æˆ·]  [+å¢åŠ æƒé™  -å‡å°‘æƒé™]  [r  w  x]   ç›®å½•å ä¾‹å¦‚ï¼šæœ‰ä¸€ä¸ªæ–‡ä»¶filenameï¼Œæƒé™ä¸ºâ€œ-rw-r----xâ€ ,å°†æƒé™å€¼æ”¹ä¸º&quot;-rwxrw-r-x&quot;ï¼Œç”¨æ•°å€¼è¡¨ç¤ºä¸º765sudo chmod u+x g+w o+r  filenameä¸Šé¢çš„ä¾‹å­å¯ä»¥ç”¨æ•°å€¼è¡¨ç¤ºsudo chmod 765 filenameä¸€èˆ¬è¶…çº§æƒé™ä¸ºsudo chmod 777 filename</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç”¨æˆ·åŠç”¨æˆ·ç»„ç®¡ç†</title>
      <link href="/2018/07/22/linux/user/"/>
      <url>/2018/07/22/linux/user/</url>
      
        <content type="html"><![CDATA[<h3 id="æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·è´¦å·"><a href="#æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·è´¦å·" class="headerlink" title="æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·è´¦å·"></a>æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·è´¦å·</h3><pre><code>cat /etc/passwdè¾“å‡ºçš„ç»“æ„ç”¨æˆ·å:å£ä»¤:ç”¨æˆ·æ ‡è¯†å·:ç»„æ ‡è¯†å·:æ³¨é‡Šæ€§æè¿°:ä¸»ç›®å½•:ç™»å½•Shell</code></pre><h3 id="æŸ¥çœ‹å­˜å‚¨ç»„è´¦å·"><a href="#æŸ¥çœ‹å­˜å‚¨ç»„è´¦å·" class="headerlink" title="æŸ¥çœ‹å­˜å‚¨ç»„è´¦å·"></a>æŸ¥çœ‹å­˜å‚¨ç»„è´¦å·</h3><pre><code>cat /etc/group  </code></pre><h3 id="æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·è´¦å·çš„å¯†ç "><a href="#æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·è´¦å·çš„å¯†ç " class="headerlink" title="æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·è´¦å·çš„å¯†ç "></a>æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·è´¦å·çš„å¯†ç </h3><pre><code>cat /etc/shadow   è¾“å‡ºç»“æ„ç™»å½•å:åŠ å¯†å£ä»¤:æœ€åä¸€æ¬¡ä¿®æ”¹æ—¶é—´:æœ€å°æ—¶é—´é—´éš”:æœ€å¤§æ—¶é—´é—´éš”:è­¦å‘Šæ—¶é—´:ä¸æ´»åŠ¨æ—¶é—´:å¤±æ•ˆæ—¶é—´:æ ‡å¿—</code></pre><h3 id="æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·ç»„è´¦å·çš„å¯†ç "><a href="#æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·ç»„è´¦å·çš„å¯†ç " class="headerlink" title="æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·ç»„è´¦å·çš„å¯†ç "></a>æŸ¥çœ‹å­˜å‚¨ç”¨æˆ·ç»„è´¦å·çš„å¯†ç </h3><pre><code>cat /etc/gshadow  </code></pre><h3 id="å»ºç«‹ç”¨æˆ·å¸å·"><a href="#å»ºç«‹ç”¨æˆ·å¸å·" class="headerlink" title="å»ºç«‹ç”¨æˆ·å¸å·"></a>å»ºç«‹ç”¨æˆ·å¸å·</h3><pre><code>å‚æ•°-c comment æŒ‡å®šä¸€æ®µæ³¨é‡Šæ€§æè¿°ã€‚-d ç›®å½• æŒ‡å®šç”¨æˆ·ä¸»ç›®å½•ï¼Œå¦‚æœæ­¤ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åŒæ—¶ä½¿ç”¨-mé€‰é¡¹ï¼Œå¯ä»¥åˆ›å»ºä¸»ç›®å½•ã€‚-g ç”¨æˆ·ç»„ æŒ‡å®šç”¨æˆ·æ‰€å±çš„ç”¨æˆ·ç»„ã€‚-G ç”¨æˆ·ç»„ï¼Œç”¨æˆ·ç»„ æŒ‡å®šç”¨æˆ·æ‰€å±çš„é™„åŠ ç»„ã€‚-s Shellæ–‡ä»¶ æŒ‡å®šç”¨æˆ·çš„ç™»å½•Shellã€‚-u ç”¨æˆ·å· æŒ‡å®šç”¨æˆ·çš„ç”¨æˆ·å·ï¼Œå¦‚æœåŒæ—¶æœ‰-oé€‰é¡¹ï¼Œåˆ™å¯ä»¥é‡å¤ä½¿ç”¨å…¶ä»–ç”¨æˆ·çš„æ ‡è¯†å·ã€‚useradd renbo  æ·»åŠ ä¸€èˆ¬ç”¨æˆ·useradd -g root renbo  ä¸ºæ·»åŠ ç”¨æˆ·æŒ‡å®šç”¨æˆ·ç»„useradd -r renbo  åˆ›å»ºç³»ç»Ÿç”¨æˆ·useradd -d /home renbo  ä¸ºæ–°æ·»åŠ çš„ç”¨æˆ·æŒ‡å®šhomeç›®å½•useradd caojh -u 544  å»ºç«‹ç”¨æˆ·ä¸”åˆ¶å®šID</code></pre><h3 id="åˆ é™¤ç”¨æˆ·å¸å·"><a href="#åˆ é™¤ç”¨æˆ·å¸å·" class="headerlink" title="åˆ é™¤ç”¨æˆ·å¸å·"></a>åˆ é™¤ç”¨æˆ·å¸å·</h3><pre><code>userdel  åŒå»ºç«‹è´¦å·ç”¨æ³•ç›¸åŒ </code></pre><h3 id="æ–°å»ºç»„"><a href="#æ–°å»ºç»„" class="headerlink" title="æ–°å»ºç»„"></a>æ–°å»ºç»„</h3><pre><code>groupadd ç»„å</code></pre><h3 id="åˆ é™¤ç»„"><a href="#åˆ é™¤ç»„" class="headerlink" title="åˆ é™¤ç»„"></a>åˆ é™¤ç»„</h3><pre><code>groupdel ç»„å</code></pre><h3 id="ä¿®æ”¹è´¦å·"><a href="#ä¿®æ”¹è´¦å·" class="headerlink" title="ä¿®æ”¹è´¦å·"></a>ä¿®æ”¹è´¦å·</h3><pre><code>usermod é€‰é¡¹ ç”¨æˆ·åå’Œuseraddç”¨æ³•ç›¸åŒ</code></pre><h3 id="æŒ‡å®šå£ä»¤"><a href="#æŒ‡å®šå£ä»¤" class="headerlink" title="æŒ‡å®šå£ä»¤"></a>æŒ‡å®šå£ä»¤</h3><p>ç”¨æˆ·å£ä»¤ç®¡ç†ç»™rootè®¾ç½®å¯†ç (ç”¨æˆ·è´¦å·åˆšåˆ›å»ºæ—¶æ²¡æœ‰å£ä»¤ï¼Œä½†æ˜¯è¢«ç³»ç»Ÿé”å®šï¼Œæ— æ³•ä½¿ç”¨ï¼Œå¿…é¡»ä¸ºå…¶æŒ‡å®šå£ä»¤åæ‰å¯ä»¥ä½¿ç”¨ï¼Œå³ä½¿æ˜¯æŒ‡å®šç©ºå£ä»¤)</p><pre><code>passwd root -l é”å®šå£ä»¤ï¼Œå³ç¦ç”¨è´¦å·ã€‚-u å£ä»¤è§£é”ã€‚-d ä½¿è´¦å·æ— å£ä»¤ã€‚-f å¼ºè¿«ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶ä¿®æ”¹å£ä»¤ã€‚</code></pre><h3 id="åˆ‡æ¢ç”¨æˆ·"><a href="#åˆ‡æ¢ç”¨æˆ·" class="headerlink" title="åˆ‡æ¢ç”¨æˆ·"></a>åˆ‡æ¢ç”¨æˆ·</h3><pre><code>su root su - root   åˆ‡æ¢åˆ°rootç”¨æˆ·æ”¹å˜ç¯å¢ƒå˜é‡su user   åˆ‡æ¢ç”¨æˆ·ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶.bashrcsu - user åˆ‡æ¢ç”¨æˆ·ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶/etc/profile ï¼ŒåŠ è½½bash_profile</code></pre><h3 id="ç³»ç»Ÿç¯å¢ƒå˜é‡æ–‡ä»¶"><a href="#ç³»ç»Ÿç¯å¢ƒå˜é‡æ–‡ä»¶" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒå˜é‡æ–‡ä»¶"></a>ç³»ç»Ÿç¯å¢ƒå˜é‡æ–‡ä»¶</h3><pre><code>cat /etc/profile æŸ¥çœ‹vim /etc/profile ç¼–è¾‘</code></pre><h3 id="ç”¨æˆ·ç¯å¢ƒå˜é‡æ–‡ä»¶"><a href="#ç”¨æˆ·ç¯å¢ƒå˜é‡æ–‡ä»¶" class="headerlink" title="ç”¨æˆ·ç¯å¢ƒå˜é‡æ–‡ä»¶"></a>ç”¨æˆ·ç¯å¢ƒå˜é‡æ–‡ä»¶</h3><pre><code>cat /etc/bash_profile æŸ¥çœ‹vim /etc/bash_profile ç¼–è¾‘cat .bashrc</code></pre><h3 id="æ›´æ”¹æ–‡ä»¶çš„ç”¨æˆ·åŠç”¨æˆ·ç»„"><a href="#æ›´æ”¹æ–‡ä»¶çš„ç”¨æˆ·åŠç”¨æˆ·ç»„" class="headerlink" title="æ›´æ”¹æ–‡ä»¶çš„ç”¨æˆ·åŠç”¨æˆ·ç»„"></a>æ›´æ”¹æ–‡ä»¶çš„ç”¨æˆ·åŠç”¨æˆ·ç»„</h3><pre><code>sudo chown [-R] owner[:group] {File|Directory}ä¾‹å¦‚ï¼šè¿˜ä»¥jdk-7u21-linux-i586.tar.gzä¸ºä¾‹ã€‚å±äºç”¨æˆ·hadoopï¼Œç»„hadoop</code></pre><h3 id="åˆ‡æ¢æ­¤æ–‡ä»¶æ‰€å±çš„ç”¨æˆ·åŠç»„"><a href="#åˆ‡æ¢æ­¤æ–‡ä»¶æ‰€å±çš„ç”¨æˆ·åŠç»„" class="headerlink" title="åˆ‡æ¢æ­¤æ–‡ä»¶æ‰€å±çš„ç”¨æˆ·åŠç»„"></a>åˆ‡æ¢æ­¤æ–‡ä»¶æ‰€å±çš„ç”¨æˆ·åŠç»„</h3><pre><code>sudo chown root:root jdk-7u21-linux-i586.tar.gz</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³æœºé‡å¯æ“ä½œ</title>
      <link href="/2018/07/16/linux/shutdown/"/>
      <url>/2018/07/16/linux/shutdown/</url>
      
        <content type="html"><![CDATA[<h3 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h3><pre><code>shutdown -r  å…³æœºé‡å¯shutdown -h  å…³æœºä¸é‡å¯shutdown now  ç«‹åˆ»å…³æœº</code></pre><h3 id="halt"><a href="#halt" class="headerlink" title="halt"></a>halt</h3><p>å…³æœº</p><h3 id="reboot"><a href="#reboot" class="headerlink" title="reboot"></a>reboot</h3><p>é‡å¯</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå¤‡ä»½æ“ä½œ</title>
      <link href="/2018/07/15/linux/backup/"/>
      <url>/2018/07/15/linux/backup/</url>
      
        <content type="html"><![CDATA[<h3 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h3><pre><code>tar -cvf log.tar log2012.log    ä»…æ‰“åŒ…ï¼Œä¸å‹ç¼©ï¼ tar -zcvf log.tar.gz log2012.log   æ‰“åŒ…åï¼Œä»¥ gzip å‹ç¼© tar -jcvf log.tar.bz2 log2012.log  æ‰“åŒ…åï¼Œä»¥ bzip2 å‹ç¼© tar -zxvf /opt/soft/test/log.tar.gz è§£å‹ç¼©</code></pre><h3 id="dump"><a href="#dump" class="headerlink" title="dump"></a>dump</h3><pre><code>dump -0aj -f /tmp/home0.bak /home  åˆ¶ä½œä¸€ä¸ª &#39;/home&#39; ç›®å½•çš„å®Œæ•´å¤‡ä»½dump -1aj -f /tmp/home0.bak /home  åˆ¶ä½œä¸€ä¸ª &#39;/home&#39; ç›®å½•çš„äº¤äº’å¼å¤‡ä»½</code></pre><h3 id="restore"><a href="#restore" class="headerlink" title="restore"></a>restore</h3><pre><code>restore -if /tmp/home0.bak  è¿˜åŸå¤‡ä»½</code></pre><h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><pre><code>rsync -rogpav --delete /home /tmp  åŒæ­¥ä¸¤è¾¹çš„ç›®å½• rsync -rogpav -e ssh --delete /home ip_address:/tmp  é€šè¿‡SSHé€šé“rsync rsync -az -e ssh --delete ip_addr:/home/public /home/local  é€šè¿‡sshå’Œå‹ç¼©å°†ä¸€ä¸ªè¿œç¨‹ç›®å½•åŒæ­¥åˆ°æœ¬åœ°ç›®å½• rsync -az -e ssh --delete /home/local ip_addr:/home/public  é€šè¿‡sshå’Œå‹ç¼©å°†æœ¬åœ°ç›®å½•åŒæ­¥åˆ°è¿œç¨‹ç›®å½• </code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxè½¯ä»¶åŒ…ç®¡ç†</title>
      <link href="/2018/07/12/linux/package/"/>
      <url>/2018/07/12/linux/package/</url>
      
        <content type="html"><![CDATA[<h3 id="dpkg"><a href="#dpkg" class="headerlink" title="dpkg"></a>dpkg</h3><p>(Debian Package)ç®¡ç†å·¥å…·ï¼Œè½¯ä»¶åŒ…åä»¥.debåç¼€</p><pre><code>sudo dpkg -i package.deb å®‰è£…/æ›´æ–° deb åŒ… sudo dpkg -r package åˆ é™¤ deb åŒ… sudo dpkg -l è·å–æ‰€æœ‰å·²ç»å®‰è£…çš„ deb åŒ… sudo dpkg -s package è·å¾—å·²ç»å®‰è£…çš„åŒ…çš„ä¿¡æ¯</code></pre><h3 id="APT"><a href="#APT" class="headerlink" title="APT"></a>APT</h3><p>ï¼ˆAdvanced Packaging Toolï¼‰</p><pre><code>sudo apt-get install package å®‰è£…packageåŒ…sudo apt-get remove package å¸è½½packageåŒ…sudo apt-get upgrade æ›´æ–°æ‰€æœ‰packageåŒ…  sudo apt-get update æ›´æ–°packageåŒ…                             </code></pre><h3 id="YUM-è½¯ä»¶åŒ…å‡çº§å™¨"><a href="#YUM-è½¯ä»¶åŒ…å‡çº§å™¨" class="headerlink" title="YUM è½¯ä»¶åŒ…å‡çº§å™¨"></a>YUM è½¯ä»¶åŒ…å‡çº§å™¨</h3><pre><code>yum install package ä¸‹è½½å¹¶å®‰è£…rpmåŒ… yum update package æ›´æ–°rpmåŒ… yum remove package åˆ é™¤rpmåŒ… yum list åˆ—å‡ºå½“å‰ç³»ç»Ÿä¸­å®‰è£…çš„æ‰€æœ‰åŒ…yum search package åœ¨rpmä»“åº“ä¸­æœå¯»è½¯ä»¶åŒ… yum clean packages æ¸…ç†rpmç¼“å­˜åˆ é™¤ä¸‹è½½çš„åŒ… yum clean headers åˆ é™¤æ‰€æœ‰å¤´æ–‡ä»¶yum clean all åˆ é™¤æ‰€æœ‰ç¼“å­˜çš„åŒ…å’Œå¤´æ–‡ä»¶ </code></pre><h3 id="RPMåŒ…"><a href="#RPMåŒ…" class="headerlink" title="RPMåŒ…"></a>RPMåŒ…</h3><pre><code>rpm -ivh package.rpm å®‰è£…rpmåŒ… rpm -ivh --nodeeps package.rpm å®‰è£…rpmåŒ…è€Œå¿½ç•¥ä¾èµ–å…³ç³»è­¦å‘Š rpm -U package.rpm æ›´æ–°rpmåŒ…ä½†ä¸æ”¹å˜å…¶é…ç½®æ–‡ä»¶ rpm -F package.rpm æ›´æ–°ç¡®å®šå·²ç»å®‰è£…çš„rpmåŒ… rpm -e package.rpm åˆ é™¤rpmåŒ… rpm -qa æ˜¾ç¤ºç³»ç»Ÿä¸­æ‰€æœ‰å·²ç»å®‰è£…çš„rpmåŒ… </code></pre><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p>rpmæ–‡ä»¶æ˜¯Redhatæ”¯æŒçš„è½¯ä»¶åŒ…æ ¼å¼ï¼Œè€Œ.debæ˜¯Debianä¸Šæ”¯æŒè½¯ä»¶åŒ…çš„æ‰©å±•å</p><p>ç”±äºubuntuæ˜¯å¯¹Debiançš„æ‰©å±•ï¼Œåœ¨ubuntuä¸‹ä¸èƒ½ç›´æ¥ä½¿.rpmæ–‡ä»¶çš„ï¼Œéœ€è¦å°†.rmpè½¬æ¢æˆ.deb</p><p>è§£å†³æ–¹æ³•</p><p>1.å®‰è£…alienï¼Œæ‰§è¡Œ<code>sudo apt-get install alien</code></p><p>2.ä½¿ç”¨alienï¼Œæ‰§è¡Œ<code>sudo alien abc.rpm</code></p><p>3.æ‰§è¡Œå®Œæˆåï¼Œç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªabc.debæ–‡ä»¶</p><p>4.å®‰è£…å¹¶ä½¿ç”¨dpkg</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxæ‰“åŒ…å‹ç¼©ç›¸å…³æŒ‡ä»¤</title>
      <link href="/2018/07/10/linux/compression/"/>
      <url>/2018/07/10/linux/compression/</url>
      
        <content type="html"><![CDATA[<h3 id="bzip2-é€‰é¡¹-å‚æ•°"><a href="#bzip2-é€‰é¡¹-å‚æ•°" class="headerlink" title="bzip2(é€‰é¡¹)(å‚æ•°)"></a>bzip2(é€‰é¡¹)(å‚æ•°)</h3><p>å‘½ä»¤ç”¨äºåˆ›å»ºå’Œç®¡ç†ï¼ˆåŒ…æ‹¬è§£å‹ç¼©ï¼‰</p><pre><code>  -cæˆ–â€”â€”stdoutï¼šå°†å‹ç¼©ä¸è§£å‹ç¼©çš„ç»“æœé€åˆ°æ ‡å‡†è¾“å‡ºï¼›  -dæˆ–â€”â€”decompressï¼šæ‰§è¡Œè§£å‹ç¼©ï¼›  -fæˆ–-forceï¼šbzip2åœ¨å‹ç¼©æˆ–è§£å‹ç¼©æ—¶ï¼Œè‹¥è¾“å‡ºæ–‡ä»¶ä¸ç°æœ‰æ–‡ä»¶åŒåï¼Œé¢„è®¾ä¸ä¼šè¦†ç›–ç°æœ‰æ–‡ä»¶ã€‚è‹¥è¦è¦†ç›–ã€‚è¯·ä½¿ç”¨æ­¤å‚æ•°ï¼›  -hæˆ–â€”â€”helpï¼šåœ¨çº¿å¸®åŠ©ï¼›  -kæˆ–â€”â€”keepï¼šbzip2åœ¨å‹ç¼©æˆ–è§£å‹ç¼©åï¼Œä¼šåˆ é™¤åŸå§‹æ–‡ä»¶ã€‚è‹¥è¦ä¿ç•™åŸå§‹æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨æ­¤å‚æ•°ï¼›  -sæˆ–â€”â€”smallï¼šé™ä½ç¨‹åºæ‰§è¡Œæ—¶å†…å­˜çš„ä½¿ç”¨é‡ï¼›  -tæˆ–â€”â€”testï¼šæµ‹è¯•.bz2å‹ç¼©æ–‡ä»¶çš„å®Œæ•´æ€§ï¼›  -væˆ–â€”â€”verboseï¼šå‹ç¼©æˆ–è§£å‹ç¼©æ–‡ä»¶æ—¶ï¼Œæ˜¾ç¤ºè¯¦ç»†çš„ä¿¡æ¯ï¼›  -zæˆ–â€”â€”compressï¼šå¼ºåˆ¶æ‰§è¡Œå‹ç¼©ï¼›  -Væˆ–â€”â€”versionï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ï¼›  --repetitive-bestï¼šè‹¥æ–‡ä»¶ä¸­æœ‰é‡å¤å‡ºç°çš„èµ„æ–™æ—¶ï¼Œå¯åˆ©ç”¨æ­¤å‚æ•°æé«˜å‹ç¼©æ•ˆæœï¼›  --repetitive-fastï¼šè‹¥æ–‡ä»¶ä¸­æœ‰é‡å¤å‡ºç°çš„èµ„æ–™æ—¶ï¼Œå¯åˆ©ç”¨æ­¤å‚æ•°åŠ å¿«æ‰§è¡Œæ•ˆæœã€‚</code></pre><h3 id="gunzip-é€‰é¡¹-å‚æ•°"><a href="#gunzip-é€‰é¡¹-å‚æ•°" class="headerlink" title="gunzip(é€‰é¡¹)(å‚æ•°)"></a>gunzip(é€‰é¡¹)(å‚æ•°)</h3><p>å‘½ä»¤ç”¨æ¥è§£å‹ç¼©æ–‡ä»¶</p><pre><code>  -aæˆ–â€”â€”asciiï¼šä½¿ç”¨ASCIIæ–‡å­—æ¨¡å¼ï¼›  -cæˆ–--stdoutæˆ–--to-stdoutï¼šæŠŠè§£å‹åçš„æ–‡ä»¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼›  -fæˆ–-forceï¼šå¼ºè¡Œè§£å¼€å‹ç¼©æ–‡ä»¶ï¼Œä¸ç†ä¼šæ–‡ä»¶åç§°æˆ–ç¡¬è¿æ¥æ˜¯å¦å­˜åœ¨ä»¥åŠè¯¥æ–‡ä»¶æ˜¯å¦ä¸ºç¬¦å·è¿æ¥ï¼›  -hæˆ–â€”â€”helpï¼šåœ¨çº¿å¸®åŠ©ï¼›  -læˆ–â€”â€”listï¼šåˆ—å‡ºå‹ç¼©æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ï¼›  -Læˆ–â€”â€”licenseï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¸ç‰ˆæƒä¿¡æ¯ï¼›  -næˆ–--no-nameï¼šè§£å‹ç¼©æ—¶ï¼Œè‹¥å‹ç¼©æ–‡ä»¶å†…å«æœ‰åŸæ¥çš„æ–‡ä»¶åç§°åŠæ—¶é—´æˆ³è®°ï¼Œåˆ™å°†å…¶å¿½ç•¥ä¸äºˆå¤„ç†ï¼›  -Næˆ–â€”â€”nameï¼šè§£å‹ç¼©æ—¶ï¼Œè‹¥å‹ç¼©æ–‡ä»¶å†…å«æœ‰åŸæ¥çš„æ–‡ä»¶åç§°åŠæ—¶é—´æˆ³è®°ï¼Œåˆ™å°†å…¶å›å­˜åˆ°è§£å¼€çš„æ–‡ä»¶ä¸Šï¼›  -qæˆ–â€”â€”quietï¼šä¸æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼›  -ræˆ–â€”â€”recursiveï¼šé€’å½’å¤„ç†ï¼Œå°†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŠå­ç›®å½•ä¸€å¹¶å¤„ç†ï¼›  -Sæˆ–&lt;å‹ç¼©å­—å°¾å­—ç¬¦ä¸²&gt;æˆ–----suffix&lt;å‹ç¼©å­—å°¾å­—ç¬¦ä¸²&gt;ï¼šæ›´æ”¹å‹ç¼©å­—å°¾å­—ç¬¦ä¸²ï¼›  -tæˆ–â€”â€”testï¼šæµ‹è¯•å‹ç¼©æ–‡ä»¶æ˜¯å¦æ­£ç¡®æ— è¯¯ï¼›  -væˆ–â€”â€”verboseï¼šæ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ï¼›  -Væˆ–â€”â€”versionï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ï¼›</code></pre><h3 id="gzip-é€‰é¡¹-å‚æ•°"><a href="#gzip-é€‰é¡¹-å‚æ•°" class="headerlink" title="gzip(é€‰é¡¹)(å‚æ•°)"></a>gzip(é€‰é¡¹)(å‚æ•°)</h3><p>å‘½ä»¤ç”¨æ¥å‹ç¼©æ–‡ä»¶</p><pre><code>  -aæˆ–â€”â€”asciiï¼šä½¿ç”¨ASCIIæ–‡å­—æ¨¡å¼ï¼›  -dæˆ–--decompressæˆ–----uncompressï¼šè§£å¼€å‹ç¼©æ–‡ä»¶ï¼›  -fæˆ–â€”â€”forceï¼šå¼ºè¡Œå‹ç¼©æ–‡ä»¶ã€‚ä¸ç†ä¼šæ–‡ä»¶åç§°æˆ–ç¡¬è¿æ¥æ˜¯å¦å­˜åœ¨ä»¥åŠè¯¥æ–‡ä»¶æ˜¯å¦ä¸ºç¬¦å·è¿æ¥ï¼›  -hæˆ–â€”â€”helpï¼šåœ¨çº¿å¸®åŠ©ï¼›  -læˆ–â€”â€”listï¼šåˆ—å‡ºå‹ç¼©æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ï¼›  -Læˆ–â€”â€”licenseï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¸ç‰ˆæƒä¿¡æ¯ï¼›  -næˆ–--no-nameï¼šå‹ç¼©æ–‡ä»¶æ—¶ï¼Œä¸ä¿å­˜åŸæ¥çš„æ–‡ä»¶åç§°åŠæ—¶é—´æˆ³è®°ï¼›  -Næˆ–â€”â€”nameï¼šå‹ç¼©æ–‡ä»¶æ—¶ï¼Œä¿å­˜åŸæ¥çš„æ–‡ä»¶åç§°åŠæ—¶é—´æˆ³è®°ï¼›  -qæˆ–â€”â€”quietï¼šä¸æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼›  -ræˆ–â€”â€”recursiveï¼šé€’å½’å¤„ç†ï¼Œå°†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŠå­ç›®å½•ä¸€å¹¶å¤„ç†ï¼›  -Sæˆ–&lt;å‹ç¼©å­—å°¾å­—ç¬¦ä¸²&gt;æˆ–----suffix&lt;å‹ç¼©å­—å°¾å­—ç¬¦ä¸²&gt;ï¼šæ›´æ”¹å‹ç¼©å­—å°¾å­—ç¬¦ä¸²ï¼›  -tæˆ–â€”â€”testï¼šæµ‹è¯•å‹ç¼©æ–‡ä»¶æ˜¯å¦æ­£ç¡®æ— è¯¯ï¼›  -væˆ–â€”â€”verboseï¼šæ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ï¼›  -Væˆ–â€”â€”versionï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ï¼›  -&lt;å‹ç¼©æ•ˆç‡&gt;ï¼šå‹ç¼©æ•ˆç‡æ˜¯ä¸€ä¸ªä»‹äº1~9çš„æ•°å€¼ï¼Œé¢„è®¾å€¼ä¸ºâ€œ6â€ï¼ŒæŒ‡å®šæ„ˆå¤§çš„æ•°å€¼ï¼Œå‹ç¼©æ•ˆç‡å°±ä¼šæ„ˆé«˜ï¼›  --bestï¼šæ­¤å‚æ•°çš„æ•ˆæœå’ŒæŒ‡å®šâ€œ-9â€å‚æ•°ç›¸åŒï¼›  --fastï¼šæ­¤å‚æ•°çš„æ•ˆæœå’ŒæŒ‡å®šâ€œ-1â€å‚æ•°ç›¸åŒã€‚</code></pre><h3 id="tar-é€‰é¡¹-å‚æ•°"><a href="#tar-é€‰é¡¹-å‚æ•°" class="headerlink" title="tar(é€‰é¡¹)(å‚æ•°)"></a>tar(é€‰é¡¹)(å‚æ•°)</h3><p>å‘½ä»¤ç”¨æ¥è§£å‹å‹ç¼©æ–‡ä»¶</p><pre><code>  -Aæˆ–--catenateï¼šæ–°å¢æ–‡ä»¶åˆ°ä»¥å­˜åœ¨çš„å¤‡ä»½æ–‡ä»¶ï¼›  -Bï¼šè®¾ç½®åŒºå—å¤§å°ï¼›  -cæˆ–--createï¼šå»ºç«‹æ–°çš„å¤‡ä»½æ–‡ä»¶ï¼›  -C &lt;ç›®å½•&gt;ï¼šè¿™ä¸ªé€‰é¡¹ç”¨åœ¨è§£å‹ç¼©ï¼Œè‹¥è¦åœ¨ç‰¹å®šç›®å½•è§£å‹ç¼©ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªé€‰é¡¹ã€‚  -dï¼šè®°å½•æ–‡ä»¶çš„å·®åˆ«ï¼›  -xæˆ–--extractæˆ–--getï¼šä»å¤‡ä»½æ–‡ä»¶ä¸­è¿˜åŸæ–‡ä»¶ï¼›  -tæˆ–--listï¼šåˆ—å‡ºå¤‡ä»½æ–‡ä»¶çš„å†…å®¹ï¼›  -zæˆ–--gzipæˆ–--ungzipï¼šé€šè¿‡gzipæŒ‡ä»¤å¤„ç†å¤‡ä»½æ–‡ä»¶ï¼›  -Zæˆ–--compressæˆ–--uncompressï¼šé€šè¿‡compressæŒ‡ä»¤å¤„ç†å¤‡ä»½æ–‡ä»¶ï¼›  -f&lt;å¤‡ä»½æ–‡ä»¶&gt;æˆ–--file=&lt;å¤‡ä»½æ–‡ä»¶&gt;ï¼šæŒ‡å®šå¤‡ä»½æ–‡ä»¶ï¼›  -væˆ–--verboseï¼šæ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ï¼›  -rï¼šæ·»åŠ æ–‡ä»¶åˆ°å·²ç»å‹ç¼©çš„æ–‡ä»¶ï¼›  -uï¼šæ·»åŠ æ”¹å˜äº†å’Œç°æœ‰çš„æ–‡ä»¶åˆ°å·²ç»å­˜åœ¨çš„å‹ç¼©æ–‡ä»¶ï¼›  -jï¼šæ”¯æŒbzip2è§£å‹æ–‡ä»¶ï¼›  -vï¼šæ˜¾ç¤ºæ“ä½œè¿‡ç¨‹ï¼›  -lï¼šæ–‡ä»¶ç³»ç»Ÿè¾¹ç•Œè®¾ç½®ï¼›  -kï¼šä¿ç•™åŸæœ‰æ–‡ä»¶ä¸è¦†ç›–ï¼›  -mï¼šä¿ç•™æ–‡ä»¶ä¸è¢«è¦†ç›–ï¼›  -wï¼šç¡®è®¤å‹ç¼©æ–‡ä»¶çš„æ­£ç¡®æ€§ï¼›  -pæˆ–--same-permissionsï¼šç”¨åŸæ¥çš„æ–‡ä»¶æƒé™è¿˜åŸæ–‡ä»¶ï¼›  -Pæˆ–--absolute-namesï¼šæ–‡ä»¶åä½¿ç”¨ç»å¯¹åç§°ï¼Œä¸ç§»é™¤æ–‡ä»¶åç§°å‰çš„â€œ/â€å·ï¼›  -N &lt;æ—¥æœŸæ ¼å¼&gt; æˆ– --newer=&lt;æ—¥æœŸæ—¶é—´&gt;ï¼šåªå°†è¾ƒæŒ‡å®šæ—¥æœŸæ›´æ–°çš„æ–‡ä»¶ä¿å­˜åˆ°å¤‡ä»½æ–‡ä»¶é‡Œï¼›  --exclude=&lt;èŒƒæœ¬æ ·å¼&gt;ï¼šæ’é™¤ç¬¦åˆèŒƒæœ¬æ ·å¼çš„æ–‡ä»¶ã€‚</code></pre><p>  å®ä¾‹<br></p><pre><code>  tar -cvf log.tar log2012.log    ä»…æ‰“åŒ…ï¼Œä¸å‹ç¼©ï¼   tar -zcvf log.tar.gz log2012.log   æ‰“åŒ…åï¼Œä»¥ gzip å‹ç¼©   tar -jcvf log.tar.bz2 log2012.log  æ‰“åŒ…åï¼Œä»¥ bzip2 å‹ç¼© </code></pre><h3 id="zip-é€‰é¡¹-å‚æ•°"><a href="#zip-é€‰é¡¹-å‚æ•°" class="headerlink" title="zip(é€‰é¡¹)(å‚æ•°)"></a>zip(é€‰é¡¹)(å‚æ•°)</h3><p>å‘½ä»¤å¯ä»¥ç”¨æ¥è§£å‹ç¼©æ–‡ä»¶</p><pre><code>  -Aï¼šè°ƒæ•´å¯æ‰§è¡Œçš„è‡ªåŠ¨è§£å‹ç¼©æ–‡ä»¶ï¼›  -b&lt;å·¥ä½œç›®å½•&gt;ï¼šæŒ‡å®šæš‚æ—¶å­˜æ”¾æ–‡ä»¶çš„ç›®å½•ï¼›  -cï¼šæ›¿æ¯ä¸ªè¢«å‹ç¼©çš„æ–‡ä»¶åŠ ä¸Šæ³¨é‡Šï¼›  -dï¼šä»å‹ç¼©æ–‡ä»¶å†…åˆ é™¤æŒ‡å®šçš„æ–‡ä»¶ï¼›  -Dï¼šå‹ç¼©æ–‡ä»¶å†…ä¸å»ºç«‹ç›®å½•åç§°ï¼›  -fï¼šæ­¤å‚æ•°çš„æ•ˆæœå’ŒæŒ‡å®šâ€œ-uâ€å‚æ•°ç±»ä¼¼ï¼Œä½†ä¸ä»…æ›´æ–°æ—¢æœ‰æ–‡ä»¶ï¼Œå¦‚æœæŸäº›æ–‡ä»¶åŸæœ¬ä¸å­˜åœ¨äºå‹ç¼©æ–‡ä»¶å†…ï¼Œä½¿ç”¨æœ¬å‚æ•°ä¼šä¸€å¹¶å°†å…¶åŠ å…¥å‹ç¼©æ–‡ä»¶ä¸­ï¼›  -Fï¼šå°è¯•ä¿®å¤å·²æŸåçš„å‹ç¼©æ–‡ä»¶ï¼›  -gï¼šå°†æ–‡ä»¶å‹ç¼©åé™„åŠ åœ¨å·²æœ‰çš„å‹ç¼©æ–‡ä»¶ä¹‹åï¼Œè€Œéå¦è¡Œå»ºç«‹æ–°çš„å‹ç¼©æ–‡ä»¶ï¼›  -hï¼šåœ¨çº¿å¸®åŠ©ï¼›  -i&lt;èŒƒæœ¬æ ·å¼&gt;ï¼šåªå‹ç¼©ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼›  -jï¼šåªä¿å­˜æ–‡ä»¶åç§°åŠå…¶å†…å®¹ï¼Œè€Œä¸å­˜æ”¾ä»»ä½•ç›®å½•åç§°ï¼›  -Jï¼šåˆ é™¤å‹ç¼©æ–‡ä»¶å‰é¢ä¸å¿…è¦çš„æ•°æ®ï¼›  -kï¼šä½¿ç”¨MS-DOSå…¼å®¹æ ¼å¼çš„æ–‡ä»¶åç§°ï¼›  -lï¼šå‹ç¼©æ–‡ä»¶æ—¶ï¼ŒæŠŠLFå­—ç¬¦ç½®æ¢æˆLF+CRå­—ç¬¦ï¼›  -llï¼šå‹ç¼©æ–‡ä»¶æ—¶ï¼ŒæŠŠLF+cpå­—ç¬¦ç½®æ¢æˆLFå­—ç¬¦ï¼›  -Lï¼šæ˜¾ç¤ºç‰ˆæƒä¿¡æ¯ï¼›  -mï¼šå°†æ–‡ä»¶å‹ç¼©å¹¶åŠ å…¥å‹ç¼©æ–‡ä»¶åï¼Œåˆ é™¤åŸå§‹æ–‡ä»¶ï¼Œå³æŠŠæ–‡ä»¶ç§»åˆ°å‹ç¼©æ–‡ä»¶ä¸­ï¼›  -n&lt;å­—å°¾å­—ç¬¦ä¸²&gt;ï¼šä¸å‹ç¼©å…·æœ‰ç‰¹å®šå­—å°¾å­—ç¬¦ä¸²çš„æ–‡ä»¶ï¼›  -oï¼šä»¥å‹ç¼©æ–‡ä»¶å†…æ‹¥æœ‰æœ€æ–°æ›´æ”¹æ—¶é—´çš„æ–‡ä»¶ä¸ºå‡†ï¼Œå°†å‹ç¼©æ–‡ä»¶çš„æ›´æ”¹æ—¶é—´è®¾æˆå’Œè¯¥æ–‡ä»¶ç›¸åŒï¼›  -qï¼šä¸æ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ï¼›  -rï¼šé€’å½’å¤„ç†ï¼Œå°†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•ä¸€å¹¶å¤„ç†ï¼›  -Sï¼šåŒ…å«ç³»ç»Ÿå’Œéšè—æ–‡ä»¶ï¼›  -t&lt;æ—¥æœŸæ—¶é—´&gt;ï¼šæŠŠå‹ç¼©æ–‡ä»¶çš„æ—¥æœŸè®¾æˆæŒ‡å®šçš„æ—¥æœŸï¼›  -Tï¼šæ£€æŸ¥å¤‡ä»½æ–‡ä»¶å†…çš„æ¯ä¸ªæ–‡ä»¶æ˜¯å¦æ­£ç¡®æ— è¯¯ï¼›  -uï¼šæ›´æ¢è¾ƒæ–°çš„æ–‡ä»¶åˆ°å‹ç¼©æ–‡ä»¶å†…ï¼›  -vï¼šæ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹æˆ–æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ï¼›  -Vï¼šä¿å­˜VMSæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶å±æ€§ï¼›  -wï¼šåœ¨æ–‡ä»¶åç§°é‡Œå‡å¦‚ç‰ˆæœ¬ç¼–å·ï¼Œæœ¬å‚æ•°ä»…åœ¨VMSæ“ä½œç³»ç»Ÿä¸‹æœ‰æ•ˆï¼›  -x&lt;èŒƒæœ¬æ ·å¼&gt;ï¼šå‹ç¼©æ—¶æ’é™¤ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼›  -Xï¼šä¸ä¿å­˜é¢å¤–çš„æ–‡ä»¶å±æ€§ï¼›  -yï¼šç›´æ¥ä¿å­˜ç¬¦å·è¿æ¥ï¼Œè€Œéè¯¥é“¾æ¥æ‰€æŒ‡å‘çš„æ–‡ä»¶ï¼Œæœ¬å‚æ•°ä»…åœ¨UNIXä¹‹ç±»çš„ç³»ç»Ÿä¸‹æœ‰æ•ˆï¼›  -zï¼šæ›¿å‹ç¼©æ–‡ä»¶åŠ ä¸Šæ³¨é‡Šï¼›  -$ï¼šä¿å­˜ç¬¬ä¸€ä¸ªè¢«å‹ç¼©æ–‡ä»¶æ‰€åœ¨ç£ç›˜çš„å·å†Œåç§°ï¼›  -&lt;å‹ç¼©æ•ˆç‡&gt;ï¼šå‹ç¼©æ•ˆç‡æ˜¯ä¸€ä¸ªä»‹äº1~9çš„æ•°å€¼ã€‚</code></pre><p>  å®ä¾‹<br></p><pre><code>  zip file1.zip file1 åˆ›å»ºä¸€ä¸ªzipæ ¼å¼çš„å‹ç¼©åŒ…   zip -r file1.zip file1 file2 dir1 å°†å‡ ä¸ªæ–‡ä»¶å’Œç›®å½•åŒæ—¶å‹ç¼©æˆä¸€ä¸ªzipæ ¼å¼çš„å‹ç¼©åŒ…   unzip file1.zip è§£å‹ä¸€ä¸ªzipæ ¼å¼å‹ç¼©åŒ… </code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç³»ç»Ÿç®¡ç†æŒ‡ä»¤</title>
      <link href="/2018/07/02/linux/system/"/>
      <url>/2018/07/02/linux/system/</url>
      
        <content type="html"><![CDATA[<h3 id="stat"><a href="#stat" class="headerlink" title="stat"></a>stat</h3><p>æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯</p><h3 id="who"><a href="#who" class="headerlink" title="who"></a>who</h3><p>æ˜¾ç¤ºåœ¨çº¿ç™»é™†ç”¨æˆ·</p><h3 id="whoami"><a href="#whoami" class="headerlink" title="whoami"></a>whoami</h3><p>æ˜¾ç¤ºå½“å‰æ“ä½œç”¨æˆ·</p><h3 id="hostname"><a href="#hostname" class="headerlink" title="hostname"></a>hostname</h3><p>æ˜¾ç¤ºä¸»æœºå</p><h3 id="uname"><a href="#uname" class="headerlink" title="uname"></a>uname</h3><p>æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯</p><h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3><p>åŠ¨æ€æ˜¾ç¤ºå½“å‰è€—è´¹èµ„æºæœ€å¤šè¿›ç¨‹ä¿¡æ¯</p><h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><p>æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€ </p><pre><code>ps -aux-A ï¼šæ‰€æœ‰çš„è¿›ç¨‹å‡æ˜¾ç¤ºå‡ºæ¥ï¼Œä¸ -e å…·æœ‰åŒæ ·çš„æ•ˆç”¨-a ï¼šæ˜¾ç¤ºç°è¡Œç»ˆç«¯æœºä¸‹çš„æ‰€æœ‰è¿›ç¨‹ï¼ŒåŒ…æ‹¬å…¶ä»–ç”¨æˆ·çš„è¿›ç¨‹-u ï¼šä»¥ç”¨æˆ·ä¸ºä¸»çš„è¿›ç¨‹çŠ¶æ€x ï¼šé€šå¸¸ä¸ a è¿™ä¸ªå‚æ•°ä¸€èµ·ä½¿ç”¨ï¼Œå¯åˆ—å‡ºè¾ƒå®Œæ•´ä¿¡æ¯</code></pre><h3 id="du"><a href="#du" class="headerlink" title="du"></a>du</h3><p>æŸ¥çœ‹ç›®å½•å¤§å° <code>du -h /home</code>å¸¦æœ‰å•ä½æ˜¾ç¤ºç›®å½•ä¿¡æ¯</p><h3 id="df"><a href="#df" class="headerlink" title="df"></a>df</h3><p>æŸ¥çœ‹ç£ç›˜å¤§å° <code>df -h</code>å¸¦æœ‰å•ä½æ˜¾ç¤ºç£ç›˜ä¿¡æ¯</p><h3 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h3><p>æŸ¥çœ‹ç½‘ç»œæƒ…å†µ</p><h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>æµ‹è¯•ç½‘ç»œè¿é€š</p><h3 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h3><p>æ˜¾ç¤ºç½‘ç»œçŠ¶æ€ä¿¡æ¯</p><h3 id="man"><a href="#man" class="headerlink" title="man"></a>man</h3><p>å‘½ä»¤å¸®åŠ©æ–‡æ¡£å¦‚ï¼š<code>man ls</code></p><h3 id="clear"><a href="#clear" class="headerlink" title="clear"></a>clear</h3><p>æ¸…å±</p><h3 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h3><p>å¯¹å‘½ä»¤é‡å‘½å</p><pre><code>alias l=&quot;ls&quot; </code></pre><h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h3><p>æ€æ­»è¿›ç¨‹ï¼Œå¯ä»¥å…ˆç”¨ps æˆ– topå‘½ä»¤æŸ¥çœ‹è¿›ç¨‹çš„idï¼Œç„¶åå†ç”¨killå‘½ä»¤æ€æ­»è¿›ç¨‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¸¸ç”¨æŒ‡ä»¤</title>
      <link href="/2018/06/23/linux/instructions/"/>
      <url>/2018/06/23/linux/instructions/</url>
      
        <content type="html"><![CDATA[<h3 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h3><p>æ˜¾ç¤ºæ–‡ä»¶æˆ–ç›®å½•</p><pre><code>ls -F  //æ˜¾ç¤ºæ–‡ä»¶æˆ–ç›®å½•ls -l  //åˆ—å‡ºæ–‡ä»¶è¯¦ç»†ä¿¡æ¯l(list)ls -a  //åˆ—å‡ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶åŠç›®å½•ï¼ŒåŒ…æ‹¬éšè—çš„a(all)</code></pre><h3 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h3><p>åˆ›å»ºç›®å½•</p><pre><code>mkdir dir  //åˆ›å»ºä¸€ä¸ªdirçš„ç›®å½•</code></pre><p>mkdir -p åˆ›å»ºç›®å½•ï¼Œè‹¥æ— çˆ¶ç›®å½•ï¼Œåˆ™åˆ›å»ºp(parent) <br></p><pre><code>mkdir -p /study/dir1/dir2  //åˆ›å»ºä¸€ä¸ªçš„ç›®å½•æ ‘</code></pre><h3 id="cd"><a href="#cd" class="headerlink" title="cd"></a>cd</h3><p>åˆ‡æ¢ç›®å½•</p><pre><code>cd ..  //è¿”å›ä¸Šçº§ç›®å½•cd /home  //è¿›å…¥æŒ‡å®šç›®å½•cd - //è¿”å›ä¸Šæ¬¡æ‰€åœ¨çš„ç›®å½• </code></pre><h3 id="touch"><a href="#touch" class="headerlink" title="touch"></a>touch</h3><p>ä¿®æ”¹æ–‡ä»¶æˆ–è€…ç›®å½•çš„æ—¶é—´å±æ€§ï¼ŒåŒ…æ‹¬å­˜å–æ—¶é—´å’Œæ›´æ”¹æ—¶é—´ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç³»ç»Ÿä¼šå»ºç«‹ä¸€ä¸ªæ–°çš„æ–‡ä»¶</p><pre><code>touch temp  //åˆ›å»ºåä¸ºtempçš„ç©ºæ–‡ä»¶touch temp  //å¦‚æœtempå­˜åœ¨åˆ™æ˜¯ä¿®æ”¹æ–‡ä»¶çš„æ—¶é—´å±æ€§ å¯é€šè¿‡ls -l temp æŸ¥çœ‹æ–‡ä»¶å±æ€§</code></pre><h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><p>å‘½ä»¤è¡Œè¾“å‡ºå†…å®¹</p><pre><code>echo &#39;zhangsan&#39; &gt;&gt; temp //åˆ›å»ºåä¸ºtempå¸¦æœ‰zhangsanå†…å®¹çš„æ–‡ä»¶</code></pre><h3 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h3><p>æŸ¥çœ‹æ–‡ä»¶å†…å®¹</p><pre><code>cat temp  //æŸ¥çœ‹tempæ–‡ä»¶ä¸­çš„å†…å®¹cat -n temp  //æ ‡ç¤ºæ–‡ä»¶çš„è¡Œæ•°</code></pre><h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h3><p>æ‹·è´</p><pre><code>cp temp newtemp  //å¤åˆ¶tempæ–‡ä»¶cp temp/* .  //å¤åˆ¶tempç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ°å½“å‰å·¥ä½œç›®å½• cp -a /temp/dir1 . //å¤åˆ¶/temp/dir1ç›®å½•åˆ°å½“å‰å·¥ä½œç›®å½• cp -a temp newtemp //å¤åˆ¶tempç›®å½• </code></pre><h3 id="mv"><a href="#mv" class="headerlink" title="mv"></a>mv</h3><p>ç§»åŠ¨æˆ–é‡å‘½å</p><pre><code>mv temp newtemp //é‡å‘½å/ç§»åŠ¨ä¸€ä¸ªç›®å½• </code></pre><h3 id="rm"><a href="#rm" class="headerlink" title="rm"></a>rm</h3><p>åˆ é™¤æ–‡ä»¶</p><pre><code>rm -f file  //åˆ é™¤fileæ–‡ä»¶&#39; rmdir dir1  //åˆ é™¤dir1çš„ç›®å½•&#39; rm -rf dir1 //é€’å½’åˆ é™¤dir1ç›®å½•æ‰€æœ‰çš„å†…å®¹rm -rf dir1 dir2 //åŒæ—¶åˆ é™¤ä¸¤ä¸ªç›®å½•åŠå®ƒä»¬çš„å†…å®¹ </code></pre><h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æŸ¥æ‰¾æŸæ–‡ä»¶</p><pre><code>find / -name file1  //ä»æ ¹æ–‡ä»¶ç³»ç»ŸæŸ¥æ‰¾æ–‡ä»¶å’Œç›®å½• find / -user renbo  //æŸ¥æ‰¾å±äºç”¨æˆ· &#39;renbo&#39; çš„æ–‡ä»¶å’Œç›®å½• find /home/renbo -name \*.bin  // æŸ¥æ‰¾å¸¦home/renboç›®å½•ä¸­æœ‰.binç»“å°¾çš„æ–‡ä»¶ find / -name \*.rpm -exec chmod 755 &#39;{}&#39; \ //æŸ¥æ‰¾ä»¥.rpmç»“å°¾çš„æ–‡ä»¶å¹¶å®šä¹‰å…¶æƒé™ find / -xdev -name \*.rpm  //æŸ¥æ‰¾æ‰€æœ‰ä»¥.rpmç»“å°¾çš„æ–‡ä»¶</code></pre><h3 id="wc"><a href="#wc" class="headerlink" title="wc"></a>wc</h3><p>ç»Ÿè®¡æ–‡æœ¬ä¸­è¡Œæ•°ã€å­—æ•°ã€å­—ç¬¦æ•°</p><pre><code>wc gitcommit.sh  //3   13  73 gitcommit.sh</code></pre><h3 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h3><p>åœ¨æ–‡æœ¬æ–‡ä»¶ä¸­æŸ¥æ‰¾æŸä¸ªå­—ç¬¦ä¸²</p><pre><code>grep Aug /var/log/messages  //åœ¨æ–‡ä»¶ &#39;/var/log/messages&#39;ä¸­æŸ¥æ‰¾å…³é”®è¯&quot;Aug&quot; grep ^Aug /var/log/messages  //åœ¨æ–‡ä»¶ &#39;/var/log/messages&#39;ä¸­æŸ¥æ‰¾ä»¥&quot;Aug&quot;å¼€å§‹çš„è¯æ±‡ grep [0-9] /var/log/messages //é€‰æ‹© &#39;/var/log/messages&#39; æ–‡ä»¶ä¸­æ‰€æœ‰åŒ…å«æ•°å­—çš„è¡Œ grep Aug -R /var/log/*  //åœ¨ç›®å½• &#39;/var/log&#39; åŠéšåçš„ç›®å½•ä¸­æœç´¢å­—ç¬¦ä¸²&quot;Aug&quot; </code></pre><h3 id="tree"><a href="#tree" class="headerlink" title="tree"></a>tree</h3><p>æ ‘å½¢ç»“æ„æ˜¾ç¤ºç›®å½•ï¼Œéœ€è¦å®‰è£…treeåŒ…</p><pre><code>tree  //æ˜¾ç¤ºæ–‡ä»¶å’Œç›®å½•ç”±æ ¹ç›®å½•å¼€å§‹çš„æ ‘å½¢ç»“æ„ </code></pre><h3 id="pwd"><a href="#pwd" class="headerlink" title="pwd"></a>pwd</h3><p>æ˜¾ç¤ºå½“å‰ç›®å½•</p><pre><code>pwd æ˜¾ç¤ºå½“å‰è·¯å¾„</code></pre><h3 id="ln"><a href="#ln" class="headerlink" title="ln"></a>ln</h3><p>åˆ›å»ºé“¾æ¥æ–‡ä»¶</p><pre><code>ln -s file1 lnk1  //åˆ›å»ºä¸€ä¸ªæŒ‡å‘æ–‡ä»¶æˆ–ç›®å½•çš„è½¯é“¾æ¥ ln file1 lnk1  //åˆ›å»ºä¸€ä¸ªæŒ‡å‘æ–‡ä»¶æˆ–ç›®å½•çš„ç‰©ç†é“¾æ¥ </code></pre><h3 id="moreã€less"><a href="#moreã€less" class="headerlink" title="moreã€less"></a>moreã€less</h3><p>åˆ†é¡µæ˜¾ç¤ºæ–‡æœ¬æ–‡ä»¶å†…å®¹</p><pre><code>more file1  //æŸ¥çœ‹ä¸€ä¸ªé•¿æ–‡ä»¶çš„å†…å®¹ less file1  //ç±»ä¼¼äº &#39;more&#39; å‘½ä»¤ï¼Œä½†æ˜¯å®ƒå…è®¸åœ¨æ–‡ä»¶ä¸­å’Œæ­£å‘æ“ä½œä¸€æ ·çš„åå‘æ“ä½œ </code></pre><h3 id="headã€tail"><a href="#headã€tail" class="headerlink" title="headã€tail"></a>headã€tail</h3><pre><code>head -2 file1 //æŸ¥çœ‹ä¸€ä¸ªæ–‡ä»¶çš„å‰ä¸¤è¡Œ tail -2 file1 //æŸ¥çœ‹ä¸€ä¸ªæ–‡ä»¶çš„æœ€åä¸¤è¡Œ tail -f /var/log/messages //å®æ—¶æŸ¥çœ‹è¢«æ·»åŠ åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ </code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSSé¢„å¤„ç†å™¨</title>
      <link href="/2017/07/01/css/css-preprocessor/"/>
      <url>/2017/07/01/css/css-preprocessor/</url>
      
        <content type="html"><![CDATA[<p>CSS é¢„å¤„ç†å™¨èµ‹äºˆæˆ‘ä»¬å¾ˆå¤šcsså¼ºå¤§çš„åŠŸèƒ½ï¼Œèƒ½å¤Ÿå¾ˆæ¸…æ™°åœ°å®ç°ä»£ç çš„åˆ†å±‚ã€å¤ç”¨å’Œä¾èµ–ç®¡ç†ï¼Œæé«˜å¼€å‘æ•ˆç‡</p><h3 id="åŸºæœ¬è¯­æ³•"><a href="#åŸºæœ¬è¯­æ³•" class="headerlink" title="åŸºæœ¬è¯­æ³•"></a>åŸºæœ¬è¯­æ³•</h3><ol><li>Less çš„åŸºæœ¬è¯­æ³•è·ŸåŸç”Ÿçš„cssçš„é£æ ¼å‡ ä¹å·®ä¸å¤š</li><li>Sassã€Stylus åˆ©ç”¨ç¼©è¿›ã€ç©ºæ ¼å’Œæ¢è¡Œæ¥å‡å°‘éœ€è¦è¾“å…¥çš„å­—ç¬¦</li></ol><p>Sass</p><pre><code>.header  background-color:red</code></pre><p>Less &amp; SCSS</p><pre><code>.header {  background-color:red;}</code></pre><p>Stylus</p><pre><code>.header  background-color:red</code></pre><h3 id="åµŒå¥—è¯­æ³•"><a href="#åµŒå¥—è¯­æ³•" class="headerlink" title="åµŒå¥—è¯­æ³•"></a>åµŒå¥—è¯­æ³•</h3><p>åµŒå¥—è¯­æ³•éƒ½æ˜¯ä¸€è‡´çš„,åŒºåˆ«æ˜¯ Sass å’Œ Stylus å¯ä»¥ä¸ç”¨ä¹¦å†™å¤§æ‹¬å·</p><p>less</p><pre><code>.header {  &amp;.title {    color: red;  }}</code></pre><h3 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h3><p>ä¸º CSS å¢åŠ äº†ä¸€ç§æœ‰æ•ˆçš„å¤ç”¨æ–¹å¼ï¼Œå‡å°‘CSSä¹¦å†™é‡å¤</p><p>Sass</p><pre><code>$bg: #ccc;.header   background-color:$bg;</code></pre><p>Less</p><pre><code>@bg: #ccc;header {  background-color: @bg;}</code></pre><p>Stylus</p><pre><code>bg = #cccheader  background-color: bg</code></pre><h3 id="import"><a href="#import" class="headerlink" title="@import"></a>@import</h3><p>Sass åªèƒ½ä½¿ç”¨ url() è¡¨è¾¾å¼å¼•å…¥æ—¶è¿›è¡Œå˜é‡æ’å€¼</p><pre><code>  $public: public;  @import url(styles.#{$public}.css);</code></pre><p>Lesså¯ä»¥åœ¨å­—ç¬¦ä¸²ä¸­è¿›è¡Œæ’å€¼ï¼š</p><pre><code>  @public: public;  @import &quot;styles.@{public}.css&quot;;</code></pre><p>Stylus å¯ä»¥åˆ©ç”¨å…¶å­—ç¬¦ä¸²æ‹¼æ¥çš„åŠŸèƒ½å®ç°</p><pre><code>  public = &quot;public&quot;  @import &quot;styles.&quot; + public + &quot;.css&quot;</code></pre><h3 id="æ··å…¥-Mixins"><a href="#æ··å…¥-Mixins" class="headerlink" title="æ··å…¥(Mixins)"></a>æ··å…¥(Mixins)</h3><p>ä½œç”¨: æ ·å¼å±‚é¢çš„æŠ½è±¡</p><p>Sass</p><pre><code>  @mixin product-public-text {    font: {      size: 20px;      weight: 600;      family: PingFangSC;    }    color: rgba(72,72,72,1);  }  .product-header-title {    @include product-public-text;    padding: 10px;  }</code></pre><p>Less</p><pre><code>  .product-public-font-weight {    font-weight: 600;  }  .product-public-font(@color: red) {    font-size: 20px;    color: @color;  }  .product-header-title{    .product-public-font-weight;    .product-public-font(red);  }</code></pre><h3 id="ç»§æ‰¿"><a href="#ç»§æ‰¿" class="headerlink" title="ç»§æ‰¿"></a>ç»§æ‰¿</h3><p>Sass</p><pre><code>  .header {    background-color: red;  }  .main.active {    @extend .header;  }</code></pre><p>less</p><pre><code>  .header {    background-color: red;  }  .main {    &amp;:extend(.header);  }</code></pre><p>Stylus,Scss</p><pre><code>  .header    background-color: red;  .main    @extend .header</code></pre><h3 id="é«˜çº§ç”¨æ³•ï¼ˆå‡½æ•°ï¼‰"><a href="#é«˜çº§ç”¨æ³•ï¼ˆå‡½æ•°ï¼‰" class="headerlink" title="é«˜çº§ç”¨æ³•ï¼ˆå‡½æ•°ï¼‰"></a>é«˜çº§ç”¨æ³•ï¼ˆå‡½æ•°ï¼‰</h3><p>ä¸‰ç§é¢„å¤„ç†å™¨éƒ½è‡ªå¸¦äº†è¯¸å¦‚è‰²å½©å¤„ç†ï¼ˆdarkenç­‰ï¼‰ã€ç±»å‹åˆ¤æ–­ï¼ˆif each for while ç­‰ï¼‰ã€æ•°å€¼è®¡ç®—ç­‰å†…ç½®å‡½æ•°</p><h3 id="ä¸‰ç§é¢„å¤„ç†å™¨æ‰‹å†Œ"><a href="#ä¸‰ç§é¢„å¤„ç†å™¨æ‰‹å†Œ" class="headerlink" title="ä¸‰ç§é¢„å¤„ç†å™¨æ‰‹å†Œ"></a>ä¸‰ç§é¢„å¤„ç†å™¨æ‰‹å†Œ</h3><ol><li>Sassï¼š<a href="http://sass.bootcss.com/" target="_blank" rel="noopener">http://sass.bootcss.com/</a></li><li>Lessï¼š <a href="https://less.bootcss.com/" target="_blank" rel="noopener">https://less.bootcss.com/</a></li><li>stylusï¼š<a href="https://stylus.bootcss.com/" target="_blank" rel="noopener">https://stylus.bootcss.com/</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cssåˆ†å±‚ç†è®º</title>
      <link href="/2017/06/22/css/css-layered/"/>
      <url>/2017/06/22/css/css-layered/</url>
      
        <content type="html"><![CDATA[<p>cssåˆ†å±‚ç†è®ºå’Œå‘½ä»¤è§„åˆ™å°†æœ‰åŠ©äºå®ƒçš„å¯æ‰©å±•æ€§ï¼Œæ€§èƒ½çš„æé«˜å’Œä»£ç çš„ç»„ç»‡ç®¡ç†ã€‚</p><h3 id="OOSS"><a href="#OOSS" class="headerlink" title="OOSS"></a>OOSS</h3><ol><li>å®šä¹‰ï¼šé¢å‘å¯¹è±¡css</li><li>è®¾è®¡åŸåˆ™ï¼šè¡¨ç°ä¸ç»“æ„åˆ†ç¦»ï¼Œå®¹å™¨ä¸å†…å®¹åˆ†ç¦»</li><li>ç”¨é€”ï¼šåˆ›å»ºå¯å¤ç”¨çš„CSSæ¨¡å—ä»¥æé«˜æ€§èƒ½</li><li>æé«˜å›¢é˜Ÿå¼€å‘æ•ˆç‡ï¼Œå‡å°‘è€¦åˆ</li></ol><h3 id="SMACSS"><a href="#SMACSS" class="headerlink" title="SMACSS"></a>SMACSS</h3><ol><li><p>å®šä¹‰ï¼šå¯æ‰©å±•çš„æ¨¡å—åŒ–æ¶æ„çš„CSS</p></li><li><p>è®¾è®¡åŸåˆ™ï¼š ä½¿ç”¨ä¸€å¥—äº”ä¸ªå±‚æ¬¡æ¥åˆ’åˆ†CSS</p></li><li><p>ç”¨é€”ï¼šåˆ›å»ºæ›´ç»“æ„åŒ–çš„æ¨¡å—ä»¥æé«˜æ€§èƒ½ï¼Œå¢åŠ æ•ˆç‡</p><pre><code>Base - è®¾å®šHTML elements çš„é»˜è®¤å€¼Layout -Page structure æ•´ä¸ªç½‘ç«™çš„ã€Œå¤§æ¶æ„ã€çš„å¤–è§‚   Module - Re-usable code bloks ä¸åŒé¡µé¢å…¬å…±æ¨¡å— State - Active/Inactive etc å®šä¹‰å…ƒç´ ä¸åŒçš„çŠ¶æ€ Theme - Typography and colour schemes é¡µé¢ä¸Šæ‰€æœ‰ã€Œä¸»è§†è§‰ã€çš„å®šä¹‰ </code></pre><pre><code>.header {}.header-top {}.header-top__title {}.header-top__title--ico {}&lt;div class=&quot;header&quot;&gt; &lt;div class=&quot;header-top&quot;&gt;   &lt;div class=&quot;header-top__title&quot;&gt;     &lt;div class=&quot;header-top__title--ico&quot;&gt;&lt;/div&gt;   &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;</code></pre></li></ol><h3 id="BEM"><a href="#BEM" class="headerlink" title="BEM"></a>BEM</h3><ol><li><p>å®šä¹‰ï¼šblockï¼šå—ï¼ŒElementï¼šå…ƒç´ ï¼ŒModifierï¼šä¿®é¥°ç¬¦ </p></li><li><p>è®¾è®¡åŸåˆ™ï¼šé€šè¿‡ç»™æ¯ä¸ªå…ƒç´ æ·»åŠ å®ƒçš„çˆ¶çº§blockæ¨¡å—ä½œä¸ºå‰ç¼€</p></li><li><p>ç”¨é€”ï¼šæœ‰åŠ©äºæ¶ˆé™¤é¡µé¢å’Œbodyç±»å¯¹åµŒå¥—æˆ–è€…é™„åŠ æ ·å¼ä¾èµ–</p><pre><code>.product-details {}.product-details__header {}.product-details__header--ico {}&lt;div class=&quot;product-details&quot;&gt; &lt;div class=&quot;product-details__header&quot;&gt;   &lt;div class=&quot;product-details__header--ico&quot;&gt;&lt;div&gt;  &lt;/div&gt;&lt;/div&gt;</code></pre></li></ol><h3 id="SUIT"><a href="#SUIT" class="headerlink" title="SUIT"></a>SUIT</h3><ol><li>å®šä¹‰ï¼šSUITèµ·æºäºBEMï¼Œå¯¹ç»„ä»¶åä½¿ç”¨é©¼å³°å¼å’Œè¿å­—å·æŠŠç»„ä»¶ä»ä»–ä»¬çš„ä¿®é¥°å’Œå­å­™åä»£ä¸­åŒºåˆ†å‡ºæ¥</li><li>ç”¨é€”ï¼šé€šè¿‡æŠ½ç¦»ç»„ä»¶çº§åˆ«çš„çš„æ ·å¼è¡¨ï¼Œæ¶ˆé™¤æ½œåœ¨çš„æ··ä¹±è¿å­—ç¬¦å·è¿æ¥å…ƒç´ åæ¥ä½¿å¾—é€‰æ‹©å™¨çš„å¯è¯»æ€§æ›´å¼ºã€‚</li><li>ä»£ç ç¤ºä¾‹åŒBEM åªä¸è¿‡æ˜¯æŠ½ç¦»çš„ç»„ä»¶</li></ol><h3 id="ACSS"><a href="#ACSS" class="headerlink" title="ACSS"></a>ACSS</h3><p>å®šä¹‰ï¼š è€ƒè™‘å¦‚ä½•è®¾è®¡ä¸€ä¸ªç³»ç»Ÿçš„æ¥å£ã€‚åŸå­(Atoms)æ˜¯åˆ›å»ºä¸€ä¸ªåŒºå—çš„æœ€åŸºæœ¬çš„ç‰¹è´¨ï¼Œæ¯”å¦‚è¯´è¡¨å•æŒ‰é’®ã€‚åˆ†å­(Molecules)æ˜¯å¾ˆå¤šä¸ªåŸå­(Atoms)çš„ç»„åˆï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªè¡¨å•ä¸­åŒ…æ‹¬äº†ä¸€ä¸ªæ ‡ç­¾ï¼Œè¾“å…¥æ¡†å’ŒæŒ‰é’®ã€‚ç”Ÿç‰©(Organisms)æ˜¯ä¼—å¤šåˆ†å­(Molecules)çš„ç»„åˆç‰©ï¼Œæ¯”å¦‚ä¸€ä¸ªç½‘ç«™çš„é¡¶éƒ¨åŒºåŸŸï¼Œå®ƒåŒ…æ‹¬äº†ç½‘ç«™çš„æ ‡é¢˜ã€å¯¼èˆªç­‰ã€‚è€Œæ¨¡æ¿(Templates)åˆæ˜¯ä¼—å¤šç”Ÿç‰©(Organisms)çš„ç»“åˆä½“ã€‚æ¯”å¦‚ä¸€ä¸ªç½‘ç«™é¡µé¢çš„å¸ƒå±€ã€‚è€Œæœ€åçš„é¡µé¢å°±æ˜¯ç‰¹æ®Šçš„æ¨¡æ¿ã€‚</p><p><img src="/images/Acss.jpg" alt></p><h3 id="ITCSS"><a href="#ITCSS" class="headerlink" title="ITCSS"></a>ITCSS</h3><p>å®šä¹‰ï¼šåˆ›é€ äº†ä¸€ç³»åˆ—çš„å±‚æ¬¡æ¥ç®¡ç†ä¾èµ–å…³ç³»å’Œä¿ƒè¿›å¯æ‰©å±•æ€§ã€‚åŸºç¡€çš„å±‚æ¬¡åŒ…æ‹¬é€šç”¨å’Œå¹¿æ³›çš„é€‰æ‹©å™¨ã€‚é¡¶éƒ¨çš„å±‚æ¬¡åŒ…å«äº†å±€éƒ¨æ¨¡å—å…·ä½“åŒ–çš„é€‰æ‹©å™¨ã€‚</p><pre><code>.Settingsâ€Šâ€”â€Šå…¨å±€å¯ç”¨é…ç½®ï¼Œè®¾ç½®å¼€å…³ã€‚$color-ui: #BADA55; $spacing-unit:10px.Toolsâ€Šâ€”é€šç”¨å·¥å…·å‡½æ•°ã€‚@mixin font-color() {font-color: $color-ui;}.Genericâ€Šâ€”â€Šé€šç”¨åŸºç¡€æ ·å¼ã€‚Normalize, resets, box-sizing: border-box;.Baseâ€Šâ€”â€Šæœªå½’ç±»çš„HTMLå…ƒç´ ã€‚ul {list-style: square outside;}.Objectsâ€Šâ€”è®¾è®¡éƒ¨åˆ†å¼€å§‹ä½¿ç”¨ä¸“ç”¨ç±»ã€‚.ui-list__item {padding: $spacing-unit;}.Componentsâ€Šâ€”â€Šè®¾è®¡ç¬¦åˆä½ ä»¬çš„ç»„ä»¶ã€‚products-list {@include font-brand();border-top: 1px solid $color-ui;}.Trumpsâ€Šâ€”é‡å†™ï¼Œåªå½±å“ä¸€å—çš„DOMã€‚(é€šå¸¸å¸¦ä¸Šæˆ‘ä»¬çš„!important)</code></pre>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSS åŠ¨ç”»</title>
      <link href="/2017/06/20/css/css-animation/"/>
      <url>/2017/06/20/css/css-animation/</url>
      
        <content type="html"><![CDATA[<p>APIçš„ç®€ä»‹åŠç®€å•åŠ¨ç”»çš„å®ç°</p><h3 id="3Dè½¬æ¢ï¼ˆtransformï¼‰"><a href="#3Dè½¬æ¢ï¼ˆtransformï¼‰" class="headerlink" title="3Dè½¬æ¢ï¼ˆtransformï¼‰"></a>3Dè½¬æ¢ï¼ˆtransformï¼‰</h3><ol><li><p>å®šä¹‰å‘å…ƒç´ åº”ç”¨ 2D æˆ– 3D è½¬æ¢ï¼Œå¯ä»¥å¯¹å…ƒç´ è¿›è¡Œç§»åŠ¨ã€ç¼©æ”¾ã€è½¬åŠ¨ã€æ‹‰é•¿æˆ–æ‹‰ä¼¸</p><p>translate(ç§»åŠ¨) æ ¹æ®Xè½´å’ŒYè½´ä½ç½®ç»™å®šçš„å‚æ•°ï¼Œä»å½“å‰å…ƒç´ ä½ç½®ç§»åŠ¨</p><pre><code>transform: translate(100px,200px);</code></pre><p>rotateï¼ˆæ—‹è½¬ï¼‰ ç»™å®šåº¦æ•°é¡ºæ—¶é’ˆæ—‹è½¬çš„å…ƒç´ ã€‚è´Ÿå€¼åˆ™ä¸ºé€†æ—¶é’ˆæ—‹è½¬</p><pre><code>transform: rotate(60deg);</code></pre><p>scale (ç¼©æ”¾) å¯¹å…ƒç´ å‡å°æˆ–è€…æ”¾å¤§ï¼Œå–å†³äºå®½åº¦ï¼ˆXè½´ï¼‰å’Œé«˜åº¦ï¼ˆYè½´ï¼‰çš„å‚æ•°</p><pre><code>transform: scale(2,2);</code></pre><p>skew (å€¾æ–œ) æ ¹æ®Xè½´å’ŒYè½´ä½ç½®ç»™å®šçš„è§’åº¦å‚æ•°ï¼Œè¿›è¡Œå€¾æ–œï¼Œè´Ÿæ•°åˆ™ä¸ºåæ–¹å‘å€¾æ–œ</p><pre><code>transform: skew(40deg,50deg);</code></pre></li><li><p>transform-originï¼šå…è®¸æ”¹å˜è¢«è½¬æ¢å…ƒç´ çš„ä½ç½®</p><pre><code>transform-origin: x-axis y-axis z-axis;</code></pre></li><li><p>transform-styleï¼šè§„å®šè¢«åµŒå¥—å…ƒç´ å¦‚ä½•åœ¨ 3D ç©ºé—´ä¸­æ˜¾ç¤º</p><pre><code>// preserve-3dæ‰€æœ‰å­å…ƒç´ åœ¨3Dç©ºé—´ä¸­å‘ˆç°// flatæ‰€æœ‰å­å…ƒç´ åœ¨2Då¹³é¢å‘ˆç°transform-style: flat|preserve-3d;</code></pre></li><li><p>perspective:è®¾ç½®å…ƒç´ è·ç¦»è§†å›¾çš„è·ç¦»ï¼Œä»¥åƒç´ è®¡ï¼Œä¸ perspective-origin å±æ€§ä¸€åŒä½¿ç”¨ï¼Œèƒ½å¤Ÿæ”¹å˜ 3D å…ƒç´ çš„åº•éƒ¨ä½ç½®</p><pre><code>perspective: number|none;</code></pre></li><li><p>backface-visibility:å®šä¹‰å½“å…ƒç´ ä¸é¢å‘å±å¹•æ—¶æ˜¯å¦å¯è§ï¼Œåœ¨æ—‹è½¬å…ƒç´ ä¸å¸Œæœ›çœ‹åˆ°å…¶èƒŒé¢æ—¶ï¼Œè¯¥å±æ€§å¾ˆæœ‰ç”¨</p><pre><code>backface-visibility: visible|hidden;</code></pre></li></ol><h3 id="CSS3è¿‡æ¸¡ï¼ˆtransitionï¼‰"><a href="#CSS3è¿‡æ¸¡ï¼ˆtransitionï¼‰" class="headerlink" title="CSS3è¿‡æ¸¡ï¼ˆtransitionï¼‰"></a>CSS3è¿‡æ¸¡ï¼ˆtransitionï¼‰</h3><ol><li>æŸç§æ•ˆæœå¯ä»¥ä»ä¸€ç§æ ·å¼è½¬å˜åˆ°å¦ä¸€ç§æ ·å¼çš„æ•ˆæœ<pre><code>transition: property duration timing-function delay;</code></pre><pre><code>transition-timing-function: linear|ease|ease-in|ease-out|ease-in-out|cubic-bezier(n,n,n,n);</code></pre></li></ol><h3 id="CSS3-åŠ¨ç”»ï¼ˆanimationåŠ-keyframesï¼‰"><a href="#CSS3-åŠ¨ç”»ï¼ˆanimationåŠ-keyframesï¼‰" class="headerlink" title="CSS3 åŠ¨ç”»ï¼ˆanimationåŠ@keyframesï¼‰"></a>CSS3 åŠ¨ç”»ï¼ˆanimationåŠ@keyframesï¼‰</h3><ol><li><p>ä½¿å…ƒç´ ä»ä¸€ç§æ ·å¼é€æ¸å˜åŒ–ä¸ºå¦ä¸€ç§æ ·å¼çš„æ•ˆæœ</p><ul><li><p>animation</p></li><li><p>@keyframes</p></li><li><p>è¯­æ³•è§„åˆ™åŠæ‹†è§£</p><pre><code>animation: animation-name animation-duration animation-timing-function animation-fill-mode animation-delay animation-iteration-count    animation-direction animation-play-state;animation-name(keyframeåå­—): keyframename|none;animation-duration(åŠ¨ç”»å®Œæˆä¸€ä¸ªå‘¨æœŸéœ€è¦å¤šå°‘ç§’æˆ–æ¯«ç§’):animation-duration: time | 0;animation-timing-function(åŠ¨ç”»çš„é€Ÿåº¦æ›²çº¿,ä½¿ç”¨çš„æ•°å­¦å‡½æ•°ï¼Œç§°ä¸ºä¸‰æ¬¡è´å¡å°”æ›²çº¿ï¼Œé€Ÿåº¦æ›²çº¿): linear    | ease    | ease-in | ease-out    | ease-in-out     | cubic-bezier(n,n,n,n);animation-fill-mode(å½“åŠ¨ç”»å®Œæˆæ—¶æˆ–åˆä¸€ä¸ªå»¶è¿Ÿæœªå¼€å§‹æ’­æ”¾æ—¶çš„æ ·å¼): none|forwards|backwards|both|initial|inherit;animation-delay(åŠ¨ç”»ä»€ä¹ˆæ—¶å€™å¼€å§‹): time;animation-iteration-count(åŠ¨ç”»è¢«æ’­æ”¾çš„æ¬¡æ•°):n |infiniteanimation-direction(æ˜¯å¦å¾ªç¯äº¤æ›¿åå‘æ’­æ”¾åŠ¨ç”»): normal|reverse|alternate|alternate-reverse|initial|inherit;animation-play-state(åŠ¨ç”»æ˜¯å¦æ­£åœ¨è¿è¡Œæˆ–æš‚åœ):paused|running;</code></pre></li></ul></li></ol><h3 id="cssåŠ¨ç”»åº“ä»¥åŠåŠ¨ç”»å·¥å…·"><a href="#cssåŠ¨ç”»åº“ä»¥åŠåŠ¨ç”»å·¥å…·" class="headerlink" title="cssåŠ¨ç”»åº“ä»¥åŠåŠ¨ç”»å·¥å…·"></a>cssåŠ¨ç”»åº“ä»¥åŠåŠ¨ç”»å·¥å…·</h3><ul><li>matrix3d(<a href="http://ds-overdesign.com/transform/matrix3d.html" target="_blank" rel="noopener">http://ds-overdesign.com/transform/matrix3d.html</a>)</li><li>matrix(<a href="http://meyerweb.com/eric/tools/matrix" target="_blank" rel="noopener">http://meyerweb.com/eric/tools/matrix</a>)</li><li>tools(<a href="http://www.f2e.name/case/css3/tools.html" target="_blank" rel="noopener">http://www.f2e.name/case/css3/tools.html</a>)</li></ul>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSS åŸºæœ¬å¸ƒå±€</title>
      <link href="/2017/06/15/css/base-layout/"/>
      <url>/2017/06/15/css/base-layout/</url>
      
        <content type="html"><![CDATA[<h3 id="è‡ªé€‚åº”ä¸¤æ å¸ƒå±€"><a href="#è‡ªé€‚åº”ä¸¤æ å¸ƒå±€" class="headerlink" title="è‡ªé€‚åº”ä¸¤æ å¸ƒå±€"></a>è‡ªé€‚åº”ä¸¤æ å¸ƒå±€</h3><p>åˆ©ç”¨BFCå®ç°è‡ªé€‚åº”ä¸¤æ å¸ƒå±€</p><pre><code>/****css****/.aside{  float: left;  width: 180px;  height: 500px;  background-color: red;  opacity: 0.5;}.main{  overflow: hidden;  height: 500px;  background-color: green;}&lt;!--html--&gt;&lt;div class=&quot;box&quot;&gt;  &lt;div class=&quot;aside&quot;&gt;å·¦ä¾§&lt;/div&gt;  &lt;div class=&quot;main&quot;&gt;å³ä¾§&lt;/div&gt;&lt;/div&gt;</code></pre><p><img src="/images/%E8%87%AA%E9%80%82%E5%BA%94%E4%B8%A4%E6%A0%8F%E5%B8%83%E5%B1%80.gif" alt></p><h3 id="åœ£æ¯å¸ƒå±€å’ŒåŒé£ç¿¼å¸ƒå±€"><a href="#åœ£æ¯å¸ƒå±€å’ŒåŒé£ç¿¼å¸ƒå±€" class="headerlink" title="åœ£æ¯å¸ƒå±€å’ŒåŒé£ç¿¼å¸ƒå±€"></a>åœ£æ¯å¸ƒå±€å’ŒåŒé£ç¿¼å¸ƒå±€</h3><ol><li>è§£å†³ä»€ä¹ˆé—®é¢˜ï¼šä¸¤è¾¹å®šå®½ï¼Œä¸­é—´è‡ªé€‚åº”çš„ä¸‰æ å¸ƒå±€ï¼Œä¸­é—´æ æ”¾åœ¨æ–‡æ¡£æµå‰é¢ä»¥ä¼˜å…ˆæ¸²æŸ“</li><li>ç›¸åŒç‚¹ï¼šä¸‰æ å…¨floatæµ®åŠ¨ï¼Œå·¦å³ä¸¤æ åŠ ä¸Šè´Ÿmarginè®©ä¸­é—´æ divå¹¶æ’ï¼Œå½¢æˆä¸‰æ </li><li>ä¸åŒç‚¹ï¼š <ul><li>åœ£æ¯å¸ƒå±€ä¸ºäº†ä¸­é—´å†…å®¹ä¸è¢«é®æŒ¡ï¼Œå°†ä¸­é—´divè®¾ç½®å·¦å³padding-leftå’Œpadding-right,å°†å·¦å³ä¸¤ä¸ªdivç”¨ç›¸å¯¹å¸ƒå±€position: relativeå¹¶åˆ†åˆ«é…åˆrightå’Œleftå±æ€§ï¼Œä»¥ä¾¿å·¦å³ä¸¤æ divç§»åŠ¨åä¸é®æŒ¡ä¸­é—´divã€‚</li><li>åŒé£ç¿¼å¸ƒå±€ï¼Œç›´æ¥åœ¨ä¸­é—´divå†…éƒ¨åˆ›å»ºå­divç”¨äºæ”¾ç½®å†…å®¹ï¼Œåœ¨è¯¥å­divé‡Œç”¨margin-leftå’Œmargin-rightä¸ºå·¦å³ä¸¤æ divç•™å‡ºä½ç½®ã€‚</li></ul></li><li>åœ£æ¯å¸ƒå±€ä»£ç </li></ol><pre><code>/****css****/.main{  width: 100%;  background: green;}.left{  left: -200px;  width: 200px;  margin-left: -100%;  background: yellowgreen;}.right{  right: -200px;  width: 200px;  margin-left: -200px;  background-color: red;}.main,.left,.right{  position: relative;  float: left;  min-height: 500px;}.container{  padding: 0 200px;  overflow: hidden;  border: 5px solid #ccc;}&lt;!--html--&gt;&lt;div class=&quot;container&quot;&gt;  &lt;div class=&quot;main&quot;&gt;ä¸­é—´æ ç›®&lt;/div&gt;  &lt;div class=&quot;left&quot;&gt;å·¦ä¾§æ ç›®&lt;/div&gt;  &lt;div class=&quot;right&quot;&gt;å³ä¾§æ ç›®&lt;/div&gt;&lt;/div&gt;</code></pre><ol start="5"><li>åŒé£ç¿¼å¸ƒå±€ä»£ç </li></ol><pre><code>/****css****/.main,.left,.right{  float: left;  min-height: 500px;}.main{  width:100%;  background-color: red;}.left{  width: 200px;  margin-left: -100%;  background-color: yellow;}.right{  width: 200px;  background-color: green;  margin-left: -200px;}.content{  margin: 0 200px;}&lt;!--html--&gt;&lt;div class=&quot;container&quot;&gt; ã€€ã€€&lt;div class=&quot;main&quot;&gt;    ã€€ã€€&lt;div class=&quot;content&quot;&gt;ä¸­é—´æ ç›®&lt;/div&gt;     &lt;/div&gt;ã€€ã€€&lt;div class=&quot;left&quot;&gt;å·¦ä¾§æ ç›®&lt;/div&gt; ã€€ã€€&lt;div class=&quot;right&quot;&gt;å³ä¾§æ ç›®&lt;/div&gt; &lt;/div&gt;</code></pre><ol start="6"><li>æ•ˆæœå›¾<br><img src="/images/%E5%9C%A3%E6%9D%AF%E5%B8%83%E5%B1%80.gif" alt></li></ol><h3 id="flexå¼¹æ€§ç›’å­å¸ƒå±€"><a href="#flexå¼¹æ€§ç›’å­å¸ƒå±€" class="headerlink" title="flexå¼¹æ€§ç›’å­å¸ƒå±€"></a>flexå¼¹æ€§ç›’å­å¸ƒå±€</h3><ol><li><p>å®šä¹‰ï¼šFlex æ˜¯ Flexible Box çš„ç¼©å†™ï¼Œæ„ä¸ºâ€å¼¹æ€§å¸ƒå±€â€ï¼Œç”¨æ¥ä¸ºç›’çŠ¶æ¨¡å‹æä¾›æœ€å¤§çš„çµæ´»æ€§ã€‚</p></li><li><p>ä¼˜ç‚¹ï¼šç›¸å¯¹äºä¼ ç»Ÿå¸ƒå±€æ›´å…·æœ‰çµæ´»æ€§ã€‚</p></li><li><p>ç¼ºç‚¹ï¼šè™½ç„¶ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒï¼Œä½†æ˜¯è¿˜æœ‰å°‘éƒ¨åˆ†æµè§ˆå™¨éœ€è¦å•ç‹¬å¤„ç†å…¶å…¼å®¹æ€§</p></li><li><p>é—®é¢˜ï¼š</p><ul><li>ç»å¯¹å®šä½ä¸å›ºå®šå®šä½çš„ç›’å­ä¸å‚ä¸flexå¸ƒå±€</li><li>ä½¿ç”¨Flexå¸ƒå±€ä»¥åï¼Œå­å…ƒç´ çš„floatã€clearå’Œvertical-alignç­‰å±æ€§å°†å¤±æ•ˆ</li><li>å…·ä½“è¯­æ³•å‚è€ƒé˜®å¤§å¤§flexå¸ƒå±€è¯­æ³•ç¯‡å’Œå®ä¾‹ç¯‡</li><li><a href="http://www.ruanyifeng.com/blog/2015/07/flex-grammar.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2015/07/flex-grammar.html</a></li><li><a href="http://www.ruanyifeng.com/blog/2015/07/flex-examples.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2015/07/flex-examples.html</a></li></ul></li><li><p>ä¸‰æ å¸ƒå±€ç¤ºä¾‹ </p></li></ol><pre><code>/****css****/.container{  display: flex;  min-height: 500px;}.main{  flex-grow:1;  background-color: red;}.left{  order: -1;  flex-basis: 200px;  background-color: yellow;}.right{  flex-basis: 200px;  background-color: green;}&lt;!--html--&gt;&lt;div class=&quot;container&quot;&gt;  &lt;div class=&quot;main&quot;&gt;ä¸­é—´å†…å®¹åŒºåŸŸ&lt;/div&gt;  &lt;div class=&quot;left&quot;&gt;å·¦è¾¹æ åŒºåŸŸ&lt;/div&gt;  &lt;div class=&quot;right&quot;&gt;å³è¾¹æ åŒºåŸŸ&lt;/div&gt;&lt;/div&gt;</code></pre><h3 id="ç»å¯¹å®šä½å¸ƒå±€"><a href="#ç»å¯¹å®šä½å¸ƒå±€" class="headerlink" title="ç»å¯¹å®šä½å¸ƒå±€"></a>ç»å¯¹å®šä½å¸ƒå±€</h3><ol><li>position:absoluteç»å¯¹å®šä½ä½¿å…ƒç´ è„±ç¦»æ–‡æ¡£æµï¼Œå› æ­¤ä¸å æ®å½“å‰å±‚çº§çš„ç©ºé—´</li><li>ä¸‰æ å¸ƒå±€ä»£ç ç¤ºä¾‹<pre><code>/****css****/.container{position: relative;}.main,.left,.right{min-height: 500px;top: 0;}.main{background-color: red;margin: 0 200px;}.left{position: absolute;left: 0px;width: 200px;background-color: green;}.right{position:absolute;right: 0px;width: 200px;background: yellow;}</code></pre></li></ol><!--html--><div class="container">  <div class="main">ä¸­é—´å†…å®¹åŒºåŸŸ</div>  <div class="left">å·¦è¾¹åŒºåŸŸ</div>  <div class="right">å³è¾¹åŒºåŸŸ</div></div>```### mediaå“åº”å¼å¸ƒå±€<ol><li>å®šä¹‰ï¼ˆResponsive Web Designï¼‰ï¼šä¸€ä¸ªç½‘ç«™èƒ½å¤Ÿå…¼å®¹å¤šä¸ªç»ˆç«¯ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªç»ˆç«¯åšä¸€ä¸ªç‰¹å®šçš„ç‰ˆæœ¬</li><li>ä¼˜ç‚¹<ul><li>è·¨å¹³å°ï¼Œé¢å¯¹ä¸åŒåˆ†è¾¨ç‡è®¾å¤‡çµæ´»æ€§å¼º</li><li>èƒ½å¤Ÿå¿«æ·è§£å†³å¤šè®¾å¤‡æ˜¾ç¤ºé€‚åº”é—®é¢˜</li><li>èŠ‚çº¦æˆæœ¬</li></ul></li><li>ç¼ºç‚¹<ul><li>å…¼å®¹æ€§ ä¸å…¼å®¹ä½ç‰ˆæœ¬æµè§ˆå™¨ï¼Œå„ç§è®¾å¤‡å·¥ä½œé‡å¤§ï¼Œæ•ˆç‡ä½ä¸‹</li><li>ä»£ç å†—ä½™é‡å¤§ï¼ŒåŠ è½½æ—¶é—´é•¿</li><li>æŠ˜ä¸­æ–¹æ¡ˆï¼Œè¾¾ä¸åˆ°ç†æƒ³çš„å¸ƒå±€æ•ˆæœ </li></ul></li></ol><h3 id="ç§»åŠ¨ç«¯remå¸ƒå±€"><a href="#ç§»åŠ¨ç«¯remå¸ƒå±€" class="headerlink" title="ç§»åŠ¨ç«¯remå¸ƒå±€"></a>ç§»åŠ¨ç«¯remå¸ƒå±€</h3><ol><li>å®šä¹‰ï¼ˆfont size of the root elementï¼‰ï¼šç›¸å¯¹äºæ ¹å…ƒç´ çš„å­—ä½“å¤§å°çš„å•ä½</li><li>ä½œç”¨ï¼šé€šè¿‡jsåŠ¨æ€è®¡ç®—html font-size èƒ½å¤Ÿä½¿htmlé¡µé¢æ¯”å“åº”å¼å¸ƒå±€ï¼Œæµå¼å¸ƒå±€ï¼Œè®¾ç½®æœ€å¤§å®½åº¦å¸ƒå±€ç­‰æ•ˆæœæ›´å®Œå–„</li><li>éœ€è¦è€ƒè™‘å½“å‰æ‰‹æœºçš„dpr</li></ol>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSS åŸºç¡€çŸ¥è¯†æ¦‚å¿µ</title>
      <link href="/2017/06/11/css/base-concepts/"/>
      <url>/2017/06/11/css/base-concepts/</url>
      
        <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯css"><a href="#ä»€ä¹ˆæ˜¯css" class="headerlink" title="ä»€ä¹ˆæ˜¯css"></a>ä»€ä¹ˆæ˜¯css</h3><p>å±‚å æ ·å¼è¡¨(è‹±æ–‡å…¨ç§°ï¼šCascading Style Sheets),æ˜¯ä¸€ç§ç”¨æ¥è¡¨ç°htmlæˆ–è€…xmlç­‰æ–‡ä»¶æ ·å¼çš„è®¡ç®—æœºè¯­è¨€ã€‚</p><h3 id="ç›’å­æ¨¡å‹"><a href="#ç›’å­æ¨¡å‹" class="headerlink" title="ç›’å­æ¨¡å‹"></a>ç›’å­æ¨¡å‹</h3><ul><li>åœ¨htmlæ–‡æ¡£ä¸­ï¼Œæ¯ä¸€ä¸ªæ¸²æŸ“åœ¨é¡µé¢ä¸­çš„æ ‡ç­¾éƒ½æ˜¯ä¸€ä¸ªä¸ªç›’å­æ¨¡å‹ï¼›</li><li>ç›’å­æ¨¡å‹åˆ†ä¸ºw3cæ ‡å‡†ç›’å­æ¨¡å‹å’ŒIEæ ‡å‡†ç›’å­æ¨¡å‹ï¼›å½“ä¸å¯¹Doctypeè¿›è¡Œå®šä¹‰æ—¶ï¼Œä¼šè§¦å‘æ€ªå¼‚æ¨¡å¼ã€‚</li><li>ç›’å­æ¨¡å‹</li></ul><pre><code>/****css****/.box{  width:100px;  height:100px;  border:10px;  background-color:red;  padding:20px;  margin:20px;}&lt;div class=&quot;box&quot;&gt;&lt;/div&gt;</code></pre><p><img src="/images/css%E7%9B%92%E5%AD%90%E6%A8%A1%E5%9E%8B.png" alt></p><h3 id="BFC"><a href="#BFC" class="headerlink" title="BFC"></a>BFC</h3><ul><li><p>å®šä¹‰ï¼ˆBlock fomatting contextï¼‰ï¼šå—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡(æ¯ä¸€ä¸ªå…ƒç´ ç›’å­ä»ä¸Šå‘ä¸‹æ’åˆ—)</p></li><li><p>block-level box:display å±æ€§ä¸º block, list-item, table çš„å…ƒç´ ï¼Œä¼šç”Ÿæˆ block-level boxã€‚å¹¶ä¸”å‚ä¸ block fomatting contextï¼›</p></li><li><p>æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¸²æŸ“åŒºåŸŸï¼Œåªæœ‰Block-level boxå‚ä¸</p></li><li><p>å¸ƒå±€è§„åˆ™</p><ol><li>å†…éƒ¨çš„Boxä¼šåœ¨å‚ç›´æ–¹å‘é“¾æ¥æ”¾ç½®</li><li>Boxå‚ç›´æ–¹å‘çš„è·ç¦»ç”±marginå†³å®šã€‚å±äºåŒä¸€ä¸ªBFCçš„ä¸¤ä¸ªç›¸é‚»Boxçš„marginä¼šå‘ç”Ÿé‡å </li><li>æ¯ä¸ªå…ƒç´ çš„margin boxçš„å·¦è¾¹ï¼Œ ä¸åŒ…å«å—border boxçš„å·¦è¾¹ç›¸æ¥è§¦(å¯¹äºä»å·¦å¾€å³çš„æ ¼å¼åŒ–ï¼Œå¦åˆ™ç›¸å)ã€‚å³ä½¿å­˜åœ¨æµ®åŠ¨ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</li><li>BFCçš„åŒºåŸŸä¸ä¼šä¸float boxé‡å </li><li>BFCå°±æ˜¯é¡µé¢ä¸Šçš„ä¸€ä¸ªéš”ç¦»çš„ç‹¬ç«‹å®¹å™¨ï¼Œå®¹å™¨é‡Œé¢çš„å­å…ƒç´ ä¸ä¼šå½±å“åˆ°å¤–é¢çš„å…ƒç´ ã€‚åä¹‹ä¹Ÿå¦‚æ­¤ã€‚</li><li>è®¡ç®—BFCçš„é«˜åº¦æ—¶ï¼Œæµ®åŠ¨å…ƒç´ ä¹Ÿå‚ä¸è®¡ç®—</li></ol></li><li><p>é‚£äº›å…ƒç´ ä¼šç”ŸæˆBFC</p><ol><li>æ ¹å…ƒç´ </li><li>floatå…ƒç´ ä¸ä¸ºnone</li><li>positionä¸º absoluteæˆ–è€…fixed</li><li>displayä¸ºinline-block, table-cell, table-caption, flex, inline-flex</li><li>overflowä¸ä¸ºvisible</li></ol></li><li><p>BFCä½œç”¨</p><ol><li>è‡ªé€‚åº”ä¸¤æ å¸ƒå±€</li><li>æ¸…é™¤å†…éƒ¨æµ®åŠ¨</li><li>é˜²æ­¢marginé‡å </li></ol></li><li><p>ä¾‹å­è¯´æ˜</p></li><li><p>æ ¹æ®ä»¥ä¸ŠBFCå¸ƒå±€è§„åˆ™ç¬¬3æ¡ã€ç¬¬4æ¡æ¥è§¦å‘mainç”ŸæˆBFCï¼Œæ¥å®ç°è‡ªé€‚åº”ä¸¤æ å¸ƒå±€</p><pre><code>  /****css****/  .main{    overflow: hidden;    height: 500px;    background: yellow;  }  .aside{    float: left;    width: 200px;    height: 500px;    background-color: red;  }  &lt;!--html--&gt;  &lt;div class=&quot;box&quot;&gt;    &lt;div class=&quot;aside&quot;&gt;ä¾§è¾¹æ åŒºåŸŸ&lt;/div&gt;    &lt;div class=&quot;main&quot;&gt;å†…å®¹åŒºåŸŸ&lt;/div&gt;  &lt;/div&gt;</code></pre></li><li><p>æ ¹æ®BFCå¸ƒå±€è§„åˆ™ç¬¬6æ¡ï¼Œè§£å†³floatå…ƒç´ ä½¿å…¶çˆ¶å…ƒç´ é«˜åº¦å¡Œé™·é—®é¢˜</p><pre><code>  /****css****/  .parent{    border: 1px solid red;    width: 400px;    overflow: hidden;    padding: 10px;  }  .child{    float: left;    height: 300px;    width: 198px;    border: 1px solid green;  }  &lt;!--html--&gt;  &lt;div class=&quot;parent&quot;&gt;    &lt;div class=&quot;child&quot;&gt;&lt;/div&gt;    &lt;div class=&quot;child&quot;&gt;&lt;/div&gt;  &lt;/div&gt;</code></pre></li><li><p>é˜²æ­¢marginé‡å ,æ ¹æ®ç”ŸæˆBFCç¬¬4æ¡è§„åˆ™</p><pre><code>  /****css****/  .box{    width: 300px;    height: auto;  }  .content{    width: 300px;    height: 200px;    margin: 100px;    background: red;  }  .warp{    display: inline-block;  }  &lt;!--html--&gt;  &lt;div class=&quot;box&quot;&gt;    &lt;div class=&quot;content&quot;&gt;&lt;/div&gt;    &lt;div class=&quot;content warp&quot;&gt;&lt;/div&gt;  &lt;/div&gt;</code></pre></li></ul><h3 id="IFC"><a href="#IFC" class="headerlink" title="IFC"></a>IFC</h3><ol><li><p>å¸ƒå±€è§„åˆ™</p><ul><li>å®šä¹‰(Inline Formatting Contexts)ï¼šå†…è”æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼ˆæ¯ä¸€ä¸ªå…ƒç´ ç›’å­ä»å·¦åˆ°å³æ’åˆ—ï¼‰</li><li>IFCçš„line boxé«˜åº¦ ç”±å…¶è¡Œå†…å…ƒç´ ä¸­ æœ€é«˜çš„å®é™…é«˜åº¦è®¡ç®—è€Œæ¥ï¼ˆä¸å—åˆ°ç«–ç›´æ–¹å‘çš„padding/marginå½±å“)</li><li>inline-level box:display å±æ€§ä¸º inline, inline-boxï¼Œinline-tableï¼Œtable-cellï¼Œtable-column-groupç­‰ï¼Œä¼šç”Ÿæˆ inline-level boxã€‚å¹¶ä¸”å‚ä¸ inline fomatting contextï¼›</li><li>å½“inline-level boxçš„å®½åº¦å¤§äºcontaining blockï¼Œä¸”è¾¾åˆ°å†…å®¹æ¢è¡Œæ¡ä»¶æ—¶ï¼Œä¼šå°†inline-levelæ‹†æ•£ä¸ºå¤šä¸ªinline-level boxå¹¶åˆ†å¸ƒåˆ°å¤šè¡Œä¸­</li><li>inline-level boxä¸€èˆ¬å·¦å³éƒ½è´´ç´§æ•´ä¸ªIFCï¼Œä½†æ˜¯ä¼šå› ä¸ºfloatå…ƒç´ è€Œæ‰°ä¹±ã€‚floatå…ƒç´ ä¼šä½äºIFCä¸ä¸line boxä¹‹é—´ï¼Œä½¿å¾—line boxå®½åº¦ç¼©çŸ­</li><li>IFCä¸­ä¸å¯èƒ½æœ‰å—çº§å…ƒç´ ï¼Œå½“æ’å…¥å—çº§å…ƒç´ æ—¶ï¼ˆå¦‚pä¸­æ’å…¥divï¼‰ä¼šäº§ç”Ÿä¸¤ä¸ªåŒ¿åå—ä¸divåˆ†éš”å¼€ï¼Œå³äº§ç”Ÿä¸¤ä¸ªIFCï¼Œæ¯ä¸ªIFCå¯¹å¤–è¡¨ç°ä¸ºå—çº§å…ƒç´ ï¼Œä¸divå‚ç›´æ’åˆ—ã€‚</li></ul></li><li><p>ä½œç”¨</p><ul><li>æ°´å¹³å±…ä¸­ï¼šå½“ä¸€ä¸ªå—è¦åœ¨ç¯å¢ƒä¸­æ°´å¹³å±…ä¸­æ—¶ï¼Œè®¾ç½®å…¶ä¸ºinline-blockåˆ™ä¼šåœ¨å¤–å±‚äº§ç”ŸIFCï¼Œé€šè¿‡text-alignåˆ™å¯ä»¥ä½¿å…¶æ°´å¹³å±…ä¸­ã€‚</li><li>å‚ç›´å±…ä¸­ï¼šåˆ›å»ºä¸€ä¸ªIFCï¼Œç”¨å…¶ä¸­ä¸€ä¸ªå…ƒç´ æ’‘å¼€çˆ¶å…ƒç´ çš„é«˜åº¦ï¼Œç„¶åè®¾ç½®å…¶vertical-align:middleï¼Œå…¶ä»–è¡Œå†…å…ƒç´ åˆ™å¯ä»¥åœ¨æ­¤çˆ¶å…ƒç´ ä¸‹å‚ç›´å±…ä¸­ã€‚</li></ul></li><li><p>ç¤ºä¾‹</p><ul><li><p>æ ¹æ®å¸ƒå±€è§„åˆ™ç¬¬4æ¡</p><pre><code>/****css****/.break{ border: 1px solid red; background: yellow;}&lt;!--html--&gt;&lt;span class=&quot;break&quot;&gt;è¿™æ˜¯ä¸€ä¸ªè¡Œå†…ç›’å­è¿™æ˜¯ä¸€ä¸ªè¡Œå†…ç›’å­è¿™æ˜¯ä¸€ä¸ªè¡Œå†…ç›’å­&lt;/span&gt;</code></pre><p><img src="/images/css-IFC.jpg" alt></p></li></ul></li><li><p>æ ¹æ®ä½œç”¨ç¬¬1æ¡,è®¾ç½®spanä¸ºinline-block,åˆ™ä¼šåœ¨boxä¸Šäº§ç”Ÿifc,åœ¨boxä¸Šè®¾ç½®text-alignä½¿spanå…ƒç´ æ°´å¹³å±…ä¸­ã€‚</p><pre><code> /****css****/ .box{text-align: center;} .content{   display: inline-block;   border: 1px solid red; } &lt;!--html--&gt; &lt;div class=&quot;box&quot;&gt;   &lt;span class=&quot;content&quot;&gt;å†…å®¹åŒºåŸŸ&lt;/span&gt; &lt;/div&gt;</code></pre></li><li><p>æ ¹æ®ä½œç”¨ç¬¬2æ¡ï¼Œè®¾ç½®ç›’å­2ä¸ºinline-blockï¼Œåˆ™ä¼šåœ¨boxä¸Šäº§ç”Ÿifcï¼Œè®¾ç½®å…¶vertical-align:middleï¼Œç›’å­1å‚ç›´å±…ä¸­ã€‚</p><pre><code> /****css****/ .box{   text-align: center;   border: 1px solid red; } .label{   display: inline-block;   height: 100px;   width: 100px;   vertical-align: middle; } &lt;!--html--&gt; &lt;div class=&quot;box&quot;&gt;   &lt;span class=&quot;content&quot;&gt;ç›’å­1&lt;/span&gt;   &lt;span class=&quot;label&quot;&gt;ç›’å­2&lt;/span&gt; &lt;/div&gt;</code></pre></li></ol><h3 id="FFC"><a href="#FFC" class="headerlink" title="FFC"></a>FFC</h3><ol><li>å®šä¹‰(Flex Formatting Contexts)ï¼šè‡ªé€‚åº”æ ¼å¼åŒ–ä¸Šä¸‹æ–‡</li><li>displayå€¼ä¸ºflexæˆ–è€…inline-flexçš„å…ƒç´ å°†ä¼šç”Ÿæˆè‡ªé€‚åº”å®¹å™¨ï¼ˆflex containerï¼‰</li><li>FFCå’ŒBFCåŒºåˆ«<ul><li>Flexbox ä¸æ”¯æŒ ::first-line å’Œ ::first-letter è¿™ä¸¤ç§ä¼ªå…ƒç´ </li><li>vertical-align å¯¹ Flexbox ä¸­çš„å­å…ƒç´ å¤±æ•ˆ</li><li>float å’Œ clear å±æ€§å¯¹ Flexbox ä¸­çš„å­å…ƒç´ æ˜¯æ²¡æœ‰æ•ˆæœçš„ï¼Œä¹Ÿä¸ä¼šä½¿å­å…ƒç´ è„±ç¦»æ–‡æ¡£æµ</li><li>å¤šæ å¸ƒå±€ï¼ˆcolumn-*ï¼‰ åœ¨ Flexbox ä¸­å¤±æ•ˆ</li><li>Flexbox ä¸‹çš„å­å…ƒç´ ä¸ä¼šç»§æ‰¿çˆ¶çº§å®¹å™¨çš„å®½</li></ul></li></ol><h3 id="GFC"><a href="#GFC" class="headerlink" title="GFC"></a>GFC</h3><ol><li>å®šä¹‰(GridLayout Formatting Contexts)ï¼šç½‘æ ¼å¸ƒå±€æ ¼å¼åŒ–ä¸Šä¸‹æ–‡</li><li>displayå€¼ä¸ºgridçš„å…ƒç´ ï¼Œè·å¾—ä¸€ä¸ªç‹¬ç«‹çš„æ¸²æŸ“åŒºåŸŸï¼Œå¯åœ¨ç½‘æ ¼å†…å®šä¹‰é¡¹ç›®ï¼ˆitemï¼‰ã€è¡Œï¼ˆrowï¼‰ã€åˆ—ï¼ˆcolumnsï¼‰</li></ol>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTML ç³»åˆ—æ€»ç»“</title>
      <link href="/2017/05/10/html/html/"/>
      <url>/2017/05/10/html/html/</url>
      
        <content type="html"><![CDATA[<div align="middle"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=407679465&auto=1&height=66"></iframe></div><h3 id="ä»€ä¹ˆæ˜¯html"><a href="#ä»€ä¹ˆæ˜¯html" class="headerlink" title="ä»€ä¹ˆæ˜¯html"></a>ä»€ä¹ˆæ˜¯html</h3><p>è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼ˆHyperText Markup Languageï¼‰ï¼Œæ˜¯â€œç½‘é¡µæµè§ˆå™¨ä¸­çœ‹åˆ°å±•ç¤ºä¿¡æ¯çš„â€è®¾è®¡çš„ä¸€ç§æ ‡è®°è¯­è¨€ã€‚</p><h3 id="Doctypeå«ä¹‰"><a href="#Doctypeå«ä¹‰" class="headerlink" title="Doctypeå«ä¹‰"></a>Doctypeå«ä¹‰</h3><ul><li><!DOCTYPE>å£°æ˜ä½äºä½äºHTMLæ–‡æ¡£ä¸­çš„ç¬¬ä¸€è¡Œï¼Œå‘Šè¯‰æµè§ˆå™¨çš„è§£é‡Šå™¨ç”¨ä»€ä¹ˆæ–‡æ¡£æ ‡å‡†æ¥è§£æè¿™ä¸ªæ–‡æ¡£ã€‚</li><li>DOCTYPEä¹¦å†™é”™è¯¯æˆ–è€…ä¸å­˜åœ¨ä¼šå¯¼è‡´æ–‡æ¡£å·²å…¼å®¹æ¨¡å¼å‘ˆç°</li></ul><h3 id="æ ‡å‡†æ¨¡å¼å’Œæ··æ‚æ¨¡å¼"><a href="#æ ‡å‡†æ¨¡å¼å’Œæ··æ‚æ¨¡å¼" class="headerlink" title="æ ‡å‡†æ¨¡å¼å’Œæ··æ‚æ¨¡å¼"></a>æ ‡å‡†æ¨¡å¼å’Œæ··æ‚æ¨¡å¼</h3><ul><li>æ ‡å‡†æ¨¡å¼ï¼š html æ’ç‰ˆå’Œ js æ¸²æŸ“å·¥ä½œæ¨¡å¼éƒ½æ˜¯ä»¥è¯¥æµè§ˆå™¨æ”¯æŒçš„æœ€é«˜æ ‡å‡†è¿è¡Œã€‚</li><li>å…¼å®¹æ¨¡å¼ï¼šé¡µé¢å·²å®½æ¾çš„å‘åå…¼å®¹çš„æ–¹å¼æ˜¾ç¤ºï¼Œæ¨¡æ‹Ÿè€æµè§ˆå™¨çš„è¡Œä¸ºã€‚</li></ul><h3 id="HTML5-ä¸ºä»€ä¹ˆåªéœ€è¦å†™-lt-DOCTYPE-HTML-gt"><a href="#HTML5-ä¸ºä»€ä¹ˆåªéœ€è¦å†™-lt-DOCTYPE-HTML-gt" class="headerlink" title="HTML5 ä¸ºä»€ä¹ˆåªéœ€è¦å†™ &lt;!DOCTYPE HTML&gt;"></a>HTML5 ä¸ºä»€ä¹ˆåªéœ€è¦å†™ <code>&lt;!DOCTYPE HTML&gt;</code></h3><p>html5ä¸æ˜¯åŸºäºSGMLï¼Œæ‰€ä»¥ä¸éœ€è¦å¯¹DTDè¿›è¡Œå¼•ç”¨ï¼Œä½†æ˜¯å®ƒéœ€è¦å¯¹æ–‡æ¡£ç±»å‹å£°æ˜ï¼Œéœ€è¦doctypeæ¥è§„èŒƒæµè§ˆå™¨è¡Œä¸ºã€‚</p><h3 id="è¡Œå†…å…ƒç´ -å—çº§å…ƒç´ -ç©ºå…ƒç´ "><a href="#è¡Œå†…å…ƒç´ -å—çº§å…ƒç´ -ç©ºå…ƒç´ " class="headerlink" title="è¡Œå†…å…ƒç´ -å—çº§å…ƒç´ -ç©ºå…ƒç´ "></a>è¡Œå†…å…ƒç´ -å—çº§å…ƒç´ -ç©ºå…ƒç´ </h3><ul><li>cssä¸­è§„å®šæ¯ä¸ªå…ƒç´ éƒ½æœ‰é»˜è®¤çš„displayå±æ€§å’Œå€¼</li><li>è¯¥å…ƒç´ çš„å±æ€§çš„å€¼ä¸ºâ€˜inlineâ€™çš„åˆ™ä¸ºè¡Œå†…å…ƒç´ ï¼ˆå¦‚:<code>span,a img,input</code>ç­‰ï¼‰</li><li>è¯¥å…ƒç´ çš„å±æ€§çš„å€¼ä¸ºâ€˜blockâ€™çš„åˆ™ä¸ºå—çº§å…ƒç´ ï¼ˆ<code>divï¼Œul,li h1...p</code>ç­‰ï¼‰</li><li>ç©ºï¼ˆvoidï¼‰å…ƒç´  <code>&lt;br&gt; &lt;hr&gt; &lt;img&gt; &lt;input&gt; &lt;link&gt; &lt;meta&gt;</code> ç­‰</li></ul><h3 id="htmlè¯­ä¹‰åŒ–"><a href="#htmlè¯­ä¹‰åŒ–" class="headerlink" title="htmlè¯­ä¹‰åŒ–"></a>htmlè¯­ä¹‰åŒ–</h3><ol><li>å®šä¹‰ï¼šæ­£ç¡®çš„æ ‡ç­¾åšæ­£ç¡®çš„äº‹æƒ…</li><li>ä¸ºä»€ä¹ˆè¦åšè¯­ä¹‰åŒ–<ul><li>æœ‰åˆ©äºSEOï¼Œæœ‰åˆ©äºæœç´¢å¼•æ“çˆ¬è™«æ›´å¥½çš„ç†è§£æˆ‘ä»¬çš„ç½‘é¡µï¼Œä»è€Œè·å–æ›´å¤šçš„æœ‰æ•ˆä¿¡æ¯ï¼Œæå‡ç½‘é¡µçš„æƒé‡ã€‚</li><li>åœ¨æ²¡æœ‰CSSçš„æ—¶å€™èƒ½å¤Ÿæ¸…æ™°çš„çœ‹å‡ºç½‘é¡µçš„ç»“æ„ï¼Œå¢å¼ºå¯è¯»æ€§ï¼Œä¾¿äºå›¢é˜Ÿå¼€å‘å’Œç»´æŠ¤ã€‚</li><li>æ”¯æŒå¤šç»ˆç«¯è®¾å¤‡çš„æµè§ˆå™¨æ¸²æŸ“ã€‚</li></ul></li><li>SEO<ul><li>æ±‰è¯‘ä¸ºæœç´¢å¼•æ“ä¼˜åŒ–ã€‚æ˜¯ä¸€ç§æ–¹å¼ï¼šåˆ©ç”¨æœç´¢å¼•æ“çš„è§„åˆ™æé«˜ç½‘ç«™åœ¨æœ‰å…³æœç´¢å¼•æ“å†…çš„è‡ªç„¶æ’åã€‚</li><li>ç›®çš„ï¼š<br>ä¸ºç½‘ç«™æä¾›ç”Ÿæ€å¼çš„è‡ªæˆ‘è¥é”€è§£å†³æ–¹æ¡ˆï¼Œè®©å…¶åœ¨è¡Œä¸šå†…å æ®é¢†å…ˆåœ°ä½ï¼Œè·å¾—å“ç‰Œæ”¶ç›Šï¼›SEOåŒ…å«ç«™å¤–SEOå’Œç«™å†…SEOä¸¤æ–¹é¢ï¼›ä¸ºäº†ä»æœç´¢å¼•æ“ä¸­è·å¾—æ›´å¤šçš„å…è´¹æµé‡ï¼Œä»ç½‘ç«™ç»“æ„ã€å†…å®¹å»ºè®¾æ–¹æ¡ˆã€ç”¨æˆ·äº’åŠ¨ä¼ æ’­ã€é¡µé¢ç­‰è§’åº¦è¿›è¡Œåˆç†è§„åˆ’ï¼Œè¿˜ä¼šä½¿æœç´¢å¼•æ“ä¸­æ˜¾ç¤ºçš„ç½‘ç«™ç›¸å…³ä¿¡æ¯å¯¹ç”¨æˆ·æ¥è¯´æ›´å…·æœ‰å¸å¼•åŠ›ã€‚</li><li>ä¼˜åŒ–æ–¹å¼ï¼š <ul><li>å†…éƒ¨ä¼˜åŒ–ï¼š<ol><li>METAæ ‡ç­¾ä¼˜åŒ–ï¼šä¾‹å¦‚ï¼šTITLEï¼ŒKEYWORDSï¼ŒDESCRIPTIONç­‰çš„ä¼˜åŒ–ã€‚</li><li>å†…éƒ¨é“¾æ¥çš„ä¼˜åŒ–ï¼ŒåŒ…æ‹¬ç›¸å…³æ€§é“¾æ¥ï¼ˆTagæ ‡ç­¾ï¼‰ï¼Œé”šæ–‡æœ¬é“¾æ¥ï¼Œå„å¯¼èˆªé“¾æ¥ï¼ŒåŠå›¾ç‰‡é“¾æ¥ã€‚</li><li>ç½‘ç«™å†…å®¹æ›´æ–°ï¼šæ¯å¤©ä¿æŒç«™å†…çš„æ›´æ–°(ä¸»è¦æ˜¯æ–‡ç« çš„æ›´æ–°ç­‰)ã€‚</li></ol></li><li>å¤–éƒ¨ä¼˜åŒ–ï¼š<ol><li>å¤–éƒ¨é“¾æ¥ç±»åˆ«ï¼šå‹æƒ…é“¾æ¥ã€åšå®¢ã€è®ºå›ã€B2Bã€æ–°é—»ã€åˆ†ç±»ä¿¡æ¯ã€è´´å§ã€çŸ¥é“ã€ç™¾ç§‘ã€ç«™ç¾¤ã€ç›¸å…³ä¿¡æ¯ç½‘ç­‰å°½é‡ä¿æŒé“¾æ¥çš„å¤šæ ·æ€§ã€‚</li><li>å¤–é“¾è¿è¥ï¼šæ¯å¤©æ·»åŠ ä¸€å®šæ•°é‡çš„å¤–éƒ¨é“¾æ¥ï¼Œä½¿å…³é”®è¯æ’åç¨³å®šæå‡ã€‚</li><li>å¤–é“¾é€‰æ‹©ï¼šä¸ä¸€äº›å’Œä½ ç½‘ç«™ç›¸å…³æ€§æ¯”è¾ƒé«˜ï¼Œæ•´ä½“è´¨é‡æ¯”è¾ƒå¥½çš„ç½‘ç«™äº¤æ¢å‹æƒ…é“¾æ¥ï¼Œå·©å›ºç¨³å®šå…³é”®è¯æ’åã€‚</li></ol></li></ul></li></ul></li></ol><h3 id="åŒæºç­–ç•¥"><a href="#åŒæºç­–ç•¥" class="headerlink" title="åŒæºç­–ç•¥"></a>åŒæºç­–ç•¥</h3><ol><li>æ¦‚å¿µï¼šå¦‚æœä¸¤ä¸ªé¡µé¢çš„åè®®ï¼Œç«¯å£ï¼ˆå¦‚æœæœ‰æŒ‡å®šï¼‰å’ŒåŸŸåéƒ½ç›¸åŒï¼Œåˆ™ä¸¤ä¸ªé¡µé¢å…·æœ‰ç›¸åŒçš„æºã€‚</li><li>ç›®çš„ï¼šä¿è¯ç”¨æˆ·ä¿¡æ¯å®‰å…¨ï¼Œé˜²æ­¢æ¶æ„ç½‘ç«™çªƒå–æ•°æ®ï¼Œé˜²æ­¢cookieå…±äº«</li><li>é™åˆ¶èŒƒå›´<ul><li>cookieã€localStorageã€indexedDBæ— æ³•è¯»å–</li><li>dom æ— æ³•è·å–</li><li>ajaxä¸èƒ½å‘é€</li><li>formè¡¨å•æ²¡æœ‰é™åˆ¶</li></ul></li><li>å¦‚ä½•è®¾ç½®åŒæºç­–ç•¥(host)ï¼šdocument.domain</li><li>ä¸å—åŒæºç­–ç•¥é™åˆ¶ï¼š<ul><li>é¡µé¢ä¸­çš„é“¾æ¥ï¼Œé‡å®šå‘ä»¥åŠè¡¨å•æäº¤æ˜¯ä¸ä¼šå—åˆ°åŒæºç­–ç•¥é™åˆ¶çš„ã€‚</li><li>è·¨åŸŸèµ„æºçš„å¼•å…¥æ˜¯å¯ä»¥çš„ã€‚ä½†æ˜¯jsä¸èƒ½è¯»å†™åŠ è½½çš„å†…å®¹ã€‚å¦‚åµŒå…¥åˆ°é¡µé¢ä¸­çš„<code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;ï¼Œ&lt;img&gt;ï¼Œ&lt;link&gt;ï¼Œ&lt;iframe&gt;</code>ç­‰ã€‚</li></ul></li></ol><h3 id="è·¨åŸŸ"><a href="#è·¨åŸŸ" class="headerlink" title="è·¨åŸŸ"></a>è·¨åŸŸ</h3><p>  å—åˆ°æµè§ˆå™¨åŒæºç­–ç•¥çš„å½±å“ï¼Œè¦æ“ä½œå…¶ä»–æºä¸‹é¢çš„è„šæœ¬ï¼Œå°±éœ€è¦è·¨åŸŸã€‚</p><h3 id="Ajaxè·¨åŸŸçš„è§£å†³æ–¹æ¡ˆ"><a href="#Ajaxè·¨åŸŸçš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="Ajaxè·¨åŸŸçš„è§£å†³æ–¹æ¡ˆ"></a>Ajaxè·¨åŸŸçš„è§£å†³æ–¹æ¡ˆ</h3><p><strong>1.JSONPï¼š</strong></p><p>  ç½‘é¡µæ·»åŠ ä¸€ä¸ª<code>&lt;script&gt;</code>å…ƒç´ ï¼Œå‘æœåŠ¡å™¨è¯·æ±‚jsONæ•°æ®ã€‚æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œå°†æ•°æ®æ”¾åœ¨ä¸€ä¸ªæŒ‡å®šåå­—çš„å›è°ƒå‡½æ•°é‡Œä¼ å›æ¥ã€‚</p><pre><code>- ç¼ºç‚¹åªæ”¯æŒgetè¯·æ±‚- ä¼˜ç‚¹ç®€å•æ–¹ä¾¿ï¼Œæ˜“ç†è§£ï¼Œå…¼å®¹æ€§è‰¯å¥½- å¦‚ä¸‹ç¤ºä¾‹ä»£ç ```  //åŠ¨æ€åˆ›å»ºscriptï¼Œç”¨äºè·¨è¶Šæ“ä½œ  function creatScriptTag(src) {    var script = document.createElement(&#39;script&#39;);    script.setAttribute(&quot;type&quot;,&quot;text/javascript&quot;);    script.src = src;    document.body.appendChild(script);  }  // è°ƒç”¨creatScriptTagå‡½æ•°  window.onload = function () {    var url = &#39;/index.php?jsoncallback=result&#39;;    creatScriptTag(url);  }  // å®šä¹‰å›è°ƒå‡½æ•°  function result (data) {    console.log(data);  } ``````  // index.php   &lt;?php  header(&#39;Content-type: application/json&#39;);  //è·å–å›è°ƒå‡½æ•°å  $jsoncallback = htmlspecialchars($_REQUEST [&#39;jsoncallback&#39;]);  //å–æ•°æ®  $data = [    &#39;data&#39;=&gt;&#39;123&#39;,  ];  $json_data = json_encode(array(&#39;code&#39;=&gt;&#39;200&#39;,&#39;msg&#39;=&gt;&#39;è¯·æ±‚æˆåŠŸ&#39;,&#39;data&#39; =&gt; $data),jsON_UNESCAPED_UNICODE);  //è¾“å‡ºjsonpæ ¼å¼çš„æ•°æ®  echo $jsoncallback .&quot;(&quot; . $json_data . &quot;)&quot;;  ?&gt;```</code></pre><p><strong>2.WebSocket:</strong></p><p>  æ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œä½¿ç”¨ws://ï¼ˆéåŠ å¯†ï¼‰å’Œwss://ï¼ˆåŠ å¯†ï¼‰ä½œä¸ºåè®®å‰ç¼€ã€‚è¯¥åè®®ä¸å®è¡ŒåŒæºæ”¿ç­–ï¼Œåªè¦æœåŠ¡å™¨è®¾ç½®åˆ©ç”¨originå­—æ®µè®¾ç½®ç™½åå•ï¼Œå°±å¯ä»¥é€šè¿‡å®ƒè¿›è¡Œè·¨æºé€šä¿¡ã€‚</p><p><strong>3.CORSï¼ˆCross-Origin Resource Sharingï¼‰</strong></p><ul><li>åœ¨è¯·æ±‚å¤´ä¿¡æ¯ä¸­å¢åŠ Originå­—æ®µï¼Œç”¨æ¥è¯´æ˜æ­¤æ¬¡è¯·æ±‚æ¥è‡ªé‚£ä¸ªæºï¼ˆåè®®+åŸŸå+ç«¯å£ï¼‰ï¼Œæ­¤å­—æ®µå¯ä»¥è®¾ç½®ç›¸åº”ç™½åå•</li><li>å¿…é¡»è®¾ç½®<code>Access-Control-Allow-Origin</code>å­—æ®µï¼Œå€¼è¦æ±‚æ˜¯<code>Origin</code>å­—æ®µçš„å€¼æˆ–è€…æ˜¯<em>ï¼Œ</em>çš„æ„æ€æ˜¯æ¥å—ä»»æ„åŸŸåçš„è¯·æ±‚</li><li>CORSè¯·æ±‚é»˜è®¤ä¸å‘é€cookieå’Œhttpè®¤è¯ä¿¡æ¯ï¼Œå¦‚æœè¦å‘é€ï¼Œè¦åœ¨æœåŠ¡å™¨ç«¯æŒ‡<code>Access-Control-Allow-Credentials: true</code>,å¹¶ä¸”ajaxè¯·æ±‚å¿…é¡»æ‰“å¼€withCredentialså±æ€§<pre><code>var xhr = new XMLHttpRequest();xhr.withCredentials = true;</code></pre></li><li>å¦‚æœé€‰æ‹©å‘é€cookie,<code>Access-Control-Allow-Origin</code>å­—æ®µä¸èƒ½è®¾ä¸º*ï¼Œå¿…é¡»æŒ‡å®šæ˜ç¡®çš„ï¼Œä¸å½“å‰ç½‘é¡µä¸€è‡´çš„åŸŸå</li></ul>]]></content>
      
      
      <categories>
          
          <category> HTML </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP å¸¸ç”¨æ–¹æ³•</title>
      <link href="/2017/01/23/php/method/"/>
      <url>/2017/01/23/php/method/</url>
      
        <content type="html"><![CDATA[<p>æ­¤ç¯‡æ–‡ç« JSæ•°ç»„æ–¹æ³•æ€»ç»“ä¸€æ ·çº¯å±æ˜¯ä¸ºäº†ç†Ÿæ‚‰APIï¼Œä¸å¾—ä¸æ‰¿è®¤PHPå¤§æ³•å¥½æ¯”JSçš„åŸç”Ÿæ–¹æ³•å¤šçš„å¾ˆã€‚è¿™é‡Œåªåˆ—å‡ºä¸ªäººè®¤ä¸ºæ¯”è¾ƒå¸¸ç”¨çš„ã€‚<br></p><p><strong>æ•°ç»„å†…ç½®å‡½æ•°</strong><br></p><ol><li><p>forã€foreachå¾ªç¯è¾“å‡ºæ•°ç»„å…ƒç´ <br></p><pre><code>&lt;?php // forå¾ªç¯for ($i = 0; $i &lt;= 100; $i++) { echo &quot;$i &lt;br/&gt;&quot;;} // foreach åªé€‚ç”¨äºæ•°ç»„$name = array(&#39;zhangsan&#39;, &#39;lisi&#39;, &#39;wangwu&#39;);  // åˆ›å»ºæ•°ç»„foreach ($name as $value) { echo &quot;$value &lt;br/&gt;&quot;;}?&gt;</code></pre></li><li><p>count() è·å–æ•°ç»„å…ƒç´ çš„ä¸ªæ•° <br></p><pre><code>&lt;?php$nameLength = array(&#39;zhangsan&#39;, &#39;lisi&#39;, &#39;wangwu&#39;);echo count($nameLength); // 3?&gt;</code></pre></li><li><p>è¾“å‡ºæ•°ç»„å½“å‰çš„å…ƒç´ çš„å€¼ï¼Œå¦‚æœå½“å‰å…ƒç´ ä¸ºç©ºæˆ–è€…æ— å€¼åˆ™è¿”å›FALSE <br></p><pre><code>&lt;?php$name = array(&#39;zhangsan&#39;, &#39;lisi&#39;, &#39;wangwu&#39;);echo current($name); // è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ zhangsan echo end($name); // è¿”å›æœ€åä¸€ä¸ªå…ƒç´ wangwuecho next($name); // è¿”å›æŒ‡å®šå…ƒç´ çš„ä¸‹ä¸€ä¸ªå…ƒç´ echo prev($name); // è¿”å›æŒ‡å®šå…ƒç´ çš„ä¸Šä¸€ä¸ªå…ƒç´ echo reset($name); // æŠŠå†…éƒ¨æŒ‡é’ˆç§»åŠ¨åˆ°æ•°ç»„çš„é¦–ä¸ªå…ƒç´ zhangsan</code></pre></li></ol><p>?&gt;</p><pre><code>4. å¯¹å½“å‰æ•°ç»„è¿›è¡Œæ’åº&lt;br/&gt;</code></pre><p>  $numbers = array(1, 2, 3, 3, 4, 5, 6, 2);</p><p>  // è¿”å›bool<br>  sort($numbers);  //å¯¹æ•°ç»„è¿›è¡Œå‡åºæˆåŠŸåˆ™ä¸ºtrue å¤±è´¥åˆ™ä¸ºfalse<br>  rsort($numbers); //å¯¹æ•°ç»„è¿›è¡Œé™åºæˆåŠŸåˆ™ä¸ºtrue å¤±è´¥åˆ™ä¸ºfalse<br>  array_reverse($array, $preserve); //å¯¹åŸæ•°ç»„æŒ‰ååºæ’åºï¼Œè¿”å›æ’åºåçš„æ•°ç»„(2, 6, 5, 4, 3, 3, 2, 1)</p><pre><code>5. åˆå¹¶æ•°ç»„&lt;br/&gt;</code></pre><p>$arr = array(1, 2, 3, 3, 4, 5, 6, 2);<br>$arr1 = array(10, 20, 30);</p><p>array_merge($arr, $arr1 );</p><pre><code>6. å‹æ ˆï¼Œå‡ºæ ˆ&lt;br/&gt;</code></pre><p>$name = â€˜wangâ€™;<br>$name1  = array(â€˜zhangâ€™, â€˜liâ€™);</p><p>array_push($name1, $name); // 3 è¿”å›æ–°æ•°ç»„çš„é•¿åº¦</p><p>array_pop($name1); //li è¿”å›è¢«popçš„å€¼ã€‚æ ˆä¸ºç©ºï¼Œè¿”å›null</p><p>array_shift($name1); //åˆ é™¤ç¬¬ä¸€ä¸ªå…ƒç´ å¹¶è¿”å›ï¼›</p><p>array_unshift(arrayï¼Œval1ï¼Œval2,â€¦); //å°†å‚æ•°æŒ‰ç…§é¡ºåºåŠ å…¥é˜Ÿåˆ—ä¸­</p><pre><code>7. ç»Ÿè®¡æ•°ç»„ä¸­å€¼ä¸ºå‡ºç°çš„æ¬¡æ•°&lt;br/&gt;</code></pre><p>$val = array(1, 2, 3, 3, 4, 3, 3, 1, 1);<br>print_r(array_count_values($val));</p><pre><code>8. è¿‡æ»¤æ•°ç»„çš„å…ƒç´ &lt;br/&gt;</code></pre><p>function func ($var) {<br>  return($var &amp; 1);<br>}</p><p>$val = array(â€˜aâ€™, â€˜bâ€™, 2, 3, 4);<br>print_r(array_filter($val, â€˜funcâ€™)); // 3</p><pre><code>9. æ£€æŸ¥ç´¢å¼•æ˜¯å¦åœ¨æ•°ç»„ä¸­&lt;br/&gt;</code></pre><p>$people = array(â€˜nameâ€™=&gt;â€™renboâ€™, â€˜ageâ€™=&gt;â€™28â€™);</p><p>if (array_key_exists(â€˜nameâ€™, $people)) {<br>  echo â€˜nameå­˜åœ¨â€™;<br>}</p><pre><code>10. æ£€æŸ¥æ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å€¼&lt;br/&gt;</code></pre><p>$val = array(â€˜zhangsanâ€™, â€˜lisiâ€™, â€˜wangwuâ€™);<br>if (in_array(â€˜zhangsanâ€™, $val)) {<br>  echo â€˜å­˜åœ¨â€™;<br>}</p><pre><code>11. è¿”å›å½“å‰å…ƒç´ çš„Key&lt;br/&gt;</code></pre><p>$people = array(â€˜nameâ€™=&gt;â€™renboâ€™, â€˜ageâ€™=&gt;â€™28â€™);<br>key($people); //name</p><pre><code>12. è¿”å›å½“å‰å…ƒç´ æ‰€æœ‰çš„key&lt;br/&gt;</code></pre><p>$people = array(â€˜nameâ€™=&gt;â€™renboâ€™,â€™ageâ€™=&gt;â€™28â€™);<br>print_r(array_keys($people)); // name age</p><pre><code>**æ—¶é—´å†…ç½®å‡½æ•°**&lt;br/&gt;</code></pre><p>date(format[,timestamp])</p><p>mktime(hour,minute,second,month,day,year) //çœç•¥çš„å‚æ•°å°†ä»¥æœ¬åœ°æ—¥æœŸå’Œæ—¶é—´ä»£æ›¿</p><p>getdate([timestamp]) </p><pre><code>**URLå¤„ç†å†…ç½®å‡½æ•°**&lt;br/&gt;</code></pre><p>urlencode(str) è¿”å›å€¼å­—ç¬¦ä¸²ä¸­æ‰€æœ‰çš„éå­—æ¯å’Œæ•°å­—å­—ç¬¦å˜æˆä¸€ä¸ªç™¾åˆ†å·(%) å’Œä¸€ä¸ªä¸¤ä½çš„åå…­è¿›åˆ¶æ•°ï¼Œç©ºæ ¼è¢«è½¬æ¢æˆ+,-ã€_å’Œ.ä¸åšä»»ä½•è½¬æ¢</p><p>urldecode(str) </p><pre><code>å…¶å®è¿˜æœ‰å¥½å¤šæ¯”å¦‚å­—ç¬¦ä¸²çš„å†…ç½®å‡½æ•°ã€æ–‡ä»¶æ“ä½œçš„å†…ç½®å‡½æ•°ã€æ•°æ®åº“è¿æ¥çš„å†…ç½®å‡½æ•°ç­‰ç­‰ã€‚å…¶å®PHPæ–¹æ³•è¿˜æ˜¯æ¯”JSå¤šç”¨åˆ°çš„æ—¶å€™æŸ¥çœ‹APIå³å¯...&lt;br/&gt;</code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¯­æ³•ã€å˜é‡ã€æ•°æ®ç±»å‹</title>
      <link href="/2017/01/23/php/base/"/>
      <url>/2017/01/23/php/base/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºç¡€è¯­æ³•"><a href="#åŸºç¡€è¯­æ³•" class="headerlink" title="åŸºç¡€è¯­æ³•"></a>åŸºç¡€è¯­æ³•</h2><ol><li>PHP è„šæœ¬ä»¥ <code>&lt;?php å¼€å§‹ï¼Œä»¥ ?&gt; ç»“æŸ</code><br></li><li>PHP æ–‡ä»¶çš„é»˜è®¤æ–‡ä»¶æ‰©å±•åæ˜¯ â€œ.phpâ€<br></li><li>PHP æ–‡ä»¶é€šå¸¸åŒ…å« HTML æ ‡ç­¾å’Œä¸€äº› PHP è„šæœ¬ä»£ç <br></li><li>PHP ä¸­çš„æ¯ä¸ªä»£ç è¡Œéƒ½å¿…é¡»ä»¥åˆ†å·ç»“æŸï¼Œå¦åˆ™è¾“å‡ºé”™è¯¯<br><pre><code>&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;body&gt; </code></pre></li></ol><?php   echo "Hello World!"; ?><p> </p> ```<h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><p><strong>PHP å˜é‡è§„åˆ™ï¼š</strong><br></p><ol><li>å˜é‡ä»¥ $ ç¬¦å·å¼€å§‹ï¼Œåé¢è·Ÿç€å˜é‡çš„åç§°,$a<br></li><li>å˜é‡åå¿…é¡»ä»¥å­—æ¯æˆ–è€…ä¸‹åˆ’çº¿å­—ç¬¦å¼€å§‹<br></li><li>å˜é‡ååªèƒ½åŒ…å«å­—æ¯æ•°å­—å­—ç¬¦ä»¥åŠä¸‹åˆ’çº¿ï¼ˆA-zã€0-9 å’Œ _ ï¼‰<br></li><li>å˜é‡åä¸èƒ½åŒ…å«ç©ºæ ¼<br></li><li>å˜é‡åæ˜¯åŒºåˆ†å¤§å°å†™çš„ï¼ˆ$y å’Œ $Y æ˜¯ä¸¤ä¸ªä¸åŒçš„å˜é‡ï¼‰<br></li><li>ç”±äºPHPæ˜¯å¼±ç±»å‹è¯­è¨€æ‰€ä»¥å˜é‡ä¸å¿…å£°æ˜ç±»å‹å’ŒJSç±»ä¼¼ <br></li></ol><p><strong>PHP å˜é‡ä½œç”¨åŸŸ</strong><br></p><p><strong>å››ç§ä¸åŒçš„å˜é‡ä½œç”¨åŸŸ</strong><br></p><pre><code>local å±€éƒ¨global å…¨å±€static å±€éƒ¨-é™æ€å˜é‡parameter å‚æ•°</code></pre><p><strong>å±€éƒ¨å’Œå…¨å±€ä½œç”¨åŸŸ local global</strong><br></p><pre><code>&lt;?php   $age = 20; //å…¨å±€ä½œç”¨åŸŸ  $name = &#39;zhangsan&#39;;  function people () {    $isJob  = &#39;yes&#39;; //å±€éƒ¨å˜é‡    global $name;   //è®¿é—®å…¨å±€ä½œç”¨åŸŸ    var_dump($name);  // zhangsan   }  people()?&gt;</code></pre><p>è§£æï¼š<br></p><ol><li>$age æ˜¯åœ¨å‡½æ•°å¤–éƒ¨å®šä¹‰çš„å˜é‡ï¼Œæ‹¥æœ‰å…¨å±€ä½œç”¨åŸŸï¼Œä½†æ˜¯è¿™é‡Œå’Œ JS çš„åŒºåˆ«æ˜¯ $age åœ¨peopleå‡½æ•°ä¸­æ˜¯ä¸å¯è®¿é—®çš„<br></li><li>$isJob æ˜¯åœ¨å‡½æ•°å†…éƒ¨å£°æ˜çš„å˜é‡æ‰€ä»¥æ˜¯å±€éƒ¨å˜é‡ï¼Œåªèƒ½åœ¨å‡½æ•°å†…éƒ¨è®¿é—®<br></li><li>$name global æ˜¯åœ¨å‡½æ•°å†…éƒ¨<strong>è°ƒç”¨</strong>å‡½æ•°å¤–éƒ¨å®šä¹‰çš„å…¨å±€å˜é‡,æ­£å¸¸æƒ…å†µåœ¨å‡½æ•°å†…éƒ¨è®¿é—®å‡½æ•°å¤–éƒ¨çš„å˜é‡åˆ™ä¸ºNULL<br></li></ol><p><strong>Static ä½œç”¨åŸŸ</strong><br></p><pre><code>&lt;?php  function test() {    static $a = 0;    // static $a = 1 + 2; // è§£æé”™è¯¯ å‚ç…§è§£æ2    echo $a;    $a++;  }  test (); //0  test (); //1  test (); //2?&gt;</code></pre><p>è§£æï¼š<br></p><ol><li>é™æ€å…¨å±€å˜é‡çš„ä½œç”¨åŸŸå±€é™äºä¸€ä¸ªæºæ–‡ä»¶å†…ï¼Œåªèƒ½ä¸ºè¯¥æºæ–‡ä»¶å†…çš„å‡½æ•°å…¬ç”¨<br></li><li>ä¸èƒ½å¯¹é™æ€å˜é‡ç”¨è¡¨è¾¾å¼çš„ç»“æœèµ‹å€¼ï¼Œå¦åˆ™ä¼šå¯¼è‡´è§£æé”™è¯¯<br></li><li>staticå…¨å±€å˜é‡åªåˆä½¿åŒ–ä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡ä¾æ®ä¸Šä¸€æ¬¡ç»“æœå€¼ï¼Œä¸Šä¾‹å­ä¸­è°ƒç”¨ä¸‰æ¬¡æ‰§è¡Œçš„ç»“æœæ˜¯ç´¯åŠ çš„ã€‚<br></li><li>åœ¨å†…å­˜çš„é™æ€å­˜å‚¨åŒºä¸­ï¼ˆé™æ€å­˜å‚¨åŒºåœ¨æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´éƒ½å­˜åœ¨ï¼Œå…¶ä»–å±€éƒ¨å˜é‡å­˜å‚¨åœ¨æ ˆä¸­ã€‚<br></li></ol><p><strong>parameter å‚æ•°ä½œç”¨åŸŸ</strong><br></p><pre><code>  function test($a) {    echo $a;  }  test (1); //1</code></pre><p><strong>å°ç»“</strong></p><ol><li>å®šä¹‰åœ¨å‡½æ•°å¤–éƒ¨çš„å°±æ˜¯å…¨å±€å˜é‡ï¼Œå®ƒçš„ä½œç”¨åŸŸä»å®šä¹‰å¤„ä¸€ç›´åˆ°æ–‡ä»¶ç»“å°¾ã€‚</li><li>å‡½æ•°å†…å®šä¹‰çš„å˜é‡å°±æ˜¯å±€éƒ¨å˜é‡ï¼Œå®ƒçš„ä½œç”¨åŸŸä¸ºå‡½æ•°å®šä¹‰èŒƒå›´å†…ã€‚</li><li>å‡½æ•°å†…è®¿é—®å…¨å±€å˜é‡éœ€è¦ global å…³é”®å­—,å¦‚æœä¸ä½¿ç”¨ï¼Œåˆ™ä¼šè¦†ç›–å…¨å±€å˜é‡</li></ol><h2 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h2><p><strong>phpæ•°æ®ç±»å‹</strong></p><p>Stringï¼ˆå­—ç¬¦ä¸²ï¼‰, Integerï¼ˆæ•´å‹ï¼‰, Floatï¼ˆæµ®ç‚¹å‹ï¼‰, Booleanï¼ˆå¸ƒå°”å‹ï¼‰, Arrayï¼ˆæ•°ç»„ï¼‰, Objectï¼ˆå¯¹è±¡ï¼‰, NULLï¼ˆç©ºå€¼ï¼‰ã€‚<br></p><p>è¿™é‡Œç”±äºå’Œ JS ç±»ä¼¼æ‰€ä»¥ä¸å¤šåšè§£é‡Š<br></p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP é¢å‘å¯¹è±¡</title>
      <link href="/2017/01/23/php/oop/"/>
      <url>/2017/01/23/php/oop/</url>
      
        <content type="html"><![CDATA[<p><strong>é¢å‘å¯¹è±¡åŸºç¡€æ¦‚å¿µ</strong><br><br>Object Oriented Programmingï¼Œç®€ç§°OOPï¼Œæ˜¯ä¸€ç§ç¨‹åºè®¾è®¡æ€æƒ³ã€‚OOPæŠŠå¯¹è±¡ä½œä¸ºç¨‹åºçš„åŸºæœ¬å•å…ƒï¼Œä¸€ä¸ªå¯¹è±¡åŒ…å«äº†æ•°æ®å’Œæ“ä½œæ•°æ®çš„å‡½æ•°<br></p><p><strong>å¯¹è±¡çš„ä¸»è¦ä¸‰ä¸ªç‰¹æ€§</strong><br><br>å¯¹è±¡çš„è¡Œä¸ºï¼šå¯ä»¥å¯¹ å¯¹è±¡æ–½åŠ é‚£äº›æ“ä½œï¼Œå¼€ç¯ï¼Œå…³ç¯å°±æ˜¯è¡Œä¸º<br><br>å¯¹è±¡çš„å½¢æ€ï¼šå½“æ–½åŠ é‚£äº›æ–¹æ³•æ˜¯å¯¹è±¡å¦‚ä½•å“åº”ï¼Œé¢œè‰²ï¼Œå°ºå¯¸ï¼Œå¤–å‹<br><br>å¯¹è±¡çš„è¡¨ç¤ºï¼šå¯¹è±¡çš„è¡¨ç¤ºå°±ç›¸å½“äºèº«ä»½è¯ï¼Œå…·ä½“åŒºåˆ†åœ¨ç›¸åŒçš„è¡Œä¸ºä¸çŠ¶æ€ä¸‹æœ‰ä»€ä¹ˆä¸åŒ<br></p><p>æ¯”å¦‚ People(äºº) æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬å¯ä»¥å…·ä½“åˆ°ç”·äººå’Œå¥³äººï¼Œç”·äººå’Œå¥³äººå°±æ˜¯å…·ä½“çš„å¯¹è±¡ï¼Œä»–ä»¬æœ‰åå­—å±æ€§ï¼Œå¯ä»¥å†™ï¼Œå¯ä»¥å­¦ä¹ è¯´è¯ç­‰è¡Œä¸ºçŠ¶æ€ã€‚</p><p><strong>é¢å‘å¯¹è±¡å†…å®¹</strong><br></p><pre><code>ç±» âˆ’ å®šä¹‰äº†ä¸€ä»¶äº‹ç‰©çš„æŠ½è±¡ç‰¹ç‚¹ã€‚ç±»çš„å®šä¹‰åŒ…å«äº†æ•°æ®çš„å½¢å¼ä»¥åŠå¯¹æ•°æ®çš„æ“ä½œå¯¹è±¡ âˆ’ æ˜¯ç±»çš„å®ä¾‹æˆå‘˜å˜é‡ âˆ’ å®šä¹‰åœ¨ç±»å†…éƒ¨çš„å˜é‡ã€‚è¯¥å˜é‡çš„å€¼å¯¹å¤–æ˜¯ä¸å¯è§çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æˆå‘˜å‡½æ•°è®¿é—®ï¼Œåœ¨ç±»è¢«å®ä¾‹åŒ–ä¸ºå¯¹è±¡åï¼Œè¯¥å˜é‡å³å¯ç§°ä¸ºå¯¹è±¡çš„å±æ€§æˆå‘˜å‡½æ•° âˆ’ å®šä¹‰åœ¨ç±»çš„å†…éƒ¨ï¼Œå¯ç”¨äºè®¿é—®å¯¹è±¡çš„æ•°æ®ç»§æ‰¿ âˆ’ ç»§æ‰¿æ€§æ˜¯å­ç±»è‡ªåŠ¨å…±äº«çˆ¶ç±»æ•°æ®ç»“æ„å’Œæ–¹æ³•çš„æœºåˆ¶ï¼Œè¿™æ˜¯ç±»ä¹‹é—´çš„ä¸€ç§å…³ç³»ã€‚åœ¨å®šä¹‰å’Œå®ç°ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç±»çš„åŸºç¡€ä¹‹ä¸Šæ¥è¿›è¡Œï¼ŒæŠŠè¿™ä¸ªå·²ç»å­˜åœ¨çš„ç±»æ‰€å®šä¹‰çš„å†…å®¹ä½œä¸ºè‡ªå·±çš„å†…å®¹ï¼Œå¹¶åŠ å…¥è‹¥å¹²æ–°çš„å†…å®¹çˆ¶ç±» âˆ’ ä¸€ä¸ªç±»è¢«å…¶ä»–ç±»ç»§æ‰¿ï¼Œå¯å°†è¯¥ç±»ç§°ä¸ºçˆ¶ç±»ï¼Œæˆ–åŸºç±»ï¼Œæˆ–è¶…ç±»å­ç±» âˆ’ ä¸€ä¸ªç±»ç»§æ‰¿å…¶ä»–ç±»ç§°ä¸ºå­ç±»ï¼Œä¹Ÿå¯ç§°ä¸ºæ´¾ç”Ÿç±»å¤šæ€ âˆ’ å¤šæ€æ€§æ˜¯æŒ‡ç›¸åŒçš„å‡½æ•°æˆ–æ–¹æ³•å¯ä½œç”¨äºå¤šç§ç±»å‹çš„å¯¹è±¡ä¸Šå¹¶è·å¾—ä¸åŒçš„ç»“æœã€‚ä¸åŒçš„å¯¹è±¡ï¼Œæ”¶åˆ°åŒä¸€æ¶ˆæ¯å¯ä»¥äº§ç”Ÿä¸åŒçš„ç»“æœï¼Œè¿™ç§ç°è±¡ç§°ä¸ºå¤šæ€æ€§é‡è½½ âˆ’ ç®€å•è¯´ï¼Œå°±æ˜¯å‡½æ•°æˆ–è€…æ–¹æ³•æœ‰åŒæ ·çš„åç§°ï¼Œä½†æ˜¯å‚æ•°åˆ—è¡¨ä¸ç›¸åŒçš„æƒ…å½¢ï¼Œè¿™æ ·çš„åŒåä¸åŒå‚æ•°çš„å‡½æ•°æˆ–è€…æ–¹æ³•ä¹‹é—´ï¼Œäº’ç›¸ç§°ä¹‹ä¸ºé‡è½½å‡½æ•°æˆ–è€…æ–¹æ³•æŠ½è±¡æ€§ âˆ’ æŠ½è±¡æ€§æ˜¯æŒ‡å°†å…·æœ‰ä¸€è‡´çš„æ•°æ®ç»“æ„ï¼ˆå±æ€§ï¼‰å’Œè¡Œä¸ºï¼ˆæ“ä½œï¼‰çš„å¯¹è±¡æŠ½è±¡æˆç±»ã€‚ä¸€ä¸ªç±»å°±æ˜¯è¿™æ ·ä¸€ç§æŠ½è±¡ï¼Œå®ƒåæ˜ äº†ä¸åº”ç”¨æœ‰å…³çš„é‡è¦æ€§è´¨ï¼Œè€Œå¿½ç•¥å…¶ä»–ä¸€äº›æ— å…³å†…å®¹ã€‚ä»»ä½•ç±»çš„åˆ’åˆ†éƒ½æ˜¯ä¸»è§‚çš„ï¼Œä½†å¿…é¡»ä¸å…·ä½“çš„åº”ç”¨æœ‰å…³å°è£… âˆ’ å°è£…æ˜¯æŒ‡å°†ç°å®ä¸–ç•Œä¸­å­˜åœ¨çš„æŸä¸ªå®¢ä½“çš„å±æ€§ä¸è¡Œä¸ºç»‘å®šåœ¨ä¸€èµ·ï¼Œå¹¶æ”¾ç½®åœ¨ä¸€ä¸ªé€»è¾‘å•å…ƒå†…æ„é€ å‡½æ•° âˆ’ ä¸»è¦ç”¨æ¥åœ¨åˆ›å»ºå¯¹è±¡æ—¶åˆå§‹åŒ–å¯¹è±¡ï¼Œ å³ä¸ºå¯¹è±¡æˆå‘˜å˜é‡èµ‹åˆå§‹å€¼ï¼Œæ€»ä¸newè¿ç®—ç¬¦ä¸€èµ·ä½¿ç”¨åœ¨åˆ›å»ºå¯¹è±¡çš„è¯­å¥ä¸­ææ„å‡½æ•° âˆ’ ææ„å‡½æ•°(destructor) ä¸æ„é€ å‡½æ•°ç›¸åï¼Œå½“å¯¹è±¡ç»“æŸå…¶ç”Ÿå‘½å‘¨æœŸæ—¶ï¼ˆä¾‹å¦‚å¯¹è±¡æ‰€åœ¨çš„å‡½æ•°å·²è°ƒç”¨å®Œæ¯•ï¼‰ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œææ„å‡½æ•°ã€‚ææ„å‡½æ•°å¾€å¾€ç”¨æ¥åš&quot;æ¸…ç†å–„å&quot; çš„å·¥ä½œï¼ˆä¾‹å¦‚åœ¨å»ºç«‹å¯¹è±¡æ—¶ç”¨newå¼€è¾Ÿäº†ä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œåº”åœ¨é€€å‡ºå‰åœ¨ææ„å‡½æ•°ä¸­ç”¨deleteé‡Šæ”¾ï¼‰</code></pre><h2 id="ä»£ç è§£æä¸Šè¿°æ¦‚å¿µ"><a href="#ä»£ç è§£æä¸Šè¿°æ¦‚å¿µ" class="headerlink" title="ä»£ç è§£æä¸Šè¿°æ¦‚å¿µ"></a>ä»£ç è§£æä¸Šè¿°æ¦‚å¿µ</h2><p><strong>PHPä¸­ç±»çš„å®šä¹‰</strong><br></p><pre><code>  &lt;?php    class People {      // å…¬æœ‰æˆå‘˜å±æ€§      public $name = &#39;zhangsan&#39;;      public $age = 28;      // å…¬æœ‰æˆå‘˜å‡½æ•°æ–¹æ³•      public function sayName () {        //ä¸šåŠ¡é€»è¾‘       }    }  ?&gt;</code></pre><p><strong>PHPä¸­å¯¹è±¡çš„åˆ›å»º</strong><br></p><pre><code>  class People {    // å…¬æœ‰æˆå‘˜å±æ€§    public $name = &#39;zhangsan&#39;;    public $age = 28;    // å…¬æœ‰æˆå‘˜å‡½æ•°æ–¹æ³•ï¼ˆ$thisä»£è¡¨è‡ªèº«çš„å¯¹è±¡);    public function sayName () {      echo $this-&gt;name;    }  }  // é€šè¿‡newæ“ä½œç¬¦åˆ›å»ºå¯¹è±¡  $body = new People();  // æˆå‘˜å¯¹è±¡çš„è°ƒç”¨  $body-&gt;study();</code></pre><p><strong>PHPä¸­æ„é€ å‡½æ•°</strong><br><br>æ„é€ å‡½æ•°æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–¹æ³•ã€‚ä¸»è¦ç”¨æ¥åœ¨åˆ›å»ºå¯¹è±¡æ—¶åˆå§‹åŒ–å¯¹è±¡å’ŒJSä¸­æ„é€ å‡½æ•°ä¸­çš„constructorç›¸ä¼¼<br></p><pre><code>  class People {    // é€šè¿‡æ„é€ æ–¹æ³•ä¸ºæˆå‘˜å˜é‡èµ‹åˆå§‹å€¼    function __construct( $name, $age ) {      $this-&gt;name = $name;      $this-&gt;age = $age;    }    // å…¬æœ‰æˆå‘˜å‡½æ•°æ–¹æ³•ï¼ˆ$thisä»£è¡¨è‡ªèº«çš„å¯¹è±¡);    public function sayName () {      echo(&quot;my name is &amp;nbsp;&quot; .$this-&gt;name.&quot;,&amp;nbspI`m&amp;nbsp;&quot; .$this-&gt;age .&quot;&amp;nbsp;years old&quot;);      echo &#39;&lt;/br&gt;&#39;;    }  }  // é€šè¿‡newæ“ä½œç¬¦åˆ›å»ºzhangsanå¯¹è±¡  $zhangsan = new People(&#39;zhangsan&#39;, 28);  $zhangsan-&gt;sayName();  // é€šè¿‡newæ“ä½œç¬¦åˆ›å»ºlisiå¯¹è±¡  $lisi = new People(&#39;lisi&#39;, 26);  $lisi-&gt;sayName();</code></pre><p><strong>PHPä¸­ææ„å‡½æ•°</strong><br><br>ææ„å‡½æ•° (destructor) ä¸æ„é€ å‡½æ•°ç›¸åï¼Œå½“å¯¹è±¡ç»“æŸå…¶ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œææ„å‡½æ•°ï¼Œå¸¸ç”¨åœºæ™¯ä¾‹å¦‚è¿æ¥æ•°æ®åº“åœ¨<strong>constructä¸­,å¤„ç†å®Œæ•°æ®æ–­å¼€è¿æ¥åœ¨</strong>destructæ–¹æ³•ä¸­<br></p><pre><code>  class People {    // é€šè¿‡æ„é€ æ–¹æ³•ä¸ºæˆå‘˜å˜é‡èµ‹åˆå§‹å€¼    function __construct ($name, $age) {      $this-&gt;name = $name;      $this-&gt;age = $age;    }    // å…¬æœ‰æˆå‘˜å‡½æ•°æ–¹æ³•ï¼ˆ$thisä»£è¡¨è‡ªèº«çš„å¯¹è±¡);    public function sayName () {      echo(&quot;my name is &amp;nbsp;&quot; .$this-&gt;name.&quot;,&amp;nbspI`m&amp;nbsp;&quot; .$this-&gt;age .&quot;&amp;nbsp;years old&quot;);      echo &#39;&lt;/br&gt;&#39;;    }    // ææ„å‡½æ•°ç”¨äºé”€æ¯æŸäº›å˜é‡ã€å¯¹è±¡ï¼Œæ“ä½œç­‰    function __destruct () {      $this-&gt;name = &#39;&#39;;      return true;    }  }  // é€šè¿‡newæ“ä½œç¬¦åˆ›å»ºlisiå¯¹è±¡  $lisi = new People(&#39;lisi&#39;, 26);  var_dump($lisi);  echo &#39;&lt;br/&gt;&#39;;  if ($lisi-&gt;__destruct()) {    echo &#39;é”€æ¯æˆåŠŸ &lt;br/&gt;&#39;;    var_dump($lisi);  }</code></pre><p><strong>PHPä¸­ç»§æ‰¿å®ç°</strong><br><br>PHP ä½¿ç”¨å…³é”®å­— extends æ¥ç»§æ‰¿ä¸€ä¸ªç±»<br></p><pre><code>  // çˆ¶ç±»  class People {    var $name;    var $age;    function __construct ($name, $age) {      $this-&gt;name = $name;      $this-&gt;age = $age;    }    public function sayName () {      echo(&quot;my name is &amp;nbsp;&quot; .$this-&gt;name.&quot;,&amp;nbspI`m&amp;nbsp;&quot; .$this-&gt;age .&quot;&amp;nbsp;years old&quot;);      echo &#39;&lt;/br&gt;&#39;;    }  }  // å­ç±»  class Boy extends People {    function getParentProperty () {      var_dump($this);    }  }  $lisi = new People(&#39;lisi&#39;, 26);  $boy = new Boy(&#39;wangwu&#39;,28);  $boy-&gt;getParentProperty();  // å­ç±»è°ƒç”¨çˆ¶ç±»æ–¹æ³•  $boy-&gt;sayName();</code></pre><p><strong>PHPä¸­æ–¹æ³•é‡å†™</strong></p><pre><code>  class People {    var $name;    var $age;    function __construct ($name, $age) {      $this-&gt;name = $name;      $this-&gt;age = $age;    }    public function sayName () {      echo(&quot;my name is &amp;nbsp;&quot; .$this-&gt;name.&quot;,&amp;nbspI`m&amp;nbsp;&quot; .$this-&gt;age .&quot;&amp;nbsp;years old&quot;);      echo &#39;&lt;/br&gt;&#39;;    }  }  // å­ç±»  class Boy extends People {    // é‡å†™çˆ¶ç±»æ–¹æ³•    public function sayName () {      echo (&quot;my name is &amp;nbsp;&quot; .$this-&gt;name);      return $this-&gt;name;    }  }  $lisi = new People(&#39;lisi&#39;, 26);  $boy = new Boy(&#39;wangwu&#39;,28);  // é‡å†™æ–¹æ³•  $boy-&gt;sayName();</code></pre><p><strong>PHPä¸­è®¿é—®çš„æ§åˆ¶</strong><br><br>PHP å¯¹å±æ€§æˆ–æ–¹æ³•çš„è®¿é—®æ§åˆ¶ï¼Œæ˜¯é€šè¿‡åœ¨å‰é¢æ·»åŠ å…³é”®å­— publicï¼ˆå…¬æœ‰ï¼‰ï¼Œprotectedï¼ˆå—ä¿æŠ¤ï¼‰æˆ– privateï¼ˆç§æœ‰ï¼‰æ¥å®ç°çš„<br></p><p>public &amp; varï¼ˆå…¬æœ‰ï¼‰ï¼šå…¬æœ‰çš„ç±»æˆå‘˜å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¢«è®¿é—®<br></p><p>protectedï¼ˆå—ä¿æŠ¤ï¼‰ï¼šå—ä¿æŠ¤çš„ç±»æˆå‘˜åˆ™å¯ä»¥è¢«å…¶è‡ªèº«ä»¥åŠå…¶å­ç±»å’Œçˆ¶ç±»è®¿é—®<br></p><p>privateï¼ˆç§æœ‰ï¼‰ï¼šç§æœ‰çš„ç±»æˆå‘˜åˆ™åªèƒ½è¢«å…¶å®šä¹‰æ‰€åœ¨çš„ç±»è®¿é—®<br></p><pre><code>  /**   * åŸºç±»   * Define People   */  class People   {    // å£°æ˜ä¸€ä¸ªå…¬æœ‰çš„æ„é€ å‡½æ•°    public function __construct () {}    // å£°æ˜ä¸€ä¸ªå…±æœ‰çš„æ–¹æ³•    public function sayName ()     {      echo &#39;sayname&lt;/br&gt;&#39;;    }    // å£°æ˜ä¸€ä¸ªå—ä¿æŠ¤çš„æ–¹æ³•    protected function swim ()     {      echo &#39;swim&lt;/br&gt;&#39;;    }    // å£°æ˜ä¸€ä¸ªç§æœ‰æ–¹æ³•    private function study ()     {      echo &#39;study&#39;;    }    // ä¸åŠ å…³é”®å­—é»˜è®¤å…¬æœ‰æ–¹æ³•    function getFun () {      $this-&gt;sayName();      $this-&gt;swim();      $this-&gt;study();    }  }  $people = new People();  // æ­£å¸¸è¿è¡Œè¾“å‡ºsayname  $people-&gt;sayName();  // äº§ç”Ÿé”™è¯¯  $people-&gt;swim();  // äº§ç”Ÿé”™è¯¯  $people-&gt;study();  // å…¬æœ‰ï¼Œå—ä¿æŠ¤ï¼Œç§æœ‰éƒ½å¯ä»¥æ‰§è¡Œ  $people-&gt;getFun();   /**   * å­ç±»   * Define Boy   */  class Boy extends People  {    function getFun2 ()    {      $this-&gt;sayName();      $this-&gt;swim();      // è¿™è¡Œä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯      $this-&gt;study();     }  }  $body = new Boy();  // è¿™è¡Œèƒ½è¢«æ­£å¸¸æ‰§è¡Œ  $body -&gt;sayName();  // å…¬æœ‰çš„å’Œå—ä¿æŠ¤çš„éƒ½å¯æ‰§è¡Œï¼Œä½†ç§æœ‰çš„ä¸è¡Œ  $body-&gt;getFun2(); </code></pre><p><strong>PHPä¸­æŠ½è±¡ç±»</strong><br><br>åˆ©ç”¨å…³é”®å­—abstractå£°æ˜æŠ½è±¡</p><p>å¦‚æœç±»ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•è¢«æ˜¯å£°æ˜ä¸ºæŠ½è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»ä¹Ÿå¿…é¡»å£°æ˜ä¸ºæŠ½è±¡<br></p><p>æŠ½è±¡æ–¹æ³•åªå£°æ˜äº†è°ƒç”¨æ–¹å¼ï¼ˆå‚æ•°ï¼‰ï¼Œä¸èƒ½å®šä¹‰å…¶å…·ä½“çš„åŠŸèƒ½å®ç°ï¼ˆç›¸å½“äºæ²¡æœ‰å‡½æ•°ä½“ï¼‰ï¼Œå­ç±»é€šè¿‡ç»§æ‰¿å®ç°æŠ½è±¡æ–¹æ³•ï¼Œä¸”ä¸èƒ½è¢«å®ä¾‹åŒ–<br></p><p>ç»§æ‰¿ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå­ç±»å¿…é¡»å®šä¹‰çˆ¶ç±»ä¸­çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•å¹¶ä¸”å¿…é¡»è¦å’Œçˆ¶ç±»çš„å£°æ˜è®¿é—®çº§åˆ«ä¿æŒä¸€è‡´æˆ–è€…æ›´å®½æ¾<br></p><pre><code>  /**   * å®šä¹‰æŠ½è±¡ç±»People   */  abstract class People   {    abstract protected function eat();    abstract protected function sleep();    abstract protected function study();    public function runing()     {      echo &#39;è·‘å•Šè·‘ï¼&lt;/br&gt;&#39;;    }  }  /**   * å®ç°æŠ½è±¡ç±»   */  class Zhangsan extends People  {    protected function eat()    {      echo &#39;eat &lt;/br&gt;&#39;;      return &#39;eat&#39;;    }    protected function sleep()    {      echo &#39;sleep &lt;/br&gt;&#39;;      return &#39;sleep&#39;;    }    protected function study()    {      echo &#39;study &lt;/br&gt;&#39;;      return &#39;study&#39;;    }    public function getFunc ()     {      $this-&gt;eat();      $this-&gt;sleep();      $this-&gt;study();    }  }  // è°ƒç”¨å­ç±»  $zhangsan = new Zhangsan;  $zhangsan-&gt;runing(); //è·‘å•Šè·‘ï¼  $zhangsan-&gt;getFunc(); // eat sleep study</code></pre><p>åœºæ™¯ï¼šåœ¨å¾ˆå¤šç±»é‡Œé¢å¾ˆå¤šçš„æ–¹æ³•éƒ½æ˜¯åœ¨é‡å¤ã€‚è¿™é‡Œå°±å¯ä»¥å»ç”¨æŠ½è±¡ç±»ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é‡å†™ä¸€ä¸ªç±»ï¼Œæ¯ä¸ªå…¬å…±ç±»å®ä¾‹åŒ–å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œè°ƒç”¨ç›¸åŒçš„æ–¹æ³•ã€‚ä½†æ˜¯abstractå¯ä»¥çœå»å®ä¾‹åŒ–çš„æ­¥éª¤ï¼Œè€Œä¸”å¯ä»¥é‡è½½è¿™ä¸ªæ–¹æ³•,è¿™æ ·ä¸æ˜¯æ›´æ–¹ä¾¿ç®€å•å˜›<br><br><strong>PHPä¸­æ¥å£çš„ä½¿ç”¨</strong><br><br>interfaceä¸»è¦å¯¹ç±»åï¼Œç±»æ‰€æ‹¥æœ‰çš„æ–¹æ³•ï¼Œä»¥åŠæ‰€ä¼ å‚æ•°èµ·çº¦æŸå’Œè§„èŒƒä½œç”¨ï¼Œå’Œabstractç±»ä¼¼ã€‚åœ¨å¤šäººååŒå¼€å‘é¡¹ç›®æ—¶èµ·é‡è¦ä½œç”¨<br></p><pre><code>// å®šä¹‰æ¥å£ç±»interface People  {  public eat () {};}// å®ç°æ¥å£ç±»class Apple implements People{ public function eat () {   echo &#39;æˆ‘åƒçš„è‹¹æœ&#39;; }}$apple = new Apple();$apple-&gt;eat(); </code></pre><p>å‚æ•°çº¦æŸï¼Œå¦‚æœå‚æ•°åå­—ä¸ä¸€æ ·ä¼šæŠ¥é”™<br></p><pre><code>// å®šä¹‰æ¥å£ç±»interface People  {  public function eat($color);}// å®ç°æ¥å£ç±»Appleclass Apple implements People{ public function eat($color) {    echo(&quot;æˆ‘åƒçš„$color ğŸ&lt;br/&gt;&quot;); }}// å®ç°æ¥å£ç±»Grapeclass Grape implements People{  public function eat($color)  {    echo(&quot;æˆ‘åƒçš„$color ğŸ‡&quot;);  }}$apple = new Apple();$apple-&gt;eat(&#39;çº¢&#39;); $grape = new Grape();$grape-&gt;eat(&#39;ç´«&#39;); </code></pre><p>æ¥å£ç»§æ‰¿<br></p><pre><code>  // å®šä¹‰Peopleæ¥å£ç±»  interface People    {      public function eat();    }  // ç»§æ‰¿Peopleæ¥å£ç±»  interface Boy extends People    {      public function drink();    }  // æ¥å£æ–¹æ³•å®ç°  class Behavior implements Boy    {      public function eat()      {          echo &quot;åƒä¸œè¥¿&lt;br&gt;&quot;;      }      public function drink()      {        echo &quot;å–é¥®æ–™&lt;br&gt;&quot;;      }    }           Behavior::eat();        Behavior::drink();</code></pre><p><strong>æ€»ç»“æŠ½è±¡ç±»å’Œæ¥å£</strong><br><br>æŠ½è±¡ç±»å°±æ˜¯ä¸€ä¸ªç±»çš„æœåŠ¡æä¾›å•†ï¼Œæ‹¥æœ‰ä¼—å¤šæœåŠ¡<br></p><p>æ¥å£ç±»å°±æ˜¯ä¸€ä¸ªç±»çš„è§„èŒƒï¼Œå­ç±»å¿…é¡»å®Œæˆå®ƒæŒ‡å®šæ–¹æ³•<br></p><p>å®ƒä»¬çš„åŒºåˆ«ï¼š<br></p><p>æŠ½è±¡ç±»ç»§æ‰¿ç”¨extends,æ¥å£ç»§æ‰¿ç”¨implements<br></p><p>æŠ½è±¡ç±»èƒ½å¤šé‡ç»§æ‰¿,æ¥å£å¤šé‡ç»§æ‰¿ç”¨â€,â€éš”å¼€<br></p><p>æŠ½è±¡ç±»ä¸­çš„æ–¹æ³•ä¸å¿…å…¨éƒ¨é‡è½½,æ¥å£æ–¹æ³•å¿…é¡»å£°æ˜æˆ–è€…é‡è½½<br></p><p>æŠ½è±¡ç±»ä¸å¿…åªåŒ…å«æŠ½è±¡æ–¹æ³•,å¯ä»¥å®šä¹‰å®Œæ•´çš„æ–¹æ³•,æ¥å£ä¸èƒ½åŒ…å«ä»»ä½•å®Œæ•´å®šä¹‰æ–¹æ³•<br></p><p><strong><strong>set,</strong>get,<strong>isset,</strong>unset,<strong>call,</strong>sleep(),__wakeup()ç­‰é­”æœ¯æ–¹æ³•</strong></p><ol><li>__sleep() æ–¹æ³•å¸¸ç”¨äºæäº¤æœªæäº¤çš„æ•°æ®ï¼Œæˆ–ç±»ä¼¼çš„æ¸…ç†æ“ä½œã€‚åŒæ—¶ï¼Œå¦‚æœæœ‰ä¸€äº›å¾ˆå¤§çš„å¯¹è±¡ï¼Œä½†ä¸éœ€è¦å…¨éƒ¨ä¿å­˜ï¼Œè¿™ä¸ªåŠŸèƒ½å°±å¾ˆå¥½ç”¨<br></li></ol><p>__wakeup() ç»å¸¸ç”¨åœ¨ååºåˆ—åŒ–æ“ä½œä¸­ï¼Œä¾‹å¦‚é‡æ–°å»ºç«‹æ•°æ®åº“è¿æ¥ï¼Œæˆ–æ‰§è¡Œå…¶å®ƒåˆå§‹åŒ–æ“ä½œ<br></p><p>å¼•å…¥phpæ‰‹å†Œä¸­çš„ä¾‹å­<br></p><pre><code>  class Connection   {      protected $link;      private $server, $username, $password, $db;      public function __construct($server, $username, $password, $db)      {          $this-&gt;server = $server;          $this-&gt;username = $username;          $this-&gt;password = $password;          $this-&gt;db = $db;          $this-&gt;connect();      }      private function connect()      {          $this-&gt;link = mysql_connect($this-&gt;server, $this-&gt;username, $this-&gt;password);          mysql_select_db($this-&gt;db, $this-&gt;link);      }      public function __sleep()      {          return array(&#39;server&#39;, &#39;username&#39;, &#39;password&#39;, &#39;db&#39;);      }      public function __wakeup()      {          $this-&gt;connect();      }  }</code></pre><ol start="2"><li>å±æ€§é‡è½½<strong>set,</strong>get,<strong>isset,</strong>unset<br><pre><code>public __set ( string $name , mixed $value ) : void // è®¾ç½®ç§æœ‰å±æ€§å€¼çš„æ—¶å€™è°ƒç”¨public __get ( string $name ) : mixed  // è·å–ç§æœ‰å±æ€§å€¼çš„æ—¶å€™è°ƒç”¨public __isset ( string $name ) : bool // å½“åˆ¤æ–­ä¸€ä¸ªç§æœ‰æˆå‘˜å±æ€§æ˜¯å¦è¢«è®¾ç½®è¿‡æ—¶è°ƒç”¨public __unset ( string $name ) : void // å½“é”€æ¯ä¸€ä¸ªç§æœ‰æˆå‘˜å±æ€§çš„æ—¶å€™è°ƒç”¨</code></pre>å½“å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡åï¼Œè°ƒç”¨ç±»ä¸­ä¸å­˜åœ¨æˆ–è€…æ²¡æœ‰æƒé™è®¿é—®çš„å±æ€§çš„æ—¶å€™ï¼Œé»˜è®¤è°ƒç”¨__get()æ–¹æ³•ã€‚å¯ä»¥è®¿é—®å†…éƒ¨å±æ€§<br></li></ol><ol start="3"><li>æ–¹æ³•é‡è½½<strong>callå’Œ</strong>callStatic<br><pre><code>call å’Œ callStatic æ˜¯ç±»ä¼¼çš„æ–¹æ³•ï¼Œå‰è€…æ˜¯è°ƒç”¨ç±»ä¸å­˜åœ¨çš„æ–¹æ³•æ—¶æ‰§è¡Œï¼Œè€Œåè€…æ˜¯è°ƒç”¨ç±»ä¸å­˜åœ¨çš„é™æ€æ–¹å¼æ–¹æ³•æ—¶æ‰§è¡Œã€‚æ­£å¸¸æƒ…å†µä¸‹å¦‚æœè°ƒç”¨ä¸€ä¸ªç±»ä¸å­˜åœ¨çš„æ–¹æ³• PHP ä¼šæŠ›å‡ºè‡´å‘½é”™è¯¯ï¼Œè€Œä½¿ç”¨è¿™ä¸¤ä¸ªé­”æœ¯æ–¹æ³•æˆ‘ä»¬å¯ä»¥æ›¿æ¢ä¸€äº›æ›´å‹å¥½çš„æç¤ºæˆ–è€…è®°å½•é”™è¯¯è°ƒç”¨æ—¥å¿—ä¿¡æ¯ã€å°†ç”¨æˆ·é‡å®šå‘ã€æŠ›å‡ºå¼‚å¸¸ç­‰ç­‰ï¼Œäº¦æˆ–è€…æ˜¯å¦‚åŒset å’Œ get é‚£æ ·åšæ–¹æ³•çš„é‡å‘½åã€‚</code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
