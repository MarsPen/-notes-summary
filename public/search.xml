<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>浏览器中的架构</title>
      <link href="/2021/02/20/browser/architecture/"/>
      <url>/2021/02/20/browser/architecture/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<hr></h3><p>由于市面上浏览器众多并且每个浏览器厂商实现有一定的区别。也是由于本人开发和搜索都是用的 Chrome，所以本文和后续关于浏览器的文章都是以 Chrome 为准。本文主要从几个角度概括的介绍浏览器的架构，更多的细节包括浏览器引擎Blink &amp; V8，渲染引擎等会在后续学习更多知识后整理呈现</p><h3 id="计算机架构"><a href="#计算机架构" class="headerlink" title="计算机架构"></a>计算机架构<hr></h3><p>为了了解浏览器正在运行的环境，我们需要了解一些计算机部件及其功能。</p><blockquote><p><strong>计算机组成</strong></p></blockquote><p>计算机组成分为五大部分控制器，处理器，存储器，输入和输出设备。如下图展示<br><img src="/images/architecture01.jpeg"></p><ol><li><strong>处理单元（Processing Unit，PU）：</strong>包含了算术逻辑单元和处理器寄存器。用于完成各种算术和逻辑运算</li><li><strong>控制器单元（Control Unit，CU）：</strong>包含了指令寄存器和程序计数器。用于控制程序的流程（程序流）</li><li><strong>储存器：</strong>包括用于存储数据和指令的主存储器和容量更大但速度却慢的外部存储器</li><li><strong>输入/输出设备：</strong>键盘、鼠标属于输入设备，显示器是输出设备，网卡即是输入设备又是输出设备</li></ol><blockquote><p><strong>CPU 中央处理器</strong></p></blockquote><img src="/images/architecture02.png"><p>CPU 是计算机系统的运算和控制核心，负责处理各种不同的任务。<strong>CPU 的运作原理可分为四个阶段：提取、解码、执行和写回。CPU 的核心数量也决定了运算处理速度的高低。</strong> 一个 CPU 内核，在上图中被描绘为办公室工作人员，可以一一处理许多不同的任务。它可以处理从数学到美术的所有工作，同时又知道如何回复客户的电话。</p><blockquote><p><strong>GPU 图形处理器</strong></p></blockquote><img src="/images/architecture03.png"><p>GPU 是计算机的另一部分。与 CPU 不同，GPU 擅长处理简单任务，但同时跨多个内核。顾名思义，它最初是为处理图形而开发的。这就是为什么在图形上下文中“使用 GPU ”或“支持 GPU ”与快速渲染和流畅交互相关联的原因。近年来，随着 GPU 的加速计算，仅 GPU 上的计算就变得越来越多。</p><blockquote><p><strong>三层计算机体系结构</strong></p></blockquote><img src="/images/architecture04.png"><p>如上图三层计算机体系结构图中所示。机器硬件在底部，操作系统在中间，应用程序在顶部。当在计算机或手机上启动应用程序时，为应用程序供电的是 CPU 和 GPU。通常应用程序使用操作系统提供的机制在 CPU 和 GPU 上运行。</p><h3 id="进程、线程、协程"><a href="#进程、线程、协程" class="headerlink" title="进程、线程、协程"></a>进程、线程、协程<hr></h3><p>在深入研究浏览器架构之前需要掌握的另一个概念是进程、线程和协程</p><img src="/images/architecture05.png"><ol><li>线程是程序执行的最小单位，而进程是操作系统分配资源的最小单位</li><li>一个进程可以拥有多个线程，一个线程也可以拥有多个协程</li><li>进程之间相互独立，同一进程下的各个线程之间共享程序的内存空间及一些进程级的资源，某进程内的线程在其它进程不可见</li><li>协程，是一种基于线程之上，但又比线程更加轻量级的存在，这种由程序员自己写程序来管理的轻量级线程叫做『用户空间线程』，具有对内核来说不可见的特性</li><li>协程出现的场景是为了解决 I/O 阻塞，且需要大量并发的场景</li></ol><p>当我们启动一个应用程序时，就会创建一个进程。而操作系统为进程提供了一块用于工作的“slab”内存，所有的应用程序状态都保存在这个私有内存空间中。当关闭应用程序时，进程也会消失，操作系统会释放内存。</p><blockquote><p><strong>进程间通信（IPC）</strong></p></blockquote><img src="/images/architecture.svg"><p>进程可以要求操作系统启动另一个进程来运行不同的任务。可以使用 IPC 进行两个进程之间的通讯。上面动画中就展示了使用 IPC 通讯的过程。（<a href="/2019/04/12/node/process">Node 中的进程通讯</a>）</p><p>大多数程序被设计成使用 IPC来进行进程间的通信，好处是不会因为一个工作进程失去响应时，而造成应用程序不能继续工作。</p><h3 id="浏览器架构"><a href="#浏览器架构" class="headerlink" title="浏览器架构"></a>浏览器架构<hr></h3><blockquote><p><strong>浏览器的主要功能</strong></p></blockquote><p>浏览器的主要功能就是向服务器发出请求，在浏览器窗口中展示对应的网络资源。而它的用户界面有很多彼此相同的元素，其中包括：</p><ol><li>用来输入 URI 的地址栏</li><li>前进和后退按钮</li><li>书签设置选项</li><li>用于刷新和停止加载当前文档的刷新和停止按钮</li><li>用于返回主页的主页按钮</li></ol><p>浏览器的用户界面并没有任何正式的规范，HTML5 也没有定义浏览器必须具有的用户界面元素，但列出了一些通用的元素，例如地址栏、状态栏和工具栏等。当然，各浏览器也可以有自己独特的功能。</p><blockquote><p><strong>浏览器的高层结构</strong></p></blockquote><img src="/images/architecture06.png"><p>如上图浏览器的主要组件为：</p><ol><li>用户界面 - 包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面</li><li>浏览器引擎 - 在用户界面和渲染引擎之间传送指令</li><li>渲染引擎 - 负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上。</li><li>网络 - 用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现。</li><li>用户界面后端 - 用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。</li><li>JavaScript 解释器。用于解析和执行 JavaScript 代码。</li><li>数据存储。这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。</li></ol><blockquote><p><strong>Chrome 浏览器架构</strong></p></blockquote><img src="/images/architecture07.png">借助进程和线程，浏览器可以设计成单进程、多线程架构（图左），或者利用 IPC 实现多进程、多线程架构（图右）。<img src="/images/architecture08.png"><p>由于没有关于如何构建浏览器的标准，所以每个浏览器实现的方案细节可能不太一样，通过图中看到 Chrome 浏览器的架构有很多个进程，每个进程各司其职：</p><ol><li>浏览器进程（Browser Process）- 负责管理 Chrome 应用本身，包括地址栏、书签、前进和后退按钮。同时也负责可不见的功能，比如网络请求、文件按访问等，也负责其他进程的调度</li><li>渲染进程（Renderer Process）- 负责站点的渲染，其中也包括 JavaScript 代码的运行，web worker的管理等</li><li>插件进程（Plugin Process）- 控制网站使用的所有插件功能，例如Flash</li><li>GPU进程（GPU Process）- 独立于其他进程处理 GPU 任务。它被分离到不同的进程中，因为 GPU 处理来自多个应用程序的请求，并在同一个屏幕上绘制</li></ol><img src="/images/architecture09.png"><p>上面是几个主要的进程，当然还有更多的进程，例如扩展进程或工具进程。可以点击右上角设置 &gt; 更多工具 &gt; 任务管理器来查看其他进程和进程占用的 CPU 和内存情况。</p><blockquote><p><strong>多进程架构的好处</strong></p></blockquote><p>Chrome 使用多个渲染进程，每个标签页都有自己的渲染进程且独立运行，这样的好处就是当有一个标签页面由于异常造成无响应甚至崩溃时，不会影响其它标签页面。</p><img src="/images/architecture10.png"><p>另一个好处是，借助操作系统对进程安全的控制，浏览器可以将页面放置在沙箱中，站点的代码可以运行在隔离的环境中，保证核心进程的安全。</p><p>虽然多进程的架构优于单进程架构，但由于进程独享自己的私有内存，以渲染进程为例，虽然渲染的站点不同，但工作内容大体相似，为了完成渲染工作它们会在自己的内存中包含相同的功能，例如 V8 引擎（用于解析和运行Javascript），这意味着这部分相同的功能需要占用每个进程的内存空间。为了节省内存，Chrome 限制了最大进程数，最大进程数取决于硬件的能力，同时当使用多个页签访问相同的站点时浏览器不会创建新的渲染进程。</p><blockquote><p>基于站点隔离的渲染进程</p></blockquote><p>Chrome 每个标签是一个渲染进程，它允许跨站点的 iframes 在单个渲染进程中运行，并在不同站点之间共享内存空间。在同一个渲染器进程中运行a.com和b.com似乎没有问题。<br>由于同源策略的影响确保一个网站不能在未经同意的情况下访问其他网站的数据。所以在 Chrome 67 默认启用的站点隔离，为每个跨站点的 iframe 在一个标签页获得一个单独的渲染程序进程并在不同的站点之间共享内存空间。</p><img src="/images/architecture11.png"><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%A4%AE%E5%A4%84%E7%90%86%E5%99%A8" target="_blank" rel="noopener">维基百科关于 CPU 的介绍</a></li><li><a href="https://www.cnblogs.com/Survivalist/p/11527949.html" target="_blank" rel="noopener">一文读懂什么是进程、线程、协程</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 浏览器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 浏览器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浏览器中的 Event Loop</title>
      <link href="/2021/01/25/browser/eventloop/"/>
      <url>/2021/01/25/browser/eventloop/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言 "></a>前言 <hr></h3><p>网上很多文章都在讨论事件循环 (Event Loop)，但是看了很多文章之后还是不知道 Event Loop 到底是什么，解决的问题是什么，规范中是怎么定义的，实际应用中具体的执行过程等等。本文就一点点道来。</p><p>事件循环是一个很重要的概念，指的是计算机系统的一种运行机制。是为了解决 JavaScript 单线程的种种问题，而产生的一种调度。它会根据不同的任务源通过算法运行不同的优先级。</p><p>起初没有事件循环，只是简单的交互就要全部占用主线程去同步处理。比如只是一个提交表单页面就需要等待 10s 甚至更久。不知道什么时候出现了异步机制，而浏览器这种异步机制使用 Event Loop 实现的。</p><p>在提交表单的过程中，JavaScript 事件和触发本质上都通过浏览器中转，所以事件循环的标准也是定义在<a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop" target="_blank" rel="noopener"> HTML 的标准</a> 中，而不是 <a href="https://tc39.es/ecma262/#execution-context-stack%E3%80%82" target="_blank" rel="noopener"> EcmaScript标准</a> 中。那么接下来我们先来看看事件循环的基本定义。</p><h3 id="定义"><a href="#定义" class="headerlink" title="定义 "></a>定义 <hr></h3><p>标准文档中这样写到 </p><blockquote><p>To coordinate events, user interaction, scripts, rendering, networking, and so forth, user agents must use event loops as described in this section. Each agent has an associated event loop, which is unique to that agent.</p></blockquote><p>通过上面定义的描述中我们发现实际上<strong>事件循环是 user agent(浏览器)用于协调事件，用户交互(鼠标、键盘)，脚本（JS），渲染（如HTML、CSS样式），网络等行为的一种机制</strong>。</p><p>与其说是 JavaScript 提供了事件循环，不如说是嵌入 JavaScript 的 user agent（浏览器） 需要通过事件循环来与多种事件源进行交互。</p><h3 id="任务的组成"><a href="#任务的组成" class="headerlink" title="任务的组成 "></a>任务的组成 <hr></h3><p>一个任务就是由诸如从头执行一段程序、执行一个事件回调或一个 interval/timeout 被触发之类的标准机制而被调度的任意 JavaScript 代码。这些都在任务队列（task queue）上被调度。</p><p>而<strong>一个事件循环有一个或多个任务队列（ task queues）</strong>，任务队列是一系列排好序的任务组成，这些任务有：</p><ol><li>Events（事件）<br>在一个特定的 EventTarget 对象上分派一个事件对象通常由一个专门的任务来完成</li><li>Parsing（解析）<br>HTML解析器对一个或多个字节进行标记，然后处理结果标记，这通常是一项任务</li><li>Callbacks（回调）<br>调用回调通常是由一个专门的任务来完成的</li><li>Using a resource（加载资源）<br>当算法获取资源时，如果获取是以非阻塞的方式进行的，那么一旦部分或全部资源可用，则执行任务对资源进行处理</li><li>Reacting to DOM manipulation（响应操作DOM）<br>DOM操作而触发的任务，例如当该元素被插入到文档中时。</li></ol><p>任务也是一个结构体，它有</p><ol><li>Steps：任务要完成工作的一系列步骤</li><li>Source：每个任务都有任务源，用于对相关任务进行分组和序列化</li><li>Document: 与任务相关联的文档，对于不在 window 事件循环中的任务，则为空。</li><li>脚本对象集: <a href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" target="_blank" rel="noopener">环境设置对象</a>，用于在任务期间跟踪脚本评估</li></ol><p>标准中的话术隐晦难懂，但也不难看出在标准中<strong>使用任务源来分离逻辑上不同类型的任务</strong>，比如可以为鼠标、键盘事件提供一个 task 队列，其他事件又是一个单独的队列。这样可以为鼠标、键盘事件分配更多的时间，保证交互的流畅。</p><p>而用户代理（浏览器）也可能希望区分这些任务。使用任务队列来合并给定事件循环中的任务源。</p><h3 id="任务的类型"><a href="#任务的类型" class="headerlink" title="任务的类型"></a>任务的类型<hr></h3><p>任务分为 <strong>task(macrotask) 和  microtask</strong>，下面详细介绍一下这两种任务</p><blockquote><p><strong>Macrotask(宏任务)</strong></p></blockquote><p>主要是浏览器协调各类事件的队列，<strong>虽然叫队列（Queue）本质上是集合(Set)。标准文件中称之为 Task Queue</strong></p><p>因为传统的队列都是先进先出（FIFO）的，而事件循环处理模型的步骤之一是<strong>从选择的队列中抓取第一个可运行的任务，而不是先进先出</strong>。排到最前面但是没有满足条件也不会执行（比如外部队列里只有一个 setTimeout 的定时任务，但是时间还没有到，没有满足条件也不会把他出列来执行）</p><p>不同的 Task 事件源的队列可以有不同的优先级（例如在网络事件和用户交互之间，浏览器可以优先处理鼠标行为，从而让用户感觉更加流程）。</p><blockquote><p><strong>Macrotask 任务源</strong></p></blockquote><p>理解定义之后，我们再来看一下 macrotask 的任务源都有什么，规范<br><a href="https://html.spec.whatwg.org/multipage/webappapis.html#generic-task-sources" target="_blank" rel="noopener">Generic task sources</a> 中定义的 macrotask 任务源有如下</p><ol><li>DOM操作任务源<br>此任务源被用来响应 DOM 操作(页面渲染)，例如一个元素以非阻塞的方式<a href="https://html.spec.whatwg.org/multipage/infrastructure.html#insert-an-element-into-a-document" target="_blank" rel="noopener">插入文档</a></li><li>用户交互任务源<br>此任务源用于对用户交互作出反应，例如键盘或鼠标输入</li><li>网络任务源<br>此任务源被用来响应网络活动，例如Ajax请求。</li><li>history traversal 任务源<br>此任务源用于当调用 history.back()等类似api时，将任务插入 task 队列</li><li>定时器任务源<br>可以使用 setTimeout() 或者 setInterval() 来添加任务</li></ol><blockquote><p><strong>Microtask (微任务)</strong></p></blockquote><p>一个微任务（microtask）就是一个简短的函数，<strong>当函数执行并且只有当 Javascript 调用栈为空，而控制权还没有交还给user agent 之前，该任务才会执行。</strong></p><p><strong>每个事件循环都有一个 microtask 队列，microtask 最初在 microtask 队列中排列而不是在 task 队列。</strong></p><p>有两种 microtask: </p><ul><li>单独回调微任务(solitary callback microtask)</li><li>复合微任务(compound microtask)</li></ul><p>当算法要求 microtask 排列时，它必须被添加到相关事件循环的 microtask 队列;这个 microtask 的任务源是微任务任务源(microtask task source)。</p><p>如果 microtask 的初始执行过程中，microtask 也可能被移动到常规的任务队列，将转动事件循环。这种情况下，微任务任务源将是使用的任务源。通常，microtask 的任务源是不相关的</p><blockquote><p><strong>Microtask 任务源</strong></p></blockquote><p>在 HTML 标准中，并没有明确规定这个队列的事件源，通常认为有以下几种：</p><ol><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener">Promise</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/observe" target="_blank" rel="noopener">Object.observe(已弃用)</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noopener">MutationObserve</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask" target="_blank" rel="noopener">queueMicrotask</a></li></ol><blockquote><p><strong>Macrotask 与 Microtask 的区别</strong></p></blockquote><p>首先，每当一个任务存在，事件循环都会检查该任务是否正把控制权交给其他 JavaScript 代码。如若不然，事件循环就会运行微任务队列中的所有微任务。接下来微任务循环会在事件循环的每次迭代中被处理多次，包括处理完事件和其他回调之后。</p><p>其次，如果一个微任务通过调用  <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask" target="_blank" rel="noopener">queueMicrotask()</a>, 向队列中加入了更多的微任务，则那些新加入的微任务 会早于下一个任务运行 。这是因为事件循环会持续调用微任务直至队列中没有留存的，即使是在有更多微任务持续被加入的情况下。</p><p>上文中提到一个事件循环有一个或多个任务队列（task queues）</p><ul><li>事件循环中的任务都是指定的任务源去提供</li><li>事件循环中只有一个 microtask 队列</li></ul><h3 id="处理模型"><a href="#处理模型" class="headerlink" title="处理模型 "></a>处理模型 <hr></h3><blockquote><p><strong>event loop 的处理过程</strong></p></blockquote><p>一个 event loop 在其存在期间必须持续运行以下步骤：</p><ol><li>在 tasks 队列中选择最老的一个 task，如果没有可选的任务，则跳到下边的 microtasks 步骤</li><li>将事件循环当前执行任务设置为 oldestTask</li><li>设置 taskStartTime 为当前的<a href="https://w3c.github.io/hr-time/#dfn-current-high-resolution-time" target="_blank" rel="noopener">current high resolution time</a></li><li>执行 oldestTask</li><li>将事件循环当前执行任务设置为 null</li><li>Microtasks: 执行 Microtasks 检查点</li><li>hasARenderingOpportunity 标志置为 false</li><li>设置当前的<a href="https://w3c.github.io/hr-time/#dfn-current-high-resolution-time" target="_blank" rel="noopener">current-high-resolution-time</a></li><li>设置最新的 top-level browsing contexts并 <a href="https://w3c.github.io/longtasks/#report-long-tasks" target="_blank" rel="noopener">Report long tasks</a></li><li>更新渲染(如果是一个浏览上下文的事件循环)</li><li>如果是一个 worker 的事件循环，但是事件循环的任务队列中没有任务并且 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WorkerGlobalScope" target="_blank" rel="noopener">WorkerGlobalScope</a> 对象的关闭标识(closing flag)是 true 的话，销毁这个事件循环，中断以上步骤，恢复运行在 Web worker 中描述的 worker 步骤</li><li>返回第一步</li></ol><p><strong>概括说来就是 event loop 会不断循环的去取 tasks 队列的中最老的一个任务推入栈中执行，并在当次循环里依次执行并清空     microtask 队列里的任务。执行完 microtask 队列里的任务，有可能会渲染更新。</strong></p><blockquote><p><strong>microtask checkpoint</strong></p></blockquote><p>当执行 microtask 的检查点时，如果检查点标识为 false， 必须运行以下步骤:</p><ol><li>将检查点 flag 设置为 true</li><li>当事件循环的 microtask 队列不为空时:<br>2.1 将 oldestMicrotask 设置为事件循环的 microtask 队列中最老的 microtask<br>2.2 将事件循环当前执行任务设置为 oldestMicrotask<br>2.3 执行 oldestMicrotask<br>2.4 将事件循环当前执行任务设置为 null<br>2.5 将 oldestMicrotask 从 microtask 队列中移除</li><li>每一个<a href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" target="_blank" rel="noopener">environment settings object</a> 它们的 <a href="https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop" target="_blank" rel="noopener">responsible event loop</a>就是当前的event loop，会给 environment settings object发一个 <a href="https://html.spec.whatwg.org/multipage/webappapis.html#notify-about-rejected-promises" target="_blank" rel="noopener">rejected promises </a>的通知</li><li><a href="https://w3c.github.io/IndexedDB/#cleanup-indexed-database-transactions" target="_blank" rel="noopener">清除索引数据库事务</a></li><li>将检查点标识设置为 false</li></ol><p>当一个组合微任务运行时，UA 必须运行一系列步骤来执行组合微任务的子任务，步骤如下：</p><ol><li>让父任务是事件循环当前执行任务</li><li>让子任务变为由执行一系列给定步骤的新任务。这个 microtask 的任务源是 microtask task source。这是一个组合微任务的子任务</li><li>将事件循环当前执行任务设置为子任务</li><li>执行子任务</li><li>将事件循环当前执行任务设置为父任务</li></ol><p>当并行运行的算法要等待稳定状态时，UA 必须运行以下步骤对 microtask 排列，然后停止执行(如下列步骤所述，当 microtask 执行时算法将恢复运行):</p><ol><li>运行算法的同步部分</li><li>如果可以，按照算法步骤中的描述，恢复并行算法的运行。</li></ol><p>当一个算法要推动事件循环知道符合条件目标时，UA 必须执行以下步骤:</p><ol><li>将事件循环当前任务设置为该任务</li><li>将任务的任务源设置为该任务任务源</li><li>将 JS 执行上下文栈拷贝给旧栈(old stack)</li><li>清空 JS 执行上下文栈</li><li>运行 microtask 检查点</li><li>停止任务，允许任何调用它的算法恢复，但是并行继续这些步骤</li><li>等待符合的条件目标出现</li><li>排列一个任务继续这些步骤，使用任务源的任务源。在新任务运行后继续执行这些步骤。</li><li>用旧栈替换 JS 执行上下文栈</li><li>返回调用者</li></ol><p><strong>概括的来说就是要执行微任务就先执行微任务检查点，什么时候执行检查点则是上下文执行栈为空的时候，也就是在 task 执行之后渲染之前。执行的时候也是持续运行直到微任务任务队列中为空停止</strong></p><h3 id="三种事件循环"><a href="#三种事件循环" class="headerlink" title="三种事件循环"></a>三种事件循环<hr></h3><p>在浏览器中不是只有一种类型的 eventloop，而每种类型的 eventloop 的处理模型也不相同，大致分为下面三种类型</p><blockquote><p><strong>浏览器上下文</strong></p></blockquote><p>每一个用户代理必须至少有一个<a href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context" target="_blank" rel="noopener">浏览器上下文</a> 的event loop，但是每个<a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts" target="_blank" rel="noopener">单元的相似源浏览器上下文</a>至多有一个event loop</p><p>宏任务与微任务，实际上都是被推入栈中执行的，而 JavaScript 是单线程有一个主线程，在主线程中有一个栈，<strong>每一个函数执行的时候都会生成新的 execution context（执行上下文）</strong>，执行上下文会包含一些当前函数的参数、局部变量之类的信息，它会被推入栈中，正在执行的上下文始终处于栈的顶部。当函数执行完后，它的执行上下文会从栈弹出（<em>更多执行上下文相关请移步 <a href="https://www.studyfe.cn/2019/02/25/javascript/closure/#toc-heading-3">上下文执行环境</a></em>）。如下图<br><img src="/images/ec.jpg"></p><p><strong>event loop 总是具有至少一个浏览器上下文，当一个 event loop 的浏览器上下文全都销毁的时候，event loop 也会销毁。一个浏览器上下文总有一个event loop去协调它的活动。</strong></p><blockquote><p><strong>Worker 事件循环</strong></p></blockquote><p>worker 事件循环顾名思义就是驱动 worker 的事件循环。分为以下几种 worker</p><ol><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API" target="_blank" rel="noopener">web worker</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker" target="_blank" rel="noopener">shared worker</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API" target="_blank" rel="noopener">service worker</a><br>worker 被放在一个或多个独立于 “主代码” 的代理中。浏览器可能会用单个或多个事件循环来处理给定类型的所有 workder<br><strong>一个 worker 对应一个event loop，<a href="https://html.spec.whatwg.org/multipage/workers.html#run-a-worker" target="_blank" rel="noopener">worker进程模型</a>管理event loop的生命周期</strong></li></ol><blockquote><p><strong>Worklet 事件循环</strong></p></blockquote><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Worklet" target="_blank" rel="noopener">worklet</a> 事件循环用于驱动运行 worklet 的代理。这包含了 Worklet、AudioWorklet 以及 PaintWorklet</p><p>通过上面三种事件循环我们总结</p><ul><li>浏览器可以有多个 event loop，同一个窗口下的 browsing contexts 可以进行通讯共用 event loop</li><li>browsing contexts 和 workers 是相互独立的，互不影响</li><li>每个线程都有自己的 event loop</li></ul><h3 id="更新渲染"><a href="#更新渲染" class="headerlink" title="更新渲染"></a>更新渲染<hr></h3><blockquote><p><strong>渲染机制</strong></p></blockquote><p>event loop 在执行到第 11 步骤的时候会进行 Update the rendering（更新渲染），规范中允许浏览器自己选择是否更新浏览器。而上文中也提到过不是每轮事件循环都要更新视图，只有在必须要的时候去更新。</p><p><img src="/images/render-process.jpg"></p><p>渲染页面大致的过程如上图</p><ol><li>HTML解析器解析成DOM 树</li><li>CSS解析器解析成CSSOM 树</li><li>结合DOM树和CSSOM树，生成一棵渲染树(Render Tree)</li><li>生成布局（Layout），根据渲染树来布局，以计算每个节点的几何信息</li><li>最后一步是绘制（Paint），使用最终渲染树将像素渲染到在屏幕上</li></ol><p>下面这两篇文章对上面每一个步骤进行了详细的解释</p><ul><li><a href="https://www.studyfe.cn/2019/05/15/javascript/debounce/#toc-heading-3">渲染机制</a></li><li><a href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork" target="_blank" rel="noopener">浏览器的工作原理</a></li></ul><blockquote><p><strong>验证渲染更新时机</strong></p></blockquote><p>上文中提到在渲染更新之前要执行微任务检查点，并将 hasARenderingOpportunity 标志置为 false。 那么下面我们来做一些测试</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// html</span> <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'box'</span><span class="token operator">></span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token comment" spellcheck="true">// js</span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>btn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/eventloop01.jpg"><p>当我们点击这个按钮的时候，一共产生了2个 task 分别是 onclick、setTimeout，用 chrome 开发工具的中的 Performance 查看各部分运行的时间点。<strong>黄色部分是脚本运行，紫色部分是更新 render 树、计算布局，绿色部分是绘制</strong>。其中<strong>绿色和紫色部分就可以认为是 Update the rendering 阶段</strong>。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// html</span> <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'box'</span><span class="token operator">></span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token comment" spellcheck="true">// js</span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>btn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/eventloop03.jpg"><p>当我们点击这个按钮的时候，执行了三个 task 两个 setTimeout、一个click，但是只在 1.8ms 处渲染了一帧为 2，难道是连续的 setTimeout 进行绘制的时候合并了？在看下面的例子</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// html</span> <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'box'</span><span class="token operator">></span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token comment" spellcheck="true">// js</span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>btn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/eventloop04.jpg"><img src="/images/eventloop05.jpg"><p>当我们点击这个按钮的时候，一共绘制了两帧，第一帧1.8ms 处为 2，第二帧9.0ms处为 6。这样是不是就可以认为 event loop 间隔很短会进行绘制。但不是每次任务都进行绘制。</p><p>我们知道浏览器会尽量保持每秒60帧的刷新频率（大约16.7ms每帧），是不是只有两次event loop 间隔大于 16.7ms 才会进行绘制呢？看下面的例子</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// html</span> <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'box'</span><span class="token operator">></span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token comment" spellcheck="true">// js</span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>btn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">16.8</span><span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/eventloop07.jpg"><p>当我们点击这个按钮的时候， 分别渲染了四帧也就是全部执行，那就证明 task 每一次渲染只要连续的高于每秒 60HZ（16.7ms）的频率，都会被渲染。那么接下来我们观察一下 microtasks</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// html</span><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'box'</span><span class="token operator">></span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token comment" spellcheck="true">// js</span><span class="token operator">&lt;</span>script<span class="token operator">></span>  <span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  btn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/eventloop02.jpg"><p>当我们点击这个按钮的时候，产生一个 click task，一个 Promise microtask ，同样绘制实在 microtask 之后，如果连续 microtask 会怎么样呢？</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// html</span><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'box'</span><span class="token operator">></span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token comment" spellcheck="true">// js</span><span class="token operator">&lt;</span>script<span class="token operator">></span>  <span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  btn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/eventloop08.jpg"><p>当我们点击这个按钮的时候，产生 3 个 microtask， 但也只是渲染一次。那么我们交叉运行 setTimeout 和 Promise 呢？</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// html</span><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'box'</span><span class="token operator">></span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token comment" spellcheck="true">// js</span><span class="token operator">&lt;</span>script<span class="token operator">></span>  <span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  btn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">setTimeout1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>       Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> Promise1 <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">1.1</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">setTimeout2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>       Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> Promise2 <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token number">2.1</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16.8</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/eventloop09.jpg"><p>当我们点击这个按钮的时候，共产生两个 setTimeout task，每个 task 中包含一个 Promise microtask，其中一共绘制了两帧分别为1.1 和 2.1，那如果将 setTimeout1 中写入大量的 Promise 会是什么结果呢？</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// html</span><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">'box'</span><span class="token operator">></span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token comment" spellcheck="true">// js</span><span class="token operator">&lt;</span>script<span class="token operator">></span>  <span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  btn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">setTimeout1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"task1"</span><span class="token punctuation">;</span>          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">250000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>              Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> i<span class="token punctuation">;</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">setTimeout2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"task2"</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16.8</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/eventloop10.jpg">当我们点击这个按钮的时候，共产生了两个 setTimeout task,一个 click task。在 setTimeout1 中执行了 250000 个 Promise microtask。从图中可以看出大面积由于脚本运行产生的阻塞，而 setTimeout2 也要等待 setTimeout1 和 promise 执行完成之后在执行。而绘制页面的时候明显看到先绘制 task1 然后是 250000，最后是 task2。<blockquote><p><strong>小结</strong></p></blockquote><p>还有很多 API 包括 queueMicrotask-微任务、MutationObserve-微任务、requestAnimationFrame-宏任务、postMessage-宏任务，在这里就不一一演示了，下面我们来总结一下</p><ol><li>每一轮的 event loop 中多次修改同一个 DOM ，只有最后一次进行绘制</li><li>浏览器在 Update the rendering（更新渲染）阶段会进行优化，并不是每轮 event loop 都会更新渲染。一般情况下大于一帧（16.7ms） 都会更新</li><li>如果想每一轮的 event loop 都进行更新可使用 requestAnimationFrame</li><li>由于 setTimeout 有最小时间 4ms 所以大多数宏任务的优先级都比它高包括 postMessage，而用户交互相关优先级是最高的</li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结<hr></h3><img src="/images/eventloop11.jpg"><p>在主线程中首先会执行同步代码，也就是说会向执行栈中加入所要执行的方法的执行环境（ec），在这个执行环境中还可以调用其他方法，或者自己。这样就会在执行栈中再加入一个执行环境，可一直调用下去，除非超出了内存的最大值发生栈溢出。</p><p>当 JS 引擎遇到一个异步事件后并不会一直等待其返回结果，而是会将这个事件挂起，继续执行执行栈中的其他任务。</p><p>当一个异步事件返回结果后，JS 会将这个事件加入与当前执行栈不同的另一个队列，称之为事件队列。</p><p>被放入事件队列不会立刻执行其回调，而是等待当前执行栈中的所有任务都执行完毕， 主线程处于闲置状态时，主线程会去查找事件队列是否有任务。</p><p>如果有，那么主线程会从中取出最老并且符合条件的事件，在取任务的时候会先处理所有微任务队列中的事件，然后再去宏任务队列中取出一个事件。也就是说同一次事件循环中，微任务永远在宏任务之前执行。</p><p>最后把这个事件对应的回调放入执行栈中，然后执行其中的同步代码。这就是 eventloop 模型的过程</p><h3 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析<hr></h3><pre class="line-numbers language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 执行结果是 start end promise1 promise2 setTimeout</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行过程如下：</p><ol><li>执行同步代码 console.log(‘start’) (输出 start)</li><li>遇到 setTimeout 加入宏任务队列</li><li>遇到两个 Promise 的 then 加入微任务队列</li><li>执行同步代码 console.log(‘end’) (输出 end)</li><li>主线程执行栈为空检查异步任务队列</li><li>优先取所有微任务队列的任务回调并放入栈中全部执行完 (输出 promise1 promise2)</li><li>宏任务队列的任务执行 （输出 setTimeout）</li></ol><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档 "></a>参考文档 <hr></h3><ul><li><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/?utm_source=html5weekly" target="_blank" rel="noopener">Jake 的博客</a></li><li><a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loops" target="_blank" rel="noopener">whatwg HTML 标准</a></li><li><a href="https://w3c.github.io/longtasks/#report-long-tasks" target="_blank" rel="noopener">report-long-tasks</a></li><li><a href="https://tc39.es/ecma262/#sec-execution-contexts" target="_blank" rel="noopener">可执行上下文</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth" target="_blank" rel="noopener">深入微任务与Javascript运行时环境</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide" target="_blank" rel="noopener">在 JavaScript 中通过 queueMicrotask() 使用微任务</a></li><li><a href="https://w3c.github.io/requestidlecallback/#start-an-idle-period-algorithm" target="_blank" rel="noopener">后台任务协同调度 requestidlecallback</a></li><li><a href="https://mp.weixin.qq.com/s/pmduRv-1JKU7tq9vkBTMXg" target="_blank" rel="noopener">从起源到浏览器再到 Node.js</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 浏览器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 浏览器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小程序框架跨端框架</title>
      <link href="/2021/01/14/mini/principle03/"/>
      <url>/2021/01/14/mini/principle03/</url>
      
        <content type="html"><![CDATA[<h3 id="跨端框架"><a href="#跨端框架" class="headerlink" title="跨端框架"></a>跨端框架<hr></h3><p>到2021年前端的跨端项目已经达到一个瓶颈期，从原生的 RN、Weex、Flutter 到小程序生态的各平台跨端框架已经百花齐放。除了Flutter 实现的自渲染以外，其他的都脱离不了 web。而小程序跨端框架虽然很多，但可以从两个纬度来进行分类</p><ul><li>从框架的语法来说<ul><li>Vue 语法</li><li>React 语法</li></ul></li><li>从实现原理来说<ul><li>编译时 compile time 框架约定了一套自己的<a href="https://zhuanlan.zhihu.com/p/107947462" target="_blank" rel="noopener"> DSL</a>，在编译打包过程中，利用 babel 工具通过 AST 进行转译，生成符合小程序规则的代码。</li><li>运行时 runtime，这种框架是在小程序逻辑层中运行 React 和 Vue，然后通过适配层，实现自定义渲染器</li></ul></li></ul><p>实现原理上运行时比编译时更消耗性能，但是编译时不够灵活，需要 case by case 的进行语法转换，需要按照框架规定的语法进行开发。<br>到 2021 年一些跨端框架其实已经放弃了维护，下面列举了一些小程序框架按照 github 上 star 数量从左到右</p><table><thead><tr><th></th><th>uniapp</th><th>Taro</th><th>wepy</th><th>chameloen</th><th>Remax</th><th>megalo</th><th>mpvue</th></tr></thead><tbody><tr><td>语法</td><td>vue</td><td>react/vue</td><td>类vue</td><td>类vue</td><td>react</td><td>vue</td><td>vue</td></tr><tr><td>厂家</td><td>Hbuilder</td><td>京东</td><td>腾讯</td><td>滴滴</td><td>蚂蚁</td><td>网易</td><td>美团</td></tr></tbody></table><h3 id="vue-核心流程"><a href="#vue-核心流程" class="headerlink" title="vue 核心流程"></a>vue 核心流程<hr></h3><p>从实现的语法上可以看出一种是 vue 一种是 react，本文只从 vue 的角度上分析其核心原理。<br>在开发中写的是 vue 代码然后经过打包编译之后就可以在小程序中运行。那这些框架背后做了什么呢？</p><p>其实从根本上都属于 vue 的基本能力，没发生改变（双向绑定、虚拟DOM、diff算法等）。只是在最后更新数据的时候vue 是操作DOM，而跨端框架交给小程序setData。</p><p>在了解跨端框架原理之前，我们先来看看 vue。一个 .vue 单文件由三个部分 <code>template</code>、<code>script</code>、<code>style</code> 构成，如下图</p><img src="/images/mini16.jpg"><p>template 模板部分会在编译打包的过程中，被 vue-loader 调用 compile 方法通过词法分析生成一个 ast 对象，然后调用代码生成器，经过遍历 AST 树递归的拼接字符串操作，最终生成一段 render 函数。而 render 函数会在第一次 mount 时，或者 data 更新的时候才会被执行，执行后，会创建不同类型的 vnode 节点，最后会生成 vnode tree （虚拟 DOM 树）,vue 在拿到 vnode tree 之后就去和上次老的 vnode tree 做 patch diff 找出最小更新策略，patch 之后就会更新真实的视图DOM</p><p>script 中我们会 new Vue，在 vue 初始化的时候会利用 Object.defineproperty 对数据进行劫持做响应式，当数据发生变化的时候，最终会调用上下文 render 函数，生成最新的 vnode tree，接着对比老的 vnode tree 然后进行 patch</p><p>以上是 vue 的核心流程如果想要了解的更多可查看另外几篇文章 </p><ul><li><a href="https://www.studyfe.cn/2019/08/27/vue/vueprinciple/">vue 主线流程</a></li><li><a href="https://www.studyfe.cn/2019/09/05/vue/vueobserve/">vue 响应式</a></li><li><a href="https://www.studyfe.cn/2019/09/19/vue/vuecompile/">vue 编译部分</a></li></ul><h3 id="mpvue-核心流程"><a href="#mpvue-核心流程" class="headerlink" title="mpvue 核心流程"></a>mpvue 核心流程<hr></h3><p>由于小程序不支持 DOM，所以小程序这些跨端框架也不可能操作DOM，那是如何更新小程序的视图呢。<br>我们先来看一下 mpvue 框架，从源码架构、运行时、编译时三个方面说明</p><p><strong>源码架构 🚩</strong><br>通过下图可以看出，mpvue 实际上是将 vue 的源码拿过来在 platforms 跨平台上增加了自己的源码，然后强行改了一波兼容，实现的方案。<br><img src="/images/mini21.png"></p><p><strong>mpvue编译时🚩</strong><br>在编译阶段实际上就是 case by case 的过程</p><ul><li>template 主要是使用了 ast 来解析转化将两侧的语法对齐的过程。</li><li>script 实际上就是将 vue 的 script 移动到小程序的 js 文件中，然后在引入 vue.js，具体如何执行的下面介绍。</li><li>style 大部分可以直接挪到 wxss 中剔除小程序不支持的<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html" target="_blank" rel="noopener">选择器</a>最后做 rpx 转换。<img src="/images/mini20.png"></li></ul><p><strong>mpvue运行时 🚩</strong></p><p>下面的图和 vue 的原理图很类似 vue 的编译、双向绑定、虚拟dom、diff 算法都没有发生改变，只是在 patch 更新 dom 的地方替换成了小程序的 setData。<br><img src="/images/mini22.png"></p><p>因为小程序框架要求页面在页面调用 Page 方法否则就会报错。所以一些 vue 框架的做法实际上是在初始化的时候调用 Page()，这样小程序进行扫描的时候页面就不会出错</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>init <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样在小程序容器中就会出现两个实例，Page 和 Vue。在页面初始化的时候，先实例化一个 Vue，然后在 Vue.init 中调用小程序的 Page()，生成小程序 page 实例，最后在 Vue 的 mounted 中把数据同步到小程序 page 实例上。</p><img src="/images/mini18.png"><p>在 vue 数据发生变化的时候<br>🌟 先进行 vue 的流程</p><ul><li>触发响应式</li><li>执行 render 生成新的 vnode</li><li>diff 新旧 vnode，得到修改数据最优解</li></ul><p>🌟 后进行小程序的流程</p><ul><li>调用 setData 方法修改小程序实例的数据，触发小程序视图层，重新渲染</li></ul><p><strong>小结 🚩</strong></p><ul><li>数据归 vue 管，当数据放生变化后，通过框架的 runtime 进行中间桥接同步到小程序中</li><li>事件及渲染由小程序管，用户在小程序触发各种事件后，先触发小程序的事件函数，然后通过框架的 runtime 运行事件代理，触发 vue 函数</li></ul><h3 id="taro-vue-核心流程"><a href="#taro-vue-核心流程" class="headerlink" title="taro/vue 核心流程"></a>taro/vue 核心流程<hr></h3><p>Taro 是一个开放式跨端跨框架解决方案，支持使用 React/Vue/Nerv 等框架来开发，Taro3.x 版本相对与 1/2 采用了重运行时的架构，下图为它的实现架构<br><img src="/images/mini28.jpg"><br>Taro 代码编译之后分为两个大部分左侧 App Service(逻辑层)、右侧 View 视图层，和其他类 vue 框架一样 数据层是 taro管理，而事件层为小程序管理<br><img src="/images/mini23.jpg"></p><blockquote><p>App Service(逻辑层) 🚩 - 参见源码 <code>taro-runtime &gt; src &gt; dsl &gt; vue.ts</code> </p></blockquote><p>🌟 vue：提供基础能力，这部分就没有好说的了<br>🌟 taro-runtime：核心底层 DOM、BOM 的实现、各平台实现代码、工具类等</p><p>在 runtime 的 DSL vue.ts 中主要有<code>createVueApp</code>、 <code>connectVuePage</code> 方法，源码如下</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">export</span> <span class="token keyword">function</span> createVueApp <span class="token punctuation">(</span>App<span class="token punctuation">:</span> VueInstance<span class="token punctuation">,</span> vue<span class="token punctuation">:</span> V<span class="token punctuation">,</span> config<span class="token punctuation">:</span> AppConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ....</span>    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>Vue <span class="token keyword">as</span> VueConstructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      render <span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>pages<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">const</span> page <span class="token operator">=</span> pages<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span>          elements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">page</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token punctuation">{</span> ref<span class="token punctuation">:</span> <span class="token string">'app'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> elements<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>        mount <span class="token punctuation">(</span>component<span class="token punctuation">:</span> ComponentOptions<span class="token operator">&lt;</span>VueCtor<span class="token operator">></span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> string<span class="token punctuation">,</span> cb<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          pages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token punctuation">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateSync</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        updateSync <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">:</span> VueInstance<span class="token punctuation">,</span> cb<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>$children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">:</span> VueInstance<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> child<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// ...</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> app<span class="token punctuation">:</span> AppInstance <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      mount <span class="token punctuation">(</span>component<span class="token punctuation">:</span> ComponentOptions<span class="token operator">&lt;</span>VueCtor<span class="token operator">></span><span class="token punctuation">,</span> id<span class="token punctuation">:</span> string<span class="token punctuation">,</span> cb<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token function">connectVuePage</span><span class="token punctuation">(</span>Vue<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span>        wrapper<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> id<span class="token punctuation">,</span> cb<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    Current<span class="token punctuation">.</span>app <span class="token operator">=</span> app    <span class="token keyword">return</span> Current<span class="token punctuation">.</span>app  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码主要的流程就是 </p><ul><li>new Vue 创建 vue 实例 wrapper</li><li>render 时，循环 pages，每个 page 实际就是通过 Vue.CreateElement创建的 vnode</li><li>调用 vue 的实例方法 mount 生成 pages</li><li>调用 vue 的实例方法 updateSync 进行 render，最后合并默认配置生成如下 json 结构</li></ul><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  config<span class="token operator">:</span> <span class="token punctuation">{</span>    pages<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"pages/index/index"</span><span class="token punctuation">,</span><span class="token string">"pages/my/index"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    permission<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    subpackages<span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        pages<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        root<span class="token operator">:</span> <span class="token string">""</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        pages<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        root<span class="token operator">:</span> <span class="token string">""</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    tabBar<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    window<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    onHide<span class="token operator">:</span> function (<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    onLaunch<span class="token operator">:</span> function (<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    onShow<span class="token operator">:</span> function (<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>🌟 实现 render 函数 创建 Taro DOM Tree</p><ul><li>DOM/BOM API 主要包含几个方法<ul><li>TaroRootElement</li><li>TaroElement、TaroText</li><li>TaroNode</li><li>TaroEventTarget</li></ul></li></ul><p>下面的 UML 图反映了几个主要的类的结构和关系<br><img src="/images/mini30.jpg"></p><blockquote><p>View（视图层）🚩 - 参见源码 <code>taro-runtime &gt; src &gt; dom &gt; html</code></p></blockquote><p>将小程序的所有组件进行模版化处理从而得到小程序组件对应的模版，如下图：</p><img src="/images/mini32.jpg"><p>然后基于组件的 template，动态 “递归” 渲染整棵树</p><ul><li>先去遍历 Taro DOM Tree 根节点的子元素</li><li>根据每个子元素的类型选择对应的模板来渲染子元素</li><li>在每个模板中又会去遍历当前元素的子元素，以此把整个节点树递归遍历出来。<img src="/images/mini27.jpg"></li></ul><blockquote><p>Taro 事件 🚩 - 参见源码 <code>taro-runtime &gt; src &gt; dom &gt; event.ts</code></p></blockquote><p>Taro Next 事件，具体的实现方式如下：</p><ul><li>在小程序组件的模版化过程中，将所有事件方法全部指定为其平台（ev）函数，如：bindtap、bindchange、bindsubmit 等</li><li>在运行时实现 eventHandler 函数，和 eh 方法绑定，收集所有的小程序事件</li><li>通过 document.getElementById() 方法获取触发事件对应的 TaroNode</li><li>通过 createEvent() 创建符合规范的 TaroEvent</li><li>调用 TaroNode.dispatchEvent 重新触发事件</li></ul><img src="/images/mini24.jpg"><blockquote><p>更新 🚩 - 参见源码 <code>taro-runtime &gt; src &gt; dom &gt; root.ts</code></p></blockquote><p>最终都会调用 Taro DOM 方法，如：appendChild、insertChild 等。</p><p>这些方法在修改 Taro DOM Tree 的同时，还会调用 enqueueUpdate 方法，这个方法能获取到每一个 DOM 方法最终修改的节点路径和值，如：<code>{root.cn.[0].cn.[4].value: &quot;1&quot;}</code>，并通过 setData 方法更新到视图层。</p><img src="/images/mini25.jpg"><blockquote><p>生命周期 🚩 - 参见源码 <code>taro-runtime &gt; src &gt; dsl &gt; instance.ts</code></p></blockquote><p>生命周期的实现是在运行时维护的 App 实例 / Page 实例进行了生命周期方法的一一对应。</p><img src="/images/mini26.jpg"><blockquote><p>路由系统 🚩 - 参见源码 <code>taro-router &gt; src &gt; router.ts</code></p></blockquote><p>taro 的路由系统主要是引用了 <code>universal-router</code> 和 <code>history</code> 两个库，然后读取 config 中的配置，通过 createRouter 方法中 LocationListener 监听路由发生变化的时候， 页面具体的表现是 showPage、hidePage、loadPage还是 unloadPage 等</p><blockquote><p>小结 🚩 </p></blockquote><ul><li>Taro Next 的版本无 DSL 限制，用 React 还是 Vue 技术栈都可以开发</li><li>模版是固定的，然后基于组件的 template，动态 “递归” 渲染整棵 Taro DOM 树</li><li>虽然几乎全运行时框架优点很多，但是由于是运行时框架，所以会有一些性能问题</li></ul><img src="/images/mini33.jpg"><p>从上图可以看到相比于原生引入了 Vue 和 React包，这样无形之中对于小程序的拉包阶段来说就体积增大了.在加上运行时的耗时，Taro DOM Tree 的构建和更新，DOM data 的初始化和更新等一系列的时间成本。首次加载的性能数据跟原生比相对较低。但选择本身选择跨端框架就是一种则中的手段。具体性能可使用 <a href="https://github.com/NervJS/taro-benchmark" target="_blank" rel="noopener">taro-benchmark</a> 和自己的项目进行对比。也可以看看<a href="https://my.oschina.net/o2team/blog/4450465" target="_blank" rel="noopener">京东小程序 Taro 开发对比原生开发测评</a></p>]]></content>
      
      
      <categories>
          
          <category> 小程序 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小程序 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2020/12/20/mini/wcsc/"/>
      <url>/2020/12/20/mini/wcsc/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> BASE_DEVICE_WIDTH <span class="token operator">=</span> <span class="token number">750</span><span class="token punctuation">;</span><span class="token keyword">var</span> isIOS <span class="token operator">=</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">"iPhone"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> deviceWidth <span class="token operator">=</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>width <span class="token operator">||</span> <span class="token number">375</span><span class="token punctuation">;</span><span class="token keyword">var</span> deviceDPR <span class="token operator">=</span> window<span class="token punctuation">.</span>devicePixelRatio <span class="token operator">||</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">var</span> checkDeviceWidth <span class="token operator">=</span> window<span class="token punctuation">.</span>__checkDeviceWidth__ <span class="token operator">||</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> newDeviceWidth <span class="token operator">=</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>width <span class="token operator">||</span> <span class="token number">375</span>    <span class="token keyword">var</span> newDeviceDPR <span class="token operator">=</span> window<span class="token punctuation">.</span>devicePixelRatio <span class="token operator">||</span> <span class="token number">2</span>    <span class="token keyword">var</span> newDeviceHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height <span class="token operator">||</span> <span class="token number">375</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>orientation <span class="token operator">&amp;&amp;</span> <span class="token regex">/^landscape/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>type <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> newDeviceWidth <span class="token operator">=</span> newDeviceHeight    <span class="token keyword">if</span> <span class="token punctuation">(</span>newDeviceWidth <span class="token operator">!==</span> deviceWidth <span class="token operator">||</span> newDeviceDPR <span class="token operator">!==</span> deviceDPR<span class="token punctuation">)</span> <span class="token punctuation">{</span>        deviceWidth <span class="token operator">=</span> newDeviceWidth deviceDPR <span class="token operator">=</span> newDeviceDPR    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">checkDeviceWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">var</span> eps <span class="token operator">=</span> <span class="token number">1e-4</span><span class="token punctuation">;</span><span class="token keyword">var</span> transformRPX <span class="token operator">=</span> window<span class="token punctuation">.</span>__transformRpx__ <span class="token operator">||</span><span class="token keyword">function</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> newDeviceWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    number <span class="token operator">=</span> number <span class="token operator">/</span> BASE_DEVICE_WIDTH <span class="token operator">*</span> <span class="token punctuation">(</span>newDeviceWidth <span class="token operator">||</span> deviceWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>    number <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>number <span class="token operator">+</span> eps<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>deviceDPR <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token operator">!</span>isIOS<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token number">0.5</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> number<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> setCssToHead <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> _xcInvalid<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> Ca <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> css_id<span class="token punctuation">;</span>    <span class="token keyword">var</span> info <span class="token operator">=</span> info <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> _C <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">makeup</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> opt<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> _n <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"number"</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>_n <span class="token operator">&amp;&amp;</span> Ca<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>_n<span class="token punctuation">)</span> Ca<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> ex <span class="token operator">=</span> _n <span class="token operator">?</span> _C<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token punctuation">:</span> file<span class="token punctuation">;</span>        <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> ex<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> content <span class="token operator">=</span> ex<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">var</span> op <span class="token operator">=</span> content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> res <span class="token operator">=</span> <span class="token function">transformRPX</span><span class="token punctuation">(</span>content<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>deviceWidth<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"px"</span> <span class="token operator">+</span> res<span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> res <span class="token operator">=</span> opt<span class="token punctuation">.</span>suffix <span class="token operator">+</span> res<span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> res <span class="token operator">=</span> <span class="token function">makeup</span><span class="token punctuation">(</span>content<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span> <span class="token operator">+</span> res<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> res <span class="token operator">=</span> content <span class="token operator">+</span> res        <span class="token punctuation">}</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> rewritor <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>suffix<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> style<span class="token punctuation">)</span> <span class="token punctuation">{</span>        opt <span class="token operator">=</span> opt <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        suffix <span class="token operator">=</span> suffix <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">;</span>        opt<span class="token punctuation">.</span>suffix <span class="token operator">=</span> suffix<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>allowIllegalSelector <span class="token operator">!=</span> undefined <span class="token operator">&amp;&amp;</span> _xcInvalid <span class="token operator">!=</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>allowIllegalSelector<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"For developer:"</span> <span class="token operator">+</span> _xcInvalid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token punctuation">{</span>                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>_xcInvalid <span class="token operator">+</span> <span class="token string">"This wxss file is ignored."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        Ca <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        css <span class="token operator">=</span> <span class="token function">makeup</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>style<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span>head <span class="token operator">||</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            window<span class="token punctuation">.</span>__rpxRecalculatingFuncs__ <span class="token operator">=</span> window<span class="token punctuation">.</span>__rpxRecalculatingFuncs__ <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            style<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/css'</span><span class="token punctuation">;</span>            style<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"wxss:path"</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>            head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>            window<span class="token punctuation">.</span>__rpxRecalculatingFuncs__<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>                opt<span class="token punctuation">.</span>deviceWidth <span class="token operator">=</span> size<span class="token punctuation">.</span>width<span class="token punctuation">;</span>                <span class="token function">rewritor</span><span class="token punctuation">(</span>suffix<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> style<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>styleSheet<span class="token punctuation">)</span> <span class="token punctuation">{</span>            style<span class="token punctuation">.</span>styleSheet<span class="token punctuation">.</span>cssText <span class="token operator">=</span> css<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> style<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>css<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> style<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nodeValue <span class="token operator">=</span> css<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> rewritor<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">setCssToHead</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setCssToHead</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> <span class="token punctuation">{</span>    path<span class="token punctuation">:</span> <span class="token string">"./app.wxss"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token keyword">var</span> wxssMap <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">'./app.wxss'</span><span class="token punctuation">:</span> <span class="token function">setCssToHead</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> <span class="token string">"./app.wxss"</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> wxssMap<span class="token punctuation">[</span>filePath<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2020/12/20/mini/wcss/"/>
      <url>/2020/12/20/mini/wcss/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/*v0.5vv_20181221_syb_scopedata*/</span> window<span class="token punctuation">.</span>__wcc_version__ <span class="token operator">=</span>  <span class="token string">"v0.5vv_20181221_syb_scopedata"</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span>__wcc_version_info__ <span class="token operator">=</span> <span class="token punctuation">{</span>  customComponents<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  fixZeroRpx<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  propValueDeepCopy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> $gwxc<span class="token punctuation">;</span><span class="token keyword">var</span> $gaic <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>$gwx <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>path<span class="token punctuation">,</span> global<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> global <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> global <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> __WXML_GLOBAL__ <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    __WXML_GLOBAL__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  __WXML_GLOBAL__<span class="token punctuation">.</span>modules <span class="token operator">=</span> __WXML_GLOBAL__<span class="token punctuation">.</span>modules <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">_</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> b <span class="token operator">!=</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> a<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_v</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> k <span class="token operator">!=</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token punctuation">{</span> tag<span class="token punctuation">:</span> <span class="token string">"virtual"</span><span class="token punctuation">,</span> wxKey<span class="token punctuation">:</span> k<span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> tag<span class="token punctuation">:</span> <span class="token string">"virtual"</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_n</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>    $gwxc<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>$gwxc <span class="token operator">>=</span> <span class="token number">16000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token string">"Dom limit exceeded, please check if there's any mistake you've made."</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      tag<span class="token punctuation">:</span> <span class="token string">"wx-"</span> <span class="token operator">+</span> tag<span class="token punctuation">,</span>      attr<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      n<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      raw<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      generics<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_p</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    b <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>properities<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_s</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> env<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">typeof</span> scope<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"undefined"</span> <span class="token operator">?</span> scope<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token punctuation">:</span> env<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_wp</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"WXMLRT_$gwx:"</span> <span class="token operator">+</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_wl</span><span class="token punctuation">(</span>tname<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">_wp</span><span class="token punctuation">(</span>      prefix <span class="token operator">+</span>        "<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span> Template <span class="token template-string"><span class="token string">`" +        tname +        "`</span></span> is being called recursively<span class="token punctuation">,</span> will be stop<span class="token punctuation">.</span>"    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  $gwn <span class="token operator">=</span> console<span class="token punctuation">.</span>warn<span class="token punctuation">;</span>  $gwl <span class="token operator">=</span> console<span class="token punctuation">.</span>log<span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">$gwh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    x<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>      hn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>obj<span class="token punctuation">,</span> all<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">==</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">var</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token keyword">var</span> any1 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            any2 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> x <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>            any1 <span class="token operator">=</span> any1 <span class="token operator">|</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> <span class="token string">"__value__"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            any2 <span class="token operator">=</span> any2 <span class="token operator">|</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> <span class="token string">"__wxspec__"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">return</span> cnt <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span>            any1 <span class="token operator">&amp;&amp;</span>            any2 <span class="token operator">&amp;&amp;</span>            <span class="token punctuation">(</span>all <span class="token operator">||</span> obj<span class="token punctuation">.</span>__wxspec__ <span class="token operator">!==</span> <span class="token string">"m"</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>__value__<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">)</span>            <span class="token operator">?</span> <span class="token string">"h"</span>            <span class="token punctuation">:</span> <span class="token string">"n"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"n"</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      nh<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>obj<span class="token punctuation">,</span> special<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span> __value__<span class="token punctuation">:</span> obj<span class="token punctuation">,</span> __wxspec__<span class="token punctuation">:</span> special <span class="token operator">?</span> special <span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      rv<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"n"</span> <span class="token operator">?</span> obj <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>__value__<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      hm<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">==</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">var</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token keyword">var</span> any1 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            any2 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> x <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>            any1 <span class="token operator">=</span> any1 <span class="token operator">|</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> <span class="token string">"__value__"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            any2 <span class="token operator">=</span> any2 <span class="token operator">|</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> <span class="token string">"__wxspec__"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">return</span> <span class="token punctuation">(</span>            cnt <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span>            any1 <span class="token operator">&amp;&amp;</span>            any2 <span class="token operator">&amp;&amp;</span>            <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>__wxspec__ <span class="token operator">===</span> <span class="token string">"m"</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hm</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>__value__<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  wh <span class="token operator">=</span> <span class="token function">$gwh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">$gstack</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> tmp <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\n "</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tmp<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">")"</span> <span class="token operator">===</span> tmp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>tmp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        tmp<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\s\(.*\)$/</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">else</span> tmp<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"at anonymous function"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> tmp<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n "</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">$gwrt</span><span class="token punctuation">(</span>should_pass_type_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">ArithmeticEv</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> _f <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> rop <span class="token operator">=</span> ops<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> _a<span class="token punctuation">,</span> _b<span class="token punctuation">,</span> _c<span class="token punctuation">,</span> _d<span class="token punctuation">,</span> _aa<span class="token punctuation">,</span> _bb<span class="token punctuation">;</span>      <span class="token keyword">switch</span> <span class="token punctuation">(</span>rop<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> <span class="token string">"?:"</span><span class="token punctuation">:</span>          _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _c <span class="token operator">=</span> should_pass_type_info <span class="token operator">&amp;&amp;</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>          _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span>            <span class="token operator">?</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span>            <span class="token punctuation">:</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _d <span class="token operator">=</span> _c <span class="token operator">&amp;&amp;</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_d<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"n"</span> <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_d<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>          <span class="token keyword">return</span> _d<span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string">"&amp;&amp;"</span><span class="token punctuation">:</span>          _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _c <span class="token operator">=</span> should_pass_type_info <span class="token operator">&amp;&amp;</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>          _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span> <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>          _d <span class="token operator">=</span> _c <span class="token operator">&amp;&amp;</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_d<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"n"</span> <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_d<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>          <span class="token keyword">return</span> _d<span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string">"||"</span><span class="token punctuation">:</span>          _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _c <span class="token operator">=</span> should_pass_type_info <span class="token operator">&amp;&amp;</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>          _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _d <span class="token operator">=</span> _c <span class="token operator">&amp;&amp;</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_d<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"n"</span> <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_d<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>          <span class="token keyword">return</span> _d<span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string">"+"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"*"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"/"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"%"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"|"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"^"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"&amp;"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"==="</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"=="</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"!="</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"!=="</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">">="</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"&lt;="</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">">"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"&lt;"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">"&lt;&lt;"</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> <span class="token string">">>"</span><span class="token punctuation">:</span>          _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _b <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _c <span class="token operator">=</span>            should_pass_type_info <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span> <span class="token operator">||</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">switch</span> <span class="token punctuation">(</span>rop<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token string">"+"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">+</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"*"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">*</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"/"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">/</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"%"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">%</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"|"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">|</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"^"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">^</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"&amp;"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">&amp;</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"==="</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"=="</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">==</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"!="</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">!=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"!=="</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">!==</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">">="</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">>=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"&lt;="</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">">"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">></span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"&lt;"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">&lt;</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"&lt;&lt;"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">">>"</span><span class="token punctuation">:</span>              _d <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">></span><span class="token operator">></span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token punctuation">:</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">return</span> _c <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_d<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string">"-"</span><span class="token punctuation">:</span>          _a <span class="token operator">=</span> ops<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">?</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>          _b <span class="token operator">=</span>            ops<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span>              <span class="token operator">?</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span>              <span class="token punctuation">:</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _c <span class="token operator">=</span>            should_pass_type_info <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span> <span class="token operator">||</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          _d <span class="token operator">=</span> _c <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">-</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token punctuation">:</span> _a <span class="token operator">-</span> _b<span class="token punctuation">;</span>          <span class="token keyword">return</span> _c <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_d<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string">"!"</span><span class="token punctuation">:</span>          _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _c <span class="token operator">=</span> should_pass_type_info <span class="token operator">&amp;&amp;</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"h"</span><span class="token punctuation">;</span>          _d <span class="token operator">=</span> <span class="token operator">!</span>wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> _c <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_d<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string">"~"</span><span class="token punctuation">:</span>          _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>          _c <span class="token operator">=</span> should_pass_type_info <span class="token operator">&amp;&amp;</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"h"</span><span class="token punctuation">;</span>          _d <span class="token operator">=</span> <span class="token operator">~</span>wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> _c <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_d<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>          <span class="token function">$gwn</span><span class="token punctuation">(</span><span class="token string">"unrecognized op"</span> <span class="token operator">+</span> rop<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> newap<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> op <span class="token operator">=</span> ops<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> _f <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newap <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> o<span class="token punctuation">.</span>ap <span class="token operator">=</span> newap<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> op <span class="token operator">===</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> vop <span class="token operator">=</span> op<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> _a<span class="token punctuation">,</span> _aa<span class="token punctuation">,</span> _b<span class="token punctuation">,</span> _bb<span class="token punctuation">,</span> _c<span class="token punctuation">,</span> _d<span class="token punctuation">,</span> _s<span class="token punctuation">,</span> _e<span class="token punctuation">,</span> _ta<span class="token punctuation">,</span> _tb<span class="token punctuation">,</span> _td<span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>vop<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token function">ArithmeticEv</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token keyword">case</span> <span class="token number">5</span><span class="token punctuation">:</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>ops<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>                _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> should_pass_type_info <span class="token operator">?</span> <span class="token punctuation">[</span>_a<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token punctuation">[</span>_a<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>              <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>              <span class="token keyword">default</span><span class="token punctuation">:</span>                _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>                _b <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>                _a<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>should_pass_type_info <span class="token operator">?</span> _b <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> _a<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token keyword">case</span> <span class="token number">6</span><span class="token punctuation">:</span>            _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> ap <span class="token operator">=</span> o<span class="token punctuation">.</span>ap<span class="token punctuation">;</span>            _ta <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>            _aa <span class="token operator">=</span> _ta <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token punctuation">:</span> _a<span class="token punctuation">;</span>            o<span class="token punctuation">.</span>is_affected <span class="token operator">|</span><span class="token operator">=</span> _ta<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>should_pass_type_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>_aa <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> _aa <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> _ta <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>undefined<span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> undefined<span class="token punctuation">;</span>              <span class="token punctuation">}</span>              _b <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>              _tb <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>              _bb <span class="token operator">=</span> _tb <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token punctuation">:</span> _b<span class="token punctuation">;</span>              o<span class="token punctuation">.</span>ap <span class="token operator">=</span> ap<span class="token punctuation">;</span>              o<span class="token punctuation">.</span>is_affected <span class="token operator">|</span><span class="token operator">=</span> _tb<span class="token punctuation">;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>                _bb <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span>                <span class="token keyword">typeof</span> _bb <span class="token operator">===</span> <span class="token string">"undefined"</span> <span class="token operator">||</span>                _bb <span class="token operator">===</span> <span class="token string">"__proto__"</span> <span class="token operator">||</span>                _bb <span class="token operator">===</span> <span class="token string">"prototype"</span> <span class="token operator">||</span>                _bb <span class="token operator">===</span> <span class="token string">"caller"</span>              <span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> _ta <span class="token operator">||</span> _tb <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>undefined<span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> undefined<span class="token punctuation">;</span>              <span class="token punctuation">}</span>              _d <span class="token operator">=</span> _aa<span class="token punctuation">[</span>_bb<span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> _d <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ap<span class="token punctuation">)</span> _d <span class="token operator">=</span> undefined<span class="token punctuation">;</span>              _td <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_d<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>              o<span class="token punctuation">.</span>is_affected <span class="token operator">|</span><span class="token operator">=</span> _td<span class="token punctuation">;</span>              <span class="token keyword">return</span> _ta <span class="token operator">||</span> _tb <span class="token operator">?</span> <span class="token punctuation">(</span>_td <span class="token operator">?</span> _d <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_d<span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>_aa <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> _aa <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> undefined<span class="token punctuation">;</span>              <span class="token punctuation">}</span>              _b <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>              _tb <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>              _bb <span class="token operator">=</span> _tb <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token punctuation">:</span> _b<span class="token punctuation">;</span>              o<span class="token punctuation">.</span>ap <span class="token operator">=</span> ap<span class="token punctuation">;</span>              o<span class="token punctuation">.</span>is_affected <span class="token operator">|</span><span class="token operator">=</span> _tb<span class="token punctuation">;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>                _bb <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span>                <span class="token keyword">typeof</span> _bb <span class="token operator">===</span> <span class="token string">"undefined"</span> <span class="token operator">||</span>                _bb <span class="token operator">===</span> <span class="token string">"__proto__"</span> <span class="token operator">||</span>                _bb <span class="token operator">===</span> <span class="token string">"prototype"</span> <span class="token operator">||</span>                _bb <span class="token operator">===</span> <span class="token string">"caller"</span>              <span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> undefined<span class="token punctuation">;</span>              <span class="token punctuation">}</span>              _d <span class="token operator">=</span> _aa<span class="token punctuation">[</span>_bb<span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> _d <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ap<span class="token punctuation">)</span> _d <span class="token operator">=</span> undefined<span class="token punctuation">;</span>              _td <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_d<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>              o<span class="token punctuation">.</span>is_affected <span class="token operator">|</span><span class="token operator">=</span> _td<span class="token punctuation">;</span>              <span class="token keyword">return</span> _td <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_d<span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>            <span class="token punctuation">}</span>          <span class="token keyword">case</span> <span class="token number">7</span><span class="token punctuation">:</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">case</span> <span class="token number">11</span><span class="token punctuation">:</span>                o<span class="token punctuation">.</span>is_affected <span class="token operator">|</span><span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> g<span class="token punctuation">;</span>              <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>                _s <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                _e <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                _b <span class="token operator">=</span> ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>g <span class="token operator">&amp;&amp;</span> g<span class="token punctuation">.</span>f <span class="token operator">&amp;&amp;</span> g<span class="token punctuation">.</span>f<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  _a <span class="token operator">=</span> g<span class="token punctuation">.</span>f<span class="token punctuation">;</span>                  o<span class="token punctuation">.</span>ap <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                  _a <span class="token operator">=</span>                    _s <span class="token operator">&amp;&amp;</span> _s<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span>                      <span class="token operator">?</span> s                      <span class="token punctuation">:</span> _e <span class="token operator">&amp;&amp;</span> _e<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span>                      <span class="token operator">?</span> e                      <span class="token punctuation">:</span> undefined<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>should_pass_type_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    _ta <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>                    _aa <span class="token operator">=</span> _ta <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token punctuation">:</span> _a<span class="token punctuation">;</span>                    _d <span class="token operator">=</span> _aa<span class="token punctuation">[</span>_b<span class="token punctuation">]</span><span class="token punctuation">;</span>                    _td <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_d<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>                    o<span class="token punctuation">.</span>is_affected <span class="token operator">|</span><span class="token operator">=</span> _ta <span class="token operator">||</span> _td<span class="token punctuation">;</span>                    _d <span class="token operator">=</span> _ta <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>_td <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_d<span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _d<span class="token punctuation">;</span>                    <span class="token keyword">return</span> _d<span class="token punctuation">;</span>                  <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    _ta <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>                    _aa <span class="token operator">=</span> _ta <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token punctuation">:</span> _a<span class="token punctuation">;</span>                    _d <span class="token operator">=</span> _aa<span class="token punctuation">[</span>_b<span class="token punctuation">]</span><span class="token punctuation">;</span>                    _td <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_d<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>                    o<span class="token punctuation">.</span>is_affected <span class="token operator">|</span><span class="token operator">=</span> _ta <span class="token operator">||</span> _td<span class="token punctuation">;</span>                    <span class="token keyword">return</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_d<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token keyword">return</span> undefined<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token keyword">case</span> <span class="token number">8</span><span class="token punctuation">:</span>            _a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>            _a<span class="token punctuation">[</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> _a<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token keyword">case</span> <span class="token number">9</span><span class="token punctuation">:</span>            _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>            _b <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">function</span> <span class="token function">merge</span><span class="token punctuation">(</span>_a<span class="token punctuation">,</span> _b<span class="token punctuation">,</span> _ow<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">var</span> ka<span class="token punctuation">,</span> _bbk<span class="token punctuation">;</span>              _ta <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>              _tb <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>              _aa <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>              _bb <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token keyword">in</span> _bb<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>_ow <span class="token operator">||</span> <span class="token operator">!</span>_aa<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  _aa<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> should_pass_type_info                    <span class="token operator">?</span> _tb                      <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_bb<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">)</span>                      <span class="token punctuation">:</span> _bb<span class="token punctuation">[</span>k<span class="token punctuation">]</span>                    <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_bb<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>              <span class="token punctuation">}</span>              <span class="token keyword">return</span> _a<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">var</span> _c <span class="token operator">=</span> _a<span class="token punctuation">;</span>            <span class="token keyword">var</span> _ow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">&amp;&amp;</span> ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              _a <span class="token operator">=</span> _b<span class="token punctuation">;</span>              _b <span class="token operator">=</span> _c<span class="token punctuation">;</span>              _ow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">&amp;&amp;</span> ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">var</span> _r <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>              <span class="token keyword">return</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token function">merge</span><span class="token punctuation">(</span>_r<span class="token punctuation">,</span> _a<span class="token punctuation">,</span> _ow<span class="token punctuation">)</span><span class="token punctuation">,</span> _b<span class="token punctuation">,</span> _ow<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">merge</span><span class="token punctuation">(</span>_a<span class="token punctuation">,</span> _b<span class="token punctuation">,</span> _ow<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token keyword">case</span> <span class="token number">10</span><span class="token punctuation">:</span>            _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>            _a <span class="token operator">=</span> should_pass_type_info <span class="token operator">?</span> _a <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> _a<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token keyword">case</span> <span class="token number">12</span><span class="token punctuation">:</span>            <span class="token keyword">var</span> _r<span class="token punctuation">;</span>            _a <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>o<span class="token punctuation">.</span>ap<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">return</span> should_pass_type_info <span class="token operator">&amp;&amp;</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span>                <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_r<span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">)</span>                <span class="token punctuation">:</span> _r<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">var</span> ap <span class="token operator">=</span> o<span class="token punctuation">.</span>ap<span class="token punctuation">;</span>            _b <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">;</span>            o<span class="token punctuation">.</span>ap <span class="token operator">=</span> ap<span class="token punctuation">;</span>            _ta <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"h"</span><span class="token punctuation">;</span>            _tb <span class="token operator">=</span> <span class="token function">_ca</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>            _aa <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>            _bb <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>            snap_bb <span class="token operator">=</span> <span class="token function">$gdc</span><span class="token punctuation">(</span>_bb<span class="token punctuation">,</span> <span class="token string">"nv_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>              _r <span class="token operator">=</span>                <span class="token keyword">typeof</span> _aa <span class="token operator">===</span> <span class="token string">"function"</span>                  <span class="token operator">?</span> <span class="token function">$gdc</span><span class="token punctuation">(</span>_aa<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> snap_bb<span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token punctuation">:</span> undefined<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              e<span class="token punctuation">.</span>message <span class="token operator">=</span> e<span class="token punctuation">.</span>message<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/nv_/g</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              e<span class="token punctuation">.</span>stack <span class="token operator">=</span> e<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>                <span class="token number">0</span><span class="token punctuation">,</span>                e<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"at nv_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token punctuation">)</span><span class="token punctuation">;</span>              e<span class="token punctuation">.</span>stack <span class="token operator">=</span> e<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\snv_/g</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              e<span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token function">$gstack</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>debugInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span>stack <span class="token operator">+</span><span class="token operator">=</span>                  <span class="token string">"\n "</span> <span class="token operator">+</span>                  <span class="token string">" "</span> <span class="token operator">+</span>                  <span class="token string">" "</span> <span class="token operator">+</span>                  <span class="token string">" at "</span> <span class="token operator">+</span>                  g<span class="token punctuation">.</span>debugInfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>                  <span class="token string">":"</span> <span class="token operator">+</span>                  g<span class="token punctuation">.</span>debugInfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span>                  <span class="token string">":"</span> <span class="token operator">+</span>                  g<span class="token punctuation">.</span>debugInfo<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>              _r <span class="token operator">=</span> undefined<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> should_pass_type_info <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_tb <span class="token operator">||</span> _ta<span class="token punctuation">)</span> <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>_r<span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _r<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">||</span> op <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">===</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">var</span> _a <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ops<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> xp <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span><span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> _f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            _a <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">typeof</span> xp <span class="token operator">===</span> <span class="token string">"undefined"</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token punctuation">:</span> xp<span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">return</span> _a<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> newap<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"11182016"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        g<span class="token punctuation">.</span>debugInfo <span class="token operator">=</span> ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> newap<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        g<span class="token punctuation">.</span>debugInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">rev</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">,</span> newap<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> wrapper<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  gra <span class="token operator">=</span> <span class="token function">$gwrt</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  grb <span class="token operator">=</span> <span class="token function">$gwrt</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">TestTest</span><span class="token punctuation">(</span>expr<span class="token punctuation">,</span> ops<span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> expect_a<span class="token punctuation">,</span> expect_b<span class="token punctuation">,</span> expect_affected<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">{</span>      <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span> is_affected<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">gra</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">!=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>expect_a<span class="token punctuation">)</span> <span class="token operator">||</span>        o<span class="token punctuation">.</span>is_affected <span class="token operator">!=</span> expect_affected      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token string">"A. "</span> <span class="token operator">+</span>            expr <span class="token operator">+</span>            <span class="token string">" get result "</span> <span class="token operator">+</span>            JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">+</span>            <span class="token string">", "</span> <span class="token operator">+</span>            o<span class="token punctuation">.</span>is_affected <span class="token operator">+</span>            <span class="token string">", but "</span> <span class="token operator">+</span>            JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>expect_a<span class="token punctuation">)</span> <span class="token operator">+</span>            <span class="token string">", "</span> <span class="token operator">+</span>            expect_affected <span class="token operator">+</span>            <span class="token string">" is expected"</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>      <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span> is_affected<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">grb</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> g<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">!=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>expect_b<span class="token punctuation">)</span> <span class="token operator">||</span>        o<span class="token punctuation">.</span>is_affected <span class="token operator">!=</span> expect_affected      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token string">"B. "</span> <span class="token operator">+</span>            expr <span class="token operator">+</span>            <span class="token string">" get result "</span> <span class="token operator">+</span>            JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">+</span>            <span class="token string">", "</span> <span class="token operator">+</span>            o<span class="token punctuation">.</span>is_affected <span class="token operator">+</span>            <span class="token string">", but "</span> <span class="token operator">+</span>            JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>expect_b<span class="token punctuation">)</span> <span class="token operator">+</span>            <span class="token string">", "</span> <span class="token operator">+</span>            expect_affected <span class="token operator">+</span>            <span class="token string">" is expected"</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">wfor</span><span class="token punctuation">(</span>    to_iter<span class="token punctuation">,</span>    func<span class="token punctuation">,</span>    env<span class="token punctuation">,</span>    _s<span class="token punctuation">,</span>    global<span class="token punctuation">,</span>    father<span class="token punctuation">,</span>    itemname<span class="token punctuation">,</span>    indexname<span class="token punctuation">,</span>    keyname  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> _n <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>to_iter<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"n"</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> scope <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>_s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> has_old_item <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>itemname<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> has_old_index <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>indexname<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> old_item <span class="token operator">=</span> scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> old_index <span class="token operator">=</span> scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> full <span class="token operator">=</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>to_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> type <span class="token operator">=</span> full<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"N"</span> <span class="token operator">&amp;&amp;</span> full<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"l"</span><span class="token punctuation">)</span> type <span class="token operator">=</span> <span class="token string">"X"</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> _y<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_n<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"A"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> r_iter_item<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> to_iter<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span> <span class="token operator">=</span> to_iter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token operator">=</span> _n <span class="token operator">?</span> i <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          r_iter_item <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>to_iter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">var</span> key <span class="token operator">=</span>            keyname <span class="token operator">&amp;&amp;</span> r_iter_item              <span class="token operator">?</span> keyname <span class="token operator">===</span> <span class="token string">"*this"</span>                <span class="token operator">?</span> r_iter_item                <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>r_iter_item<span class="token punctuation">[</span>keyname<span class="token punctuation">]</span><span class="token punctuation">)</span>              <span class="token punctuation">:</span> undefined<span class="token punctuation">;</span>          _y <span class="token operator">=</span> <span class="token function">_v</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">_</span><span class="token punctuation">(</span>father<span class="token punctuation">,</span> _y<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">func</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"O"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> r_iter_item<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token keyword">in</span> to_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>          scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span> <span class="token operator">=</span> to_iter<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token operator">=</span> _n <span class="token operator">?</span> k <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          r_iter_item <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>to_iter<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">var</span> key <span class="token operator">=</span>            keyname <span class="token operator">&amp;&amp;</span> r_iter_item              <span class="token operator">?</span> keyname <span class="token operator">===</span> <span class="token string">"*this"</span>                <span class="token operator">?</span> r_iter_item                <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>r_iter_item<span class="token punctuation">[</span>keyname<span class="token punctuation">]</span><span class="token punctuation">)</span>              <span class="token punctuation">:</span> undefined<span class="token punctuation">;</span>          _y <span class="token operator">=</span> <span class="token function">_v</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">_</span><span class="token punctuation">(</span>father<span class="token punctuation">,</span> _y<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">func</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>          i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"S"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> to_iter<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span> <span class="token operator">=</span> to_iter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token operator">=</span> _n <span class="token operator">?</span> i <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          _y <span class="token operator">=</span> <span class="token function">_v</span><span class="token punctuation">(</span>to_iter<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">_</span><span class="token punctuation">(</span>father<span class="token punctuation">,</span> _y<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">func</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"N"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> to_iter<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token operator">=</span> _n <span class="token operator">?</span> i <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          _y <span class="token operator">=</span> <span class="token function">_v</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">_</span><span class="token punctuation">(</span>father<span class="token punctuation">,</span> _y<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">func</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> r_to_iter <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>to_iter<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> r_iter_item<span class="token punctuation">,</span> iter_item<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"A"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r_to_iter<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          iter_item <span class="token operator">=</span> r_to_iter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>          iter_item <span class="token operator">=</span>            wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>iter_item<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"n"</span> <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>iter_item<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> iter_item<span class="token punctuation">;</span>          r_iter_item <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>iter_item<span class="token punctuation">)</span><span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span> <span class="token operator">=</span> iter_item<span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token operator">=</span> _n <span class="token operator">?</span> i <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">var</span> key <span class="token operator">=</span>            keyname <span class="token operator">&amp;&amp;</span> r_iter_item              <span class="token operator">?</span> keyname <span class="token operator">===</span> <span class="token string">"*this"</span>                <span class="token operator">?</span> r_iter_item                <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>r_iter_item<span class="token punctuation">[</span>keyname<span class="token punctuation">]</span><span class="token punctuation">)</span>              <span class="token punctuation">:</span> undefined<span class="token punctuation">;</span>          _y <span class="token operator">=</span> <span class="token function">_v</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">_</span><span class="token punctuation">(</span>father<span class="token punctuation">,</span> _y<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">func</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"O"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token keyword">in</span> r_to_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>          iter_item <span class="token operator">=</span> r_to_iter<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>          iter_item <span class="token operator">=</span>            wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>iter_item<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"n"</span> <span class="token operator">?</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>iter_item<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> iter_item<span class="token punctuation">;</span>          r_iter_item <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>iter_item<span class="token punctuation">)</span><span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span> <span class="token operator">=</span> iter_item<span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token operator">=</span> _n <span class="token operator">?</span> k <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">var</span> key <span class="token operator">=</span>            keyname <span class="token operator">&amp;&amp;</span> r_iter_item              <span class="token operator">?</span> keyname <span class="token operator">===</span> <span class="token string">"*this"</span>                <span class="token operator">?</span> r_iter_item                <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>r_iter_item<span class="token punctuation">[</span>keyname<span class="token punctuation">]</span><span class="token punctuation">)</span>              <span class="token punctuation">:</span> undefined<span class="token punctuation">;</span>          _y <span class="token operator">=</span> <span class="token function">_v</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">_</span><span class="token punctuation">(</span>father<span class="token punctuation">,</span> _y<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">func</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>          i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"S"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r_to_iter<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          iter_item <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>r_to_iter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span> <span class="token operator">=</span> iter_item<span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token operator">=</span> _n <span class="token operator">?</span> i <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          _y <span class="token operator">=</span> <span class="token function">_v</span><span class="token punctuation">(</span>to_iter<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">_</span><span class="token punctuation">(</span>father<span class="token punctuation">,</span> _y<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">func</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"N"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r_to_iter<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          iter_item <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span> <span class="token operator">=</span> iter_item<span class="token punctuation">;</span>          scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token operator">=</span> _n <span class="token operator">?</span> i <span class="token punctuation">:</span> wh<span class="token punctuation">.</span><span class="token function">nh</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          _y <span class="token operator">=</span> <span class="token function">_v</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">_</span><span class="token punctuation">(</span>father<span class="token punctuation">,</span> _y<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">func</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> _y<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>has_old_item<span class="token punctuation">)</span> <span class="token punctuation">{</span>      scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span> <span class="token operator">=</span> old_item<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">delete</span> scope<span class="token punctuation">[</span>itemname<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>has_old_index<span class="token punctuation">)</span> <span class="token punctuation">{</span>      scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token operator">=</span> old_index<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">delete</span> scope<span class="token punctuation">[</span>indexname<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_ca</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>wh<span class="token punctuation">.</span><span class="token function">hn</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"h"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> o <span class="token operator">!==</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_ca</span><span class="token punctuation">(</span>o<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_da</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> attrname<span class="token punctuation">,</span> opindex<span class="token punctuation">,</span> raw<span class="token punctuation">,</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> isaffected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token function">$gdc</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>ap <span class="token operator">&amp;&amp;</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>      attrname <span class="token operator">=</span> <span class="token string">"$wxs:"</span> <span class="token operator">+</span> attrname<span class="token punctuation">;</span>      node<span class="token punctuation">.</span>attr<span class="token punctuation">[</span><span class="token string">"$gdc"</span><span class="token punctuation">]</span> <span class="token operator">=</span> $gdc<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>is_affected <span class="token operator">||</span> <span class="token function">_ca</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      node<span class="token punctuation">.</span>n<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>attrname<span class="token punctuation">)</span><span class="token punctuation">;</span>      node<span class="token punctuation">.</span>raw<span class="token punctuation">[</span>attrname<span class="token punctuation">]</span> <span class="token operator">=</span> raw<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    node<span class="token punctuation">.</span>attr<span class="token punctuation">[</span>attrname<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_r</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> attrname<span class="token punctuation">,</span> opindex<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span> <span class="token punctuation">{</span>    global<span class="token punctuation">.</span>opindex <span class="token operator">=</span> opindex<span class="token punctuation">;</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      _env<span class="token punctuation">;</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">grb</span><span class="token punctuation">(</span>z<span class="token punctuation">[</span>opindex<span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_da</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> attrname<span class="token punctuation">,</span> opindex<span class="token punctuation">,</span> a<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_rz</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> node<span class="token punctuation">,</span> attrname<span class="token punctuation">,</span> opindex<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span> <span class="token punctuation">{</span>    global<span class="token punctuation">.</span>opindex <span class="token operator">=</span> opindex<span class="token punctuation">;</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      _env<span class="token punctuation">;</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">grb</span><span class="token punctuation">(</span>z<span class="token punctuation">[</span>opindex<span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_da</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> attrname<span class="token punctuation">,</span> opindex<span class="token punctuation">,</span> a<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_o</span><span class="token punctuation">(</span>opindex<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span> <span class="token punctuation">{</span>    global<span class="token punctuation">.</span>opindex <span class="token operator">=</span> opindex<span class="token punctuation">;</span>    <span class="token keyword">var</span> nothing <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token function">grb</span><span class="token punctuation">(</span>z<span class="token punctuation">[</span>opindex<span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">,</span> nothing<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> r <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Function <span class="token operator">?</span> undefined <span class="token punctuation">:</span> r<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_oz</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> opindex<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span> <span class="token punctuation">{</span>    global<span class="token punctuation">.</span>opindex <span class="token operator">=</span> opindex<span class="token punctuation">;</span>    <span class="token keyword">var</span> nothing <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token function">grb</span><span class="token punctuation">(</span>z<span class="token punctuation">[</span>opindex<span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">,</span> nothing<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> r <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Function <span class="token operator">?</span> undefined <span class="token punctuation">:</span> r<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_1</span><span class="token punctuation">(</span>opindex<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">,</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> o <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    global<span class="token punctuation">.</span>opindex <span class="token operator">=</span> opindex<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">gra</span><span class="token punctuation">(</span>z<span class="token punctuation">[</span>opindex<span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_1z</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> opindex<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">,</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> o <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    global<span class="token punctuation">.</span>opindex <span class="token operator">=</span> opindex<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">gra</span><span class="token punctuation">(</span>z<span class="token punctuation">[</span>opindex<span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_2</span><span class="token punctuation">(</span>    opindex<span class="token punctuation">,</span>    func<span class="token punctuation">,</span>    env<span class="token punctuation">,</span>    scope<span class="token punctuation">,</span>    global<span class="token punctuation">,</span>    father<span class="token punctuation">,</span>    itemname<span class="token punctuation">,</span>    indexname<span class="token punctuation">,</span>    keyname  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> to_iter <span class="token operator">=</span> <span class="token function">_1</span><span class="token punctuation">(</span>opindex<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">wfor</span><span class="token punctuation">(</span>      to_iter<span class="token punctuation">,</span>      func<span class="token punctuation">,</span>      env<span class="token punctuation">,</span>      scope<span class="token punctuation">,</span>      global<span class="token punctuation">,</span>      father<span class="token punctuation">,</span>      itemname<span class="token punctuation">,</span>      indexname<span class="token punctuation">,</span>      keyname    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_2z</span><span class="token punctuation">(</span>    z<span class="token punctuation">,</span>    opindex<span class="token punctuation">,</span>    func<span class="token punctuation">,</span>    env<span class="token punctuation">,</span>    scope<span class="token punctuation">,</span>    global<span class="token punctuation">,</span>    father<span class="token punctuation">,</span>    itemname<span class="token punctuation">,</span>    indexname<span class="token punctuation">,</span>    keyname  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> to_iter <span class="token operator">=</span> <span class="token function">_1z</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> opindex<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">wfor</span><span class="token punctuation">(</span>      to_iter<span class="token punctuation">,</span>      func<span class="token punctuation">,</span>      env<span class="token punctuation">,</span>      scope<span class="token punctuation">,</span>      global<span class="token punctuation">,</span>      father<span class="token punctuation">,</span>      itemname<span class="token punctuation">,</span>      indexname<span class="token punctuation">,</span>      keyname    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_m</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> generics<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token function">_n</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> attrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">+</span> attrs<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        tmp<span class="token punctuation">.</span>attr<span class="token punctuation">[</span>attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">_r</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> base <span class="token operator">+</span> attrs<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> base <span class="token operator">=</span> attrs<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> generics<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">+</span> generics<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        tmp<span class="token punctuation">.</span>generics<span class="token punctuation">[</span>generics<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> $t <span class="token operator">=</span> <span class="token function">grb</span><span class="token punctuation">(</span>z<span class="token punctuation">[</span>base <span class="token operator">+</span> generics<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>$t <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> $t <span class="token operator">=</span> <span class="token string">"wx-"</span> <span class="token operator">+</span> $t<span class="token punctuation">;</span>        tmp<span class="token punctuation">.</span>generics<span class="token punctuation">[</span>generics<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> $t<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> base <span class="token operator">=</span> generics<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_mz</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> generics<span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token function">_n</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> attrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">+</span> attrs<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        tmp<span class="token punctuation">.</span>attr<span class="token punctuation">[</span>attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">_rz</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> base <span class="token operator">+</span> attrs<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> base <span class="token operator">=</span> attrs<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> generics<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">+</span> generics<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        tmp<span class="token punctuation">.</span>generics<span class="token punctuation">[</span>generics<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> $t <span class="token operator">=</span> <span class="token function">grb</span><span class="token punctuation">(</span>z<span class="token punctuation">[</span>base <span class="token operator">+</span> generics<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>$t <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> $t <span class="token operator">=</span> <span class="token string">"wx-"</span> <span class="token operator">+</span> $t<span class="token punctuation">;</span>        tmp<span class="token punctuation">.</span>generics<span class="token punctuation">[</span>generics<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> $t<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> base <span class="token operator">=</span> generics<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> nf_init <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>      <span class="token keyword">typeof</span> __WXML_GLOBAL__ <span class="token operator">===</span> <span class="token string">"undefined"</span> <span class="token operator">||</span>      undefined <span class="token operator">===</span> __WXML_GLOBAL__<span class="token punctuation">.</span>wxs_nf_init    <span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">nf_init_Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">nf_init_Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">nf_init_Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">nf_init_String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">nf_init_Boolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">nf_init_Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">nf_init_Math</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">nf_init_Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">nf_init_RegExp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> __WXML_GLOBAL__ <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span>      __WXML_GLOBAL__<span class="token punctuation">.</span>wxs_nf_init <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nf_init_Object <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_constructor"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token string">"Object"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"[object Object]"</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nf_init_Function <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_constructor"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token string">"Function"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_length"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"[function Function]"</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nf_init_Array <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">nv_join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_join"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>        s <span class="token operator">=</span> undefined <span class="token operator">==</span> s <span class="token operator">?</span> <span class="token string">","</span> <span class="token punctuation">:</span> s<span class="token punctuation">;</span>        <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span> r <span class="token operator">+</span><span class="token operator">=</span> s<span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> undefined <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> r <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"function"</span><span class="token punctuation">)</span> r <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">nv_toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>            <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"object"</span> <span class="token operator">&amp;&amp;</span>            <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>nv_constructor <span class="token operator">===</span> <span class="token string">"Array"</span>          <span class="token punctuation">)</span>            r <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">nv_join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">else</span> r <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> r<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_constructor"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token string">"Array"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_concat"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>concat<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_pop"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_push"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>push<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_reverse"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>reverse<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_shift"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>shift<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_slice"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_sort"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sort<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_splice"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>splice<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_unshift"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>unshift<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_indexOf"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>indexOf<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_lastIndexOf"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>lastIndexOf<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_every"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>every<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_some"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>some<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_forEach"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>forEach<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_map"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>map<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_filter"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>filter<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_reduce"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>reduce<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_reduceRight"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>reduceRight<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_length"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> value<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nf_init_String <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_constructor"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token string">"String"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_valueOf"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_charAt"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>charAt<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_charCodeAt"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>charCodeAt<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_concat"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>concat<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_indexOf"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>indexOf<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_lastIndexOf"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>lastIndexOf<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_localeCompare"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>localeCompare<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_match"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>match<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_replace"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>replace<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_search"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>search<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_slice"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_split"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>split<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_substring"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>substring<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toLowerCase"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toLowerCase<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toLocaleLowerCase"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toLocaleLowerCase<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toUpperCase"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toUpperCase<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toLocaleUpperCase"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toLocaleUpperCase<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_trim"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> String<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>trim<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_length"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> value<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nf_init_Boolean <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_constructor"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token string">"Boolean"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Boolean<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_valueOf"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Boolean<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nf_init_Number <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">,</span> <span class="token string">"nv_MAX_VALUE"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">,</span> <span class="token string">"nv_MIN_VALUE"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">,</span> <span class="token string">"nv_NEGATIVE_INFINITY"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>NEGATIVE_INFINITY<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">,</span> <span class="token string">"nv_POSITIVE_INFINITY"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>POSITIVE_INFINITY<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_constructor"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token string">"Number"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toLocaleString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_valueOf"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toFixed"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toFixed<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toExponential"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toExponential<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toPrecision"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Number<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toPrecision<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nf_init_Math <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_E"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>E <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_LN10"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>LN10<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_LN2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>LN2 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_LOG2E"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>LOG2E<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_LOG10E"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>LOG10E<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_PI"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>PI <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_SQRT1_2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>SQRT1_2<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_SQRT2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>SQRT2<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_abs"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>abs <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_acos"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>acos<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_asin"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>asin<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_atan"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>atan<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_atan2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>atan2<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_ceil"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>ceil<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_cos"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>cos <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_exp"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>exp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_floor"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>floor<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_log"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>log <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_max"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>max <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_min"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>min <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_pow"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>pow <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_random"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>random<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_round"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>round<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_sin"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>sin <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_sqrt"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>sqrt<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token string">"nv_tan"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Math<span class="token punctuation">.</span>tan <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nf_init_Date <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_constructor"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token string">"Date"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">,</span> <span class="token string">"nv_parse"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>parse<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">,</span> <span class="token string">"nv_UTC"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>UTC <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">,</span> <span class="token string">"nv_now"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>now <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toDateString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toDateString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toTimeString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toTimeString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toLocaleString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toLocaleString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toLocaleDateString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toLocaleDateString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toLocaleTimeString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toLocaleTimeString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_valueOf"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getTime"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getTime<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getFullYear"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getFullYear<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getUTCFullYear"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getUTCFullYear<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getMonth"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getMonth<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getUTCMonth"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getUTCMonth<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getDate"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getDate<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getUTCDate"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getUTCDate<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getDay"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getDay<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getUTCDay"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getUTCDay<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getHours"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getHours<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getUTCHours"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getUTCHours<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getMinutes"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getMinutes<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getUTCMinutes"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getUTCMinutes<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getSeconds"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getSeconds<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getUTCSeconds"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getUTCSeconds<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getMilliseconds"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getMilliseconds<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getUTCMilliseconds"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getUTCMilliseconds<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_getTimezoneOffset"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getTimezoneOffset<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setTime"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setTime<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setMilliseconds"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setMilliseconds<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setUTCMilliseconds"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setUTCMilliseconds<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setSeconds"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setSeconds<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setUTCSeconds"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setUTCSeconds<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setMinutes"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setMinutes<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setUTCMinutes"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setUTCMinutes<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setHours"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setHours<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setUTCHours"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setUTCHours<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setDate"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setDate<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setUTCDate"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setUTCDate<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setMonth"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setMonth<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setUTCMonth"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setUTCMonth<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setFullYear"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setFullYear<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_setUTCFullYear"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setUTCFullYear<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toUTCString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toUTCString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toISOString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toISOString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toJSON"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> Date<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toJSON<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nf_init_RegExp <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_constructor"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> <span class="token string">"RegExp"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_exec"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>exec<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_test"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>test<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_toString"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      value<span class="token punctuation">:</span> RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_source"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_global"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>global<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_ignoreCase"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ignoreCase<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_multiline"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>multiline<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">"nv_lastIndex"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastIndex<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> v<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token function">nf_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nv_getDate <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>Date<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>bind<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>Date<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nv_getRegExp <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>bind<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nv_console <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  nv_console<span class="token punctuation">.</span>nv_log <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token string">"WXSRT:"</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> res <span class="token operator">+</span><span class="token operator">=</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> nv_parseInt <span class="token operator">=</span> parseInt<span class="token punctuation">,</span>    nv_parseFloat <span class="token operator">=</span> parseFloat<span class="token punctuation">,</span>    nv_isNaN <span class="token operator">=</span> isNaN<span class="token punctuation">,</span>    nv_isFinite <span class="token operator">=</span> isFinite<span class="token punctuation">,</span>    nv_decodeURI <span class="token operator">=</span> decodeURI<span class="token punctuation">,</span>    nv_decodeURIComponent <span class="token operator">=</span> decodeURIComponent<span class="token punctuation">,</span>    nv_encodeURI <span class="token operator">=</span> encodeURI<span class="token punctuation">,</span>    nv_encodeURIComponent <span class="token operator">=</span> encodeURIComponent<span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">$gdc</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> p<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>    o <span class="token operator">=</span> wh<span class="token punctuation">.</span><span class="token function">rv</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> o <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token keyword">return</span> o<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>      o<span class="token punctuation">.</span>constructor <span class="token operator">===</span> String <span class="token operator">||</span>      o<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Boolean <span class="token operator">||</span>      o<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Number    <span class="token punctuation">)</span>      <span class="token keyword">return</span> o<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> copy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token keyword">in</span> o<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>undefined <span class="token operator">===</span> p<span class="token punctuation">)</span> copy<span class="token punctuation">[</span>k<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">$gdc</span><span class="token punctuation">(</span>o<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">else</span> copy<span class="token punctuation">[</span>p <span class="token operator">+</span> k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">$gdc</span><span class="token punctuation">(</span>o<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> copy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Array<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> copy <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> o<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> copy<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">$gdc</span><span class="token punctuation">(</span>o<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> copy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Date<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> copy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      copy<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> copy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>constructor <span class="token operator">===</span> RegExp<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>global<span class="token punctuation">)</span> f <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">"g"</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>ignoreCase<span class="token punctuation">)</span> f <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">"i"</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>multiline<span class="token punctuation">)</span> f <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">"m"</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>source<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&amp;&amp;</span> o<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">$gdc</span><span class="token punctuation">(</span><span class="token function">o</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> o<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> nv_JSON <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  nv_JSON<span class="token punctuation">.</span>nv_stringify <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>    JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">$gdc</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  nv_JSON<span class="token punctuation">.</span>nv_parse <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token keyword">return</span> undefined<span class="token punctuation">;</span>    <span class="token keyword">var</span> t <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">$gdc</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"nv_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">_af</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> a<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>    p<span class="token punctuation">.</span>extraAttr <span class="token operator">=</span> <span class="token punctuation">{</span> t_action<span class="token punctuation">:</span> a<span class="token punctuation">,</span> t_cid<span class="token punctuation">:</span> c <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_gv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> window<span class="token punctuation">.</span>__webview_engine_version__<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_ai</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> p<span class="token punctuation">,</span> e<span class="token punctuation">,</span> me<span class="token punctuation">,</span> r<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">_grp</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> e<span class="token punctuation">,</span> me<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> i<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">{</span>      i<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">_wp</span><span class="token punctuation">(</span>        me <span class="token operator">+</span>          <span class="token string">":import:"</span> <span class="token operator">+</span>          r <span class="token operator">+</span>          <span class="token string">":"</span> <span class="token operator">+</span>          c <span class="token operator">+</span>          "<span class="token punctuation">:</span> Path <span class="token template-string"><span class="token string">`" +          p +          "`</span></span> not found <span class="token keyword">from</span> <span class="token template-string"><span class="token string">`" +          me +          "`</span></span><span class="token punctuation">.</span>"      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_grp</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> e<span class="token punctuation">,</span> me<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> mepart <span class="token operator">=</span> me<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      mepart<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> ppart <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ppart<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ppart<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">".."</span><span class="token punctuation">)</span> mepart<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ppart<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> ppart<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> mepart<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ppart<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      p <span class="token operator">=</span> mepart<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>me<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"."</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"/"</span><span class="token punctuation">)</span> p <span class="token operator">=</span> <span class="token string">"."</span> <span class="token operator">+</span> p<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> p<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">[</span>p <span class="token operator">+</span> <span class="token string">".wxml"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> p <span class="token operator">+</span> <span class="token string">".wxml"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_gd</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> c<span class="token punctuation">,</span> e<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>c<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> d<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> x <span class="token operator">=</span> e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>i<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> x <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> x<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>i<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> d<span class="token punctuation">[</span>e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>i<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> d<span class="token punctuation">[</span>e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>i<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> x <span class="token operator">=</span> e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>ti<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> x <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> x<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> q <span class="token operator">=</span> <span class="token function">_grp</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>ti<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">&amp;&amp;</span> d<span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> d<span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token function">_gapi</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> ii<span class="token punctuation">.</span>length<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ii<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> d<span class="token punctuation">[</span>ii<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> d<span class="token punctuation">[</span>ii<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token operator">=</span> e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>j<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">--</span><span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>j<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> q <span class="token operator">=</span> e<span class="token punctuation">[</span>e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>j<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ti<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> q <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> q<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">var</span> pp <span class="token operator">=</span> <span class="token function">_grp</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>e<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>j<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ti<span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token operator">&amp;&amp;</span> d<span class="token punctuation">[</span>pp<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> d<span class="token punctuation">[</span>pp<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_gapi</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>$gaic<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> $gaic<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      q <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>      t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>      put <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      visited <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    q<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    visited<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    t<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>h <span class="token operator">&lt;</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> a <span class="token operator">=</span> q<span class="token punctuation">[</span>h<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> e<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span>ic<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> nd <span class="token operator">=</span> e<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span>ic<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> np <span class="token operator">=</span> <span class="token function">_grp</span><span class="token punctuation">(</span>nd<span class="token punctuation">,</span> e<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>np <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>visited<span class="token punctuation">[</span>np<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          visited<span class="token punctuation">[</span>np<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>          q<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>          t<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a <span class="token operator">!=</span> p <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> e<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span>ti<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> ni <span class="token operator">=</span> e<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span>ti<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> nm <span class="token operator">=</span> <span class="token function">_grp</span><span class="token punctuation">(</span>ni<span class="token punctuation">,</span> e<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nm <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>put<span class="token punctuation">[</span>nm<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          put<span class="token punctuation">[</span>nm<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>          ret<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>nm<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    $gaic<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">;</span>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> $ixc <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">_ic</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> ent<span class="token punctuation">,</span> me<span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> r<span class="token punctuation">,</span> gg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">_grp</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> ent<span class="token punctuation">,</span> me<span class="token punctuation">)</span><span class="token punctuation">;</span>    ent<span class="token punctuation">[</span>me<span class="token punctuation">]</span><span class="token punctuation">.</span>j<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>$ixc<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">_wp</span><span class="token punctuation">(</span>          "<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>include<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`" +            p +            "`</span></span> is being included <span class="token keyword">in</span> a loop<span class="token punctuation">,</span> will be stop<span class="token punctuation">.</span>"        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      $ixc<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        ent<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> r<span class="token punctuation">,</span> gg<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      $ixc<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">_wp</span><span class="token punctuation">(</span>        me <span class="token operator">+</span>          "<span class="token punctuation">:</span>include<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span> Included path <span class="token template-string"><span class="token string">`" +          p +          "`</span></span> not found <span class="token keyword">from</span> <span class="token template-string"><span class="token string">`" +          me +          "`</span></span><span class="token punctuation">.</span>"      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_w</span><span class="token punctuation">(</span>tn<span class="token punctuation">,</span> f<span class="token punctuation">,</span> line<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">_wp</span><span class="token punctuation">(</span>      f <span class="token operator">+</span> <span class="token string">":template:"</span> <span class="token operator">+</span> line <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> c <span class="token operator">+</span> "<span class="token punctuation">:</span> Template <span class="token template-string"><span class="token string">`" + tn + "`</span></span> not found<span class="token punctuation">.</span>"    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_ev</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">delete</span> dom<span class="token punctuation">.</span>properities<span class="token punctuation">;</span>    <span class="token keyword">delete</span> dom<span class="token punctuation">.</span>n<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">do</span> <span class="token punctuation">{</span>        changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> newch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dom<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">var</span> ch <span class="token operator">=</span> dom<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>ch<span class="token punctuation">.</span>tag <span class="token operator">==</span> <span class="token string">"virtual"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ch<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;</span> ch<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              newch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            newch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        dom<span class="token punctuation">.</span>children <span class="token operator">=</span> newch<span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dom<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">_ev</span><span class="token punctuation">(</span>dom<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> dom<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">_tsd</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>tag <span class="token operator">==</span> <span class="token string">"wx-wx-scope"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      root<span class="token punctuation">.</span>tag <span class="token operator">=</span> <span class="token string">"virtual"</span><span class="token punctuation">;</span>      root<span class="token punctuation">.</span>wxCkey <span class="token operator">=</span> <span class="token string">"11"</span><span class="token punctuation">;</span>      root<span class="token punctuation">[</span><span class="token string">"wxScopeData"</span><span class="token punctuation">]</span> <span class="token operator">=</span> root<span class="token punctuation">.</span>attr<span class="token punctuation">[</span><span class="token string">"wx:scope-data"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">delete</span> root<span class="token punctuation">.</span>n<span class="token punctuation">;</span>      <span class="token keyword">delete</span> root<span class="token punctuation">.</span>raw<span class="token punctuation">;</span>      <span class="token keyword">delete</span> root<span class="token punctuation">.</span>generics<span class="token punctuation">;</span>      <span class="token keyword">delete</span> root<span class="token punctuation">.</span>attr<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> root<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> root<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">_tsd</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> root<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> e_ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> global<span class="token punctuation">.</span>entrys <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> global<span class="token punctuation">.</span>entrys <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  e_ <span class="token operator">=</span> global<span class="token punctuation">.</span>entrys<span class="token punctuation">;</span>  <span class="token keyword">var</span> d_ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> global<span class="token punctuation">.</span>defines <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> global<span class="token punctuation">.</span>defines <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  d_ <span class="token operator">=</span> global<span class="token punctuation">.</span>defines<span class="token punctuation">;</span>  <span class="token keyword">var</span> f_ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> global<span class="token punctuation">.</span>modules <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> global<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  f_ <span class="token operator">=</span> global<span class="token punctuation">.</span>modules <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> p_ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> cs<span class="token punctuation">;</span>  __WXML_GLOBAL__<span class="token punctuation">.</span>ops_cached <span class="token operator">=</span> __WXML_GLOBAL__<span class="token punctuation">.</span>ops_cached <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  __WXML_GLOBAL__<span class="token punctuation">.</span>ops_set <span class="token operator">=</span> __WXML_GLOBAL__<span class="token punctuation">.</span>ops_set <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  __WXML_GLOBAL__<span class="token punctuation">.</span>ops_init <span class="token operator">=</span> __WXML_GLOBAL__<span class="token punctuation">.</span>ops_init <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> z <span class="token operator">=</span> __WXML_GLOBAL__<span class="token punctuation">.</span>ops_set<span class="token punctuation">.</span>$gwx <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">gz$gwx_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>__WXML_GLOBAL__<span class="token punctuation">.</span>ops_cached<span class="token punctuation">.</span>$gwx_1<span class="token punctuation">)</span>      <span class="token keyword">return</span> __WXML_GLOBAL__<span class="token punctuation">.</span>ops_cached<span class="token punctuation">.</span>$gwx_1<span class="token punctuation">;</span>    __WXML_GLOBAL__<span class="token punctuation">.</span>ops_cached<span class="token punctuation">.</span>$gwx_1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>      <span class="token keyword">function</span> <span class="token function">Z</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span> <span class="token punctuation">{</span>        z<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token function">Z</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"box"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">Z</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"box-text"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">Z</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__WXML_GLOBAL__<span class="token punctuation">.</span>ops_cached<span class="token punctuation">.</span>$gwx_1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> __WXML_GLOBAL__<span class="token punctuation">.</span>ops_cached<span class="token punctuation">.</span>$gwx_1<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  __WXML_GLOBAL__<span class="token punctuation">.</span>ops_set<span class="token punctuation">.</span>$gwx <span class="token operator">=</span> z<span class="token punctuation">;</span>  __WXML_GLOBAL__<span class="token punctuation">.</span>ops_init<span class="token punctuation">.</span>$gwx <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"index.wxml"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  d_<span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> m0 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> r<span class="token punctuation">,</span> gg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> z <span class="token operator">=</span> <span class="token function">gz$gwx_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"index.wxml:view:2:3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> oB <span class="token operator">=</span> <span class="token function">_n</span><span class="token punctuation">(</span><span class="token string">"view"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_rz</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> oB<span class="token punctuation">,</span> <span class="token string">"class"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> gg<span class="token punctuation">)</span><span class="token punctuation">;</span>    cs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"index.wxml:text:3:4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> xC <span class="token operator">=</span> <span class="token function">_n</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_rz</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> xC<span class="token punctuation">,</span> <span class="token string">"class"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> gg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> oD <span class="token operator">=</span> <span class="token function">_oz</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> s<span class="token punctuation">,</span> gg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_</span><span class="token punctuation">(</span>xC<span class="token punctuation">,</span> oD<span class="token punctuation">)</span><span class="token punctuation">;</span>    cs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_</span><span class="token punctuation">(</span>oB<span class="token punctuation">,</span> xC<span class="token punctuation">)</span><span class="token punctuation">;</span>    cs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> oB<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> r<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  e_<span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> f<span class="token punctuation">:</span> m0<span class="token punctuation">,</span> j<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ti<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ic<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">&amp;&amp;</span> e_<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>__wxml_comp_version__ <span class="token operator">=</span> <span class="token number">0.02</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>env<span class="token punctuation">,</span> dd<span class="token punctuation">,</span> global<span class="token punctuation">)</span> <span class="token punctuation">{</span>      $gwxc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token punctuation">{</span> tag<span class="token punctuation">:</span> <span class="token string">"wx-page"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>      root<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> main <span class="token operator">=</span> e_<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>      cs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> global <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> global <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>      global<span class="token punctuation">.</span>f <span class="token operator">=</span> <span class="token function">$gdc</span><span class="token punctuation">(</span>f_<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        <span class="token keyword">typeof</span> window<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">!=</span> <span class="token string">"undefined"</span> <span class="token operator">&amp;&amp;</span>        window<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">+</span> <span class="token number">1e-6</span> <span class="token operator">>=</span> <span class="token number">0.02</span> <span class="token operator">+</span> <span class="token number">1e-6</span> <span class="token operator">&amp;&amp;</span>        window<span class="token punctuation">.</span>__mergeData__      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        env <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">__mergeData__</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> dd<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token function">main</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">_tsd</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>          <span class="token keyword">typeof</span> window<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">==</span> <span class="token string">"undefined"</span> <span class="token operator">||</span>          window<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">+</span> <span class="token number">1e-6</span> <span class="token operator">&lt;</span> <span class="token number">0.01</span> <span class="token operator">+</span> <span class="token number">1e-6</span>        <span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token function">_ev</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cs<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">return</span> $gwx<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2020/12/20/mini/waservice/"/>
      <url>/2020/12/20/mini/waservice/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> __wxLibrary <span class="token operator">=</span> <span class="token punctuation">{</span>  fileName<span class="token punctuation">:</span> <span class="token string">"WAService.js"</span><span class="token punctuation">,</span>  envType<span class="token punctuation">:</span> <span class="token string">"Service"</span><span class="token punctuation">,</span>  contextType<span class="token punctuation">:</span> <span class="token string">"App:Uncertain"</span><span class="token punctuation">,</span>  execStart<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> __WAServiceStartTime__ <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>global<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> __exportGlobal__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> __libVersionInfo__ <span class="token operator">=</span> <span class="token punctuation">{</span>    updateTime<span class="token punctuation">:</span> <span class="token string">"2020.12.17 16:43:54"</span><span class="token punctuation">,</span>    version<span class="token punctuation">:</span> <span class="token string">"2.14.1"</span><span class="token punctuation">,</span>    features<span class="token punctuation">:</span> <span class="token punctuation">{</span>      pruneWxConfigByPage<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      injectGameContextPlugin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      lazyCodeLoading2<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      injectAppSeparatedPlugin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      nativeTrans<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> __Function__ <span class="token operator">=</span> global<span class="token punctuation">.</span>Function<span class="token punctuation">;</span>  <span class="token keyword">var</span> Function <span class="token operator">=</span> __Function__<span class="token punctuation">;</span>  <span class="token keyword">var</span> __sclEngine__ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// core-js 模块</span>  <span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> o<span class="token punctuation">,</span> Ke<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> __wxTest__ <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span>  wxRunOnDebug <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  __wxConfig<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 基础模块 </span>  Foundation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>  nativeTrans <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">/**   * 消息通信模块               * on: v, //js 监听 native 消息   * publish: A,//发布消息到对应的逻辑层或者视图层   * invoke: g,//js 调用原生方法   * subscribe: m, //监听对应逻辑层或者视图层发送过来的消息   */</span>  WeixinJSBridge <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  Foundation<span class="token punctuation">.</span><span class="token function">onBridgeReady</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 监听 nativeTrans 相关事件</span>  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> nativeTrans<span class="token punctuation">.</span>enabled<span class="token punctuation">;</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 解析配置</span>  <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 异常捕获（error、onunhandledrejection）</span>  <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 原生缓冲区</span>  <span class="token keyword">var</span> NativeBuffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  WeixinNativeBuffer <span class="token operator">=</span> NativeBuffer<span class="token punctuation">,</span>  NativeBuffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  wxConsole <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"log"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token string">"warn"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"debug"</span><span class="token punctuation">,</span> <span class="token string">"time"</span><span class="token punctuation">,</span> <span class="token string">"timeEnd"</span><span class="token punctuation">,</span> <span class="token string">"group"</span><span class="token punctuation">,</span> <span class="token string">"groupEnd"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> e<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  wxPerfConsole <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"log"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token string">"warn"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"time"</span><span class="token punctuation">,</span> <span class="token string">"timeEnd"</span><span class="token punctuation">,</span> <span class="token string">"trace"</span><span class="token punctuation">,</span> <span class="token string">"profile"</span><span class="token punctuation">,</span> <span class="token string">"profileSync"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> e<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  wxNativeConsole <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// Worker 模块</span>  <span class="token keyword">var</span> WeixinWorker <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// JSContext</span>  JSContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>  __appServiceConsole__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> N<span class="token punctuation">,</span> R<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>  Protect <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  __errorTracer__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  Reporter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> N<span class="token punctuation">,</span> R<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>  __subContextEngine__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  Safeway <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  __safeway__ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Safeway</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  __exparserSclEngine__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> p<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   __sclEngine__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  __waServiceInit__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">__doWAServiceInit__</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> A<span class="token punctuation">;</span>    <span class="token string">"undefined"</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span> wx <span class="token operator">&amp;&amp;</span> wx<span class="token punctuation">.</span>version <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>A <span class="token operator">=</span> wx<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">__waServiceInit__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      A <span class="token operator">&amp;&amp;</span>        <span class="token string">"undefined"</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span> __exportGlobal__ <span class="token operator">&amp;&amp;</span>        __exportGlobal__<span class="token punctuation">.</span>wx <span class="token operator">&amp;&amp;</span>        <span class="token punctuation">(</span>__exportGlobal__<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>version <span class="token operator">=</span> A<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  __subContextEngine__<span class="token punctuation">.</span><span class="token function">isIsolateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  __subContextEngine__<span class="token punctuation">.</span><span class="token function">isIsolateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">__doWAServiceInit__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  __subContextEngine__<span class="token punctuation">.</span><span class="token function">initAppRelatedContexts</span><span class="token punctuation">(</span>__exportGlobal__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> __WAServiceEndTime__ <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">typeof</span> __wxLibrary<span class="token punctuation">.</span>onEnd <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> __wxLibrary<span class="token punctuation">.</span><span class="token function">onEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>__wxLibrary <span class="token operator">=</span> undefined<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2020/12/20/mini/wawebview/"/>
      <url>/2020/12/20/mini/wawebview/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// WAWebview.js 源码结构</span><span class="token keyword">var</span> __wxLibrary <span class="token operator">=</span> <span class="token punctuation">{</span>  fileName<span class="token punctuation">:</span> <span class="token string">"WAWebview.js"</span><span class="token punctuation">,</span>  envType<span class="token punctuation">:</span> <span class="token string">"WebView"</span><span class="token punctuation">,</span>  contextType<span class="token punctuation">:</span> <span class="token string">"others"</span><span class="token punctuation">,</span>  execStart<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> __WAWebviewStartTime__ <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> __libVersionInfo__ <span class="token operator">=</span> <span class="token punctuation">{</span>  updateTime<span class="token punctuation">:</span> <span class="token string">"2020.12.17 16:43:54"</span><span class="token punctuation">,</span>  version<span class="token punctuation">:</span> <span class="token string">"2.14.1"</span><span class="token punctuation">,</span>  features<span class="token punctuation">:</span> <span class="token punctuation">{</span>    pruneWxConfigByPage<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    injectGameContextPlugin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    lazyCodeLoading2<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    injectAppSeparatedPlugin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    nativeTrans<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// core-js 核心模块</span><span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> o<span class="token punctuation">,</span> Ye<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token function">i</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      o <span class="token operator">=</span> <span class="token string">"__core-js_shared__"</span><span class="token punctuation">,</span>      r <span class="token operator">=</span> n<span class="token punctuation">[</span>o<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n<span class="token punctuation">[</span>o<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    e<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> __wxTest__ <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span>wxRunOnDebug <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>__wxConfig<span class="token punctuation">,</span><span class="token comment" spellcheck="true">/*** 基础功能* env 版本控制* eventEmit 实现及调用处理* 初始化库函数及当前基本环境* 检查JSBridge* utils*/</span>Foundation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>nativeTrans <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">/** * 消息通信模块             * on: v, //js 监听 native 消息 * publish: A,//发布消息到对应的逻辑层或者视图层 * invoke: g,//js 调用原生方法 * subscribe: m, //监听对应逻辑层或者视图层发送过来的消息 */</span>WeixinJSBridge <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Foundation<span class="token punctuation">.</span><span class="token function">onBridgeReady</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 监听 nativeTrans 相关事件</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> o <span class="token operator">=</span> nativeTrans<span class="token punctuation">.</span>enabled<span class="token punctuation">;</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 解析配置</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  __wxConfig <span class="token operator">=</span> <span class="token function">_</span><span class="token punctuation">(</span>__wxConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> __wxConfig <span class="token operator">=</span> <span class="token function">v</span><span class="token punctuation">(</span>__wxConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> Foundation<span class="token punctuation">.</span><span class="token function">onConfigReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n <span class="token operator">?</span> __wxConfig<span class="token punctuation">.</span>__readyHandler <span class="token operator">=</span> A <span class="token punctuation">:</span> d <span class="token operator">?</span> Foundation<span class="token punctuation">.</span><span class="token function">onBridgeReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    WeixinJSBridge<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"onWxConfigReady"</span><span class="token punctuation">,</span> A<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> Foundation<span class="token punctuation">.</span><span class="token function">onLibraryReady</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 异常捕获（error、onunhandledrejection）</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">t</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Foundation<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"unhandledRejection"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">||</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Uncaught (in promise)"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token string">"object"</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> e <span class="token operator">&amp;&amp;</span> <span class="token string">"function"</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> e<span class="token punctuation">.</span>addEventListener <span class="token operator">?</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"unhandledrejection"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      reason<span class="token punctuation">:</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">,</span>      promise<span class="token punctuation">:</span> e<span class="token punctuation">.</span>promise    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> t<span class="token punctuation">;</span>    t <span class="token operator">=</span> e<span class="token punctuation">.</span>error<span class="token punctuation">,</span> Foundation<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">||</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Uncaught"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">===</span> e<span class="token punctuation">.</span>onunhandledrejection <span class="token operator">&amp;&amp;</span> Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"onunhandledrejection"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    value<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">{</span>        reason<span class="token punctuation">:</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> e <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reason<span class="token punctuation">,</span>        promise<span class="token punctuation">:</span> e<span class="token punctuation">.</span>promise      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 原生缓冲区</span><span class="token keyword">var</span> NativeBuffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>WeixinNativeBuffer <span class="token operator">=</span> NativeBuffer<span class="token punctuation">,</span>NativeBuffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 日志模块：wxConsole、wxPerfConsole、wxNativeConsole、__webviewConsole__</span>wxConsole <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"log"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token string">"warn"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"debug"</span><span class="token punctuation">,</span> <span class="token string">"time"</span><span class="token punctuation">,</span> <span class="token string">"timeEnd"</span><span class="token punctuation">,</span> <span class="token string">"group"</span><span class="token punctuation">,</span> <span class="token string">"groupEnd"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> e<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>wxPerfConsole <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"log"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token string">"warn"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"time"</span><span class="token punctuation">,</span> <span class="token string">"timeEnd"</span><span class="token punctuation">,</span> <span class="token string">"trace"</span><span class="token punctuation">,</span> <span class="token string">"profile"</span><span class="token punctuation">,</span> <span class="token string">"profileSync"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> e<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>wxNativeConsole <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>__webviewConsole__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 上报模块</span>Reporter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> L<span class="token punctuation">,</span> O<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>Perf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 视图层 API</span>__webViewSDK__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> L<span class="token punctuation">,</span> O<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>wx <span class="token operator">=</span> __webViewSDK__<span class="token punctuation">.</span>wx<span class="token punctuation">,</span><span class="token comment" spellcheck="true">//组件系统</span>exparser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">/** * 框架粘合层 *  * 使用 exparser.registerBehavior 和 exparser.registerElement 方法注册内置组件 * 转发 window、wx 对象上到事件转发到 exparser */</span><span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Virtual DOM </span><span class="token keyword">var</span> __virtualDOMDataThread__ <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">var</span> __virtualDOM__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// __webviewEngine__</span>__webviewEngine__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * 注入默认样式到页面 */</span><span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token keyword">function</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token function">i</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    __wxConfig<span class="token punctuation">.</span>isReady <span class="token operator">?</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">!==</span> __wxConfig<span class="token punctuation">.</span>theme <span class="token operator">&amp;&amp;</span> <span class="token function">i</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">.</span>nextElementSibling<span class="token punctuation">)</span> <span class="token punctuation">:</span> __wxConfig<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">!==</span> __wxConfig<span class="token punctuation">.</span>theme <span class="token operator">&amp;&amp;</span> <span class="token function">i</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">.</span>nextElementSibling<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  window<span class="token punctuation">.</span>document <span class="token operator">&amp;&amp;</span> <span class="token string">"complete"</span> <span class="token operator">===</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>readyState <span class="token operator">?</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> window<span class="token punctuation">.</span>onload <span class="token operator">=</span> e<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> __WAWebviewEndTime__ <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> __wxAppCode__ <span class="token operator">=</span> __wxAppCode__ <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> __WXML_GLOBAL__ <span class="token operator">=</span> __WXML_GLOBAL__ <span class="token operator">||</span> <span class="token punctuation">{</span>  entrys<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  defines<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  modules<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  ops<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  wxs_nf_init<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>  total_ops<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">typeof</span> __wxLibrary<span class="token punctuation">.</span>onEnd <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> __wxLibrary<span class="token punctuation">.</span><span class="token function">onEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>__wxLibrary <span class="token operator">=</span> undefined<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>小程序之启动流程</title>
      <link href="/2020/12/20/mini/principle02/"/>
      <url>/2020/12/20/mini/principle02/</url>
      
        <content type="html"><![CDATA[<p>在说小程序启动流程分析之前我们先来了解下其他相关相关知识，也是官方文档提到的</p><h3 id="运行机制"><a href="#运行机制" class="headerlink" title="运行机制"></a>运行机制</h3><blockquote><p>小程序启动会有两种情况，一种是「冷启动」，一种是「热启动」。假如用户已经打开过某小程序，然后在一定时间内再次打开该小程序，此时无需重新启动，只需将后台状态的小程序切换到前台，这个过程就是热启动；冷启动指的是用户首次打开或小程序被微信主动销毁后再次打开的情况，此时小程序需要重新加载启</p></blockquote><ul><li>小程序没有重启的概念</li><li>当小程序进入后台，客户端会维持一段时间的运行状态，超过一定时间后（目前是5分钟）会被微信主动销毁</li><li>当短时间内（5s）连续收到两次以上收到系统内存告警，会进行小程序的销毁</li></ul><img src="/images/mini13.png"><h3 id="更新机制"><a href="#更新机制" class="headerlink" title="更新机制"></a>更新机制</h3><p>小程序冷启动时如果发现有新版本，将会异步下载新版本的代码包，并同时用客户端本地的包进行启动，即新版本的小程序需要等下一次冷启动才会应用上。 如果需要马上应用最新版本，可以使用 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/base/update/wx.getUpdateManager.html" target="_blank" rel="noopener">wx.getUpdateManager API</a> 进行处理</p><h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>小程序的生命周期分为冷启动和热启动，执行顺序如下图（无卸载销毁阶段）<br><img src="/images/mini14.jpg"></p><h3 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h3><p>在微信开发者工具命令行中输入 <code>document</code> 打开逻辑层的的代码可以看到大致流程如下：<br><img src="/images/mini15.png"></p><p><strong>第一步：初始化全局变量</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 指向当前正在加载的页面路径</span><span class="token keyword">var</span> __wxRoute<span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 标志 Page 的正确注册</span>  __wxRouteBegin<span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 指向当前正在加载的 JS 文件</span>  __wxAppCurrentFile__<span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 小程序每个页面的 data 域对象</span>  __wxAppData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 分为两类.json 和 .wxml 结尾，</span><span class="token comment" spellcheck="true">// .wxml 结尾的，其 key 值为通过调用 $gwx('./pages/index/index.wxml')() 得到一个节点树</span>  __wxAppCode__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  __vd_version_info__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 自定义组件构造器</span>  Component <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 自定义组件 behavior 构造器</span>  Behavior <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 自定义插件的构造器</span>  definePlugin <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  requirePlugin <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// global</span>global <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> $gwx<span class="token punctuation">,</span>  __workerVendorCode__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  __workersCode__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 多线程构造器</span>  __WeixinWorker <span class="token operator">=</span> <span class="token punctuation">(</span>WeixinWorker <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 根据全局配置和页面配置生成的配置对象</span><span class="token keyword">var</span> __wxConfig <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>第二步：加载框架（WAService.js）</strong></p><p>我们调用的 API 主要是 <code>__waServiceInit__</code>部分定义的，如以下方法</p><ul><li><code>__appServiceEngine__</code>： 提供了框架最基本的对外接口，如 <code>App</code>、<code>Page</code>、<code>Component</code>、<code>Behavior</code>、<code>getApp</code>、<code>getCurrentPages</code> 等方法</li><li><code>exparser</code>：提供了框架底层的能力，如实例化组件，数据变化监听，<code>View</code> 层与逻辑层的交互等</li><li><code>__virtualDOM__</code>：着连接 <code>__appServiceEngine__</code>和 <code>exparser</code> 的作用</li></ul><p><strong>第三步：业务代码的加载</strong></p><p>require 和 define</p><ul><li>小程序中，开发者的 JavaScript 代码会被打包为 AMD 规范的 JS 模块</li><li>require 和 define 两个方法是在 WAService 中定义的</li><li>define 限制了模块可使用的其他模块，如 window，document在小程序中是不可使用的</li></ul><p>代码的加载顺序是</p><ul><li>加载项目中其他 js 文件（非注册程序和注册页面的 js 文件）</li><li>注册程序的 app.js</li><li>注册自定义组件 js 文件</li><li>注册页面的 js 代码</li></ul><p>对于在 app.js 以及注册页面的 js 代码都会加载完成后立即使用 require 方法执行模块中的程序。其他的代码则需要在程序中使用 require 方法才会被执行</p><p><strong>第四步：加载 app.js 与注册程序</strong></p><p>在 app.js 加载完成后，小程序会使用 require(‘app.js’) 注册程序，即对 App 方法进行调用。App 方法是对<code>__appServiceEngine__.App</code>方法的引用， App() 函数用来注册一个小程序，接收一个 object 对象参数，其指定小程序的生命周期函数等，getApp() 函数可以用来获取到小程序实例</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">try</span> <span class="token punctuation">{</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"app.js"</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token keyword">from</span> <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'app.js错误:\\n'</span><span class="token punctuation">,</span>error<span class="token punctuation">)</span>  <span class="token keyword">throw</span> error<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> decodePathName <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token string">"component/hello"</span><span class="token punctuation">)</span>__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">".json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token string">"component"</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token string">"usingComponents"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">".wxml"</span><span class="token punctuation">]</span><span class="token operator">=</span>\<span class="token function">$gwx</span><span class="token punctuation">(</span><span class="token string">"./"</span> <span class="token operator">+</span> decodePathName <span class="token operator">+</span> <span class="token string">".wxml"</span><span class="token punctuation">)</span><span class="token keyword">var</span> decodePathName <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token string">"pages/index/index"</span><span class="token punctuation">)</span>__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">".json"</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token string">"usingComponents"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">"hello"</span><span class="token punctuation">:</span><span class="token string">"/component/hello"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">".wxml"</span><span class="token punctuation">]</span><span class="token operator">=</span>\<span class="token function">$gwx</span><span class="token punctuation">(</span><span class="token string">"./"</span> <span class="token operator">+</span> decodePathName <span class="token operator">+</span> <span class="token string">".wxml"</span><span class="token punctuation">)</span><span class="token keyword">var</span> decodePathName <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token string">"pages/logs/logs"</span><span class="token punctuation">)</span>__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">".json"</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token string">"navigationBarTitleText"</span><span class="token punctuation">:</span><span class="token string">"查看启动日志"</span><span class="token punctuation">,</span>  <span class="token string">"usingComponents"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">".wxml"</span><span class="token punctuation">]</span><span class="token operator">=</span>\<span class="token function">$gwx</span><span class="token punctuation">(</span><span class="token string">"./"</span> <span class="token operator">+</span> decodePathName <span class="token operator">+</span> <span class="token string">".wxml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> decodePathName <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token string">"component/hello"</span><span class="token punctuation">)</span>__wxRoute <span class="token operator">=</span> decodePathName__wxRouteBegin <span class="token operator">=</span> <span class="token boolean">true</span>__wxAppCurrentFile__ <span class="token operator">=</span> decodePathName <span class="token operator">+</span> <span class="token string">".js"</span><span class="token keyword">try</span> <span class="token punctuation">{</span>  <span class="token function">require</span><span class="token punctuation">(</span>__wxAppCurrentFile__<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 插件项目不能hack define和require，走这里，异常只能精准到页面，内部的多层依赖的报错无法精准</span>  <span class="token operator">!</span>error<span class="token punctuation">.</span><span class="token keyword">from</span> <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'页面【'</span> <span class="token operator">+</span> decodePathName <span class="token operator">+</span> <span class="token string">']错误:\\n'</span><span class="token punctuation">,</span>error<span class="token punctuation">)</span>  <span class="token keyword">throw</span> error<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>APP 方法调用时的处理流程</p><ul><li>deprecated：getCurrentPage</li><li>绑定生命周期函数如 “onLaunch”、”onShow”等</li><li>绑定其他属性并判断是不是 getCurrentPage，然后绑定当前的 APP 实例</li><li>根据是否有 onError 属性判断是不是注册错误</li><li>检查启动参数<ul><li>调用 onLaunch 参数使用 __wxConfig.appLaunchInfo，然后 JSBridge 调用 getAppConfig</li><li>调用 onShow 参数可能和 onLaunch 不同</li></ul></li><li>注册前后台切换回调</li><li>注册找不到页面的回调</li><li>返回实例给 APP 缓存</li></ul><p><strong>第五步：加载自定义组件代码以及注册自定义组件</strong><br>在 app.js 加载完之后，会加载自定义组件，每个自定义组件都是加载完自动注册。直到所有组件注册完毕。执行的步骤如下</p><ul><li>设置 <code>__wxRouteBegin</code> 为 false</li><li>执行 <code>__virtualDOM__.Component(com)</code>：<ul><li>获取当前加载路径</li><li>标准化 com 配置（生命周期、插槽、通讯参数等）</li><li>缓存 com 配置，缓存到 exparser.component.__list 中</li></ul></li><li>缓存组件：以 path 为 key 值为 exparser.component.__list[comPath]</li></ul><p><strong>第六步：加载页面代码和注册页面</strong></p><p>和加载自定义组件处理流程一样，都是每一个加载完后先注册在加载下一个</p><p>处理 Page 的流程如下</p><ul><li>检查 <code>__wxRouteBegin</code> 是否为 false，</li><li>设置 <code>__wxRouteBegin</code> 为 false</li><li>检查是否在 app.json 中定义，如果未定义则抛出错误</li><li>获取.json 中的定义信息</li><li>检查 page 是否为对象，如果不是则抛出错误</li><li>检查是否使用自定义组件<ul><li>使用：执行 <code>__virtualDOM__.Page(page)</code>，缓存 page 的配置信息以 path 为 key 值为 exparser.Component.__list[pagePath]`</li><li>未使用： 缓存 page 的配置信息以 path 为 key 值为 page 对象</li></ul></li></ul><p><strong>第七步：等待页面 Ready 和 Page 实例化</strong></p><p>在小程序中切换页面或打开页面时会触发 onAppRoute 事件，通过 wx.onAppRoute 注册页面切换的处理程序，在所有程序就绪后，以 entryPagePath 作为入口使用 appLaunch 的方式进入页面。而 Ready 生命周期才页面真正的渲染完成</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结<hr></h3><p>上述就是小程序的启动流程，小程序不论是组件还是页面加载过后都会缓存一方面主要是为了提高性能，另一方面小程序还主要是 web 程序要等到 web 都执行完毕之后才 Ready。由于小程序插件在实际开发中应用很少所以就不再这里介绍了。我们记住这个流程（加载APP –&gt; 加载组件 –&gt; 加载页面）就可以了。</p>]]></content>
      
      
      <categories>
          
          <category> 小程序 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小程序 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小程序架构原理</title>
      <link href="/2020/12/12/mini/principle01/"/>
      <url>/2020/12/12/mini/principle01/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<hr></h3><p>​小程序的主要开发语言是 JavaScript ，虽然有与网页开发有相似性但是还有一定的区别</p><ul><li>​网页开发渲染线程和脚本线程是互斥的，也是为什么长时间的脚本运行可能会导致页面失去响应</li><li>小程序中，逻辑层和渲染层是分开的，双线程同时运行。渲染层的界面使用 WebView 进行渲染；逻辑层采用 JSCore 运行 JavaScript 代码</li><li>网页开发面对的主要是浏览器及移动端浏览器 WebView</li><li>小程序开发面对的是两大操作系统 iOS 和 Android 的 微信客户端，所以开发时候需要注意的是微信客户端的版本号和小程序API 支持的基础库版本号</li></ul><p>渲染非原生组件以及脚本执行环境的区别如下</p><table><thead><tr><th>运行环境</th><th>逻辑层</th><th>渲染层</th></tr></thead><tbody><tr><td>Android</td><td>V8</td><td>Chromium定制内核</td></tr><tr><td>iOS</td><td>JSCore</td><td>WKWebView</td></tr><tr><td>小程序开发者工具</td><td>NWJS</td><td>Chrome WebView</td></tr></tbody></table><h3 id="小程序宿主环境"><a href="#小程序宿主环境" class="headerlink" title="小程序宿主环境"></a>小程序宿主环境<hr></h3><p>在前言中提到小程序的宿主环境为微信客户端，所以借助宿主环境提供的能力，可以完成许多普通网页无法完成的功能</p><h3 id="渲染层和逻辑层"><a href="#渲染层和逻辑层" class="headerlink" title="渲染层和逻辑层"></a>渲染层和逻辑层<hr></h3><p>首先，我们来简单了解下小程序的运行环境。小程序的运行环境分成渲染层和逻辑层，其中 WXML 模板和 WXSS 样式工作在渲染层，JS 脚本工作在逻辑层。</p><p>小程序的渲染层和逻辑层分别由2个线程管理：渲染层的界面使用了 WebView 进行渲染；逻辑层采用 JsCore 线程运行 JS 脚本。一个小程序存在多个界面，所以渲染层存在多个 WebView 线程，这两个线程的通信会经由微信客户端做中转，逻辑层发送网络请求也经由 Native 转发，小程序的通信模型下图所示。</p><img src="/images/mini01.png"><h3 id="视图和逻辑通信"><a href="#视图和逻辑通信" class="headerlink" title="视图和逻辑通信"></a>视图和逻辑通信</h3><p>多 WebView 模式下，每一个 WebView 都有一个独立的 JSContext，那视图和逻辑是如何进行通讯？如下图双线程生命周期所示。</p><img src="/images/mini02.png"><p>相对于浏览器双线程模型</p><ul><li>更加安全，因为微信小程序阻止开发者使用一些浏览器提供的一些功能，如操作DOM、动态执行脚本等</li><li>不用等待浏览器主线程去下载并解析 html，遇到 JS 脚本还会阻塞，影响视图渲染，造成白屏</li><li>缺点是双线程如果频繁的通信，操作 setDate 更新视图，对性能消耗特别严重，例如拖拽、滚动等</li></ul><h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构<hr></h3><p>当我们对 View 层进行事件操作后，会通过 WeixinJSBridge 将数据传递到 Native 系统层。Native 系统层决定是否要用 native 处理，然后丢给逻辑层进行用户的逻辑代码处理。逻辑层处理后将数据通过 WeixinJSBridge 返给 View 层。View 渲染更新视图，如下图所示。<br><img src="/images/mini03.jpg"></p><h3 id="编译原理"><a href="#编译原理" class="headerlink" title="编译原理"></a>编译原理<hr></h3><p>微信开者工具模拟器运行的代码是经过本地预处理、本地编译，才能看见的页面。而微信客户端运行的代码是额外经过服务器编译的。只有经过编译才能识别并运行小程序的代码。我们先来看一下小程序文件的基本结构</p><ul><li><code>.wxml</code> 页面结构</li><li><code>.wxss</code> 页面样式</li><li><code>.js</code>  页面逻辑</li><li><code>.json</code> 页面相关配置按照【约定优于配置】的原则</li></ul><p>接下来我们打开小程序开发者工具，点击左上角微信开发者工具 &gt;&gt; 调试 &gt;&gt; 调试微信开发者工具，看到如下界面（官网组件demo）<br><img src="/images/mini04.jpg"><br>可以看到渲染层和逻辑层是两个 webview，第一个对应的 webview 是渲染层，每个页面都有一个webview，而逻辑层的 appservice 是只有一个。</p><p>然后我们接着往下看 webview 中到底是什么？打开 webview 发现 iframe 标签是空的，但我们想要查看怎么办，打开调试面板（console）下面输入</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 第一步先找到所有的webview</span>document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'webview'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 第二步找到第一个渲染层页面用开发工具命令打开</span>document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'webview'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">showDevTools</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这个时候我们会看到如下窗口，这个页面就是我们渲染层的页面结构了。<br><img src="/images/mini05.jpg"></p><p>既然能看到每一个渲染层，肯定也能看到逻辑层代码，在开发者工具控制台中输入 <code>document</code>，出现如下页面<br><img src="/images/mini06.jpg"></p><p>接下来我们看一下微信小程序使用的基础库文件。在开发者工具控制台中输入 <code>openVendor()</code> 就会打开本地小程序的 <code>WeappVendor</code> 目录，有几个重要的文件</p><ul><li><code>wcc</code> 编译器负责将 <code>wxml</code> 编译成 <code>js</code> 文件</li><li><code>wcsc</code> 编译器负责将 <code>wxss</code> 文件编译成 <code>js</code> 文件</li><li><code>xxx.wxvpkg</code> 是不同版本的小程序基础库，主要包含小程序基础库 <code>WAService</code> 和 <code>WAWebview</code>，这块后续分析。</li></ul><p><strong>wcc的作用</strong></p><p>1、新建一个名为 <code>compiler.js</code> 的文件，并写入以下代码</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> miniprogramCompiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"miniprogram-compiler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> JsCompiler <span class="token operator">=</span> miniprogramCompiler<span class="token punctuation">.</span><span class="token function">wxmlToJs</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> cssCompiler <span class="token operator">=</span> miniprogramCompiler<span class="token punctuation">.</span><span class="token function">wxssToJs</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">"wxml.js"</span><span class="token punctuation">,</span> JsCompiler<span class="token punctuation">)</span><span class="token punctuation">;</span>  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">"wxcss.js"</span><span class="token punctuation">,</span> cssCompiler<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2、执行 <code>npm install miniprogram-compiler</code><br>3、执行 <code>node compiler.js</code>,会在同目录生成 <a href="https://github.com/MarsPen/-notes-summary/blob/master/source/_posts/mini/wcss.md" target="_blank" rel="noopener"> wxml</a> 和 <a href="https://github.com/MarsPen/-notes-summary/blob/master/source/_posts/mini/wcsc.md" target="_blank" rel="noopener">wxcss</a> 两个 JS 文件<br>4、新建 index.wxml 并写入如下代码</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token operator">&lt;</span>view <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box"</span><span class="token operator">></span>    <span class="token operator">&lt;</span>text <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box-text"</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">{</span> text <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>text<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>5、新建 index.html 引入文件 wxml.js，如下代码</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"./wxml.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>  <span class="token operator">&lt;</span>script<span class="token operator">></span>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">$gwx</span><span class="token punctuation">(</span><span class="token string">"index.wxml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> virtualTree <span class="token operator">=</span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token string">'data数据'</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>virtualTree<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用浏览器打开 index.html 控制台会输出类似 Virtual DOM 的对象</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>  <span class="token string">"tag"</span><span class="token punctuation">:</span><span class="token string">"wx-page"</span><span class="token punctuation">,</span>  <span class="token string">"children"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    <span class="token string">"tag"</span><span class="token punctuation">:</span><span class="token string">"wx-view"</span><span class="token punctuation">,</span>    <span class="token string">"attr"</span><span class="token punctuation">:</span><span class="token punctuation">{</span> <span class="token string">"class"</span><span class="token punctuation">:</span><span class="token string">"box"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"children"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>        <span class="token string">"tag"</span><span class="token punctuation">:</span><span class="token string">"wx-text"</span><span class="token punctuation">,</span>        <span class="token string">"attr"</span><span class="token punctuation">:</span><span class="token punctuation">{</span> <span class="token string">"class"</span><span class="token punctuation">:</span><span class="token string">"box-text"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"children"</span><span class="token punctuation">:</span><span class="token punctuation">[</span> <span class="token string">"data数据"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string">"raw"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"generics"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token string">"raw"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"generics"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>wcc的作用就是：</p><ul><li>执行 wcc 编译 wxml 生成相关页面注册代码，并记录标签的属性及其值（生成 JS 文件）</li><li>这个文件主体是一个 $gwx() 函数，接收两个参数 <code>path</code> （页面 wxml 路径）和 <code>global</code>（顶层对象)</li></ul><p><strong>wcsc的作用</strong></p><ul><li>wcsc 编译 wxss 得到一个 js 文件</li><li>添加尺寸单位rpx转换，可根据屏幕宽度自适应</li><li>提供 setCssToHead 方法将转换后的 css 内容添加到 header</li></ul><p><strong>xxx.wxvpkg</strong></p><p>上面提到过开发者工具中输入<code>openVendor</code> 之后会看到很多 <code>.wxvpkg</code> 文件，这是小程序的基础库，主要有两部分组成 <code>WAService</code> 和 <code>WAWebview</code></p><ul><li>WAWebview：小程序视图层基础库，提供视图层基础能力</li><li>WAService：小程序逻辑层基础库，提供逻辑层基础能力</li></ul><p>微信小程序基础库版本是不断更新的，当前我本地的最高版本为 2.14.1.wxvpkg ，我们可以利用<a href="https://github.com/thedreamwork/unwxapkg" target="_blank" rel="noopener">unwxapkg</a> 解压 2.14.1.wxvpkg。解压后的目录为 </p><pre class="line-numbers language-js"><code class="language-js">├── WAAutoService<span class="token punctuation">.</span>js├── WAAutoWebview<span class="token punctuation">.</span>js├── WAGame<span class="token punctuation">.</span>js├── WAGameSubContext<span class="token punctuation">.</span>js├── WAGameVConsole<span class="token punctuation">.</span>html├── WAGfxEmsc<span class="token punctuation">.</span>js├── WAGfxEmsc<span class="token punctuation">.</span>wasm├── WAPageFrame<span class="token punctuation">.</span>html├── WAPerf<span class="token punctuation">.</span>js├── WARemoteDebug<span class="token punctuation">.</span>js├── WAService<span class="token punctuation">.</span>js├── WAServiceMainContext<span class="token punctuation">.</span>js├── WASourceMap<span class="token punctuation">.</span>js├── WASubContext<span class="token punctuation">.</span>js├── WAVConsole<span class="token punctuation">.</span>js├── WAVersion<span class="token punctuation">.</span>json├── WAWKWorker<span class="token punctuation">.</span>html├── WAWebview<span class="token punctuation">.</span>js├── WAWidget<span class="token punctuation">.</span>js└── WAWorker<span class="token punctuation">.</span>js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其他文件先忽略，我们先看一下 webview 引用的两个基础文件源码概览<br><a href="https://github.com/MarsPen/-notes-summary/blob/master/source/_posts/mini/WAWebview.md" target="_blank" rel="noopener">WAWebview</a> 和 <a href="https://github.com/MarsPen/-notes-summary/blob/master/source/_posts/mini/WAService.md" target="_blank" rel="noopener">WAService</a></p><p>其中，WAWebview 最主要的几个部分：</p><ul><li><code>Foundation</code>：基础模块(发布订阅、通信桥梁 ready 事件)</li><li><code>WeixinJSBridge</code>：消息通信模块（js 和 native 通讯） Webview 和 Service都有相同的一套</li><li><code>exparser</code>：组件系统模块，实现了一套自定义的组件模型，比如实现了 wx-view</li><li><code>__virtualDOM__</code>：虚拟 Dom 模块</li><li><code>__webViewSDK__</code>：WebView SDK 模块</li><li><code>Reporter</code>：日志上报模块(异常和性能统计数据)</li></ul><p>其中，WAService 最主要的几个部分：</p><ul><li><code>Foundation</code>：基础模块</li><li><code>WeixinJSBridge</code>：消息通信模块(js 和 native 通讯) Webview 和 Service都有相同的一套</li><li><code>WeixinNativeBuffer</code>：原生缓冲区</li><li><code>WeixinWorker</code>：Worker 线程</li><li><code>JSContext</code>：JS Engine Context</li><li><code>Protect</code>：JS 保护的对象</li><li><code>__subContextEngine__</code>：提供 App、Page、Component、Behavior、getApp、getCurrentPages 等方法</li></ul><p><strong>Foundation 模块</strong><br>基础模块提供环境变量 env、发布订阅 EventEmitter、配置/基础库/通信桥 Ready 事件。<br><img src="/images/mini07.jpg"></p><p><strong>Exparser 模块</strong><br>微信小程序的组件组织框架，内置在小程序基础库中，为小程序的各种组件提供基础的支持。小程序内的所有组件，包括内置组件和自定义组件，都由 Exparser 组织管理。Exparser 的组件模型与 WebComponents 标准中的 ShadowDOM 高度相似。Exparser 会维护整个页面的节点树相关信息，包括节点的属性、事件绑定等，相当于一个简化版的 Shadow DOM 实现。<br><img src="/images/mini08.jpg"></p><p><strong>Virtual DOM 模块</strong><br>生成 <code>wx-element</code> 对象，和 <a href="https://github.com/Matt-Esch/virtual-dom" target="_blank" rel="noopener">virtual-dom</a> 类似<br><img src="/images/mini09.jpg"></p><p><strong>WeixinJSBridge 模块</strong><br>提供了视图层 JS 与 Native、视图层与逻辑层之间消息通信的机制，如下图几个方法:<br><img src="/images/mini10.jpg"></p><p><strong>首次渲染流程</strong><br>通过上面这些主体结构和函数，对小程序应该有大致的了解，那么我们把上面串起来看一下首次渲染的流程</p><ul><li>打开微信开发者工具</li><li>点击左上角调试微信开发者工具</li><li>调试面板输入 <code>document.getElementsByTagName(&#39;webview&#39;)[0].showDevTools(true)</code></li></ul><img src="/images/mini11.jpg"><p>上图中最后标注的代码</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> decodeName <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token string">"./pages/index/index.wxml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> generateFunc <span class="token operator">=</span> <span class="token function">$gwx</span><span class="token punctuation">(</span>decodeName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>generateFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> CE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> __global <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>CustomEvent <span class="token operator">||</span> __global<span class="token punctuation">.</span>CustomEvent<span class="token punctuation">)</span> <span class="token punctuation">:</span> window<span class="token punctuation">.</span>CustomEvent<span class="token punctuation">;</span>    document<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CE</span><span class="token punctuation">(</span><span class="token string">"generateFuncReady"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>        detail<span class="token punctuation">:</span> <span class="token punctuation">{</span>            generateFunc<span class="token punctuation">:</span> generateFunc        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> __global<span class="token punctuation">.</span>timing<span class="token punctuation">.</span><span class="token function">addPoint</span><span class="token punctuation">(</span><span class="token string">'PAGEFRAME_GENERATE_FUNC_READY'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> decodeName <span class="token operator">+</span> <span class="token string">" not found"</span>console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>decodeName <span class="token operator">+</span> <span class="token string">" not found"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以初次渲染流程如下</p><ul><li><p>利用 $gwx 创建类似虚拟 DOM 的节点树</p></li><li><p>创建自定义事件 window.CustomEvent（CE）</p></li><li><p>分发自定义事件 document.dispatchEvent</p></li><li><p>在 WAWebview 监听这个事件，然后通过 WeixinJSBridge 通知 JS 逻辑层视图已经准备好</p><pre class="line-numbers language-js"><code class="language-js">c <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token operator">!</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">var</span> e <span class="token operator">=</span> arguments<span class="token punctuation">;</span>          <span class="token function">r</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            WeixinJSBridge<span class="token punctuation">.</span>publish<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>WeixinJSBridge<span class="token punctuation">,</span> <span class="token function">o</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">"GenerateFuncReady"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">}</span>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"generateFuncReady"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>最后 JS 逻辑层将数据给 Webview 视图层，进行首次渲染</p></li></ul><img src="/images/mini12.jpeg"><h3 id="通信原理"><a href="#通信原理" class="headerlink" title="通信原理"></a>通信原理<hr></h3><p>小程序逻辑层和渲染层的通信会由 Native （微信客户端）做中转，逻辑层发送网络请求也经由 Native 转发。</p><p><strong>视图层组件:</strong><br>内置组件中有部分组件（map、video等）是利用到客户端原生提供的能力，那是怎么通信的呢？iOS 是利用了 WKWebView 的提供 messageHandlers 特性，而在安卓则是往 WebView 的 window 对象注入一个原生方法，最终会封装成 WeiXinJSBridge 这样一个兼容层，主要提供了调用（invoke）和监听（on）这两种方法。</p><p><strong>逻辑层接口:</strong><br>iOS 平台往 JavaScripCore 框架注入一个全局的原生方法，而安卓方面则是跟渲染层一致。</p><p>不论视图层（部分组件）还是逻辑层，开发者都是间接地调用客户端原生底层的能力。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结<hr></h3><p>这篇文章主要是理解小程序 wcc 和 wcsc 编译的文件，以及整个小程序架构的的意义。由于逻辑层源码微信官方加密看到只能靠打印和猜测每个模块大致的作用。</p>]]></content>
      
      
      <categories>
          
          <category> 小程序 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小程序 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flutter 之 dart 基础语法</title>
      <link href="/2019/12/15/flutter/library-flutter-dart/"/>
      <url>/2019/12/15/flutter/library-flutter-dart/</url>
      
        <content type="html"><![CDATA[<p>dart 作为 flutter 选用的基础语言，具有一定的优势。下面我们来简单的了解一下这门语言。</p><h3 id="什么是-dart"><a href="#什么是-dart" class="headerlink" title="什么是 dart "></a>什么是 dart <hr></h3><p>dart 是由 Google 主导开发的一种编程语言，于 2011 年 10 月公开。也是一种面向对象语言，但是它采用基于类编程。</p><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性<hr></h3><ul><li>所有的对象都继承自 Object，即使是 numbers、function、null</li><li>在 running 之前解析所有代码，指定类型会更安全，加快编译</li><li>如果没有显示定义类型，则会自动推导，没有初始化的变量则默认值为 null</li><li>dart 提供顶级函数（如main（))</li><li>dart 没有 public、private、protected，变量名以“_”开头意味着对它的 lib 是私有的</li><li>内嵌的 dart vm 的 Chromium，可以在浏览器中直接执行 dart</li><li>dart2js 是可以将 dart 代码编译为 Javascript 的工具</li></ul><h3 id="运行-dart-环境"><a href="#运行-dart-环境" class="headerlink" title="运行 dart 环境"></a>运行 dart 环境<hr></h3><ul><li>在 vscode 编辑器中添加插件 dart，</li><li>新建文件 demo.dart</li><li>在文件中写入 main 入口函数，在函数内定义其他可执行代码</li><li>关于 flutter 环境布置在后续文章中会介绍</li></ul><h3 id="声明变量与常量"><a href="#声明变量与常量" class="headerlink" title="声明变量与常量"></a>声明变量与常量<hr></h3><p><strong>var 定义变量（编译器确定变量类型）</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'my name is $name I,m $age years old'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// age = '28';  // 错误</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>dynamic （运行期确定变量类型）</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  dynamic name <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>  dynamic age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'my name is $name I,m $age years old'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// age = '28'; 正确</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>const 定义常量（编译期确定常量值）</strong> </p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> String name<span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> int age <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'$name + $age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>final 定义常量（运行期确定常量值）</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  final String city <span class="token operator">=</span> <span class="token string">'biejing'</span><span class="token punctuation">;</span>  final int phone <span class="token operator">=</span> <span class="token number">15212345678</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'$city + $phone'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>所有未初始化的变量的初始值为 null</li><li>var 在编译期会自动匹配类型，所以当改变的值类型不同时会提示错误</li><li>dynamic 被编译后是 object 类型，在编译器不进行任何类型的检查，将检查放到了运行期</li><li>final 必须被初始化，只能赋值一次，赋值可以是常量也可以是变量，赋值后不能更改</li><li>const 必须被初始化，只能赋值一次，赋值必须是常量，赋值后不能更改</li></ul><h3 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型<hr></h3><p><strong>Number 数字类型 有两个子类 int 和 double</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  int a <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>  double b  <span class="token operator">=</span> <span class="token number">100.01</span><span class="token punctuation">;</span>  int c <span class="token operator">=</span> int<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  double d <span class="token operator">=</span> double<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'100.01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'$a + $b + $c + $d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>String 用$ 计算字符串值，如果是表达式用 ${}</strong></p><pre class="line-numbers language-js"><code class="language-js">main <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  String name <span class="token operator">=</span> <span class="token string">'Renbo'</span><span class="token punctuation">;</span>  String nametoLowerCase <span class="token operator">=</span> <span class="token string">'${name.toUpperCase()}'</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'$nametoLowerCase'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// RENBO</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Booleans true or false</strong></p><pre class="line-numbers language-js"><code class="language-js">main <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  bool isFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>isFlag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Lists 集合 类似于 javaScript 中的数组</strong></p><pre class="line-numbers language-js"><code class="language-js">main <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 定义集合</span>  <span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1,3,2,3,3,4]</span>  <span class="token function">print</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 6</span>  <span class="token comment" spellcheck="true">// 向末尾添加元素</span>  list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token function">print</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1,3,2,3,3,4,5]</span>  <span class="token comment" spellcheck="true">// 移除为3的元素，如果有多个相同的，则移除第一个</span>  list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token function">print</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1, 2, 3, 3, 4, 5]</span>  <span class="token comment" spellcheck="true">// 根据下表移除</span>  list<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token function">print</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [2, 3, 3, 4, 5]</span>  <span class="token comment" spellcheck="true">// 定义常量集合</span>  <span class="token keyword">var</span> list  <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Maps 集合</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 用 {} 直接声明 map</span>Map info <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span>  <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>  <span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'beijing'</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">print</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// {name: renbo, age: 20, city: beijing}</span><span class="token comment" spellcheck="true">// 获取值</span><span class="token function">print</span><span class="token punctuation">(</span>info<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo</span><span class="token comment" spellcheck="true">// 添加新键值对</span>info<span class="token punctuation">[</span><span class="token string">'phone'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15212344567</span><span class="token punctuation">;</span><span class="token function">print</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// {name: renbo, age: 20, city: beijing, phone: 15210713603}</span><span class="token comment" spellcheck="true">// map 长度</span><span class="token function">print</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 4</span><span class="token comment" spellcheck="true">// 检索Map是否含有某Key</span><span class="token function">print</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">'gender'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span><span class="token comment" spellcheck="true">// 先声明，再去赋值</span><span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>map<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span><span class="token function">print</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 编译时常量的map</span>Map infoConst <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>  <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span>  <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">28</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">print</span><span class="token punctuation">(</span>infoConst<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面简单的介绍了 dart 的基本数据类型，当然有很多操作上的 api 就不一一列举了，可自行查找 api</p><h3 id="运算符与流程控制"><a href="#运算符与流程控制" class="headerlink" title="运算符与流程控制"></a>运算符与流程控制<hr></h3><p><strong>if…else</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'大于100'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">></span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'大于200'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">></span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'大于300'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>三元运算符</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  int age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  String status <span class="token operator">=</span> age <span class="token operator">&lt;</span> <span class="token number">28</span> <span class="token operator">?</span> <span class="token string">"年轻人"</span> <span class="token punctuation">:</span> <span class="token string">"老男人"</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>switch…case</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  int age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  <span class="token keyword">switch</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token number">18</span><span class="token punctuation">:</span>      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'18'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token number">28</span><span class="token punctuation">:</span>      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'28'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token number">38</span><span class="token punctuation">:</span>      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'38'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>for 循环</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>int i<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'$i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>while 循环</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'$i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    i<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Do-while</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">do</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'$i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    i<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数<hr></h3><p><strong>函数调用</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  String name <span class="token operator">=</span> <span class="token function">fullName</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>String <span class="token function">fullName</span><span class="token punctuation">(</span>String firstName<span class="token punctuation">,</span> String lastName<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token string">"$firstName $lastName"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>如果函数内表达式较为简单可以使用箭头函数</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  String name <span class="token operator">=</span> <span class="token function">fullName</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span><span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>fullName <span class="token punctuation">(</span>String firstName<span class="token punctuation">,</span> String lastName<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"$firstName $lastName"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>函数的参数</strong></p><ul><li>函数的参数有两种形式分为可选参数和必要参数</li><li>必要参数定义在参数列表前面，可选参数则定义在必要参数后面</li><li>可选参数分为命名参数和位置参数，可在参数列表中任选其一使用，但两者不能同时出现在参数列表中</li><li>可以使用 @required 注解来标识一个命名参数是必须的参数</li></ul><p><strong>参数的默认值 = 表示</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token function">fullName</span><span class="token punctuation">(</span>firstName<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">fullName</span><span class="token punctuation">(</span><span class="token punctuation">{</span>String firstName<span class="token punctuation">,</span> String lastName <span class="token operator">=</span> <span class="token string">"lisi"</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token string">"$firstName $lastName"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>命名参数 指定参数名字</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token function">fullName</span><span class="token punctuation">(</span>lastName<span class="token punctuation">:</span> <span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">fullName</span><span class="token punctuation">(</span><span class="token punctuation">{</span>String firstName<span class="token punctuation">,</span> String lastName<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token string">"$firstName $lastName"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>函数当参数</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">out</span><span class="token punctuation">(</span>printOutLoud<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">out</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token function">inner</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">inner</span><span class="token punctuation">(</span><span class="token string">'My Name Is Renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">printOutLoud</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>匿名函数</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">out</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">out</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token function">inner</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">inner</span><span class="token punctuation">(</span><span class="token string">'My Name Is Renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>词法作用域(大括号内定义的变量只能在大括号内访问，作用域在书写代码的时候就已经确定)</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// myFunction 函数可以访问包括顶层变量在内的所有的变量</span>String name <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span><span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  int age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> myFunction <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    String gender <span class="token operator">=</span> <span class="token string">'m'</span><span class="token punctuation">;</span>    <span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print</span><span class="token punctuation">(</span>gender<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">myFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>闭包(函数对象，即使函数对象的调用在它原始作用域之外，依然能够访问在它词法作用域内的变量)</strong></p><pre class="line-numbers language-js"><code class="language-js">Function <span class="token function">add</span><span class="token punctuation">(</span>num value<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>num i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> value <span class="token operator">+</span> i<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> add1 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> add2 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">add1</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">add2</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="类"><a href="#类" class="headerlink" title="类"></a>类<hr></h3><ul><li>dart 是支持基于 mixin 继承机制的面向对象语言</li><li>所有对象都是一个类的实例，而所有的类都继承自 Object 类</li><li>Extension 方法是一种在不更改类或创建子类的情况下向类添加功能的方式</li></ul><p><strong>构造函数(Constructors)</strong></p><ul><li>构造函数不被继承<ul><li>子类不会继承父类的构造函数，如果子类没有声明构造函数，那么只会有一个默认无参数的构造函数</li><li>如果希望拥有父类的一样功能的命名构造函数，则必须在子类中重新定义</li></ul></li><li>默认构造函数<ul><li>如果没有声明构造函数，dart 会自动生成一个无参数的构造函数并且该构造函数会调用其父类的无参数构造方法</li></ul></li><li>声明一个和类名相同的函数，则作为类的构造函数</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Person p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 声明实例变量，初始化为null </span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 声明构造函数</span>  Person <span class="token punctuation">(</span>String name<span class="token punctuation">,</span> int age<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// this 指当前的实例</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">//Person (this.name,this.age); // dart 语法糖和上面声明方式一样 </span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>命名构造函数</strong></p><p>命名式构造函数可以为一个类声明多个命名式构造函数来表达更明确的意图</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Person p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person<span class="token punctuation">.</span>study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 声明实例变量</span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  Person <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 命名构造函数</span>  Person<span class="token punctuation">.</span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    name <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>    age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>重定向构造函数</strong></p><ul><li>有时构造函数的唯一目的是重定向到同一个类中的另一个构造函数 </li><li>重定向构造函数的函数体为空， 构造函数的调用在冒号 ( : ) 之后</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Person p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person<span class="token punctuation">.</span>study</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 声明实例变量</span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  Person <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 重定向构造函数</span>  Person<span class="token punctuation">.</span><span class="token function">study</span><span class="token punctuation">(</span>String name <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>常量构造函数</strong></p><ul><li>如果类生成的对象都是不会变的，那么可以在生成这些对象时就将其变为编译时常量</li><li>优点是在编译时已经知道所有字段值的对象，而不执行任何语句</li><li>由于常量不会每次都重新创建。在编译时被规范化，并存储在特殊的查找表中（通过规范签名进行哈希处理），方便重新使用</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Person p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person<span class="token punctuation">.</span>study</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 声明实例变量</span>  final String name<span class="token punctuation">;</span>  final int age<span class="token punctuation">;</span>  <span class="token keyword">const</span> Person <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 重定向构造函数</span>  <span class="token keyword">const</span> Person<span class="token punctuation">.</span><span class="token function">study</span><span class="token punctuation">(</span>String name <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>工厂构造函数</strong></p><ul><li>使用 factory 关键字标识类的构造函数将会令该构造函数变为工厂构造函数</li><li>这将意味着使用该构造函数构造类的实例时并非总是会返回新的实例对象</li><li>可能会从缓存中返回一个实例，或者返回一个子类型的实例</li><li>在工厂构造函数中无法访问 this</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Person p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 声明实例变量</span>  final String name<span class="token punctuation">;</span>  final int age<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// _cache 是一个私有库</span>  <span class="token keyword">static</span> final Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Person<span class="token operator">></span> _cache <span class="token operator">=</span> <span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Person<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 定义工厂函数</span>  factory Person <span class="token punctuation">(</span>String name<span class="token punctuation">,</span>int age<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_cache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'从缓冲中取值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> _cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'放入缓存中'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      final person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person<span class="token punctuation">.</span>_study</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>      _cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> person <span class="token punctuation">;</span>      <span class="token keyword">return</span> person<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  Person<span class="token punctuation">.</span><span class="token function">_study</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>类-方法（Methods）</strong><br>方法是对象提供行为的函数，有实例方法、Getter 和 Setter、抽象方法几种方式</p><p>实例方法可以访问实例变量和 this</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Person p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">smile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  <span class="token function">Person</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 实例方法</span>  String <span class="token function">smile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'😂😂😂😂😂😂😂😂'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">"${this.name} ${this.age}"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Getter 和 Setter 是一对用来读写对象属性的特殊方法</li><li>实例对象的每一个属性都有一个隐式的 Getter 方法</li><li>如果为非 final 属性的话还会有一个 Setter 方法</li><li>可以使用 get 和 set 关键字为额外的属性添加 Getter 和 Setter 方法</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Person p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"${p.name} ${p.age}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  <span class="token function">Person</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 实例方法</span>  String <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"${this.name} ${this.age}"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">void</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>String value <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> value<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>抽象方法是定义一个接口方法，不关心业务逻辑。将实例方法、Getter 和 Setter 进行抽象分离,</li><li>抽象方法只能存在抽象类中</li><li>抽象类使用关键字 abstract 标识类可以让该类成为 抽象类，抽象类将无法被实例化</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 定义抽象类</span>abstract <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 定义实例变量和方法等等……</span>  <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 定义抽象方法。</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Man</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 提供一个实现，所以在这里该方法不再是抽象的……</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>隐式接口（implements）</strong></p><ul><li>dart 中没有 interface 关键字定义接口，普通类或抽象类都可以作为接口被实现</li><li>使用 implements 关键字进行实现</li></ul><pre class="line-numbers language-dart"><code class="language-dart"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> man <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Man</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>man<span class="token punctuation">.</span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>man<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 定义抽象类方法</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Person</span>  <span class="token punctuation">{</span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 用接口实现抽象类</span><span class="token keyword">class</span> <span class="token class-name">Man</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token metadata symbol">@override</span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  <span class="token function">Man</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token metadata symbol">@override</span>  String <span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// TODO: implement study</span>    <span class="token keyword">return</span> <span class="token string">"${this.name} ${this.age} studying"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token metadata symbol">@override</span>  String <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// TODO: implement eat</span>    <span class="token keyword">return</span> <span class="token string">"${this.name} ${this.age} eating"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>类继承（extends）</strong></p><p>使用 extends 关键字来创建一个子类，并可使用 super 关键字引用一个父类：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Man p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Man</span><span class="token punctuation">(</span><span class="token string">'zhansan'</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  <span class="token function">Person</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  Person<span class="token punctuation">.</span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    name <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>    age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Man</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token function">Man</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> int age<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>重写类成员（Overriding members）</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Man p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Man<span class="token punctuation">.</span>smile</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  p<span class="token punctuation">.</span><span class="token function">bark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  <span class="token function">Person</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  Person<span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    name <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>    age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">bark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'我是bark'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Man</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token function">Man</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> int age<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>  Man<span class="token punctuation">.</span><span class="token function">smile</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> @override  <span class="token function">bark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'我是重写的bark方法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>类的静态变量和方法</strong></p><ul><li>声明静态属性和静态方法使用 static 关键字</li><li>静态变量（即类变量）常用于声明类范围内所属的状态变量和常量</li><li>静态变量在其首次被使用的时候才被初始化</li><li>静态方法（即类方法）不能被一个类的实例访问，同样地，静态方法内也不可以使用 this</li><li>对于一些通用或常用的静态方法，应该将其定义为顶级函数而非静态方法</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Person<span class="token punctuation">.</span><span class="token function">smile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  String name<span class="token punctuation">;</span>  int age<span class="token punctuation">;</span>  <span class="token function">Person</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">static</span> <span class="token function">smile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'😂😂😂😂😂😂'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>泛型（Generics）</strong></p><ul><li>泛型常用于需要要求类型安全的情况</li><li>适当地指定泛型可以更好地帮助代码生成</li><li>使用泛型可以减少代码重复</li><li>&lt;…&gt; 符号表示是一个 泛型，用一个字母来代表类型参数，通常是T</li></ul><p>比如你想声明一个只能包含 String 类型的数组，你可以将该数组声明为 List<string>（读作“字符串类型的 list”），这样的话就可以很容易避免因为在该数组放入非 String 类变量而导致的诸多问题，同时编译器以及其他阅读代码的人都可以很容易地发现并定位问题：</string></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> names <span class="token operator">=</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>names<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Seth'</span><span class="token punctuation">,</span> <span class="token string">'Kathy'</span><span class="token punctuation">,</span> <span class="token string">'Lars'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Error</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>另一个使用泛型的原因是可以减少重复代码。泛型可以让你在多个不同类型实现之间共享同一个接口声明，比如下面的例子中声明了一个类用于缓存对象的接口：</p><pre class="line-numbers language-js"><code class="language-js">abstract <span class="token keyword">class</span> <span class="token class-name">Cache</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>  T <span class="token function">getByKey</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">setByKey</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> T value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  DataHolder<span class="token operator">&lt;</span>String<span class="token operator">></span> dataHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataHolder</span><span class="token punctuation">(</span><span class="token string">'Some data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>dataHolder<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  dataHolder<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'New Data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print</span><span class="token punctuation">(</span>dataHolder<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">DataHolder</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>  T data<span class="token punctuation">;</span>  <span class="token function">DataHolder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> data<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="库和可见性"><a href="#库和可见性" class="headerlink" title="库和可见性"></a>库和可见性<hr></h3><p><strong>导入库（import）</strong></p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 导入 dart 内置库</span><span class="token keyword">import</span> <span class="token string">'dart:html'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 指定库来至包管理器</span><span class="token keyword">import</span> <span class="token string">'package:flutter/cupertino.dart'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>指定库前缀</strong></p><p>如果导入的两个代码库有冲突的标识符，可以为其中一个指定前缀。比如如果 library1 和 library2 都有 Element 类，那么可以这么处理：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string">'package:lib1/lib1.dart'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'package:lib2/lib2.dart'</span> <span class="token operator">as</span> lib2<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 使用 lib1 的 Element 类。</span>Element element1 <span class="token operator">=</span> <span class="token function">Element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 使用 lib2 的 Element 类。</span>lib2<span class="token punctuation">.</span>Element element2 <span class="token operator">=</span> lib2<span class="token punctuation">.</span><span class="token function">Element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>导入库的一部分</strong></p><p>如果你只想使用代码库中的一部分，你可以有选择地导入代码库。例如：</p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 只导入 lib1 中的 foo。(Import only foo).</span><span class="token keyword">import</span> <span class="token string">'package:lib1/lib1.dart'</span> show foo<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 导入 lib2 中除了 foo 外的所有。</span><span class="token keyword">import</span> <span class="token string">'package:lib2/lib2.dart'</span> hide foo<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>Dart 代码库中有大量返回 <a href="https://api.dart.dev/stable/2.7.0/dart-async/Future-class.html" target="_blank" rel="noopener">Future</a> 或 <a href="https://api.dart.dev/stable/2.7.0/dart-async/Stream-class.html" target="_blank" rel="noopener">Stream</a> 对象的函数，这些函数被成为异步函数，它们会在耗时操作（比如I/O）执行完毕前直接返回而不会等待耗时操作执行完毕。</p><p>async 和 await 关键字用于实现异步编程，并且让你的代码看起来就像是同步的。</p><p>Future 和 JavaScript 中 Promise 对象极其相似用于异步处理，当异步处理成功就成功的操作，否则就捕获错误或者停止后续操作。Future 返回值仍然是 Future对象，所以进行链式调用</p><p><strong>Future.then 返回成功的结果</strong></p><pre class="line-numbers language-dart"><code class="language-dart"><span class="token comment" spellcheck="true">// 延时任务 2s 后 返回 hi world 结果</span>Future<span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token string">"hi world!"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Future.catchErro 捕获错误</strong></p><pre class="line-numbers language-dart"><code class="language-dart">Future<span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//return "hi world!";</span>   <span class="token keyword">throw</span> <span class="token function">AssertionError</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//执行成功会走到这里  </span>   <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catchError</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//执行失败会走到这里  </span>   <span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Future.whenComplete 无论异步执行成功或者失败都执行</strong></p><pre class="line-numbers language-dart"><code class="language-dart">Future<span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token keyword">return</span> <span class="token string">"hi world!"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//执行成功会走到这里 </span>   <span class="token function">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catchError</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//执行失败会走到这里   </span>   <span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//无论成功或失败都会走到这里</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Future.wait 类似 primise.all，当数组中所有 Future 都执行成功后，才会触发 then 的成功回调，只要有一个 Future 执行失败，就会触发错误回调</strong></p><pre class="line-numbers language-dart"><code class="language-dart">Future<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token comment" spellcheck="true">// 2秒后返回结果  </span>  Future<span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 4秒后返回结果  </span>  Future<span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">" world"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catchError</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>async 和 await 和 JavaScript 中用法相似，在这里就不多做介绍，更多用法请参考<a href="http://www.dartdoc.cn/guides/language/language-tour#asynchrony-support" target="_blank" rel="noopener">异步</a></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考<hr></h3><p><a href="http://www.dartdoc.cn/guides/language/language-tour#class-variables-and-methods" target="_blank" rel="noopener">Dart 开发文档</a></p>]]></content>
      
      
      <categories>
          
          <category> Flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基本概念</title>
      <link href="/2019/11/25/datastructure/library-array/"/>
      <url>/2019/11/25/datastructure/library-array/</url>
      
        <content type="html"><![CDATA[<h3 id="基本概念和术语-🚩"><a href="#基本概念和术语-🚩" class="headerlink" title="基本概念和术语 🚩"></a>基本概念和术语 🚩<hr></h3><p><strong>数据🍎</strong> </p><p>在计算机科学中是指所有能输入到计算机中并被计算机程序处理的符号的总称，是对客观事物的符合表示。</p><p><strong>数据元素🍎</strong></p><p>数据的基本单位，一个数据元素可由若干个<code>数据项</code>组成,<code>数据项</code>是数据不可分割的最小单位。</p><p><strong>数据单位🍎</strong></p><p>是性质相同的数据元素的集合，是数据的一个子集</p><p><strong>数据结构🍎</strong></p><p>相互间存在一种或多种特定关系的数据元素的集合，通常由4类基本结构 <code>集合</code>，<code>线性结构</code>、<code>树形结构</code>、<code>图状结构或网状结构</code>，如下图</p><img src="/images/shuju01.jpg"><ul><li>计算机中的数据结构表现形式称为数据的 <code>物理结构</code>，又称为存储结构。包括数据元素的表示和关系的表示。</li><li>计算机中表示信息的最小单位是二进制数的一<code>位（bit）</code>。</li><li>若干个位组合起来形成的一个位串表示一个<code>数据元素</code>，通常称这个位串为<code>元素（element）</code>，或者<code>节点（node）</code>。</li><li>当 <code>数据元素</code> 有若干个 <code>数据项</code> 组成时为，位串中对应的各个数据项的子位串称为 <code>数据域</code>。</li><li><code>数据元素</code> 之间的关系有两种不同的表示方法 <code>顺序映像（相邻的元素）</code> 和 <code>非顺序映像</code>（不一定相邻），因此得到两种不同的存储结构 <code>顺序存储结构</code> 和 <code>链式存储结构</code></li><li><code>顺序存储结构</code> 的特点是借助元素在存储器中相对位置来表示数据元素之间的逻辑关系。</li><li><code>链式存储结构</code> 的特点是借助指示元素存储地址的<code>指针</code>表示数据元素之间的逻辑关系。</li><li>算法的设计取决于选定的逻辑结构，而实现则依赖于采用的存储结构。</li></ul><p><strong>数据类型🍎</strong></p><p><strong>抽象数据类型🍎</strong></p><ul><li><p>原子类型</p></li><li><p>固定聚合类型</p></li><li><p>可变聚合类型</p></li></ul><p><strong>多形数据类型🍎</strong></p><h3 id="算法和算法分析"><a href="#算法和算法分析" class="headerlink" title="算法和算法分析"></a>算法和算法分析</h3><p><strong>什么是算法🍎</strong></p><p><strong>算法的设计要求🍎</strong><br><strong>算法的效率🍎</strong></p><ul><li>时间复杂度</li><li>空间复杂度</li></ul><p>栈(stack)是简单的数据结构，但在计算机中使用广泛。它是有序的元素集合</p><p>内存的区域，以后进先出（LIFO）的方式添加或删除数据。<br>在计算机系统中，每个线程都有一个保留的内存区域称其为栈，当函数执行时，它可能会将其一些局部状态数据添加到堆栈的顶部；当函数退出时，它负责从堆栈中删除该数据。至少，线程的堆栈用于存储调用方提供的返回地址的位置，以便允许return语句返回正确的位置。堆栈通常用于存储当前活动函数本地固定长度的变量。</p><p>优缺点：</p><p>因为数据是以先进先出的方式添加和删除的，所以栈的内存分配非常简单，并且通常比通过动态（malloc）内存分配内存快得多。</p><p>另一个功能是，当函数退出时，栈上的内存会自动高效地回收，如果数据需要以某种形式保存，则必须在函数退出之前将其从堆、栈复制到堆中。因此，基于栈的分配适用于临时数据或在当前函数退出后不再需要的数据。</p><p>在某些小型CPU上，线程分配的堆栈大小可能只有几个字节。在堆栈上分配的内存多于可用内存，可能由于堆栈溢出而导致崩溃。</p><p>基于栈的分配也会导致较小的性能问题：导致可变大小的堆栈帧，因此需要管理堆栈指针和帧指针（对于固定大小的堆栈帧，其中之一是冗余的）。通常，这比调用 malloc 和 free 无论如何都要便宜得多。特别是，如果当前函数同时包含对alloca的调用和包含可变长度的本地数据的块，则alloca尝试增加当前堆栈帧直到当前函数退出与编译器需要将可变长度的局部变量放入其中之间会发生冲突。堆栈框架中的相同位置。通常通过为每个alloca调用创建一个单独的堆存储链来解决此冲突（请参阅：<a href="https://code.woboq.org/gcc/libiberty/alloca.c.html）。该链记录发生每次分配的堆栈深度，随后在任何函数中对alloca的调用都会将该链修剪到当前堆栈深度，以最终（但不是立即）释放该链上的任何存储空间。对参数为零的alloca的调用也可以用于触发释放内存，而无需分配更多此类内存。由于alloca和局部变量存储之间的这种冲突，使用alloca可能不会比使用malloc更有效。" target="_blank" rel="noopener">https://code.woboq.org/gcc/libiberty/alloca.c.html）。该链记录发生每次分配的堆栈深度，随后在任何函数中对alloca的调用都会将该链修剪到当前堆栈深度，以最终（但不是立即）释放该链上的任何存储空间。对参数为零的alloca的调用也可以用于触发释放内存，而无需分配更多此类内存。由于alloca和局部变量存储之间的这种冲突，使用alloca可能不会比使用malloc更有效。</a></p><p>子例程<br>某个主程序的一部分代码，该代码执行特定的任务并且与主程序中的其他代码相对独立。<br>子例程又被称为子程序、过程、方法、函数等。在主程序中可以调用子例程来执行。<br>　　函数，是一种子程序，利用函数名称，可以接收回传值。</p><p>调用栈<br>在计算机科学中调用栈是一种栈数据结构，用于存储有关计算机活动的子例程的信息。</p><p>有调用栈的主要原因<br>1要跟踪每个活动子例程在完成执行后应返回控制的点。已被调用但尚未完成执行的子例程，应将控制权交还给调用点。</p><p>2本地数据存储<br>另请参阅：基于堆栈的内存分配<br>子例程经常需要存储空间来存储局部变量的值，这些局部变量仅在活动子例程中是已知的，并且在返回后不会保留值。通过简单地将堆栈顶部移动足够的空间来提供空间，通常可以方便地分配空间。与使用堆空间的动态内存分配相比，这非常快。请注意，子例程的每次单独激活都会在堆栈中为本地变量获得其自己的单独空间。</p><p>由于调用栈是作为一个栈组织的，因此调用方将返回地址压入堆栈，并且被调用子例程完成后，将返回地址从调用堆栈中拉出或弹出，并将控制权转移到该地址。如果被调用子例程又调用另一个子例程，它将把另一个返回地址压入调用堆栈，依此类推，信息将按照程序的指示进行堆积和堆积。如果推入消耗了为调用堆栈分配的所有空间，则会发生称为堆栈溢出的错误，通常会导致程序崩溃。将子例程的条目添加到调用堆栈有时被称为“缠绕”。相反，删除条目是“结束”。</p><p>一个典型的堆栈，用于存储本地数据和用于嵌套过程调用（不一定是嵌套过程）的调用信息。该堆栈从其原始位置开始向下生长。堆栈指针指向堆栈上的当前最上面的基准。推操作使指针递减并将数据复制到堆栈；弹出操作会从堆栈中复制数据，然后递增指针。程序中调用的每个过程通过将过程返回信息（以黄色显示）和本地数据（以其他颜色显示）存储到堆栈中来存储它们。</p><h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>数组是最简单的内存数据结构了，在前端也有数组类型下面我们看看关于数组的知识</p><h3 id="什么是数组"><a href="#什么是数组" class="headerlink" title="什么是数组"></a>什么是数组<hr></h3><p>数组是存储一系列同一种类型的值（js 中可以是不同类型的值）。定义的时候为其分配存储单元，此存储单元在内存中是一块连续的区域，在使用前要先申请占用的内存大小。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// js 中声明数组的一种方式，也可以使用 new Array</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/images/array-what.jpg" width="50%"></p><p>上面我们在代码中初始化了一个名为 arr 的数组，数组中的元素为 1，2，3，4，5，6，可以通过数组的 length 属性知道数组里面存了多少个元素。因为数组都有自己的下标 从 0 开始（上图中的[0]-[5]），所以可以通过 [] 中括号下标的方式去得到对应的值</p><pre class="line-numbers language-js"><code class="language-js">arr<span class="token punctuation">.</span>length <span class="token comment" spellcheck="true">// 6</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 1</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 2</span><span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="数组的操作"><a href="#数组的操作" class="headerlink" title="数组的操作"></a>数组的操作<hr></h3><p>在 javascript 中对数组的操作其实也很容易，因为操作数组的 api 太多，所以我们通过添加、删除、合并、迭代、搜索、排序这几个方面来了解数组的常规操作。当然这里不会将所有的 api 都用到。更多 api 介绍请移步 <a href="https://www.studyfe.cn/2019/03/20/javascript/api/">操作数组的 API 方法</a></p><blockquote><p>数组的添加</p></blockquote><p>在 javaScript 中，数组是一个可以修改的对象，如果向末尾添加元素，只要把值赋给数组最后一个空位上的元素即可。它就会动态增长这点和 java 有一定的区别。在 java 中要添加元素就必须创建一个全新的数组。因为在数组定义的时候要定义其长度，为其分配内存空间。如果类似 javaScript 那么在 java 中可以用集合 ArrayList。 </p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// javascript</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [1,2,3,4,5,6]</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [1,2,3,4,5,6,7,8]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// java</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 初始化默认值为1-5，分配长度为5的int 类型数组arr(静态) </span><span class="token keyword">int</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 声明并分配一个长度为 5 的 int 类型数组 arr（动态），</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// java</span>ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 声明实例的一个 int 类型的数组集合</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 向集合中添加一个元素</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面的 javascript 代码中我们向数组末尾添加了一个元素。接下来我们向数组首位添加一个元素。如果向首位添加一个元素，就需要将腾出数组中第一个元素的位置，把所有元素向右移动一位。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [0, 1, 2, 3, 4, 5]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码中我们通过循环向数组的首位添加了一个为 0 的元素。当然只是为了更好的演示数组的操作，也可以直接通过 api unshift 来添加。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arr<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [0, 1, 2, 3, 4, 5]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>下面这张图很好的描述了我们刚才的操作过程</p><p><img src="/images/array-unshift.jpg" width="50%"></p><p>现在数组中输出的数字是 0-5 并且数组的长度从 5 变为 6，那么接下来看看数组的删除</p><blockquote><p>数组的删除</p></blockquote><p>还是跟上面的操作一样，这回我们还是用循环删除数组中第一个元素，当然也可以用api shift 来删除</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 循环</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [1, 2, 3, 4, 5, undefined]</span><span class="token comment" spellcheck="true">// shift</span>arr<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回删除的元素 0</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [1, 2, 3, 4, 5]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面这张图很好的描述的这段代码的执行过程</p><p><img src="/images/array-shift.jpg" width="50%"></p><p>我们将数组里的所有元素左移动了一位。数组的长度依然是17，所以数组的末尾有一个额外的 undefined，因为在最后一次循环 ， i+1 引用了一个数组里还未初始化的位置。</p><p>当然我们也可以删除数组内指定的元素可以用 splice,从数组的索引开始的几个元素（下面就是从数组的索引2开始的3元素）</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> newArr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[2,3,4]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [0,1,5]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//[2,3,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>数组的合并</p></blockquote><p>数组的合并在实际开发的应用中经常会用到，将多个数组进行迭代，把每个元素加入定义好的数组中。在 JavaScript 中提供了 concat 的方法来实现合并</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// concat</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arr1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">var</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arr3 <span class="token operator">=</span> arr2<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arr1<span class="token punctuation">,</span> arr2<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr3<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [-3, -2, -1, 0, 1, 2, 3]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arr1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">var</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arr3  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr2<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  arr3<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>arr3<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  arr3<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr3<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [-3, -2, -1, 0, 1, 2, 3]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>数组的迭代</p></blockquote><p>在 javaScript 中内置了很多数组迭代的方法，every、some、forEach、map、filter、reduce 具体的 api 使用请参考 <a href="https://www.studyfe.cn/2019/03/20/javascript/api/">操作数组的 API 方法</a>原生方法实现请参考<a href="https://juejin.im/post/5c0b7f03e51d452eec725729" target="_blank" rel="noopener">map 和 filter 的实现</a>也可以参考<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map" target="_blank" rel="noopener">mdn 的 Polyfill</a></p><blockquote><p>数组的搜索</p></blockquote><p>数组的搜索方法请参考 <a href="https://www.studyfe.cn/2019/03/20/javascript/api/#toc-heading-15">indexOf</a></p><blockquote><p>数组的排序</p></blockquote><p>在 Javascript 中对数组的排序提供了 sort api ，下面我们来看看 sort</p><p>sort 是按照字符编码顺序进行排序，如果想要实现业务逻辑排序需要自定义比较函数</p><p><strong>数字升序排序</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> newArr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [6, 7, 8, 9, 10, 11, 15, 18]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>字符串进行排序</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Ana'</span><span class="token punctuation">,</span><span class="token string">'ana'</span><span class="token punctuation">,</span><span class="token string">'john'</span><span class="token punctuation">,</span><span class="token string">'John'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> newNames <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newNames<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ["Ana", "John", "ana", "john"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面这样可定是不对的因为 Javascript 做字符串比较的时候是根据ASCII值来比较的 A,j,a,j对应的值为65，75，97，106。所以需要我们要自定义函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Ana'</span><span class="token punctuation">,</span><span class="token string">'ana'</span><span class="token punctuation">,</span><span class="token string">'john'</span><span class="token punctuation">,</span><span class="token string">'John'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> newNames <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a<span class="token operator">-</span>b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newNames<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ['Ana','ana','john','John']</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>数组对象排序</strong></p><p>下面按照年龄排序，实际项目中有可能会用 id 进行排序</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> friends <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span><span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'wangwu'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token keyword">var</span> newFriends <span class="token operator">=</span> friends<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a<span class="token punctuation">.</span>age <span class="token operator">-</span> b<span class="token punctuation">.</span>age<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newFriends<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结<hr></h3><p>数组是最常用的数据结构，我们在上面举例说明了什么是数组、数组的创建、以及一些操作数组的常用API。虽然过于简单，但有助于我们在后续编写自己的算法时能够更好的深入和理解。当然有很多优秀的库供我们使用例如 <a href="https://www.lodashjs.com/" target="_blank" rel="noopener">Lodash</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构与算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack 使用总结</title>
      <link href="/2019/11/20/webpack/library-webpack01/"/>
      <url>/2019/11/20/webpack/library-webpack01/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍<hr></h2><p>在前端的历史车轮中出现过很多优秀的构建工具，例如 npm script、grunt、gulp、fis3、webpack、rollup, parcel 等等。也正是因为前端技术发展之快，才出现各种可以提高开发效率的工具，来提高生产力，减小开发成本。通过这篇文章主要了解以下两点</p><ul><li>各大主流构建工具的对比以及优缺点</li><li>webpack 常用的插件总结及配置</li></ul><h2 id="构建工具作用"><a href="#构建工具作用" class="headerlink" title="构建工具作用"></a>构建工具作用<hr></h2><p>在了解各大构建工具之前，我们要清楚构建工具是做什么的。实际上它就是将源代码转化成可执行的代码。如转换 javaScript、css、html等。在转换的过程中包含以下功能</p><ul><li>将代码转换成能在浏览器中可执行的代码（es6、sass、less 等）</li><li>进行代码和页面级别、资源级别的优化（压缩、混淆、合并、缓存等）</li><li>进行代码分割和模块合并、规范校验等工作（提取页面公共代码等）</li><li>进行开发热更新、区分环境自动发布等</li></ul><p>上面说了这么多实际上就是工程化、自动化的思想。将手动的流程用工具自动的解决一系列复杂的操作，解放生产力。</p><h2 id="构建工具对比"><a href="#构建工具对比" class="headerlink" title="构建工具对比"></a>构建工具对比</h2><p>通过对比能够更好的了解当前构建工具的应用场景和优缺点，下面我们来看看</p><h3 id="npm"><a href="#npm" class="headerlink" title="npm "></a>npm <hr></h3><blockquote><p><a href="http://www.ruanyifeng.com/blog/2016/10/npm_scripts.html" target="_blank" rel="noopener">npm scripts 使用指南</a></p></blockquote><p>Npm Scripts（NPM脚本）是一个任务执行者。NPM 是安装 Node 时附带的一个包管理器，Npm Script 则是 NPM 内置的一个功能，允许在 package.json 文件里面使用 scripts 字段定义任务：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>    <span class="token string">"scripts"</span><span class="token punctuation">:</span><span class="token punctuation">{</span>        <span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token string">"node dev.js"</span><span class="token punctuation">,</span>        <span class="token string">"pub"</span><span class="token punctuation">:</span> <span class="token string">"node build.js"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>里面的 scripts 字段是一个对象，每个属性对应一个 Shell 脚本，以上代码定义了两个任务，dev 和 pub。其底层实现原理是通过调用 Shell 去运行脚本命令，例如，执行 npm run pub 命令等同于执行 node build.js 命令。</p><p>优点：npm scripts 的优点是内置，无需安装其他依赖<br>缺点：功能太简单，虽然提供了 pre 和 post 两个钩子，但不能方便的管理多个任务之间的依赖。</p><h3 id="grunt"><a href="#grunt" class="headerlink" title="grunt "></a>grunt <hr></h3><blockquote><p><a href="https://gruntjs.com/" target="_blank" rel="noopener">grunt 官网</a></p></blockquote><p>Grunt 现在已基本不用了，简单说一下。Grunt 和 Npm Scripts 类似，也是一个任务执行者。Grunt 有大量现成的插件封装了常见任务，也能管理任务之间的依赖关系，自动化地执行依赖任务，每个任务的具体执行代码和依赖关系写在配置文件 gruntfile.js 里。</p><p>优点：灵活，它只负责执行我们定义好的任务。大量可复用插件封装好了常见的构建任务。<br>缺点：集成度不高，要写很多配置后才可以用，无法做到开箱即用</p><h3 id="gulp"><a href="#gulp" class="headerlink" title="gulp "></a>gulp <hr></h3><blockquote><p><a href="https://www.gulpjs.com.cn/" target="_blank" rel="noopener">gulp 官网</a></p></blockquote><p>Gulp 是一个基于流的自动化构建工具。除了可以管理任务和执行任务，还支持监听文件、读写文件。Gulp 被设计的非常简单，只通过下面5个方法就可以支持几乎所有构建场景：</p><ul><li>通过 gulp.task 注册一个任务</li><li>通过 gulp.run 执行任务</li><li>通过 gulp.watch 监听文件变化</li><li>通过 gulp.src 读取文件</li><li>通过 gulp.dest 写完文件</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 大致方法</span><span class="token comment" spellcheck="true">// 引入 Gulp</span><span class="token keyword">var</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"gulp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 引入插件</span><span class="token keyword">var</span> jshint <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"gulp-jshint"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"gulp-sass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> concat <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"gulp-concat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token comment" spellcheck="true">// SCSS任务</span>gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'scss'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 读取文件，通过管道执行插件</span>    gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'./scss/*.scss'</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// SCSS 插件将 scss 文件编译成 css</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 输出文件</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>guilp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 合并压缩 JavaScript 文件</span>gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'scripts'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'./js/*.js'</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'all.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./dest'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 监听文件变化</span>gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'watch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 当 SCSS 文件被编辑时执行 SCSS 任务</span>    gulp<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'./scss/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'sass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gulp<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'./js/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'scripts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>优点：好用又不失灵活，既可以单独完成构建，也可以和其他工具搭配使用<br>缺点：集成度不高，要写很多配置后才可以用，无法做到开箱即用</p><p>可以将 Gulp 看做是 Grunt 的加强版。相对于 Grunt ，Gulp 增加了文件监听、读写文件、流式处理的功能。</p><h3 id="fis3"><a href="#fis3" class="headerlink" title="fis3 "></a>fis3 <hr></h3><blockquote><p><a href="http://fis.baidu.com/" target="_blank" rel="noopener">fis3 官网</a></p></blockquote><p>Fis3是一个来自百度的优秀国产构建工具。相对于 Grunt、Gulp 这些只提供了基本功能的工具。Fis3集成了开发者常用的构建功能，如下所述。</p><ul><li>读写文件：通过 fis.match 读文件，release 配置文件输出路径。</li><li>资源定位：解析文件之间的依赖关系和文件位置。</li><li>文件指纹：在通过 useHash 配置输出文件时为文件 URL加上 md5 戳，来优化浏览器的缓存。</li><li>文件编译：通过 parser 配置文件解析器做文件转换，例如将 ES6 编译成 ES5。</li><li>压缩资源：通过 optimizer 配置代码压缩方法。</li><li>图片合并：通过 spriter 配置合并 CSS 里导入的图片到一个文件中，来减少 HTTP 请求数。</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 加 md5</span>fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.{js,css,png}'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    useHash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 通过fis3-parse-typescript插件可将 TypeScript 文件转换成 JavaScript 文件</span>fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    parser<span class="token punctuation">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 对CSS进行雪碧图合并</span>fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.css'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 为匹配到的文件分配属性 useSprite</span>    useSprite<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 压缩 JavaScript</span>fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    optimizer<span class="token punctuation">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'uglify-js'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 压缩CSS</span>fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.css'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    optimizer<span class="token punctuation">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'clean-css'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 压缩图片</span>fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.png'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    optimizer<span class="token punctuation">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'png-compressor'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>优点：集成了各种Web所需的构建功能，配置简单，开箱即用<br>缺点：目前官方已经不再更新和维护，不支持最新版本的 Node</p><blockquote><p><a href="https://webpack.js.org/" target="_blank" rel="noopener"> webpack 官网 </a></p></blockquote><p>webpack 是一个打包模块化的 JavaScript 的工具，在 webpack 里一切文件皆模块，通过 loader 转换文件，通过 Plugin 注入钩子，最后输出由多个模块组合成的文件。webpack 专注于构建模块化项目。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 大致方法</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token string">'./app.js'</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>优点：</p><ul><li>专注于处理模块化的项目，能做到开箱即用、一步到位；</li><li>可通过 Plugin 扩展，完整好用又不失灵活性；</li><li>使用场景不局限于Web开发；</li><li>社区庞大活跃，经常引入紧跟时代发展的新特性，能为大多数场景找到已有的开源扩展；</li><li>良好的开发体验；</li></ul><p>缺点： </p><p>只能用于采用模块化开发的项目</p><h3 id="rollup"><a href="#rollup" class="headerlink" title="rollup "></a>rollup <hr></h3><blockquote><p><a href="https://www.rollupjs.com/" target="_blank" rel="noopener"> rollup 官网 </a></p></blockquote><p>Rollup 是一个和 webpack 很类似但专注于 ES6 的模块打包工具。它的亮点在于，针对 ES6 源码进行 Tree Shaking, 以去除那些已经被定义但没被使用的代码并进行 Scope Hoisting，以减少输出文件的大小和提升运行性能。然而 Rollup 的这些亮点随后就被 webpack 模仿和实现了。由于 Rollup 的使用方法和 webpack 差不多，所以这里就不详细介绍如何使用 Rollup 了，而是详细说明他们的差别：</p><ul><li>Rollup 是在 webpack 流行后出现的替代品；</li><li>Rollup 生态链不完善，体验还不如 webpack；</li><li>Rollup 的功能不如 webpack 完善，但其配置和使用更简单；</li><li>Rollup 不支持 Code Spliting， 但好处是在打包出来的代码中没有 webpack 那段模块的加载、执行和缓存的代码。</li><li>Rollup 在用于打包 JavaScript 库时比 webpack 更有优势，因为其打包出来的代码更小、更快。但他的功能不够完善，在很多场景下都找不到现成的解决方案</li></ul><h3 id="parcel"><a href="#parcel" class="headerlink" title="parcel"></a>parcel<hr></h3><blockquote><p> <a href="https://parceljs.org/" target="_blank" rel="noopener"> parcel 官网 </a></p></blockquote><p>Parcel 适用于经验不同的开发者。它利用多核处理提供了极快的速度，并且不需要任何配置。做到开箱即用。</p><p>优点：</p><ul><li>极速打包。Parcel 使用 worker 进程去启用多核编译。同时有文件系统缓存，即使在重启构建后也能快速再编译。</li><li>开箱即用。对 JS, CSS, HTML, 文件 及更多的支持，而且不需要插件。</li><li>自动转换。如若有需要，Babel, PostCSS, 和PostHTML甚至 node_modules 包会被用于自动转换代码.</li><li>热模块替换。Parcel 无需配置，在开发环境的时候会自动在浏览器内随着你的代码更改而去更新模块。</li><li>友好的错误日志。当遇到错误时，Parcel 会输出 语法高亮的代码片段，帮助你定位问题。</li></ul><p>缺点：</p><ul><li>不支持SourceMap：在开发模式下，Parcel也不会输出SourceMap，目前只能去调试可读性极低的代码；</li><li>不支持剔除无效代码(TreeShaking)：很多时候我们只用到了库中的一个函数，结果Parcel把整个库都打包了进来；</li><li>一些依赖会让Parcel出错：当你的项目依赖了一些Npm上的模块时，有些Npm模块会让Parcel运行错误；</li><li>不灵活的配置： 零配置的Parcel关闭了很多配置项，在一些需要的配置的场景下无法改变</li><li>场景受限制：只能用来构建能用来构建用于运行在浏览器中的网页</li></ul><p>通过上面的对比我们看到每种构建工具实际上都有应用的场景。每种工具也是时代应运产生的。那么在这几年流行的模块化、组件化也出现了很多组件库，CMD 规范的 seaJs、AMD 规范的 requireJs 等（<a href="https://juejin.im/post/5aaa37c8f265da23945f365c" target="_blank" rel="noopener">区别</a>），这写规范无外乎都是解决开发中实际的问题。那么我们为什么会去选择 webpack 呢。</p><ul><li>当前前端技术都会采用的新思想（模块化+新语言+新框架）去开发</li><li>webpack 在4.0以后可以几乎零配置</li><li>可以为新项目提供一站式解决方案</li><li>有良好的生态和维护团队，学习资源多并且能够保证良好体验和质量</li><li>vue 和 react 库的 cli 流行也是造成我们选择它的理由</li></ul><p>那么接下来我来了解一下 webpack 的原理</p><h2 id="webpack-原理"><a href="#webpack-原理" class="headerlink" title="webpack 原理"></a>webpack 原理</h2><p>在了解原理之前我们先认识基本的构建概念和构建流程</p><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念 "></a>基本概念 <hr></h3><ul><li>entry 构建的入口文件</li><li>output 构建完成的文件输出的位置</li><li>module 模块，通过模块内的匹配规则和loader来处理文件</li><li>loader 处理文件的文件转化器（ES6 -&gt; ES5 等）</li><li>plugin 插件，通过监听执行流程上的钩子函数可以做扩展功能</li><li>chunk 多个文件组成的代码快</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 简单的例子</span><span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> _mode <span class="token operator">==</span> <span class="token string">"test"</span> <span class="token operator">?</span> <span class="token string">"development"</span> <span class="token punctuation">:</span> _mode<span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>    main<span class="token punctuation">:</span> <span class="token string">"./src/main.js"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    path<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./dist/assets"</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>_plugins<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  externals<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>_externals  <span class="token punctuation">}</span><span class="token punctuation">,</span>  resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="运行流程"><a href="#运行流程" class="headerlink" title="运行流程 "></a>运行流程 <hr></h3><p>webpack 就像一条生产线，要经过一系列处理流程后才能将源文件转换成输出结果。 这条生产线上的每个处理流程的职责都是单一的，多个流程之间有存在依赖关系，只有完成当前处理后才能交给下一个流程去处理。 插件就像是一个插入到生产线中的一个功能，在特定的时机对生产线上的资源做处理。</p><p>webpack 通过 Tapable 来组织这条复杂的生产线。 webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件，就能加入到这条生产线中，去改变生产线的运作。 webpack 的事件流机制保证了插件的有序性，使得整个系统扩展性很好。  –吴浩麟《深入浅出webpack》</p><p>上面这段话把 webapck 做的事情解释的很清楚，实际上就是在构建的时候通过一系列的事件处理和回调来处理不同的功能。那么这种事件流是通过 Tapable 来管理的，关于 <a href="https://github.com/Pein892/learn-webpack-tapable" target="_blank" rel="noopener">Tapable</a>请移步大佬的源码分析。</p><p>但是在 webpack4 中重写了事件流机制 <a href="https://webpack.js.org/api/compiler-hooks/" target="_blank" rel="noopener"> webpack Hook</a>，由于源码的复杂性。在后面会通过思维导图的方式整理方便记忆。那么在<a href="https://github.com/webpack/changelog-v5/blob/master/README.md" target="_blank" rel="noopener">webpack5</a> 中其实也增加了一些功能。在这里就不展开讨论了。</p><p>下面我们通过流程图来对 webpack 的执行流程作出分析</p><p><img src="/images/webpack.png"></p><ul><li>首先读取 webpack.config.js 文件，初始化本次构建的配置参数</li><li>初始化参数阶段开始读取配置 Entries ，遍历所有入口文件。</li><li>依次进入每个入口文件使用配置好的loader 对文件内容进行解析编译，生成<a hre="https://juejin.im/post/5bff941e5188254e3b31b424">AST（静态语法树）</a></li><li>最后输出代码 chunk、打包好的文件等</li></ul><p>上面的过程只是粗略的介绍了执行流程，那么接下来还是通过一张图来看一下 webpack 内部到底是如何工作的</p><p><img src="/images/webpack-render.jpg"></p><p>通过上面的图已经很清楚的看到在 webpack 的每个阶段要做的事情熟悉整个流程有助于帮助我们理解日常的开发。下面我们就日常开发列出一些常用 loader 和 plugin</p><h2 id="webpack-常用插件"><a href="#webpack-常用插件" class="headerlink" title="webpack 常用插件"></a>webpack 常用插件</h2><p>我们通过配置的伪代码来介绍我们常用的功能几插件</p><h3 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> webpackConfig  <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> _mode <span class="token operator">==</span> <span class="token string">"test"</span> <span class="token operator">?</span> <span class="token string">"development"</span> <span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>通过 mode 可以控制我们是开发还是线上环境通过控制环境来区分执行的文件如果 production 除了我们配置的以外 webpack 会默认开启以下插件</p><ul><li>FlagDependencyUsagePlugin（编译时标记依赖）</li><li>FlagIncludedChunksPlugin（标记chunks,防止chunks多次加载）</li><li>ModuleConcatenationPlugin（scope hoisting，预编译功能，提升代码在浏览器中的执行速度）</li><li>NoEmitOnErrorsPlugin（在编译时候遇到错误可以跳过输出阶段，确保输出资源不会包含错误）</li><li>OccurrenceOrderPlugin（给生成的 chunkid 排序）</li><li>SideEffectsFlagPlugin（module.rules 的SideEffects 标志）</li><li>uglifyjs-webpack-plugin（删除未引用代码并压缩 js） </li></ul><h3 id="entry"><a href="#entry" class="headerlink" title="entry "></a>entry <hr></h3><p>单页面入口配置</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> webpackConfig  <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> _mode <span class="token operator">==</span> <span class="token string">"test"</span> <span class="token operator">?</span> <span class="token string">"development"</span> <span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>    main<span class="token punctuation">:</span> <span class="token string">"./src/main.js"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>多页面入口配置</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> webpackConfig  <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> _mode <span class="token operator">==</span> <span class="token string">"test"</span> <span class="token operator">?</span> <span class="token string">"development"</span> <span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>    pageOne<span class="token punctuation">:</span> <span class="token string">'./src/pageOne/index.js'</span><span class="token punctuation">,</span>    pageTwo<span class="token punctuation">:</span> <span class="token string">'./src/pageTwo/index.js'</span><span class="token punctuation">,</span>    pageThree<span class="token punctuation">:</span> <span class="token string">'./src/pageThree/index.js'</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="output"><a href="#output" class="headerlink" title="output"></a>output<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> webpackConfig  <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//...</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    path<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./dist/assets"</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以对输出文件进行 hash 和 publicPath 设置，publicPath 可以设置 cdn 地址这样可以优化加载文件时间</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> webpackConfig  <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">"scripts/[name].[contenthash:5].bundule.js"</span><span class="token punctuation">,</span>    publicPath<span class="token punctuation">:</span> <span class="token string">"/assets/"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="module"><a href="#module" class="headerlink" title="module "></a>module <hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// loaders</span><span class="token keyword">const</span> webpackConfig  <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 创建模块时，匹配请求的规则数组</span>    <span class="token comment" spellcheck="true">// 通过这些规则可以对模块(module)应用 loader 和或者修改解析器(parse)</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 匹配规则</span>        exclude<span class="token punctuation">:</span> <span class="token regex">/(node_modules|bower_components)/</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 排除文件</span>        use<span class="token punctuation">:</span> <span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">"babel-loader"</span>  <span class="token comment" spellcheck="true">// 使用的loader</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.vue$/</span><span class="token punctuation">,</span>        loader<span class="token punctuation">:</span> <span class="token string">"vue-loader"</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpg|gif)$/i</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">{</span>            loader<span class="token punctuation">:</span> <span class="token string">"url-loader"</span><span class="token punctuation">,</span>            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">// 小于 10kB(10240字节）的内联文件</span>              limit<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>              name<span class="token punctuation">:</span> _modeflag                <span class="token operator">?</span> <span class="token string">"images/[name].[contenthash:5].[ext]"</span>                <span class="token punctuation">:</span> <span class="token string">"images/[name].[ext]"</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span>        <span class="token punctuation">]</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更多配置参数请参考<a href="https://webpack.docschina.org/configuration/module/#module-rules" target="_blank" rel="noopener">webpack 官网</a></p><h3 id="plugin"><a href="#plugin" class="headerlink" title="plugin "></a>plugin <hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// plugins</span><span class="token keyword">const</span> webpackConfig  <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">//分析当前包的大小</span>    <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 创建html入口文件</span>    <span class="token keyword">new</span> <span class="token class-name">HtmlwebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      filename<span class="token punctuation">:</span> <span class="token string">"index.html"</span><span class="token punctuation">,</span>      template<span class="token punctuation">:</span> <span class="token string">"./src/index-dev.html"</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// webpack构建错误和警告通知</span>    <span class="token keyword">new</span> <span class="token class-name">webpackBuildNotifierPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      title<span class="token punctuation">:</span> <span class="token string">"前端项目"</span><span class="token punctuation">,</span>      logo<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"./favicon.png"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      suppressSuccess<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 友好提示插件</span>    <span class="token keyword">new</span> <span class="token class-name">FriendlyErrorsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      compilationSuccessInfo<span class="token punctuation">:</span> <span class="token punctuation">{</span>        messages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"You application is running here http://localhost:8080"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        notes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"请配置代理之后运行本服务"</span><span class="token punctuation">]</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//提示好的工具 进行更详细的展现</span>      onErrors<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>severity<span class="token punctuation">,</span> errors<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      clearConsole<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面只是列举了几个开发环境中常用的 plugin，其实还有很多例如线上环境可以配置 OptimizeCssAssetsPlugin 、MiniCssExtractPlugin可以进行css 优化，ProgressBarPlugin 进度条等在这里就不列举了。</p><h3 id="optimization"><a href="#optimization" class="headerlink" title="optimization"></a>optimization<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 优化配置</span><span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>    runtimeChunk<span class="token punctuation">:</span> <span class="token punctuation">{</span>      name<span class="token punctuation">:</span> <span class="token string">"runtime"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span>      chunks<span class="token punctuation">:</span> <span class="token string">"async"</span><span class="token punctuation">,</span>      minSize<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>      minChunks<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>      maxAsyncRequests<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>      maxInitialRequests<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>      name<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>        commons<span class="token punctuation">:</span> <span class="token punctuation">{</span>          chunks<span class="token punctuation">:</span> <span class="token string">"initial"</span><span class="token punctuation">,</span>          minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>          maxInitialRequests<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>          minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>          name<span class="token punctuation">:</span> <span class="token string">"commons"</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关于更多参数及更多 plugins 请参考<a href="https://webpack.docschina.org/plugins/split-chunks-plugin/" target="_blank" rel="noopener">webapck 官网</a></p><h3 id="externals"><a href="#externals" class="headerlink" title="externals"></a>externals<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 外部扩展</span><span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  externals<span class="token punctuation">:</span> <span class="token punctuation">{</span>    vue<span class="token punctuation">:</span> <span class="token string">"Vue"</span><span class="token punctuation">,</span>    <span class="token string">"vue-router"</span><span class="token punctuation">:</span> <span class="token string">"VueRouter"</span><span class="token punctuation">,</span>    vuex<span class="token punctuation">:</span> <span class="token string">"Vuex"</span><span class="token punctuation">,</span>    axios<span class="token punctuation">:</span> <span class="token string">"axios"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a>resolve<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 别名设置</span><span class="token keyword">const</span> webpackConfig  <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>    alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"@"</span><span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">".js"</span><span class="token punctuation">,</span> <span class="token string">".vue"</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="devServer"><a href="#devServer" class="headerlink" title="devServer"></a>devServer<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 开发环境启动服务配置</span><span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token punctuation">{</span>  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>    quiet<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    open<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    historyApiFallback<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    proxy<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"/api"</span><span class="token punctuation">:</span> <span class="token string">"http://localhost:3000"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    hot<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    contentBase<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"../dist/assets"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上就是在 webpack 开发中常用的配置，更多配置及优化请参考官网。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://github.com/gwuhaolin/dive-into-webpack/" target="_blank" rel="noopener">深入浅出 webpack </a></p>]]></content>
      
      
      <categories>
          
          <category> webpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> webpack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React 原理之 hook</title>
      <link href="/2019/11/09/react/library-react-hook/"/>
      <url>/2019/11/09/react/library-react-hook/</url>
      
        <content type="html"><![CDATA[<h3 id="什么是-hook"><a href="#什么是-hook" class="headerlink" title="什么是 hook"></a>什么是 hook<hr></h3><p>hook 意为钩子，当代码执行特定的时期时会自动调用 hook 中的代码和生命周期类似。</p><h3 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题<hr></h3><p>它能够在不使用类的情况下使用状态和其他功能，它的编写基本上是函数组件的方式，在这之前我们写 react 虽然都是组件式开发，提高了代码的灵活性，但是随着业务复杂化，好多业务代码不得不和各种生命周期的钩子相关联，不方便抽离，所以只能复制，粘贴进行修改。</p><p>hook 就是为了解决组件复用这个问题出现的，下面我会通过 hook 使用和原理来说明它的强大之处。</p><h3 id="补充的知识"><a href="#补充的知识" class="headerlink" title="补充的知识"></a>补充的知识<hr></h3><p>在了解 hook 之前先看一下 react 这两方面<a href="https://reactjs.org/docs/render-props.html" target="_blank" rel="noopener">渲染属性</a>和<a href="https://reactjs.org/docs/higher-order-components.html" target="_blank" rel="noopener">高阶组件</a>的知识有助于理解 hook</p><h3 id="hook-的规则"><a href="#hook-的规则" class="headerlink" title="hook 的规则"></a>hook 的规则<hr></h3><p>hook 本质就是 JavaScript 函数，但是在使用它时需要遵循两条规则</p><ul><li>只在最顶层使用 hook，不要在循环，条件或嵌套函数中调用 hook</li><li>只在 React 函数中调用 hook，不要在普通的 JavaScript 函数中调用 hook</li></ul><p>通过<a href="https://www.npmjs.com/package/eslint-plugin-react-hooks" target="_blank" rel="noopener">eslint-plugin-react-hooks</a>插件可以强制执行这两条规则</p><pre class="line-numbers language-js"><code class="language-js">npm install eslint<span class="token operator">-</span>plugin<span class="token operator">-</span>react<span class="token operator">-</span>hooks <span class="token operator">--</span>save<span class="token operator">-</span>dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 你的 ESLint 配置</span><span class="token punctuation">{</span>  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token string">"react-hooks"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">"rules"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token string">"react-hooks/rules-of-hooks"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 检查 Hook 的规则</span>    <span class="token string">"react-hooks/exhaustive-deps"</span><span class="token punctuation">:</span> <span class="token string">"warn"</span> <span class="token comment" spellcheck="true">// 检查 effect 的依赖</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="hook-的分类"><a href="#hook-的分类" class="headerlink" title="hook 的分类"></a>hook 的分类<hr></h3><p>hook分为内置的和自定义的两种类型，内置的 hook 有以下几个</p><p>基础 hook</p><ul><li>useState</li><li>useEffect</li><li>useContext</li></ul><p>额外 hook</p><ul><li>useReducer</li><li>useCallback</li><li>useMemo</li><li>useRef</li><li>useImperativeHandle</li><li>useLayoutEffect</li><li>useDebugValue</li></ul><h3 id="hook-的使用"><a href="#hook-的使用" class="headerlink" title="hook 的使用"></a>hook 的使用<hr></h3><blockquote><p>useState 返回一个 state，以及更新 state 的函数</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// hook 模式</span><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">const</span>  Example  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 声明一个叫 "count" 的 state 变量</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span>p<span class="token operator">></span>You clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>        Click me      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// class 模式</span><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>p<span class="token operator">></span>You clicked <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span> times<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>          Click me        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面来自官网的例子我们很清晰的看到没有 class、也没有了显示声明的constructor、this，而是使用了 useState 这个函数。<br>但是上面的代码有一个疑问我们怎么定义多个 state？ 让我们来看看下面两种方式</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// count</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// name</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// age</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// propertys</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>propertys<span class="token punctuation">,</span> setPropertys<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>count<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">28</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>官方建议是将不同功能的 state 抽离到 不同 useState 中。这样在后期拆分逻辑的时候更加容易控制</p><p>通过上面代码我们知道 useState 的作用是</p><ul><li>它让我们在函数组件中存储内部 state</li><li>可以通过 useState 的返回值来更新 state</li><li>根据 useState 出现的顺序来保证在使用的能找到对应的 state（useEffect 会讲），所以在上面说到 hook 声明要在最外层</li><li>hook 中没有使用 this，而是通过组件内部的「记忆单元格」列表来对当先渲染中的组件进行追踪。</li></ul><blockquote><p>useEffect 接收一个函数。默认的情况下 effect 将在每轮渲染结束后执行</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token function">useEffect</span><span class="token punctuation">(</span>didUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// hook 模式</span><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span>p<span class="token operator">></span>You clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>        Click me      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// class 模式</span><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>p<span class="token operator">></span>You clicked <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span> times<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>          Click me        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的代码对比应该知道了 useEffect，的基本作用了，我们可以在这个 hook 中发送网络请求，进行有副作用操作的计算等等。</p><p>所以可以把它当作 componentDidMount，componentDidUpdate 和 componentWillUnmount 这三个函数的组合。</p><p>回到多个 useState 的问题，我们来看一个多个 useEffect 是怎么执行和匹配的</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// hook 1</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// hook 2</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的例子看到 hook 允许我们按照代码的用途分离他们，React 将按照 effect 声明的顺序依次调用组件中的每一个 effect，否则就有可能找不到对应的标识而出错</p><p>在每次进行重新渲染的时候都要运行 Effect，而不是只在卸载组件的时候执行一次。是防止没有处理更新逻辑而导致的常见 bug，但是每次渲染后都执行清理或者执行 effect 可能会导致性能问题我们怎么来解决呢？</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 在 class 中</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevState<span class="token punctuation">.</span>count <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// hook 中</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 仅在 count 更改时更新</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>上面的例子中我我们看到在 class 中 需要我们自己在 componentDidUpdate 中处理对应的逻辑，而 hook 中被内置到了 api 中它会对前一次和后一次进行比较，通过第二个参数来跳过对 effect 的调用实现了性能优化,但是在使用中还有一些问题如</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> someProp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>someProp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 🔴 这样不安全（它调用的 `doSomething` 函数使用了 `someProp`）</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> someProp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>someProp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>someProp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ✅ 安全（我们的 effect 仅用到了 `someProp`）</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当函数（以及它所调用的函数）不引用 props、state 以及由它们衍生而来的值时，才可以通过第二个参数跳过 effect 的调用。</p><p>通过上面我们总结一下 useEffect</p><ul><li>在执行 DOM 更新之后才调用此 hook</li><li>可以告诉 react 组件需要在渲染后执行某些操作（包含副作用的一些逻辑等）</li><li>放在组件内部让我们可以在 effect 中直接访问 state 的变量（因为使用了闭包机制，保存在函数作用域中）</li><li>会在每次渲染后都执行（第一次渲染和每次更新）可以通过第二个参数进行性能优化</li><li>使用 useEffect 调度的 effect 不会阻塞浏览器更新屏幕</li><li>effect 返回一个函数是因为，可以在函数内进行清除一些副作用（引用了外部的变量上面的例子）</li></ul><p>由于文章的篇幅问题我们就不再这里进行更多hook 的介绍了，可以查看<a href="https://zh-hans.reactjs.org/docs/hooks-reference.html" target="_blank" rel="noopener">官网</a></p><h3 id="hooks-的原理"><a href="#hooks-的原理" class="headerlink" title="hooks 的原理"></a>hooks 的原理<hr></h3><p>在上面的介绍 useEffect 的时候提到过 hook 实际上是使用闭包机制，将状态行为和副作用封装在其中。</p><p>让我们来回忆一下什么是闭包，《你不知道的JS》这本书中将闭包定义为。</p><p><strong>闭包是指某个函数能够记住并访问其词法范围，即使该函数在其词法范围之外执行</strong></p><blockquote><p>useState 实现</p></blockquote><p>我们通过上面的 demo 已经知道使用 useState 时候</p><ul><li>返回一个变量和一个函数，</li><li>参数为返回变量的默认值</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _val <span class="token operator">=</span> initialValue   <span class="token keyword">function</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 闭包</span>    <span class="token keyword">return</span> _val   <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 闭包</span>    _val <span class="token operator">=</span> newVal   <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token keyword">var</span> <span class="token punctuation">[</span>foo<span class="token punctuation">,</span> setFoo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 0</span><span class="token function">setFoo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码我们看到借助 foo 和 setFoo，我们能够访问和操纵（也称为“封闭”）内部变量_val。</p><p>它们保留对 useState 的作用域的访问权限，该引用称为闭包。在 react 中这就是状态。</p><p>但是我们都知道状态必须是变量而不是函数。所以我们作出如下修改</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _val <span class="token operator">=</span> <span class="token punctuation">{</span>value <span class="token punctuation">:</span> initialValue<span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    _val<span class="token punctuation">.</span>value <span class="token operator">=</span> newVal  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 暴露 _val</span>  <span class="token keyword">return</span> <span class="token punctuation">[</span>_val<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token keyword">var</span> <span class="token punctuation">[</span>foo<span class="token punctuation">,</span> setFoo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 0}</span><span class="token function">setFoo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 1}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码似乎跟我们想要的样子更近了，但是问题在于解构 foo 时返回的是一个对象和 React.useState API 还是有区别。</p><ul><li>useState 返回的新函数设置值之后需要重新渲染页面</li><li>由于 _val 在函数内部被声明的，每次重新调用都会被初始化，所以将 _val 提到全局</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> MyReact <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 将 _val 提交全局用于保存这个值</span>  <span class="token keyword">let</span> _val   <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 模拟 render 用于改变值后需要重新渲染</span>    <span class="token function">render</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> Comp <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      Comp<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> Comp    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// useState</span>    <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>      _val <span class="token operator">=</span> _val <span class="token operator">||</span> initialValue      <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _val <span class="token operator">=</span> newVal      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span>_val<span class="token punctuation">,</span> setState<span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    click<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    render<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render:'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> AppApp <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// render: { count: 0 }</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// render: { count: 1 }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看到上面的执行结果之后，其实 useState 这个 api 就模拟成功了，下面让我看看 useEffect 的实现</p><blockquote><p>useEffect 实现</p></blockquote><p>通过上面使用 useEffect，我们知道 useEffect实际上</p><ul><li>有两个参数一个是函数，一个是可选参数-数组</li><li>根据第二个参数中是否有变化，来判断是否执行 useEffect 来提高性能</li></ul><p>那么根据上面的规则我们实现如下</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> MyReact <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> _val<span class="token punctuation">,</span> _deps <span class="token comment" spellcheck="true">// 用于保持数据，因为依赖发生改变后会重新渲染执行</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 模拟 render 函数</span>    <span class="token function">render</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> Comp <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      Comp<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> Comp    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 模拟 useEffect</span>    <span class="token function">useEffect</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> depArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> hasNoDeps <span class="token operator">=</span> <span class="token operator">!</span>depArray      <span class="token keyword">const</span> hasChangedDeps <span class="token operator">=</span> _deps <span class="token operator">?</span> <span class="token operator">!</span>depArray<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> el <span class="token operator">===</span> _deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token boolean">true</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNoDeps <span class="token operator">||</span> hasChangedDeps<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        _deps <span class="token operator">=</span> depArray      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 模拟 useState</span>    <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>      _val <span class="token operator">=</span> _val <span class="token operator">||</span> initialValue      <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _val <span class="token operator">=</span> newVal      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span>_val<span class="token punctuation">,</span> setState<span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 来调用一下，看看结果</span><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  MyReact<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effect'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    click<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    noop<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span>    render<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> AppApp <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 0</span><span class="token comment" spellcheck="true">// render {count: 0}</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 1</span><span class="token comment" spellcheck="true">// render {count: 1}</span>App<span class="token punctuation">.</span><span class="token function">noop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// // no effect run</span><span class="token comment" spellcheck="true">// render {count: 1}</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 2</span><span class="token comment" spellcheck="true">// render {count: 2}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面基本实现了 useState、 useEffect，但是也只是调用了一次，如果组件中进行多次调用呢？如下</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// hook 1</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// hook 2</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Example<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果按照多次调用我们的实现就会发生变量冲突，因为在上面的实现过程中我们共享了一个全局变量用于存储数据。</p><p>通过上面介绍 API 的时候说过它是通过组件内部的「记忆单元格」列表来对当先渲染中的组件进行追踪，最主要的是根据执行的顺序来调用的。</p><p>那么我们是不是可以通过数组来维护当前的记忆列表呢？如下</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> MyReact <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 通过数组和索引维护当前的记忆单元</span>  <span class="token keyword">let</span> hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    currentHook <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token function">render</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 运行 effects</span>      <span class="token keyword">const</span> Comp <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      Comp<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// 重置为下一次渲染</span>      currentHook <span class="token operator">=</span> <span class="token number">0</span>      <span class="token keyword">return</span> Comp    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 模拟 useEffect</span>    <span class="token function">useEffect</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> depArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> hasNoDeps <span class="token operator">=</span> <span class="token operator">!</span>depArray      <span class="token keyword">const</span> deps <span class="token operator">=</span> hooks<span class="token punctuation">[</span>currentHook<span class="token punctuation">]</span>      <span class="token keyword">const</span> hasChangedDeps <span class="token operator">=</span> deps <span class="token operator">?</span> <span class="token operator">!</span>depArray<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> el <span class="token operator">===</span> deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token boolean">true</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNoDeps <span class="token operator">||</span> hasChangedDeps<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        hooks<span class="token punctuation">[</span>currentHook<span class="token punctuation">]</span> <span class="token operator">=</span> depArray      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// 累加 currentHook</span>      currentHook<span class="token operator">++</span>     <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 模拟 useState</span>    <span class="token function">useState</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>      hooks<span class="token punctuation">[</span>currentHook<span class="token punctuation">]</span> <span class="token operator">=</span> hooks<span class="token punctuation">[</span>currentHook<span class="token punctuation">]</span> <span class="token operator">||</span> initialValue      <span class="token keyword">const</span> setStateHookIndex <span class="token operator">=</span> currentHook      <span class="token keyword">const</span> setState <span class="token operator">=</span> newState <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>hooks<span class="token punctuation">[</span>setStateHookIndex<span class="token punctuation">]</span> <span class="token operator">=</span> newState<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">//  返回 state 然后 currentHook+1</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>currentHook<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> setState<span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>  MyReact<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effect'</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> text<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> text<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    click<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    type<span class="token punctuation">:</span> txt <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setText</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span><span class="token punctuation">,</span>    noop<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span>    render<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> text <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> AppApp <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 0 foo</span><span class="token comment" spellcheck="true">// render {count: 0, text: 'foo'}</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 1 foo</span><span class="token comment" spellcheck="true">// render {count: 1, text: 'foo'}</span>App<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 1 bar</span><span class="token comment" spellcheck="true">// render {count: 1, text: 'bar'}</span>App<span class="token punctuation">.</span><span class="token function">noop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// // no effect run</span><span class="token comment" spellcheck="true">// render {count: 1, text: 'bar'}</span>App<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>App <span class="token operator">=</span> MyReact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// effect 2 bar</span><span class="token comment" spellcheck="true">// render {count: 2, text: 'bar'}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的实现我们基本了解了 hooks 的实现及原理</p><ul><li>利用了闭包机制</li><li>按照执行顺序放入维护的数组队列和索引中</li><li>当进行取值操作则按照压栈的顺序来进行取值和判断逻辑</li></ul><h3 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读<hr></h3><p><a href="https://zh-hans.reactjs.org/docs/hooks-reference.html" target="_blank" rel="noopener">Hook API</a><br><a href="https://medium.com/@dan_abramov/making-sense-of-react-hooks-fdbde8803889" target="_blank" rel="noopener">理解 React Hook</a><br><a href="https://cloud.tencent.com/developer/article/1468196" target="_blank" rel="noopener">Hook 原理</a><br><a href="https://overreacted.io/making-setinterval-declarative-with-react-hooks/" target="_blank" rel="noopener">Hook 的使用问题</a><br><a href="https://github.com/facebook/react/blob/master/packages/react/src/ReactHooks.js" target="_blank" rel="noopener">源码</a></p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React 原理之 setState 执行机制</title>
      <link href="/2019/10/09/react/library-react-state/"/>
      <url>/2019/10/09/react/library-react-state/</url>
      
        <content type="html"><![CDATA[<p>提到 react 的 setState 大家应该都很熟悉，那么下面我们以实际开发中遇到的几个问题，来引入 setState 的机制</p><h3 id="问题集合"><a href="#问题集合" class="headerlink" title="问题集合"></a>问题集合</h3><blockquote><p>setState 是同步的还是异步的？</p></blockquote><p><strong>1. 生命周期和合成事件中</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"开始调用"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 开始调用 0</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count1"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// count1 0</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count2"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// count2 0</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"结束调用"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 结束调用 0</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>2. 异步代码和原生事件中</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"开始调用"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 开始调用 0</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count1"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// count1 1</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count2"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// count2 2</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"结束调用"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 结束调用 2</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>3. 连续多次 setState</strong></p><p>如果想要在 componentDidMount 阶段立即拿到数据可以采用如下模式</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"开始调用"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count1"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"count2"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"结束调用"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行结果</p><pre class="line-numbers language-md"><code class="language-md">开始调用 0结束调用 0count1 1count2 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>上面的示例代码，我们已经看出了问题</p><ul><li>为什么连续 setState 之后值结果相同。</li><li>为什么在生命周期和合成事件中不能及时的拿到结果。</li><li>为什么异步代码和原生事件中就能拿到结果了，到底是同步的还是异步的。</li></ul><p>通过官网对<a href="https://reactjs.org/docs/react-component.html#setstate" target="_blank" rel="noopener">setState()</a>介绍，我们大概总结如下这几方面</p><ul><li>通过队列的形式保存组件状态并通知 React 这个组件和它的子组件需要重新渲</li><li>并不能总是立即更新组件，也不能保证更新后数据立即生效</li><li>有时候会批量推迟更新，如果需要在调用后直接拿到数据可利用回调或者 componentDidUpdate（官网建议）</li><li>会执行浅合并来生成一个新的 state </li><li>在同一周期靠后的 setState()将会覆盖前一个 setSate() 的值(相同属性名)</li></ul><p>通过上面的总结，我们可能已经解决了提出的问题。但实际上远远没那么简单，下面我们就来看看源码中 setState。此文章分析为 16.9 版本（ 16.9关于调度和 setState 改动还是蛮大的网上通过批处理控制标志已经在源码中不见了）</p><p>由于本人能力有限所以不会将整个流程进行分析完毕因为在setState 包括生命周期，组件渲染，事件合成，批处理等多处都会涉及。</p><p>我们通过源码来看一下 setState 的执行过程。由于源码很多很长，如果不想了解源码可以查看文章后面的总结</p><h3 id="setState入口"><a href="#setState入口" class="headerlink" title="setState入口"></a>setState入口<hr></h3><p>定义在文件 <code>packages/react/src/ReactBaseClasses.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/*** 总是使用 setState 来改变状态，而不是使用 this.state* 无法保证 setState 会立即更新，所以调用 this.state 可能还是旧值 * 无法保证对 setState 的调用将同步运行，他们可能会被批量处理* 可以提供一个可选的回调，它将在对 setState 的调用实际完成时执行* setState 第一个参数为 function 时，会在将来的某个时候和组件参数(state,props, context)一起被调用(不是同步调用)。这些值可以与this.state不同* 因为 function 可能在 receiveProps 之后 shouldComponentUpdate之前调用，new state、props、content还没更新到当前this指向的这些值。*/</span>Component<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setState <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>partialState<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">invariant</span><span class="token punctuation">(</span>    <span class="token keyword">typeof</span> partialState <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">||</span>      <span class="token keyword">typeof</span> partialState <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">||</span>      partialState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token string">"setState(...): takes an object of state variables to update or a "</span> <span class="token operator">+</span>      <span class="token string">"function which returns an object of state variables."</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token string">"setState"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们看到 setState 传入了两个参数</p><ul><li>partialState 通过 invariant 函数验证我们知道需要对象、函数、null</li><li>callback 回调函数</li></ul><p>partialState 这个参数传入的是 state，也许是整个state，也许是部分，但是最后都会被执行浅合并。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> dontMutate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dontMutate<span class="token punctuation">)</span> <span class="token punctuation">{</span>  dontMutate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  nextState <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> nextState<span class="token punctuation">,</span> partialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>nextState<span class="token punctuation">,</span> partialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来执行了 </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token string">"setState"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在这里调用了 this.updater 中的 enqueueSetState, 这是一个 setState 的队列（准确的说它是一个链表）</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">,</span> updater<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 如果一个组件有字符串引用，将在以后分配一个不同的对象</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>refs <span class="token operator">=</span> emptyObject<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 初始化默认的 updater ，但是在render 的时候被注入真正的值</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>updater <span class="token operator">=</span> updater <span class="token operator">||</span> ReactNoopUpdateQueue<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的注释我们看到 updater 有一个默认值，但是真正的值是在 render 的时候被注入的</p><h3 id="updater"><a href="#updater" class="headerlink" title="updater"></a>updater<hr></h3><p>那么接下来我们看看这个 updater 的数据结构，定义在 <code>react\packages\react-reconciler\src\ReactFiberClassComponent</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//classComponent 初始化的时候拿到的 update 结构</span><span class="token keyword">const</span> classComponentUpdater <span class="token operator">=</span> <span class="token punctuation">{</span>  isMounted<span class="token punctuation">,</span>  <span class="token function">enqueueSetState</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// inst 就是传入的 this，通过 this 获取 fiber 对象 </span>    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 计算当前时间</span>    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 异步加载的设置</span>    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 根据超时时间设置任务的优先级</span>    <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>      currentTime<span class="token punctuation">,</span>      fiber<span class="token punctuation">,</span>      suspenseConfig<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 创建 update 结构</span>    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 传进来的 state</span>    update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// callback 就是 setState 的回调函数 setstate({},()=>{})</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> undefined <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>revertPassiveEffectsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 将 update 结构放入队列</span>    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 任务调度流程</span>    <span class="token function">scheduleWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 替换 state</span>  <span class="token function">enqueueReplaceState</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>      currentTime<span class="token punctuation">,</span>      fiber<span class="token punctuation">,</span>      suspenseConfig<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>    update<span class="token punctuation">.</span>tag <span class="token operator">=</span> ReplaceState<span class="token punctuation">;</span>    update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> undefined <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>revertPassiveEffectsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scheduleWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 强制更新 state</span>  <span class="token function">enqueueForceUpdate</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>      currentTime<span class="token punctuation">,</span>      fiber<span class="token punctuation">,</span>      suspenseConfig<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>    update<span class="token punctuation">.</span>tag <span class="token operator">=</span> ForceUpdate<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> undefined <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>revertPassiveEffectsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scheduleWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来我们主要看一下 enqueueSetState，通过上面的注释我们很清楚的知道每个方法的作用。那么我们来总结一下 enqueueSetState 的流程</p><ul><li>获取 this 上的 fiber 对象</li><li>计算 currentTime 时间</li><li>根据 fiber 对象和 currentTime 时间，计算超时时间 </li><li>根据 expirationTime 创建 update 对象</li><li>将传入的 payload 也就是 state 赋值到 update.payload</li><li>如果 callback 存在将 callback 赋值到 update.callback</li><li>将 update 推入 updateQueue 队列</li><li>进行任务调度</li></ul><p>关于 requestCurrentTime、 requestCurrentSuspenseConfig、computeExpirationForFiber 在这里就不多做解释。请查看<a href="https://www.studyfe.cn/2019/10/04/react/library-react-fiber01/"> FiberRoot 构建过程</a>和<a href="https://www.studyfe.cn/2019/10/06/react/library-react-fiber02/">FiberRoot 调度过程</a></p><h3 id="createUpdate"><a href="#createUpdate" class="headerlink" title="createUpdate "></a>createUpdate <hr></h3><p>上面代码 执行一共有三个方法分别是 enqueueSetState、 enqueueReplaceState、enqueueForceUpdate，他们主要是的区别就是在于 tag 上。也就是 React 的状态更新分为四种情况</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> UpdateState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ReplaceState <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ForceUpdate <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> CaptureUpdate <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>  suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Update<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//超时时间</span>    expirationTime<span class="token punctuation">,</span>    suspenseConfig<span class="token punctuation">,</span>    tag<span class="token punctuation">:</span> UpdateState<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//0更新 1替换 2强制更新 3捕获更新</span>    <span class="token comment" spellcheck="true">//更新的 state</span>    payload<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//对应的回调，比如setState({}, callback )</span>    callback<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//指向下一个更新</span>    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//指向下一个side effect</span>    nextEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来我们主要来看看 enqueueUpdate 这个函数,也就是将 update 推入 updateQueue 队列</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 每次 setState 都会 update，每次 update，都会入加入 updateQueue</span><span class="token keyword">export</span> <span class="token keyword">function</span> enqueueUpdate<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">(</span>fiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span> update<span class="token punctuation">:</span> Update<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 更新队列是延迟创建的.</span>  <span class="token comment" spellcheck="true">// fiber => current</span>  <span class="token comment" spellcheck="true">// alternate => workInProgress</span>  <span class="token keyword">const</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// current 队列</span>  <span class="token keyword">let</span> queue1<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// alternate 队列</span>  <span class="token keyword">let</span> queue2<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// current到alternate即workInProgress有一个映射关系</span>  <span class="token comment" spellcheck="true">// 要保证current和workInProgress的updateQueue是一致的</span>  <span class="token comment" spellcheck="true">// 如果 alternate 队列是空的 </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 只有一个 fiber.</span>    queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>    queue2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//如果 current 仍为空，则初始化更新队列</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue1 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">createUpdateQueue</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果 alternate 不为空 则分别更新各自的队列</span>    queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>    queue2 <span class="token operator">=</span> alternate<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue1 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue2 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// queue1 和 queue2 的 fiber 都没有更新队列。则创建一个新队列.</span>        queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">createUpdateQueue</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">;</span>        queue2 <span class="token operator">=</span> alternate<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">createUpdateQueue</span><span class="token punctuation">(</span>          alternate<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果 queue2存在，则利用 cloneUpdateQueue 克隆一个队列到 queue1</span>        queue1 <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">cloneUpdateQueue</span><span class="token punctuation">(</span>queue2<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue2 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              queue2 <span class="token operator">=</span> alternate<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token function">cloneUpdateQueue</span><span class="token punctuation">(</span>queue1<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Both owners have an update queue.</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue2 <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> queue1 <span class="token operator">===</span> queue2<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 只有一个队列.</span>    <span class="token function">appendUpdateToQueue</span><span class="token punctuation">(</span>queue1<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 将更新附加到两个队列，</span>     <span class="token comment" spellcheck="true">// 同时考虑到列表的持久结构不希望将相同的更新添加多次</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue1<span class="token punctuation">.</span>lastUpdate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> queue2<span class="token punctuation">.</span>lastUpdate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 其中一个队列不是空的。将更新添加到两个队列.</span>      <span class="token function">appendUpdateToQueue</span><span class="token punctuation">(</span>queue1<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">appendUpdateToQueue</span><span class="token punctuation">(</span>queue2<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 两个队列都不是空的。由于结构共享，这两个列表中的最新更新是相同的。</span>      <span class="token comment" spellcheck="true">// 因此，只向其中一个列表追加。</span>      <span class="token function">appendUpdateToQueue</span><span class="token punctuation">(</span>queue1<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 要更新 queue2 的 `lastUpdate` 指针.</span>      queue2<span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> update<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总结一下上面的注释</p><ul><li>queue1 是 fiber.updateQueue;</li><li>queue2 是 alternate.updateQueue</li><li>如果都为 null，则调用 createUpdateQueue() 获取初始队列</li><li>如果有一个为 null，则调用 cloneUpdateQueue() 从对方中获取队列</li><li>如果都不为 null，则调用 appendUpdateToQueue 将 update 作为 lastUpdate</li></ul><h3 id="createUpdateQueue"><a href="#createUpdateQueue" class="headerlink" title="createUpdateQueue "></a>createUpdateQueue <hr></h3><p>我们先来看看如下代码 createUpdateQueue 创建更新队列</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> createUpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">(</span>baseState<span class="token punctuation">:</span> State<span class="token punctuation">)</span><span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> queue<span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 更新后的 state</span>    baseState<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 队列中的第一个 update</span>    firstUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 队列中的最后一个 update</span>    lastUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 队列中第一个捕获更新的 update</span>    firstCapturedUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 队列中最后一个捕获更新的 update</span>    lastCapturedUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 第一个side effect</span>    firstEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 最后一个side effect</span>    lastEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 第一个side 捕获更新 effect</span>    firstCapturedEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 最后一个side 捕获更新 effect</span>    lastCapturedEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> queue<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的注释我们来整理一下</p><ul><li><p>baseState 在组件 setState 后，渲染并更新state，在下次更新时，拿的就是这次更新过的state</p></li><li><p>firstUpdate 和 lastUpdate 之间的 update 通过上个 update 的 next 串联</p></li></ul><h3 id="cloneUpdateQueue"><a href="#cloneUpdateQueue" class="headerlink" title="cloneUpdateQueue"></a>cloneUpdateQueue</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 克隆更新队列</span><span class="token keyword">function</span> cloneUpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">(</span>  currentQueue<span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> queue<span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>    baseState<span class="token punctuation">:</span> currentQueue<span class="token punctuation">.</span>baseState<span class="token punctuation">,</span>    firstUpdate<span class="token punctuation">:</span> currentQueue<span class="token punctuation">.</span>firstUpdate<span class="token punctuation">,</span>    lastUpdate<span class="token punctuation">:</span> currentQueue<span class="token punctuation">.</span>lastUpdate<span class="token punctuation">,</span>    firstCapturedUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    lastCapturedUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    firstEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    lastEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    firstCapturedEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    lastCapturedEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> queue<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过以上代码我们知道 UpdateQueue 实际上是一个<a href="https://github.com/trekhleb/javascript-algorithms/blob/master/README.zh-CN.md" target="_blank" rel="noopener">链表</a></p><img src="/images/updateQueue.jpg"><p>通过上面的图片展示,我们可以很清楚的看见这是一个链表结构。当然具体的操作链表的方法我就不在这里展开了。</p><p>具体的更新队列步骤如下</p><ul><li>创建更新队列 createUpdateQueue()</li><li>更新 state getStateFromUpdate()</li><li>处理更新 processUpdateQueue()</li><li>提交更新 commitUpdateQueue()</li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>react 事件系统中和通过生命周期阶段调用的 setState 在推入队列前面的阶段实际上都可以属于同步阶段，但在执行批处理到渲染阶段都会触发批处理由于自定义的一套事件系统所以都是异步。</p><p>使用原生事件监听和 settimeout 这种当时不会触发此事件系统 ，也不会触发批处理，所以可以更新 this.setState 所以是同步的。</p><h3 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h3><p> <a href="https://stackoverflow.com/questions/48563650/does-react-keep-the-order-for-state-updates/48610973#48610973" target="_blank" rel="noopener">为什么会批量执行</a><br> <a href="https://github.com/facebook/react/issues/9439" target="_blank" rel="noopener">某些情况下 setState 的工作方式</a><br> <a href="https://github.com/facebook/react/issues/11527#issuecomment-360199710" target="_blank" rel="noopener">为什么不直接更新 this.state</a></p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React 原理之 FiberRoot 调度过程</title>
      <link href="/2019/10/06/react/library-react-fiber02/"/>
      <url>/2019/10/06/react/library-react-fiber02/</url>
      
        <content type="html"><![CDATA[<p>上篇文章我们对 fiber 的创建做了大概的了解，并且还引入了 scheduleWork 函数。scheduleWork 函数实际执行了如下几个重要的函数</p><ul><li>checkForNestedUpdates 判断是否有无限循环的 update</li><li>markUpdateTimeFromFiberToRoot 找到 rootFiber 并遍历更新子节点的 expirationTime </li><li>checkForInterruption 判断是否有高优先级任务打断当前正在执行的任务</li><li>schedulePendingInteractions 立即执行调度任务</li><li>scheduleCallbackForRoot 异步任务立即执行调度任务</li><li>rootsWithPendingDiscreteUpdates 得到 DiscreteTime</li></ul><h2 id="checkForNestedUpdates"><a href="#checkForNestedUpdates" class="headerlink" title="checkForNestedUpdates "></a>checkForNestedUpdates <hr></h2><blockquote><p>checkForNestedUpdates 最大更新深度为 50，防止无限循环 </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> NESTED_UPDATE_LIMIT <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span><span class="token keyword">let</span> nestedUpdateCount<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>nestedUpdateCount <span class="token operator">></span> NESTED_UPDATE_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>    nestedUpdateCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    rootWithNestedUpdates <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token function">invariant</span><span class="token punctuation">(</span>      <span class="token boolean">false</span><span class="token punctuation">,</span>      <span class="token string">'Maximum update depth exceeded. This can happen when a component '</span> <span class="token operator">+</span>        <span class="token string">'repeatedly calls setState inside componentWillUpdate or '</span> <span class="token operator">+</span>        <span class="token string">'componentDidUpdate. React limits the number of nested updates to '</span> <span class="token operator">+</span>        <span class="token string">'prevent infinite loops.'</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="markUpdateTimeFromFiberToRoot"><a href="#markUpdateTimeFromFiberToRoot" class="headerlink" title="markUpdateTimeFromFiberToRoot "></a>markUpdateTimeFromFiberToRoot <hr></h2><blockquote><p>markUpdateTimeFromFiberToRoot </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">markUpdateTimeFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//如果fiber对象的过期时间小于 expirationTime，则更新fiber对象的过期时间</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">//向上遍历父节点，直到root节点，在遍历的过程中更新子节点的expirationTime</span>  <span class="token keyword">let</span> node <span class="token operator">=</span> fiber<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 树的顶层节点 root</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    root <span class="token operator">=</span> fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      alternate <span class="token operator">=</span> node<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>        node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>          alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>          alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime        <span class="token punctuation">)</span> <span class="token punctuation">{</span>          alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>        alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>        alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">//如果是顶层 rootFiber，结束循环</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>        root <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Update the first and last pending expiration times in this root</span>    <span class="token keyword">const</span> firstPendingTime <span class="token operator">=</span> root<span class="token punctuation">.</span>firstPendingTime<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">></span> firstPendingTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>      root<span class="token punctuation">.</span>firstPendingTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> lastPendingTime <span class="token operator">=</span> root<span class="token punctuation">.</span>lastPendingTime<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastPendingTime <span class="token operator">===</span> NoWork <span class="token operator">||</span> expirationTime <span class="token operator">&lt;</span> lastPendingTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>      root<span class="token punctuation">.</span>lastPendingTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> root<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的函数我们知道此函数有如下作用</p><ul><li>更新 fiber 对象的 expirationTime</li><li>根据 fiber.return 向上遍历寻找 FiberRoot，并更新父对象的子节点的 childExpirationTime</li><li>更新该 rootFiber 的新老挂起时间</li><li>返回 FiberRoot</li></ul><h2 id="checkForInterruption"><a href="#checkForInterruption" class="headerlink" title="checkForInterruption "></a>checkForInterruption <hr></h2><blockquote><p>checkForInterruption</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">checkForInterruption</span><span class="token punctuation">(</span>  fiberThatReceivedUpdate<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>  updateExpirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    enableUserTimingAPI <span class="token operator">&amp;&amp;</span>    workInProgressRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>    updateExpirationTime <span class="token operator">></span> renderExpirationTime  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 打断当前任务，优先执行优先级高的任务</span>    interruptedBy <span class="token operator">=</span> fiberThatReceivedUpdate<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="schedulePendingInteractions"><a href="#schedulePendingInteractions" class="headerlink" title="schedulePendingInteractions"></a>schedulePendingInteractions<hr></h2><blockquote><p>schedulePendingInteractions</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 如果是同步任务并且是初次渲染的话，则会先执行</span>  <span class="token comment" spellcheck="true">// __interactionsRef 设置当前跟踪的 interactions 栈</span>  <span class="token function">scheduleInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">,</span> __interactionsRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>scheduleInteractions</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 和 schedule 的交互</span><span class="token keyword">function</span> <span class="token function">scheduleInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">,</span> interactions<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>interactions<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> pendingInteractionMap <span class="token operator">=</span> root<span class="token punctuation">.</span>pendingInteractionMap<span class="token punctuation">;</span>    <span class="token keyword">const</span> pendingInteractions <span class="token operator">=</span> pendingInteractionMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingInteractions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 遍历并更新还未调度的同步任务的数量</span>      interactions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>interaction <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pendingInteractions<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>interaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          interaction<span class="token punctuation">.</span>__count<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        pendingInteractions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>interaction<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 重新设置 fiberRoot 上的 pendingInteractionMap</span>      pendingInteractionMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>interactions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 获取当前调度中同步任务的数量</span>      interactions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>interaction <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        interaction<span class="token punctuation">.</span>__count<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> subscriber <span class="token operator">=</span> __subscriberRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> threadID <span class="token operator">=</span> <span class="token function">computeThreadID</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 利用线程去查看同步的更新任务是否会报错</span>      subscriber<span class="token punctuation">.</span><span class="token function">onWorkScheduled</span><span class="token punctuation">(</span>interactions<span class="token punctuation">,</span> threadID<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码 scheduleInteractions 的主要作用是</p><ul><li>获取 fiber 上的 pendingInteractionMap 属性</li><li>通过 pendingInteractionMap 获取 expirationTime</li><li>获取每次 schedule 所需的 update 任务的集合</li></ul><h2 id="scheduleCallbackForRoot"><a href="#scheduleCallbackForRoot" class="headerlink" title="scheduleCallbackForRoot"></a>scheduleCallbackForRoot<hr></h2><p>在render()之后，立即执行调度任务</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">scheduleCallbackForRoot</span><span class="token punctuation">(</span>  root<span class="token punctuation">:</span> FiberRoot<span class="token punctuation">,</span>  priorityLevel<span class="token punctuation">:</span> ReactPriorityLevel<span class="token punctuation">,</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 获取root的回调过期时间</span>  <span class="token keyword">const</span> existingCallbackExpirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackExpirationTime<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 更新root的回调过期时间</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackExpirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 当新的expirationTime比已存在的callback的expirationTime优先级更高的时候</span>    <span class="token keyword">const</span> existingCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 打断已存在的 callback）</span>      <span class="token comment" spellcheck="true">// 将已存在的 callback 节点从链表中移除</span>      <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 更新callbackExpirationTime</span>    root<span class="token punctuation">.</span>callbackExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 如果是同步任务</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 在临时队列中同步被调度的 callback</span>      root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span>        runRootCallback<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>          <span class="token keyword">null</span><span class="token punctuation">,</span>          root<span class="token punctuation">,</span>          renderRoot<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        <span class="token operator">!</span>disableSchedulerTimeoutBasedOnReactExpirationTime <span class="token operator">&amp;&amp;</span>        expirationTime <span class="token operator">!==</span> Never      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        options <span class="token operator">=</span> <span class="token punctuation">{</span>timeout<span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// callbackNode 即经过处理包装的新任务</span>      root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>        priorityLevel<span class="token punctuation">,</span>        runRootCallback<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>          <span class="token keyword">null</span><span class="token punctuation">,</span>          root<span class="token punctuation">,</span>          renderRoot<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>        options<span class="token punctuation">,</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        enableUserTimingAPI <span class="token operator">&amp;&amp;</span>        expirationTime <span class="token operator">!==</span> Sync <span class="token operator">&amp;&amp;</span>        <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 开始调度 callback 的标志</span>        <span class="token function">startRequestCallbackTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 跟踪队列，并计数检查是否报错</span>  <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上述代码我们知道 scheduleCallbackForRoot 的主要作用是</p><ul><li>对比任务优先级如果新的 scheduleCallback 的优先级更高时，中断当前任务(cancelCallback）</li><li>如果是同步任务，调用 scheduleSyncCallback 在临时队列中进行调度，否则更新调度队列的状态</li><li>设置开始调度的时间节点并通过 schedulePendingInteractions 计数跟踪队列的更新情况</li></ul><p>通过上面 scheduleCallbackForRoot 方法，我们知道 Fiber 机制可以为每一个任务进行优先级排序，同时可以根据任务的优先级中断正在执行的任务，当优先级高的任务执行之后，还可以继续之前被中断的任务。在这个期间可以记录任务调度执行到了哪里。那么下面我们具体看看 scheduleCallbackForRoot 调用的几个重要的方法</p><h3 id="cancelCallback"><a href="#cancelCallback" class="headerlink" title="cancelCallback"></a>cancelCallback</h3><blockquote><p>cancelCallback 中断正在执行的任务</p></blockquote><p>定义在文件 /packages/react-reconciler/src/SchedulerWithReactIntegration.js</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cancelCallback</span><span class="token punctuation">(</span>callbackNode<span class="token punctuation">:</span> mixed<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackNode <span class="token operator">!==</span> fakeCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">Scheduler_cancelCallback</span><span class="token punctuation">(</span>callbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 引入的单独 Scheduler 库</span><span class="token keyword">const</span> <span class="token punctuation">{</span> unstable_cancelCallback<span class="token punctuation">:</span> Scheduler_cancelCallback <span class="token punctuation">}</span> <span class="token operator">=</span> Scheduler<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 定义在 packages/scheduler/src/Scheduler.js</span><span class="token keyword">function</span> <span class="token function">unstable_cancelCallback</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 获取 callbackNode 的 next 节点 </span>  <span class="token keyword">var</span> next <span class="token operator">=</span> task<span class="token punctuation">.</span>next<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 如果等于 null 说明当前节点已经不存在</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Already cancelled.</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 如果 task === next 相等说明链表结构中只有一个 callbackNode </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 重置 firstTask / firstDelayedTask</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      firstTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> firstDelayedTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      firstDelayedTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 将 firstTask / firstDelayedTask 指向下一个节点</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      firstTask <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">===</span> firstDelayedTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      firstDelayedTask <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 链表操作</span>    <span class="token keyword">var</span> previous <span class="token operator">=</span> task<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>    previous<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>    next<span class="token punctuation">.</span>previous <span class="token operator">=</span> previous<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 删除已经存在的 callbackNode</span>  task<span class="token punctuation">.</span>next <span class="token operator">=</span> task<span class="token punctuation">.</span>previous <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码的上下文我们知道，通过操作 schedule 链表，通过对比正在执行任务的优先级来确定是否要移除正在执行的 callbackNode，将节点指向下一个调度任务</p><h3 id="scheduleSyncCallback"><a href="#scheduleSyncCallback" class="headerlink" title="scheduleSyncCallback "></a>scheduleSyncCallback <hr></h3><blockquote><p>scheduleSyncCallback 同步任务，将调度任务放入队列，并返回临时队列</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">:</span> SchedulerCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 将此回调推入内部队列，如果同步队列为空，则初始化同步队列并在</span>  <span class="token comment" spellcheck="true">// 在下一次调度的时候刷新，或者更早的时候调用‘flushSyncCallbackQueue’。</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>syncQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    syncQueue <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 最快在下一次刷新队列</span>    immediateQueueCallbackNode <span class="token operator">=</span> <span class="token function">Scheduler_scheduleCallback</span><span class="token punctuation">(</span>      Scheduler_ImmediatePriority<span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 循环遍历 syncQueue，并更新节点的isSync状态，更新同步队列</span>      flushSyncCallbackQueueImpl<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//如果同步队列不为空，则将 callback push 到队列</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// push 现有队列。不需要调度 callback，因为在创建队列时已经调度了回调</span>    syncQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> fakeCallbackNode<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="scheduleCallback"><a href="#scheduleCallback" class="headerlink" title="scheduleCallback"></a>scheduleCallback<hr></h3><blockquote><p>scheduleCallback 异步任务，对 callback 进行包装返回新的 task 并更新调度队列的状态</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 调用 Scheduler_scheduleCallback</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>  reactPriorityLevel<span class="token punctuation">:</span> ReactPriorityLevel<span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> SchedulerCallback<span class="token punctuation">,</span>  options<span class="token punctuation">:</span> SchedulerCallbackOptions <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">reactPriorityToSchedulerPriority</span><span class="token punctuation">(</span>reactPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">Scheduler_scheduleCallback</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 引入单独 scheduler 库</span><span class="token keyword">const</span> <span class="token punctuation">{</span> unstable_scheduleCallback<span class="token punctuation">:</span> Scheduler_scheduleCallback <span class="token punctuation">}</span> <span class="token operator">=</span> Scheduler<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 定义在 packages/scheduler/src/Scheduler.js</span><span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> startTime<span class="token punctuation">;</span>  <span class="token keyword">var</span> timeout<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 在上面执行同步任务队列为空的时候也调用了一次 </span>  <span class="token comment" spellcheck="true">// scheduleCallback 但传入了两个参数</span>  <span class="token comment" spellcheck="true">// 所以可以用来区分来区分执行的时候执行时机</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> options <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> delay <span class="token operator">=</span> options<span class="token punctuation">.</span>delay<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> delay <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> delay <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      startTime <span class="token operator">=</span> currentTime <span class="token operator">+</span> delay<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    timeout <span class="token operator">=</span>      <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>timeout <span class="token operator">===</span> <span class="token string">'number'</span>        <span class="token operator">?</span> options<span class="token punctuation">.</span>timeout        <span class="token punctuation">:</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**    * 根据传入任务的优先级来判断当前执行的 timeout    * 立即执行 ImmediatePriority timeout -1     * 用户交互优先级 UserBlockingPriority  timeout 250    * 普通优先级 NormalPriority timeout 5000    * 闲置的优先级 IdlePriority timeout 1073741823    * 低优先级 LowPriority timeout 10000    */</span>    timeout <span class="token operator">=</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>    startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// expirationTime = 当前时间 + 5s 后</span>  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> timeout<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 组成新的 task 结构</span>  <span class="token keyword">var</span> newTask <span class="token operator">=</span> <span class="token punctuation">{</span>    callback<span class="token punctuation">,</span>    priorityLevel<span class="token punctuation">,</span>    startTime<span class="token punctuation">,</span>    expirationTime<span class="token punctuation">,</span>    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    previous<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 延期任务</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">></span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 将延期的 task 插入到队列中 </span>    <span class="token function">insertDelayedTask</span><span class="token punctuation">(</span>newTask<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//判断调度队列的 firstTask 任务为 null，并且 firstDelayedTask 调度队列的头任务正好是 newTask，</span>    <span class="token comment" spellcheck="true">//说明所有任务均延期，并且此时的任务是第一个延期任务</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTask <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> firstDelayedTask <span class="token operator">===</span> newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 如果延迟调度开始的 flag 为 true，则取消定时的时间</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Cancel an existing timeout.</span>        <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// Schedule a timeout.</span>      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 正常任务</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 按照正常的执行任务插入 task </span>    <span class="token function">insertScheduledTask</span><span class="token punctuation">(</span>newTask<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 是否更新调度的标志</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPerformingWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 更新调度执行</span>      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> newTask<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的代码我们知道 Scheduler_scheduleCallback 的主要作用是</p><ul><li>确定当前时间 startTime 和延迟更新时间 timeout</li><li>新建 newTask 包装对象</li><li>如果是延迟任务则将 newTask 放入延迟调度队列并执行 requestHostTimeout</li><li>如果是正常任务则将 newTask 放入正常调度队列并执行 requestHostCallback</li><li>返回新的 newTask</li></ul><p>从上面的段落总结中我们看到 Scheduler_scheduleCallback 的作用，根据任务的不同去执行了 requestHostTimeout 和 requestHostCallback，由于这两个方法分为非 DOM 环境和 DOM 环境，我们只看 DOM 环境的实现即可</p><p>定义在文件 /packages/scheduler/src/forks/SchedulerHostConfig.default.js</p><h3 id="requestHostTimeout"><a href="#requestHostTimeout" class="headerlink" title="requestHostTimeout "></a>requestHostTimeout <hr></h3><blockquote><p>requestHostTimeout</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handleTimeout</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 延期开启的 flag</span>  isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 是否开始更新调度的 flag</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果第一个任务不为 null </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 如果第一个延时任务不为null</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firstDelayedTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 继续递归执行 requestHostTimeout</span>      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>        handleTimeout<span class="token punctuation">,</span>        firstDelayedTask<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">,</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>requestHostTimeout <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>  taskTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的代码我理解为如果是延期的任务，插入队列中。通过计算延期任务的时间和当前的最新时间来递归执行 requestHostTimeout，直到 isHostTimeoutScheduled 标志为 true 执行取消定时器函数。当 startTime &lt; currentTime后插入正常任务队列执行 requestHostCallback</p><h3 id="requestHostCallback"><a href="#requestHostCallback" class="headerlink" title="requestHostCallback"></a>requestHostCallback</h3><blockquote><p>requestHostCallback 在每一帧内执行调度任务</p></blockquote><pre class="line-numbers language-js"><code class="language-js">requestHostCallback <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// callback 就是 flushWork 回调用 workLoop 来执行任务</span>  scheduledHostCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 默认为 false</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableMessageLoopImplementation<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMessageLoopRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>      isMessageLoopRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 默认为 false 当执行一次循环后 isRAFLoopRunning 为 true </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRAFLoopRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 开始一个 rAF (requestAnimationFrame) 循环。</span>      isRAFLoopRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>rAFTime <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 默认 false </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestIdleCallbackBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">cancelIdleCallback</span><span class="token punctuation">(</span>idleCallbackID<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 默认 false </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestTimerEventBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">clearTimeout</span><span class="token punctuation">(</span>idleTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">onAnimationFrame</span><span class="token punctuation">(</span>rAFTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 如果错过了上一个 vsync，下一个 rAF 可能就不会出现在另一个帧上</span>      <span class="token comment" spellcheck="true">// 为了争取尽可能多的空闲时间，使用 requestIdleCallback 发布一个回调</span>      <span class="token comment" spellcheck="true">// 如果帧中还有空闲时间，它应该被触发。这样就不会影响页面的刷新渲染，用户不会感到卡顿</span>      <span class="token keyword">let</span> idleCallbackID<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>requestIdleCallbackBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>        idleCallbackID <span class="token operator">=</span> <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>          <span class="token keyword">function</span> <span class="token function">onIdleCallbackBeforeFirstFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestTimerEventBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">clearTimeout</span><span class="token punctuation">(</span>idleTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            frameDeadline <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> frameLength<span class="token punctuation">;</span>            <span class="token function">performWorkUntilDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// 如果这是在 rAF 之前触发的，则很可能表示在下一次 vsync 之前有空闲时间。</span>      <span class="token keyword">let</span> idleTimeoutID<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>requestTimerEventBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>        idleTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">onTimerEventBeforeFirstFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>requestIdleCallbackBeforeFirstFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">cancelIdleCallback</span><span class="token punctuation">(</span>idleCallbackID<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          frameDeadline <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> frameLength<span class="token punctuation">;</span>          <span class="token function">performWorkUntilDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上面的代码中大概知道 requestHostCallback 主要是调用了如下几个方法</p><ul><li>requestAnimationFrame</li><li>onAnimationFrame</li><li>requestIdleCallback</li><li>performWorkUntilDeadline</li></ul><p>下面我们对上面的方法慢慢拆解</p><blockquote><p>requestAnimationFrame 定义为 window.requestAnimationFrame</p></blockquote><p>该方法告诉浏览器你希望执行一个动画，并且要求浏览器在下次重绘之前调用指定的回调函数更新动画。该方法需要传入一个回调函数作为参数，该回调函数会在浏览器下一次重绘之前执行（<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame" target="_blank" rel="noopener">来至MDN</a>）</p><blockquote><p>onAnimationFrame</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> onAnimationFrame <span class="token operator">=</span> rAFTime <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledHostCallback <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    prevRAFTime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    prevRAFInterval <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    isRAFLoopRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 在帧的开头安排下一个动画回调</span>  <span class="token comment" spellcheck="true">// 这样能够确保它在尽可能早的框架内被触发，如果等到帧的末尾才发布回调</span>  <span class="token comment" spellcheck="true">// 那么就冒着浏览器跳过一帧的风险，直到那之后的帧才触发回调</span>  <span class="token comment" spellcheck="true">// 如果调度器队列在帧结束时不是空的，它将继续在回调中刷新</span>  <span class="token comment" spellcheck="true">// 如果队列是空的，那么它将立即退出</span>  isRAFLoopRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>nextRAFTime <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>rAFTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">onAnimationFrame</span><span class="token punctuation">(</span>nextRAFTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> onTimeout <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    frameDeadline <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> frameLength <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token function">performWorkUntilDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    rAFTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>onTimeout<span class="token punctuation">,</span> frameLength <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  rAFTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>onTimeout<span class="token punctuation">,</span> frameLength <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    prevRAFTime <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>    <span class="token comment" spellcheck="true">// 确保这次 rAF 的时间与上次不同，保证不再同一帧内同时执行任务</span>    rAFTime <span class="token operator">-</span> prevRAFTime <span class="token operator">></span> <span class="token number">0.1</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> rAFInterval <span class="token operator">=</span> rAFTime <span class="token operator">-</span> prevRAFTime<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fpsLocked <span class="token operator">&amp;&amp;</span> prevRAFInterval <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 观察两个连续的帧间隔。使用它来动态调整帧速率。</span>      <span class="token comment" spellcheck="true">// 如果一帧很长，那么下一帧就会很短。如果连续两帧都很短，那就说明我们的帧率比当前优化的帧率要高。</span>      <span class="token comment" spellcheck="true">// 动态调整帧率。例如，如果我们在 120h z显示器或 90hz VR 显示器上运行。取两个中的最大值，以防其中一个由于错过帧而异常</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>rAFInterval <span class="token operator">&lt;</span> frameLength <span class="token operator">&amp;&amp;</span> prevRAFInterval <span class="token operator">&lt;</span> frameLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>        frameLength <span class="token operator">=</span>          rAFInterval <span class="token operator">&lt;</span> prevRAFInterval <span class="token operator">?</span> prevRAFInterval <span class="token punctuation">:</span> rAFInterval<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>frameLength <span class="token operator">&lt;</span> <span class="token number">8.33</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// 防御性编码。不支持高于120hz的帧速率</span>          <span class="token comment" spellcheck="true">// 如果计算出的帧长度小于8，这可能是一个bug </span>          frameLength <span class="token operator">=</span> <span class="token number">8.33</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    prevRAFInterval <span class="token operator">=</span> rAFInterval<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  prevRAFTime <span class="token operator">=</span> rAFTime<span class="token punctuation">;</span>  frameDeadline <span class="token operator">=</span> rAFTime <span class="token operator">+</span> frameLength<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 使用 postMessage 技巧将空闲的任务延迟到重新绘制之后</span>  port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>requestIdleCallback 定义为 window.requestIdleCallback</p></blockquote><p>window.requestIdleCallback()方法将在浏览器的空闲时段内调用的函数排队。这使开发人员能够在主事件循环上执行后台和低优先级工作，而不会影响延迟关键事件，如动画和输入响应。函数一般会按先进先调用的顺序执行，然而，如果回调函数指定了执行超时时间timeout，则有可能为了在超时前执行函数而打乱执行顺序。<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" target="_blank" rel="noopener">来至MDN</a></p><blockquote><p>performWorkUntilDeadline </p></blockquote><p>由于 enableMessageLoopImplementation 为 false 所以我们只看 else 中的逻辑</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> performWorkUntilDeadline <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableMessageLoopImplementation<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 当前有任务需要执行</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledHostCallback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// </span>      <span class="token keyword">const</span> hasTimeRemaining <span class="token operator">=</span> frameDeadline <span class="token operator">-</span> currentTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 开始执行任务</span>        <span class="token keyword">const</span> hasMoreWork <span class="token operator">=</span> <span class="token function">scheduledHostCallback</span><span class="token punctuation">(</span>          hasTimeRemaining<span class="token punctuation">,</span>          currentTime<span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 调度任务结束</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasMoreWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>          scheduledHostCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 浏览器绘制的标志</span>    needsPaint <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2<span class="token punctuation">;</span>channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> performWorkUntilDeadline<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过拆解注释我们总结一下 requestHostCallback 的主要作用</p><ul><li>利用浏览器的 window.requestAnimationFrame API 在每一帧之后的空闲时间开始执行任务。</li><li>onAnimationFrame 会加入 event loop，进行递归也就是每一帧执行一次，当下一帧执行 onAnimationFrame 的时候，之前就已经计算出了 nextRAFTime。直到任务队列为空。</li><li>在执行 onAnimationFrame 期间对 frameDeadline 进行计算 <code>frameDeadline = getCurrentTime() + frameLength / 2</code> 得到当前帧的截止时间（33.33/2）16.7ms</li><li>如果错过了上一个requestAnimationFrame，则通过 window.requestIdleCallback 在发布一个回调，在帧中还有空余时间的时候会被触发，这样用户就不会感觉到卡顿。</li><li>最后通过 onmessage 接受 postMessage 指令, 触发消息事件的执行最终执行 scheduledHostCallback（也就是 flushWork）</li></ul><p>上面说到 scheduledHostCallback 实际上就是 flushWork，那么接下来我们分析 flushWork </p><h3 id="flushWork"><a href="#flushWork" class="headerlink" title="flushWork"></a>flushWork</h3><blockquote><p>flushWork</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">flushWork</span><span class="token punctuation">(</span>hasTimeRemaining<span class="token punctuation">,</span> initialTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 调度任务是否执行的标志</span>  isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>    isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> currentTime <span class="token operator">=</span> initialTime<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 检查是否有没过期的任务，并把它们加入到新的调度队列中</span>  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  isPerformingWork <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// hasTimeRemaining = frameDeadline - currentTime > 0</span>    <span class="token comment" spellcheck="true">// 在一帧内执行的时间超时</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasTimeRemaining<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 一直执行过期的任务，直到到达一个不过期的任务为止</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>        firstTask <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>        <span class="token comment" spellcheck="true">// 如果 firstTask.expirationTime一直 >= currentTime，则递归执行 flushTask 方法</span>        firstTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime <span class="token operator">&amp;&amp;</span>        <span class="token operator">!</span><span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">flushTask</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 不断刷新回调，直到在帧中耗尽时间</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>          <span class="token function">flushTask</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>          currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>          firstTask <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>          <span class="token comment" spellcheck="true">// 比较 frameDeadline 和 currentTime，如果当前帧还有时间的话，就一直执行</span>          <span class="token operator">!</span><span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>          <span class="token operator">!</span><span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Return whether there's additional work</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>firstDelayedTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 执行延期的任务</span>        <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>          handleTimeout<span class="token punctuation">,</span>          firstDelayedTask<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    isPerformingWork <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面注释我们了解到 flushWork 的主要作用</p><ul><li>判断是否是超时任务，如果是则调用 cancelHostTimeout 取消执行的调度任务</li><li>调用 advanceTimers 重新检查是否有没过期的任务，将他们加入到新的调度队列</li><li>执行调度队列将 isPerformingWork 标志改为 true </li><li>判断一帧内的剩余时间，执行调度队列，分为以下情况</li></ul><p><strong>如果剩余时间小于0，调度队列存在且调度任务过期</strong></p><ol><li>调用 flushTask()，从调度队列中取出调度任务并执行，之后将调度任务生出的子调度任务插入到其后</li><li>调用 getCurrentTime()，刷新当前时间</li><li>调用 advanceTimers()，检查是否有不过期的任务，并把它们加入到新的调度队列中 </li></ol><p><strong>如果剩余时间大于0，调度队列存在且调度任务未被中断</strong></p><ol><li>调用 flushTask()，从调度队列中取出调度任务并执行，执行调度任务生出的子调度任务</li><li>调用 getCurrentTime()，刷新当前时间</li><li>调用 advanceTimers()，检查是否有不过期的任务，并把它们加入到新的调度队列中</li></ol><p>如果调度任务都执行完毕，则返回 true，否则返回 false，执行延期的任务</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，React 的基础调度流程便算是走了一遍，下面我们就16.9版本代码的执行顺序看一下流程图<br><image src="/images/library-react-schedule.jpg"></image></p><p>其实16.9和16.8 在调度流程上还是有一定区别的那么我们看一下16.8的整个调度流程，对比学习，更有助于加深理解。<br><image src="/images/scheduler-fiber-scheduler.png"></image></p><h2 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h2><p><a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener">React Fiber(时间分片)</a></p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React 原理之 FiberRoot 构建过程</title>
      <link href="/2019/10/04/react/library-react-fiber01/"/>
      <url>/2019/10/04/react/library-react-fiber01/</url>
      
        <content type="html"><![CDATA[<p>fiber 是当前整个 react 核心部分，其中包含了大量的计算机知识。如果阅读 react 的源码能让人感觉到无力。</p><p>每次版本更新，核心部分的函数总是要动那么一动。从 15, 到 16 到 16.8、16.9 到现在的 16.10，包括现在已经改版的 vue3.0 着实让人难受。但是学习的步伐还是不能停下。react 系列文章主要是依赖 16.9 的源码进行分析。</p><p>我们言归正传，这一章到后面的几篇文章都是对 fiber 的学习和理解包括构建、调度、更新等。如有错误欢迎在 git 博客项目下提交 issue。</p><h2 id="什么是-fiber"><a href="#什么是-fiber" class="headerlink" title="什么是 fiber"></a>什么是 fiber<hr></h2><p>Fiber 的中文解释是纤程，是线程的颗粒化的一个概念。也就是说一个线程可以包含多个 Fiber。可以使同步计算变得被拆解、异步化，使浏览器主线程得以调控。</p><p>通过把更新过程碎片化，当执行完一段更新的时候，把控制权交还给 React 负责任务协调的模块，通过调度系统的任务的优先级去执行更新操作。</p><h2 id="创建-FiberRoot"><a href="#创建-FiberRoot" class="headerlink" title="创建 FiberRoot"></a>创建 FiberRoot<hr></h2><p>下面我们就 FiberRoot 的创建来开始我们的这篇文章，我们在 <a href="https://www.studyfe.cn/2019/10/01/react/library-react-jsx/">jsx</a> 转换的时候介绍过 jsx 主要是在编译的时候通过 React.createElement 这个函数进行转换的，那么转换后的代码会在 ReactDOM.render 中进行执行，首先我们看一下 ReactDOM.render 的执行函数，定义在文件 <code>packages/react-dom/src/client/ReactDOM.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> ReactDOM<span class="token punctuation">:</span> Object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ...</span>  <span class="token function">hydrate</span><span class="token punctuation">(</span>element<span class="token punctuation">:</span> React$Node<span class="token punctuation">,</span> container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span> callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">invariant</span><span class="token punctuation">(</span>      <span class="token function">isValidContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token string">'Target container is not a DOM element.'</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// TODO: throw or warn if we couldn't hydrate?</span>    <span class="token keyword">return</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>      <span class="token keyword">null</span><span class="token punctuation">,</span>      element<span class="token punctuation">,</span>      container<span class="token punctuation">,</span>      <span class="token boolean">true</span><span class="token punctuation">,</span>      callback<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span>    element<span class="token punctuation">:</span> React$Element<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">,</span>    container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>    callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">invariant</span><span class="token punctuation">(</span>      <span class="token function">isValidContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token string">'Target container is not a DOM element.'</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>      <span class="token keyword">null</span><span class="token punctuation">,</span>      element<span class="token punctuation">,</span>      container<span class="token punctuation">,</span>      <span class="token boolean">false</span><span class="token punctuation">,</span>      callback<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>经过上面的部分代码我们已经看到了 render 函数，但是在执行 render 函数之前执行了 hydrate 函数，这段代码是 React16 新增的主要是使⽤用服务端渲染和本地 DOM 进行调和，通过参数区分是否是服务端渲染，最后在创建 fiberRoot 过程中做区分。具体过程在后面会作出分析。</p><p>接下来我们看 render 函数，通过 invariant 验证是否是有效的 DOM element 然后执行了一个主要的方法 legacyRenderSubtreeIntoContainer</p><h3 id="legacyRenderSubtreeIntoContainer"><a href="#legacyRenderSubtreeIntoContainer" class="headerlink" title="legacyRenderSubtreeIntoContainer "></a>legacyRenderSubtreeIntoContainer <hr></h3><blockquote><p>legacyRenderSubtreeIntoContainer 方法主要的作用是</p></blockquote><ul><li>调用 legacyCreateRootFromDOMContainer 给 root 元素打上标识 _reactRootContainer，这里面的 forceHydrate 就是区分是否是服务端的标志 </li><li>调用 ReactSyncRoot 创建 fiberRoot</li><li>调用 unbatchedUpdates，第一次渲染是不使用批量更新。最后调用 updateContainer 更新子节点，生成完整的 fiber 树</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 渲染Dom Tree到挂载的container节点上</span><span class="token keyword">function</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>  parentComponent<span class="token punctuation">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">,</span>  children<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>  container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>  forceHydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 判断container 是否有_reactRootContainer属性，正常情况第一次渲染 container 是不会有 _reactRootContainer 属性的</span>  <span class="token keyword">let</span> root<span class="token punctuation">:</span> _ReactSyncRoot <span class="token operator">=</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_reactRootContainer<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> fiberRoot<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 初次渲染，初始化 root 对象</span>    root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>      container<span class="token punctuation">,</span>      forceHydrate<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 结合 ReactSyncRoot 函数 this._internalRoot = root;  </span>    <span class="token comment" spellcheck="true">// fiberRoot 为 createContainer 函数返回结果</span>    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>      callback <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>        originalCallback<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 初次渲染不使用批量更新.</span>    <span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 批量更新子节点</span>      <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>      callback <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>        originalCallback<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Update</span>    <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的大致流程，来详细的说明三个步骤中的执行过程</p><h3 id="legacyCreateRootFromDOMContainer"><a href="#legacyCreateRootFromDOMContainer" class="headerlink" title="legacyCreateRootFromDOMContainer "></a>legacyCreateRootFromDOMContainer <hr></h3><blockquote><p>legacyCreateRootFromDOMContainer，此方法的作用是</p></blockquote><ul><li>判断是否是服务端渲染标志 shouldHydrate</li><li>清除所有子元素 removeChild</li><li>返回 ReactSyncRoot 的实例</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>  container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>  forceHydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> _ReactSyncRoot <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 通过传递过来的 hydrate 标志，来确定是否会调和（复用）原来存在的 dom 节点，以提高性能，之后在和新渲染的节点进行合并</span>  <span class="token keyword">const</span> shouldHydrate <span class="token operator">=</span> forceHydrate <span class="token operator">||</span> <span class="token function">shouldHydrateDueToLegacyHeuristic</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldHydrate<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> warned <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> rootSibling<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 删除container 下的所有子节点</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rootSibling <span class="token operator">=</span> container<span class="token punctuation">.</span>lastChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ...</span>      <span class="token punctuation">}</span>      container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>rootSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// root 是同步更新的.</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactSyncRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> LegacyRoot<span class="token punctuation">,</span> shouldHydrate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ReactSyncRoot"><a href="#ReactSyncRoot" class="headerlink" title="ReactSyncRoot "></a>ReactSyncRoot <hr></h3><blockquote><p>ReactSyncRoot，此方法主要的作用是</p></blockquote><ul><li>调用 createContainer</li><li>创建了一个 fiberRoot 进行赋值</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">ReactSyncRoot</span><span class="token punctuation">(</span>  container<span class="token punctuation">:</span> DOMContainer<span class="token punctuation">,</span>  tag<span class="token punctuation">:</span> RootTag<span class="token punctuation">,</span>  hydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 将 createContainer 返回的值赋值给实例的 _internalRoot</span>  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> root<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="createContainer"><a href="#createContainer" class="headerlink" title="createContainer "></a>createContainer <hr></h3><blockquote><p>createContainer 此方法主要来源于 <code>react-reconciler/inline.dom</code></p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>  computeUniqueAsyncExpiration<span class="token punctuation">,</span>  findHostInstanceWithNoPortals<span class="token punctuation">,</span>  updateContainerAtExpirationTime<span class="token punctuation">,</span>  flushRoot<span class="token punctuation">,</span>  createContainer<span class="token punctuation">,</span>  updateContainer<span class="token punctuation">,</span>  batchedEventUpdates<span class="token punctuation">,</span>  batchedUpdates<span class="token punctuation">,</span>  unbatchedUpdates<span class="token punctuation">,</span>  discreteUpdates<span class="token punctuation">,</span>  flushDiscreteUpdates<span class="token punctuation">,</span>  flushSync<span class="token punctuation">,</span>  flushControlled<span class="token punctuation">,</span>  injectIntoDevTools<span class="token punctuation">,</span>  getPublicRootInstance<span class="token punctuation">,</span>  findHostInstance<span class="token punctuation">,</span>  findHostInstanceWithWarning<span class="token punctuation">,</span>  flushPassiveEffects<span class="token punctuation">,</span>  IsThisRendererActing<span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-reconciler/inline.dom'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到引入的这个文件里面定义的很多相关方法，那么我们进入这个文件</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./src/ReactFiberReconciler'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>通过名字就能看到这是 fiber 的构建文件，进入这个文件查看 createContainer</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>  containerInfo<span class="token punctuation">:</span> Container<span class="token punctuation">,</span>  tag<span class="token punctuation">:</span> RootTag<span class="token punctuation">,</span>  hydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> OpaqueRoot <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此方法主要的作用是</p><ul><li>返回 createFiberRoot 方法的值</li></ul><h3 id="createFiberRoot"><a href="#createFiberRoot" class="headerlink" title="createFiberRoot"></a>createFiberRoot<hr></h3><blockquote><p>createFiberRoot 方法来源于文件 <code>./ReactFiberRoot</code>，此方法的主要作用是</p></blockquote><ul><li>调用 createHostRootFiber 函数返回  uninitializedFiber</li><li>将 uninitializedFibe 赋值在 root 对象的 current 上</li><li>将 root 赋值给 uninitializedFiber.stateNode</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>  containerInfo<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  tag<span class="token punctuation">:</span> RootTag<span class="token punctuation">,</span>  hydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> FiberRoot <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// root 节点是 fiber</span>  <span class="token keyword">const</span> root<span class="token punctuation">:</span> FiberRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 循环结构，进行相互引用</span>  <span class="token comment" spellcheck="true">// 此处实际上一个单向链表的串联方式，用这个数据结构把整个 fiber 树串联起来</span>  <span class="token keyword">const</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// current 是 uninitializedFiber</span>  <span class="token comment" spellcheck="true">// 每一个 ReactElment 节点都对应一个 fiber 对象，也就会有一个树状结构</span>  <span class="token comment" spellcheck="true">// root.current 是当前的 fiber 对象的树状结构的顶点</span>  root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>  uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>  <span class="token keyword">return</span> root<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的方法我们知道执行了 FiberRootNode 和 createHostRootFiber 来创建整个结构我们必须清楚他们是什么关系</p><ul><li>root 是 ReactRoot 实例，</li><li>root._internalRoot 是 fiberRoot 实例，</li><li>root._internalRoot.current 是 Fiber 实例，</li><li>root._internalRoot.current.stateNode = root._internalRoot</li></ul><h3 id="FiberRootNode"><a href="#FiberRootNode" class="headerlink" title="FiberRootNode "></a>FiberRootNode <hr></h3><blockquote><p>new FiberRootNode 此方法的作用是创建 FiberRootNode，也就是 fiber 的 root 节点 </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 标记不同的组件类型</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 对应的 root 节点，也是对应的 fiber 对象</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// dom 上的 root 节点 render 里接收的第二个参数</span>  <span class="token comment" spellcheck="true">// ReactDOM.render(element, document.getElementById('root'));</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>containerInfo <span class="token operator">=</span> containerInfo<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 在持久更新中用到</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pingCache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 记录更新任务的优先级，在commit 阶段只会处理这个值对应的任务</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 在任务被挂起的时候通过 setTimeout 设置的返回内容，用来下⼀次如果有新的任务挂起时清理还没触发的 timeout</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> noTimeout<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 是否进行调合标志</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>hydrate <span class="token operator">=</span> hydrate<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>firstBatch <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>callbackExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>firstPendingTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>lastPendingTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pingTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>interactionThreadID <span class="token operator">=</span> <span class="token function">unstable_getThreadID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedInteractions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingInteractionMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来会执行 createHostRootFiber</p><h3 id="createHostRootFiber"><a href="#createHostRootFiber" class="headerlink" title="createHostRootFiber "></a>createHostRootFiber <hr></h3><blockquote><p>createHostRootFiber 来源于 <code>./ReactFiber</code>，此方法的主要作用是</p></blockquote><ul><li>通过 RootTag 来进行对比区分创建 fiber 的模式</li><li>执行 createFiber 函数，拿到返回值</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> RootTag<span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token punctuation">{</span>  <span class="token keyword">let</span> mode<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> ConcurrentRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mode <span class="token operator">=</span> ConcurrentMode <span class="token operator">|</span> BatchedMode <span class="token operator">|</span> StrictMode<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> BatchedRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mode <span class="token operator">=</span> BatchedMode <span class="token operator">|</span> StrictMode<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    mode <span class="token operator">=</span> NoMode<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer <span class="token operator">&amp;&amp;</span> isDevToolsPresent<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mode <span class="token operator">|</span><span class="token operator">=</span> ProfileMode<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>HostRoot<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>上面的对比过程有几个变量我觉得挺有意思，如果其他同学不感兴趣可以直接略过以下此部分</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>ConcurrentRoot<span class="token punctuation">,</span> BatchedRoot<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared/ReactRootTags'</span><span class="token punctuation">;</span><span class="token keyword">export</span> type RootTag <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> LegacyRoot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> BatchedRoot <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ConcurrentRoot <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>  NoMode<span class="token punctuation">,</span>  ConcurrentMode<span class="token punctuation">,</span>  ProfileMode<span class="token punctuation">,</span>  StrictMode<span class="token punctuation">,</span>  BatchedMode<span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactTypeOfMode'</span><span class="token punctuation">;</span><span class="token keyword">export</span> type TypeOfMode <span class="token operator">=</span> number<span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> NoMode <span class="token operator">=</span> <span class="token number">0b0000</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> StrictMode <span class="token operator">=</span> <span class="token number">0b0001</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 从 root 中读取数据，删除 BatchedMode 和 ConcurrentMode</span><span class="token keyword">export</span> <span class="token keyword">const</span> BatchedMode <span class="token operator">=</span> <span class="token number">0b0010</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ConcurrentMode <span class="token operator">=</span> <span class="token number">0b0100</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ProfileMode <span class="token operator">=</span> <span class="token number">0b1000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面二进制计算，来确定 expiriation-time 模式，关于此模式我们会在后续文章中进行介绍。</p><p>接下来我们看一下 createFiber</p><h3 id="createFiber"><a href="#createFiber" class="headerlink" title="createFiber "></a>createFiber <hr></h3><blockquote><p>createFiber 此方法主要的作用是返回了 FiberNode 的实例 进行 FiberNode 的初始化</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> createFiber <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>  tag<span class="token punctuation">:</span> WorkTag<span class="token punctuation">,</span>  pendingProps<span class="token punctuation">:</span> mixed<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>  mode<span class="token punctuation">:</span> TypeOfMode<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// $FlowFixMe: the shapes are exact here but Flow doesn't like constructors</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FiberNode</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> key<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="FiberNode"><a href="#FiberNode" class="headerlink" title="FiberNode "></a>FiberNode <hr></h3><blockquote><p>FiberNode</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span>  tag<span class="token punctuation">:</span> WorkTag<span class="token punctuation">,</span>  pendingProps<span class="token punctuation">:</span> mixed<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>  mode<span class="token punctuation">:</span> TypeOfMode<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Instance</span>  <span class="token comment" spellcheck="true">// 区分 fiber的不同类型，标记不同的组件类型</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ReactElement里面的key</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 调用`createElement`的第一个参数</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>elementType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 异步组件resolved之后返回的内容，一般是`function`或者`class`</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 对应节点的实例 </span>  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Fiber 单链表结构树结构.</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 在 setState 之后 pendingProps 里存的新的 props </span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 在 setState 之后 memoizedProps 存的老的 props</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 在 setState 或者 forceUpdate 创建更新之后就会存在此队列里，也是单向链表结构</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 节点的更新模式</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Effects</span>  <span class="token comment" spellcheck="true">// 标记最终dom节点要进行哪些更新的工具</span>  <span class="token comment" spellcheck="true">// 标记是否执行组件生命周期的内容</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>effectTag <span class="token operator">=</span> NoEffect<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//任务优先级调度的过期时间</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的初始化 fiberRoot 的过程就结束了，在创建 fiberRoot 的同时还进行了 </p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>下面我们就看看怎么更新的子节点</p><h3 id="unbatchedUpdates"><a href="#unbatchedUpdates" class="headerlink" title="unbatchedUpdates"></a>unbatchedUpdates</h3><p>创建完 fiberRoot 在 unbatchedUpdates 中执行 updateContainer 对容器内容进⾏更新。那么在执行更新之前 unbatchedUpdates 做了什么？接下来进入 unbatchedUpdates</p><blockquote><p>unbatchedUpdates 不会进行批量更新，定义在文件 <code>packages/react-reconciler/src/ReactFiberWorkLoop.js</code> 中</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> unbatchedUpdates<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>fn<span class="token punctuation">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">:</span> A<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> R<span class="token punctuation">,</span> a<span class="token punctuation">:</span> A<span class="token punctuation">)</span><span class="token punctuation">:</span> R <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// type ExecutionContext = number;</span>  <span class="token comment" spellcheck="true">// const NoContext = </span><span class="token comment" spellcheck="true">/*                    */</span> <span class="token number">0b000000</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const BatchedContext = </span><span class="token comment" spellcheck="true">/*               */</span> <span class="token number">0b000001</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const EventContext = </span><span class="token comment" spellcheck="true">/*                 */</span> <span class="token number">0b000010</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const DiscreteEventContext = </span><span class="token comment" spellcheck="true">/*         */</span> <span class="token number">0b000100</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const LegacyUnbatchedContext = </span><span class="token comment" spellcheck="true">/*       */</span> <span class="token number">0b001000</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const RenderContext = </span><span class="token comment" spellcheck="true">/*                */</span> <span class="token number">0b010000</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// const CommitContext = </span><span class="token comment" spellcheck="true">/*                */</span> <span class="token number">0b100000</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// let executionContext: ExecutionContext = NoContext;</span>  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>  executionContext <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>BatchedContext<span class="token punctuation">;</span>  executionContext <span class="token operator">|</span><span class="token operator">=</span> LegacyUnbatchedContext<span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 刷新在此批处理期间调度的即时回调</span>      <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运算符的概念</p><ul><li>&amp; 如果两位都是 1 则设置每位为 1 </li><li>| 如果两位之一为 1 则设置每位为 1</li><li>~ 反转操作数的比特位，即 0 变成 1，1 变成 0</li></ul><p>上面表达式相当于下面写法，初始化的值为</p><pre class="line-numbers language-js"><code class="language-js">executionContext <span class="token operator">=</span> executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span>BatchedContext<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 0 &amp; (~1) 为 0</span>executionContext <span class="token operator">=</span> executionContext <span class="token operator">|</span> LegacyUnbatchedContext <span class="token comment" spellcheck="true">// 0 | 8 则为 8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>executionContext 则是这些 Context 组合的结果:</p><ul><li>将当前上下文添加 render：executionContext |= RenderContext</li><li>判断当前是否处于 render 阶段： executionContext &amp;= RenderContext === NoContext</li><li>去除 render: executionContext &amp;= ~RenderContext</li></ul><p>所以此方法的执行流程是</p><ul><li>将当前的执行上下文赋值给 prevExecutionContext 默认为 0</li><li>当前上下文设置成 BatchedContext 默认为 0</li><li>把当前上下文设置成 LegacyUnbatchedContext 默认为 8</li><li>执行 try 中的回调之后执行 flushSyncCallbackQueue</li><li>最后返回执行结果</li></ul><p>在初始化更新阶段 try 中的回调实际上就是 updateContainer，那么接下来我们看看 updateContainer</p><h3 id="updateContainer"><a href="#updateContainer" class="headerlink" title="updateContainer "></a>updateContainer <hr></h3><blockquote><p>updateContainer 定义在 <code>/packages/react-reconciler/src/ReactFiberReconciler.js</code></p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>  element<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>  container<span class="token punctuation">:</span> OpaqueRoot<span class="token punctuation">,</span>  parentComponent<span class="token punctuation">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ExpirationTime <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 上面提到过，对应的是一个 fiber 对象</span>  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 获取当前任务时间</span>  <span class="token comment" spellcheck="true">// 过期时间是通过添加当前时间(开始时间)来计算的</span>  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 批处理的过程的配置 SuspenseConfig 默认为 null</span>  <span class="token comment" spellcheck="true">// export type SuspenseConfig = {</span>  <span class="token comment" spellcheck="true">//  timeoutMs: number,</span>  <span class="token comment" spellcheck="true">//  busyDelayMs?: number,</span>  <span class="token comment" spellcheck="true">//  busyMinDurationMs?: number,</span>  <span class="token comment" spellcheck="true">// };</span>  <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 通过 expirationTime 对节点计算过期时间</span>  <span class="token comment" spellcheck="true">// 如果在同一个事件中安排了两个更新，应该将它们的开始时间视为同时发生的</span>  <span class="token comment" spellcheck="true">// 即使在第一次和第二次调用之间实际的时钟时间已经提前</span>  <span class="token comment" spellcheck="true">// 过期时间决定更新的批处理方式，在同一事件中发生的具有相同优先级的所有更新都能接收到相同的过期时间</span>  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>    currentTime<span class="token punctuation">,</span>    current<span class="token punctuation">,</span>    suspenseConfig<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">updateContainerAtExpirationTime</span><span class="token punctuation">(</span>    element<span class="token punctuation">,</span>    container<span class="token punctuation">,</span>    parentComponent<span class="token punctuation">,</span>    expirationTime<span class="token punctuation">,</span>    suspenseConfig<span class="token punctuation">,</span>    callback<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的逻辑最主要的的两个方法 computeExpirationForFiber 和 updateContainerAtExpirationTime</p><h3 id="computeExpirationForFiber"><a href="#computeExpirationForFiber" class="headerlink" title="computeExpirationForFiber "></a>computeExpirationForFiber <hr></h3><blockquote><p>computeExpirationForFiber 计算节点过期时间</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>  currentTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>  fiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>  suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ExpirationTime <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 当前 fiber 对象采用的模式 </span>  <span class="token keyword">const</span> mode <span class="token operator">=</span> fiber<span class="token punctuation">.</span>mode<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**   * form ./ReactTypeOfMode    * 调度系统的处理模式   * NoMode 0b0000 --> 0   * BatchedMode 0b0010 --> 2   * ConcurrentMode 0b0100  --> 4   */</span>  <span class="token comment" spellcheck="true">/**   * from ./ReactFiberWorkLoop    * 当前调度系统的 Execution   * ExecutionContext 默认值  NoContext  0b000000 --> 0   * RenderContext 0b010000 --> 16   */</span>  <span class="token comment" spellcheck="true">/**   * from ./ReactFiberExpirationTime    * 调度系统的处理模式   * Sync 默认值 MAX_SIGNED_31_BIT_INT --> 1073741823 (最大 31 位整数。32 位系统的 V8 中的最大整数大小, Math.pow(2, 30) - 1)   * Batched  Sync - 1   * LOW_PRIORITY_EXPIRATION 5000   * LOW_PRIORITY_BATCH_SIZE 250   * HIGH_PRIORITY_EXPIRATION  __DEV__ ? 500 : 150   * HIGH_PRIORITY_BATCH_SIZE 100   */</span>  <span class="token comment" spellcheck="true">/**   * ./SchedulerWithReactIntegration   * 除了 NoPriority 之外，这些都对应于调度器优先级   * 使用升序数字，从90开始，以避免与调度程序的优先级冲突   * ImmediatePriority  99    * UserBlockingPriority 98   * NormalPriority 96   * IdlePriority 95   * NoPriority 90   */</span>  <span class="token comment" spellcheck="true">// (mode &amp; 2) === 0 </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> BatchedMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// return 1073741823</span>    <span class="token keyword">return</span> Sync<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// (mode &amp; 4) === 0 执行 </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// priorityLevel === 99 ? 1073741823 : (1073741823 - 1)</span>    <span class="token keyword">return</span> priorityLevel <span class="token operator">===</span> ImmediatePriority <span class="token operator">?</span> Sync <span class="token punctuation">:</span> Batched<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// (0 &amp; 16-> 0b010000) !== 0 (0b000000)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 利用我们已经渲染的时间, 默认是 nowork（0）</span>    <span class="token keyword">return</span> renderExpirationTime<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// expirationTime 代表该 fiber 的优先级，数值越大，优先级越高，Sync 的优先级最高</span>  <span class="token keyword">let</span> expirationTime<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>suspenseConfig <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 基于暂停超时计算过期时间</span>    expirationTime <span class="token operator">=</span> <span class="token function">computeSuspenseExpiration</span><span class="token punctuation">(</span>      currentTime<span class="token punctuation">,</span>      suspenseConfig<span class="token punctuation">.</span>timeoutMs <span class="token operator">|</span> <span class="token number">0</span> <span class="token operator">||</span> LOW_PRIORITY_EXPIRATION<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 根据调度器优先级计算 expirationTime</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">case</span> ImmediatePriority<span class="token punctuation">:</span>        expirationTime <span class="token operator">=</span> Sync<span class="token punctuation">;</span>         <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> UserBlockingPriority<span class="token punctuation">:</span>        expirationTime <span class="token operator">=</span> <span class="token function">computeInteractiveExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> NormalPriority<span class="token punctuation">:</span>      <span class="token keyword">case</span> LowPriority<span class="token punctuation">:</span>        expirationTime <span class="token operator">=</span> <span class="token function">computeAsyncExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> IdlePriority<span class="token punctuation">:</span>        expirationTime <span class="token operator">=</span> Never<span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'Expected a valid priority level'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 如果正在渲染一个树，不要在已经渲染的过期时间上更新操作。</span>  <span class="token comment" spellcheck="true">// 如果在不同的 root 节点上更新移动到单独的批处理中</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> expirationTime <span class="token operator">===</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    expirationTime <span class="token operator">-</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> expirationTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上到代码的注释就能看到 computeExpirationForFiber 主要是根据不同的任务优先级去进行调度执行计算过期时间 expirationTime，那么在不同的任务优先级下面具体是怎么计算的呢</p><p>主要有下面四种</p><ul><li>computeSuspenseExpiration 暂停任务的计算</li><li>Sync 同步任务的计算值</li><li>computeInteractiveExpiration 交互更新的计算</li><li>computeAsyncExpiration 异步任务的计算 </li></ul><p>上面的方法除了 Sync 任务优先级最高为 99 外，其他需要计算，都调用了 ./ReactFiberExpirationTime 文件中 computeExpirationBucket 方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** computeSuspenseExpiration (currentTime, timeoutMs, LOW_PRIORITY_BATCH_SIZE) {}* timeoutMs --> suspenseConfig.timeoutMs | 0 || LOW_PRIORITY_EXPIRATION* LOW_PRIORITY_BATCH_SIZE --> 200*/</span><span class="token comment" spellcheck="true">/** computeInteractiveExpiration (currentTime, HIGH_PRIORITY_EXPIRATION, HIGH_PRIORITY_BATCH_SIZE) {}* HIGH_PRIORITY_EXPIRATION --> __DEV__ ? 500 : 150* HIGH_PRIORITY_BATCH_SIZE --> 100*/</span><span class="token comment" spellcheck="true">/** computeAsyncExpiration (currentTime, LOW_PRIORITY_EXPIRATION, LOW_PRIORITY_BATCH_SIZE) {}* LOW_PRIORITY_EXPIRATION --> 5000* LOW_PRIORITY_BATCH_SIZE --> 250*/</span><span class="token comment" spellcheck="true">// MAGIC_NUMBER_OFFSET = Batched-1 --> (Sync - 1)-1 --> 1073741821;</span><span class="token comment" spellcheck="true">// UNIT_SIZE = 10</span><span class="token keyword">function</span> <span class="token function">computeExpirationBucket</span><span class="token punctuation">(</span>  currentTime<span class="token punctuation">,</span>  expirationInMs<span class="token punctuation">,</span>  bucketSizeMs<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ExpirationTime <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    MAGIC_NUMBER_OFFSET <span class="token operator">-</span>    <span class="token function">ceiling</span><span class="token punctuation">(</span>      MAGIC_NUMBER_OFFSET <span class="token operator">-</span> currentTime <span class="token operator">+</span> expirationInMs <span class="token operator">/</span> UNIT_SIZE<span class="token punctuation">,</span>      bucketSizeMs <span class="token operator">/</span> UNIT_SIZE<span class="token punctuation">,</span>    <span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">ceiling</span><span class="token punctuation">(</span>num<span class="token punctuation">:</span> number<span class="token punctuation">,</span> precision<span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> number <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">/</span> precision<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> precision<span class="token punctuation">;</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据上面公式，我们通过不同的任务优先级来计算一下 expirationTime</p><p>computeAsyncExpiration 的 expirationTime 为</p><pre class="line-numbers language-js"><code class="language-js"><span class="token number">1073741821</span><span class="token operator">-</span><span class="token function">ceiling</span><span class="token punctuation">(</span><span class="token number">1073741821</span><span class="token operator">-</span>currentTime <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token number">1073741821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1073741821</span> <span class="token operator">-</span> currentTime <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>我们取最后四位来看一下规律并且把 currentTime 变为从 <span class="token number">996</span><span class="token operator">-</span><span class="token number">1047</span> 的数字<span class="token number">1821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1821</span> <span class="token operator">-</span> <span class="token number">996</span> <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>  <span class="token comment" spellcheck="true">//1821-1350</span><span class="token number">1821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1821</span> <span class="token operator">-</span> <span class="token number">1021</span><span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>  <span class="token comment" spellcheck="true">//1821-1325</span><span class="token number">1821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1821</span> <span class="token operator">-</span> <span class="token number">1022</span><span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>  <span class="token comment" spellcheck="true">//1821-1300</span><span class="token number">1821</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1821</span> <span class="token operator">-</span> <span class="token number">1047</span><span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">25</span>  <span class="token comment" spellcheck="true">//1821-1275</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>可以得出，在跨度 996-1021 数字之内执行得出相同的结果，所以异步更新的过期时间间隔是25ms</strong></p><p>同理 computeInteractiveExpiration 的 expirationTime 为</p><pre class="line-numbers language-js"><code class="language-js"><span class="token number">1073741821</span><span class="token operator">-</span><span class="token function">ceiling</span><span class="token punctuation">(</span><span class="token number">1073741821</span><span class="token operator">-</span>currentTime<span class="token operator">+</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>可以得出，交互更新的过期时间间隔是10ms</strong></p><p>computeSuspenseExpiration 中的 <a href="https://www.zhihu.com/question/268028123/answer/332182059" target="_blank" rel="noopener">suspenseConfig</a> 是用来解决异步 IO问题的，它计算的优先级取决于 suspenseConfig.timeoutMs 的时间，如果suspenseConfig.timeoutMs 没有值那么默认为 LOW_PRIORITY_EXPIRATION（5000），LOW_PRIORITY_BATCH_SIZE（250），代入公式为</p><pre class="line-numbers language-js"><code class="language-js"><span class="token number">1073741821</span><span class="token operator">-</span><span class="token function">ceiling</span><span class="token punctuation">(</span><span class="token number">1073741821</span><span class="token operator">-</span>currentTime<span class="token operator">+</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>可以得出，时间间隔是25ms，但由于500 的取值不固定，所以它的优先级不固定</strong></p><p>通过上面计算的结论得出</p><ul><li>Sync 任务优先级最高 &gt; computeInteractiveExpiration 用户交互更新任务 &gt; computeAsyncExpiration 异步任务的计算 </li><li>computeSuspenseExpiration 的情况由于不固定所以任务优先级不固定</li></ul><p>从结论中得出 react 异步更新的 expirationTime 间隔是25ms，让两个或多个相近（25ms内）的更新得到相同的 expirationTime。目的就是让这两个更新自动合并成一个，从而达到自动批量更新的目的。这样在开发中不停的 setState() 进行更新操作，25ms内的就会合并提高性能。我们后面也会介绍 setState 和 BatchUpdate 的运行机制。</p><h3 id="updateContainerAtExpirationTime"><a href="#updateContainerAtExpirationTime" class="headerlink" title="updateContainerAtExpirationTime "></a>updateContainerAtExpirationTime <hr></h3><blockquote><p>updateContainerAtExpirationTime 定义在文件 <code>packages/react-reconciler/src/ReactFiberReconciler.js</code></p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainerAtExpirationTime</span><span class="token punctuation">(</span>  element<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>  container<span class="token punctuation">:</span> OpaqueRoot<span class="token punctuation">,</span>  parentComponent<span class="token punctuation">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">,</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>  suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// TODO: If this is a nested container, this won't be the root.</span>  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ..</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span>parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>context <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    container<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    container<span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> context<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">scheduleRootUpdate</span><span class="token punctuation">(</span>    current<span class="token punctuation">,</span>    element<span class="token punctuation">,</span>    expirationTime<span class="token punctuation">,</span>    suspenseConfig<span class="token punctuation">,</span>    callback<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上面看到获取容器的节点，之后进入 scheduleRootUpdate 更新 container</p><h3 id="scheduleRootUpdate"><a href="#scheduleRootUpdate" class="headerlink" title="scheduleRootUpdate"></a>scheduleRootUpdate<hr></h3><blockquote><p>scheduleRootUpdate </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">scheduleRootUpdate</span><span class="token punctuation">(</span>  current<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>  element<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>  suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span>  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 获得优先级后则和同步更新一样， 创建 update 用于记录组件改变的状态的对象</span>  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 设置update属性 初次渲染</span>  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>element<span class="token punctuation">}</span><span class="token punctuation">;</span>  callback <span class="token operator">=</span> callback <span class="token operator">===</span> undefined <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> callback<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>revertPassiveEffectsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// enqueueUpdate 把 update 对象加入 fiber 对象的 updateQueue 中，updateQueue对象是一个单向链表结构 </span>  <span class="token comment" spellcheck="true">// 只要有 setState 或者其他方式触发了更新，就会在 fiber 上的 updateQueue 里插入一个 update</span>  <span class="token comment" spellcheck="true">// 这样在更新的时候就可以合并一起更新</span>  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 开始进行任务调度流程，任务调度则需要按照优先级进行控制</span>  <span class="token comment" spellcheck="true">// 在同一时间有不同的任务优先级，则需要先执行优先级高的任务</span>  <span class="token function">scheduleWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> expirationTime<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="scheduleWork"><a href="#scheduleWork" class="headerlink" title="scheduleWork "></a>scheduleWork <hr></h3><blockquote><p>scheduleWork 异步调度流程，定义在文件 <code>/packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>  fiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 判断是否有无限循环的 update，如果超过50层件套 update</span>  <span class="token comment" spellcheck="true">// 就会停止调度，并报错</span>  <span class="token comment" spellcheck="true">// 所以我们在我们不能在 render 中无条件的调用 setState，造成死循环</span>  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// 找到 rootFiber 并遍历更新子节点的 expirationTime</span>  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">markUpdateTimeFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">warnAboutUpdateOnUnmountedFiberInDEV</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// NoWork表示无更新操作 为 0 </span>  root<span class="token punctuation">.</span>pingTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//判断是否有高优先级任务打断当前正在执行的任务</span>  <span class="token function">checkForInterruption</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 报告调度更新</span>  <span class="token function">recordScheduleUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//  获取优先级</span>  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 同步任务</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>      <span class="token comment" spellcheck="true">// render前，也就是第一次执行 </span>      <span class="token comment" spellcheck="true">// 不批量更新</span>      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> LegacyUnbatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>      <span class="token comment" spellcheck="true">// 是否已经 render</span>      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext    <span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 跟踪 在root 注册挂起的交互，以避免丢失跟踪的交互数据</span>      <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 批量更新时，render是同步的，但布局的更新要延迟到批量更新的末尾才执行</span>      <span class="token comment" spellcheck="true">// 渲染 root 组件</span>      <span class="token comment" spellcheck="true">// 调用workLoop进行循环单元更新</span>      <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token function">renderRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> Sync<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        callback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// render 后</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 立即执行调度任务</span>      <span class="token function">scheduleCallbackForRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> ImmediatePriority<span class="token punctuation">,</span> Sync<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 判断没有update时</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 刷新同步任务队列</span>        <span class="token comment" spellcheck="true">// 放在 scheduleUpdateOnFiber 而不是 scheduleCallbackForFiber中，以保留在不立即刷新回调的情况下调度回调的能力。</span>        <span class="token comment" spellcheck="true">// 只对用户发起的更新这样做，以保持同步模式的历史行为。</span>        <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 异步任务立即执行调度任务</span>    <span class="token function">scheduleCallbackForRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> priorityLevel<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> DiscreteEventContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>    <span class="token punctuation">(</span>priorityLevel <span class="token operator">===</span> UserBlockingPriority <span class="token operator">||</span> priorityLevel <span class="token operator">===</span> ImmediatePriority<span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootsWithPendingDiscreteUpdates <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// key是root，value是expirationTime</span>      rootsWithPendingDiscreteUpdates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 获取最新的DiscreteTime</span>      <span class="token keyword">const</span> lastDiscreteTime <span class="token operator">=</span> rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 更新DiscreteTime</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastDiscreteTime <span class="token operator">===</span> undefined <span class="token operator">||</span> lastDiscreteTime <span class="token operator">></span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>        rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">const</span> scheduleWork <span class="token operator">=</span> scheduleUpdateOnFiber<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的代码分析我们了解到了整个 fiber 的创建过程以及提到了一点点的调度，关于怎么执行调度机制会在下一篇文章中进行分析。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结<hr></h2><p>通过上面代码我们总结以下几个知识点</p><blockquote><p>fiber 的实现原理</p></blockquote><p>通过上面代码我们知道（虽然调度过程还没有分析），fiber 实际上是将需要执行的操作放在 updateQueue 队列中，而不是 Javascript 的栈。通过调度逻辑优先级控制在内存中保留栈帧，从而控制整个渲染。</p><blockquote><p>fiber 的作用</p></blockquote><ul><li>每一个 ReactElement 对应一个Fiber对象</li><li>记录每个节点的状态，例如 props 和 state 等</li><li>会串联整个应用形成树结构</li></ul><blockquote><p>fiber-tree</p></blockquote><img src="/images/library-react-fiber-tree.png"><p>上面的图就是整个 fiber-tree 的数据结构图，是通过递归 diff的过程，拆分成一系列小任务，通过调度算法，形成的结构。</p><blockquote><p>其他</p></blockquote><p>由于篇幅过长所以调度流程只分析的大概，但是从上面的源码中我们知道以下几个知识点</p><ul><li>hydrate 的作用</li><li>在初次渲染时是不会进行批量更新的，因为要加速渲染过程</li><li>FiberNode 中的节点字段信息都有什么含义</li><li>在初始化创建更新子节点，通过过期时间 expirationTime 来决定批处理的方式</li><li>任务执行的优先级为 Sync 任务优先级最高 &gt; computeInteractiveExpiration 用户交互更新任务 &gt; computeAsyncExpiration 异步任务的计算</li><li>进行 setState 的时候在 25ms内执行多次，会被进行合并，这个在后续文章中通过 BatchUpdate 会详细说明</li><li>所有的数据会放在 fiber 对象的 updateQueue 队列中等待更新操作</li><li>通过 scheduleWork 开启调度任务，调度任务的优先级通过 expirationTime 计算得出</li></ul>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React 之生命周期使用</title>
      <link href="/2019/10/02/react/library-react-lifecycle/"/>
      <url>/2019/10/02/react/library-react-lifecycle/</url>
      
        <content type="html"><![CDATA[<p>和 Vue 一样 React 也会有对应的生命周期钩子函数，在相对应的钩子函数内，分别在不同时机处理相对应的逻辑，贴一张来至官网<a href="http://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/" target="_blank" rel="noopener">生命周期图</a>，通过周期图让我们看看 react 的生命周期具体的含义。</p><p>在 react 中，我们可以将生命周期分为四个阶段：</p><ul><li>初始化阶段</li><li>挂载阶段</li><li>更新阶段</li><li>卸载阶段</li></ul><p>下面我们就根据不同阶段对应不同的钩子函数进行简单的介绍使用（本文主要依据版本16.9.0）</p><h3 id="初始化阶段（Initalization）"><a href="#初始化阶段（Initalization）" class="headerlink" title="初始化阶段（Initalization）"></a>初始化阶段（Initalization）<hr></h3><p>挂载阶段实际上就是在做初始化的过程，当组件实例被创建并插入 DOM 中的时候，将依次调用以下生命周期函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> propTypes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">static</span> defaultProps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面对上面的代码进行拆分</p><blockquote><p>static propTypes = {} 和 static defaultProps = {}</p></blockquote><p>getDefaultProps 相当于 ES6中 static defaultProps = {}<br>getInitialState 相当于 constructor中 的 this.state = {}</p><ul><li>static defaultProps = {} 是设置组件的默认 props</li><li>static propTypes = {} 组件的 props类型检测</li></ul><blockquote><p>constructor(props)</p></blockquote><p>在组件进行挂载之前，调用它的构造函数，可以做如下事情</p><ul><li>访问 props</li><li>初始化 state 值</li><li>绑定事件处理函数</li></ul><h3 id="挂载阶段（Mounting）"><a href="#挂载阶段（Mounting）" class="headerlink" title="挂载阶段（Mounting）"></a>挂载阶段（Mounting）<hr></h3><p>将虚拟 DOM 转化为真实 DOM 的过程</p><blockquote><p>static getDerivedStateFromProps(props, state) 此钩子会执行 &gt; 1 次</p></blockquote><p>getDerivedStateFromProps 是在 render 之前被调用的，主要存在的作用是让组件的 props 变化时更新 state。<br>在初始化挂载和后续更新都会被调用，它返回一个对象来更新状态，或者返回 null 来表明新属性不需要更新任何状态。</p><p>使用此生命周期有几点需要注意的地方</p><ul><li>调用 this.setState() 通常不会触发此方法</li><li>此方法会被调用多次</li><li>必须有返回值，返回一个对象更新 state 或者返回 null</li></ul><blockquote><p>render() 此函数会执行 &gt; 1 次，代表挂载（渲染）组件</p></blockquote><p>render 函数是组件中唯一一个必须实现的方法，该函数在使用过程中有几点注意的地方</p><ul><li>此函数会被调用多次</li><li>不能在函数中调用 this.setState() 方法</li><li>render() 函数应该为<a href="https://www.studyfe.cn/2019/07/15/javascript/functionalpurity/">纯函数</a></li><li>必须有返回值，可以有<a href="https://zh-hans.reactjs.org/docs/react-component.html#render" target="_blank" rel="noopener">多种类型</a>。如果没有任何返回值，可以直接返回 null。</li></ul><blockquote><p>componentDidMount()，此钩子只执行一次，代表组件渲染完成</p></blockquote><p>此钩子函数并不是在 render 调用后立即调用，会在组件挂载后（插入 DOM 树中）立即调用。</p><ul><li>依赖于 DOM 节点的初始化应该放在这里</li><li>如需通过网络请求获取数据，此处是实例化请求的好地方</li><li>在此钩子函数中可以直接调用 setState()，但会触发额外的渲染，调用两次 render，导致性能问题。所以如果不依赖 DOM，做数据初始化最好是用constructor。当然如果使用 redux 作为数据存储就无关紧要了。因为 redux 作初始数据载入时，是可以不需透过 react 组件的生命周期方法。</li></ul><p><strong>挂载阶段即将废弃的钩子函数</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * componentWillMount * 从 15 更新到 16 后不建议使用，该名称将继续使用至 React 17 * 它在 render() 之前调用，因此在此方法中同步调用 setState() 不会触发额外渲染 * 此钩子做的事情完全可以在 constructor 中做到，所以这个函数没什么存在感 */</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="更新阶段（Updation）"><a href="#更新阶段（Updation）" class="headerlink" title="更新阶段（Updation）"></a>更新阶段（Updation）<hr></h3><p>组件 state，props 变化引发的重新渲染的过程，将依次调用以下生命周期函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span> <span class="token punctuation">}</span>  shouldComponentUpdate <span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">}</span>  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>getDerivedStateFromProps(props,state) 在组件挂载阶段有说明，在更新阶段用法一样，就不多做介绍了</p></blockquote><blockquote><p>shouldComponentUpdate (nextProps, nextState)</p></blockquote><p>此钩子首次渲染调用 render 的时候不会被触发，在更新阶段接收到新的 state 或者 props 的时候会在 render 方法前面被调用，使用此钩子应注意几个地方</p><ul><li>首次渲染或使用 forceUpdate() 时不会调用该方法</li><li>默认行为是当 props 或 state 发生变化时，此钩子会在 render 之前被调用，返回默认 true</li><li>如果要手动的返回 false，则会跳过更新阶段，不会执行 UNSAFE_componentWillUpdate()，render() 和 componentDidUpdate()</li><li>不建议在此钩子中进行深层次的比较或使用 JSON.stringify()。这样非常影响效率，且会损害性能。</li><li>此钩子可以对 react 进行性能上的优化，因为因为父组件的重新更新，会造成它下面所有的子组件重新执行 render 方法，形成新的虚拟DOM，在进行比对决定是否重新渲染，影响性能。所以我们可以将 this.props 与 nextProps 以及 this.state 与nextState 进行比较，并返回 false 以告知 React 可以跳过更新。也可以考虑使用内置的 PureComponent 组件，来进行浅层比较，减少跳过更新的必要性。</li></ul><blockquote><p>render () 根据新的状态对象重新挂载(渲染)组件，在挂载阶段有说明，在更新阶段，就不多做介绍了</p></blockquote><blockquote><p>getSnapshotBeforeUpdate（prevProps, prevState）</p></blockquote><p>此钩子触发的时机是发生在组件更新阶段，在 render 重新渲染之后，组件 DOM 渲染之前，返回一个值，为 componentDidUpdate 的第三个参数；配合 componentDidUpdate， 可以覆盖 componentWillUpdate 的所有用法。</p><ul><li>此钩子可以处理异步加载资源和组件在发生更改之前从 DOM 中捕获一些信息（如滚动位置等）</li><li>应返回 snapshot 的值（或 null）</li></ul><blockquote><p>componentDidUpdate（prevProps, prevState, snapshot）</p></blockquote><p>此钩子首次渲染调用 render 的时候不会被触发，在更新后被立即调用</p><ul><li>当组件更新后，可以在此处对 DOM 进行操作</li><li>如果你对更新前后的 props 进行了比较，也可以选择在此处进行网络请求</li><li>可以在此钩子中直接调用 setState()，但请注意它必须被包裹在一个条件语件里，否则会造成死循环。它还会造成额外的重新渲染，影响性能。</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 典型用法（不要忘记比较 props）：</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>userID <span class="token operator">!==</span> prevProps<span class="token punctuation">.</span>userID<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>userID<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>更新阶段即将废弃的钩子函数</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * componentWillReceiveProps和 componentWillUpdate * 从 15 更新到 16 后不建议使用，该名称将继续使用至 React 17 * componentWillReceiveProps 组件收到新的属性对象时调用，首次渲染不会触发 * componentWillUpdate 组件更新之前调用的钩子函数 */</span>componentWillReceiveProps <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>componentWillUpdate <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="卸载阶段（Unmounting）"><a href="#卸载阶段（Unmounting）" class="headerlink" title="卸载阶段（Unmounting）"></a>卸载阶段（Unmounting）<hr></h3><p>组件卸载之前调用此钩子</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>componentWillUnmount()</p></blockquote><p>此钩子会在组件卸载及销毁之前直接调用，在此方法中执行必要的清理操作，例如，清除 timer，取消网络请求或清除在 componentDidMount() 中创建的订阅等</p><ul><li>此钩子不应调用 setState()，因为该组件将永远不会重新渲染。组件实例卸载后，将永远不会再挂载它</li></ul><h3 id="其他钩子"><a href="#其他钩子" class="headerlink" title="其他钩子"></a>其他钩子<hr></h3><p>当渲染过程，生命周期，或子组件的构造函数中抛出错误时，会调用如下方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 两个钩子用其中一个就可以</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Error boundaries 组件会捕获在渲染期间，在生命周期方法以及其整个树的构造函数中发生的错误</li><li>Error boundaries 仅捕获组件树中以下组件中的错误。但它本身的错误无法捕获。</li><li>如果发生错误，你可以通过调用 setState 使用 componentDidCatch() 渲染降级 UI，但在未来的版本中将不推荐这样做。 可以使用静态 getDerivedStateFromError() 来处理降级渲染。</li></ul><blockquote><p>static getDerivedStateFromError() 会在渲染阶段调用，因此不允许出现副作用。 如遇此类情况，请改用 componentDidCatch()。</p></blockquote><p>此钩子会在后代组件抛出错误后被调用。 它将抛出的错误作为参数，并返回一个值以更新 state</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 更新 state 使下一次渲染可以降级 UI</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 你可以渲染任何自定义的降级  UI</span>      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">></span>Something went wrong<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>componentDidCatch(error, info) 会在 “提交” 阶段被调用，因此允许执行副作用。 用于记录错误之类的情况.</p></blockquote><p>此生命周期在后代组件抛出错误后被调用。 它接收两个参数：</p><ul><li>error —— 抛出的错误。</li><li>info —— 带有 componentStack key 的对象。</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 更新 state 使下一次渲染可以显示降级 UI</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// "组件堆栈" 例子:</span>    <span class="token comment" spellcheck="true">//   in ComponentThatThrows (created by App)</span>    <span class="token comment" spellcheck="true">//   in ErrorBoundary (created by App)</span>    <span class="token comment" spellcheck="true">//   in div (created by App)</span>    <span class="token comment" spellcheck="true">//   in App</span>    <span class="token function">logComponentStackToMyService</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>componentStack<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 你可以渲染任何自定义的降级 UI</span>      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">></span>Something went wrong<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="版本对比图"><a href="#版本对比图" class="headerlink" title="版本对比图"></a>版本对比图<hr></h3><img src="/images/library-react-lifecycle01.png"><p>通过上面版本对比图我们能够很清晰的看到在 Mounting 和 Updation 阶段16版本增加了深蓝色部分。 </p><ul><li>16版本中 componentWillMount、componentWillReceiveProps、componmentWillUpdate 被标记为不安全的钩子，在17版本中被移除</li><li>增加了 getDeriveStateFromProps、getSnapshotBeforeUpdate。</li><li>增加了错误处理的钩子分别为 componentDidCatch、getDerivedStateFromError</li></ul><h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图<hr></h3><img src="/images/library-react-lifecycle02.png"><h3 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序<hr></h3><p>用下面的例子进行测试</p><p>父组件</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./ToDo.css'</span><span class="token punctuation">;</span><span class="token keyword">import</span> ToDoItem <span class="token keyword">from</span> <span class="token string">'./components/ToDoItem'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">ToDo</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// this is where the data goes</span>      list<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>          <span class="token string">'todo'</span><span class="token punctuation">:</span> <span class="token string">'clean the house'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>          <span class="token string">'todo'</span><span class="token punctuation">:</span> <span class="token string">'buy milk'</span>        <span class="token punctuation">}</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      todo<span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getDerivedStateFromProps父'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentDidMount父'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'shouldComponentUpdate父'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span>  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getSnapshotBeforeUpdate父'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentDidUpdate父'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentWillUnmount父'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  createNewToDoItem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> list<span class="token punctuation">,</span> todo <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>      list<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token operator">...</span>list<span class="token punctuation">,</span>        <span class="token punctuation">{</span>          todo        <span class="token punctuation">}</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      todo<span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  handleKeyPress <span class="token operator">=</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">'Enter'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createNewToDoItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  handleInput <span class="token operator">=</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      todo<span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// this is now being emitted back to the parent from the child component</span>  deleteItem <span class="token operator">=</span> indexToDelete <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> list <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>      list<span class="token punctuation">:</span> list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>toDo<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> index <span class="token operator">!==</span> indexToDelete<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render 父"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDo"</span><span class="token operator">></span>        <span class="token operator">&lt;</span>h1 className<span class="token operator">=</span><span class="token string">"ToDo-Header"</span><span class="token operator">></span>React To Do<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDo-Container"</span><span class="token operator">></span>          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDo-Content"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>ToDoItem <span class="token operator">/</span><span class="token operator">></span>            <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>              <span class="token keyword">return</span> <span class="token operator">&lt;</span>ToDoItem                key<span class="token operator">=</span><span class="token punctuation">{</span>key<span class="token punctuation">}</span>                item<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>todo<span class="token punctuation">}</span>                deleteItem<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>deleteItem<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">}</span>              <span class="token operator">/</span><span class="token operator">></span>            <span class="token punctuation">}</span>            <span class="token punctuation">)</span><span class="token punctuation">}</span>          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>          <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>todo<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleInput<span class="token punctuation">}</span> onKeyPress<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleKeyPress<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDo-Add"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>createNewToDoItem<span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ToDo<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>子组件</p><pre class="line-numbers language-js"><code class="language-js">mport React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./ToDoItem.css'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">ToDoItem</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      item<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>item    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getDerivedStateFromProps子'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentDidMount子'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'shouldComponentUpdate子'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span>  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getSnapshotBeforeUpdate子'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentDidUpdate子'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componentWillUnmount子'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"render 子"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDoItem"</span><span class="token operator">></span>        <span class="token operator">&lt;</span>p className<span class="token operator">=</span><span class="token string">"ToDoItem-Text"</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>item<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"ToDoItem-Delete"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>deleteItem<span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">-</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ToDoItem<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用父组件</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./index.css'</span><span class="token punctuation">;</span><span class="token keyword">import</span> ToDo <span class="token keyword">from</span> <span class="token string">'./ToDo'</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>ToDo <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码看的初始化执行顺序是</p><image src="/images/library-react-lifecycle03.jpg"><p>可以看到先执行</p><ul><li>父组件的 getDerivedStateFromProps -&gt; render</li><li>子组件的 getDerivedStateFromProps -&gt; render</li><li>子组件的 componentDidMount</li><li>父组件的 componentDidMount</li></ul><p>更新阶段执行的顺序是<br><image src="/images/library-react-lifecycle04.jpg"></image></p><ul><li>父组件的 getDerivedStateFromProps -&gt; shouldComponentUpdate -&gt; render</li><li>子组件的 getDerivedStateFromProps -&gt; shouldComponentUpdate -&gt; render</li><li>子组件 getSnapshotBeforeUpdate</li><li>父组件 getSnapshotBeforeUpdate</li><li>子组件 componentWillUnmount（因为删除了子组件）</li><li>子组件的 componentDidUpdate</li><li>父组件的 componentDidUpdate</li></ul><h3 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h3><p><a href="https://zh-hans.reactjs.org/docs/react-component.html" target="_blank" rel="noopener">组件的生命周期<a></a></a></p></image>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React 原理之 JSX 转换</title>
      <link href="/2019/10/01/react/library-react-jsx/"/>
      <url>/2019/10/01/react/library-react-jsx/</url>
      
        <content type="html"><![CDATA[<h2 id="JSX-转换"><a href="#JSX-转换" class="headerlink" title="JSX 转换"></a>JSX 转换</h2><p>在我们写 react 组件的时候都会去写 jsx，那么 jsx 在 react 内部到底是怎么进行转换编译的呢？</p><h3 id="babel-转换"><a href="#babel-转换" class="headerlink" title="babel 转换"></a>babel 转换<hr></h3><p>在进行转换编译之前，我们先来配置环境。这样方便我们查看转换后的代码。当然我们也使用 babel 去编译，但这里只是简单的说明 jsx 转换，所以不去配置 .babelrc 或者其他配置方式。</p><p>执行下面步骤</p><ul><li>创建并进入文件夹</li><li>在终端中执行 npm init -y </li><li>在终端中执行 npm install babel-cli@6 babel-preset-react-app@3</li><li>创建 demo.html,并写入</li></ul><pre class="line-numbers language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, initial-scale<span class="token punctuation">=</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ie<span class="token punctuation">=</span>edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/react@16/umd/react.development.js<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/react-dom@16/umd/react-dom.development.js<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>demo.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建 src 文件夹，在 src 文件中创建 demo.jsx，并写入</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">]</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>ul<span class="token operator">></span>      <span class="token punctuation">{</span>        arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span> <span class="token operator">></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>  <span class="token operator">&lt;</span>App key<span class="token operator">=</span><span class="token string">"app"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>执行 npx babel –watch src –out-dir . –presets react-app/prod</li></ul><p>经过 babel 编译之后的代码为</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>    <span class="token string">"ul"</span><span class="token punctuation">,</span>    <span class="token keyword">null</span><span class="token punctuation">,</span>    arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>        <span class="token string">"li"</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> key<span class="token punctuation">:</span> index <span class="token punctuation">}</span><span class="token punctuation">,</span>        item      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>App<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面编译完成的代码，可以看到 jsx 只是为 <code>React.createElement(component, props, ...children)</code> 方法提供的语法糖，实际上和直接写 <code>React.createElement（）</code> 等价，只是 babel 帮助我们完成了这个转换的过程</p><p><em><code>注意 babel 在编译时会判断 jsx 中组件的首字母，当首字母为小写时，其被认定为原生DOM标签，createElement 的第一个变量被编译为字符串，当首字母为大写时，其被认定为自定义组件，createElement 的第一个变量被编译为对象；</code></em></p><h3 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement<hr></h3><p>在进行编译的时候 jsx 主要调用了 React.createElement 函数，那么接下来我们看看这个函数的主要作用（注意本文主要依托于源码 v16.9.0 版本)， 定义在 <code>react/packages/react/src/React.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">import</span> <span class="token punctuation">{</span>  createElement<span class="token punctuation">,</span>  createFactory<span class="token punctuation">,</span>  cloneElement<span class="token punctuation">,</span>  isValidElement<span class="token punctuation">,</span>  jsx<span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactElement'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>找到 <code>react/packages/react/src/ReactElement.js</code> 文件中定义的 ReactElement 方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">const</span> ReactElement <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> self<span class="token punctuation">,</span> source<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// This tag allows us to uniquely identify this as a React Element</span>    $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> REACT_ELEMENT_TYPE<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// Built-in properties that belong on the element</span>    type<span class="token punctuation">:</span> type<span class="token punctuation">,</span>    key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>    ref<span class="token punctuation">:</span> ref<span class="token punctuation">,</span>    props<span class="token punctuation">:</span> props<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// Record the component responsible for creating this element.</span>    _owner<span class="token punctuation">:</span> owner<span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">return</span> element<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> propName<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Reserved names are extracted</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 1. 处理 props</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 2. 获取并处理 children 节点</span>  <span class="token keyword">const</span> childrenLength <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 3. 处理默认 props</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// 4. 返回 ReactElement 对象</span>  <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>    type<span class="token punctuation">,</span>    key<span class="token punctuation">,</span>    ref<span class="token punctuation">,</span>    self<span class="token punctuation">,</span>    source<span class="token punctuation">,</span>    ReactCurrentOwner<span class="token punctuation">.</span>current<span class="token punctuation">,</span>    props<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到 createElement 主要的作用很简单就是将 props 和子元素进行处理之后返回一个 ReactElement 对象，下面我们分析上面三个步骤</p><blockquote><p>1.处理 props</p></blockquote><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasValidRef</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      ref <span class="token operator">=</span> config<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasValidKey</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      key <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">+</span> config<span class="token punctuation">.</span>key<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    self <span class="token operator">=</span> config<span class="token punctuation">.</span>__self <span class="token operator">===</span> undefined <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span>    source <span class="token operator">=</span> config<span class="token punctuation">.</span>__source <span class="token operator">===</span> undefined <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Remaining properties are added to a new props object</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>propName <span class="token keyword">in</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> propName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token operator">!</span>RESERVED_PROPS<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>从 config 中取出ref，key</li><li>从 config 中取出 self，source</li><li>将除特殊属性的其他属性取出并赋值给 props</li></ul><blockquote><p>2.获取并处理 children 节点</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> childrenLength <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> childArray <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>childrenLength<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    childArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>freeze<span class="token punctuation">)</span> <span class="token punctuation">{</span>      Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>childArray<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  props<span class="token punctuation">.</span>children <span class="token operator">=</span> childArray<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>获取第二个参数后面的所有参数</li><li>如果只有一个子元素，直接赋值给 props.children</li><li>如果有多个子元素，将子元素改变为数组赋值给 props.children</li></ul><blockquote><p>3.处理默认 props</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> defaultProps <span class="token operator">=</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>propName <span class="token keyword">in</span> defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>        props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> defaultProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将组件的静态属性 defaultProps 赋值给定义的默认 props </p><blockquote><p>4.返回 ReactElement</p></blockquote><p>可以看到 ReactElement 函数将几个参数进行重新组合，最后返回组合的对象 element，那么这几个参数的是干什么的呢？</p><ul><li>type：元素的类型，可以是字符串或者是函数</li><li>key：组件的唯一标识，用于Diff算法</li><li>ref：用于直接访问原生的 DOM</li><li>props：组件通信的 props</li><li>owner：维护在构建虚拟DOM过程中，随时会变动的变量的临时保存位置所在，是识别自定义组件的关键</li><li>$$typeof： 一个 Symbol 类型的变量，防止XSS</li></ul><p>$$typeof 在 ReactElement 中被赋值为 <code>REACT_ELEMENT_TYPE</code>，定义在 <code>react/packages/shared/ReactSymbols.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> hasSymbol <span class="token operator">=</span> <span class="token keyword">typeof</span> Symbol <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> REACT_ELEMENT_TYPE <span class="token operator">=</span> hasSymbol  <span class="token operator">?</span> Symbol<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token string">'react.element'</span><span class="token punctuation">)</span>  <span class="token punctuation">:</span> <span class="token number">0xeac7</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到上面判断，如果当前环境支持 Symbol， 那么就是用 Symbol.for 来进行组件的标示，否则 $$typeof 被赋值为 0xeac7。至于为什么 React 开发者给出了答案：0xeac7看起来有点像 React 😄😄😄 （如果不熟悉 Symbol.for，请参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Symbol/for" target="_blank" rel="noopener">MDN</a>。）<br>当 React 渲染时会把没有 $$typeof 标识的以及规则校验不通过的组件过滤掉，这样就知道了 React 组件是否是有效的</p><pre class="line-numbers language-js"><code class="language-js">ReactElement<span class="token punctuation">.</span>isValidElement <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">typeof</span> object <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> object <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> object<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> REACT_ELEMENT_TYPE<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结<hr></h3><p>通过上述分析我们知道了 React.createElement 实际上返回的是一个特定格式的对象，这个对象大致如下</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>  $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span>  key<span class="token punctuation">:</span> <span class="token keyword">null</span>  props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  ref<span class="token punctuation">:</span> <span class="token keyword">null</span>  type<span class="token punctuation">:</span> ƒ <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  _owner<span class="token punctuation">:</span> <span class="token keyword">null</span>  _store<span class="token punctuation">:</span> <span class="token punctuation">{</span>validated<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>  _self<span class="token punctuation">:</span> <span class="token keyword">null</span>  _source<span class="token punctuation">:</span> <span class="token keyword">null</span>  __proto__<span class="token punctuation">:</span> Object<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="React-Children-原理"><a href="#React-Children-原理" class="headerlink" title="React.Children 原理"></a>React.Children 原理</h2><p>在 createElement 方法中执行了 props.children，那它到底在那进行处理的呢？下面我们来介绍 React.Children 方法，定义在<code>react/packages/react/src/React.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">import</span> <span class="token punctuation">{</span>forEach<span class="token punctuation">,</span> map<span class="token punctuation">,</span> count<span class="token punctuation">,</span> toArray<span class="token punctuation">,</span> only<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactChildren'</span><span class="token punctuation">;</span><span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>  Children<span class="token punctuation">:</span> <span class="token punctuation">{</span>    map<span class="token punctuation">,</span>    forEach<span class="token punctuation">,</span>    count<span class="token punctuation">,</span>    toArray<span class="token punctuation">,</span>    only<span class="token punctuation">,</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="原理流程图"><a href="#原理流程图" class="headerlink" title="原理流程图"></a>原理流程图<hr></h3><p>React.Children.map 调度的时候创建 children 节点防⽌子节点内存抖动，由于代码量比较大所以我们来看一下流程图</p><img src="/images/react-jsx-children.png"><h3 id="map"><a href="#map" class="headerlink" title="map "></a>map <hr></h3><p>来看一下简化后的 map 代码</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">/** * The provided mapFunction(child, key, index) will be called for each * leaf child. * * @param {?*} children Children tree container. * @param {function(*, int)} func The map function. * @param {*} context Context for mapFunction. * @return {object} Object containing the ordered map of results. */</span><span class="token keyword">function</span> <span class="token function">mapChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> children<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">mapIntoWithKeyPrefixInternal</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">function</span> <span class="token function">mapIntoWithKeyPrefixInternal</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> array<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> escapedPrefix <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>prefix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    escapedPrefix <span class="token operator">=</span> <span class="token function">escapeUserProvidedKey</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> traverseContext <span class="token operator">=</span> <span class="token function">getPooledTraverseContext</span><span class="token punctuation">(</span>    array<span class="token punctuation">,</span>    escapedPrefix<span class="token punctuation">,</span>    func<span class="token punctuation">,</span>    context<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">traverseAllChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> mapSingleChildIntoContext<span class="token punctuation">,</span> traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">releaseTraverseContext</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token punctuation">{</span>  forEachChildren <span class="token keyword">as</span> forEach<span class="token punctuation">,</span>  mapChildren <span class="token keyword">as</span> map<span class="token punctuation">,</span>  countChildren <span class="token keyword">as</span> count<span class="token punctuation">,</span>  onlyChild <span class="token keyword">as</span> only<span class="token punctuation">,</span>  toArray<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="contextPool"><a href="#contextPool" class="headerlink" title="contextPool "></a>contextPool <hr></h3><p>从上面的流程图能够看出调用过程和函数的作用，那么 ContextPool 的作用是什么？那么我们来看一下 getPooledTraverseContext 和 releaseTraverseContext 方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> POOL_SIZE <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">const</span> traverseContextPool <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 获取 contextPool </span><span class="token comment" spellcheck="true">// 实际上维护了一个 size 为 10 的缓冲池</span><span class="token comment" spellcheck="true">// 如果 contextPool 中有对象, 则 pop 出一个进行使用. 如果 contextPool 为空, 则 return 一个新的对象</span><span class="token keyword">function</span> <span class="token function">getPooledTraverseContext</span><span class="token punctuation">(</span>  mapResult<span class="token punctuation">,</span>  keyPrefix<span class="token punctuation">,</span>  mapFunction<span class="token punctuation">,</span>  mapContext<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseContextPool<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 复用对象</span>    <span class="token keyword">const</span> traverseContext <span class="token operator">=</span> traverseContextPool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>result <span class="token operator">=</span> mapResult<span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>keyPrefix <span class="token operator">=</span> keyPrefix<span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>func <span class="token operator">=</span> mapFunction<span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>context <span class="token operator">=</span> mapContext<span class="token punctuation">;</span>    traverseContext<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> traverseContext<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 第一次获取 contextPool 中的对象</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      result<span class="token punctuation">:</span> mapResult<span class="token punctuation">,</span>      keyPrefix<span class="token punctuation">:</span> keyPrefix<span class="token punctuation">,</span>      func<span class="token punctuation">:</span> mapFunction<span class="token punctuation">,</span>      context<span class="token punctuation">:</span> mapContext<span class="token punctuation">,</span>      count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// traverseContext 复用之后，进行清空操作</span><span class="token comment" spellcheck="true">// 这里面有一个判断，如果 traverseContextPool 小于 10，就将 traverseContext push 到 traverseContextPool 中，进行对象的复用</span><span class="token keyword">function</span> <span class="token function">releaseTraverseContext</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>  traverseContext<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  traverseContext<span class="token punctuation">.</span>keyPrefix <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  traverseContext<span class="token punctuation">.</span>func <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  traverseContext<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  traverseContext<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseContextPool<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> POOL_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>    traverseContextPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面提到过 React.Children.map 调度的时候创建 children 节点，防⽌子节点内存抖动。<br>因为每次构建新对象的时候都会复用 contextPool。会直接从 contextPool 里获取第一个对象，也就是 traverseContextPool.pop()，进行重新进行赋值。<br>当使用完之后调用 releaseTraverseContext 再清空这个对象，最后 push traverseContextPool（contextPool）对象中，以供下次使用。这样就完成了对内存的重复使用，防止节点内存抖动。<br>如果在每次构建节点的时候都重新构建对象，那么用完之后会被系统垃圾回收，这样对于内存来讲就是反复分配，释放的过程，会造成内存抖动。</p><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结 "></a>小结 <hr></h3><p>至此, React.Children.map 就分析完了，其实 mapChildren 就是调用了 mapIntoWithKeyPrefixInternal 通过这个函数执行</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">mapIntoWithKeyPrefixInternal</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> array<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> escapedPrefix <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>prefix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    escapedPrefix <span class="token operator">=</span> <span class="token function">escapeUserProvidedKey</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 将 func（mapFunction） 处理函数和 上下文（mapContext）封装成一个对象 traverseContext </span>  <span class="token keyword">const</span> traverseContext <span class="token operator">=</span> <span class="token function">getPooledTraverseContext</span><span class="token punctuation">(</span>    array<span class="token punctuation">,</span>    escapedPrefix<span class="token punctuation">,</span>    func<span class="token punctuation">,</span>    context<span class="token punctuation">,</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 深度遍历子元素, 并调用处理函数</span>  <span class="token function">traverseAllChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> mapSingleChildIntoContext<span class="token punctuation">,</span> traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 释放 traverseContext 对象</span>  <span class="token function">releaseTraverseContext</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p><a href="http://www.que01.top/2019/06/28/react-ReactCurrentOwner/" target="_blank" rel="noopener">React ReactCurrentOwner</a><br><a href="http://js.walfud.com/React.Children.xxx%20%E7%9A%84%E4%BD%9C%E7%94%A8/" target="_blank" rel="noopener">React.Children.xxx 的作用</a></p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理之keep-alive</title>
      <link href="/2019/09/22/vue/vuekeepalive/"/>
      <url>/2019/09/22/vue/vuekeepalive/</url>
      
        <content type="html"><![CDATA[<p>在我们的平时开发工作中，有很多组件没有必要多次初始化，通过缓存组件的状态减少性能上的开销。而 vue 的组件缓存优化则使用内置组件 <keep-alive></keep-alive></p><h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive<span class="token operator">></span>  <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面代码示例说明被 keep-alive 包含的组件已经成为被缓存的组件，只渲染一次，也就是说生命周期也不起任何作用。但是如果你想要重新在某一个时机想要重新渲染，keep-alive 内置组件提供了两个钩子函数</p><ul><li>activated 当 keepalive 包含的组件再次渲染的时候触发</li><li>deactivated 当 keepalive 包含的组件销毁的时候触发</li></ul><p>vue 对 keep-alive 内置组件还提供了 3个属性作为参数进行匹配对应的组件进行缓存</p><ul><li>include 通过字符串、数组、正则表达式进行匹配，匹配到的组件会进行缓存</li><li>exclude 通过字符串、数组、正则表达式进行匹配，匹配到的组件不会进行缓存</li><li>max 通过设置字符或者数字控制组件缓存的最大个数</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 只缓存a或者b组件</span><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive include<span class="token operator">=</span><span class="token string">"a,b"</span><span class="token operator">></span>   <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span class="token comment" spellcheck="true">// c组件不被缓存</span><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive exclude<span class="token operator">=</span><span class="token string">"c"</span><span class="token operator">></span>   <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span class="token comment" spellcheck="true">// 缓存的最大个数</span><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive  max<span class="token operator">=</span><span class="token string">"5"</span><span class="token operator">></span>   <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span class="token comment" spellcheck="true">// 如果同时使用 exclude 优先级高于 include 所以只缓存 a,c 组件</span><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive include<span class="token operator">=</span><span class="token string">"a,b,c"</span> exclude<span class="token operator">=</span><span class="token string">"b"</span><span class="token operator">></span>   <span class="token operator">&lt;</span>component <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配合-router"><a href="#配合-router" class="headerlink" title="配合 router"></a>配合 router</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive <span class="token punctuation">:</span>include<span class="token operator">=</span><span class="token string">"cacheList"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>router<span class="token operator">-</span>view <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>只有路径匹配到的 name 是 cacheList 方法中返回的组件名称就会被缓存，当然也可以所有路由都缓存</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive<span class="token operator">></span>  <span class="token operator">&lt;</span>router<span class="token operator">-</span>view<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 所有路径匹配到的视图组件都会被缓存！ <span class="token operator">--</span><span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>view<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以使用 meta 属性单独控制路由的缓存</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// routes 配置</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span>    path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>    name<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>    component<span class="token punctuation">:</span> Home<span class="token punctuation">,</span>    meta<span class="token punctuation">:</span> <span class="token punctuation">{</span>      keepAlive<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// 需要被缓存</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    path<span class="token punctuation">:</span> <span class="token string">'/user-registration'</span><span class="token punctuation">,</span>    name<span class="token punctuation">:</span> <span class="token string">'user-registration'</span><span class="token punctuation">,</span>    component<span class="token punctuation">:</span> UserRegistrationManager<span class="token punctuation">,</span>    meta<span class="token punctuation">:</span> <span class="token punctuation">{</span>      keepAlive<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">// 不需要被缓存</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive<span class="token operator">></span>  <span class="token operator">&lt;</span>router<span class="token operator">-</span>view v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"$route.meta.keepAlive"</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 这里是会被缓存的视图组件，比如 Home！ <span class="token operator">--</span><span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>view<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>keep<span class="token operator">-</span>alive<span class="token operator">></span><span class="token operator">&lt;</span>router<span class="token operator">-</span>view v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"!$route.meta.keepAlive"</span><span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>   <span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>view<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="源码理解"><a href="#源码理解" class="headerlink" title="源码理解"></a>源码理解</h3><p>通过上面的例子我们已经基本的了解了 keep-alive 的使用，接下来我们通过源码来分析它的实现，它定义在<code>定义在 src/core/components/keep-alive.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> 'keep<span class="token operator">-</span>alive<span class="token punctuation">,</span>  abstract<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  props<span class="token punctuation">:</span> <span class="token punctuation">{</span>    include<span class="token punctuation">:</span> patternTypes<span class="token punctuation">,</span>    exclude<span class="token punctuation">:</span> patternTypes<span class="token punctuation">,</span>    max<span class="token punctuation">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> Number<span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  created <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  destroyed <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keys<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  mounted <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'include'</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token function">pruneCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name <span class="token operator">=</span><span class="token operator">></span> <span class="token function">matches</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'exclude'</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token function">pruneCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  render <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> slot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span><span class="token keyword">default</span>    <span class="token keyword">const</span> vnode<span class="token punctuation">:</span> VNode <span class="token operator">=</span> <span class="token function">getFirstComponentChild</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span>    <span class="token keyword">const</span> componentOptions<span class="token punctuation">:</span> <span class="token operator">?</span>VNodeComponentOptions <span class="token operator">=</span> vnode <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>componentOptions    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// check pattern</span>      <span class="token keyword">const</span> name<span class="token punctuation">:</span> <span class="token operator">?</span>string <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> include<span class="token punctuation">,</span> exclude <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        <span class="token comment" spellcheck="true">// not included</span>        <span class="token punctuation">(</span>include <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>include<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>        <span class="token comment" spellcheck="true">// excluded</span>        <span class="token punctuation">(</span>exclude <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>exclude<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> vnode      <span class="token punctuation">}</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> cache<span class="token punctuation">,</span> keys <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>      <span class="token keyword">const</span> key<span class="token punctuation">:</span> <span class="token operator">?</span>string <span class="token operator">=</span> vnode<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token keyword">null</span>        <span class="token comment" spellcheck="true">// same constructor may get registered as different local components</span>        <span class="token comment" spellcheck="true">// so cid alone is not enough (#3269)</span>        <span class="token operator">?</span> componentOptions<span class="token punctuation">.</span>Ctor<span class="token punctuation">.</span>cid <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span>tag <span class="token operator">?</span> <span class="token template-string"><span class="token string">`::</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentOptions<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span>        <span class="token punctuation">:</span> vnode<span class="token punctuation">.</span>key      <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance        <span class="token comment" spellcheck="true">// make current key freshest</span>        <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span>        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// prune oldest entry</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> vnode <span class="token operator">||</span> <span class="token punctuation">(</span>slot <span class="token operator">&amp;&amp;</span> slot<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面源码我们可以看到通过 getFirstComponentChild 函数获取第一个子节点，<keep-alive> 只处理第一个子元素，所以一般和它搭配使用的有 component 动态组件或者是 router-view，之后又根据传的 include 和 exclude， 用 matches 去做匹配，如果命中缓存则直接从缓存中拿 vnode 组件实例，重新调整 key 的顺序，放在最后一个，否则重新放进缓存，如果配置了 max 并且缓存的长度超过了 this.max 则要从缓存中删除第一个</keep-alive></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> pruneCacheEntry <span class="token punctuation">(</span>  cache<span class="token punctuation">:</span> VNodeCache<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  keys<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">></span><span class="token punctuation">,</span>  current<span class="token operator">?</span><span class="token punctuation">:</span> VNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> cached <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>current <span class="token operator">||</span> cached<span class="token punctuation">.</span>tag <span class="token operator">!==</span> current<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    cached<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>   <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="首次渲染"><a href="#首次渲染" class="headerlink" title="首次渲染"></a>首次渲染</h3><p>我们前面介绍过渲染最后在 patch 过程中会执行 createComponent 方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> createComponent <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> isReactivated <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>keepAlive    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* hydrating */</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// after calling the init hook, if the vnode is a child component</span>    <span class="token comment" spellcheck="true">// it should've created a child instance and mounted it. the child</span>    <span class="token comment" spellcheck="true">// component also has set the placeholder vnode's elm.</span>    <span class="token comment" spellcheck="true">// in that case we can just return the element and be done.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当 vnode 已经执行完 patch 后，执行 initComponent 函数：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> initComponent <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pendingInsert<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    insertedVnodeQueue<span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>insertedVnodeQueue<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pendingInsert<span class="token punctuation">)</span>    vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pendingInsert <span class="token operator">=</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>$el  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">invokeCreateHooks</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token function">setScope</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// empty component root.</span>    <span class="token comment" spellcheck="true">// skip all element-related modules except for ref (#3455)</span>    <span class="token function">registerRef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// make sure to invoke the insert hook</span>    insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里会有 vnode.elm 缓存了 vnode 创建生成的 DOM 节点。所以对于首次渲染而言，除了在 <keep-alive> 中建立缓存，和普通组件渲染没什么区别。</keep-alive></p><h3 id="缓存渲染"><a href="#缓存渲染" class="headerlink" title="缓存渲染"></a>缓存渲染</h3><p>当数据发送变化，在 patch 执行 patchVnode 的逻辑,对比新旧节点之前 会执行 prepatch 函数,定义在 <code>src/core/vdom/create-component</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>  prepatch <span class="token punctuation">(</span>oldVnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">,</span> vnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> options <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentOptions    <span class="token keyword">const</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>componentInstance    <span class="token function">updateChildComponent</span><span class="token punctuation">(</span>      child<span class="token punctuation">,</span>      options<span class="token punctuation">.</span>propsData<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// updated props</span>      options<span class="token punctuation">.</span>listeners<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// updated listeners</span>      vnode<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new parent vnode</span>      options<span class="token punctuation">.</span>children <span class="token comment" spellcheck="true">// new children</span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它会执行 updateChildComponent 方法，定义在 <code>src/core/instance/lifecycle.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> updateChildComponent <span class="token punctuation">(</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  propsData<span class="token punctuation">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>  listeners<span class="token punctuation">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>  parentVnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">,</span>  renderChildren<span class="token punctuation">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>VNode<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> hasChildren <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>    renderChildren <span class="token operator">||</span>              vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_renderChildren <span class="token operator">||</span>    parentVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>scopedSlots <span class="token operator">||</span>     vm<span class="token punctuation">.</span>$scopedSlots <span class="token operator">!==</span> emptyObject   <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>$slots <span class="token operator">=</span> <span class="token function">resolveSlots</span><span class="token punctuation">(</span>renderChildren<span class="token punctuation">,</span> parentVnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span>    vm<span class="token punctuation">.</span><span class="token function">$forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面看到在执行过中会 触发 <keep-alive> 组件实例 $forceUpdate 逻辑，也就是重新执行 <keep-alive> 的 render 方法，如果这个时候命中缓存，则直接返回 vnode.componentInstance ，再次执行 createComponent </keep-alive></keep-alive></p><pre class="line-numbers language-js"><code class="language-js">unction createComponent <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> isReactivated <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>keepAlive    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* hydrating */</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// after calling the init hook, if the vnode is a child component</span>    <span class="token comment" spellcheck="true">// it should've created a child instance and mounted it. the child</span>    <span class="token comment" spellcheck="true">// component also has set the placeholder vnode's elm.</span>    <span class="token comment" spellcheck="true">// in that case we can just return the element and be done.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个时候 isReactivated 为 true，就会执行 reactivateComponent 方法</p><pre class="line-numbers language-js"><code class="language-js">unction reactivateComponent <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i  <span class="token comment" spellcheck="true">// hack for #4339: a reactivated component with inner transition</span>  <span class="token comment" spellcheck="true">// does not trigger because the inner node's created hooks are not called</span>  <span class="token comment" spellcheck="true">// again. It's not ideal to involve module-specific logic in here but</span>  <span class="token comment" spellcheck="true">// there doesn't seem to be a better way to do it.</span>  <span class="token keyword">let</span> innerNode <span class="token operator">=</span> vnode  <span class="token keyword">while</span> <span class="token punctuation">(</span>innerNode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>    innerNode <span class="token operator">=</span> innerNode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>_vnode    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> innerNode<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>transition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>activate<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        cbs<span class="token punctuation">.</span>activate<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> innerNode<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>innerNode<span class="token punctuation">)</span>      <span class="token keyword">break</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// unlike a newly created component,</span>  <span class="token comment" spellcheck="true">// a reactivated keep-alive component doesn't insert itself</span>  <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个时候会执行 insert(parentElm, vnode.elm, refElm) 就把缓存的 DOM 对象直接插入到目标元素中，所以就不会在执行组件的 created、mounted 等钩子函数了。</p><p><keep-alive> 组件的钩子函数 activated 和 deactivated,则是定义在 insert 方法中,定义在 <code>src/core/vdom/create-component.js</code> </keep-alive></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>  insert <span class="token punctuation">(</span>vnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> context<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span> <span class="token operator">=</span> vnode    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>      componentInstance<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token function">callHook</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// vue-router#1212</span>        <span class="token comment" spellcheck="true">// During updates, a kept-alive component's child components may</span>        <span class="token comment" spellcheck="true">// change, so directly walking the tree here may call activated hooks</span>        <span class="token comment" spellcheck="true">// on incorrect children. Instead we push them into a queue which will</span>        <span class="token comment" spellcheck="true">// be processed after the whole patch process ended.</span>        <span class="token function">queueActivatedComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">activateChildComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* direct */</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过判断包裹组件是否被 mounted 分别执行 queueActivatedComponent(componentInstance) 和 activateChildComponent(componentInstance, true)</p><p>在上述两个方法中会执行 callHook(vm, ‘activated’) 钩子函数，唯一不同点是 queueActivatedComponent 是等所有的渲染完毕，在 nextTick后会执行 flushSchedulerQueue，通过队列的方式就是把整个 activated 时机延后的，而组件的 deactivated 钩子，也是同理进行递归销毁。</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理之生命周期</title>
      <link href="/2019/09/21/vue/vuelifecycle/"/>
      <url>/2019/09/21/vue/vuelifecycle/</url>
      
        <content type="html"><![CDATA[<p>每一个 vue 的实例在创建的时候都经过一系列的初始化操作，在每一个阶段都会有相对应的生命周期钩子函数，来在特定的场景实现一些功能</p><h3 id="生命周期方法"><a href="#生命周期方法" class="headerlink" title="生命周期方法"></a>生命周期方法<hr></h3><ul><li>beforeCreate（实例创建前）</li><li>created（实例创建后）</li><li>beforeMount（渲染 DOM 前）</li><li>mounted（渲染 DOM 后）</li><li>beforeUpdate（更新数据前）</li><li>updated（更新数据后）</li><li>beforeDestroy（销毁组件前）</li><li>destroyed（销毁组件后）</li></ul><h3 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程 "></a>执行流程 <hr></h3><p>通过上面生命周期的方法，看一下来至官网的一张神图，告诉我们大致的工作流程。通过每个阶段的源码来分析，在日常开发中遇到的问题。比如到底那个阶段做请求好，父子组件的生命周期在不同情况的下执行顺序是怎样的。</p><img src="/images/lifecycle.png" width="50%"><h3 id="callHook"><a href="#callHook" class="headerlink" title="callHook"></a>callHook<hr></h3><p>我们在介绍 vue 主流程的时候知道首先会执行实例的 _init(options)，然后会执行一个 merge options 的逻辑，通过调用 mergeOptions 处理不同的合并策略，其中 mergeHook 就是关于生命周期的</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> mergeHook <span class="token punctuation">(</span>  parentVal<span class="token punctuation">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token punctuation">,</span>  childVal<span class="token punctuation">:</span> <span class="token operator">?</span>Function <span class="token operator">|</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> childVal    <span class="token operator">?</span> parentVal      <span class="token operator">?</span> parentVal<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>      <span class="token punctuation">:</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>        <span class="token operator">?</span> childVal        <span class="token punctuation">:</span> <span class="token punctuation">[</span>childVal<span class="token punctuation">]</span>    <span class="token punctuation">:</span> parentVal<span class="token punctuation">}</span>LIFECYCLE_HOOKS<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>hook <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  strats<span class="token punctuation">[</span>hook<span class="token punctuation">]</span> <span class="token operator">=</span> mergeHook<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这其中的 LIFECYCLE_HOOKS 的定义在 <code>src/shared/constants.js</code> 中：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> LIFECYCLE_HOOKS <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token string">'beforeCreate'</span><span class="token punctuation">,</span>  <span class="token string">'created'</span><span class="token punctuation">,</span>  <span class="token string">'beforeMount'</span><span class="token punctuation">,</span>  <span class="token string">'mounted'</span><span class="token punctuation">,</span>  <span class="token string">'beforeUpdate'</span><span class="token punctuation">,</span>  <span class="token string">'updated'</span><span class="token punctuation">,</span>  <span class="token string">'beforeDestroy'</span><span class="token punctuation">,</span>  <span class="token string">'destroyed'</span><span class="token punctuation">,</span>  <span class="token string">'activated'</span><span class="token punctuation">,</span>  <span class="token string">'deactivated'</span><span class="token punctuation">,</span>  <span class="token string">'errorCaptured'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面我们看到了生命周期的钩子函数， 然后再通过 callHook 就能调用某个生命周期钩子注册的所有回调函数了，callHook 定义在 <code>src/core/instance/lifecycle.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> callHook <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> hook<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> handlers <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">[</span>hook<span class="token punctuation">]</span>   <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hook<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> hook`</span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> handlers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">invokeWithErrorHandling</span><span class="token punctuation">(</span>handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_hasHookEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'hook:'</span> <span class="token operator">+</span> hook<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面 callHook 主要执行了 invokeWithErrorHandling 定义在 <code>src/core/util/error.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> invokeWithErrorHandling <span class="token punctuation">(</span>  handler<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>  context<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  args<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  vm<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  info<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> res  <span class="token keyword">try</span> <span class="token punctuation">{</span>    res <span class="token operator">=</span> args <span class="token operator">?</span> handler<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">:</span> handler<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">.</span>_isVue <span class="token operator">&amp;&amp;</span> <span class="token function">isPromise</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">.</span>_handled<span class="token punctuation">)</span> <span class="token punctuation">{</span>      res<span class="token punctuation">.</span>_handled <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> res<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过调用 handler.apply(context, args) : handler.call(context)，改变了当前的 this，这就是我们在写生命周期的时候不能用箭头函数的原因。接下来我们继续探讨生命周期的执行时机。</p><h3 id="beforeCreate-amp-created"><a href="#beforeCreate-amp-created" class="headerlink" title="beforeCreate &amp; created"></a>beforeCreate &amp; created<hr></h3><p>这两个钩子函数主要是在 vue 初始化实例阶段，定义在 <code>src/core/instance/init.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_init <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>  <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// resolve injections before data/props</span>  <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// resolve provide after data/props</span>  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到 beforeCreate 是在初始化生命周期、事件，渲染函数之后调用，那么 created 是在初始化 initInjections、initState 等函数之后，那么这里的 initState 在前面的文章说过，主要是初始化 props、data、methods、watch、computed 等属性，所以 beforeCreate 中是不能够操作 data、props 等数据、也不能调用 methods 中定义的函数。 </p><h3 id="beforeMount-amp-mounted"><a href="#beforeMount-amp-mounted" class="headerlink" title="beforeMount &amp; mounted "></a>beforeMount &amp; mounted <hr></h3><p>在 mounted 阶段主要是执行了 mountComponent 方法，核心就是先实例化一个渲染 Watcher，在前面主流程中和响应式数据中我们经常提到两个核型方法 vm._render() 和 vm._update()，用于生成 DOM，mountComponent 方法定义在 <code>src/core/instance/lifecycle</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> mountComponent <span class="token punctuation">(</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  el<span class="token punctuation">:</span> <span class="token operator">?</span>Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render <span class="token operator">=</span> createEmptyVNode    <span class="token operator">...</span>  <span class="token punctuation">}</span>  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeMount'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// beforeMount 钩子</span>  <span class="token keyword">let</span> updateComponent  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>    updateComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//...</span>      <span class="token comment" spellcheck="true">// 渲染 VNode</span>      <span class="token keyword">const</span> vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// ...</span>      <span class="token comment" spellcheck="true">// 渲染真实 DOM</span>      vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    updateComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>    before <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 判断是否 mouted 完成阶段并且没有被销毁</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 数据更新之前</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* isRenderWatcher */</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// mounted 钩子</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> vm<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的代码，我们可以看出 beforeMount 钩子函数是在执行 vm._render() 函数渲染 VNode 之前执行的 ，在执行完 vm._update() 把 VNode patch 到真实 DOM 后，执行 mouted 钩子。上面有个逻辑 <code>vm.$vnode == null</code> 这表明不是一次组件的初始化过程，而是通过 new Vue() 创建的。当组件的 VNode patch 到 DOM 后，会执行 invokeInsertHook 函数，把 insertedVnodeQueue 里保存的钩子函数依次执行一遍，它的定义在 <code>src/core/vdom/patch.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> invokeInsertHook <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> initial<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 在真正插入元素后调用，延迟组件根节点的插入钩子，</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    vnode<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pendingInsert <span class="token operator">=</span> queue  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>      queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该函数会执行 insert 这个钩子函数，对于组件而言，insert 钩子函数的定义在 <code>src/core/vdom/create-component.js</code> 中的 componentVNodeHooks 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  insert <span class="token punctuation">(</span>vnode<span class="token punctuation">:</span> MountedComponentVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> context<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span> <span class="token operator">=</span> vnode    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>      componentInstance<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token function">callHook</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每个子组件都是在这个钩子函数中执行 mounted 钩子函数，insertedVnodeQueue 的添加顺序是先子后父，所以对于同步渲染的子组件而言，mounted 钩子函数的执行顺序也是先子后父。</p><h3 id="beforeUpdate-amp-updated"><a href="#beforeUpdate-amp-updated" class="headerlink" title="beforeUpdate &amp; updated "></a>beforeUpdate &amp; updated <hr></h3><p>updated 阶段也就是数据的依赖收集更新阶段，在响应式数据中我们已经提到，在文件 <code>src/core/instance/lifecycle</code> 中定义</p><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>    before <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 判断是否 mouted 完成阶段并且没有被销毁</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 调用 beforeUpdate 钩子</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* isRenderWatcher */</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面可以看到 beforeUpdate 是在满足 vm._isMounted &amp;&amp; !vm._isDestroyed 条件才会被调用的,那么 updated 调用时机是在哪里呢，它被定义在 <code>src/core/observer/scheduler.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> callUpdatedHooks <span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> queue<span class="token punctuation">.</span>length  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> watcher <span class="token operator">=</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    <span class="token keyword">const</span> vm <span class="token operator">=</span> watcher<span class="token punctuation">.</span>vm    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher <span class="token operator">===</span> watcher <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'updated'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们可以看到在执行 updated 之前，对 watcher 队列进行了遍历，只有条件满足当前 watcher 为 vm._watcher 和 mounted 阶段，才会执行 updated 钩子函数，那么接下来我们看一下 watcher 到底做了什么，其实在响应式数据中我们已经分析过，被定义在 <code>src/instance/observer/watcher.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  constructor <span class="token punctuation">(</span>    vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>    expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>    cb<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>    options<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>    isRenderWatcher<span class="token operator">?</span><span class="token punctuation">:</span> boolean  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token punctuation">}</span>    vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token operator">...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 watcher 实例化的过程中会会判断 isRenderWatcher。 接着把当前 watcher 的实例赋值给 vm._watcher,同时将 watcher 的实例 push 到 vm._watchers 中。通过 vm._watcher 对 vm 上数据变化的监测，当数据发生变化就会重新渲染。所以在 callUpdatedHooks 函数中，只有 vm._watcher 的回调执行完毕后，才会执 updated 钩子函数。所以是通过 watcher 监听实例上的数据变化来控制整个 vue 的渲染流程。</p><h3 id="beforeDestroy-amp-destroyed"><a href="#beforeDestroy-amp-destroyed" class="headerlink" title="beforeDestroy &amp; destroyed"></a>beforeDestroy &amp; destroyed<hr></h3><p>这个阶段也是最后一个阶段进行组件的销毁，它被定义在 <code>src/core/instance/lifecycle.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$destroy <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isBeingDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeDestroy'</span><span class="token punctuation">)</span>    vm<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token comment" spellcheck="true">// 从 parent 的 $children 中删掉自身</span>    <span class="token keyword">const</span> parent <span class="token operator">=</span> vm<span class="token punctuation">.</span>$parent    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parent<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>abstract<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">remove</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>$children<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 删除 watcher</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span>length    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token operator">...</span>    vm<span class="token punctuation">.</span>_isDestroyed <span class="token operator">=</span> <span class="token boolean">true</span>    vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_vnode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'destroyed'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 调用 destroyed 钩子</span>    <span class="token comment" spellcheck="true">// 关闭实例侦听器。</span>    vm<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 删除 __vue__ 引用</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 释放循环引用</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 $destroy 的执行过程中，它又会执行 <code>vm.__patch__(vm._vnode, null)</code> 触发它子组件的销毁钩子函数，这样一层层的递归调用，所以 destroy 钩子函数执行顺序是先子后父，和 mounted 过程一样。</p><p>通过上面八种钩子，我们了解了组件销毁阶段的拆卸过程，那么在官网中除了这八种钩子函数其实还有集中不常见的钩子</p><h3 id="activated-amp-deactivated"><a href="#activated-amp-deactivated" class="headerlink" title="activated &amp; deactivated"></a>activated &amp; deactivated<hr></h3><p>这两个钩子函数是 keep-alive 组件独有的。用 keep-alive 包裹的组件在切换时不会进行销毁，而是缓存到内存中并执行 deactivated 钩子函数，命中缓存渲染后会执行 activated 钩子函数。</p><h3 id="errorCaptured"><a href="#errorCaptured" class="headerlink" title="errorCaptured"></a>errorCaptured<hr></h3><p>通过 errorCaptured 钩子可以捕获来自子孙组件的错误，通过设置钩子的返回状态为 false，防止当一个错误被捕获时该组件进入无限的渲染循环，导致程序失败。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结<hr></h3><p>通过对上面的理解我们总结一下 vue 生命周期在不同场景的执行顺序</p><img src="/images/vue-lifecycle.png">]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理之组件化</title>
      <link href="/2019/09/21/vue/vuecomponents/"/>
      <url>/2019/09/21/vue/vuecomponents/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://www.studyfe.cn/2019/09/21/vue/vuelifecycle/">生命周期</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/08/vue/vuecomponentregister/">组件注册</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/10/vue/vueasync-component/">异步组件</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/12/vue/vuevmodel/">v-model</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/22/vue/vuekeepalive/">keep-alive</a></p></blockquote><blockquote><p><a href="https://www.studyfe.cn/2019/09/07/vue/vuecomputedwatcher/">computed 和 watch</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理之编译</title>
      <link href="/2019/09/19/vue/vuecompile/"/>
      <url>/2019/09/19/vue/vuecompile/</url>
      
        <content type="html"><![CDATA[<h2 id="编译入口"><a href="#编译入口" class="headerlink" title="编译入口"></a>编译入口</h2><p>还记得我们在第一篇文章介绍整理的执行过程的时候通过，在 $mount 这个函数内调用 compileToFunctions 吗？下面我们再来看看这个方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>    shouldDecodeNewlines<span class="token punctuation">,</span>    shouldDecodeNewlinesForHref<span class="token punctuation">,</span>    delimiters<span class="token punctuation">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>    comments<span class="token punctuation">:</span> options<span class="token punctuation">.</span>comments  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>  options<span class="token punctuation">.</span>render <span class="token operator">=</span> render  options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns<span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>compileToFunctions 来至于 <code>src/compiler/index.js</code> 中  createCompiler(baseOptions) </p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// createCompilerCreator 允许创建使用alternative的编译器</span><span class="token comment" spellcheck="true">// parser/optimizer/codegen, e.g the SSR optimizing compiler.</span><span class="token comment" spellcheck="true">// 这里我们只是使用默认部分导出一个默认编译器</span><span class="token keyword">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> baseCompile <span class="token punctuation">(</span>  template<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  options<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> CompiledResult <span class="token punctuation">{</span>  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    ast<span class="token punctuation">,</span>    render<span class="token punctuation">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>    staticRenderFns<span class="token punctuation">:</span> code<span class="token punctuation">.</span>staticRenderFns  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="createCompilerCreator"><a href="#createCompilerCreator" class="headerlink" title="createCompilerCreator "></a>createCompilerCreator <hr></h3><p>createCompilerCreator 来至于 <code>src/compiler/create-compiler.js</code>中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> createCompilerCreator <span class="token punctuation">(</span>baseCompile<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> createCompiler <span class="token punctuation">(</span>baseOptions<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> compile <span class="token punctuation">(</span>      template<span class="token punctuation">:</span> string<span class="token punctuation">,</span>      options<span class="token operator">?</span><span class="token punctuation">:</span> CompilerOptions    <span class="token punctuation">)</span><span class="token punctuation">:</span> CompiledResult <span class="token punctuation">{</span>      <span class="token keyword">const</span> finalOptions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span>      <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token keyword">const</span> tips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      finalOptions<span class="token punctuation">.</span>warn <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> tip<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token punctuation">(</span>tip <span class="token operator">?</span> tips <span class="token punctuation">:</span> errors<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 合并自定义模块</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>          finalOptions<span class="token punctuation">.</span>modules <span class="token operator">=</span>            <span class="token punctuation">(</span>baseOptions<span class="token punctuation">.</span>modules <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 合并自定义指令</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>directives<span class="token punctuation">)</span> <span class="token punctuation">{</span>          finalOptions<span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>            Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">.</span>directives <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            options<span class="token punctuation">.</span>directives          <span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 复制其他参数</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">'modules'</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">!==</span> <span class="token string">'directives'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            finalOptions<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">[</span>key<span class="token punctuation">]</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> finalOptions<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        errors<span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>errors<span class="token punctuation">,</span> <span class="token function">detectErrors</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>ast<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      compiled<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors      compiled<span class="token punctuation">.</span>tips <span class="token operator">=</span> tips      <span class="token keyword">return</span> compiled    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      compile<span class="token punctuation">,</span>      compileToFunctions<span class="token punctuation">:</span> <span class="token function">createCompileToFunctionFn</span><span class="token punctuation">(</span>compile<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该方法返回了一个 createCompiler 的函数，它接收一个 baseOptions 的参数，返回的是一个对象，包括 compile 方法属性和 compileToFunctions 属性，这个 compileToFunctions 对应的就是 $mount 函数调用的 compileToFunctions 方法，它是调用 createCompileToFunctionFn 方法的返回值。</p><h3 id="createCompileToFunctionFn"><a href="#createCompileToFunctionFn" class="headerlink" title="createCompileToFunctionFn "></a>createCompileToFunctionFn <hr></h3><p>我们接下来看一下 createCompileToFunctionFn 方法，它的定义在 <code>src/compiler/to-function/js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> createCompileToFunctionFn <span class="token punctuation">(</span>compile<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">const</span> cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> compileToFunctions <span class="token punctuation">(</span>    template<span class="token punctuation">:</span> string<span class="token punctuation">,</span>    options<span class="token operator">?</span><span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">,</span>    vm<span class="token operator">?</span><span class="token punctuation">:</span> Component  <span class="token punctuation">)</span><span class="token punctuation">:</span> CompiledFunctionResult <span class="token punctuation">{</span>    options <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token keyword">const</span> warn <span class="token operator">=</span> options<span class="token punctuation">.</span>warn <span class="token operator">||</span> baseWarn    <span class="token keyword">delete</span> options<span class="token punctuation">.</span>warn    <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// detect possible CSP restriction</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'return 1'</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/unsafe-eval|CSP/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">warn</span><span class="token punctuation">(</span>            <span class="token string">'It seems you are using the standalone build of Vue.js in an '</span> <span class="token operator">+</span>            <span class="token string">'environment with Content Security Policy that prohibits unsafe-eval. '</span> <span class="token operator">+</span>            <span class="token string">'The template compiler cannot work in this environment. Consider '</span> <span class="token operator">+</span>            <span class="token string">'relaxing the policy to allow unsafe-eval or pre-compiling your '</span> <span class="token operator">+</span>            <span class="token string">'templates into render functions.'</span>          <span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// check cache</span>    <span class="token keyword">const</span> key <span class="token operator">=</span> options<span class="token punctuation">.</span>delimiters      <span class="token operator">?</span> <span class="token function">String</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">)</span> <span class="token operator">+</span> template      <span class="token punctuation">:</span> template    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 编译</span>    <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 检查编译错误/提示</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>errors <span class="token operator">&amp;&amp;</span> compiled<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`Error compiling template:\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n`</span></span> <span class="token operator">+</span>          compiled<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>tips <span class="token operator">&amp;&amp;</span> compiled<span class="token punctuation">.</span>tips<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        compiled<span class="token punctuation">.</span>tips<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>msg <span class="token operator">=</span><span class="token operator">></span> <span class="token function">tip</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 将代码转换为函数</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">const</span> fnGenErrors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    res<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>render<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span>    res<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> compiled<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>code <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 检查函数生成错误.</span>    <span class="token comment" spellcheck="true">// 只有当编译器本身存在错误时，才会发生这种情况</span>    <span class="token comment" spellcheck="true">// 主要用于codegen 开发使用</span>    <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>compiled<span class="token punctuation">.</span>errors <span class="token operator">||</span> <span class="token operator">!</span>compiled<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fnGenErrors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`Failed to generate render function:\n\n`</span></span> <span class="token operator">+</span>          fnGenErrors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> err<span class="token punctuation">,</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> in\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile<hr></h3><p>通过上面函数我们看到 compileToFunctions 接收三个参数，编译模板 template，编译配置 options 和 Vue 实例 vm。核心代码只有一行</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="baseCompile"><a href="#baseCompile" class="headerlink" title="baseCompile"></a>baseCompile<hr></h3><p>compile 函数执行的逻辑是先处理配置参数，真正执行编译过程就一行代码：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> finalOptions<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>baseCompile 是在执行 createCompilerCreator 方法时作为参数传入的所以绕了一圈真正的入口就是</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// `createCompilerCreator`允许创建使用alternative的编译器</span><span class="token comment" spellcheck="true">// parser/optimizer/codegen, e.g the SSR optimizing compiler.</span><span class="token comment" spellcheck="true">// 这里我们只是使用默认部分导出一个默认编译器</span><span class="token keyword">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> baseCompile <span class="token punctuation">(</span>  template<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  options<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> CompiledResult <span class="token punctuation">{</span>  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    ast<span class="token punctuation">,</span>    render<span class="token punctuation">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>    staticRenderFns<span class="token punctuation">:</span> code<span class="token punctuation">.</span>staticRenderFns  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="主要执行步骤"><a href="#主要执行步骤" class="headerlink" title="主要执行步骤"></a>主要执行步骤<hr></h3><blockquote><p>解析模板字符串生成 AST</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>优化语法树</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>生成代码</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="parse"><a href="#parse" class="headerlink" title="parse"></a>parse</h2><p>parse 定义在 <code>src/compiler/parser/index.js</code> 中，由于编译流程较为复杂难懂所以我们只了解大概的流程</p><p>parse 接收两个参数 template 和 options 对于 options 不去研究平台特殊性，template 模板的解析主要是通过 parseHTML 函数循环解析</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对于不同情况分别进行不同的处理，在匹配的过程中会利用 advance 函数不断前进整个模板字符串，直到字符串末尾。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> advance <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>  index <span class="token operator">+</span><span class="token operator">=</span> n  html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>对于注释和条件注释节点，前进至它们的末尾位置；对于文档类型节点，则前进它自身长度的距离</li><li>通过 parseStartTag 解析开始标签(通过 startTagOpen配置开始标签，然后定义了 match 对象，通过 handleStartTag 处理 match.attrs,最后调用 options.start回调函数)</li><li>通过正则 endTag 匹配到闭合标签，然后前进到闭合标签末尾，然后执行 parseEndTag 方法对闭合，最后调用 options.end 回调函数</li><li>判断 textEnd 是否大于等于 0 说明从当前位置到 textEnd 位置都是文本，如果 extEnd 小于 0 的情况，则说明整个 template 解析完毕了，将剩余的 html 都赋值给了 text，最后调用了 options.chars 回调函数，并传 text 参数</li></ul><h3 id="options-start-处理开始标签"><a href="#options-start-处理开始标签" class="headerlink" title="options.start 处理开始标签"></a>options.start 处理开始标签<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span>start <span class="token punctuation">(</span>tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>  <span class="token function">processElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>  <span class="token function">treeManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>通过 createASTElement 创建 AST 元素</li><li>处理 AST 元素</li><li>AST 树管理</li></ul><blockquote><p>createASTElement</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// 每一个 AST 元素是一个普通的 JavaScript 对象</span><span class="token comment" spellcheck="true">// type 表示 AST 元素类型</span><span class="token comment" spellcheck="true">// tag 表示标签名</span><span class="token comment" spellcheck="true">// attrsList 表示属性列表</span><span class="token comment" spellcheck="true">// attrsMap 表示属性映射表</span><span class="token comment" spellcheck="true">// parent 表示父的 AST 元素</span><span class="token comment" spellcheck="true">// children 表示子 AST 元素集合。</span><span class="token keyword">export</span> <span class="token keyword">function</span> createASTElement <span class="token punctuation">(</span>  tag<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  attrs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Attr<span class="token operator">></span><span class="token punctuation">,</span>  parent<span class="token punctuation">:</span> ASTElement <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ASTElement <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    tag<span class="token punctuation">,</span>    attrsList<span class="token punctuation">:</span> attrs<span class="token punctuation">,</span>    attrsMap<span class="token punctuation">:</span> <span class="token function">makeAttrsMap</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">,</span>    parent<span class="token punctuation">,</span>    children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>processElement(element)</p></blockquote><p>调用 preTransforms、transforms、postTransforms 函，然后通过各种指令 processXXX 做处理，处理的结果就是扩展 AST 元素的属性，如 processFor 解析 v-for 指令内容，将解析的属性值添加到 AST 的元素上</p><blockquote><p>treeManagement()</p></blockquote><p>AST 树管理的目标是构建一颗 AST 树，本质上利用 stack 栈的数据结构来维护 root 根节点和当前父节点 currentParent。</p><h3 id="options-end-处理闭合标签"><a href="#options-end-处理闭合标签" class="headerlink" title="options.end 处理闭合标签"></a>options.end 处理闭合标签<hr></h3><pre class="line-numbers language-js"><code class="language-js">end <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">treeManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">closeElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>首先处理了尾部空格的情况,然后把 stack 的元素弹一个出栈，并把 stack 最后一个元素赋值给 currentParent，这样就维护了整个 AST 树。</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// remove trailing whitespace</span><span class="token keyword">const</span> element <span class="token operator">=</span> stack<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token keyword">const</span> lastNode <span class="token operator">=</span> element<span class="token punctuation">.</span>children<span class="token punctuation">[</span>element<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token keyword">if</span> <span class="token punctuation">(</span>lastNode <span class="token operator">&amp;&amp;</span> lastNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> lastNode<span class="token punctuation">.</span>text <span class="token operator">===</span> <span class="token string">' '</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inPre<span class="token punctuation">)</span> <span class="token punctuation">{</span>  element<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// pop stack</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span><span class="token operator">=</span> <span class="token number">1</span>currentParent <span class="token operator">=</span> stack<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token function">closeElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>closeElement 更新一下 inVPre 和 inPre 的状态，以及执行 postTransforms 函数 </p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> closeElement <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// check pre state</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token punctuation">{</span>    inVPre <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">platformIsPreTag</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    inPre <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// apply post-transforms</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> postTransforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    postTransforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> options<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="options-chars-处理文本内容"><a href="#options-chars-处理文本内容" class="headerlink" title="options.chars 处理文本内容"></a>options.chars 处理文本内容<hr></h3><pre class="line-numbers language-js"><code class="language-js">chars <span class="token punctuation">(</span>text<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">handleText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">createChildrenASTOfText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>通过执行 parseText(text, delimiters) 对文本解析, 定义在 <code>src/compiler/parser/text-parsre.js</code> 中，主要流程就是</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 先根据分隔符（默认是 `{{}}`）构造了文本匹配的正则表达式，然后再循环匹配文本</span><span class="token comment" spellcheck="true">// 遇到普通文本就 push 到 rawTokens 和 tokens 中</span><span class="token comment" spellcheck="true">// 如果是表达式就转换成 `_s(${exp})` push 到 tokens 中</span><span class="token comment" spellcheck="true">// 转换成 `{@binding:exp}` push 到 rawTokens 中</span><span class="token keyword">const</span> defaultTagRE <span class="token operator">=</span> <span class="token regex">/\{\{((?:.|\n)+?)\}\}/g</span><span class="token keyword">const</span> regexEscapeRE <span class="token operator">=</span> <span class="token regex">/[-.*+?^${}()|[\]\/\\]/g</span><span class="token keyword">const</span> buildRegex <span class="token operator">=</span> <span class="token function">cached</span><span class="token punctuation">(</span>delimiters <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> open <span class="token operator">=</span> delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regexEscapeRE<span class="token punctuation">,</span> <span class="token string">'\\$&amp;'</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> close <span class="token operator">=</span> delimiters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regexEscapeRE<span class="token punctuation">,</span> <span class="token string">'\\$&amp;'</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>open <span class="token operator">+</span> <span class="token string">'((?:.|\\n)+?)'</span> <span class="token operator">+</span> close<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">function</span> parseText <span class="token punctuation">(</span>  text<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  delimiters<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">,</span> string<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> TextParseResult <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> tagRE <span class="token operator">=</span> delimiters <span class="token operator">?</span> <span class="token function">buildRegex</span><span class="token punctuation">(</span>delimiters<span class="token punctuation">)</span> <span class="token punctuation">:</span> defaultTagRE  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tagRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> rawTokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> tagRE<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">let</span> match<span class="token punctuation">,</span> index<span class="token punctuation">,</span> tokenValue  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> tagRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    index <span class="token operator">=</span> match<span class="token punctuation">.</span>index    <span class="token comment" spellcheck="true">// push text token</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>      rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tokenValue <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span>      tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// tag token</span>    <span class="token keyword">const</span> exp <span class="token operator">=</span> <span class="token function">parseFilters</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`_s(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">)</span>    rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'@binding'</span><span class="token punctuation">:</span> exp <span class="token punctuation">}</span><span class="token punctuation">)</span>    lastIndex <span class="token operator">=</span> index <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastIndex <span class="token operator">&lt;</span> text<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>    rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tokenValue <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span>    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    expression<span class="token punctuation">:</span> tokens<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    tokens<span class="token punctuation">:</span> rawTokens  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="小结"><a href="#小结" class="headerlink" title="小结 "></a>小结 <hr></h3><ul><li>parse 的作用就是将 template 模版字符串转换成 AST 树。其实是用对象的形式来描述整个模版，用正则顺序解析模版，达到构建 AST 树的目的</li><li>AST 元素节点总共有 3 种类型，type 为 1 表示是普通元素，为 2 表示是表达式，为 3 表示是纯文本</li></ul><h2 id="optimize"><a href="#optimize" class="headerlink" title="optimize"></a>optimize</h2><p>optimize 方法的定义，在 <code>src/compiler/optimizer.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> optimize <span class="token punctuation">(</span>root<span class="token punctuation">:</span> <span class="token operator">?</span>ASTElement<span class="token punctuation">,</span> options<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token keyword">return</span>  isStaticKey <span class="token operator">=</span> <span class="token function">genStaticKeysCached</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>staticKeys <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span>  isPlatformReservedTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isReservedTag <span class="token operator">||</span> no  <span class="token comment" spellcheck="true">// first pass: mark all non-static nodes.</span>  <span class="token function">markStatic</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// second pass: mark static roots.</span>  <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> genStaticKeys <span class="token punctuation">(</span>keys<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">makeMap</span><span class="token punctuation">(</span>    <span class="token string">'type,tag,attrsList,attrsMap,plain,parent,children,attrs'</span> <span class="token operator">+</span>    <span class="token punctuation">(</span>keys <span class="token operator">?</span> <span class="token string">','</span> <span class="token operator">+</span> keys <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 optimize 函数我们看到优化主要就做了两件事情</p><h3 id="markStatic-root-标记静态节点"><a href="#markStatic-root-标记静态节点" class="headerlink" title="markStatic(root) 标记静态节点"></a>markStatic(root) 标记静态节点<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> markStatic <span class="token punctuation">(</span>node<span class="token punctuation">:</span> ASTNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>  node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// do not make component slot content static. this avoids</span>    <span class="token comment" spellcheck="true">// 1. components not able to mutate slot nodes</span>    <span class="token comment" spellcheck="true">// 2. static slot content fails for hot-reloading</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>      <span class="token operator">!</span><span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">'slot'</span> <span class="token operator">&amp;&amp;</span>      node<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'inline-template'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span>    <span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>      <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">=</span> <span class="token boolean">false</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> block <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block        <span class="token function">markStatic</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> isStatic <span class="token punctuation">(</span>node<span class="token punctuation">:</span> ASTNode<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// expression</span>    <span class="token keyword">return</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// text</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>pre <span class="token operator">||</span> <span class="token punctuation">(</span>    <span class="token operator">!</span>node<span class="token punctuation">.</span>hasBindings <span class="token operator">&amp;&amp;</span> <span class="token comment" spellcheck="true">// no dynamic bindings</span>    <span class="token operator">!</span>node<span class="token punctuation">.</span><span class="token keyword">if</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>node<span class="token punctuation">.</span><span class="token keyword">for</span> <span class="token operator">&amp;&amp;</span> <span class="token comment" spellcheck="true">// not v-if or v-for or v-else</span>    <span class="token operator">!</span><span class="token function">isBuiltInTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment" spellcheck="true">// not a built-in</span>    <span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment" spellcheck="true">// not a component</span>    <span class="token operator">!</span><span class="token function">isDirectChildOfTemplateFor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isStaticKey<span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>通过 isStatic 函数判断 AST 是否是静态</li><li>type === 2 为表达式不是静态</li><li>type === 3 是纯文本是静态</li><li>普通元素，如果有 pre 属性 是静态</li><li>没有使用 v-if、 v-for 、没有使用其它指令（不包括 v-once）、非内置组件、是平台保留的标签、节点的所有属性的 key 都满足静态 key，这些都满足则这个 AST 节点是一个静态节点</li><li>递归遍历普通元素，如果一旦子节点有不是静态的情况，则父节点的 static 变为 false</li></ul><h3 id="markStaticRoots-root-false-标记静态根"><a href="#markStaticRoots-root-false-标记静态根" class="headerlink" title="markStaticRoots(root, false) 标记静态根"></a>markStaticRoots(root, false) 标记静态根<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> markStaticRoots <span class="token punctuation">(</span>node<span class="token punctuation">:</span> ASTNode<span class="token punctuation">,</span> isInFor<span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>      node<span class="token punctuation">.</span>staticInFor <span class="token operator">=</span> isInFor    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// For a node to qualify as a static root, it should have children that</span>    <span class="token comment" spellcheck="true">// are not just static text. Otherwise the cost of hoisting out will</span>    <span class="token comment" spellcheck="true">// outweigh the benefits and it's better off to just always render it fresh.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>      node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>      node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isInFor <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>node<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">,</span> isInFor<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>对于已经是 static 的节点或者是 v-once 指令的节点，node.staticInFor = isInFor</li><li>本身是一个静态节点外，满足拥有 children，并且 children 不能只是一个文本节点，才有资格成为 staticRoot 的节点</li><li>递归遍历普通元素，如果一旦子节点有不是静态的情况，则父节点的 static 变为 false</li></ul><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结<hr></h3><p>optimize 的过程，就是深度遍历这个 AST 树，检测它的每一颗子树是不是静态节点，如果是静态节点则它们生成 DOM 永远不需要改变，这样我们在 patch 的过程就不会对比为静态属性的节点</p><h2 id="codegen"><a href="#codegen" class="headerlink" title="codegen"></a>codegen</h2><p>最后一步就是将优化过后的 AST 树转化成执行的代码</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>generate 函数的定义在 src/compiler/codegen/index.js 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> generate <span class="token punctuation">(</span>  ast<span class="token punctuation">:</span> ASTElement <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>  options<span class="token punctuation">:</span> CompilerOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> CodegenResult <span class="token punctuation">{</span>  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodegenState</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>  <span class="token keyword">const</span> code <span class="token operator">=</span> ast <span class="token operator">?</span> <span class="token function">genElement</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">'_c("div")'</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    render<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`with(this){return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span><span class="token punctuation">,</span>    staticRenderFns<span class="token punctuation">:</span> state<span class="token punctuation">.</span>staticRenderFns  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="CodegenState"><a href="#CodegenState" class="headerlink" title="CodegenState "></a>CodegenState <hr></h3><p>调用 CodegenState 函数，获取所有 modules 中的 genData 函数</p><h3 id="genElement"><a href="#genElement" class="headerlink" title="genElement "></a>genElement <hr></h3><p>调用 genElement 函数生成 code</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> genElement <span class="token punctuation">(</span>el<span class="token punctuation">:</span> ASTElement<span class="token punctuation">,</span> state<span class="token punctuation">:</span> CodegenState<span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>staticRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>staticProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genStatic</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>once <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>onceProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genOnce</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span><span class="token keyword">for</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>forProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genFor</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span><span class="token keyword">if</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>ifProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genIf</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'template'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>slotTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'void 0'</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'slot'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">genSlot</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// component or element</span>    <span class="token keyword">let</span> code    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>      code <span class="token operator">=</span> <span class="token function">genComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">,</span> el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> data <span class="token operator">=</span> el<span class="token punctuation">.</span>plain <span class="token operator">?</span> undefined <span class="token punctuation">:</span> <span class="token function">genData</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>      <span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span>inlineTemplate <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>      code <span class="token operator">=</span> <span class="token template-string"><span class="token string">`_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'${        data ? `</span></span><span class="token punctuation">,</span>$<span class="token punctuation">{</span>data<span class="token punctuation">}</span><span class="token template-string"><span class="token string">` : '' // data      }${        children ? `</span></span><span class="token punctuation">,</span>$<span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token template-string"><span class="token string">` : '' // children      })`</span></span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// module transforms</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      code <span class="token operator">=</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> code<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> code  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据 AST 的属性执行不同的代码生成函数，这里面有 genStatic、genOnce、genFor、genIf、genChildren、genSlot、genData、genComponent</p><h3 id="执行-code"><a href="#执行-code" class="headerlink" title="执行 code "></a>执行 code <hr></h3><p>用 <code>with(this){return ${code}}</code> 将 code 传入 render 中执行 new Function()</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span>res<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>render<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span><span class="token keyword">function</span> createFunction <span class="token punctuation">(</span>code<span class="token punctuation">,</span> errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> err<span class="token punctuation">,</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> noop  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="/images/vue-dom-diff12.png"></p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理之组件更新</title>
      <link href="/2019/09/18/vue/vuecomupdate/"/>
      <url>/2019/09/18/vue/vuecomupdate/</url>
      
        <content type="html"><![CDATA[<p>上一篇文章我们对响应式原理进行了梳理，知道了当数据发生变化会触发 watcher 的回调，进行组件更新，那么接下来我们看看更新的操作是怎么进行了。<code>src/core/instance/lifecycle.js</code> 中 <code>vm._update</code> 方法</p><h3 id="vm-update"><a href="#vm-update" class="headerlink" title="vm._update "></a>vm._update <hr></h3><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_update <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">:</span> VNode<span class="token punctuation">,</span> hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">const</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// initial render</span>    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* removeOnly */</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// updates</span>    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="vm-patch"><a href="#vm-patch" class="headerlink" title="vm.patch "></a>vm.<strong>patch</strong> <hr></h3><p><code>vm._update</code> 方法主要通过节点来判断传入的参数，但是执行的方法都是 <code>vm.__patch__</code>,接下我们看一下 <code>src/core/vdom/patch.js</code> 中 patch 函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">return</span> <span class="token keyword">function</span> patch <span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> isInitialPatch <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token keyword">const</span> insertedVnodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// empty mount (likely as component), create new root element</span>    isInitialPatch <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> isRealElement <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRealElement <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// patch existing root node</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>isRealElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">// ...</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// replacing existing element</span>      <span class="token keyword">const</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm      <span class="token keyword">const</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// create new node</span>      <span class="token function">createElm</span><span class="token punctuation">(</span>        vnode<span class="token punctuation">,</span>        insertedVnodeQueue<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// extremely rare edge case: do not insert if old element is in a</span>        <span class="token comment" spellcheck="true">// leaving transition. Only happens when combining transition +</span>        <span class="token comment" spellcheck="true">// keep-alive + HOCs. (#4590)</span>        oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> parentElm<span class="token punctuation">,</span>        nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>      <span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// update parent placeholder node element, recursively</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> ancestor <span class="token operator">=</span> vnode<span class="token punctuation">.</span>parent        <span class="token keyword">const</span> patchable <span class="token operator">=</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>            cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>          <span class="token punctuation">}</span>          ancestor<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm          <span class="token keyword">if</span> <span class="token punctuation">(</span>patchable<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>              cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> ancestor<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// #6513</span>            <span class="token comment" spellcheck="true">// invoke insert hooks that may have been merged by create hooks.</span>            <span class="token comment" spellcheck="true">// e.g. for directives that uses the "inserted" hook.</span>            <span class="token keyword">const</span> insert <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span>insert            <span class="token keyword">if</span> <span class="token punctuation">(</span>insert<span class="token punctuation">.</span>merged<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">// start at index 1 to avoid re-invoking component mounted hook</span>              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insert<span class="token punctuation">.</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                insert<span class="token punctuation">.</span>fns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">registerRef</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>          <span class="token punctuation">}</span>          ancestor <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>parent        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// destroy old node</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> isInitialPatch<span class="token punctuation">)</span>  <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 可以看到 patch 的逻辑进来通过判断是否有 oldVnode 来区分是否是首次渲染，进行不同的逻辑，接下来我们通过  <code>sameVNode(oldVnode, vnode)</code> </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> sameVnode <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    a<span class="token punctuation">.</span>key <span class="token operator">===</span> b<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>      <span class="token punctuation">(</span>        a<span class="token punctuation">.</span>tag <span class="token operator">===</span> b<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span>        a<span class="token punctuation">.</span>isComment <span class="token operator">===</span> b<span class="token punctuation">.</span>isComment <span class="token operator">&amp;&amp;</span>        <span class="token function">isDef</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">isDef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">sameInputType</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>        <span class="token function">isTrue</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>isAsyncPlaceholder<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        a<span class="token punctuation">.</span>asyncFactory <span class="token operator">===</span> b<span class="token punctuation">.</span>asyncFactory <span class="token operator">&amp;&amp;</span>        <span class="token function">isUndef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>asyncFactory<span class="token punctuation">.</span>error<span class="token punctuation">)</span>      <span class="token punctuation">)</span>    <span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据 vnode 的 key 进行判断是否是相同的，再继续根据 isComment、data、sameInputType 的类型是否相同来判断同步组件，对于异步组件则通过判断 asyncFactory 是否相同，所以是根据判断它们是否是相同的 vnode 来区分不同的更新逻辑</p><h3 id="新旧节点不同"><a href="#新旧节点不同" class="headerlink" title="新旧节点不同"></a>新旧节点不同<hr></h3><p>如果新旧节点不同,那么就是替换已经存在的节点大致流程为</p><ul><li>创建新节点</li><li>更新父的占位符节点</li><li>删除旧节点</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token keyword">const</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// create new node</span><span class="token function">createElm</span><span class="token punctuation">(</span>  vnode<span class="token punctuation">,</span>  insertedVnodeQueue<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// extremely rare edge case: do not insert if old element is in a</span>  <span class="token comment" spellcheck="true">// leaving transition. Only happens when combining  transition +</span>  <span class="token comment" spellcheck="true">// keep-alive + HOCs. (#4590)</span>  oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> parentElm<span class="token punctuation">,</span>  nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建新节点调用的是 createElm 方法， 以当前旧节点为参考，创建新的节点，并插入到 DOM 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// update parent placeholder node element, recursively</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> ancestor <span class="token operator">=</span> vnode<span class="token punctuation">.</span>parent  <span class="token keyword">const</span> patchable <span class="token operator">=</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>      cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    ancestor<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchable<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> ancestor<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// #6513</span>      <span class="token comment" spellcheck="true">// invoke insert hooks that may have been merged by create hooks.</span>      <span class="token comment" spellcheck="true">// e.g. for directives that uses the "inserted" hook.</span>      <span class="token keyword">const</span> insert <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span>insert      <span class="token keyword">if</span> <span class="token punctuation">(</span>insert<span class="token punctuation">.</span>merged<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// start at index 1 to avoid re-invoking component mounted hook</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insert<span class="token punctuation">.</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          insert<span class="token punctuation">.</span>fns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">registerRef</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    ancestor <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>parent  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>找到当前的 vnode 的 父的占位符节点，先执行 cbs.destroy 钩子函数，如果当前占位符是一个可挂载的节点，则执行 cbs.create 钩子函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// destroy old node</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将 oldVnode 从当前 DOM 树中删除，如果存在父节点，执行 removeVnodes 方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> removeVnodes <span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodes<span class="token punctuation">,</span> startIdx<span class="token punctuation">,</span> endIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">removeAndInvokeRemoveHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Text node</span>        <span class="token function">removeNode</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> removeAndInvokeRemoveHook <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> rm<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>rm<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> i    <span class="token keyword">const</span> listeners <span class="token operator">=</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>rm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// we have a recursively passed down rm callback</span>      <span class="token comment" spellcheck="true">// increase the listeners count</span>      rm<span class="token punctuation">.</span>listeners <span class="token operator">+</span><span class="token operator">=</span> listeners    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// directly removing</span>      rm <span class="token operator">=</span> <span class="token function">createRmCb</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// recursively invoke hooks on child component root node</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">removeAndInvokeRemoveHook</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> rm<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>      cbs<span class="token punctuation">.</span>remove<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> rm<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>remove<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> rm<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">rm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">removeNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> invokeDestroyHook <span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i<span class="token punctuation">,</span> j  <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>destroy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>遍历待删除的 vnodes 做删除，</li><li>调用 removeAndInvokeRemoveHook 执行 cbs.remove 钩子进行删除。如果存在子节点则进行递归调用 removeAndInvokeRemoveHook</li><li>调用 invokeDestroyHook 执行 cbs.destroy 钩子，进行销毁。如果存在子节点则进行递归调用 invokeDestroyHook</li><li>执行 removeNode 调用平台的 DOM API 删除真正的 DOM 节点</li></ul><h3 id="新旧节点相同"><a href="#新旧节点相同" class="headerlink" title="新旧节点相同"></a>新旧节点相同<hr></h3><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRealElement <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// patch existing root node</span>    <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当新旧节点相同的时候,会调用 patchVnode 方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> patchVnode <span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isAsyncPlaceholder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>asyncFactory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">hydrate</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      vnode<span class="token punctuation">.</span>isAsyncPlaceholder <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// reuse element for static trees.</span>  <span class="token comment" spellcheck="true">// note we only do this if the vnode is cloned -</span>  <span class="token comment" spellcheck="true">// if the new node is not cloned it means the render functions have been</span>  <span class="token comment" spellcheck="true">// reset by the hot-reload-api and we need to do a proper re-render.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    vnode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVnode<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>    <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isCloned<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isOnce<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>componentInstance    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> i  <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children  <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>      <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>    nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>postpatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>patchVnode 将 vnode patch 到旧的 vnode 上将执行以下主要过程</p><ul><li>如果两个vnode相等，不需要 patch</li><li>如果是异步占位，执行 hydrate 方法或者定义 isAsyncPlaceholder 为 true</li><li>当更新的 vnode 是组件 vnode 的时候， 执行 i.prepatch 钩子函数，拿到最新的 vnode 组件配置以及组件的实例后，执行 updateChildComponent 方法更新 vm 实例上一系列的属性和方法</li><li>执行 cbs.update 钩子函数</li><li>完成 patch 过程</li><li>执行 postpatch 钩子函数</li></ul><p>上面执行的步骤我们重点关注一下完成 patch 的过程，这也是 vnode diff 最复杂的地方</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>      <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>    nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>如果 vnode 是个文本节点且新旧文本不相同，则直接替换文本内容，否则根据不同情况处理逻辑</li><li>oldCh 与 ch 都存在且不相同时，调用 updateChildren 来更新子节点</li><li>当只有 ch 存在，判断旧的节点是文本节点则先将节点的文本清除，然后通过 addVnodes 将 ch 批量插入到新节点 elm 下，表示不需要旧节点了</li><li>当只有 oldCh 存在，将旧的节点通过 removeVnodes 全部清除，表示更新的是空节点</li><li>当只有旧节点是文本节点的时候，则清除其节点文本内容</li></ul><h3 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren "></a>updateChildren <hr></h3><p>上面在判断 oldCh 与 ch 都存在且不相同时调用 updateChildren 来更新子节点，接下来我们看看这个函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> updateChildren <span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>  <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>   <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span>   <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>   <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span>  <span class="token keyword">let</span> oldKeyToIdx<span class="token punctuation">,</span> idxInOld<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">,</span> refElm  <span class="token comment" spellcheck="true">// removeOnly 是一个只用于 &lt;transition-group> 的特殊标签，</span>  <span class="token comment" spellcheck="true">// 确保移除元素过程中保持一个正确的相对位置。</span>  <span class="token keyword">const</span> canMove <span class="token operator">=</span> <span class="token operator">!</span>removeOnly  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">checkDuplicateKeys</span><span class="token punctuation">(</span>newCh<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 开始老 vnode 向右一位</span>      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// Vnode has been moved left</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 结束老 vnode 向左一位</span>      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 新旧开始 vnode 相似，进行pacth。开始 vnode 向右一位</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 新旧结束 vnode 相似，进行patch。结束 vnode 向左一位</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Vnode moved right</span>      <span class="token comment" spellcheck="true">// 新结束 vnode 和老开始 vnode 相似，进行patch。</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// 老开始 vnode 插入到真实 DOM 中，老开始 vnode 向右一位，新结束 vnode 向左一位</span>      canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span>      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Vnode moved left</span>     <span class="token comment" spellcheck="true">// 老结束 vnode 和新开始 vnode 相似，进行 patch。</span>      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// 老结束 vnode 插入到真实 DOM 中，老结束 vnode 向左一位，新开始 vnode 向右一位</span>      canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 获取老 Idx 的 key</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// 给老 idx 赋值</span>      idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>        <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>        <span class="token punctuation">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// New element</span>        <span class="token comment" spellcheck="true">// 如果老 idx 为 undefined，说明没有这个元素，创建新 DOM 元素。</span>        <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 获取 vnode</span>        vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// 如果生成的 vnode 和新开始 vnode 相似，执行 patch。</span>          <span class="token function">patchVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">// 赋值 undefined，插入 vnodeToMove 元素</span>          oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> undefined          canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// 相同的key不同的元素，视为新元素</span>          <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// 新开始 vnode 向右一位</span>      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 如果老开始 idx 大于老结束 idx，如果是有效数据则添加 vnode 到新 vnode 中。</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">></span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm    <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">></span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的逻辑比较复杂，我们通过一个简单的例子先来看一下</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"app"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>div<span class="token operator">></span>    <span class="token operator">&lt;</span>ul<span class="token operator">></span>      <span class="token operator">&lt;</span>li v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"item in items"</span> <span class="token punctuation">:</span>key<span class="token operator">=</span><span class="token string">"item.id"</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">{</span> item<span class="token punctuation">.</span>val <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">"change"</span><span class="token operator">></span>点击我<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span>  <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    el<span class="token punctuation">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>      items<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'A'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'B'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'C'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'D'</span> <span class="token punctuation">}</span>      <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token string">'E'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码很简单就是初始化的时候渲染列表为 A、B、C、D，当点击的时候将数据中 push 一个 E 并且进行反转，结果为 D、C、B、A、E 那么具体怎么更新的呢，看一下下面的流程</p><p>第一步:<br><img src="/images/vue-dom-diff01.png"></p><p>第二步:<br><img src="/images/vue-dom-diff02.png"></p><p>第三步:<br><img src="/images/vue-dom-diff03.png"></p><p>第四步:<br><img src="/images/vue-dom-diff04.png"></p><p>第五步:<br><img src="/images/vue-dom-diff05.png"></p><p>第六步:<br><img src="/images/vue-dom-diff06.png"></p><p>通过上面流程图，我们很清晰的知道实际上就是新旧节点对比移动的过程那么我们拆分 updateChildren 函数</p><blockquote><p>初始化全局变量</p></blockquote><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment" spellcheck="true">// 旧节点索引开始位置</span>  <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">// 新节点索引开始位置</span>  <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment" spellcheck="true">// 旧节点索引终点位置</span>  <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">//  旧节点开始值</span>  <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 旧节点最后一位的值</span>  <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment" spellcheck="true">// 新节点索引结束位置</span>  <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 新节点开始值</span>  <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 新节点结束的值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>定义循环，在遍历过程中，oldStartIdx 和 newStartIdx 递增，oldEndIdx 和 newEndIdx 递减。当条件不符合跳出遍历循环</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>检测 oldStartVnode、oldEndVnode。如果 oldStartVnode 不存在，oldCh 起始点向后移动。如果 oldEndVnode 不存在，oldCh 终止点向前移动。</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>对比 oldStartVnode 和 newStartVnode 如果为真则执行 patchVnode 同时彼此向后移动一位</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>  newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> 对比 oldEndVnode 和 newEndVnode 如果为真则执行 patchVnode 同时彼此向前移动一位</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>  newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>对比 oldStartVnode 和 newEndVnode 如果为真则执行 patchVnode，然后将该节点移动到 vnode 数组最后一位</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Vnode moved right</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span>  oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>  newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>对比 oldEndVnode 和 newStartVnode 如果为真则执行 patchVnode，然后将该节点移动到 vnode 数组第一位</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Vnode moved left</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>  oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>  newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>对比 idx 如果没有相同的 idx 则执行 createElm 创建元素。</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>  <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>  <span class="token punctuation">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// New element</span>  <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> 对比 idx 如果两个 vnode 相似，则先执行 patchVnode，节点移动到 vnode 数组第一位。如果两个 vnode 不相似，视为新元素，执行 createElm 创建</p></blockquote><pre class="line-numbers language-js"><code class="language-js">vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">patchVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>  oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> undefined  canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// same key but different element. treat as new element</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">}</span>newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> 如果老 vnode 数组的开始索引大于结束索引，说明新 node 数组长度大于老 vnode 数组，执行 addVnodes 方法添加这些新 vnode 到 DOM 中</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">></span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm  <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>如果老 vnode 数组的开始索引小于结束索引，说明老 node 数组长度大于新 vnode 数组，执行 removeVnodes 方法从 DOM 中移除老 vnode 数组中多余的 vnode</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">></span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>经过上面的代码解析我们知道 vue 的 diff 对默认的 diff 执行了优化，查找的同一级的节点通过唯一的 key 去区分。如果节点类型相同重新设置该节点的属性，直接更新。如果不同，直接干掉前面的节点，创建并插入新的节点，不再比较这个节点以后的子节点。而不是同一级别每一个去比较并更新替换。如下图<br><img src="/images/vue-dom-diff08.png"></p><p>如上图我们希望在 A 和 B 之间加一个 F，那默认的 diff 算法是这样的<br><img src="/images/vue-dom-diff09.png"></p><p>vue 通过每一个节点的 key 标识符是这样的<br><img src="/images/vue-dom-diff10.png"></p><p>下面我们通过 一张图来大致总结 patchVnode 的流程<br><img src="/images/vue-dom-diff11.png"></p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理之 v-model</title>
      <link href="/2019/09/12/vue/vuevmodel/"/>
      <url>/2019/09/12/vue/vuevmodel/</url>
      
        <content type="html"><![CDATA[<p>在日常开发中我们使用 v-model 来实现数据的双向绑定，那么接下来我们通过一张流程图来大概的看看它实现的流程。具体源码解析请参考<a href="https://ustbhuangyi.github.io/vue-analysis/extend/v-model.html" target="_blank" rel="noopener">Vue.js 技术揭秘</a><br><img src="/images/vue-vmodel.png"></p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理之异步组件</title>
      <link href="/2019/09/10/vue/vueasync-component/"/>
      <url>/2019/09/10/vue/vueasync-component/</url>
      
        <content type="html"><![CDATA[<p>在我们平时的开发工作中，为了减少首屏代码体积，往往会把一些非首屏的组件设计成异步组件，按需加载。Vue 也原生支持了异步组件的能力，有三种实现方式</p><ul><li>普通的异步组件</li></ul><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'async-example'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 这个特殊的 require 语法告诉 webpack</span>   <span class="token comment" spellcheck="true">// 自动将编译后的代码分割成不同的块，</span>   <span class="token comment" spellcheck="true">// 这些块将通过 Ajax 请求自动下载。</span>   <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./my-async-component'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Promise 异步组件</li></ul><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>  <span class="token string">'async-webpack-example'</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 该 `import` 函数返回一个 `Promise` 对象。</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./my-async-component'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>高级异步组件</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> AsyncComp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 需要加载的组件。应当是一个 Promise</span>  component<span class="token punctuation">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./MyComp.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 加载中应当渲染的组件</span>  loading<span class="token punctuation">:</span> LoadingComp<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 出错时渲染的组件</span>  error<span class="token punctuation">:</span> ErrorComp<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 渲染加载中组件前的等待时间。默认：200ms。</span>  delay<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 最长等待时间。超出此时间则渲染错误组件。默认：Infinity</span>  timeout<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'async-example'</span><span class="token punctuation">,</span> AsyncComp<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的例子，我们知道异步组件的注册不再是一个对象，而是一个工厂函数，所以不会执行 Vue.extend 的逻辑把它变成一个组件的构造函数，但是它仍然可以执行到 createComponent 函数，通过createComponent 方法执行 <code>Ctor = resolveAsyncComponent(asyncFactory, baseCtor, context)</code>, 它的定义在 <code>src/core/vdom/helpers/resolve-async-component.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> resolveAsyncComponent <span class="token punctuation">(</span>  factory<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>  baseCtor<span class="token punctuation">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span><span class="token punctuation">,</span>  context<span class="token punctuation">:</span> Component<span class="token punctuation">)</span><span class="token punctuation">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>errorComp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>errorComp  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>resolved  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>loadingComp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>loadingComp  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>contexts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// already pending</span>    factory<span class="token punctuation">.</span>contexts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> contexts <span class="token operator">=</span> factory<span class="token punctuation">.</span>contexts <span class="token operator">=</span> <span class="token punctuation">[</span>context<span class="token punctuation">]</span>    <span class="token keyword">let</span> sync <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">const</span> forceRender <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> contexts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        contexts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">$forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">:</span> Object <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// cache resolved</span>      factory<span class="token punctuation">.</span>resolved <span class="token operator">=</span> <span class="token function">ensureCtor</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> baseCtor<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// invoke callbacks only if this is not a synchronous resolve</span>      <span class="token comment" spellcheck="true">// (async resolves are shimmed as synchronous during SSR)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">forceRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> reject <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span>reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>        <span class="token template-string"><span class="token string">`Failed to resolve async component: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token operator">+</span>        <span class="token punctuation">(</span>reason <span class="token operator">?</span> <span class="token template-string"><span class="token string">`\nReason: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>errorComp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        factory<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token function">forceRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// () => Promise</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> res<span class="token punctuation">.</span>component<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        res<span class="token punctuation">.</span>component<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          factory<span class="token punctuation">.</span>errorComp <span class="token operator">=</span> <span class="token function">ensureCtor</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error<span class="token punctuation">,</span> baseCtor<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          factory<span class="token punctuation">.</span>loadingComp <span class="token operator">=</span> <span class="token function">ensureCtor</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>loading<span class="token punctuation">,</span> baseCtor<span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>delay <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            factory<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                factory<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span>                <span class="token function">forceRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>delay <span class="token operator">||</span> <span class="token number">200</span><span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">reject</span><span class="token punctuation">(</span>                process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span>                  <span class="token operator">?</span> <span class="token template-string"><span class="token string">`timeout (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms)`</span></span>                  <span class="token punctuation">:</span> <span class="token keyword">null</span>              <span class="token punctuation">)</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    sync <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token comment" spellcheck="true">// return in case resolved synchronously</span>    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>loading      <span class="token operator">?</span> factory<span class="token punctuation">.</span>loadingComp      <span class="token punctuation">:</span> factory<span class="token punctuation">.</span>resolved  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码我们很直观的可以看到异步组件定义了 forceRender、resolve 和 reject 函数来执行异步组件。如果异步组件执行成功就会执行 resolve 函数，再通过 forceUpdate 的逻辑调用渲染 watcher 的 update 方法，让渲染 watcher 对应的回调函数执行，强制触发了组件的重新渲染。因为异步组件加载过程中是没有数据发生变化的，所以通过执行 $forceUpdate 可以强制组件重新渲染一次。这样其实异步组件本质是两次渲染。如果失败或者是错误则执行 reject 函数</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理之组件注册</title>
      <link href="/2019/09/08/vue/vuecomponentregister/"/>
      <url>/2019/09/08/vue/vuecomponentregister/</url>
      
        <content type="html"><![CDATA[<p>在日常开发中我们经常会用到许多自定义的组件，除了内置组件自定义组件用的时候必须注册，否则会提示如下信息</p><pre class="line-numbers language-md"><code class="language-md">'Unknown custom element: <xxx> - did you register the component correctly? For recursive components, make sure to provide the "name" option.'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在<a href="https://cn.vuejs.org/v2/guide/components-registration.html" target="_blank" rel="noopener">官网</a>中提到组件组册的方式分为全局和局部</p><h3 id="全局注册"><a href="#全局注册" class="headerlink" title="全局注册"></a>全局注册</h3><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'my-component-name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ... 选项 ...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>官方文档中有这样一句话 <strong>全局注册的行为必须在根 Vue 实例 (通过 new Vue) 创建之前发生</strong> ，那么代码被定义在 <code>src/core/global-api/assets.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> ASSET_TYPES <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared/constants'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> isPlainObject<span class="token punctuation">,</span> validateComponentName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span><span class="token keyword">export</span> <span class="token keyword">function</span> initAssetRegisters <span class="token punctuation">(</span>Vue<span class="token punctuation">:</span> GlobalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 创建注册的方法</span>  ASSET_TYPES<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>type <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    Vue<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>      id<span class="token punctuation">:</span> string<span class="token punctuation">,</span>      definition<span class="token punctuation">:</span> Function <span class="token operator">|</span> Object    <span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">===</span> <span class="token string">'component'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">validateComponentName</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'component'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          definition<span class="token punctuation">.</span>name <span class="token operator">=</span> definition<span class="token punctuation">.</span>name <span class="token operator">||</span> id          definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'directive'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> definition <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          definition <span class="token operator">=</span> <span class="token punctuation">{</span> bind<span class="token punctuation">:</span> definition<span class="token punctuation">,</span> update<span class="token punctuation">:</span> definition <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> definition        <span class="token keyword">return</span> definition      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>遍历 ASSET_TYPES，得到 type 后挂载到 Vue 上，定义在 <code>src/shared/constants.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> ASSET_TYPES <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token string">'component'</span><span class="token punctuation">,</span>  <span class="token string">'directive'</span><span class="token punctuation">,</span>  <span class="token string">'filter'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实际上 vue 是初始化了3个全局函数，那么对于 component 来说是使用 Vue.extend 把这个对象转换成一个继承于 Vue 的构造函数，最后通过 <code>this.options[type + &#39;s&#39;][id] = definition</code> 把它挂载到 <code>Vue.options.components</code> 上。然后在通过 mergeOptions 进行参数合并，最后在创建 vnode 的时候执行 _createElement 方法，定义在 <code>src/core/vdom/create-element.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> _createElement <span class="token punctuation">(</span>  context<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  tag<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span> <span class="token operator">|</span> Function <span class="token operator">|</span> Object<span class="token punctuation">,</span>  data<span class="token operator">?</span><span class="token punctuation">:</span> VNodeData<span class="token punctuation">,</span>  children<span class="token operator">?</span><span class="token punctuation">:</span> any<span class="token punctuation">,</span>  normalizationType<span class="token operator">?</span><span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> VNode <span class="token operator">|</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">let</span> vnode<span class="token punctuation">,</span> ns  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> Ctor    ns <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>ns<span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">getTagNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>Ctor <span class="token operator">=</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token string">'components'</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// component</span>      vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// direct component options / constructor</span>    vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 _createElement  方法中的 resolveAsset 拿到这个组件的构造函数，并作为 createComponent 的钩子的参数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> resolveAsset <span class="token punctuation">(</span>  options<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>  type<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  id<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  warnMissing<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> any <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 组件名称必须是字符串</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> assets <span class="token operator">=</span> options<span class="token punctuation">[</span>type<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">// 检查本地的注册变量</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> assets<span class="token punctuation">[</span>id<span class="token punctuation">]</span>  <span class="token keyword">const</span> camelizedId <span class="token operator">=</span> <span class="token function">camelize</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> camelizedId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> assets<span class="token punctuation">[</span>camelizedId<span class="token punctuation">]</span>  <span class="token keyword">const</span> PascalCaseId <span class="token operator">=</span> <span class="token function">capitalize</span><span class="token punctuation">(</span>camelizedId<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> PascalCaseId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> assets<span class="token punctuation">[</span>PascalCaseId<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">// 如果条件都满足那么返回标志，进行 createComponent</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> assets<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> assets<span class="token punctuation">[</span>camelizedId<span class="token punctuation">]</span> <span class="token operator">||</span> assets<span class="token punctuation">[</span>PascalCaseId<span class="token punctuation">]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> warnMissing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">warn</span><span class="token punctuation">(</span>      <span class="token string">'Failed to resolve '</span> <span class="token operator">+</span> type<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">': '</span> <span class="token operator">+</span> id<span class="token punctuation">,</span>      options    <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> res<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码很直观的分析到关于我们关于组件名字的注意事项</p><ul><li>直接使用 id 拿，如果不存在，则把 id 变成驼峰的形式再拿</li><li>如果仍然不存在则在驼峰的基础上把首字母再变成大写的形式再拿</li><li>如果仍然拿不到则报错</li></ul><p>这样说明了我们在使用 Vue.component(id, definition) 全局注册组件的时候，id 可以是连字符、驼峰或首字母大写的形式。那么在在<a href="https://cn.vuejs.org/v2/guide/components-registration.html" target="_blank" rel="noopener">官网</a>中关于组件的命令也写到使用 kebab-case 方式 或者 使用 PascalCase 方式</p><h3 id="局部注册"><a href="#局部注册" class="headerlink" title="局部注册"></a>局部注册</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> ComponentA <span class="token keyword">from</span> <span class="token string">'./ComponentA.vue'</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  components<span class="token punctuation">:</span> <span class="token punctuation">{</span>    ComponentA  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实通过上面全局组件的注册，局部组件就很好理解了，也是经过参数合并，通过 resolveAsset 拿到组件的构造函数，并作为createComponent 钩子的参数，区别是局部组件只有该类型的组件才可以访问局部注册的子组件，而全局注册是扩展到 Vue.options 下，所以在所有组件创建的过程中，都会从全局的 Vue.options.components 扩展到当前组件的 vm.$options.components 下，这就是全局注册的组件能被任意使用的原因。</p><h3 id="Vue-use"><a href="#Vue-use" class="headerlink" title="Vue.use"></a>Vue.use</h3><p>我们都知道使用插件的话 vue 提供一个 Vue.use 方法，具体用法见<a href="https://cn.vuejs.org/v2/api/#Vue-use" target="_blank" rel="noopener">官网文档</a>  </p><p>那么它的原理是什么呢？定义在 <code>vue/src/core/index.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// 初始化全局API</span><span class="token keyword">import</span> <span class="token punctuation">{</span> initGlobalAPI <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./global-api/index'</span><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">//初始化全局API变量</span><span class="token function">initGlobalAPI</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">default</span> Vue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>initGlobalAPI 定义在 <code>/src/core/global-api/index.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> initGlobalAPI <span class="token punctuation">(</span>Vue<span class="token punctuation">:</span> GlobalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// 初始化use()</span>  <span class="token function">initUse</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>initUse(Vue) 定义在 <code>vue/src/core/global-api/use.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> initUse <span class="token punctuation">(</span>Vue<span class="token punctuation">:</span> GlobalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Vue<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">:</span> Function <span class="token operator">|</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// installedPlugins 存储 install 后的插件</span>    <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 同一个插件只会安装一次</span>      <span class="token keyword">return</span> <span class="token keyword">this</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 插件以外的其他参数 Vue.use(MyPlugin, { someOption: true })</span>    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 如果插件是一个对象，必须提供 install 方法</span>      plugin<span class="token punctuation">.</span>install<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> args<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 如果插件是一个函数，它会被作为 install 方法</span>      plugin<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// install 之后通过队列储存插件再次安装时匹配判断避免重复安装</span>    installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">this</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面我们总结到</p><ul><li>Vue.use 对象的原理是使用 install 字段，来进行插件安装</li><li>Vue.use 调用必须在 new Vue 之前</li><li>同一个插件多次使用 Vue.use 只会被运行一次</li></ul>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>computed 和 watcher</title>
      <link href="/2019/09/07/vue/vuecomputedwatcher/"/>
      <url>/2019/09/07/vue/vuecomputedwatcher/</url>
      
        <content type="html"><![CDATA[<p>vue 的 computed 和 watch 是我们在开发中经常用的方法，从而实现数据的响应与监听，下面我们从使用和源码来分析一下这两个属性的实现原理是什么。</p><h3 id="computed-和-watch-使用"><a href="#computed-和-watch-使用" class="headerlink" title="computed 和 watch 使用"></a>computed 和 watch 使用<hr></h3><blockquote><p>computed 计算属性，根据依赖的数据动态显示新的计算结果。当依赖的属性值改变之后，通过调用对应的 getter 来计算并进行缓存，计算的属性名称不能在组件的 props 和 data 中定义，否则会报错。</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>template<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hello"</span><span class="token operator">></span>    <span class="token punctuation">{</span><span class="token punctuation">{</span>fullName<span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token punctuation">{</span>        firstName<span class="token punctuation">:</span> <span class="token string">'ren'</span><span class="token punctuation">,</span>        lastName<span class="token punctuation">:</span> <span class="token string">"bo"</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token function">fullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastName      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>watcher 侦听属性，当依赖的 data 的数据变化，执行回调方法，在方法中传入 newVal 和 oldVal。Vue 实例将会在实例化时调用 $watch()，遍历 watch 对象的每一个属性。来实现数据的监听和观察，并在使用watch 的时候可以执行异步操作，设置中间状态等。</p></blockquote><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>template<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hello"</span><span class="token operator">></span>    <span class="token punctuation">{</span><span class="token punctuation">{</span>fullName<span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">"handleChangName"</span><span class="token operator">></span>改变姓名<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      firstName<span class="token punctuation">:</span> <span class="token string">'ren'</span><span class="token punctuation">,</span>      lastName<span class="token punctuation">:</span> <span class="token string">"bo"</span><span class="token punctuation">,</span>      fullName<span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token function">handleChangName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">"zhang"</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">"san"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>    firstName<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token function">handler</span><span class="token punctuation">(</span>newval<span class="token punctuation">,</span> oldval<span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newval<span class="token punctuation">)</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>oldval<span class="token punctuation">)</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>fullName <span class="token operator">=</span> newval <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastName      <span class="token punctuation">}</span><span class="token punctuation">,</span>      immediate<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>watch 只有在数据发生变化的时候，执行回调方法，但是初始化的时候也可以执行，如上面的 firstName 方法中增加 handler 和 immediate 立即执行，具体为什么会立即执行，稍后在做分析，如果我们要监听对象中属性的添加和删除那么我们必须为 watch 中添加 deep 来进行对象深度遍历，进行监听，如下所示</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>template<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hello"</span><span class="token operator">></span>    <span class="token punctuation">{</span><span class="token punctuation">{</span>fullName<span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">"handleChangName"</span><span class="token operator">></span>改变姓名<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      person<span class="token punctuation">:</span> <span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span>        age<span class="token punctuation">:</span> <span class="token number">26</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      fullName<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token function">handleChangName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"zhangsan"</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">27</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>    person<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token function">handler</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>fullName <span class="token operator">=</span> newVal<span class="token punctuation">.</span>name <span class="token operator">+</span> newVal<span class="token punctuation">.</span>age      <span class="token punctuation">}</span><span class="token punctuation">,</span>      immediate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      deep<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="computed-和-watch-的异同"><a href="#computed-和-watch-的异同" class="headerlink" title="computed 和 watch 的异同"></a>computed 和 watch 的异同<hr></h3><p>通过上面的使用对比</p><p>相同点</p><ul><li>computed 和watch 都能起到监听和依赖处理数据</li><li>都是通过 vue 的监听器实现的</li></ul><p>不同点</p><ul><li>computed 主要用于对同步数据的处理</li><li>watch 则主要用于监听某个值的变化去完成开销较大的复杂业务逻辑</li></ul><p>主要的应用场景就是如果一个数据依赖另一个数据那么就用 computed，如果在监听数据发生变化去实现某一些功能，状态，异步等那就就用 watch，但是由于 watch 使用deep进行深度遍历监听会消耗性能，所以还是尽量少用 </p><h3 id="computed-本质-–-computed-watch"><a href="#computed-本质-–-computed-watch" class="headerlink" title="computed 本质 – computed watch"></a>computed 本质 – computed watch<hr></h3><p>前面分析过 new Vue() 的时候会调用 _init 方法，该方法会初始化生命周期，初始化事件，初始化render，初始化data，computed，methods，wacther等等，不清楚大致流程的请参考另一篇文章 <a href="https://www.studyfe.cn/2019/08/27/vue/vueprinciple/#toc-heading-12">vue 的主线流程</a>。计算属性的初始化是发生在 vue 实例初始化阶段的 initState 函数中</p><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">export</span> <span class="token keyword">function</span> initState <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* asRootData */</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面进行了判断，我们先来看看 opts.computed 存在的情况执行 initComputed 方法，该方法定义在<code>src/core/instance/state.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 用于传入 Watcher 实例的一个对象，即computed watcher</span><span class="token keyword">const</span> computedWatcherOptions <span class="token operator">=</span> <span class="token punctuation">{</span> lazy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token keyword">function</span> initComputed <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> computed<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 声明 watchers，同时在实例上挂载 _computedWatchers</span>  <span class="token keyword">const</span> watchers <span class="token operator">=</span> vm<span class="token punctuation">.</span>_computedWatchers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 计算属性在 ssr 模式在只能使用 getter 方法</span>  <span class="token keyword">const</span> isSSR <span class="token operator">=</span> <span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 遍历取出 computed 对象中的每个方法并赋值给 userDef</span>    <span class="token keyword">const</span> userDef <span class="token operator">=</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> userDef <span class="token punctuation">:</span> userDef<span class="token punctuation">.</span><span class="token keyword">get</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> getter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">warn</span><span class="token punctuation">(</span>        <span class="token template-string"><span class="token string">`Getter is missing for computed property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">".`</span></span><span class="token punctuation">,</span>        vm      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSSR<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 如果不是SSR服务端渲染，则创建一个watcher实例</span>      watchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>        vm<span class="token punctuation">,</span>        getter <span class="token operator">||</span> noop<span class="token punctuation">,</span>        noop<span class="token punctuation">,</span>        computedWatcherOptions      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 组件定义的计算属性已经在组件原型上定义。我们只需要定义在实例化时定义的计算属性。</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 如果computed 中的 key 没有设置到 vm 中，通过defineComputed函数挂载上去</span>      <span class="token function">defineComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> userDef<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// props 和 data 中不能和 computed 的 key 同名</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`The computed property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is already defined in data.`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`The computed property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is already defined as a prop.`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面源码我们发现它先声明了一个名为 watchers 的空对象，同时在 vm 上也挂载了这个空对象。接着对 computed 对象做遍历，拿到每个 userDef，如果 userDef 是 function 的话就赋给 getter，如果不是服务端渲染，就会为这个 getter 创建一个 watcher，这个 watcher 和渲染 watcher 有一点很大的不同，我们在新建实例的时候传入了第四个参数 computedWatcherOptions，其实也就是在代码的第一行，<code>const computedWatcherOptions = { lazy: true }</code>，这个对象是实现computed watcher的关键，这样watcher 中就出现了变化，watcher 定义在 <code>src/core/observer/watcher.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// options</span><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>deep  <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>user  <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy  <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>sync  <span class="token keyword">this</span><span class="token punctuation">.</span>before <span class="token operator">=</span> options<span class="token punctuation">.</span>before<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb<span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>uid <span class="token comment" spellcheck="true">// uid for batching</span><span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token comment" spellcheck="true">// for lazy watchers</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的 this.lazy 实际上就是 computedWatcherOptions 传递过来的，将 dirty 状态改为 true 之后在 createComputedGetter 方法中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> createComputedGetter <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> computedGetter <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>        watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        watcher<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> watcher<span class="token punctuation">.</span>value    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到之后执行了 watcher.evaluate()，通过调用 this.get() 方法实际上就是在执行 <code>value = this.getter.call(vm, vm)</code>，这样就能执行计算属性定义的 getter 函数</p><pre class="line-numbers language-js"><code class="language-js">  evaluate <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>之后在执行 watcher.depend() 把自身持有的 dep 添加到当前正在计算的 watcher 中，这个时候 Dep.target 就是这个 computed watcher，最后拿到当前 watcher 的 value，当计算属性依赖的数据发生改变的时候，会触发 setter 过程，通知所有订阅它变化的 watcher 进行更新，执行 watcher.update() 方法</p><pre class="line-numbers language-js"><code class="language-js">update <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="watch-的工作原理"><a href="#watch-的工作原理" class="headerlink" title="watch 的工作原理"></a>watch 的工作原理<hr></h3><p>和 computed 一样也是在执行 initState 的时候执行了 <code>initWatch(vm, opts.watch)</code></p><pre class="line-numbers language-js"><code class="language-js"> <span class="token keyword">export</span> <span class="token keyword">function</span> initState <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>initWatch 方法定义在 <code>src/core/instance/state.js</code> 中 </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> initWatch <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> watch<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> watch<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 遍历 watch 取到 key </span>    <span class="token keyword">const</span> handler <span class="token operator">=</span> watch<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 因为 Vue 是支持 watch 的同一个 key 对应多个 handler，所以如果 handler 是一个数组，则遍历这个数组</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handler<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> createWatcher <span class="token punctuation">(</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>  handler<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  options<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    options <span class="token operator">=</span> handler    handler <span class="token operator">=</span> handler<span class="token punctuation">.</span>handler  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    handler <span class="token operator">=</span> vm<span class="token punctuation">[</span>handler<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过对 hanlder 的类型做判断，拿到它最终的回调函数，最后调用 <code>vm.$watch(keyOrFn, handler, options)</code> 函数，vm.$watch 实际上是执行了 Vue.prototype.$watch</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$watch <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>    expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>    cb<span class="token punctuation">:</span> any<span class="token punctuation">,</span>    options<span class="token operator">?</span><span class="token punctuation">:</span> Object  <span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        cb<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`callback for immediate watcher "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> unwatchFn <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码可以看到，侦听属性 watch 最终会调用 $watch 方法，这个方法首先判断 cb 如果是一个对象，则调用 createWatcher 方法，这是因为 $watch 方法是用户可以直接调用的，它可以传递一个对象，也可以传递函数。接着执行 const watcher = new Watcher(vm, expOrFn, cb, options) 实例化了一个 watcher，这里需要注意一点这是一个 user watcher，因为 options.user = true。通过实例化 watcher 的方式，一旦我们 watch 的数据发送变化，它最终会执行 watcher 的 run 方法，执行回调函数 cb，上面还有两点需要注意 如果参数传递的 deep ，这样就创建了一个 deep watcher 则会执行</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行 traverse 函数进行深层递归遍历，那么这样就解决了我们开篇时使用 watch 观察改变一个复杂对象不起作用的问题，那么是 watch 立即执行是怎么做到的呢</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    cb<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`callback for immediate watcher "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过设置 immediate 为 true，则直接会执行回调函数 cb。这样就会立即执行 watch 属性</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结<hr></h3><p>通过以上的分析，我们大概了解了计算属性本质上是一个computed watch，侦听属性本质上是一个user watch。计算属性适合在模版渲染中某一个值依赖了其他响应对象甚至是计算属性计算而来，而侦听属性适用于观测某个值的变化去完成一段复杂的业务逻辑。</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理解析之响应式</title>
      <link href="/2019/09/05/vue/vueobserve/"/>
      <url>/2019/09/05/vue/vueobserve/</url>
      
        <content type="html"><![CDATA[<h2 id="响应式对象"><a href="#响应式对象" class="headerlink" title="响应式对象"></a>响应式对象</h2><p>提到 vue 的双向数据绑定原理，我们都知道是利用了 <code>Object.defineProperty</code> 给数据添加 getter 和 setter，来进行依赖收集和数据派发更新，首先我们再来熟悉一下这个方法</p><h3 id="Object-defineProperty"><a href="#Object-defineProperty" class="headerlink" title="Object.defineProperty "></a>Object.defineProperty <hr></h3><p>MDN 中写到 <code>Object.defineProperty()</code> 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Person <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'sayHello'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token keyword">set</span><span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> value  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'renbo'</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>sayHello<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// my name is renbo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们在实现一个极简版双向绑定</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>请输入:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>input<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>Object<span class="token punctuation">.</span><span class="token function">definePerperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  <span class="token keyword">get</span><span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'获得的值'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token keyword">set</span><span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'设置的值'</span><span class="token punctuation">)</span>    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> newVal    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> newVal<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">const</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>  obj<span class="token punctuation">.</span>text <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>set 提供 setter 方法，当我们对 p.name 做修改的时候会触发 setter 方法， 我们访问 sayHello 的时候会触发 getter 方法，取到对应的值，那么一旦对象拥有了 getter 和 setter，就把这个对象变为自动存取的响应对象</p><h3 id="initState"><a href="#initState" class="headerlink" title="initState "></a>initState <hr></h3><p>在 vue _init 阶段我们还执行了 initState(vm) 方法，我们上篇文章写到这个方法主要是对 props、methods、data、computed 和 wathcer 等属性做了初始化操作,在 <code>src/core/instance/state.js 中定义</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> initState <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* asRootData */</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="initProps"><a href="#initProps" class="headerlink" title="initProps "></a>initProps <hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> initProps <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> propsOptions<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> propsData <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>propsData <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>_props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// cache prop keys so that future props updates can iterate using Array</span>  <span class="token comment" spellcheck="true">// instead of dynamic object key enumeration.</span>  <span class="token keyword">const</span> keys <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_propKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> isRoot <span class="token operator">=</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>$parent  <span class="token comment" spellcheck="true">// root instance props should be converted</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> propsOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>    keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">validateProp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> propsOptions<span class="token punctuation">,</span> propsData<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> hyphenatedKey <span class="token operator">=</span> <span class="token function">hyphenate</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReservedAttribute</span><span class="token punctuation">(</span>hyphenatedKey<span class="token punctuation">)</span> <span class="token operator">||</span>          config<span class="token punctuation">.</span><span class="token function">isReservedAttr</span><span class="token punctuation">(</span>hyphenatedKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hyphenatedKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is a reserved attribute and cannot be used as component prop.`</span></span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token function">defineReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isUpdatingChildComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">warn</span><span class="token punctuation">(</span>            <span class="token template-string"><span class="token string">`Avoid mutating a prop directly since the value will be `</span></span> <span class="token operator">+</span>            <span class="token template-string"><span class="token string">`overwritten whenever the parent component re-renders. `</span></span> <span class="token operator">+</span>            <span class="token template-string"><span class="token string">`Instead, use a data or computed property based on the prop's `</span></span> <span class="token operator">+</span>            <span class="token template-string"><span class="token string">`value. Prop being mutated: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">,</span>            vm          <span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">defineReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// static props are already proxied on the component's prototype</span>    <span class="token comment" spellcheck="true">// during Vue.extend(). We only need to proxy props defined at</span>    <span class="token comment" spellcheck="true">// instantiation here.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`_props`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上面代码中我们看到 props 过程，主要就是遍历 propsOptions ，调用 defineReactive 方法和 proxy，但是上面在开发环境中调用 defineReactive 给一个警告，平时我们通过 props 方法来接受父组件所传过来的值，但是这个过程是单项的，父组件可以改变传给子组件的值，但是如果子组件想改变所接受的值并传给父组件是不可以的，会收到这个警告</p><p>这个错误告诉我们避免去直接更改 props 因为当父组件重新渲染时，该值就会被覆盖。这个时候就需要用到计算属性或者侦听属性了。</p><p>defineReactive 方法和 proxy 具体作用我们在后面介绍。</p><h3 id="initData"><a href="#initData" class="headerlink" title="initData"></a>initData<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> initData <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span>    <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>    <span class="token punctuation">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>      <span class="token string">'data functions should return an object:\n'</span> <span class="token operator">+</span>      <span class="token string">'https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function'</span><span class="token punctuation">,</span>      vm    <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// proxy data on instance</span>  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>methods<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`Method "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" has already been defined as a data property.`</span></span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>        <span class="token template-string"><span class="token string">`The data property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is already declared as a prop. `</span></span> <span class="token operator">+</span>        <span class="token template-string"><span class="token string">`Use prop default value instead.`</span></span><span class="token punctuation">,</span>        vm      <span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`_data`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// observe data</span>  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>initData 主要是遍历data，取到对应的key 调用 proxy ；另一个是调用 observe 方法</p><h3 id="proxy"><a href="#proxy" class="headerlink" title="proxy"></a>proxy<hr></h3><p>平时我们写 vue 的时候我们可以直接在方法中访问 props 和 data，看下面例子</p><pre class="line-numbers language-js"><code class="language-js">props<span class="token punctuation">:</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>    <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token string">'renbo'</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>data<span class="token punctuation">:</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>     age<span class="token punctuation">:</span> <span class="token number">26</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>  sayHello <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这就是通过 proxy 将 props 和 data 上的属性代理到 vm 实例上，所以我们可以直接通过 this 访问到</p><p>那么我们看看 proxy 是如何定义的呢</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> proxy <span class="token punctuation">(</span>target<span class="token punctuation">:</span> Object<span class="token punctuation">,</span> sourceKey<span class="token punctuation">:</span> string<span class="token punctuation">,</span> key<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>  sharedPropertyDefinition<span class="token punctuation">.</span><span class="token keyword">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> proxyGetter <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  sharedPropertyDefinition<span class="token punctuation">.</span><span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> proxySetter <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val  <span class="token punctuation">}</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sharedPropertyDefinition<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 Object.defineProperty 把 target[sourceKey][key] 的读写变成了对 target[key] 的读写，所以对于 props 和 data 而言就是</p><pre class="line-numbers language-js"><code class="language-js">vm<span class="token punctuation">.</span>_props<span class="token punctuation">.</span>xxx <span class="token operator">-</span><span class="token operator">></span> vm<span class="token punctuation">.</span>xxxvm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>xxx <span class="token operator">-</span><span class="token operator">></span> vm<span class="token punctuation">.</span>xxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="observe"><a href="#observe" class="headerlink" title="observe"></a>observe<hr></h3><p>上面在 initData中调用了 observe 函数，进入文件 <code>src/core/observer/index.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">**</span> <span class="token operator">*</span> Attempt to create an observer instance <span class="token keyword">for</span> a value<span class="token punctuation">,</span> <span class="token operator">*</span> returns the <span class="token keyword">new</span> <span class="token class-name">observer</span> <span class="token keyword">if</span> successfully observed<span class="token punctuation">,</span> <span class="token operator">*</span> or the existing observer <span class="token keyword">if</span> the value already has one<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span><span class="token keyword">export</span> <span class="token keyword">function</span> observe <span class="token punctuation">(</span>value<span class="token punctuation">:</span> any<span class="token punctuation">,</span> asRootData<span class="token punctuation">:</span> <span class="token operator">?</span>boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Observer <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> ob<span class="token punctuation">:</span> Observer <span class="token operator">|</span> <span class="token keyword">void</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__ob__ <span class="token keyword">instanceof</span> <span class="token class-name">Observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ob <span class="token operator">=</span> value<span class="token punctuation">.</span>__ob__  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>    shouldObserve <span class="token operator">&amp;&amp;</span>    <span class="token operator">!</span><span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token operator">!</span>value<span class="token punctuation">.</span>_isVue  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>asRootData <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ob<span class="token punctuation">.</span>vmCount<span class="token operator">++</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> ob<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>observe 就是给除了 vnode 的对象类型的数据添加一个观察者实例</p><p>如果已经添加过则直接返回，否则在满足一定条件下去 new Observer</p><p>接下来我们来看一下 Observer 的作用</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> any<span class="token punctuation">;</span>  dep<span class="token punctuation">:</span> Dep<span class="token punctuation">;</span>  vmCount<span class="token punctuation">:</span> number<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// number of vms that have this object as root $data</span>  constructor <span class="token punctuation">(</span>value<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span>    <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProto<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">protoAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">copyAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Walk through all properties and convert them into   * getter/setters. This method should only be called when   * value type is Object.   */</span>  walk <span class="token punctuation">(</span>obj<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Observe a list of Array items.   */</span>  observeArray <span class="token punctuation">(</span>items<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Observer 是一个构造函数</p><ul><li>在constructor 中实例化了 Dep 对象</li><li>执行了 <code>def(value, &#39;__ob__&#39;, this)</code></li><li>对 value 进行判断，如果是数组调用 observeArray，如果是纯对象调用 walk </li><li>observeArray 方法中遍历数组再次调用 observer，而 walk 遍历对象的 key 调用 defineReactive</li></ul><p>Dep 主要的作用就是进行依赖收集，是整个 getter 的核心，在后面会介绍，def 函数是通过 Object.defineProperty 的封装的，作用是将自身实例添加到数据对象 value 的 <code>__ob__</code> 属性上，这样我们在开发中就会看到 data 上对象类型的数据多了一个 <code>__ob__</code>的属性</p><h3 id="defineReactive"><a href="#defineReactive" class="headerlink" title="defineReactive"></a>defineReactive<hr></h3><p>defineReactive 的作用就是定义一个响应式对象，给对象动态添加 getter 和 setter</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * Define a reactive property on an Object. */</span><span class="token keyword">export</span> <span class="token keyword">function</span> defineReactive <span class="token punctuation">(</span>  obj<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  val<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  customSetter<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>  shallow<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// cater for pre-defined getter/setters</span>  <span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span><span class="token keyword">get</span>  <span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span><span class="token keyword">set</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>getter <span class="token operator">||</span> setter<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> reactiveGetter <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">:</span> val      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>          childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> value    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> reactiveSetter <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">:</span> val      <span class="token comment" spellcheck="true">/* eslint-disable no-self-compare */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/* eslint-enable no-self-compare */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// #7981: for accessor properties without setter</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>getter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span> <span class="token keyword">return</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        setter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        val <span class="token operator">=</span> newVal      <span class="token punctuation">}</span>      childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>defineReactive 函数</p><ul><li>new Dep()</li><li>通过 Object.getOwnPropertyDescriptor 拿到 obj 的属性描述符</li><li>对子对象递归调用 observe 方法，把所有子属性变成响应式对象</li><li>利用 Object.defineProperty 给 obj 的属性 key 添加 getter 和 setter</li></ul><p>下面我们通过上面的逻辑步骤整理下面一张图</p><img src="/images/vue-observer.png"><p>通过上面的逻辑和总结发现响应式对象的核心其实就是利用 Object.defineProperty 给数据添加了 getter 和 setter，来进行依赖收集<code>dep.depend()</code> 和派发更新 <code>dep.notify()</code></p><h2 id="依赖收集"><a href="#依赖收集" class="headerlink" title="依赖收集"></a>依赖收集</h2><p>通过响应式对象我们知道在 defineReactive 函数内的 Object.defineProperty 定义的 get 内部实例了 Dep</p><h3 id="dep"><a href="#dep" class="headerlink" title="dep"></a>dep<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>前文说过 Dep 是整个 getter 依赖收集的核心，打开文件在 <code>src/core/observer/dep.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">/** * A dep is an observable that can have multiple * directives subscribing to it. */</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> target<span class="token punctuation">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">;</span>  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>  subs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Watcher<span class="token operator">></span><span class="token punctuation">;</span>  constructor <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span>  addSub <span class="token punctuation">(</span>sub<span class="token punctuation">:</span> Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  removeSub <span class="token punctuation">(</span>sub<span class="token punctuation">:</span> Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  depend <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  notify <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// stabilize the subscriber list first</span>    <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// subs aren't sorted in scheduler if not running async</span>      <span class="token comment" spellcheck="true">// we need to sort them now to make sure they fire in correct</span>      <span class="token comment" spellcheck="true">// order</span>      subs<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// the current target watcher being evaluated.</span><span class="token comment" spellcheck="true">// this is globally unique because there could be only one</span><span class="token comment" spellcheck="true">// watcher being evaluated at any time.</span>Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">export</span> <span class="token keyword">function</span> pushTarget <span class="token punctuation">(</span>_target<span class="token punctuation">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> _target<span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> popTarget <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="watcher"><a href="#watcher" class="headerlink" title="watcher"></a>watcher<hr></h3><p>我们来看一下 Dep 中主要就是对 Watcher 的一种管理，其中 <code>subs: Array&lt;Watcher&gt;;</code> 就是订阅者列表,在Watcher 中进行定义</p><p>查看 <code>src/core/observer/watcher.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span><span class="token comment" spellcheck="true">/** * A watcher parses an expression, collects dependencies, * and fires callback when the expression value changes. * This is used for both the $watch() api and directives. */</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">;</span>  expression<span class="token punctuation">:</span> string<span class="token punctuation">;</span>  cb<span class="token punctuation">:</span> Function<span class="token punctuation">;</span>  id<span class="token punctuation">:</span> number<span class="token punctuation">;</span>  deep<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  user<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  computed<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  sync<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  dirty<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  active<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>  dep<span class="token punctuation">:</span> Dep<span class="token punctuation">;</span>  deps<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Dep<span class="token operator">></span><span class="token punctuation">;</span>  newDeps<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Dep<span class="token operator">></span><span class="token punctuation">;</span>  depIds<span class="token punctuation">:</span> SimpleSet<span class="token punctuation">;</span>  newDepIds<span class="token punctuation">:</span> SimpleSet<span class="token punctuation">;</span>  before<span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">;</span>  getter<span class="token punctuation">:</span> Function<span class="token punctuation">;</span>  value<span class="token punctuation">:</span> any<span class="token punctuation">;</span>  constructor <span class="token punctuation">(</span>    vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>    expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>    cb<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>    options<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>    isRenderWatcher<span class="token operator">?</span><span class="token punctuation">:</span> boolean  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token punctuation">}</span>    vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// options</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>deep      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>user      <span class="token keyword">this</span><span class="token punctuation">.</span>computed <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>computed      <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>sync      <span class="token keyword">this</span><span class="token punctuation">.</span>before <span class="token operator">=</span> options<span class="token punctuation">.</span>before    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>uid <span class="token comment" spellcheck="true">// uid for batching</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed <span class="token comment" spellcheck="true">// for computed watchers</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span>      <span class="token operator">?</span> expOrFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token comment" spellcheck="true">// parse expression for getter</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`Failed watching path: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expOrFn<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" `</span></span> <span class="token operator">+</span>          <span class="token string">'Watcher only accepts simple dot-delimited paths. '</span> <span class="token operator">+</span>          <span class="token string">'For full control, use a function instead.'</span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> undefined      <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Evaluate the getter, and re-collect dependencies.   */</span>  <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> value    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm    <span class="token keyword">try</span> <span class="token punctuation">{</span>      value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`getter for watcher "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> e      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// "touch" every property so they are all tracked as</span>      <span class="token comment" spellcheck="true">// dependencies for deep watching</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> value  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Add a dependency to this directive.   */</span>  addDep <span class="token punctuation">(</span>dep<span class="token punctuation">:</span> Dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Clean up for dependency collection.   */</span>  cleanupDeps <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        dep<span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depIds    <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> tmp    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> tmp    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="依赖收集过程"><a href="#依赖收集过程" class="headerlink" title="依赖收集过程"></a>依赖收集过程<hr></h3><p>当我们在 mount 过程中调用 mountComponent 函数的时候实例化了 <code>new Watcher</code>, 然后执行了 <code>this.get()</code> 方法<br>进入 get 函数 会执行 <code>pushTarget(this)</code></p><p>打开文件 <code>src/core/observer/dep.js</code> </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> pushTarget <span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>  targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>pushTarget 主要两个作用 </p><ul><li>把 Dep.target 赋值为当前的 Watcher</li><li>将 target 进行压栈操作</li></ul><p>接着执行</p><pre class="line-numbers language-js"><code class="language-js">value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>this.getter 对应就是 updateComponent 函数，这实际上就是在执行：</p><pre class="line-numbers language-js"><code class="language-js">vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>它会先执行 vm._render() 方法，生成渲染 VNode，访问 vm 上的数据，这样就触发了数据对象的 getter。<br>每个getter 上都有一个 dep ，这样就是调用 dep.depend() 进行依赖收集</p><pre class="line-numbers language-js"><code class="language-js">addDep <span class="token punctuation">(</span>dep<span class="token punctuation">:</span> Dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在保证添加的数据的唯一性 后执行 <code>dep.addSub(this)</code></p><p>也就是执行了<code>this.subs.push(sub)</code></p><p>通过上面的执行顺序，当前的 watcher 已经订阅到了数据 dep 的 subs 数组中，当数据放生改变在进行 dep.notify</p><p>接下来执行递归去访问 value，触发它所有子项的 getter</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>之后执行 popTarget(),打开文件 <code>src/core/observer/dep.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> popTarget <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">[</span>targetStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这个时候 vm 的数据依赖收集已经完成需要将 Dep.target 改变成上一个状态，完成  Dep.target 渲染，最后执行<code>this.cleanupDeps()</code> 进行依赖清空</p><pre class="line-numbers language-js"><code class="language-js">cleanupDeps <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      dep<span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depIds  <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds  <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> tmp  <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps  <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps  <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> tmp  <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在执行 cleanupDeps 函数，首先遍历 deps，移除对 dep.subs 数组中 Wathcer 的订阅，把 newDepIds 和 depIds 交换，newDeps 和 deps 交换，并把 newDepIds 和 newDeps 清空，因为 newDeps 是新添加的 Dep 实例数组，而 deps 表示上一次添加的 Dep 实例数组，所以每次订阅，在subs 中都是最新的，这样就完成了整个依赖收集</p><h2 id="派发更新"><a href="#派发更新" class="headerlink" title="派发更新"></a>派发更新</h2><p>通过 sub 这个数组，当我们修改数据的时候，就可以更新 sub 数组 进行派发更新，下面在进行代码分析这个过程</p><h3 id="setter-逻辑"><a href="#setter-逻辑" class="headerlink" title="setter 逻辑"></a>setter 逻辑<hr></h3><p>通过 <code>defineReactive</code> 函数中，定义响应式的 setter 调用了 <code>dep.notify()</code> 来通知所有订阅者，我们要更新了。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> defineReactive <span class="token punctuation">(</span>  obj<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  val<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  customSetter<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>  shallow<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// cater for pre-defined getter/setters</span>  <span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span><span class="token keyword">get</span>  <span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span><span class="token keyword">set</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>getter <span class="token operator">||</span> setter<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> reactiveSetter <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">:</span> val      <span class="token comment" spellcheck="true">/* eslint-disable no-self-compare */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/* eslint-enable no-self-compare */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        setter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        val <span class="token operator">=</span> newVal      <span class="token punctuation">}</span>      childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="派发更新过程"><a href="#派发更新过程" class="headerlink" title="派发更新过程"></a>派发更新过程<hr></h3><p>当我们修改了数据，触发了 setter ，调用 <code>dep.notify()</code> ,遍历所有 subs，调用 watcher 的 update 方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/core/observer/dep.js</span><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  notify <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// stabilize the subscriber list first</span>    <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/core/observer/watcher.js</span><span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  update <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// A computed property watcher has two modes: lazy and activated.</span>      <span class="token comment" spellcheck="true">// It initializes as lazy by default, and only becomes activated when</span>      <span class="token comment" spellcheck="true">// it is depended on by at least one subscriber, which is typically</span>      <span class="token comment" spellcheck="true">// another computed property or a component's render function.</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">.</span>subs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// In lazy mode, we don't want to perform computations until necessary,</span>        <span class="token comment" spellcheck="true">// so we simply mark the watcher as dirty. The actual computation is</span>        <span class="token comment" spellcheck="true">// performed just-in-time in this.evaluate() when the computed property</span>        <span class="token comment" spellcheck="true">// is accessed.</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// In activated mode, we want to proactively perform the computation</span>        <span class="token comment" spellcheck="true">// but only notify our subscribers when the value has indeed changed.</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAndInvoke</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在进行 update 的时候会根据不同场景去派发更新，computed 与 sync 我们放在后面来说，这两个状态也就是我们的计算属性（computed）和侦听属性（watch），先看一下 queueWatcher </p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/core/observer/scheduler.js</span><span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Watcher<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">let</span> has<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> number<span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">let</span> waiting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token keyword">let</span> flushing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token comment" spellcheck="true">/** * Push a watcher into the watcher queue. * Jobs with duplicate IDs will be skipped unless it's * pushed when the queue is being flushed. */</span><span class="token keyword">export</span> <span class="token keyword">function</span> queueWatcher <span class="token punctuation">(</span>watcher<span class="token punctuation">:</span> Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id  <span class="token keyword">if</span> <span class="token punctuation">(</span>has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushing<span class="token punctuation">)</span> <span class="token punctuation">{</span>      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// if already flushing, splice the watcher based on its id</span>      <span class="token comment" spellcheck="true">// if already past its id, it will be run next immediately.</span>      <span class="token keyword">let</span> i <span class="token operator">=</span> queue<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">></span> index <span class="token operator">&amp;&amp;</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">></span> watcher<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        i<span class="token operator">--</span>      <span class="token punctuation">}</span>      queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> watcher<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// queue the flush</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waiting<span class="token punctuation">)</span> <span class="token punctuation">{</span>      waiting <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token function">nextTick</span><span class="token punctuation">(</span>flushSchedulerQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用 has 保证在同一个 watcher 只添加一次，并且在派发更新的时候每次数据改变并不会都触发 watcher ，而是把watcher添加到队列里面通过执行 nextTick，下面来看一下 <code>flushSchedulerQueue</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/core/observer/scheduler.js</span><span class="token keyword">let</span> flushing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token comment" spellcheck="true">/** * Flush both queues and run the watchers. */</span><span class="token keyword">function</span> flushSchedulerQueue <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  flushing <span class="token operator">=</span> <span class="token boolean">true</span>  <span class="token keyword">let</span> watcher<span class="token punctuation">,</span> id  <span class="token comment" spellcheck="true">// Sort queue before flush.</span>  <span class="token comment" spellcheck="true">// This ensures that:</span>  <span class="token comment" spellcheck="true">// 1. Components are updated from parent to child. (because parent is always</span>  <span class="token comment" spellcheck="true">//    created before the child)</span>  <span class="token comment" spellcheck="true">// 2. A component's user watchers are run before its render watcher (because</span>  <span class="token comment" spellcheck="true">//    user watchers are created before the render watcher)</span>  <span class="token comment" spellcheck="true">// 3. If a component is destroyed during a parent component's watcher run,</span>  <span class="token comment" spellcheck="true">//    its watchers can be skipped.</span>  queue<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// do not cache length because more watchers might be pushed</span>  <span class="token comment" spellcheck="true">// as we run existing watchers</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    watcher <span class="token operator">=</span> queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>      watcher<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>    watcher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// in dev build, check and stop circular updates.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">></span> MAX_UPDATE_COUNT<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token string">'You may have an infinite update loop '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>            watcher<span class="token punctuation">.</span>user              <span class="token operator">?</span> <span class="token template-string"><span class="token string">`in watcher with expression "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span>              <span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`in a component render function.`</span></span>          <span class="token punctuation">)</span><span class="token punctuation">,</span>          watcher<span class="token punctuation">.</span>vm        <span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// keep copies of post queues before resetting state</span>  <span class="token keyword">const</span> activatedQueue <span class="token operator">=</span> activatedChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> updatedQueue <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">resetSchedulerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// call component updated and activated hooks</span>  <span class="token function">callActivatedHooks</span><span class="token punctuation">(</span>activatedQueue<span class="token punctuation">)</span>  <span class="token function">callUpdatedHooks</span><span class="token punctuation">(</span>updatedQueue<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// devtool hook</span>  <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>devtools <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>devtools<span class="token punctuation">)</span> <span class="token punctuation">{</span>    devtools<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'flush'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先执行对队列做了从小到大的排序</p><ol><li><p>组件的更新由父到子；因为父组件的创建过程是先于子的，所以 watcher 的创建也是先父后子，执行顺序也应该保持先父后子。</p></li><li><p>用户的自定义 watcher 要优先于渲染 watcher 执行；因为用户自定义 watcher 是在渲染 watcher 之前创建的。</p></li><li><p>如果一个组件在父组件的 watcher 执行期间被销毁，那么它对应的 watcher 执行都可以被跳过，所以父组件的 watcher 应该先执行。</p></li></ol><p>其次进行队列遍历</p><p>拿到对应的 watcher，执行 watcher.run()。如果在遍历的时候，用户有再添加新的 watcher 动作， 那么就在队列中从后往前找，找到第一个没有插入的 watcher 的 id 比当前队列中 watcher 的 id 的大的位置，放到队列中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> queueWatcher <span class="token punctuation">(</span>watcher<span class="token punctuation">:</span> Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id  <span class="token keyword">if</span> <span class="token punctuation">(</span>has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushing<span class="token punctuation">)</span> <span class="token punctuation">{</span>      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// if already flushing, splice the watcher based on its id</span>      <span class="token comment" spellcheck="true">// if already past its id, it will be run next immediately.</span>      <span class="token keyword">let</span> i <span class="token operator">=</span> queue<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">></span> index <span class="token operator">&amp;&amp;</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">></span> watcher<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        i<span class="token operator">--</span>      <span class="token punctuation">}</span>      queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> watcher<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样在执行 <code>watcher.run()</code> 时候，通过 <code>this.get()</code> 就能得到 watcher 当前的值，然后通过判断 新旧值不等、新值是对象类型、deep 模式中的任何一个条件成立都会触发 watcher 回调，传入新的 value 和 旧的 value，这样我们在我们自定义 watcher 的时候就可以在回调函数中拿到两个值。</p><p>当我们数据发生改变的时候，触发setter ，因为 watcher 是一个队列，通过调度进行了优化 在 nextTick 后执行所有 <code>watcher</code> 的 run 然后触发所有 watcher 的 update 进行进行 patch</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结 "></a>总结 <hr></h3><img src="/images/vue-dep.png"><p>通过上面几个模块的分析我们基本知道了 vue 的响应式过程，在生成响应对象的时候需要注意的是，vue 更新对象数组必须用他的全局方法也就是 <code>vue.set,vue.get,vue.del</code> 等，否则是不会触发setter，导致视图更新失败。</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 原理解析之主线流程</title>
      <link href="/2019/08/27/vue/vueprinciple/"/>
      <url>/2019/08/27/vue/vueprinciple/</url>
      
        <content type="html"><![CDATA[<div align="middle">  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=436394160&auto=1&height=66">  </iframe></div><h2 id="源码架构"><a href="#源码架构" class="headerlink" title="源码架构"></a>源码架构</h2><p>vue 一直以简单，快速著称，也自称为渐进式框架今天我们来分析一下vue的源码，这样我们也能了解其中的思想，帮助我们在工作中很好的应用和解决问题。当然我们并不可能把源码很细致的分析个遍，那样没什么意义。<br>附上 git 仓库<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue源码</a>地址。</p><p>我们看一下 vue 源码的核心目录方便大家去对应查找</p><pre class="line-numbers language-md"><code class="language-md">src├── compiler/        # 模版编译目录 ├── core/            # 核心代码 ├── platforms/       # 跨平台的支持├── server/          # 处理服务端渲染├── sfc/             # .vue 文件的解析├── shared/          # 全局用到的工具函数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="compiler"><a href="#compiler" class="headerlink" title="compiler"></a>compiler<hr></h3><p>vue 所有编译相关的代码。包括把模版解析成抽象语法树（AST）,编译、生成等功能</p><h3 id="core"><a href="#core" class="headerlink" title="core"></a>core<hr></h3><p>vue 核心代码，包括内置组件，指令、全局API、Observer、虚拟DOM、全局工具函数等，这个目录也是vue的灵魂，也是我们重点关注分析的地方，compiler 会在后续文章中分析</p><h3 id="platform"><a href="#platform" class="headerlink" title="platform"></a>platform<hr></h3><p>最初 vue 是跑在 web 上的mvvm架构, 后期增加了 阿里团队的 weex 入口，配合 weex 也可以运行在 native 客户端上</p><h3 id="server"><a href="#server" class="headerlink" title="server "></a>server <hr></h3><p>服务端渲染入口，这是是vue2.0 之后更新的功能，所谓的服务端渲染是把相对应的组件渲染为服务端的 html 字符串，然后发送给客户端，客户端进行处理。这样做能提高客户体验</p><h3 id="sfc"><a href="#sfc" class="headerlink" title="sfc"></a>sfc<hr></h3><p>将 .vue 文件内容解析成JavaScript的对象</p><h2 id="源码构建"><a href="#源码构建" class="headerlink" title="源码构建"></a>源码构建</h2><p>vue 源码是基于 <a href="https://rollupjs.org/guide/en/" target="_blank" rel="noopener">Rollup </a>构建的，构建的配置在 scripts 目录下</p><pre class="line-numbers language-md"><code class="language-md">scripts├── git-hook/           # git-hook配置文件├── alias               # 混入文件目录别名配置├── build               # 构建的入口文件├── config              # 构建全局配置文件├── feature-flags       # weex 环境 flag├── gen-release-note    # 生成 Change log├── get-weex-version    # 生成 weexBaseVersion├── release-weex        # weex发布的脚本├── release             # 发布脚本├── verify-commit-msg   # 检查 Commit message 是否符合格式<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="构建脚本"><a href="#构建脚本" class="headerlink" title="构建脚本"></a>构建脚本<hr></h3><p>基于 npm 托管的项目都会有一个 package.json 文件，这个文件当中的 script 描述符中一般配置的基本都是启动项目、打包、测试等相关命令, 看一下 vue 项目根目录的 package.json,由于只做 build 环境中的分析，所以我们去掉 dev、test等执行命令</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node scripts/build.js"</span><span class="token punctuation">,</span>    <span class="token property">"build:ssr"</span><span class="token operator">:</span> <span class="token string">"npm run build -- web-runtime-cjs,web-server-renderer"</span><span class="token punctuation">,</span>    <span class="token property">"build:weex"</span><span class="token operator">:</span> <span class="token string">"npm run build -- weex"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面三个命令在执行的时候通过环境参数来区分不同的平台，当执行 <code>npm run build</code> 命令的时候就会执行 <code>node scripts/build.js</code> 这个文件</p><h3 id="构建过程"><a href="#构建过程" class="headerlink" title="构建过程"></a>构建过程<hr></h3><p>接下来来查看一下 <code>node scripts/build.js</code> 这个文件看看执行过程</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> builds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllBuilds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// filter builds via command line arg</span><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> filters <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>  builds <span class="token operator">=</span> builds<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>b <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> filters<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>f <span class="token operator">=</span><span class="token operator">></span> b<span class="token punctuation">.</span>output<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> b<span class="token punctuation">.</span>_name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// filter out weex builds by default</span>  builds <span class="token operator">=</span> builds<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>b <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> b<span class="token punctuation">.</span>output<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'weex'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token function">build</span><span class="token punctuation">(</span>builds<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的代码片段了解到主要引用了 <code>./config</code> getAllBuilds 文件下面的方法，进入这个文件</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> builds <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">const</span> aliases <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./alias'</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> resolve <span class="token operator">=</span> p <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> base <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>aliases<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// Runtime only (CommonJS). Used by bundlers e.g. Webpack &amp; Browserify</span>  <span class="token string">'web-runtime-cjs-prod'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    dest<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.runtime.common.prod.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    format<span class="token punctuation">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>    env<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>    banner  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// runtime-only production build (Browser)</span>  <span class="token string">'web-runtime-prod'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    dest<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.runtime.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    format<span class="token punctuation">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>    env<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>    banner  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// Runtime+compiler CommonJS build (CommonJS)</span>  <span class="token string">'web-full-prod'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    dest<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    format<span class="token punctuation">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>    env<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>    alias<span class="token punctuation">:</span> <span class="token punctuation">{</span> he<span class="token punctuation">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    banner  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token keyword">function</span> genConfig <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> opts <span class="token operator">=</span> builds<span class="token punctuation">[</span>name<span class="token punctuation">]</span>  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>    input<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>entry<span class="token punctuation">,</span>    external<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>external<span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token function">flow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">alias</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> aliases<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>alias<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>plugins <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>      file<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>dest<span class="token punctuation">,</span>      format<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>format<span class="token punctuation">,</span>      banner<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>banner<span class="token punctuation">,</span>      name<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>moduleName <span class="token operator">||</span> <span class="token string">'Vue'</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'_name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    enumerable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    value<span class="token punctuation">:</span> name  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> config<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过这里的代码片面大概了解到 vue 通过当前web、服务端渲染、webpack插件、weex等配置来进行打包，每一个配置都遵循 rollup 的构建规则</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"entry"</span><span class="token operator">:</span> <span class="token string">"构建的入口文件"</span><span class="token punctuation">,</span>  <span class="token property">"dest"</span><span class="token operator">:</span> <span class="token string">"构建后的文件地址"</span><span class="token punctuation">,</span>  <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"构建规范"</span><span class="token punctuation">,</span>  <span class="token property">"alias"</span><span class="token operator">:</span> <span class="token string">"别名设置"</span>   // ...<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么在打包的过程中进行了路径别名设置，通过别名设置能代码能够更清晰整洁。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token keyword">const</span> resolve <span class="token operator">=</span> p <span class="token operator">=</span><span class="token operator">></span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  vue<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/platforms/web/entry-runtime-with-compiler'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  compiler<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/compiler'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  core<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/core'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  shared<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/shared'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  web<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/platforms/web'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  weex<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/platforms/weex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  server<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  sfc<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/sfc'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看到这个别名设置，我们就应该很清楚 vue 的核心构建文件都在 src 目录，具体作用在文章开头就已经介绍过了。那么我们主要看 web 别名下的目录，其它的目录有兴趣的同学可以了解一下实现规则</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'core/index'</span><span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">'core/config'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> extend<span class="token punctuation">,</span> noop <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared/util'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> mountComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/instance/lifecycle'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> devtools<span class="token punctuation">,</span> inBrowser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/util/index'</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">import</span> <span class="token punctuation">{</span> patch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./patch'</span><span class="token keyword">import</span> platformDirectives <span class="token keyword">from</span> <span class="token string">'./directives/index'</span><span class="token keyword">import</span> platformComponents <span class="token keyword">from</span> <span class="token string">'./components/index'</span><span class="token comment" spellcheck="true">// install platform runtime directives &amp; components</span><span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> platformDirectives<span class="token punctuation">)</span><span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> platformComponents<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// install platform patch function</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__patch__ <span class="token operator">=</span> inBrowser <span class="token operator">?</span> patch <span class="token punctuation">:</span> noop<span class="token comment" spellcheck="true">// public mount method</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>  el<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">:</span> undefined  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>终于看到了 Vue 构造函数和核心代码的入口<code>core/index</code>，并在构造函数和原型上面挂载了一些方法，通过执行的上述构建过程我们总结到</p><p>Vue.js 的组成是由 core + 对应的 ‘平台’ 补充代码构成(独立构建和运行时构建 只是 platforms 下 web 平台的两种选择)</p><img src="/images/vue-init.png" width="50%"><h2 id="new-Vue"><a href="#new-Vue" class="headerlink" title="new Vue"></a>new Vue</h2><p>通过 vue 的核心目录，我们知道 Vue 实际上是一个构造函数，上面挂满了大大小小的各种方法我们在用的时候传一定的参数即可</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> <span class="token string">'xxxx'</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> xxxx<span class="token punctuation">,</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="initGlobalAPI"><a href="#initGlobalAPI" class="headerlink" title="initGlobalAPI"></a>initGlobalAPI<hr></h3><p>那么在 vue 实例化的过程中到底发生了什么，打开核心代码 <code>src/core</code> 目录下面的 index</p><pre class="line-numbers language-js"><code class="language-js">src<span class="token operator">/</span>core<span class="token operator">/</span>index<span class="token punctuation">.</span>js<span class="token comment" spellcheck="true">// vue初始化的核心文件--创建Vue构造函数，将构造函数传入五个方法中</span><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'./instance/index'</span><span class="token comment" spellcheck="true">// 初始化全局API</span><span class="token keyword">import</span> <span class="token punctuation">{</span> initGlobalAPI <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./global-api/index'</span><span class="token comment" spellcheck="true">// 获得一些环境判断，和是否是服务端渲染</span><span class="token keyword">import</span> <span class="token punctuation">{</span> isServerRendering <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/util/env'</span><span class="token comment" spellcheck="true">// ssr 环境加载此方法</span><span class="token keyword">import</span> <span class="token punctuation">{</span> FunctionalRenderContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/vdom/create-functional-component'</span><span class="token comment" spellcheck="true">//初始化全局API变量</span><span class="token function">initGlobalAPI</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//为vue的原型定义$isServer属性</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$isServer'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  <span class="token keyword">get</span><span class="token punctuation">:</span> isServerRendering<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//为vue的原型定义$ssrContext</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$ssrContext'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* istanbul ignore next */</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>ssrContext  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//为vue原型定义当为ssr环境时加载FunctionalRenderContext方法</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">,</span> <span class="token string">'FunctionalRenderContext'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> FunctionalRenderContext<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//添加版本号</span>Vue<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">'__VERSION__'</span><span class="token keyword">export</span> <span class="token keyword">default</span> Vue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总结一下这个文件加载的方法</p><pre class="line-numbers language-md"><code class="language-md">core/index├── Vue            # 初始化构造函数├── initGlobalAPI  # 初始化全局API├── $isServer      # 判断环境的工具函数├── $ssrContext    # ssr 环境加载此方法也可用于操作状态├── FunctionalRenderContext  # ssr 环境加载此方法├── 添加版本号<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="new-Vue-1"><a href="#new-Vue-1" class="headerlink" title="new Vue "></a>new Vue <hr></h3><p>初始化文件后，进入导出 Vue 构造函数的文件 <code>src/core/instance/index.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Vue <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>    <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Vue</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Vue is a constructor and should be called with the `new` keyword'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面我们看到了 Vue 实际上就是一个用 Function 实现的类，通过 new 关键字初始化，然后会调用 this._init 方法。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span> Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_init <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token comment" spellcheck="true">// a uid</span>    vm<span class="token punctuation">.</span>_uid <span class="token operator">=</span> uid<span class="token operator">++</span>    <span class="token keyword">let</span> startTag<span class="token punctuation">,</span> endTag    <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>      startTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-start:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>      endTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-end:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>      <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 如果是Vue的实例，则不需要被observe</span>    vm<span class="token punctuation">.</span>_isVue <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token comment" spellcheck="true">// 对参数进行 merge 操作  </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// optimize internal component instantiation</span>      <span class="token comment" spellcheck="true">// since dynamic options merging is pretty slow, and none of the</span>      <span class="token comment" spellcheck="true">// internal component options needs special treatment.</span>      <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>        <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>        options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        vm      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 通过判断 Proxy 为 vue的实例属性赋值</span>    <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">initProxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>_renderProxy <span class="token operator">=</span> vm    <span class="token punctuation">}</span>    vm<span class="token punctuation">.</span>_self <span class="token operator">=</span> vm    <span class="token comment" spellcheck="true">// 初始化生命周期相关</span>    <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 输初始化事件监听相关</span>    <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 初始化编译render</span>    <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 调用beforeCreate钩子函数并且触发beforeCreate钩子事件</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>    <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 初始化props、methods、data、computed与watch</span>    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 调用created钩子函数并且触发created钩子事件</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 格式化组件名</span>      vm<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token function">formatComponentName</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>      <span class="token function">mark</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>      <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> init`</span></span><span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 挂载组件方法触发组件的DOM渲染</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码的注释了解到 Vue 初始化主要就干了几件事情，合并配置操作，初始化生命周期，初始化事件监听，初始化render，初始化 data、props、computed、watcher 等，在最后调用vm.$mount 方法挂载 vm ，把模版渲染成DOM。当然这里面还有很多细节需要知道例如上面初始化合并配置，生命周期初始化等，会在后面清楚的梳理 vue 整理流程之后，进入细节</p><h2 id="vm-mount"><a href="#vm-mount" class="headerlink" title="vm.$mount"></a>vm.$mount</h2><p>通过 $mount 实例方法去挂载 vm ，但 $mount 方法是由于多平台编译处理不太一样，所以在多个文件中定义。我们进入 <code>src/platform</code> 这个目录可以观察到有 web 和 weex 目录，我们直接抛掉 weex，只分析 web 目录，在 vue 官网教程中介绍了vue的完整版<code>web/entry-runtime-with-compiler.js</code>和runtime版本<code>web/runtime/index.js</code></p><p>完整版</p><ul><li>包含编译和运行是的版本</li><li>html字符串 → render函数 → vnode → 真实dom节点</li></ul><p>runtime版本</p><ul><li>创建 Vue 实例、render、更新 DOM 等的操作的代码，没有编译器编译模版字符串代码</li><li>render函数 → vnode → 真实dom节点</li></ul><h3 id="完整版-mount"><a href="#完整版-mount" class="headerlink" title="完整版 $mount"></a>完整版 $mount<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">const</span> mount <span class="token operator">=</span> Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mountVue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>  el<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">===</span> document<span class="token punctuation">.</span>body <span class="token operator">||</span> el <span class="token operator">===</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>      <span class="token template-string"><span class="token string">`Do not mount Vue to &lt;html> or &lt;body> - mount to normal elements instead.`</span></span>    <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token keyword">this</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options  <span class="token comment" spellcheck="true">// resolve template/el and convert to render function</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> template <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          template <span class="token operator">=</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">/* istanbul ignore if */</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">warn</span><span class="token punctuation">(</span>              <span class="token template-string"><span class="token string">`Template element not found or is empty: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>              <span class="token keyword">this</span>            <span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>        template <span class="token operator">=</span> template<span class="token punctuation">.</span>innerHTML      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'invalid template option:'</span> <span class="token operator">+</span> template<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">this</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>      template <span class="token operator">=</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ...</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>        outputSourceRange<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">,</span>        shouldDecodeNewlines<span class="token punctuation">,</span>        shouldDecodeNewlinesForHref<span class="token punctuation">,</span>        delimiters<span class="token punctuation">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>        comments<span class="token punctuation">:</span> options<span class="token punctuation">.</span>comments      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>      options<span class="token punctuation">.</span>render <span class="token operator">=</span> render      options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns      <span class="token comment" spellcheck="true">// ..</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> mount<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码逻辑很清晰，将执行以下过程</p><ul><li>首先在原型上定义了 $mount 这个方法</li><li>对传入的 el 做限制不能将节点挂载在 body 和 html 这种跟节点上</li><li>如果没有定义 render 方法，则会把 el 或者 template 字符串转换成 render 方法</li><li>模版或字符串转换 render 方法（调用 compileToFunctions 进行编译转换）</li></ul><h3 id="runtime-版本-mount"><a href="#runtime-版本-mount" class="headerlink" title="runtime 版本 $mount"></a>runtime 版本 $mount<hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// public mount method</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>  el<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">:</span> undefined  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行过程</p><ul><li>挂载的元素，可以是字符串，也可以是DOM对象，如果是字符串通过 query 方法转换成DOM</li><li>执行 mountComponent 函数传入三个参数</li></ul><p>通过上面代码可以看出并没有经过 compileToFunctions方法 进行转换编译阶段，而直接是 render –&gt; VNode 过程。</p><p>接下来我们接着查看 mountComponent方法调用，打开文件<code>src/core/instance/lifecycle.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> mountComponent <span class="token punctuation">(</span>  vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  el<span class="token punctuation">:</span> <span class="token operator">?</span>Element<span class="token punctuation">,</span>  hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Component <span class="token punctuation">{</span>  vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render <span class="token operator">=</span> createEmptyVNode    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeMount'</span><span class="token punctuation">)</span>  <span class="token keyword">let</span> updateComponent  <span class="token comment" spellcheck="true">// ...</span>  updateComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// we set this to vm._watcher inside the watcher's constructor</span>  <span class="token comment" spellcheck="true">// since the watcher's initial patch may call $forceUpdate (e.g. inside child</span>  <span class="token comment" spellcheck="true">// component's mounted hook), which relies on vm._watcher being already defined</span>  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>    before <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* isRenderWatcher */</span><span class="token punctuation">)</span>  hydrating <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token comment" spellcheck="true">// manually mounted instance, call mounted on self</span>  <span class="token comment" spellcheck="true">// mounted is called for render-created child components in its inserted hook</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> vm<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码很直观的看见 mountComponent 方法主要作用</p><ul><li>判断 render 函数是不是存在如果不存在调用创建 createEmptyVNode 方法创建一个空VNode节点</li><li>检测完 render 开始挂载 beforeMount 钩子</li><li>执行 new Watcher方法()</li><li>_isMounted状态设置true， 开始挂载mounted</li></ul><p>Watcher 在它的回调函数中会调用 updateComponent 方法，在此方法中调用 vm._render 方法生成虚拟 Node节点，最后调用 vm._update 更新 DOM</p><p>Watcher 初始化的时候会执行回调函数，当 vm 实例中的监测的数据发生变化的时候也会执行回调函数，这就是我们说的观察者进行依赖收集的过程,当然这也是 vue 核心原理的一部分。new Watcher到底做了什么我们在后面的单独整理，先以主线程为主</p><h2 id="vm-render"><a href="#vm-render" class="headerlink" title="vm._render"></a>vm._render</h2><p>上文中提到 Watcher 在它的回调函数中会调用 updateComponent 方法，在此方法中调用 vm._render 方法生成虚拟 Node节点，最后调用 vm._update 更新 DOM，那么就出现 私有方法 vm._render 和 vm._update 两个最核心的方法。</p><p>_render 定义在 <code>src/core/instance/render.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// ...</span>  Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_render <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> VNode <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> _parentVnode <span class="token punctuation">}</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options    <span class="token keyword">if</span> <span class="token punctuation">(</span>_parentVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$scopedSlots <span class="token operator">=</span> <span class="token function">normalizeScopedSlots</span><span class="token punctuation">(</span>        _parentVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>scopedSlots<span class="token punctuation">,</span>        vm<span class="token punctuation">.</span>$slots<span class="token punctuation">,</span>        vm<span class="token punctuation">.</span>$scopedSlots      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// set parent vnode. this allows render functions to have access</span>    <span class="token comment" spellcheck="true">// to the data on the placeholder node.</span>    vm<span class="token punctuation">.</span>$vnode <span class="token operator">=</span> _parentVnode    <span class="token comment" spellcheck="true">// render self</span>    <span class="token keyword">let</span> vnode    <span class="token keyword">try</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// There's no need to maintain a stack because all render fns are called</span>      <span class="token comment" spellcheck="true">// separately from one another. Nested component's render fns are called</span>      <span class="token comment" spellcheck="true">// when parent component is patched.</span>      currentRenderingInstance <span class="token operator">=</span> vm      vnode <span class="token operator">=</span> render<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`render`</span></span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// return error render result,</span>      <span class="token comment" spellcheck="true">// or previous vnode to prevent render error causing blank component</span>      <span class="token comment" spellcheck="true">/* istanbul ignore else */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>renderError<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>          vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>renderError<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">,</span> e<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`renderError`</span></span><span class="token punctuation">)</span>          vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>      currentRenderingInstance <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// if the returned array contains only a single node, allow it</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      vnode <span class="token operator">=</span> vnode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// return empty vnode in case the render function errored out</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>vnode <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token string">'Multiple root nodes returned from render function. Render function '</span> <span class="token operator">+</span>          <span class="token string">'should return a single root node.'</span><span class="token punctuation">,</span>          vm        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>      vnode <span class="token operator">=</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// set parent</span>    vnode<span class="token punctuation">.</span>parent <span class="token operator">=</span> _parentVnode    <span class="token keyword">return</span> vnode  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面这段代码最关键的地方就是调用 render 方法 <code>render.call(vm._renderProxy, vm.$createElement)</code>，在上面说过在 mounted 方法中会把 template 和 string 经过 compileToFunctions 编译最后形成 render方法进行渲染，但是这是用字符串模版的形式，如果用字符串模板的代替方案 render 方法呢</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  render<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>createElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>     attrs<span class="token punctuation">:</span> <span class="token punctuation">{</span>        id<span class="token punctuation">:</span> <span class="token string">'app'</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  renderError<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>createElement<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'pre'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token punctuation">:</span> <span class="token punctuation">{</span> color<span class="token punctuation">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们可以看出render 方法的参数 createElement 实际上就是 vm.$createElement,然而 vm.$createElement 在初始化中就已经执行过了</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> initRender <span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  vm<span class="token punctuation">.</span>_c <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">createElement</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// normalization is always applied for the public version, used in</span>  <span class="token comment" spellcheck="true">// user-written render functions.</span>  vm<span class="token punctuation">.</span>$createElement <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">createElement</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// $attrs &amp; $listeners are exposed for easier HOC creation.</span>  <span class="token comment" spellcheck="true">// they need to be reactive so that HOCs using them are always updated</span>  <span class="token keyword">const</span> parentData <span class="token operator">=</span> parentVnode <span class="token operator">&amp;&amp;</span> parentVnode<span class="token punctuation">.</span>data  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以在 initRender 方法的时候，除了 vm.$createElement 方法，还有一个 vm._c 方法，它是被模板编译成的 render 函数使用，但 vm.$createElement 是我们用原生写的 render 方法使用的， 这俩个方法支持的参数相同，并且内部都调用了 createElement 方法。</p><p>官网中一句话说的很清楚 <strong>Vue 选项中的 render 函数若存在，则 Vue 构造函数不会从 template 选项或通过 el 选项指定的挂载元素中提取出的 HTML 模板编译渲染函数。</strong></p><p>通过上述总结到 render 函数最终是执行 createElement 方法 返回 vnode 节点，这是一个虚拟 node 而 vue2.0 的 另一个核心就是利用了Virtual DOM，实际上 Vue.js 中 Virtual DOM 是借鉴了开源库 <a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener">snabbdom</a> 的实现，然后加入了一些 Vue.js 特色的东西, 这部分源码就在 <code>src/core/vdom/vnode.js</code> 中我们暂时不去查看，待后续文章写到 Virtual DOM 的时候我们在做分析。 </p><p>那么在面试中我们经常被问到是 操作 Virtual DOM 快还是真实 DOM 快</p><p>答案是相对的在数据量大的情况下，肯定是 Virtual DOM 快，因为通过对比 node 减少频繁的去更新DOM， 如果数据量相对较小的情况还是直接操作 DOM 较快，因为少了编译、遍历、对比的过程</p><h2 id="vm-createElement"><a href="#vm-createElement" class="headerlink" title="vm.$createElement"></a>vm.$createElement</h2><p>上面文章提到 render 的时候内部调用了 createElement 方法，创建了vnode，该方法定义在 src/core/vdom/create-elemenet.js 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">function</span> _createElement <span class="token punctuation">(</span>  context<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>  tag<span class="token operator">?</span><span class="token punctuation">:</span> string <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">></span> <span class="token operator">|</span> Function <span class="token operator">|</span> Object<span class="token punctuation">,</span>  data<span class="token operator">?</span><span class="token punctuation">:</span> VNodeData<span class="token punctuation">,</span>  children<span class="token operator">?</span><span class="token punctuation">:</span> any<span class="token punctuation">,</span>  normalizationType<span class="token operator">?</span><span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> VNode <span class="token operator">|</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">/**   * 如果存在data.__ob__，说明data是被Observer观察的数据   * 不能用作虚拟节点的data   * 需要抛出警告，并返回一个空节点   *   * 被监控的data不能被用作vnode渲染的数据的原因是：   * data在vnode渲染过程中可能会被改变，这样会触发监控，导致不符合预期的操作   */</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>      <span class="token template-string"><span class="token string">`Avoid using observed data object as vnode data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n`</span></span> <span class="token operator">+</span>      <span class="token string">'Always create fresh vnode data objects in each render!'</span><span class="token punctuation">,</span>      context    <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 当通过 :is 动态设置组件时</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    tag <span class="token operator">=</span> data<span class="token punctuation">.</span>is  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// in case of component :is set to falsy value</span>    <span class="token keyword">return</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// 作用域插槽</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token keyword">typeof</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    data <span class="token operator">=</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    data<span class="token punctuation">.</span>scopedSlots <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>    children<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizationType <span class="token operator">===</span> ALWAYS_NORMALIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>    children <span class="token operator">=</span> <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizationType <span class="token operator">===</span> SIMPLE_NORMALIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>    children <span class="token operator">=</span> <span class="token function">simpleNormalizeChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">let</span> vnode<span class="token punctuation">,</span> ns  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> Ctor    ns <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>ns<span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">getTagNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// platform built-in elements</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>nativeOn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">warn</span><span class="token punctuation">(</span>          <span class="token template-string"><span class="token string">`The .native modifier for v-on is only valid on components but it was used on &lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">>.`</span></span><span class="token punctuation">,</span>          context        <span class="token punctuation">)</span>      <span class="token punctuation">}</span>      vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>        config<span class="token punctuation">.</span><span class="token function">parsePlatformTagName</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span>        undefined<span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> context      <span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>Ctor <span class="token operator">=</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token string">'components'</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// component</span>      vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// unknown or unlisted namespaced elements</span>      <span class="token comment" spellcheck="true">// check at runtime because it may get assigned a namespace when its</span>      <span class="token comment" spellcheck="true">// parent normalizes children</span>      vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>        tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span>        undefined<span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> context      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// direct component options / constructor</span>    vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> vnode  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">applyNS</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> ns<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">registerDeepBindings</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token keyword">return</span> vnode  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码我们看到 主要调用了几个方法 createEmptyVNode 和 createComponent、normalizeChildren、simpleNormalizeChildren</p><p>我们简单的看一下执行步骤</p><p>首先判断了 tag 是否存在，如果不存在则调用 <code>src/core/vdom/vnode.js</code>目录下的 createEmptyVNode 方法创建空的 vnode 节点</p><p>如果传递了children，由于其是任意类型，所以根据 normalizationType 去调用<code>src/core/vdom/helpers/normalzie-children.js</code> 目录下的 normalizeChildren(children) 和 simpleNormalizeChildren(children) 方法进行递归遍历，把整个 children 打平，让它变成深度只有一层的 vnode 数组</p><p>最后通过 对参数 tag 的判断，如果是一个普通的 html 标签，则实例化一个普通 vnode 节点，否则通过 <code>src/core/vdom/create-component.js</code>目录下的 createComponent 方法创建一个组件的 vnode</p><p>因为除了组件的 vnode 没有 children，其他通过 createElement 创建的每个 vnode 都有 children，children 每个元素也是一个 vnode，这样就形成了一个 vnode tree，这样我们就知道 vm._render 阶段是如何创建的 vnode，那么接下来我们就通过 vm._update，将 vnode 渲染成真实的 dom。</p><h2 id="vm-update"><a href="#vm-update" class="headerlink" title="vm._update"></a>vm._update</h2><p>vm._update 也是一个私有方法，作用是把 vnode 渲染成真实的 dom 在 <code>src/core/instance/lifecycle.js</code> 文件中定义</p><h3 id="update"><a href="#update" class="headerlink" title="_update "></a>_update <hr></h3><pre class="line-numbers language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// ...</span>  Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_update <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">:</span> VNode<span class="token punctuation">,</span> hydrating<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">const</span> prevEl <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el    <span class="token keyword">const</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode    <span class="token keyword">const</span> restoreActiveInstance <span class="token operator">=</span> <span class="token function">setActiveInstance</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>    vm<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode    <span class="token comment" spellcheck="true">// Vue.prototype.__patch__ is injected in entry points</span>    <span class="token comment" spellcheck="true">// based on the rendering backend used.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// initial render</span>      vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* removeOnly */</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// updates</span>      vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">restoreActiveInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// update __vue__ reference</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevEl<span class="token punctuation">)</span> <span class="token punctuation">{</span>      prevEl<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> vm    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// if parent is an HOC, update its $el as well</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$vnode <span class="token operator">===</span> vm<span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      vm<span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// updated hook is called by the scheduler to ensure that children are</span>    <span class="token comment" spellcheck="true">// updated in a parent's updated hook.</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码我们知道 vm.<em>update 的核心就是通过 vm.<strong>patch</strong>函数来实现将 vnode 转换成真实的 node 节点，而 vm.<em>_patch</em></em> 的实现是多平台的有weex、ssr、inBrowser，我们只查看在浏览器环境内的实现</p><p>在 <code>src/platforms/web/runtime/index.js</code> 通过判断如果是浏览器环境调用 patch，否则创建一个空对象</p><h3 id="patch"><a href="#patch" class="headerlink" title="patch "></a><strong>patch</strong> <hr></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// install platform patch function</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__patch__ <span class="token operator">=</span> inBrowser <span class="token operator">?</span> patch <span class="token punctuation">:</span> noop<span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过引用我们到 <code>src/platforms/web/runtime/patch.js</code> 目录看到调用了 createPatchFunction 方法的返回值</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> patch<span class="token punctuation">:</span> Function <span class="token operator">=</span> <span class="token function">createPatchFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nodeOps<span class="token punctuation">,</span> modules <span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="createPatchFunction"><a href="#createPatchFunction" class="headerlink" title="createPatchFunction "></a>createPatchFunction <hr></h3><p>在通过查找文件 <code>src/core/vdom/patch.js</code> 中定义的 createPatchFunction 方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">function</span> createPatchFunction <span class="token punctuation">(</span>backend<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> patch <span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果 vnode 不存在但 oldVnode 存在，调用 invokeDestroyHook(oldVnode) 来进行销毁旧节点</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">let</span> isInitialPatch <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">const</span> insertedVnodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment" spellcheck="true">// 如果oldVnode不存在，vnode存在，则创建新节点  </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// empty mount (likely as component), create new root element</span>      isInitialPatch <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> isRealElement <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// 如果 oldVnode 与 vnode 都存在判断是同一节点调用 patchVnode 处理去比较两个节点的差异</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRealElement <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// patch existing root node</span>        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRealElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// 如果存在真实的节点，存在data-server-rendered属性，将 hydrating 变为true</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> oldVnode<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span>SSR_ATTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            oldVnode<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>SSR_ATTR<span class="token punctuation">)</span>            hydrating <span class="token operator">=</span> <span class="token boolean">true</span>          <span class="token punctuation">}</span>          <span class="token comment" spellcheck="true">// 用hydrate函数将虚拟DOM和真实DOM进行映射</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>hydrating<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hydrate</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>              <span class="token keyword">return</span> oldVnode            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// ...</span>          <span class="token punctuation">}</span>          <span class="token comment" spellcheck="true">// 如果不是server-rendered 或者hydration失败</span>          <span class="token comment" spellcheck="true">// 创建一个空VNode，代替oldVnode</span>          oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 将oldVnode设置为对应的虚拟dom，找到oldVnode.elm的父节点</span>        <span class="token comment" spellcheck="true">// 根据vnode创建一个真实dom节点并插入到该父节点中oldVnode.elm的位置</span>        <span class="token keyword">const</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm        <span class="token keyword">const</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>        <span class="token function">createElm</span><span class="token punctuation">(</span>          vnode<span class="token punctuation">,</span>          insertedVnodeQueue<span class="token punctuation">,</span>          oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> parentElm<span class="token punctuation">,</span>          nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>        <span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 递归更新父级占位节点元素，</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">let</span> ancestor <span class="token operator">=</span> vnode<span class="token punctuation">.</span>parent          <span class="token keyword">const</span> patchable <span class="token operator">=</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>          <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>              cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            ancestor<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm            <span class="token keyword">if</span> <span class="token punctuation">(</span>patchable<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> ancestor<span class="token punctuation">)</span>              <span class="token punctuation">}</span>              <span class="token comment" spellcheck="true">// #6513</span>              <span class="token comment" spellcheck="true">// invoke insert hooks that may have been merged by create hooks.</span>              <span class="token comment" spellcheck="true">// e.g. for directives that uses the "inserted" hook.</span>              <span class="token keyword">const</span> insert <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span>insert              <span class="token keyword">if</span> <span class="token punctuation">(</span>insert<span class="token punctuation">.</span>merged<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// start at index 1 to avoid re-invoking component mounted hook</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insert<span class="token punctuation">.</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  insert<span class="token punctuation">.</span>fns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>              <span class="token function">registerRef</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            ancestor <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>parent          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 销毁旧节点</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> isInitialPatch<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 返回节点</span>    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面看到 patch 方法本身</p><p>接收 4个参数</p><ul><li>oldVnode 表示旧的 VNode 节点或者或者是一个 DOM 对象</li><li>vnode 表示执行 _render 后返回的 VNode 的节点</li><li>hydrating 表示是否是服务端渲染</li><li>removeOnly 是给 transition-group 用的，防止在 updateChildren 阶段，移动 vnode 节点</li></ul><p>关键调用三个方法</p><ul><li>createElm 以当前旧节点为参考节点，创建新的节点，执行相关的 insert 钩子函数，并插入到 DOM 中，</li><li>sameVnode 通过对比 key 是否相同、tag、注释、data是否存在等判断2个节点，是否是同一个节点</li><li>patchVnode vdom 核心更新 node </li></ul><p>patchVode 中的几个核心方法 addVnodes、 removeVnodes，updateChildren，具体是怎么增加、删除，更新 vnode 和 dom 节点的，dom-diff 比较复杂，我们会在分析响应式原理的时候具体查看细节</p><h3 id="主流程总结"><a href="#主流程总结" class="headerlink" title="主流程总结"></a>主流程总结<hr></h3><p>下面我们通过一张图来总结 vue 主线流程</p><img src="/images/vue-process.png"><p>上面的图中能够直观的看到 vue 主干的执行流程，但是缺少核心部分，也就是 vue 的响应式原理，下篇文章我们也是通过文件的执行过程来分析 vue 响应式原理的实现</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>generator 与 async</title>
      <link href="/2019/08/26/javascript/generator-async/"/>
      <url>/2019/08/26/javascript/generator-async/</url>
      
        <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>在前端中异步编程一直是前端开发的一个痛点，因为 JavaScript 语法的灵活性和特殊性导致前端开发的困难（因为 JavaScript 是单线程，如果没有异步的世界可以想象一下，将无法执行卡死操作）</p><h3 id="什么是异步编程"><a href="#什么是异步编程" class="headerlink" title="什么是异步编程"></a>什么是异步编程</h3><p>所谓”异步”，一个任务不是连续完成的，先执行第一段，然后执行其他任务，等做好了准备，回过头执行第二段</p><p>所谓”同步”，就是不间断的连续执行一个任务</p><h3 id="异步编程示例"><a href="#异步编程示例" class="headerlink" title="异步编程示例"></a>异步编程示例</h3><p>我们熟悉的异步编程有很多种例如 <code>代码的执行任务队列</code>,<code>setTimeout</code>, <code>setInterval</code>, <code>callback</code>, <code>promise</code> 等</p><p>回调函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Fun</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>  callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>再例如数组的操作方法<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> i<span class="token operator">+</span><span class="token string">':'</span><span class="token operator">+</span>v<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Promise</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> readFile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-readfile-promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">readFile</span><span class="token punctuation">(</span>fileB<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Generator概念"><a href="#Generator概念" class="headerlink" title="Generator概念"></a>Generator概念</h3><p>ES6 提供的一种异步编程解决方案，执行 Generator 函数会返回一个遍历器对象，也就是说，Generator 函数除了状态机，还是一个遍历器对象生成函数。返回的遍历器对象，可以依次遍历 Generator 函数内部的每一个状态。</p><h3 id="Generator特征"><a href="#Generator特征" class="headerlink" title="Generator特征"></a>Generator特征</h3><ul><li>function关键字与函数名之间有一个星号</li><li>函数体内部使用yield表达式，定义不同的内部状态</li><li>执行函数不会立即执行，只有调用了next方法才会执行</li><li>如果函数内部不写 yield 表达式，则此函数就是单纯的暂缓执行函数</li><li>每次调用遍历器对象的next方法，返回value和done两个属性的对象</li><li>value属性表示当前的内部状态的值，是yield表达式后面那个表达式的值</li><li>done属性是一个布尔值，表示是否遍历结束</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">funGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">yield</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>  <span class="token keyword">yield</span> <span class="token string">'my name is renbo'</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token string">'ending'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> fun <span class="token operator">=</span> <span class="token function">funGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fun<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// { value: 'hello', done: false }</span>fun<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// { value: 'my name is renbo', done: false }</span>fun<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// { value: 'ending', done: true }</span>fun<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// { value: undefined, done: true }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="控制流管理"><a href="#控制流管理" class="headerlink" title="控制流管理"></a>控制流管理</h3><p>回调</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">step1</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value1<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">step2</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">step3</span><span class="token punctuation">(</span>value2<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value3<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">step4</span><span class="token punctuation">(</span>value3<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value4<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Do something with value4</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>promise</p><pre class="line-numbers language-js"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>step1<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step2<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step3<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step4<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value4<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Do something with value4</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Handle any error from step1 through step4</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Generator</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">longRunningTask</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> value2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step1</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> value3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step2</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> value4 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step3</span><span class="token punctuation">(</span>value3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> value5 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step4</span><span class="token punctuation">(</span>value4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Do something with value4</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Handle any error from step1 through step4</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="单个异步任务"><a href="#单个异步任务" class="headerlink" title="单个异步任务"></a>单个异步任务</h3><p>Generator + Promise</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 调用</span><span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>result<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上述的执行过程调用 gen 会返回遍历器，然后通过遍历器的 next 方法返回 fetch 的 promise 实例<code>{ value: Promise { &lt;pending&gt; }, done: false }</code>，通过调用 then 方法执行结果</p><h3 id="多个异步任务"><a href="#多个异步任务" class="headerlink" title="多个异步任务"></a>多个异步任务</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/repos'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r1<span class="token punctuation">.</span>bio<span class="token punctuation">,</span> r2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>login<span class="token punctuation">,</span> r3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>full_name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获得执行结果</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> result1 <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>result1<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>利用递归封装上述执行结果</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    result<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动器函数-（Generator-Promise）"><a href="#启动器函数-（Generator-Promise）" class="headerlink" title="启动器函数 （Generator + Promise）"></a>启动器函数 （Generator + Promise）</h3><p>由于 fetch 方法返回 promise 有 json 方法，所以上述例子成立，如果 yield 直接结合 promise 函数那么就会变成启动器函数。由于 Generator 不能像普通函数一样自动执行和自己暂缓执行的特性，所以增加自执行启动函数，这也是 co 模块的初衷（）</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> json1 <span class="token operator">=</span> <span class="token keyword">yield</span> r1<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> json2 <span class="token operator">=</span> <span class="token keyword">yield</span> r2<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/repos'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> json3 <span class="token operator">=</span> <span class="token keyword">yield</span> r3<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>json1<span class="token punctuation">.</span>bio<span class="token punctuation">,</span> json2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>login<span class="token punctuation">,</span> json3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>full_name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动器函数-（Generator-回调）"><a href="#启动器函数-（Generator-回调）" class="headerlink" title="启动器函数 （Generator + 回调）"></a>启动器函数 （Generator + 回调）</h3><p>回调函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">{</span>status<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> url<span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Generator函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r1<span class="token punctuation">.</span>data<span class="token punctuation">,</span> r2<span class="token punctuation">.</span>data<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获得结果</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> r1 <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>r1<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> r2 <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  r2<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>      g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的示例代码我们观察到回调函数依然解决不了多个 yield 时代码会循环嵌套。还的借助递归</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><p>通过上面代码可以看出 Generator 函数的自动执行需要一种机制，当异步操作有了结果，才能自动交回执行权</p><ul><li>回调函数。 将异步操作进行包装，暴露出回调函数，在回调函数里面交回执行权</li><li>Promise对象。将异步操作包装成 Promise 对象，用 then 方法交回执行权</li></ul><p>上面两种方法写了一个 run 的启动器函数，那么我们将两种封装在一起，返回了一个 Promise，获得 Generator 函数的返回值，并且捕获错误</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> gen <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> gen <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 如果 gen 不是一个迭代器</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gen <span class="token operator">||</span> <span class="token keyword">typeof</span> gen<span class="token punctuation">.</span>next <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span>        <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">function</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> ret<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                ret <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">next</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">function</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> ret<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                ret <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token keyword">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">next</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token function">toPromise</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token function">isPromise</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You may only yield a function, promise '</span> <span class="token operator">+</span>                <span class="token string">'but the following object was passed: "'</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">isPromise</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">'function'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">.</span>then<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">toPromise</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'function'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">thunkToPromise</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> obj<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">thunkToPromise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> run<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="co"><a href="#co" class="headerlink" title="co"></a>co</h3><p>co 是大神 TJ Holowaychuk 于 2013 年 6 月发布的一个小模块，用于 Generator 函数的自动执行。</p><p>如果直接使用 co 模块，这两种不同的例子可以简写为</p><p>yield 后是一个 Promise</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json1 <span class="token operator">=</span> <span class="token keyword">yield</span> r1<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json2 <span class="token operator">=</span> <span class="token keyword">yield</span> r2<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/repos'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json3 <span class="token operator">=</span> <span class="token keyword">yield</span> r3<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>json1<span class="token punctuation">.</span>bio<span class="token punctuation">,</span> json2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>login<span class="token punctuation">,</span> json3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>full_name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">co</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yield 后是一个回调函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> url <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github/followers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r1<span class="token punctuation">.</span>data<span class="token punctuation">,</span> r2<span class="token punctuation">.</span>data<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">co</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="async-优点"><a href="#async-优点" class="headerlink" title="async 优点"></a>async 优点</h3><p> async 函数，使得异步操作变得更加方便,它也是 Generator 函数的语法糖。</p><p>当使用 Generator 函数的时候</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json1 <span class="token operator">=</span> <span class="token keyword">yield</span> r1<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json1<span class="token punctuation">.</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">co</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当使用 async 时候</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> fetchData <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> json1 <span class="token operator">=</span> <span class="token keyword">await</span> r1<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json1<span class="token punctuation">.</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面观察到代码基本一样，所以 async 的原理就是将 Generator 函数和自动执行器，包装在一个函数里面</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 等同于</span><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>async 函数返回一个 Promise 对象所以也可以理解为 async 函数是基于 Promise 和 Generator 的一层封装<br>随意处理初步流程 async 会比使用 Promise 更优雅</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token string">"done"</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token string">"done"</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>moreData<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">fetchAnotherData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>moreData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> moreData      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> data    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>moreData<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> moreData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchAnotherData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> moreData  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> data  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value1 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">fetchMoreData</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value2 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">fetchMoreData2</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> value1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> value2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchMoreData</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">fetchMoreData2</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="async-缺点"><a href="#async-缺点" class="headerlink" title="async 缺点"></a>async 缺点</h3><ul><li>用try…catch 处理上是原本的优雅代码变得不再优雅</li><li>语法的简洁让原本可以并行执行的内容变成了顺序执行，从而影响了性能</li></ul><p>await由于返回 promise 对象，所以结果可能是rejected，所以最好把await命令放在try…catch代码块中<br>但是如果想捕获 JSON.parse 中的错误那么就需要再添加一层 try…catch</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> data <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>原本没有依赖关系的两个函数，却只能等待 getList 返回才能执行 getAnotherList，导致请求时间多了一倍</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> getList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> getAnotherList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>将上面的函数改为如下函数可以解决上述问题</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> listPromise <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> anotherListPromise <span class="token operator">=</span> <span class="token function">getAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">await</span> listPromise<span class="token punctuation">;</span>  <span class="token keyword">await</span> anotherListPromise<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以使用 Promse.all</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>并发执行 async 函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> listPromise <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">await</span> <span class="token function">submit</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> anotherListPromise <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">await</span> <span class="token function">submit</span><span class="token punctuation">(</span>anotherListData<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 方法一</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> handleListPromise <span class="token operator">=</span> <span class="token function">handleList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> handleAnotherListPromise <span class="token operator">=</span> <span class="token function">handleAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">await</span> handleListPromise  <span class="token keyword">await</span> handleAnotherListPromise<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 方法二</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">handleList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">handleAnotherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>global.d.ts</title>
      <link href="/2019/08/15/typescript/global.d.ts/"/>
      <url>/2019/08/15/typescript/global.d.ts/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// Type definitions for [~THE LIBRARY NAME~] [~OPTIONAL VERSION NUMBER~]</span><span class="token comment" spellcheck="true">// Project: [~THE PROJECT NAME~]</span><span class="token comment" spellcheck="true">// Definitions by: [~YOUR NAME~] &lt;[~A URL FOR YOU~]></span><span class="token comment" spellcheck="true">/*~ If this library is callable (e.g. can be invoked as myLib(3)), *~ include those call signatures here. *~ Otherwise, delete this section. */</span><span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">myLib</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span><span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">myLib</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ If you want the name of this library to be a valid type name, *~ you can do so here. *~ *~ For example, this allows us to write 'var x: myLib'; *~ Be sure this actually makes sense! If it doesn't, just *~ delete this declaration and add types inside the namespace below. */</span><span class="token keyword">interface</span> <span class="token class-name">myLib</span> <span class="token punctuation">{</span>    name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>    length<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>    extras<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/*~ If your library has properties exposed on a global variable, *~ place them here. *~ You should also place types (interfaces and type alias) here. */</span><span class="token keyword">declare</span> namespace myLib <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//~ We can write 'myLib.timeout = 50;'</span>    <span class="token keyword">let</span> timeout<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//~ We can access 'myLib.version', but not change it</span>    <span class="token keyword">const</span> version<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//~ There's some class we can create via 'let c = new myLib.Cat(42)'</span>    <span class="token comment" spellcheck="true">//~ Or reference e.g. 'function f(c: myLib.Cat) { ... }</span>    <span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token punctuation">{</span>        <span class="token keyword">constructor</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//~ We can read 'c.age' from a 'Cat' instance</span>        readonly age<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//~ We can invoke 'c.purr()' from a 'Cat' instance</span>        <span class="token function">purr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//~ We can declare a variable as</span>    <span class="token comment" spellcheck="true">//~   'var s: myLib.CatSettings = { weight: 5, name: "Maru" };'</span>    <span class="token keyword">interface</span> <span class="token class-name">CatSettings</span> <span class="token punctuation">{</span>        weight<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>        name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>        tailLength<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//~ We can write 'const v: myLib.VetID = 42;'</span>    <span class="token comment" spellcheck="true">//~  or 'const v: myLib.VetID = "bob";'</span>    type VetID <span class="token operator">=</span> <span class="token keyword">string</span> <span class="token operator">|</span> <span class="token keyword">number</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//~ We can invoke 'myLib.checkCat(c)' or 'myLib.checkCat(c, v);'</span>    <span class="token keyword">function</span> <span class="token function">checkCat</span><span class="token punctuation">(</span>c<span class="token punctuation">:</span> Cat<span class="token punctuation">,</span> s<span class="token operator">?</span><span class="token punctuation">:</span> VetID<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>function.d.ts</title>
      <link href="/2019/08/15/typescript/module-function.d.ts/"/>
      <url>/2019/08/15/typescript/module-function.d.ts/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// Type definitions for [~THE LIBRARY NAME~] [~OPTIONAL VERSION NUMBER~]</span><span class="token comment" spellcheck="true">// Project: [~THE PROJECT NAME~]</span><span class="token comment" spellcheck="true">// Definitions by: [~YOUR NAME~] &lt;[~A URL FOR YOU~]></span><span class="token comment" spellcheck="true">/*~ This is the module template file for function modules. *~ You should rename it to index.d.ts and place it in a folder with the same name as the module. *~ For example, if you were writing a file for "super-greeter", this *~ file should be 'super-greeter/index.d.ts' */</span><span class="token comment" spellcheck="true">/*~ Note that ES6 modules cannot directly export callable functions. *~ This file should be imported using the CommonJS-style: *~   import x = require('someLibrary'); *~ *~ Refer to the documentation to understand common *~ workarounds for this limitation of ES6 modules. */</span><span class="token comment" spellcheck="true">/*~ If this module is a UMD module that exposes a global variable 'myFuncLib' when *~ loaded outside a module loader environment, declare that global here. *~ Otherwise, delete this declaration. */</span><span class="token keyword">export</span> as namespace myFuncLib<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ This declaration specifies that the function *~ is the exported object from the file */</span><span class="token keyword">export</span> <span class="token operator">=</span> MyFunction<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ This example shows how to have multiple overloads for your function */</span><span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">MyFunction</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> MyFunction<span class="token punctuation">.</span>NamedReturnType<span class="token punctuation">;</span><span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">MyFunction</span><span class="token punctuation">(</span>length<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> MyFunction<span class="token punctuation">.</span>LengthReturnType<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ If you want to expose types from your module as well, you can *~ place them in this block. Often you will want to describe the *~ shape of the return type of the function; that type should *~ be declared in here, as this example shows. */</span><span class="token keyword">declare</span> namespace MyFunction <span class="token punctuation">{</span>    <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">LengthReturnType</span> <span class="token punctuation">{</span>        width<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>        height<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">NamedReturnType</span> <span class="token punctuation">{</span>        firstName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>        lastName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*~ If the module also has properties, declare them here. For example,     *~ this declaration says that this code is legal:     *~   import f = require('myFuncLibrary');     *~   console.log(f.defaultName);     */</span>    <span class="token keyword">export</span> <span class="token keyword">const</span> defaultName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>    <span class="token keyword">export</span> <span class="token keyword">let</span> defaultLength<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>module.d.ts</title>
      <link href="/2019/08/15/typescript/module.d.ts/"/>
      <url>/2019/08/15/typescript/module.d.ts/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// Type definitions for [~THE LIBRARY NAME~] [~OPTIONAL VERSION NUMBER~]</span><span class="token comment" spellcheck="true">// Project: [~THE PROJECT NAME~]</span><span class="token comment" spellcheck="true">// Definitions by: [~YOUR NAME~] &lt;[~A URL FOR YOU~]></span><span class="token comment" spellcheck="true">/*~ This is the module template file. You should rename it to index.d.ts *~ and place it in a folder with the same name as the module. *~ For example, if you were writing a file for "super-greeter", this *~ file should be 'super-greeter/index.d.ts' */</span><span class="token comment" spellcheck="true">/*~ If this module is a UMD module that exposes a global variable 'myLib' when *~ loaded outside a module loader environment, declare that global here. *~ Otherwise, delete this declaration. */</span><span class="token keyword">export</span> as namespace myLib<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ If this module has methods, declare them as functions like so. */</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">myMethod</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">myOtherMethod</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ You can declare types that are available via importing the module */</span><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">someType</span> <span class="token punctuation">{</span>    name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>    length<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>    extras<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/*~ You can declare properties of the module using const, let, or var */</span><span class="token keyword">export</span> <span class="token keyword">const</span> myField<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ If there are types, properties, or methods inside dotted names *~ of the module, declare them inside a 'namespace'. */</span><span class="token keyword">export</span> namespace subProp <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/*~ For example, given this definition, someone could write:     *~   import { subProp } from 'yourModule';     *~   subProp.foo();     *~ or     *~   import * as yourMod from 'yourModule';     *~   yourMod.subProp.foo();     */</span>    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>class.d.ts</title>
      <link href="/2019/08/15/typescript/module-class.d.ts/"/>
      <url>/2019/08/15/typescript/module-class.d.ts/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// Type definitions for [~THE LIBRARY NAME~] [~OPTIONAL VERSION NUMBER~]</span><span class="token comment" spellcheck="true">// Project: [~THE PROJECT NAME~]</span><span class="token comment" spellcheck="true">// Definitions by: [~YOUR NAME~] &lt;[~A URL FOR YOU~]></span><span class="token comment" spellcheck="true">/*~ This is the module template file for class modules. *~ You should rename it to index.d.ts and place it in a folder with the same name as the module. *~ For example, if you were writing a file for "super-greeter", this *~ file should be 'super-greeter/index.d.ts' */</span><span class="token comment" spellcheck="true">/*~ Note that ES6 modules cannot directly export class objects. *~ This file should be imported using the CommonJS-style: *~   import x = require('someLibrary'); *~ *~ Refer to the documentation to understand common *~ workarounds for this limitation of ES6 modules. */</span><span class="token comment" spellcheck="true">/*~ If this module is a UMD module that exposes a global variable 'myClassLib' when *~ loaded outside a module loader environment, declare that global here. *~ Otherwise, delete this declaration. */</span><span class="token keyword">export</span> as namespace myClassLib<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ This declaration specifies that the class constructor function *~ is the exported object from the file */</span><span class="token keyword">export</span> <span class="token operator">=</span> MyClass<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ Write your module's methods and properties in this class */</span><span class="token keyword">declare</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>    <span class="token keyword">constructor</span><span class="token punctuation">(</span>someParam<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    someProperty<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">myMethod</span><span class="token punctuation">(</span>opts<span class="token punctuation">:</span> MyClass<span class="token punctuation">.</span>MyClassMethodOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/*~ If you want to expose types from your module as well, you can *~ place them in this block. */</span><span class="token keyword">declare</span> namespace MyClass <span class="token punctuation">{</span>    <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">MyClassMethodOptions</span> <span class="token punctuation">{</span>        width<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>        height<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TypeScript编译原理</title>
      <link href="/2019/08/05/typescript/compilationprinciple/"/>
      <url>/2019/08/05/typescript/compilationprinciple/</url>
      
        <content type="html"><![CDATA[<p>TypeScript 编译器源文件位于 <a href="https://github.com/Microsoft/TypeScript/tree/master/src/compiler" target="_blank" rel="noopener">src/compiler </a> 目录下</p><p>主要的应用文件</p><image src="/images/TypeScript 编译原理.png"><h3 id="编译器的大概工作流"><a href="#编译器的大概工作流" class="headerlink" title="编译器的大概工作流"></a>编译器的大概工作流</h3><pre><code>SourceCode（源码） ~~ 扫描器 ~~&gt; Token 流</code></pre><pre><code>Token 流 ~~ 解析器 ~~&gt; AST（抽象语法树）</code></pre><pre><code>AST ~~ 绑定器 ~~&gt; Symbols（符号）</code></pre><pre><code>AST + 符号 ~~ 检查器 ~~&gt; 类型验证</code></pre><pre><code>AST + 检查器 ~~ 发射器 ~~&gt; JavaScript 代码</code></pre></image>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>函数式编程-Point Free</title>
      <link href="/2019/07/25/javascript/functionalpoint/"/>
      <url>/2019/07/25/javascript/functionalpoint/</url>
      
        <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>Point-free 是一种编程风格，其中函数定义不引用函数的参数。不用关心将要操作的数据是什样的。我们来看看 JavaScript 中的函数定义</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 表达式</span><span class="token keyword">function</span> foo <span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* parameters are declared here*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 声明式</span><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* parameters are declared here */</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token comment" spellcheck="true">// ...</span><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* parameters are declared here */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如何在不引用所需参数的情况下在 JavaScript 中定义函数？我们不能使用 functionkeyword，也不能使用箭头函数（=&gt;），因为它们需要声明形参（这将引用它的参数）。所以我们需要做的是调用一个返回函数的函数<br></p><h3 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 非 Point-free. 因为函数引用了参数name</span><span class="token keyword">var</span> greet <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">'hello '</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Point-free 先定义基本的函数，不用关心中间变量str是什么，抽象基本结构</span><span class="token keyword">var</span> toUpperCase <span class="token operator">=</span> str <span class="token operator">=</span><span class="token operator">></span> str<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> hello <span class="token operator">=</span> str <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>str<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span> <span class="token keyword">var</span> greet <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>hello<span class="token punctuation">,</span> toUpperCase<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">greet</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h3><p>这个例子来自于<a href="https://fr.umio.us/favoring-curry/" target="_blank" rel="noopener">Favoring Curry</a><br><br>假设我们从服务器获取这样的数据：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>  result<span class="token punctuation">:</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">,</span>  tasks<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">104</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            priority<span class="token punctuation">:</span> <span class="token string">"high"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-29"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Scott"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Do something"</span><span class="token punctuation">,</span>      created<span class="token punctuation">:</span> <span class="token string">"9/22/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">105</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            priority<span class="token punctuation">:</span> <span class="token string">"medium"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-22"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Lena"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Do something else"</span><span class="token punctuation">,</span> created<span class="token punctuation">:</span> <span class="token string">"9/22/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">107</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             priority<span class="token punctuation">:</span> <span class="token string">"high"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-22"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Mike"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Fix the foo"</span><span class="token punctuation">,</span>       created<span class="token punctuation">:</span> <span class="token string">"9/22/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">108</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            priority<span class="token punctuation">:</span> <span class="token string">"low"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-15"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Punam"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Adjust the bar"</span><span class="token punctuation">,</span>    created<span class="token punctuation">:</span> <span class="token string">"9/25/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">110</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            priority<span class="token punctuation">:</span> <span class="token string">"medium"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-15"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Scott"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Rename everything"</span><span class="token punctuation">,</span> created<span class="token punctuation">:</span> <span class="token string">"10/2/2013"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">112</span><span class="token punctuation">,</span> complete<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             priority<span class="token punctuation">:</span> <span class="token string">"high"</span><span class="token punctuation">,</span>              dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-27"</span><span class="token punctuation">,</span>      username<span class="token punctuation">:</span> <span class="token string">"Lena"</span><span class="token punctuation">,</span>              title<span class="token punctuation">:</span> <span class="token string">"Alter all quuxes"</span><span class="token punctuation">,</span>  created<span class="token punctuation">:</span> <span class="token string">"10/5/2013"</span><span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="getIncompleteTaskSummaries-函数"><a href="#getIncompleteTaskSummaries-函数" class="headerlink" title="getIncompleteTaskSummaries 函数"></a>getIncompleteTaskSummaries 函数</h3><p>我们需要一个名为 getIncompleteTaskSummaries 的函数，接收一个 username 作为参数，从服务器获取数据之后筛选出这个用户未完成的任务的 ids、priorities、titles、和 dueDate 数据，并且按照日期升序排序。<br></p><p>以 Scott 为例，最终筛选出的数据为<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">110</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"Rename everything"</span><span class="token punctuation">,</span>         dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-15"</span><span class="token punctuation">,</span> priority<span class="token punctuation">:</span> <span class="token string">"medium"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">104</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"Do something"</span><span class="token punctuation">,</span>         dueDate<span class="token punctuation">:</span> <span class="token string">"2013-11-29"</span><span class="token punctuation">,</span> priority<span class="token punctuation">:</span> <span class="token string">"high"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> data<span class="token punctuation">.</span>tasks<span class="token punctuation">;</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token keyword">return</span> task<span class="token punctuation">.</span>username <span class="token operator">==</span> membername             <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token keyword">return</span> <span class="token operator">!</span>task<span class="token punctuation">.</span>complete             <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token keyword">return</span> <span class="token punctuation">{</span>                     id<span class="token punctuation">:</span> task<span class="token punctuation">.</span>id<span class="token punctuation">,</span>                     dueDate<span class="token punctuation">:</span> task<span class="token punctuation">.</span>dueDate<span class="token punctuation">,</span>                     title<span class="token punctuation">:</span> task<span class="token punctuation">.</span>title<span class="token punctuation">,</span>                     priority<span class="token punctuation">:</span> task<span class="token punctuation">.</span>priority                 <span class="token punctuation">}</span>             <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token keyword">var</span> a <span class="token operator">=</span> first<span class="token punctuation">.</span>dueDate<span class="token punctuation">,</span>                     b <span class="token operator">=</span> second<span class="token punctuation">.</span>dueDate<span class="token punctuation">;</span>                 <span class="token keyword">return</span> a <span class="token operator">&lt;</span> b <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> a <span class="token operator">></span> b <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>             console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">getIncompleteTaskSummaries</span><span class="token punctuation">(</span><span class="token string">'Scott'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Point-free-模式"><a href="#Point-free-模式" class="headerlink" title="Point-free 模式"></a>Point-free 模式<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 拆分基础函数</span>curry 为封装的通用 curry 韩式<span class="token keyword">var</span> prop <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> obj<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> propEq <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> obj<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">===</span> val<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> filter <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> pick <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        result<span class="token punctuation">[</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> sortBy <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span>            b <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> a <span class="token operator">&lt;</span> b <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> a <span class="token operator">></span> b <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 拼装</span><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> membername<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'complete'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'dueDate'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">sortBy</span><span class="token punctuation">(</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'dueDate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">getIncompleteTaskSummaries</span><span class="token punctuation">(</span><span class="token string">'Scott'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="利用-ramda-js-实现-getIncompleteTaskSummarie"><a href="#利用-ramda-js-实现-getIncompleteTaskSummarie" class="headerlink" title="利用 ramda.js 实现 getIncompleteTaskSummarie"></a>利用 ramda.js 实现 getIncompleteTaskSummarie</h3><p>如果直接使用 ramda.js，你可以省去编写基本函数<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> membername<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'complete'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'dueDate'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">sortBy</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'dueDate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">getIncompleteTaskSummaries</span><span class="token punctuation">(</span><span class="token string">'Scott'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="利用-compose-实现-getIncompleteTaskSummaries"><a href="#利用-compose-实现-getIncompleteTaskSummaries" class="headerlink" title="利用 compose 实现 getIncompleteTaskSummaries"></a>利用 compose 实现 getIncompleteTaskSummaries</h3><p>可以从左到右</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span>            R<span class="token punctuation">.</span><span class="token function">sortBy</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'dueDate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            R<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'dueDate'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'complete'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> membername<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">getIncompleteTaskSummaries</span><span class="token punctuation">(</span><span class="token string">'Scott'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="利用-ramda-js-提供的-R-pipe-函数"><a href="#利用-ramda-js-提供的-R-pipe-函数" class="headerlink" title="利用 ramda.js 提供的 R.pipe 函数"></a>利用 ramda.js 提供的 R.pipe 函数</h3><p>可以从左到右</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> getIncompleteTaskSummaries <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>membername<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>          R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> membername<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          R<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">propEq</span><span class="token punctuation">(</span><span class="token string">'complete'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          R<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'dueDate'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          R<span class="token punctuation">.</span><span class="token function">sortBy</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'dueDate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 函数式编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 函数式编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>函数式编程-函数组合</title>
      <link href="/2019/07/22/javascript/functionalcombination/"/>
      <url>/2019/07/22/javascript/functionalcombination/</url>
      
        <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>函数组合是将两个或多个函数组合以产生新函数的过程。将功能组合在一起就像将一系列管道拼凑在一起，以便我们的数据流过<br></p><p>简而言之，函数<code>f</code>和<code>g</code>的组合可以定义为<code>f（g（x））</code>，它从内到外 - 从右到左进行求值<br></p><h3 id="demo-toSlug"><a href="#demo-toSlug" class="headerlink" title="demo toSlug"></a>demo toSlug</h3><p>举例子，想象一个场景，想要将用户的全名转换为URL slugs，以便为每个用户提供个人资料页面。为此，需要完成一系列步骤：</p><ol><li>将名称拆分为空格中的数组</li><li>将名称映射到小写</li><li>加入破折号</li><li>编码URI组件</li></ol><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// toslug.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> input <span class="token operator">=</span><span class="token operator">></span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>  input<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>str <span class="token operator">=</span><span class="token operator">></span> str<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="组合功能"><a href="#组合功能" class="headerlink" title="组合功能"></a>组合功能</h3><p>不错……但如果我告诉你它可能更具可读性呢？想象一下，这些操作中的每一个都具有相应的可组合功能。可以写成<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// nesting-composition.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> input <span class="token operator">=</span><span class="token operator">></span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">(</span>      <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">(</span>        input      <span class="token punctuation">)</span>    <span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="简单的偏应用函数"><a href="#简单的偏应用函数" class="headerlink" title="简单的偏应用函数"></a>简单的偏应用函数</h3><p>这看起来比我们的第一次尝试更难阅读，但先放在这，我们继续以可组合形式的常用实用程序，如<code>split（）</code>，<code>join（）</code>和<code>map（）</code>。来实现<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// composables.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> curry <span class="token operator">=</span> fn <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> fn<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> join <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> arr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> toLowerCase <span class="token operator">=</span> str <span class="token operator">=</span><span class="token operator">></span> str<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> split <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>splitOn<span class="token punctuation">,</span> str<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>splitOn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的例子在技术上并不是真的柯里化，它总能产生一元函数，但是它是一个简单的偏应用函数。请参考<a href="https://medium.com/javascript-scene/curry-or-partial-application-8150044c78b8" target="_blank" rel="noopener">有关偏应用函数和柯里化的区别</a> <br></p><p>回到我们的<code>toSlug（）</code>实现</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// nesting-composition.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> input <span class="token operator">=</span><span class="token operator">></span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">(</span>      <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">(</span>        input      <span class="token punctuation">)</span>    <span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="compose（）"><a href="#compose（）" class="headerlink" title="compose（）"></a>compose（）</h3><p>我们可以使用一个自动组合这些函数的函数来展平嵌套，这意味着它将从一个函数获取输出并自动将其到下一个函数的输入，直到它输出最终值<br><br>想象一下我们实现函数 <code>reduce（）</code> 的功能，但为了匹配上面的compose行为，我们需要它从右到左，而不是从左到右<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// compose.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> compose <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>fns<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">=</span><span class="token operator">></span> fns<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">f</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> compose <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>fns<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">=</span><span class="token operator">></span> fns<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">f</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面的 <code>.reduceRight()</code> 与<code>.reduce（）</code>一样，数组<code>.reduceRight（）</code>方法采用reducer函数和初始值（<code>x</code>）。我们迭代数组函数（从右到左），依次将每个函数应用于累加值（<code>v</code>）<br></p><p>使用compose，我们可以在没有嵌套的情况下重写 toSlug 的组合<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// using-compose.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>  encodeURIComponent<span class="token punctuation">,</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="pipe（）"><a href="#pipe（）" class="headerlink" title="pipe（）"></a>pipe（）</h3><p>还有另一种通常称为“pipe（）”的形式。 Lodash称之为<code>flow（）</code><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// pipe.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> pipe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>fns<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">=</span><span class="token operator">></span> fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">f</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> fn1 <span class="token operator">=</span> s <span class="token operator">=</span><span class="token operator">></span> s<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> fn2 <span class="token operator">=</span> s <span class="token operator">=</span><span class="token operator">></span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> fn3 <span class="token operator">=</span> s <span class="token operator">=</span><span class="token operator">></span> s <span class="token operator">+</span> <span class="token string">'!'</span><span class="token keyword">const</span> newFunc <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fn1<span class="token punctuation">,</span> fn2<span class="token punctuation">,</span> fn3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">newFunc</span><span class="token punctuation">(</span><span class="token string">'Time'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// emit!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们看看用<code>pipe（）</code>实现的<code>toSlug（）</code>函数<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// using-pipe.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>  <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  encodeURIComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在命令式编程中，当您对某个变量执行转换时，您将在转换的每个步骤中找到对该变量的引用。上面的<code>pipe（）</code>实现是以无点的方式编写的，这意味着它根本不识别它运行的参数。<br></p><h3 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h3><p>我经常在单元测试和Redux状态之类的东西中使用管道来消除对中间变量的需要，这些中间变量只存在于一个操作和下一个操作之间的瞬态值。<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// using-trace.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> trace <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`== </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> label <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> x <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> toSlug <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">map</span><span class="token punctuation">(</span>toLowerCase<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'after map'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  encodeURIComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">'JS Cheerleader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// '== input:  JS Cheerleader'</span><span class="token comment" spellcheck="true">// '== after map:  js,cheerleader'</span><span class="token comment" spellcheck="true">// 'js-cheerleader'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>trace（）</code>只是更通用的<code>tap（）</code>的一种特殊形式，它允许你为流经管道的每个值执行一些操作<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// tap.js hosted with ❤ by GitHub</span><span class="token keyword">const</span> tap <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">fn</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在可以看到<code>trace（）</code>是一个特殊的<code>tap（）</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> trace <span class="token operator">=</span> label <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">tap</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`== </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> label <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> x <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 函数式编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 函数式编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>装饰器</title>
      <link href="/2019/07/18/typescript/decorators/"/>
      <url>/2019/07/18/typescript/decorators/</url>
      
        <content type="html"><![CDATA[<p>装饰器是一种为类声明和成员添加注释和元编程语法的方法，用于在编译时对类、类的方法、类的属性、类的方法的参数进行处理，通俗的讲就是在原有代码外层包装了一层处理逻辑，这样就可以在不改变原方法、函数等逻辑功能的基础上增加额外的处理行为</p><h3 id="使用装饰器"><a href="#使用装饰器" class="headerlink" title="使用装饰器"></a><strong>使用装饰器</strong></h3><p>要启用装饰器功能需要开始experimentalDecorators选项，两种方式</p><p>命令行</p><pre class="line-numbers language-ts"><code class="language-ts">tsc <span class="token operator">--</span>target ES5 <span class="token operator">--</span>experimentalDecorators<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>tsconfig.json配置</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token punctuation">{</span>    <span class="token string">"compilerOptions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token string">"target"</span><span class="token punctuation">:</span> <span class="token string">"ES5"</span><span class="token punctuation">,</span>        <span class="token string">"experimentalDecorators"</span><span class="token punctuation">:</span> <span class="token keyword">true</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="装饰器的简单应用"><a href="#装饰器的简单应用" class="headerlink" title="装饰器的简单应用"></a><strong>装饰器的简单应用</strong></h3><p>定义一个装饰器</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">function</span> people <span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在类中使用装饰器（@Decorator的语法是通过 @ 符号后边跟一个装饰器函数的引用）</p><pre class="line-numbers language-ts"><code class="language-ts">@people<span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="装饰器工厂"><a href="#装饰器工厂" class="headerlink" title="装饰器工厂"></a>装饰器工厂</h3><p>解决在类中调用装饰器传参数的场景</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 装饰器工厂</span><span class="token keyword">function</span> <span class="token function">people</span><span class="token punctuation">(</span>name <span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 装饰器</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span>           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 调用装饰器工厂</span>@<span class="token function">people</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">People</span><span class="token punctuation">{</span>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="多个装饰器应用"><a href="#多个装饰器应用" class="headerlink" title="多个装饰器应用"></a>多个装饰器应用</h3><p>当在一个类上由多个装饰器调用的时候，类似于<a href="functionalCombination.md">函数组合</a></p><p>定义多个装饰器</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">decorator1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"decorator1(): start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"decorator1(): end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">decorator2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"decorator2(): start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"decorator2(): end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用装饰器</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>  @<span class="token function">decorator1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  @<span class="token function">decorator2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出结果为(可以看作组合函数调用 decorator1(decorator2()))</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token function">decorator1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> start<span class="token function">decorator2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> start<span class="token function">decorator2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> end<span class="token function">decorator1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="类装饰器（Class）"><a href="#类装饰器（Class）" class="headerlink" title="类装饰器（Class）"></a>类装饰器（Class）</h3><ul><li>类装饰器应用于类的构造函数，用于观察，修改或替换类定义 </li><li>类会在class定义前调用，如果函数有返回值，它将使用提供的构造函数替换之前的构造函数</li><li>函数接收一个参数 <code>constructor</code> 之前的构造函数</li><li>如果返回新的构造函数，则必须维护原始原型</li></ul><p>我们定义一个类，继承原有的类并对这个类增加一些属性</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 定义类装饰器</span><span class="token keyword">function</span> personName<span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token punctuation">{</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">:</span><span class="token keyword">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">constructor</span><span class="token punctuation">:</span>T<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> <span class="token keyword">constructor</span> <span class="token punctuation">{</span>    name <span class="token operator">=</span> <span class="token string">"zhangsan"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 使用类装饰器</span>@personName<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  <span class="token keyword">constructor</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Hi, my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Hi, my name is wangwu</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// class_1 {name: "zhangsan",__proto__:Person}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="方法装饰器"><a href="#方法装饰器" class="headerlink" title="方法装饰器"></a>方法装饰器</h3><p>方法，属性，get、set访问器，都可以认为是类成员。所以被分为了Method Decorator、Accessor Decorator和Property Decorator 这三个参数 </p><p>方法装饰只是一个方法声明之前声明，方法装饰器不能用于声明文件，重载或任何其他环境上下文（例如declare类中）</p><p>方法装饰器的表达式将在运行时作为函数调用，具有以下三个参数：</p><ul><li>如果装饰器挂载于静态成员上，则会返回构造函数，如果挂载于实例成员上则会返回类的原型</li><li>装饰器挂载的成员名称</li><li>方法成员的属性描述对象（Object.getOwnPropertyDescriptor 的返回值）</li></ul><p>所谓的访问器也就是有 get set 前缀的函数，方法是控制属性的赋值及取值，访问器装饰器和方法装饰器一样因为和下面要说到的属性装饰器一样都是类的成员具有三个参数</p><p>Method Decorator、Accessor Decorator和Property Decorator<br>使用方法装饰器</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">Greeter</span> <span class="token punctuation">{</span>  greeting<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  <span class="token keyword">constructor</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>greeting <span class="token operator">=</span> message<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  @<span class="token function">enumerable</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span>  <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"Hello, "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>greeting<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">enumerable</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">,</span> propertyKey<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">:</span> PropertyDescriptor<span class="token punctuation">{</span>    descriptor<span class="token punctuation">.</span>enumerable <span class="token operator">=</span> value<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>明确一下静态成员与实例成员在返回值上的区别</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">Func</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 静态成员</span>  <span class="token keyword">static</span> method1 <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">static</span> method2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 实例成员</span>  method3 <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  method4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>静态成员 method1 和 method2 都是定义在 Func 构造函数上，method3 和 method4 区别在于 method3 定义在原型链之上 method4 只有在 Func 类实例化对象之后才有，转化ES5代码之后的样子</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">var</span> Func <span class="token operator">=</span> <span class="token comment" spellcheck="true">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">Func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>method4 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态成员</span>    Func<span class="token punctuation">.</span>method1 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 实例成员</span>    Func<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>method3 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    Func<span class="token punctuation">.</span>method2 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> Func<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过函数可以证明上述论点装饰器挂载于静态成员上，则会返回构造函数，如果挂载于实例成员上则会返回类的原型 而且 method4 在实例化之前是一个不存在的属性所以没有 descriptor，就是为什么TS在针对Property Decorator不传递第三个参数的原因</p><h3 id="访问器装饰器（get-set）"><a href="#访问器装饰器（get-set）" class="headerlink" title="访问器装饰器（get set）"></a>访问器装饰器（get set）</h3><p>访问器装饰器就是有get、set前缀的函数，用于控制属性的赋值及取值操作。上面说到和方法装饰器一样有三个参数</p><p>定义装饰器三个参数</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">configurable</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">,</span> propertyKey<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">:</span> PropertyDescriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>    descriptor<span class="token punctuation">.</span>configurable <span class="token operator">=</span> value<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>定义带有get，set的类</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  <span class="token keyword">private</span> _x<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>  <span class="token keyword">private</span> _y<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>  <span class="token keyword">constructor</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> x<span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>_y <span class="token operator">=</span> y<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  @<span class="token function">configurable</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span>  <span class="token keyword">get</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span> <span class="token punctuation">}</span>  @<span class="token function">configurable</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span>  <span class="token keyword">get</span> <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_y<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="属性装饰器"><a href="#属性装饰器" class="headerlink" title="属性装饰器"></a>属性装饰器</h3><p>属性装饰器由于没有返回 descriptor 所以只有两个参数，没有方法成员的属性描述对象，如果想要修改某一个静态属性，可以通过 Object.getOwnPropertyDescriptor 获取 descriptor</p><p><em>注意在TypeScript中如何初始化属性修饰符，因此不提供属性描述符作为属性修饰符的参数。这是因为当定义原型的成员时，当前没有机制来描述实例属性，也无法观察或修改属性的初始化器。返回值也被忽略。因此，属性装饰器只能用于观察已为类声明特定名称的属性。</em></p><p>定义类</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>  @configurable  <span class="token keyword">static</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>定义属性装饰器获取类属性上的值进行更改</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">configurable</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> x<span class="token punctuation">)</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>descriptor<span class="token punctuation">,</span>    value<span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Point<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 2 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以使用 reflect-metadata 这个库它主要用来在声明的时候添加和读取元数据<br>使用的时候需要安装</p><pre class="line-numbers language-js"><code class="language-js">npm i reflect<span class="token operator">-</span>metadata <span class="token operator">--</span>save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>之后在tsconfig.json 中配置emitDecoratorMetadata选项</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token punctuation">{</span>  <span class="token string">"compilerOptions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">"target"</span><span class="token punctuation">:</span> <span class="token string">"ES5"</span><span class="token punctuation">,</span>    <span class="token string">"experimentalDecorators"</span><span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>    <span class="token string">"emitDecoratorMetadata"</span><span class="token punctuation">:</span> <span class="token keyword">true</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>定义类</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">Greeter</span> <span class="token punctuation">{</span>    @<span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Hello, %s"</span><span class="token punctuation">)</span>    greeting<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>    <span class="token keyword">constructor</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>greeting <span class="token operator">=</span> message<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> formatString <span class="token operator">=</span> <span class="token function">getFormat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"greeting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> formatString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>greeting<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>// 利用 reflect-metadata 定义装饰器</p><p>Reflect.metadata 当作 Decorator 使用，当修饰类时，在类上添加元数据，当修饰类属性时，在类原型的属性上添加元数据</p><p>Reflect.getMetadata 能获取属性</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token string">"reflect-metadata"</span><span class="token punctuation">;</span><span class="token keyword">const</span> formatMetadataKey <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">"format"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">format</span><span class="token punctuation">(</span>formatString<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">metadata</span><span class="token punctuation">(</span>formatMetadataKey<span class="token punctuation">,</span> formatString<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">getFormat</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">,</span> propertyKey<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span>formatMetadataKey<span class="token punctuation">,</span> target<span class="token punctuation">,</span> propertyKey<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="参数装饰器"><a href="#参数装饰器" class="headerlink" title="参数装饰器"></a>参数装饰器</h3><p>参数装饰器和属性装饰器一样都是在函数运行时调用的，它接收3个参数</p><ul><li>如果装饰器挂载于静态成员上，则会返回构造函数，如果挂载于实例成员上则会返回类的原型</li><li>参数所处的函数名称</li><li>参数在函数中形参中的位置</li></ul><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">function</span> require <span class="token punctuation">(</span>value <span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target <span class="token punctuation">:</span> <span class="token keyword">any</span> <span class="token punctuation">,</span> propertyKey <span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token punctuation">,</span>parameterIndex <span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    obj<span class="token punctuation">[</span>parameterIndex<span class="token punctuation">]</span> <span class="token operator">=</span> value  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>  <span class="token function">method</span><span class="token punctuation">(</span>@<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">)</span> name <span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ['lisi']</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>偏应用函数、函数的柯里化</title>
      <link href="/2019/07/17/javascript/functioncurrying/"/>
      <url>/2019/07/17/javascript/functioncurrying/</url>
      
        <content type="html"><![CDATA[<p>偏应用函数简称偏函数，在模拟 bind 的时候已经说明其概念和作为主要 bind 的实现<br></p><p>函数柯里化主要是通过偏应用函数的实现，把接受多个参数的函数变换成接受一个单一参数的函数，并且返回接受余下的参数而且返回结果的新函数<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 柯里化之前</span><span class="token keyword">function</span> add <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 柯里化之后</span><span class="token keyword">function</span> add <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> a<span class="token operator">+</span>b  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 等同于</span><span class="token keyword">const</span> add <span class="token operator">=</span> a <span class="token operator">=</span><span class="token operator">></span> b <span class="token operator">=</span><span class="token operator">></span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// => 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>首先函数接受 a 参数 然后返回一个新的匿名函数体确定了新的词法作用域,在该词法作用域中也拥有 a 参数</li><li>该匿名函数调用传入参数 3 返回 a+b 的和</li><li>通过上面程序了解到柯里化函数的特点是总是返回一个一元的函数：一个带有一个参数的新函数，不同的是普通函数可以根据需要一次获取尽可能多的参数</li></ol><h3 id="为什么要柯里化"><a href="#为什么要柯里化" class="headerlink" title="为什么要柯里化"></a>为什么要柯里化</h3><ol><li>柯里化在函数组合的上下文中起到关键的作用,能够让你重新组合你的应用，将复杂的功能拆分成一个个简单的部分，这样容易更改，理解</li><li>柯里化也是一种函数预加载的方法，通过传递较少的参数得到一个在相同词法作用域当中缓存了这些参数的新函数，其实这也是一种对参数的缓存</li></ol><h3 id="如何柯里化"><a href="#如何柯里化" class="headerlink" title="如何柯里化"></a>如何柯里化</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 普通</span><span class="token keyword">const</span> sayName <span class="token operator">=</span> name <span class="token operator">=</span><span class="token operator">></span> age <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, Im years old </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">;</span><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> age <span class="token operator">=</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 利用bind</span><span class="token keyword">function</span> person <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I,m years old </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, my height is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>height<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> meters`</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">let</span> info <span class="token operator">=</span> person<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">175</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="柯里化函数的应用场景"><a href="#柯里化函数的应用场景" class="headerlink" title="柯里化函数的应用场景"></a>柯里化函数的应用场景</h3><ol><li>延迟计算</li><li>参数复用</li><li>动态创建函数</li></ol><p>延迟计算<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 普通实现</span><span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> a<span class="token operator">+</span>b  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 15</span><span class="token comment" spellcheck="true">// 柯里化实现</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> adder <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 利用闭包特性保存_args的值</span>      <span class="token keyword">var</span> _adder <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_args<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> _adder<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 利用隐式转换的特性，计算最终的值返回</span>      _adder<span class="token punctuation">.</span>toString <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> _args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> _adder<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> adder<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 15</span>优点：调用灵活，参数定义随意充分利用了柯里化提延迟执行的特点延迟执行 – 返回新函数可以进行任意调用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>DOM操作中的事件绑定(动态创建函数)<br><br>当在多次调用同一个函数，并且传递的参数绝大多数是相同的。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 普通版本</span><span class="token keyword">var</span> addEvent <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> capture<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>      el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> capture<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>      el<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">"on"</span> <span class="token operator">+</span> type<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 柯里化版本</span> <span class="token keyword">var</span> addEvent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> capture<span class="token punctuation">)</span> <span class="token punctuation">{</span>        el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>          fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>capture<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> capture<span class="token punctuation">)</span> <span class="token punctuation">{</span>        el<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">"on"</span> <span class="token operator">+</span> type<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>优点：不用每次调用进行 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 判断兼容性问题充分利用了柯里化提前返回和延迟执行的特点提前返回 – 使用函数立即调用进行了一次兼容判断（部分求值），返回兼容的事件绑定方法延迟执行 – 返回新函数，在新函数调用兼容的事件方法。等待addEvent新函数调用，延迟执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当然应用场景还有很多，比如我们经常提到的防抖和节流问题，充分的利用了函数式编程的延迟执行特性，将多个间隔接近的函数执行合并成一次函数执行来提高性能问题。<br><br>关于事件节流和防抖动将会在后续的专题中单独指出<br></p>]]></content>
      
      
      <categories>
          
          <category> 函数式编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 函数式编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tsconfig.json</title>
      <link href="/2019/07/15/typescript/tsconfig/"/>
      <url>/2019/07/15/typescript/tsconfig/</url>
      
        <content type="html"><![CDATA[<p>## </p><p>如果一个目录下存在一个tsconfig.json文件，它会把一个文件夹转换为项目，也意味着这个目录是TypeScript项目的根目录</p><h3 id="使用tsconfig-json"><a href="#使用tsconfig-json" class="headerlink" title="使用tsconfig.json"></a>使用tsconfig.json</h3><p>初始化 tsconfig.json 或者手动建立文件tsconfig.json</p><pre class="line-numbers language-ts"><code class="language-ts">tsc <span class="token operator">--</span>init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果项目配置了tsconfig.json，那么在进行转换的时候可以在命令行直接输入</p><pre class="line-numbers language-ts"><code class="language-ts">tsc <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编译器会从当前目录开始去查找tsconfig.json文件，逐级向上搜索父目录</p><p>否则就需要在编译时加上文件及目录</p><pre class="line-numbers language-ts"><code class="language-ts">tsc test<span class="token punctuation">.</span>ts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>默认在当前目录生成test.js</p><h3 id="编写需要的配置项"><a href="#编写需要的配置项" class="headerlink" title="编写需要的配置项"></a>编写需要的配置项</h3><p>下面这个例子是列举了在项目中经常用到的配置，当前根据项目的不同会有区别</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token punctuation">{</span>  <span class="token string">"compileOnSave"</span><span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//让IDE在保存文件的时候根据tsconfig.json重新生成文件</span>  <span class="token string">"compilerOptions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">"target"</span><span class="token punctuation">:</span> <span class="token string">"ES5"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 目标代码类型版本</span>    <span class="token string">"outDir"</span><span class="token punctuation">:</span><span class="token string">"build/"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 重定向输出目录</span>    <span class="token string">"baseUrl"</span><span class="token punctuation">:</span>  <span class="token string">"https://test.file.com"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 解析非相对模块名的基准目录</span>    <span class="token string">"noImplicitAny"</span><span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 在表达式和声明上有隐含的'any'类型时报错</span>    <span class="token string">"removeComments"</span><span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//编译 js 的时候，删除掉注释</span>    <span class="token string">"preserveConstEnums"</span><span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 保留const和enum声明</span>    <span class="token string">"experimentalDecorators"</span><span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 使用装饰器要开始此选项</span>    <span class="token string">"emitDecoratorMetadata"</span><span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 在使用reflect-metadata库时候需要添加，给源码里的装饰器声明加上设计类型元数据</span>    <span class="token string">"declaration"</span><span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 编译时候是否同时产生一份 声明文件</span>    <span class="token string">"strict"</span><span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 编译时开启严格模式</span>    <span class="token string">"sourceMap"</span><span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 生成相应的.map文件</span>    <span class="token string">"module"</span><span class="token punctuation">:</span> <span class="token string">"commonjs"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//生成哪种模块系统代码</span>    <span class="token string">"watch"</span><span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//会在文件改变时候监视输出文件，重新进行编译</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token string">"include"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 编译时包含的目录及文件</span>    <span class="token string">"test.ts"</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">"exclude"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 编译时排除的目录及文件</span>    <span class="token string">"node_modules"</span><span class="token punctuation">,</span>     <span class="token string">"dist"</span><span class="token punctuation">,</span>      <span class="token string">"mock"</span>    <span class="token string">"build"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">"lib"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 需编译过程中需要引入的库文件的列表，不然编译器识别错误报错</span>    <span class="token string">"es2017"</span><span class="token punctuation">,</span>    <span class="token string">"dom"</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em>注意使用”include”引入的文件可以使用”exclude”属性过滤。 然而，通过 “files”属性明确指定的文件不管”exclude”如何设置却总是会被包含在内。 如果没有特殊指定， “exclude”默认情况下会排除node_modules，bower_components，jspm_packages和outDir目录。</em></p><p>更多参数请参考官网<a href="https://www.tslang.cn/docs/handbook/compiler-options.html" target="_blank" rel="noopener"> tsconfig配置列表 </a></p>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>函数式编程-纯函数</title>
      <link href="/2019/07/15/javascript/functionalpurity/"/>
      <url>/2019/07/15/javascript/functionalpurity/</url>
      
        <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>说纯函数概念之前我们再来复习一下什么是函数</p><p>函数是一个方法，有一些输入，称为变量，并产生一些输出称为返回值</p><p>函数可以用于以下目的</p><ol><li>映射：根据给定的输入生成一些输出，函数将输入值映射到输出值上</li><li>过程：调用函数按照一系列的步骤来执行。这就是我们说的过程编程</li><li>I/O：与系统其他部分通信的功能。如存储系统日志，网络等</li></ol><p>纯函数都是关于映射的所以对于相同的输入，永远会得到相同的输出，而且没有任何可观察的副作用，也不依赖外部环境的状态。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 纯函数</span><span class="token keyword">const</span> double <span class="token operator">=</span> x <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span>log（double（<span class="token number">5</span>））<span class="token comment" spellcheck="true">// 不纯</span><span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">const</span> double <span class="token operator">=</span> x <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">*</span> val<span class="token punctuation">;</span>console<span class="token punctuation">.</span>log（double（<span class="token number">5</span>））<span class="token comment" spellcheck="true">// 不纯</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="函数式编程-纯函数"><a href="#函数式编程-纯函数" class="headerlink" title="函数式编程-纯函数"></a>函数式编程-纯函数</h3><p>纯函数的优点<br></p><ol><li>独立于外部状态，所以不会受外部全局环境的影响而产生的错误或者副作用</li><li>由于其独立，所以易于重构和重组和重用，使程序更加灵活</li></ol><h3 id="函数式编程-幂等性"><a href="#函数式编程-幂等性" class="headerlink" title="函数式编程-幂等性"></a>函数式编程-幂等性</h3><p>执行多次所产生的影响均与一次执行的影响相同，也就是说执行一次和执行多次对系统内部的状态影响是一样的 <br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  sayName <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>my name is <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>zhangsan<span class="token punctuation">)</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="纯函数和幂等性的区别"><a href="#纯函数和幂等性的区别" class="headerlink" title="纯函数和幂等性的区别"></a>纯函数和幂等性的区别</h3><ol><li>法调用多次对内部的状态影响是一样的，则这么方法就具有幂等性，在函数式编程中，纯函数也具有幂等性，但具有幂等性的函数却不一定是纯函数。</li><li>纯函数主要强调相同的输入，多次调用，输出也相同且无副作用，而幂等主要强调多次调用，对内部的状态的影响是一样的，调用返回值可能不同。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 函数式编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 函数式编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>函数式编程-基本理论</title>
      <link href="/2019/07/12/javascript/functionalbase/"/>
      <url>/2019/07/12/javascript/functionalbase/</url>
      
        <content type="html"><![CDATA[<h3 id="什么是函数式编程"><a href="#什么是函数式编程" class="headerlink" title="什么是函数式编程"></a>什么是函数式编程</h3><p>函数式编程主要是范畴论数学中的一个分支，它认为所有的概念体系都可以抽象成一个个范畴，属于结构化编程的一种。运算过程尽量写成一系列嵌套的函数调用 <br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//  函数式编程</span><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">subtract</span><span class="token punctuation">(</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 过程编程</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">multiply</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">subtract</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="为什么学习函数式编程"><a href="#为什么学习函数式编程" class="headerlink" title="为什么学习函数式编程"></a>为什么学习函数式编程</h3><p>其实个人觉的学习函数式编程就是为了更好的模块化，使其看起来更简洁。这也是<a href="http://en.wikipedia.org/wiki/Programming_paradigm" target="_blank" rel="noopener">范式编程</a>和<a href="http://en.wikipedia.org/wiki/Structured_programming" target="_blank" rel="noopener">结构化编程</a>的主要思想</p><h3 id="函数式编程特点"><a href="#函数式编程特点" class="headerlink" title="函数式编程特点"></a>函数式编程特点</h3><ol><li>函数是”第一等公民”</li><li>只用表达式，不用语句</li><li>没有副作用（函数要保持独立，所有功能就是返回一个新的值，没有其他行为，更不能修改外部状态的值）</li><li>不修改状态（可以使用参数来保存状态，不可以使用变量来保存状态）</li><li>引用透明（函数运行只靠参数）</li></ol><h3 id="函数式编程的优点"><a href="#函数式编程的优点" class="headerlink" title="函数式编程的优点"></a>函数式编程的优点</h3><ol><li>代码更简洁，易于理解，维护更方便</li><li>易于并发编程（由于不修改变量所以不存在锁线程的问题）</li><li>代码的热升级</li></ol>]]></content>
      
      
      <categories>
          
          <category> 函数式编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 函数式编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mixinx</title>
      <link href="/2019/07/02/typescript/mixinx/"/>
      <url>/2019/07/02/typescript/mixinx/</url>
      
        <content type="html"><![CDATA[<p> 一般情况下，我们已经习惯了用面向对象的继承方式，比如在 JS ES5中用 prototype， 在 ES6 和 TS 中 用extends,然而用 mixinx 也是一种通过可重用组件创建类的方式，来进行混用，混合多个类的方法到一个类上</p><h3 id="应用例子"><a href="#应用例子" class="headerlink" title="应用例子"></a>应用例子</h3><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// Disposable Mixin</span><span class="token keyword">class</span> <span class="token class-name">Disposable</span> <span class="token punctuation">{</span>    isDisposed<span class="token operator">!</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>    <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isDisposed<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Activatable Mixin</span><span class="token keyword">class</span> <span class="token class-name">Activatable</span> <span class="token punctuation">{</span>    isActive<span class="token operator">!</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>    <span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isActive<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 没使用 extends 而是使用 implements</span><span class="token keyword">class</span> <span class="token class-name">SmartObject</span> <span class="token keyword">implements</span> <span class="token class-name">Disposable</span><span class="token punctuation">,</span>Activatable <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Disposable</span>    isDisposed<span class="token punctuation">:</span> <span class="token keyword">boolean</span> <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>    dispose<span class="token operator">!</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">void</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Activatable</span>    isActive<span class="token punctuation">:</span> <span class="token keyword">boolean</span> <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>    activate<span class="token operator">!</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">void</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// mixins混入定义的类，完成全部实现部分</span><span class="token function">applyMixins</span><span class="token punctuation">(</span>SmartObject<span class="token punctuation">,</span> <span class="token punctuation">[</span>Disposable<span class="token punctuation">,</span> Activatable<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 创建 applyMixins 混用函数，作用是遍历mixins上的所有属性，并复制到目标上去，把之前的占位属性替换成真正的实现代码。</span><span class="token keyword">function</span> <span class="token function">applyMixins</span><span class="token punctuation">(</span>derivedCtor<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">,</span> baseCtors<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    baseCtors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>baseCtor <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>baseCtor<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>name <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            derivedCtor<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> baseCtor<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> smartObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmartObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>smartObject<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// false</span>smartObject<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>声明文件</title>
      <link href="/2019/06/20/typescript/declarefile/"/>
      <url>/2019/06/20/typescript/declarefile/</url>
      
        <content type="html"><![CDATA[<h2 id="声明文件"><a href="#声明文件" class="headerlink" title="声明文件"></a>声明文件</h2><h3 id="识别库的类型"><a href="#识别库的类型" class="headerlink" title="识别库的类型"></a>识别库的类型</h3><p>全局库(全局命名空间下能访问)</p><ul><li>顶级的var语句或function声明</li><li>一个或多个赋值语句到window上</li><li>假设DOM原始值像document或window是存在的</li></ul><pre class="line-numbers language-ts"><code class="language-ts"><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"jquery.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>window<span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1111'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>模块化库（只能工作在模块加载器的环境下）</p><ul><li>无条件的调用require或define</li><li>像import * as a from ‘b’; or export c;这样的声明</li><li>赋值给exports或module.exports</li></ul><p>UMD模块是指那些既可以作为模块使用（通过导入）又可以作为全局（在没有模块加载器的环境里）使用的模块</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"moment"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moment<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在浏览器环境内也可以这样使用</p><pre class="line-numbers language-ts"><code class="language-ts">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moment<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>识别UMD库</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"libName"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">module</span> <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">module</span><span class="token punctuation">.</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">module</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"libName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        root<span class="token punctuation">.</span>returnExports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>libName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用依赖"><a href="#使用依赖" class="headerlink" title="使用依赖"></a>使用依赖</h3><p>依赖全局库</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">/// &lt;reference types="someLib" /></span><span class="token keyword">function</span> <span class="token function">getThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> someLib<span class="token punctuation">.</span>thing<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>依赖模块</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token operator">*</span> as moment <span class="token keyword">from</span> <span class="token string">"moment"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">getThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> moment<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>依赖UMD库</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// &lt;reference types="moment" /></span><span class="token keyword">function</span> <span class="token function">getThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> moment<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果你的模块或UMD库依赖于一个UMD库</p><p>不要使用/// &lt;reference指令去声明UMD库的依赖！</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token operator">*</span> as someLib <span class="token keyword">from</span> <span class="token string">'someLib'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="防止命名冲突"><a href="#防止命名冲突" class="headerlink" title="防止命名冲突"></a>防止命名冲突</h3><p>在书写全局声明文件时，使用库定义的全局变量名来声明命名空间类型</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">declare</span> namespace cats <span class="token punctuation">{</span>    <span class="token keyword">interface</span> <span class="token class-name">KittySettings</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="定义全局库模版"><a href="#定义全局库模版" class="headerlink" title="定义全局库模版"></a>定义全局库模版</h3><p>模版文件<a href="global.d.ts.md"> global.d.ts </a>定义了myLib库作为例子</p><h3 id="定义模块化库模版"><a href="#定义模块化库模版" class="headerlink" title="定义模块化库模版"></a>定义模块化库模版</h3><p>针对模块有三种可用的模块， module.d.ts, module-class.d.ts and module-fun</p><p><a href="module.d.ts.md"> module.d.ts </a> 作为函数调用</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Note: calling 'x' as a function</span><span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><a href="module-class.d.ts.md">module-class.d.ts </a>使用new来构造调用</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"bar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Note: using 'new' operator on the imported variable</span><span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">x</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果模块不能被调用或构造，使用<a href="module.d.ts.md"> module.d.ts </a>文件</p><h3 id="使用库"><a href="#使用库" class="headerlink" title="使用库"></a>使用库</h3><p>在TypeScript 2.0以上的版本，获取类型声明文件只需要使用npm。</p><pre class="line-numbers language-ts"><code class="language-ts">npm install <span class="token operator">--</span>save @types<span class="token operator">/</span>lodash<span class="token keyword">import</span> <span class="token operator">*</span> as _ <span class="token keyword">from</span> <span class="token string">"lodash"</span><span class="token punctuation">;</span>_<span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token string">"Hello TypeScript!"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果npm包没有包含它的声明文件，那就必须下载相应的@types包</p><p>大多数类型声明包的名字总是与它们在npm上的包的名字相同，但是有@types/前缀</p><p>查找更多typeScript 库请前往 <a href="https://aka.ms/types" target="_blank" rel="noopener">https://aka.ms/types</a></p>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>模块与命名空间</title>
      <link href="/2019/06/15/typescript/module/"/>
      <url>/2019/06/15/typescript/module/</url>
      
        <content type="html"><![CDATA[<p>在 JS 中 有 module 模块机制，和 TS 类似，在 TS 中内部模块命名空间为关键字namespaces。外部模块现在只是modules</p><h3 id="使用命名空间"><a href="#使用命名空间" class="headerlink" title="使用命名空间 "></a>使用命名空间 <br></h3><ul><li>命名空间只是全局命名空间中的JavaScript对象</li><li>使用 namespace 关键字</li><li>跨多个文件，并且可以使用连接–outFile</li><li>不使用require关键字</li></ul><p><strong>1.单文件命名空间</strong></p><pre class="line-numbers language-ts"><code class="language-ts">  namespace Validation <span class="token punctuation">{</span>    <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">StringValidator</span> <span class="token punctuation">{</span>      <span class="token function">isAcceptable</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> lettersRegexp <span class="token operator">=</span> <span class="token regex">/^[A-Za-z]+$/</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> numberRegexp <span class="token operator">=</span> <span class="token regex">/^[0-9]+$/</span><span class="token punctuation">;</span>    <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LettersOnlyValidator</span> <span class="token keyword">implements</span> <span class="token class-name">StringValidator</span> <span class="token punctuation">{</span>        <span class="token function">isAcceptable</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> lettersRegexp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ZipCodeValidator</span> <span class="token keyword">implements</span> <span class="token class-name">StringValidator</span> <span class="token punctuation">{</span>        <span class="token function">isAcceptable</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> numberRegexp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>2.多文件命名空间及引入</strong></p><p>Validation.ts</p><pre class="line-numbers language-ts"><code class="language-ts">namespace Validation <span class="token punctuation">{</span>  <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">StringValidator</span> <span class="token punctuation">{</span>    <span class="token function">isAcceptable</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>LettersOnlyValidator.ts</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">/// &lt;reference path="Validation.ts" /></span>namespace Validation <span class="token punctuation">{</span>    <span class="token keyword">const</span> lettersRegexp <span class="token operator">=</span> <span class="token regex">/^[A-Za-z]+$/</span><span class="token punctuation">;</span>    <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LettersOnlyValidator</span> <span class="token keyword">implements</span> <span class="token class-name">StringValidator</span> <span class="token punctuation">{</span>        <span class="token function">isAcceptable</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> lettersRegexp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ZipCodeValidator.ts</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">/// &lt;reference path="Validation.ts" /></span>namespace Validation <span class="token punctuation">{</span>    <span class="token keyword">const</span> numberRegexp <span class="token operator">=</span> <span class="token regex">/^[0-9]+$/</span><span class="token punctuation">;</span>    <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ZipCodeValidator</span> <span class="token keyword">implements</span> <span class="token class-name">StringValidator</span> <span class="token punctuation">{</span>        <span class="token function">isAcceptable</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> numberRegexp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Test.ts</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">/// &lt;reference path="Validation.ts" /></span><span class="token comment" spellcheck="true">/// &lt;reference path="LettersOnlyValidator.ts" /></span><span class="token comment" spellcheck="true">/// &lt;reference path="ZipCodeValidator.ts" /></span><span class="token comment" spellcheck="true">// Some samples to try</span><span class="token keyword">let</span> strings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Hello"</span><span class="token punctuation">,</span> <span class="token string">"98052"</span><span class="token punctuation">,</span> <span class="token string">"101"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Validators to use</span><span class="token keyword">let</span> validators<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>s<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Validation<span class="token punctuation">.</span>StringValidator<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>validators<span class="token punctuation">[</span><span class="token string">"ZIP code"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validation<span class="token punctuation">.</span>ZipCodeValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>validators<span class="token punctuation">[</span><span class="token string">"Letters only"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validation<span class="token punctuation">.</span>LettersOnlyValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Show whether each string passed each validator</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> s of strings<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> name <span class="token keyword">in</span> validators<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> s <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> validators<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"matches"</span> <span class="token punctuation">:</span> <span class="token string">"does not match"</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> name <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>涉及多个文件，我们需要确保加载所有已编译的代码。有两种方法可以做到这一点。</p><ol><li><strong>–outFile 编译器将根据文件中存在的引用标记自动排序输出文件</strong><pre class="line-numbers language-ts"><code class="language-ts">tsc <span class="token operator">--</span>outFile sample<span class="token punctuation">.</span>js Test<span class="token punctuation">.</span>ts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><strong>为每一个文件编译一个 JS 文件利用 Script 按照顺序引入</strong><pre class="line-numbers language-ts"><code class="language-ts"><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"Validation.js"</span> type<span class="token operator">=</span><span class="token string">"text/javascript"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"LettersOnlyValidator.js"</span> type<span class="token operator">=</span><span class="token string">"text/javascript"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"ZipCodeValidator.js"</span> type<span class="token operator">=</span><span class="token string">"text/javascript"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"Test.js"</span> type<span class="token operator">=</span><span class="token string">"text/javascript"</span> <span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="使用模块"><a href="#使用模块" class="headerlink" title="使用模块 "></a>使用模块 <br></h3><ul><li>模块在自己的范围内执行，而不是在全局范围内执行</li><li>模块中声明的变量，函数，类等在模块外部不可见,除非使用其中一个export显式导出</li><li>模块是声明性的; 模块之间的关系是根据文件级别的导入和导出来指定的</li><li>模块文件之间引用用关键字 import 或被 export</li></ul><p><strong>1.使用 export 关键字来导出声明</strong></p><p>单模块导出</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">StringValidator</span> <span class="token punctuation">{</span>  <span class="token function">isAcceptable</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>重命名导出</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">ZipCodeValidator</span> <span class="token keyword">implements</span> <span class="token class-name">StringValidator</span> <span class="token punctuation">{</span>  <span class="token function">isAcceptable</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> numberRegexp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token punctuation">{</span> ZipCodeValidator <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">{</span> ZipCodeValidator as mainValidator <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>导出所有模块</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">"./StringValidator"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">"./ZipCodeValidator"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>2.使用 import 关键字来导入声明</strong></p><p>从模块导入单个导出</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> ZipCodeValidator <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./ZipCodeValidator"</span><span class="token punctuation">;</span><span class="token keyword">let</span> myValidator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipCodeValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>重命名导入</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> ZipCodeValidator as ZCV <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./ZipCodeValidator"</span><span class="token punctuation">;</span><span class="token keyword">let</span> myValidator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZCV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>将整个模块导入单个变量，并使用它来访问模块导出</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token operator">*</span> as validator <span class="token keyword">from</span> <span class="token string">"./ZipCodeValidator"</span><span class="token punctuation">;</span><span class="token keyword">let</span> myValidator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">validator<span class="token punctuation">.</span>ZipCodeValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>仅使用这个文件</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token string">"./my-module.js"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>3.模块的代码生成</strong></p><p>编译器将为Node.js（CommonJS），require.js（AMD），UMD，SystemJS或ECMAScript 2015本机模块（ES6）模块加载系统生成适当的代码</p><p>编译 commonjs 规范</p><pre class="line-numbers language-ts"><code class="language-ts">tsc <span class="token operator">--</span><span class="token keyword">module</span> commonjs Test<span class="token punctuation">.</span>ts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编译 amd 规范</p><pre class="line-numbers language-ts"><code class="language-ts">tsc <span class="token operator">--</span><span class="token keyword">module</span> amd Test<span class="token punctuation">.</span>ts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>promise</title>
      <link href="/2019/06/11/javascript/promise/"/>
      <url>/2019/06/11/javascript/promise/</url>
      
        <content type="html"><![CDATA[<p>本篇文章主要是实现 Promise 的原理, 具体 API 用法不在本文中做介绍。可以查看阮一峰老师的 <a href="http://es6.ruanyifeng.com/#docs/promise" target="_blank" rel="noopener">ES6 Promise教程</a><br></p><p>实现 Promise 首先要知道它的执行特点<br></p><ol><li>Promise 是一个构造函数，接受函数作为参数(resolve(),reject()) </li><li>Promise 对象有三种状态 pending(进行中), fulfilled(成功), rejected(失败)</li><li>Promise 从 pending 变为 fulfilled 过程是成功的过程可以执行回调函数 resolve() </li><li>Promise 从 pending 变为 rejected 过程是失败的过程可以执行回调函数 reject()</li><li>Promise 状态无法中途取消，一旦建立立即执行，会一直保持这个结果，这时也叫 resolved(已定型状态)</li><li>Promise 状态改变时 then 方法支持多次链式调用 </li><li>Promise 如果不设置回调函数内部会抛异常</li></ol><h3 id="定义构造函数"><a href="#定义构造函数" class="headerlink" title="定义构造函数"></a>定义构造函数</h3><p>构造函数 Promise 必须接受函数作为参数</p><ol><li>定义构造函数</li><li>判断一个参数是否为函数</li></ol><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 封装判断参数是够是函数 */</span><span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 定义构造函数 * @param {*} fn  */</span><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="定义-resolve"><a href="#定义-resolve" class="headerlink" title="定义 resolve"></a>定义 resolve</h3><p>在内部定义 resolve 方法作为参数传到 fn 中，fn 调用成功后会调用 resolve 方法，之后在执行 then 中注册的回调函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 定义构造函数 * @param {*} fn  */</span><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 判断是否是函数</span>  <span class="token keyword">var</span> _isFunction <span class="token operator">=</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 如果不是函数抛出异常</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 定义回调状态</span>  <span class="token keyword">var</span> __callback  <span class="token keyword">this</span><span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>    __callback <span class="token operator">=</span> status  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 定义 resolve 函数传入成功的数据</span>  <span class="token keyword">function</span> resolve <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">__callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用例子</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> request <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"renbo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 输出</span>renbosuccess<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的例子我们已经简单的实现了 promise 的基础回调，接下来我们完成链式语法调用以及then队列管理</p><h3 id="链式语法及队列管理"><a href="#链式语法及队列管理" class="headerlink" title="链式语法及队列管理"></a>链式语法及队列管理</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Promise <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _isFunction <span class="token operator">=</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>      _value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      _this<span class="token punctuation">.</span>_resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>    _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 将 resolve 中执行回调的逻辑放置到 JS 任务队列列末尾</span>  <span class="token keyword">function</span> resolve <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _value <span class="token operator">=</span> val        <span class="token function">callback</span><span class="token punctuation">(</span>_value<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  fn <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="加入状态并串行Promise"><a href="#加入状态并串行Promise" class="headerlink" title="加入状态并串行Promise"></a>加入状态并串行Promise</h3><p>Promise 对象有三种状态 <br></p><ol><li>pending(进行中) 立即执行</li><li>从 pending 变为 fulfilled 过程是成功的过程可以执行回调函数 resolve(‘fulfilled’) </li><li>从 pending 变为 rejected 过程是失败的过程可以执行回调函数 reject(‘rejected’)</li></ol><p><code>promsie状态 只能由 pending =&gt; fulfilled/rejected, 一旦修改就不能再变</code></p><p>我们加入上面的状态并串行Promise</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Promise <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> _isFunction <span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>      _val <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      _this<span class="token punctuation">.</span>_resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// handle 函数对上一个 promise 的 then 中回调进行了处理，并且调用当前的 promise 中的 resolve 方法。</span>      <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span>_val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_val<span class="token punctuation">)</span> <span class="token operator">||</span> _val        <span class="token comment" spellcheck="true">// 如果是⼀一个 promise 对象，就会调⽤ then 方法，形成一个嵌套</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token string">'then'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          ret<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_status <span class="token operator">===</span> <span class="token string">'PENDING'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>promise<span class="token punctuation">.</span>_status <span class="token operator">===</span> <span class="token string">'FULFILLED'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 将 resolve 中执行回调的逻辑放置到 JS 任务队列列末尾</span>  <span class="token keyword">function</span> resolve <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"FULFILLED"</span><span class="token punctuation">;</span>      _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _val <span class="token operator">=</span> val        <span class="token function">callback</span><span class="token punctuation">(</span>_val<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  fn <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="错误处理reject"><a href="#错误处理reject" class="headerlink" title="错误处理reject"></a>错误处理reject</h3><p>在异步操作中，操作可能失败，执行失败的回调函数，上面已经说到从 pending 变为 rejected 过程是失败的过程可以执行回调函数 reject()</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/**   * 工具函数判断是否是 function   * @param {*} func    */</span>  <span class="token keyword">function</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Function]'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_value<span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_reason<span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_rejects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token string">"PENDING"</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**   * promise then回调   * @onFulfilled 执行成功状态的处理函数   * @onRejected 执行失败状态处理函数   */</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/**       * 对上一个 promise 的 then 中回调进行了处理       * 并且调用当前的 promise 中的 resolve 方法       */</span>      <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token string">'then'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          ret<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>            <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token keyword">function</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>          <span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/**       * 错误处理回调函数       */</span>      <span class="token keyword">function</span> <span class="token function">errback</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        reason <span class="token operator">=</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">||</span> reason<span class="token punctuation">;</span>        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/**       * 根据当前异步状态执行操作       */</span>      <span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">'PENDING'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>          _this<span class="token punctuation">.</span>_rejects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>errback<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">'FULFILLED'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">'REJECTED'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">errback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_reason<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      config<span class="token punctuation">[</span>_this<span class="token punctuation">.</span>_status<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * 成功的回调函数   * setTimeout作用是将resolve    * 执行回调的逻辑放置到 JS 任务队列列末尾   * 防止then执行在resolve之前   * @FULFILLED 状态   * @param {*} value    */</span>  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">"FULFILLED"</span>      _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>       _this<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * 错误处理回调函数   * @REJECTED 状态   * @param {*} value    */</span>  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token string">"REJECTED"</span>      _this<span class="token punctuation">.</span>_rejects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _this<span class="token punctuation">.</span>_reason <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实现Promise-all"><a href="#实现Promise-all" class="headerlink" title="实现Promise.all"></a>实现Promise.all</h3><p>实现Promise.all函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * Promise.all * 接收一个元素为 Promise 对象的数组作为参数 * 返回一个Promise实例 * 当这个数组里的所有promise对象都变为resolve状态的时候，才会返回 */</span>Promise<span class="token punctuation">.</span>all <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You must pass an array to all.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 返回 promise 实例</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">.</span>length<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>    promiseArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>      promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">done</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>reject<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">gen</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">===</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实现Promise-race"><a href="#实现Promise-race" class="headerlink" title="实现Promise.race"></a>实现Promise.race</h3><p>实现Promise.race函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * Promise.race * 接收一个元素为 Promise 对象的数组作为参数 * 返回一个Promise实例 * 只要该数组中的任意一个 Promise 对象的状态发⽣变化(无论是 resolve 还是 reject)该⽅法都会返回 */</span>Promise<span class="token punctuation">.</span>race <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You must pass an array to all.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 返回 promise 实例</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">{</span>    promiseArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>      promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实现-catch"><a href="#实现-catch" class="headerlink" title="实现 catch "></a>实现 catch <br></h3><p>实现 catch </p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 链式写法中可以捕获前面then中发送的异常 */</span><span class="token keyword">function</span> Promise <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>  <span class="token operator">...</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> _this<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="代码封装"><a href="#代码封装" class="headerlink" title="代码封装"></a>代码封装</h3><p>经过上面的几个步骤我们基本实现了 promise 的几个重要特性，下面我们将代码整理一下</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/* * @Description: promise  * @Author: renbo * @Date: 2019-08-12 15:13:40 * @LastEditTime: 2019-08-15 10:34:44 */</span><span class="token keyword">var</span> Promise <span class="token operator">=</span> <span class="token comment" spellcheck="true">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> Promise <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>    _this<span class="token punctuation">.</span>_value <span class="token operator">=</span> undefined<span class="token punctuation">;</span>    _this<span class="token punctuation">.</span>_reason <span class="token operator">=</span> undefined<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//存储状态</span>    _this<span class="token punctuation">.</span>_resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    _this<span class="token punctuation">.</span>_rejects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 异常处理</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Promise must accept a function as a parameter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//由於apply參數是數組</span>      _this<span class="token punctuation">.</span>final<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'FULFILLED'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>final<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'REJECTED'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>reason<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * 用于resolve 和 reject    * 异步调用，保证then是先执行的   * @param {*} status    * @param {*} value    */</span>  Promise<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>final <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>status<span class="token punctuation">,</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span> st<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_status <span class="token operator">!==</span> <span class="token string">'PENDING'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      _this<span class="token punctuation">.</span>_status <span class="token operator">=</span> status<span class="token punctuation">;</span>      st <span class="token operator">=</span> _this<span class="token punctuation">.</span>_status <span class="token operator">===</span> <span class="token string">'FULFILLED'</span>      queue <span class="token operator">=</span> _this<span class="token punctuation">[</span>st <span class="token operator">?</span> <span class="token string">'_resolves'</span> <span class="token punctuation">:</span> <span class="token string">'_rejects'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">while</span><span class="token punctuation">(</span>fn <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        value <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">||</span> value<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      _this<span class="token punctuation">[</span>st <span class="token operator">?</span> <span class="token string">'_value'</span> <span class="token punctuation">:</span> <span class="token string">'_reason'</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>      _this<span class="token punctuation">[</span><span class="token string">'_resolves'</span><span class="token punctuation">]</span> <span class="token operator">=</span> _this<span class="token punctuation">[</span><span class="token string">'_rejects'</span><span class="token punctuation">]</span> <span class="token operator">=</span> undefined<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * then    * @params onFulfilled   * @params onRejected   */</span>  Promise<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>then <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 每次返回一个promise，保证是可thenable的</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 這一步很關鍵，只有這樣才可以將值傳遞給下一個resolve</span>        <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//判断是不是promise 对象</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> ret <span class="token punctuation">[</span><span class="token string">'then'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ret<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">function</span> <span class="token function">errback</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>        reason <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">||</span> reason<span class="token punctuation">;</span>        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// 根据当前异步状态执行操作</span>      <span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">'PENDING'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          _this<span class="token punctuation">.</span>_resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>          _this<span class="token punctuation">.</span>_rejects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>errback<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">'FULFILLED'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">handle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">'REJECTED'</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">errback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>_reason<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      config<span class="token punctuation">[</span>_this<span class="token punctuation">.</span>_status<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * 链式写法中可以捕获前面then中发送的异常   */</span>  Promise<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token keyword">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>undefined<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Promise.race   * 接收一个元素为 Promise 对象的数组作为参数   * 返回一个Promise实例   * 只要该数组中的任意一个 Promise 对象的状态发⽣变化(无论是 resolve 还是 reject)该⽅法都会返回   */</span>  Promise<span class="token punctuation">.</span>race <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You must pass an array to all.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 返回 promise 实例</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">{</span>      promiseArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * Promise.all   * 接收一个元素为 Promise 对象的数组作为参数   * 返回一个Promise实例   * 当这个数组里的所有promise对象都变为resolve状态的时候，才会返回   */</span>  Promise<span class="token punctuation">.</span>all <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'You must pass an array to all.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 返回 promise 实例</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">.</span>length<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>      promiseArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">done</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>reject<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 判断 promise 状态是否全部 resolve</span>    <span class="token keyword">function</span> <span class="token function">gen</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">===</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  Promise<span class="token punctuation">.</span>resolve <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  Promise<span class="token punctuation">.</span>reject <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token function">reject</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> Promise<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基本数据类型</title>
      <link href="/2019/05/23/typescript/basedatatype/"/>
      <url>/2019/05/23/typescript/basedatatype/</url>
      
        <content type="html"><![CDATA[<p>每种语言都会有属于自己的数据类型，ts的基本数据类型基本上是继承了js，但也在基础之上增加了几个不一样的类型</p><h3 id="布尔型-true／false"><a href="#布尔型-true／false" class="headerlink" title="布尔型 true／false "></a>布尔型 true／false <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//在js中声明boolean型的方法和ts中的不同之处</span><span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">let</span> flag<span class="token punctuation">:</span> boolean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="float-数值型（在js和ts中数字型都是float）"><a href="#float-数值型（在js和ts中数字型都是float）" class="headerlink" title="float,数值型（在js和ts中数字型都是float）"></a>float,数值型（在js和ts中数字型都是float）<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//在js中声明number型的方法和ts中的不同之处</span><span class="token keyword">let</span> age <span class="token operator">=</span> <span class="token number">26</span><span class="token punctuation">;</span><span class="token keyword">let</span> age<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token number">26</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="字符型-String"><a href="#字符型-String" class="headerlink" title="字符型 String "></a>字符型 String <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//在js中声明number型的方法和ts中的不同之处</span><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'boren'</span><span class="token punctuation">;</span><span class="token keyword">let</span> name<span class="token punctuation">:</span> string <span class="token operator">=</span> <span class="token string">'boren'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="数组-Array"><a href="#数组-Array" class="headerlink" title="数组 Array "></a>数组 Array <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//在js中声明数组的方法和ts中的不同之处</span><span class="token comment" spellcheck="true">//1.js中声明数组的两种方式</span><span class="token keyword">let</span> city <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> city <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//2.ts中声明数组的两种方式</span><span class="token keyword">let</span> city<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> city<span class="token punctuation">:</span>Array<span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">//在ts中声明数组必须提前指定其数据类型，如果其数组中的元素其数据类型不相同，声明的方式会在后面介绍</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="元组-Tuple"><a href="#元组-Tuple" class="headerlink" title="元组 Tuple "></a>元组 Tuple <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//可以定义数组中元素不相同的数据类型</span><span class="token keyword">let</span> people <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'boren'</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//js</span><span class="token keyword">let</span> people<span class="token punctuation">:</span><span class="token punctuation">[</span>string<span class="token punctuation">,</span>number<span class="token punctuation">]</span><span class="token punctuation">;</span>people <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'boren'</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//ts</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="枚举-Enum"><a href="#枚举-Enum" class="headerlink" title="枚举 Enum "></a>枚举 Enum <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//js中没有此方法，都是以object或者json的形式去实现枚举的特性如：</span><span class="token keyword">let</span> school <span class="token operator">=</span> <span class="token punctuation">{</span>     teacherOne <span class="token punctuation">:</span> <span class="token string">'Mars'</span><span class="token punctuation">,</span>     teacherTwo<span class="token punctuation">:</span><span class="token string">'yupeng'</span><span class="token punctuation">,</span>     teacherThree<span class="token punctuation">:</span><span class="token string">'luxuesong'</span><span class="token punctuation">}</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>school<span class="token punctuation">.</span>teacherOne<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//Mars</span><span class="token comment" spellcheck="true">//在ECMA2015，简称es5中Object.getOwnPropertyDescriptor方法可以获取该属性的描述对象</span>Object<span class="token punctuation">.</span>getOwnPropertyDescriptor（school<span class="token punctuation">,</span>‘teacherOne’）<span class="token comment" spellcheck="true">// {</span><span class="token comment" spellcheck="true">// value: Mars,</span><span class="token comment" spellcheck="true">// writable: true,</span><span class="token comment" spellcheck="true">// enumerable: true,</span><span class="token comment" spellcheck="true">// configurable: true</span><span class="token comment" spellcheck="true">// }</span><span class="token comment" spellcheck="true">//其中这么方法打印出来的对象中key enumerable属性，为可枚举性，在js es5中有三个操作会忽略枚举为 false，for...in、 Object...keys()、 JSON.stringify()；在es6中新增一个方法Object.assign()会忽略enumerable为false的属性，只拷贝对象自身的可枚举的属性。关于更多js中对枚举属性的支持，在这里就不一一介绍，例如toString()和length等等其枚举属性为false</span><span class="token comment" spellcheck="true">//ts中枚举类型的用法</span><span class="token keyword">enum</span> classMember <span class="token operator">=</span> <span class="token punctuation">{</span>chenchao<span class="token punctuation">,</span>rongbin<span class="token punctuation">,</span>chenhua<span class="token punctuation">,</span>liurui<span class="token punctuation">,</span>luxuesong<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">let</span> teacher<span class="token punctuation">:</span>classMember <span class="token operator">=</span> classMember<span class="token punctuation">.</span>luxuesong<span class="token comment" spellcheck="true">//我们也可以给枚举中的成员进行编号等等，以便于更方便的去找到相应的对象元素</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="通用数据类型-Any"><a href="#通用数据类型-Any" class="headerlink" title="通用数据类型 Any"></a>通用数据类型 Any<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//这种数据类型个人认为是万能的，它可以在你不知道这个变量为什么数据类型的情况下，并且项目比较急的时候标注为Any，它可以通过编译时的类型检查，有人会说那我所有的类型都写Any，如果你非要这么干，也无妨，那就失去了ts这么语言本身的意义所在，可以用这种方法去解决一个上述声明数组类型时很麻烦的问题</span><span class="token keyword">let</span> lists<span class="token punctuation">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'boren'</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token string">'body'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">let</span> age<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token number">26</span><span class="token punctuation">;</span><span class="token keyword">let</span> name<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token string">'boren'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="空值Void"><a href="#空值Void" class="headerlink" title="空值Void "></a>空值Void <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//在js中我们其实对void不是那么的陌生，它被认为是一个操作符，这个操作符可以计算表达式但不会返回任何值，在js中常常出现的位置就是在a标签的链接中，我们不想让页面刷新，更不想链接到某些位置只是简简单单的a标签，有时候会调用一个简单的函数，仅此而已，那么我们就会</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"javascript:void(0)"</span> onclick<span class="token operator">=</span><span class="token string">"people()"</span><span class="token operator">></span>点我<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span><span class="token comment" spellcheck="true">//在ts中，void类型像是与any类型相反，它表示没有任何类型。</span><span class="token keyword">function</span> <span class="token function">student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">{</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'my name is renbo'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//在上述函数中没有返回任何值，所以类型为void，其实void的变量没什么用处和null,undefined一样职能作为数据的类型的判断。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="永不存在值的类型Never"><a href="#永不存在值的类型Never" class="headerlink" title="永不存在值的类型Never"></a>永不存在值的类型Never<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//官网解释</span>never is the <span class="token keyword">return</span> type <span class="token keyword">for</span> a <span class="token keyword">function</span> expression or an arrow <span class="token keyword">function</span> expression that always throws an exception or one that never returns<span class="token punctuation">;</span>Variables also acquire the type never when narrowed by any type guards that can never be <span class="token boolean">true</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">//never类型是那些总是会抛出异常或根本就不会有返回值的函数表达式或箭头函数表达式的返回值类型； 变量也可能是never类型，当它们被永不为真的类型保护所约束时。</span><span class="token comment" spellcheck="true">//个人觉得没什么太大用这里就不做深究。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="类型断言"><a href="#类型断言" class="headerlink" title="类型断言 "></a>类型断言 <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//在ts中类型断言这种方式还是比较有用处的，其相当于js中的类型转换。但是只在编译的时候起作用。并不会改变其数据的本身结构。</span><span class="token keyword">let</span> city<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token string">"beijing"</span><span class="token punctuation">;</span><span class="token keyword">let</span> strLength<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token punctuation">(</span>city <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//另外一种写法：</span><span class="token keyword">let</span> city<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token string">"beijing"</span><span class="token punctuation">;</span><span class="token keyword">let</span> strLength<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>string<span class="token operator">></span>city<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr>总结：通过以上的介绍相信大家对ts的数据类型已经有了大概的了解，其实相对于js,ts的数据类型并没有做什么变更，只是在声明其数据类型的时候必须明确的指定其相应的数据类型，否则代码编译会报错。虽然 ts的文件是xxx.ts 但由于编译过后和js 没有什么大的不同点，能够很好的运行在浏览器端，其中class、public等等函数及模块编译过后的js能后让你更深入的了解js]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>泛型</title>
      <link href="/2019/05/22/typescript/generics/"/>
      <url>/2019/05/22/typescript/generics/</url>
      
        <content type="html"><![CDATA[<p>泛型（Generics）就是不提前指定接口、变量、函数等的类型，在使用的时候再指定类型</p><h3 id="定义泛型"><a href="#定义泛型" class="headerlink" title="定义泛型 "></a>定义泛型 <br></h3><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 定义类型</span><span class="token keyword">function</span> <span class="token function">identity</span><span class="token punctuation">(</span>arg<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">number</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> arg<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 定义 any 类型</span><span class="token keyword">function</span> <span class="token function">identity</span><span class="token punctuation">(</span>arg<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">any</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> arg<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果所有的接口、变量、函数等都用 any 类型，那么写 TS 和写 JS 一样将失去意义，因为你可能像 JS 一样造成许多未知的错误，那么解决这样的问题我们使用一种特殊的变量T，来表示返回的内容。</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">function</span> identity<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">:</span> T<span class="token punctuation">)</span><span class="token punctuation">:</span> T <span class="token punctuation">{</span>  <span class="token keyword">return</span> arg<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="调用泛型"><a href="#调用泛型" class="headerlink" title="调用泛型"></a>调用泛型<br></h3><pre><code>let output = identity&lt;string&gt;(&quot;myString&quot;);</code></pre><h3 id="泛型约束"><a href="#泛型约束" class="headerlink" title="泛型约束"></a>泛型约束<br></h3><p>在函数内部使用泛型变量的时候，因为不知道它是哪种类型，所以不能随意的操作它的属性或方法</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">function</span> loggingIdentity<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">:</span> T<span class="token punctuation">)</span><span class="token punctuation">:</span> T <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Error: T doesn't have .length</span>  <span class="token keyword">return</span> arg<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>由于上面的泛型 T 中不一定包含属性.length, 所以会抛出异常。</p><p>这时我们可以创建一个具有单个.length属性的接口，然后我们将使用此接口和extends关键字来表示我们的约束：</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">Lengthwise</span> <span class="token punctuation">{</span>    length<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> loggingIdentity<span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">Lengthwise</span><span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">:</span> T<span class="token punctuation">)</span><span class="token punctuation">:</span> T <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> arg<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的例子如果在调用的时候传入的参数不符合定义的约束，那么就会抛出异常</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">Lengthwise</span> <span class="token punctuation">{</span>    length<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> loggingIdentity<span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">Lengthwise</span><span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">:</span> T<span class="token punctuation">)</span><span class="token punctuation">:</span> T <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> arg<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">loggingIdentity</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Argument of type '5' is not assignable to parameter of type 'Lengthwise'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>相反如果定义了正确的类型</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">Lengthwise</span> <span class="token punctuation">{</span>    length<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> loggingIdentity<span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">Lengthwise</span><span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">:</span> T<span class="token punctuation">)</span><span class="token punctuation">:</span> T <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> arg<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">loggingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 2</span><span class="token function">loggingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">{</span>length<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="泛型接口"><a href="#泛型接口" class="headerlink" title="泛型接口"></a>泛型接口<br></h3><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 定义泛型结构</span><span class="token keyword">interface</span> <span class="token class-name">CreatePeopleFunc</span> <span class="token punctuation">{</span>  <span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> T<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">Array</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 创建泛型</span><span class="token keyword">let</span> createPeople<span class="token punctuation">:</span>CreatePeopleFunc<span class="token punctuation">;</span>createPeople <span class="token operator">=</span> <span class="token keyword">function</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> T<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">Array</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> people<span class="token punctuation">:</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> temp<span class="token punctuation">:</span><span class="token keyword">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    name <span class="token punctuation">:</span> name<span class="token punctuation">,</span>    age<span class="token punctuation">:</span> age  <span class="token punctuation">}</span>  people<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>  <span class="token keyword">return</span> people<span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 调用函数</span><span class="token function">createPeople</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面例子我们定义了一个泛型，创建了函数，在函数内创建数组并添加了一个元素 name, age</p><h3 id="泛型类"><a href="#泛型类" class="headerlink" title="泛型类"></a>泛型类<br></h3><p>泛型类具有与通用接口类似的形状。泛型类&lt;&gt;在类名称后面的尖括号（）中有一个泛型类型参数列表</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">GenericNumber</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    zeroValue<span class="token punctuation">:</span> T<span class="token punctuation">;</span>    add<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> T<span class="token punctuation">,</span> y<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> T<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> myGenericNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericNumber</span><span class="token operator">&lt;</span><span class="token keyword">number</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>myGenericNumber<span class="token punctuation">.</span>zeroValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>myGenericNumber<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>接口</title>
      <link href="/2019/05/18/typescript/interfaces/"/>
      <url>/2019/05/18/typescript/interfaces/</url>
      
        <content type="html"><![CDATA[<p>##</p><p>在面向对象语言中接口 (Interfaces) 是对类的行为的抽象，在TypeScript中也常用于定义结构子类型，方便进行类型检查</p><h3 id="定义一个简单的接口"><a href="#定义一个简单的接口" class="headerlink" title="定义一个简单的接口"></a>定义一个简单的接口<br></h3><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">IPeople</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  age<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">}</span><span class="token keyword">let</span> zhangsan<span class="token punctuation">:</span> IPeople <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>  age<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的例子我定义了一个接口 IPeople，并且定义了一个变量 zhangsan，它的类型是 IPerson，zhangsan的数据结构类型必须与 IPeople 一致否则会报错例如下面</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">IPeople</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  age<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">}</span><span class="token keyword">let</span> zhangsan<span class="token punctuation">:</span> IPeople <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>Property <span class="token string">'age'</span> is missing <span class="token keyword">in</span> type <span class="token string">'{ name: string; }'</span> but required <span class="token keyword">in</span> type <span class="token string">'IPeople'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="可选属性"><a href="#可选属性" class="headerlink" title="可选属性 "></a>可选属性 <br></h3><p>当我们定义接口属性的时候不是必须的那么可选属性就起到了作用</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">IPeople</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  age<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">}</span><span class="token keyword">let</span> zhangsan<span class="token punctuation">:</span> IPeople <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="任意属性"><a href="#任意属性" class="headerlink" title="任意属性"></a>任意属性<br></h3><p>当我们需要定义或增加一些未知的属性，那么任意属性就起到了作用</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">IPeople</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  age<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span>  <span class="token punctuation">[</span>propName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> zhangsan<span class="token punctuation">:</span> IPeople <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>  age<span class="token punctuation">:</span> <span class="token number">28</span><span class="token punctuation">,</span>  gender<span class="token punctuation">:</span> <span class="token string">'m'</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上述例子中需要注意的是一旦定义了任意属性，那么可选属性和确定属性的类型必须是它的的类型的子集，否则会报错，例如</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">IPeople</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  age<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span>  <span class="token punctuation">[</span>propName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> zhangsan<span class="token punctuation">:</span> IPeople <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>  age<span class="token punctuation">:</span> <span class="token number">28</span><span class="token punctuation">,</span>  gender<span class="token punctuation">:</span> <span class="token string">'m'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>Type <span class="token string">'{ name: string; age: number; gender: string; }'</span> is not assignable to type <span class="token string">'IPeople'</span><span class="token punctuation">.</span>Property <span class="token string">'age'</span> is incompatible <span class="token keyword">with</span> index signature<span class="token punctuation">.</span>Type <span class="token string">'number'</span> is not assignable to type <span class="token string">'string'</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="只读属性"><a href="#只读属性" class="headerlink" title="只读属性"></a>只读属性<br></h3><p>当我们需要对象中字段只能在创建的时候被赋值，那么只读属性就起到了作用</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">IPerson</span> <span class="token punctuation">{</span>  readonly id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  age<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>  <span class="token punctuation">[</span>propName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> zhangsan<span class="token punctuation">:</span> IPerson <span class="token operator">=</span> <span class="token punctuation">{</span>  id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  name<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>  gender<span class="token punctuation">:</span> <span class="token string">'m'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>zhangsan<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>Cannot assign to <span class="token string">'id'</span> because it is a read<span class="token operator">-</span>only property<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="可以为接口定义函数类型"><a href="#可以为接口定义函数类型" class="headerlink" title="可以为接口定义函数类型"></a>可以为接口定义函数类型<br></h3><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">IPeople</span> <span class="token punctuation">{</span>  <span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> hello<span class="token punctuation">:</span> IPeople<span class="token punctuation">;</span>hello <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> I,m years old </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">}</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//my name is zhangsan I,m years old 28</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面简单的介绍了接口的基本用法，也就是对对象的结构进行性约定，接下来我们来用 Interface 对类的行为进行抽象</p><h3 id="用类实现接口"><a href="#用类实现接口" class="headerlink" title="用类实现接口"></a>用类实现接口<br></h3><p>用类实现接口主要应用的场景就是类与类之间有一些公有的功能及特性，要实现高度抽象这也是面向对象的基本。在 TypeScript 中用关键字 implements 去实现。</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 定义接口，接口中有一个公共的方法eat</span><span class="token keyword">interface</span> <span class="token class-name">People</span><span class="token punctuation">{</span>  <span class="token function">eat</span><span class="token punctuation">(</span>food<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 实现接口的方法</span><span class="token keyword">class</span> <span class="token class-name">Boy</span> <span class="token keyword">implements</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  eat <span class="token punctuation">(</span>food<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> food   <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 实现接口方法</span><span class="token keyword">class</span> <span class="token class-name">Girl</span> <span class="token keyword">implements</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  eat <span class="token punctuation">(</span>food<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">string</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> food  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> boy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>boy<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">let</span> girl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>girl<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一个类也可以实现多个接口</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">Eat</span><span class="token punctuation">{</span>  food <span class="token punctuation">(</span>food<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">interface</span> <span class="token class-name">Drink</span><span class="token punctuation">{</span>  <span class="token function">drink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 实现接口的方法</span><span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token keyword">implements</span> <span class="token class-name">Eat</span><span class="token punctuation">,</span> Drink <span class="token punctuation">{</span>  <span class="token keyword">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  food <span class="token punctuation">(</span>food<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> food   <span class="token punctuation">}</span>  drink <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">string</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`小明跑步中吃</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">food</span><span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">是不健康的`</span></span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">.</span><span class="token function">drink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="接口的继承"><a href="#接口的继承" class="headerlink" title="接口的继承"></a>接口的继承<br></h3><p>在 JS ECMA6 中类的继承用 extends 关键字， 那么在 TS 中我们依然同样用这个关键字</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">Eat</span> <span class="token punctuation">{</span>  eat <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">interface</span> <span class="token class-name">People</span> <span class="token keyword">extends</span> <span class="token class-name">Eat</span> <span class="token punctuation">{</span>  <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  run <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="混合类型"><a href="#混合类型" class="headerlink" title="混合类型"></a>混合类型<br></h3><p>混合类型实际上就是在接口中存在多种规则，利用这种规则去实现自己的属性和方法</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 定义规则</span><span class="token keyword">interface</span> <span class="token class-name">Counter</span> <span class="token punctuation">{</span>  <span class="token punctuation">(</span>start<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  interval<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>  <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 实现规则</span><span class="token keyword">function</span> <span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Counter <span class="token punctuation">{</span>  <span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token operator">&lt;</span>Counter<span class="token operator">></span><span class="token keyword">function</span> <span class="token punctuation">(</span>start<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  counter<span class="token punctuation">.</span>interval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  counter<span class="token punctuation">.</span>reset <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reset'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> counter<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">counter</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 20</span>counter<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// reset </span>counter<span class="token punctuation">.</span>interval <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>类</title>
      <link href="/2019/05/17/typescript/class/"/>
      <url>/2019/05/17/typescript/class/</url>
      
        <content type="html"><![CDATA[<h2 id="TS基础系列之-类"><a href="#TS基础系列之-类" class="headerlink" title="TS基础系列之-类"></a>TS基础系列之-类</h2><p>在JavaScript 通过构造函数和原型链来实现类和继承。而在 ES6 中，也用语法糖实现了class，下面介绍一下在 ts 中的类。</p><h3 id="类的概念"><a href="#类的概念" class="headerlink" title="类的概念 "></a>类的概念 <br><hr></h3><p>类是面向对象程序设计中的概念，是面向对象编程的基础，由于是一种数据类型，而不是数据，所以不存在于内存中。</p><ul><li>类(Class)：定义了一件事物的抽象特点，包含它的属性和方法</li><li>对象（Object）：类的实例，通过 new 生成，类是概念，对象是实体</li><li>面向对象（OOP）的三大特性：封装、继承、多态</li><li>封装（Encapsulation）：将对数据的操作细节隐藏起来，只暴露对外的接口。外界调用端不需要（也不可能）知道细节，就能通过对外提供的接口来访问该对象，同时也保证了外界无法任意更改对象内部的数据</li><li>继承（Inheritance）：子类继承父类，子类除了拥有父类的所有特性外，还有一些更具体的特性</li><li>多态（Polymorphism）：由继承而产生了相关的不同的类，对同一个方法可以有不同的响应。</li><li>存取器（getter &amp; setter）：用以改变属性的读取和赋值行为</li><li>修饰符（Modifiers）：修饰符是一些关键字，用于限定成员或类型的性质。比如 public 表示公有属性或方法</li><li>抽象类（Abstract Class）：抽象类是供其他类继承的基类，抽象类不允许被实例化。抽象类中的抽象方法必须在子类中被实现</li><li>接口（Interfaces）：不同类之间公有的属性或方法，可以抽象成一个接口。接口可以被类实现（implements）。一个类只能继承自另一个类，但是可以实现多个接口</li></ul><h3 id="ES6中类的用法"><a href="#ES6中类的用法" class="headerlink" title="ES6中类的用法 "></a>ES6中类的用法 <br><hr></h3><ol><li><p><strong>定义属性和方法</strong></p><pre class="line-numbers language-ts"><code class="language-ts"> <span class="token comment" spellcheck="true">// 定义类</span> <span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 定义构造函数</span>   <span class="token keyword">constructor</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'wang'</span><span class="token punctuation">,</span>age<span class="token operator">=</span><span class="token string">'27'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 定义属性</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">// 定义方法</span>   <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> eat food`</span></span><span class="token punctuation">)</span>   <span class="token punctuation">}</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>利用关键字extends 和 super 继承</strong></p><pre class="line-numbers language-ts"><code class="language-ts"> <span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span><span class="token punctuation">{</span>      <span class="token keyword">constructor</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'ren'</span><span class="token punctuation">,</span>age <span class="token operator">=</span> <span class="token string">'27'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//继承父类属性</span>       <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>        <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//继承父类方法</span>         <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">let</span> child <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'xiaoxiami'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    child<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>存储器getter,setter改变属性和读取</strong></p><pre class="line-numbers language-ts"><code class="language-ts"> <span class="token keyword">class</span> <span class="token class-name">People</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 定义构造函数</span>   <span class="token keyword">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 定义属性</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token keyword">get</span> name <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token keyword">set</span> name <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setter: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">// 定义方法</span>   <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">  eat food`</span></span><span class="token punctuation">)</span>   <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">let</span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// setter: lisi</span> people<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// setter: zhangsan</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>静态方法使用static修饰符（由于分配在静态内存空间中，所以不需要实例化，只需要吊影即可）</strong></p><pre class="line-numbers language-ts"><code class="language-ts"> <span class="token keyword">class</span> <span class="token class-name">People</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 定义静态方法</span>   <span class="token keyword">static</span> <span class="token function">eat</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> eat food`</span></span><span class="token punctuation">)</span>   <span class="token punctuation">}</span> <span class="token punctuation">}</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>People<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// renbo eat food</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="ES7中类的用法"><a href="#ES7中类的用法" class="headerlink" title="ES7中类的用法 "></a>ES7中类的用法 <br><hr></h3><ol><li><p><strong>定义属性可以直接在类中定义</strong></p><pre class="line-numbers language-ts"><code class="language-ts"> <span class="token keyword">class</span> <span class="token class-name">People</span><span class="token punctuation">{</span>   name <span class="token operator">=</span> <span class="token string">'zhangsan'</span>   <span class="token keyword">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// </span>   <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">let</span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>npeople<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// zhangsan</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>定义静态属性</strong></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">People</span><span class="token punctuation">{</span><span class="token keyword">static</span>  name <span class="token operator">=</span> <span class="token string">'zhangsan'</span> <span class="token keyword">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// </span> <span class="token punctuation">}</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>People<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// zhangsan</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="TypeScript-中类的用法"><a href="#TypeScript-中类的用法" class="headerlink" title="TypeScript 中类的用法 "></a>TypeScript 中类的用法 <br><hr></h3><ol><li><strong>说起 ts 中的类不得不说访问修饰符 public private protected</strong></li></ol><ul><li>public 说明属性或方法是公有的，在任何地方被访问到，在 ts 中方法和属性默认的是 public</li><li>private 说明属性或方法是私有的，不能在类的外部访问</li><li>protected 说明属性或方法是受保护的，和 private 类似，但是 protected 也可以在子类中访问</li></ul><p><strong>public 修饰符</strong></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> name<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>private 修饰符</strong></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">private</span>  name<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Property 'name' is private and only accessible within class 'People'.</span><span class="token comment" spellcheck="true">// 在子类中也不允许访问，只是私有</span><span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">private</span>  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">SmilePeople</span> <span class="token keyword">extends</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">constructor</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Property 'name' is private and only accessible within class 'People'.</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>protected 修饰符</strong></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">protected</span>  name<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Property 'name' is protected and only accessible within class 'People' and its subclasses.ts</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>protected 修饰符(子类访问)</strong></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">protected</span>  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">SmilePeople</span> <span class="token keyword">extends</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">constructor</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> people  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span> <span class="token punctuation">(</span><span class="token string">'zhangsna'</span><span class="token punctuation">)</span><span class="token keyword">let</span> smilePeople <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmilePeople</span><span class="token punctuation">(</span><span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// wangwu</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li><strong>抽象类（ abstract 用于定义抽象类以及抽象类中的抽象方法）</strong></li></ol><ul><li>抽象类可以作为派生其他类的基类</li><li>抽象类中的抽象方法必须被子类实现</li><li>抽象类无法直接实例化</li><li>与接口不同，抽象类可以包含其成员的实现细节</li></ul><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 上述1，2</span>abstract <span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> name<span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">constructor</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> abstract <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 派生类</span><span class="token keyword">class</span> <span class="token class-name">SmilePeople</span> <span class="token keyword">extends</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> food<span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token operator">=</span> <span class="token string">'apple'</span>  <span class="token comment" spellcheck="true">// eat 方法必须在子类中实现</span>  <span class="token keyword">public</span> eat <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">string</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> I,m eating </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>SmilePeople<span class="token punctuation">.</span>food<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> smilePeople <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmilePeople</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>smilePeople<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 无法直接实例化</span>abstract <span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> name<span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">constructor</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> abstract eat <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">}</span><span class="token keyword">let</span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Cannot create an instance of an abstract class.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>函数</title>
      <link href="/2019/05/16/typescript/function/"/>
      <url>/2019/05/16/typescript/function/</url>
      
        <content type="html"><![CDATA[<h3 id="函数的创建"><a href="#函数的创建" class="headerlink" title="函数的创建 "></a>函数的创建 <br></h3><p>在 ts 中函数创建也氛围两种匿名函数和有命名的函数</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 有名字的函数</span><span class="token keyword">function</span> people <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 匿名函数</span><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="函数的参数类型和返回值类型"><a href="#函数的参数类型和返回值类型" class="headerlink" title="函数的参数类型和返回值类型 "></a>函数的参数类型和返回值类型 <br></h3><ul><li>只要参数类型是匹配的，那么就认为它是有效的函数类型，而不在乎参数名是否正</li><li>设定了类型之后必须要返回相对应的类型，否则会报错</li><li>如果函数没有返回任何值，也必须指定返回值类型为 void而不能留空<pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">/*** * @param {*} x number* @param {*} y number*  return add number */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>const add = (x: number, y: number): number =&gt; x + y;<br>// 书写完整的函数类型<br>const add: (x: number, y: number) =&gt; number = (x: number, y: number):number =&gt; x + y </p><pre><code>### 函数的可选参数和默认参数&lt;br/&gt;- 传递给一个函数的参数个数必须与函数期望的参数个数一致，否则会报错- 可选参数用`?argname`表示，必须跟在必须参数后面- 没有传递参数或传递的值是undefined，这种叫做默认初始化值的参数- 所有必须参数**后面**的带默认初始化的参数都是可选的，调用时可省略- 带默认值的参数如果出现在必须参数**前面**，用户必须明确的传入 undefined 值来获得默认值- 当传入的参数个数不固定时，将所有参数收集到一个变量里和 js 中的 arguments 类似，剩余参数会被当做个数不限的可选参数。 可以一个都没有，同样也可以有任意个表达方式为（...）```ts// 上述1const add: (x: number, y: number) =&gt; number = (x: number, y: number):number =&gt; x + y add(1, 2) // 3add(1) // 报错add(1,2,3) // 报错// 上述2const yourName = (firstName: string, lastName?: string): string =&gt; `${firstName}+${lastName} `;console.log(yourName(&#39;ren&#39;, &#39;bo&#39;)) //ren+boconsole.log(yourName(&#39;ren&#39;)) // ren+undefined// 上述3const yourName = (firstName: string, lastName?: string): string =&gt; `${firstName}+${lastName} `;console.log(yourName(&#39;ren&#39;, &#39;bo&#39;)) //ren+boconsole.log(yourName(&#39;ren&#39;, undefined)) // ren+undefined//上述4const yourName = (firstName: string, lastName=&#39;bo&#39;): string =&gt; `${firstName}+${lastName} `;console.log(yourName(&#39;ren&#39;, &#39;bo&#39;)) //ren+boconsole.log(yourName(&#39;ren&#39;)) // ren+bo// 上述5const yourName = ( lastName=&#39;bo&#39;, firstName: string): string =&gt; `${firstName}+${lastName} `;console.log(yourName(&#39;ren&#39;, &#39;bo&#39;)) //bo+renconsole.log(yourName(undefined, &#39;ren&#39;)) // ren+bo// 上述6const people = ( name: string, ...otherProperty: string[]): string =&gt; {  return name + &quot; &quot; + otherProperty.join(&quot; &quot;);}console.log(people(&#39;renbo&#39;, &#39;28&#39;,&#39;170&#39;))  // renbo 28 170 </code></pre><h3 id="函数的重载"><a href="#函数的重载" class="headerlink" title="函数的重载 "></a>函数的重载 <br></h3><p>重载允许一个函数接受不同数量或类型的参数时，作出不同的处理</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 我们来实现一下通过传入不同的 type 来实现函数的加操作和乘法操作并返回相应的类型</span><span class="token keyword">const</span> compute <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span> <span class="token operator">...</span>resetData<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">number</span> <span class="token operator">|</span> <span class="token keyword">string</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> resetData<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">number</span> <span class="token operator">=</span><span class="token operator">></span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>resetData<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">number</span> <span class="token operator">=</span><span class="token operator">></span> a <span class="token operator">*</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 18</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// '360'</span><span class="token comment" spellcheck="true">// 通过上面的实现唯一的缺点就是不能明确通过type返回的相对应的计算的值和类型</span><span class="token keyword">const</span> compute <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span> <span class="token operator">...</span>resetData<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">number</span><span class="token punctuation">;</span><span class="token keyword">const</span> compute <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span> <span class="token operator">...</span>resetData<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">;</span><span class="token keyword">const</span> compute <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span> <span class="token operator">...</span>resetData<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">number</span> <span class="token operator">|</span> <span class="token keyword">string</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> resetData<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">number</span> <span class="token operator">=</span><span class="token operator">></span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>resetData<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">number</span> <span class="token operator">=</span><span class="token operator">></span> a <span class="token operator">*</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 18</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// '360'</span><span class="token comment" spellcheck="true">// 上例中，我们重复定义了多次函数 compute，前几次都是函数定义，最后一次是函数实现。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基础之概述和环境配置</title>
      <link href="/2019/05/15/typescript/envconfig/"/>
      <url>/2019/05/15/typescript/envconfig/</url>
      
        <content type="html"><![CDATA[<h3 id="什么是TypeScript？"><a href="#什么是TypeScript？" class="headerlink" title="什么是TypeScript？"></a>什么是TypeScript？<br></h3><p>  ts是一种的开源的编程语言，是由Microsoft主导研发。从工作机制上讲，它就像javaScript的超集。这个语言添加了可选的静态类型和基于类的面向对象编程。2012年首个版本公布</p><h3 id="TypeScript的特点"><a href="#TypeScript的特点" class="headerlink" title="TypeScript的特点?"></a>TypeScript的特点?</h3><ul><li>JavaScript可以使用TypeScript。所有TypeScript代码也都转换为它的JavaScript等效代码</li><li>TypeScript支持其他JS库</li><li>TypeScript是可移植的。TypeScript可跨浏览器，设备和操作系统的移植</li><li>TypeScript与ECMAScript6规范一致</li></ul><h3 id="为什么要使用TypeScript？"><a href="#为什么要使用TypeScript？" class="headerlink" title="为什么要使用TypeScript？"></a>为什么要使用TypeScript？<br></h3><p>  作为前端开发人员我们都知道，从本质上讲，JavaScript是一种自由语言，也叫弱类型的语言，它的语法规则并不是那么严格。正因为如此，我们就更容易犯错，而且，即使是在运行的时候，我们也不能找到所有的错误。鉴于此，TypeScript作为JavaScript的超集，它的语法更严格，我们在编写代码的时候就能够发现大部分错误。不仅如此，按照TypeScript官方的说法，TypeScript使得我们能够以JavaScript的方式实现自己的构思。TypeScript对面向对象的支持也非常完善，它拥有面向对象编程语言的所有特性。如果你想要获取有关TypeScript的更多信息，可以前往TypeScript的官方网站: <a href="http://www.typescriptlang.org/" target="_blank" rel="noopener">TypeScript - JavaScript that scales.</a></p><h3 id="TypeScript的组成部分"><a href="#TypeScript的组成部分" class="headerlink" title="TypeScript的组成部分?"></a>TypeScript的组成部分?</h3><ul><li>语言层 - 它包括语法，关键字和类型注释</li><li>编译器层 - TypeScript编译器（TSC）将使用TypeScript编写的指令转换为其等效的JavaScript</li><li>语言服务层 - “语言服务”在核心编译管道周围公开了一个额外的层，它是类似编辑器的应用程序。ts编译核心(core.ts,program.ts,scanner.ts,parser.ts,checker,emitter.ts)<br><br><image src="/images/ts-lang.png" width="350"></image></li></ul><h3 id="TypeScript-环境配置（本文不讨论-windows-安装过程和-mac-类似）"><a href="#TypeScript-环境配置（本文不讨论-windows-安装过程和-mac-类似）" class="headerlink" title="TypeScript 环境配置（本文不讨论 windows 安装过程和 mac 类似）"></a>TypeScript 环境配置（本文不讨论 windows 安装过程和 mac 类似）</h3><ul><li>下载并安装 node <a href="https://nodejs.org/en/" target="_blank" rel="noopener">相关 node 官网</a></li><li>查看 node 是否安装成功，在命令行中执行 <code>node -v</code> 如果出现版本号则证明 node 安装成功 </li><li>通过 npm 安装 typescript <code>npm install -g typescript</code> </li><li>创建 filename.ts 文件在文件中书写相应ts代码</li><li>执行 <code>tsc filename.ts</code> 编译过后默认会在当前目录产生js文件,在页面中引入js文件即可</li><li>后续在tsconfig.json 中讨论配置监听属性</li></ul>]]></content>
      
      
      <categories>
          
          <category> TypeScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TypeScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>函数节流与抖动</title>
      <link href="/2019/05/15/javascript/debounce/"/>
      <url>/2019/05/15/javascript/debounce/</url>
      
        <content type="html"><![CDATA[<h3 id="浏览器内核"><a href="#浏览器内核" class="headerlink" title="浏览器内核"></a>浏览器内核</h3><p>说起函数的节流与抖动这个老生长谈的话题，我们就需要了解一下关于浏览器的知识</p><p>浏览器有各种进程，来保证浏览器正常的、流畅的呈现在用户的眼前。例如渲染进程（也就是浏览器的内核）是非常重要的一个进程，其中包含了很多的线程</p><pre><code>GUI渲染线程(负责渲染浏览器界面，解析HTML,CSS,构建DOM树和RenderObject树，布局和绘制等)JS引擎线程(JS内核，负责处理JavaScript脚本程序)事件触发线程(归属于浏览器而不是JS引擎，用来控制事件循环)定时触发器线程(传说中的setTimeout和setInterval所在的线程)异步http请求线程(在XMLHttpRequest在连接后是通过浏览器新型一个线程请求)</code></pre><p>这里我们大概了解一下着几个概念，关于更过的相关知识会在后续的文章中介绍</p><h3 id="请求过程"><a href="#请求过程" class="headerlink" title="请求过程"></a>请求过程</h3><p>我们先来看下面一张来至 W3C 的图</p><p><img src="/images/timestamp-diagram.svg"></p><p>从图中我们看到处理模型大概分为如下几个阶段</p><ul><li>DNS 查询</li><li>TCP 连接</li><li>HTTP 请求即响应</li><li>服务器响应</li><li>客户端渲染</li></ul><p>这篇文章我们不讨论 Resource Timing 阶段，会在后续文章前端性能的时候重新提起</p><h3 id="渲染过程"><a href="#渲染过程" class="headerlink" title="渲染过程"></a>渲染过程</h3><p>通过第五个阶段客户端渲染简单的回忆一下网页的生成过程，大致分为几个步骤</p><ul><li>HTML解析器解析成DOM 树</li><li>CSS解析器解析成CSSOM 树</li><li>结合DOM树和CSSOM树，生成一棵渲染树(Render Tree)</li><li>生成布局（Layout），根据渲染树来布局，以计算每个节点的几何信息</li><li>最后一步是绘制（Paint），使用最终渲染树将像素渲染到在屏幕上</li></ul><img src="/images/render-process.jpg"><p>通过上面的总结我们解析每一个步骤能更加深入的了解浏览器渲染过程</p><h3 id="HTML-解析器解析过程"><a href="#HTML-解析器解析过程" class="headerlink" title="HTML 解析器解析过程"></a>HTML 解析器解析过程</h3><p>HTML 解析器构建 DOM 树，实际上是经过下面几个步骤</p><pre><code>字节 -&gt; 字符 -&gt; 令牌 -&gt; 节点对象 -&gt; 对象模型编码阶段将 HTML 的原始字节数据转换为文件指定编码令牌阶段根据HTML规范来将字符串转换成各种令牌也就是标签节点生成节点对象阶段是根据每个令牌转换定义其属性和规则的对象（节点对象）最后阶段 DOM 树构建完成，整个对象集合就像是一棵树形结构（对象模型）</code></pre><p>下面通过代码和图片来解释上面的步骤</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width,initial-scale<span class="token punctuation">=</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>style.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Hello <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>web performance<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span> students!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/dom-render.jpg"><h3 id="CSS-解析过程"><a href="#CSS-解析过程" class="headerlink" title="CSS 解析过程"></a>CSS 解析过程</h3><p>浏览器获得 CSS 文件的数据后 CSS 解析器根据具体的样式将渲染 CSSDOM 树</p><img src="/images/css-dom-render.jpg"><h3 id="渲染树渲染"><a href="#渲染树渲染" class="headerlink" title="渲染树渲染"></a>渲染树渲染</h3><p>构建 两个树之后渲染树出场，浏览器会先从DOM树的根节点开始遍历，对每个可见节点，找到对应的 CSS 样式规则，进行匹配形成构建完成的渲染树</p><img src="/images/render-tree.jpg"><p>渲染树构建后浏览器根据节点对象的规则进行flow（布局）阶段，布局阶段会从渲染树的根节点开始遍历，然后确定每个节点对象在页面上的确切大小与位置最后生成我们大家知道的浏览器盒模型</p><p>最后当Layout布局事件完成后，浏览器会立即发出Paint Setup与Paint事件，开始将渲染树绘制成像素，最后渲染到在屏幕上</p><p>通过上面大致的流程我们知道了浏览器的渲染过程，我们知道网页在生成的时候，至少会渲染一次执行css之后 load 对应 JS 也会进行重新渲染</p><p>重新渲染就可能会 reflow + repaint</p><h3 id="重绘与回流"><a href="#重绘与回流" class="headerlink" title="重绘与回流"></a>重绘与回流</h3><p>回流(reflow)： 当render tree中的一部分(或全部)因为元素的规模尺寸、布局、隐藏等改变而需要重新构建</p><p>重绘(repaint): 当一个元素的外观发生改变，但没有改变布局,重新把元素外观绘制出来的过程，叫做重绘</p><p>回流必定会发生重绘，重绘不一定会引发回流</p><p>浏览器的reflow + repaint 在我们设置节点样式时频繁出现，对性能是个巨大的消耗，因为回流所需的成本比重绘高的多，改变父节点里的子节点很可能会导致父节点的一系列回流，所以我们经常说尽可能的减少重排次数、重排范围，这样就能呈现给用户更改的感官（关于优化手段会在后续的性能优化文章中介绍）</p><p>根据上面说了这么多，我们来进入文章的主题<strong>防抖和节流</strong>当我们窗口发生改变，浏览器的滚动条执行scroll，输入框校验，搜索请求接口等这些都会使页面频繁重新渲染，加重浏览器的负担，这是我们通过<strong>防抖和节流</strong>的方式减少触发频率，这样就会大大的提高用户体验</p><h3 id="debounce（防抖）"><a href="#debounce（防抖）" class="headerlink" title="debounce（防抖）"></a>debounce（防抖）</h3><p>动作发生一定时间后触发事件，在这段时间内，如果该动作又发生，则重新等待一定时间再触发事件。</p><p>html </p><pre class="line-numbers language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ie<span class="token punctuation">=</span>edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>防抖<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">    <span class="token selector"><span class="token id">#container</span></span><span class="token punctuation">{</span>      <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100%</span><span class="token punctuation">;</span>       <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span>       <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode">#000</span><span class="token punctuation">;</span>       <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">50</span>px<span class="token punctuation">;</span>      <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#fff</span><span class="token punctuation">;</span>      <span class="token property">line-height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span>       <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>     <span class="token punctuation">}</span>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>debounce.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">getContent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>      container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> count<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// container.onmousemove = getContent</span>    container<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span>getContent<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>debounce.js </p><pre class="line-numbers language-js"><code class="language-js">@underscore<span class="token punctuation">.</span>js<span class="token keyword">var</span> debounce <span class="token operator">=</span> <span class="token comment" spellcheck="true">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/**   * @desc 函数防抖   * @param {*} func 回调函数   * @param {*} wait 延迟执行毫秒数   * @param {*} immediate  true 表立即执行，false 表非立即执行   */</span>  <span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 创建一个标记用来存放定时器的返回值</span>    <span class="token keyword">var</span> timeout<span class="token punctuation">,</span>result<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 指定this 作用域</span>      <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// event 对象</span>      <span class="token keyword">var</span> args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 再次执行事件的时候，清除上一个定时器</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果已经执行过，将不再执行</span>        <span class="token keyword">var</span> callNow <span class="token operator">=</span> <span class="token operator">!</span>timeout<span class="token punctuation">;</span>        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>callNow<span class="token punctuation">)</span> result <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">else</span> <span class="token punctuation">{</span>        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// func 这个函数，可能有返回值</span>      <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> debounce<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h3><p>动作执行一段时间后触发事件，在这段时间内，如果动作又发生，则无视该动作，直到事件执行完后，才能重新执行</p><p>关于节流的实现，有两种主流的实现方式，一种是使用时间戳，一种是设置定时器</p><p>使用时间戳</p><p>当触发事件的时候，取出当前的时间戳，之后减去之前的时间戳(最一开始值设为 0 )，如果大于设置的时间周期，执行函数并更新当前时间戳，反之就不执行。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> throttle <span class="token operator">=</span> <span class="token comment" spellcheck="true">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> args<span class="token punctuation">;</span>    <span class="token keyword">var</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> now <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> previous <span class="token operator">></span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>        func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        previous <span class="token operator">=</span> now<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> throttle<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用定时器</p><p>事件触发的时候，设置一个定时器，如果定时器存在，就不执行，等定时器到指定的时间，清空定时器，执行事件</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> timeout<span class="token punctuation">;</span>  <span class="token keyword">var</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>      timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对比两种实现方式</p><ul><li>第一种会立刻执行，第二种会在设定的时间后第一次执行</li><li>第一种停止触发后不会再执行，第二种停止触发后依然会再执行一次</li></ul><p>现在我们要结合上面两种方式实现一个开始触发立刻执行，停止触发的时候还能再执行一次</p><pre class="line-numbers language-js"><code class="language-js">@underscore<span class="token punctuation">.</span>js<span class="token keyword">var</span> throttle <span class="token operator">=</span> <span class="token comment" spellcheck="true">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/**   * throttle 节流   * @param {*} func  回调函数   * @param {*} wait  执行时间间隔   * @param {*} options  如果想忽略开始函数的的调用，传入{leading: false}   *                     如果想忽略结尾函数的调用，传入{trailing: false}   *                     两者不能共存，否则函数不能执行   */</span>  <span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> timeout<span class="token punctuation">,</span> context<span class="token punctuation">,</span> args<span class="token punctuation">;</span>    <span class="token keyword">var</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> later <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 如果设置了 leading，就将 previous 设为 0</span>      previous <span class="token operator">=</span> options<span class="token punctuation">.</span>leading <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 置空一是为了防止内存泄漏，二是为了下面的定时器判断</span>      timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> context <span class="token operator">=</span> args <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> throttled <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previous <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>leading <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> previous <span class="token operator">=</span> now<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 计算剩余时间</span>      <span class="token keyword">var</span> remaining <span class="token operator">=</span> wait <span class="token operator">-</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> previous<span class="token punctuation">)</span><span class="token punctuation">;</span>      context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>      args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> remaining <span class="token operator">></span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果存在定时器就清理掉否则会调用二次回调</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>          timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        previous <span class="token operator">=</span> now<span class="token punctuation">;</span>        func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> context <span class="token operator">=</span> args <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>trailing <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 判断是否设置了定时器和 trailing，没有就开启一个定时器</span>        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>later<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> throttled<span class="token punctuation">;</span><span class="token punctuation">}</span>  <span class="token keyword">return</span> throttle<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用例子</p><pre class="line-numbers language-js"><code class="language-js">ontainer<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span>getContent<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>container<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span>getContent<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  leading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>container<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span>getContent<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  trailing<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>上面的就是函数的节流与抖动的全部，我们在面试和工作中会经常的遇到。这也是性能优化的一种方案。当然还有很多版本比如多 promise 版本的就不再这里叙述了，有兴趣的可以找找技术论坛</p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>json 对象</title>
      <link href="/2019/05/11/javascript/json/"/>
      <url>/2019/05/11/javascript/json/</url>
      
        <content type="html"><![CDATA[<h2 id="JSON-stringify"><a href="#JSON-stringify" class="headerlink" title="JSON.stringify"></a>JSON.stringify</h2><ul><li>将值转换为相应的JSON格式</li><li>布尔值、数字、字符串在序列化过程中会自动转换成对应的原始值 (字符串需要单独处理)</li><li>NaN和Infinity格式的数值及null都会被当做null</li><li>不可枚举的属性会被忽略</li><li>undefined、任意的函数以及 symbol 值，在序列化过程中会被忽略（出现在非数组对象的属性值中时）或者被转换成 null（出现在数组中时）</li><li>函数、undefine,Sysmbol被单独转换时，会返回undefined</li><li>对包含循环引用的对象（对象之间相互引用，形成无限循环）执行此方法，会抛出错误</li></ul><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><pre class="line-numbers language-js"><code class="language-js">JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token punctuation">,</span> replacer <span class="token punctuation">[</span><span class="token punctuation">,</span> space<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>通过上述说明处理不同情况下的数据情况，此实现不包括第二个和第三个参数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">jsonStringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> dataType <span class="token operator">=</span> <span class="token keyword">typeof</span> data  <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType <span class="token operator">!==</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> isString <span class="token operator">=</span> dataType <span class="token operator">===</span> <span class="token string">'string'</span>    <span class="token keyword">let</span> isNull <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span> data <span class="token operator">===</span> <span class="token number">Infinity</span>    <span class="token keyword">let</span> isUndefined <span class="token operator">=</span> dataType <span class="token operator">===</span> <span class="token string">"undefined"</span> <span class="token operator">||</span> dataType <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">||</span> dataType <span class="token operator">===</span> <span class="token string">"symbol"</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isNull<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"null"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isUndefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> undefined    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isString<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">'"'</span> <span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">'"'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType <span class="token operator">===</span> <span class="token string">"object"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token string">"null"</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>toJSON <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> data<span class="token punctuation">.</span>toJSON <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">jsonStringify</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> isNull <span class="token operator">=</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">"undefined"</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">"symbol"</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isNull<span class="token punctuation">)</span> <span class="token punctuation">{</span>          result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"null"</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">jsonStringify</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      result <span class="token operator">=</span> <span class="token string">"["</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">"]"</span>      <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token string">'/g, '</span>"'<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> dataType <span class="token operator">=</span> <span class="token keyword">typeof</span> data<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"undefined"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> data<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> data<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"symbol"</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item <span class="token operator">!==</span> <span class="token string">"symbol"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType<span class="token punctuation">)</span> <span class="token punctuation">{</span>            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'"'</span> <span class="token operator">+</span> item <span class="token operator">+</span> <span class="token string">'"'</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token function">jsonStringify</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">"{"</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">"}"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token string">'/g, '</span>"'<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="JSON-pase"><a href="#JSON-pase" class="headerlink" title="JSON.pase"></a>JSON.pase</h2><p>解析 JSON 字符串</p><h3 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h3><pre class="line-numbers language-js"><code class="language-js">JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>text<span class="token punctuation">[</span><span class="token punctuation">,</span> reviver<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="evel-版本实现"><a href="#evel-版本实现" class="headerlink" title="evel 版本实现"></a>evel 版本实现</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> jsonPase <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">evel</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>直接调用存在 xss 漏洞，数据中可能不是json 数据，所以需要对数据进行校验</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> rx_one <span class="token operator">=</span> <span class="token regex">/^[\],:{}\s]*$/</span><span class="token punctuation">;</span><span class="token keyword">var</span> rx_two <span class="token operator">=</span> <span class="token regex">/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g</span><span class="token punctuation">;</span><span class="token keyword">var</span> rx_three <span class="token operator">=</span> <span class="token regex">/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g</span><span class="token punctuation">;</span><span class="token keyword">var</span> rx_four <span class="token operator">=</span> <span class="token regex">/(?:^|:|,)(?:\s*\[)+/g</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>    rx_one<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>        json            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rx_two<span class="token punctuation">,</span> <span class="token string">"@"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rx_three<span class="token punctuation">,</span> <span class="token string">"]"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rx_four<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"("</span> <span class="token operator">+</span>json <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Function-版本实现"><a href="#Function-版本实现" class="headerlink" title="Function 版本实现"></a>Function 版本实现</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> jsonStr <span class="token operator">=</span> <span class="token string">'{ "age": 20, "name": "renbo" }'</span><span class="token keyword">var</span> json <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'return '</span> <span class="token operator">+</span> jsonStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>new 运算符</title>
      <link href="/2019/04/27/javascript/new/"/>
      <url>/2019/04/27/javascript/new/</url>
      
        <content type="html"><![CDATA[<p>实现 new 运算符也算是 JS 中经典的面试题了。在实际应用中其实 new 运算符的应用场景是定义对象类型的实例</p><h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 定义构造函数 * @param {*} name  * @param {*} age  */</span><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I'm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> years old`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>study <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I'm learning to swim`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 调用内置函数</span><span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="模拟实现"><a href="#模拟实现" class="headerlink" title="模拟实现"></a>模拟实现</h3><p>用构造函数实际上会经历以下4个步骤（实现思路）</p><ul><li>创建一个新对象</li><li>将构造函数的作用域赋给新对象（因此this就指向了这个对象）</li><li>执行构造函数中的代码（为这个新对象添加属性）</li><li>返回新对象</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> newFun <span class="token punctuation">(</span>constructor<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 将 o 的原型指向构造函数，这样 o 就可以访问到构造函数原型中的属性</span>  o<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 改变构造函数 this 的指向到新建的对象，这样 o 就可以访问到构造函数中的属性</span>  <span class="token keyword">var</span> ret <span class="token operator">=</span> constructor<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 需要判断返回的值是否是对象，如果不是对象返回正常数据类型</span>  <span class="token keyword">return</span> <span class="token keyword">typeof</span> ret <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> ret <span class="token punctuation">:</span> o<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 再次使用上面的例子</span><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I'm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> years old`</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>study <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I'm learning to swim`</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> person <span class="token operator">=</span>  <span class="token function">newFun</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// my name is renbo, I'm 28 years old</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// my name is renbo, I'm learning to swim</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>call 和 apply</title>
      <link href="/2019/04/22/javascript/call/"/>
      <url>/2019/04/22/javascript/call/</url>
      
        <content type="html"><![CDATA[<p>谈起 call 和 apply 这两个 Function.prototype 上的方法可能很熟悉了，它在继承，改变this指针上有很多的应用场景。接下来我们简单的来重新回忆一下 call 和 apply 这两个函数的功能 <br></p><h3 id="例子一"><a href="#例子一" class="headerlink" title="例子一"></a>例子一</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value <span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token keyword">function</span> fun <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="例子二"><a href="#例子二" class="headerlink" title="例子二"></a>例子二</h3><pre class="line-numbers language-js"><code class="language-js">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span> <span class="token string">'element'</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">let</span> func <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       console<span class="token punctuation">.</span>log <span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 指向element元素</span>  <span class="token punctuation">}</span>   func<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="例子三"><a href="#例子三" class="headerlink" title="例子三"></a>例子三</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> FunA <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> FunB <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  FunA<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>FunB<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getValue <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token keyword">let</span> funb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FunB</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>funb<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>经过上面的例子我们可以直观的知道call apply 的作用大部分都是用作改变this的指针。那么接下来我们来模拟 call apply 实现简单的一下这两个函数<br></p><h3 id="模拟实现第一步"><a href="#模拟实现第一步" class="headerlink" title="模拟实现第一步"></a>模拟实现第一步</h3><p>实现思路<br><br>1、将函数设为对象的属性用来改变 this 指向<br><br>2、调用对应函数<br><br>3、删除对象的函数<br></p><p>接下来我们改造一下例子一的函数<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>  fun<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>value  <span class="token punctuation">}</span><span class="token punctuation">}</span>obj<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 20</span><span class="token keyword">delete</span> obj<span class="token punctuation">.</span>funconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {value: 20}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来简单的把上面的函数封装一下<br></p><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newCall <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  context<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  context<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">delete</span> context<span class="token punctuation">.</span>fn<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 通过例子一测试</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value <span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token keyword">function</span> fun <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>fun<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="模拟实现第二步"><a href="#模拟实现第二步" class="headerlink" title="模拟实现第二步"></a>模拟实现第二步</h3><p>第一步的我们只实现了基础。没有考虑参数的情况。call，apply 的基本区别就是在参数上 call 参数数量不确定，apply 只接受两个参数。接下来我们继续优化上面的例子</p><p>1、将函数设为对象的属性用来改变 this 指向<br><br>2、调用对应函数<br><br>3、删除对象的函数<br><br>4、取出不定长的参数放到执行的函数里面<br></p><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newCall <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 如果传入参数 this 为 null，则默认为当前宿主环境</span>  <span class="token keyword">let</span> ec <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> window <span class="token punctuation">:</span> global<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 防止方法冲突覆盖</span>  <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  context <span class="token operator">=</span> context <span class="token operator">||</span> ec<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 改变 this</span>  context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 将参数放入函数内</span>  <span class="token keyword">let</span> result <span class="token operator">=</span> context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 删除对象中的函数</span>  <span class="token keyword">delete</span> context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 测试一下</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>bar<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过以上 call 的实现我们对apply的实现应该说也清楚了， 上述说过call 和 apply 的区别就在与参数上面，通过ES6实现的方法实际上 call, apply 一样<br></p><h3 id="模拟实现-apply"><a href="#模拟实现-apply" class="headerlink" title="模拟实现 apply"></a>模拟实现 apply</h3><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newApply <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 如果传入参数 this 为 null，则默认为当前宿主环境</span>  <span class="token keyword">let</span> ec <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> window <span class="token punctuation">:</span> global<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 防止方法冲突覆盖</span>  <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  context <span class="token operator">=</span> context <span class="token operator">||</span> ec<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 改变 this</span>  context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 将参数放入函数内</span>  <span class="token keyword">let</span> result <span class="token operator">=</span> context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 删除对象中的函数</span>  <span class="token keyword">delete</span> context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 测试一下</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>bar<span class="token punctuation">.</span><span class="token function">newApply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bind 函数</title>
      <link href="/2019/04/21/javascript/bind/"/>
      <url>/2019/04/21/javascript/bind/</url>
      
        <content type="html"><![CDATA[<p>bind 方法其实和 call apply 功能上差不多，只不过 bind() 方法会绑定一个新的函数，通过这个新的函数我们可以当作构造函数、偏函数等等去使用</p><h3 id="作为绑定函数使用"><a href="#作为绑定函数使用" class="headerlink" title="作为绑定函数使用"></a>作为绑定函数使用</h3><p>demo1</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span>  getValue<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 直接调用 this 指向 obj</span>obj<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 29</span><span class="token comment" spellcheck="true">// obj.getValue 是一个函数体，在全局作用域中调用，所以 this 指向 window</span><span class="token keyword">let</span> valFun <span class="token operator">=</span> obj<span class="token punctuation">.</span>getValue<span class="token punctuation">;</span><span class="token function">valFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 20</span><span class="token comment" spellcheck="true">// 使用 bind 将当前的 this 指针指向 obj 对象上</span><span class="token keyword">let</span> boundGetValue <span class="token operator">=</span> valFun<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">boundGetValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 29</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>demo2</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * obj.getValue() 返回的是一个匿名函数 * obj.getValue()() 立即执行函数 * 匿名函数上下文执行环境具有全局性，所以 this 通常指向 window */</span><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span>  getValue<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>obj<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 20</span><span class="token comment" spellcheck="true">// 利用bind我们可以使匿名函数的 this 指针指向当前对象（当然还有很多方法比如在匿名函数内增加变量 _this = this）</span><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span>  getValue<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>obj<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 29</span><span class="token comment" spellcheck="true">// 当然要是改变上述 this 指针不只用 bind 可以如下方法(还有很多方法 比如 apply call)</span><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span>  getValue<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> _this<span class="token punctuation">.</span>value    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>obj<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 29</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="作为偏函数使用"><a href="#作为偏函数使用" class="headerlink" title="作为偏函数使用"></a>作为偏函数使用</h3><p>使一个函数拥有预设的初始参数，这就是偏函数。比如函数A已经拥有参数或者变量，此时我们通过调用函数A，产生函数B，我们就说B为偏函数</p><p>在这里我们不展开说明偏函数，柯里化一些函数式编程的概念，在 <strong>JS 高级系列</strong> 函数式编程中会有详细介绍</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 插入到目标函数的参数列表的开始位置 * 传递给绑定函数的参数会跟在它们后面 */</span><span class="token keyword">function</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 偏函数</span><span class="token keyword">let</span> listArr <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">listArr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [28]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">listArr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [28, 1, 2, 3]</span><span class="token comment" spellcheck="true">/** * 多次 bind 无效 只能执行一次 * bind 内部 使用call apply 实现 */</span><span class="token keyword">function</span> bar <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token keyword">let</span> foo1 <span class="token operator">=</span> <span class="token punctuation">{</span>  value<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token keyword">let</span> func <span class="token operator">=</span> bar<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>foo1<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="模拟第一步"><a href="#模拟第一步" class="headerlink" title="模拟第一步"></a>模拟第一步</h3><p>通过上面的应用我们实现 bind 有几个条件</p><ul><li>bind 会返回一个新的函数</li><li>可以传递任意参数</li><li>绑定 bind 的函数可以有返回值</li></ul><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newBind <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 获取 bind 的参数，如上面偏函数的例子</span>  <span class="token keyword">var</span> _args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 返回新函数</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// bind 返回函数传入的参数</span>    <span class="token keyword">var</span> _bindArgs <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 合并参数返回</span>    <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> _args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>_bindArgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="模拟第二步"><a href="#模拟第二步" class="headerlink" title="模拟第二步"></a>模拟第二步</h3><p>通过第一步其实我们已经模拟了 bind 的大部分功能，但是在 JS 中也可以把函数当成构造函数来用 可以使用 new 关键字， 这个时候 bind 绑定的函数的 this 就会失效，因为在构造函数中 this 永远指向的是它的实例，关于 new 会在下篇文章中作出解释<br></p><ul><li>通过修改返回的函数的原型，来改变 this 指向问题</li><li>调用 bind 一定是函数，否则提示错误</li></ul><pre class="line-numbers language-js"><code class="language-js">Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>newBind  <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 提示错误信息</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Function.prototype.bind - what is trying to be bound is not callable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 获取参数</span>  <span class="token keyword">var</span> _args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 利用空函数来防止修改绑定函数的原型，关于 prototype 请查看 prototype 章节</span>  <span class="token keyword">var</span> _fNOP <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// bind 返回的新函数</span>  <span class="token keyword">var</span> _fBound <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> _bindArgs <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 如果返回的 _fBound 被当做 new 的构造函数调用</span>    <span class="token keyword">return</span> _this<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">_fBound</span> <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token punctuation">:</span> context<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>_bindArgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 让 _fBound 构造的实例继承绑定函数原型中的值，否则会修改绑定函数的原型的值</span>  _fNOP<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>  _fBound<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_fNOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> _fBound<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Error 异常模块</title>
      <link href="/2019/04/14/node/error/"/>
      <url>/2019/04/14/node/error/</url>
      
        <content type="html"><![CDATA[<p>错误处理是所有应用程序的重要组成部分。要抛出异常，请使用 JavaScript 的 throw  关键字。在 JavaScript 中，通常使用 Error 对象和消息来表示错误<br></p><p><strong>捕获异常try/catch</strong><br></p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">function</span> fun <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>finally关键字</strong><br></p><p>catch部分只有在抛出错误时才执行。finally部分仍然执行，尽管在try部分中抛出了任何错误<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">try</span> <span class="token punctuation">{</span>   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"throw error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"不论抛出什么错误，我依然会执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>process进程</title>
      <link href="/2019/04/12/node/process/"/>
      <url>/2019/04/12/node/process/</url>
      
        <content type="html"><![CDATA[<p>process 对象是一个全局变量，它提供有关当前 Node.js 进程的信息并对其进行控制。 作为一个全局变量，它始终可供 Node.js 应用程序使用，无需使用 require()<br></p><p>上文中提到过事件队列调度可以通过process的.nextTick()来实现<br></p><p>上述文章中说到过 Node 是单进程单线程架构，对多核使用不足，所以启动多进程。每个进程一个 CPU 以此实现多核 CPU 的利用<br></p><p><strong>Master-Worker模式（主从模式）</strong></p><p>主从模式主要用于在分布式架构中并行处理业务的模式，具备良好的可伸缩性和稳定性，主进程（master）负责和管理工作进程（worker），工作进程（worker）负责具体的业务逻辑<br></p><p><img src="/images/master-worker.png"><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 创建工作进程 * worker.js */</span><span class="token comment" spellcheck="true">// 引入核心模块http</span><span class="token keyword">let</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 创建服务</span><span class="token keyword">let</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span> <span class="token punctuation">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Hello World !'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 指定域名</span><span class="token keyword">let</span> domain <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 随机创建端口</span><span class="token keyword">let</span> port <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 监听启动服务</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> domain<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 创建主进程 * master.js */</span><span class="token comment" spellcheck="true">// 引入核心模块child_process 创建子进程</span><span class="token keyword">let</span> childProcess <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>引入核心模块os，得到cpu数量<span class="token keyword">let</span> cpus <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 根据cpu数量取复制对应的 node 的进程数量</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpus<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  childProcess<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>进程间通信</strong><br></p><p>说起进程通信，其实我们都熟悉浏览器的 Javascript 主线程与 UI 渲染，共用一个线程。两个是互斥关系，当 UI 渲染时Js引擎线程暂时挂起。所以为了解决这个问题 HTML5 提出WebWork API 主线程与工作线程之间通过onmessage()和postMessage()进行通讯，使 JS 阻塞较为严重的计算不影响主线程上的UI渲染<br></p><p>在 node 中为了实现父子进程通讯，父子之间将会创建IPC通道，通过IPC通道，父子进程才能通过message和send()传递函数<br></p><p>IPC原理创建实现示意图<br></p><p><img src="/images/ipc.png"><br></p><p>IPC通道创建、连接<br></p><p>1、父进程在实际创建子进程之前，首先创建IPC通道并监听，然后在创建子进程<br><br>2、通过环境变量（NODE_CHAMMEL_FD）通知子进程 IPC 通道的文件描述符<br><br>3、子进程启动过程中通过文件描述符连接已经存在的 IPC 通道<br><br>4、建立连接后就可以在内核中完成双向通信，不经过网络层<br><br>5、在 Node 中，IPC 被抽象成为 Stream 对象，调用 send（）发送数据，通过 message 事件接收数据<br></p><p><img src="/images/ipc-create.png"><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 创建父线程 * master.js */</span><span class="token comment" spellcheck="true">// 引入核心模块child_process 创建子进程</span><span class="token keyword">let</span> childProcess <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 复制进程</span><span class="token keyword">let</span> n <span class="token operator">=</span> childProcess<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 监听message</span>n<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'messge'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 发送数据</span>n<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>hello<span class="token punctuation">:</span> <span class="token string">''</span>world<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 创建子线程 * worker.js */</span><span class="token comment" spellcheck="true">// 监听message</span>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 发送数据</span>process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>句柄传递</strong><br></p><p>通过上述我们简单的了解到进程之间通信原理，但是我们想要通过监听一个端口，主进程将所有的请求交由子进程处理，上述通信远远不够的，所以可以通过 <strong>Node句柄传递</strong> 来实现<br></p><p>主进程将请求发送给工作进程<br></p><p><img src="/images/process-send.png"><br></p><p>主进程发送完句柄并关闭监听<br></p><p><img src="/images/process-on.png"><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 创建主进程 * master.js */</span><span class="token comment" spellcheck="true">// 引入核心模块child_process 创建子进程</span><span class="token keyword">let</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 复制进程</span><span class="token keyword">let</span> child1 <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> child2 <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 打开服务使用得服务对象发送数据</span><span class="token keyword">let</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">1337</span> <span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  child1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>  child2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 主进程发送完成句柄关闭监听</span>  server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * 创建子进程 * worker.js */</span><span class="token comment" spellcheck="true">// 引入核心模块http</span><span class="token keyword">let</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 创建服务</span><span class="token keyword">let</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span> <span class="token punctuation">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'pid is'</span> <span class="token operator">+</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 子进程监听端口</span>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>m<span class="token punctuation">,</span> tcp<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">===</span> <span class="token string">'server'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    tcp<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>      server<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上述几个例子我们基本基本了解 Node 的进程。当然还有很多需要在事件中摸索例如集群的稳定，包括自动重启，负载均衡，状态共享等等。当然创建 Node 集群也可以用cluster模块，实现起来更轻松方便<br></p><h2 id="更多方法参考"><a href="#更多方法参考" class="headerlink" title="更多方法参考"></a>更多方法参考<br></h2><p><a href="http://nodejs.cn/api/process.html" target="_blank" rel="noopener">Node Api process</a><br><br><a href="http://nodejs.cn/api/child_process.html" target="_blank" rel="noopener">Node Api child_process</a><br><br><a href="http://nodejs.cn/api/cluster.html" target="_blank" rel="noopener">Node Api cluster</a><br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>event 事件驱动模型</title>
      <link href="/2019/04/10/node/event/"/>
      <url>/2019/04/10/node/event/</url>
      
        <content type="html"><![CDATA[<p>说起node的事件驱动模型首先我们来搞清楚几个概念CPU，线程、进程、调度、事件驱动<br></p><p><strong>CPU</strong><br></p><p>1、CPU 是中央处理器，是计算机的核心<br><br>2、CPU 通过和寄存器，高速缓存，以及内存交互来执行程序<br><br>3、32位 CPU 最多寻址4g内存，而64位 CPU 目前来说没有上限<br></p><p><strong>进程（Process）</strong><br></p><p>1、进程是资源分配最小单位，对于操作系统而言打开一个浏览器就是启动一个浏览器进程，打开 QQ 就是一个 QQ 进程<br><br>2、操作系统为进程开辟一段内存空间，每个进程占用一个进程表项，包含了进程状态的重要信息，包括程序计数器、堆栈指针、内存分配状况、所打开文件的状态、帐号和调度信息等，cpu根据这些信息配合寄存器进行函数调用和程序执行<br></p><p>3、 CPU利用率=1－pⁿ<br></p><ul><li>一个进程等待I/O操作的时间与其停留在内存中的时间比为p<br></li><li>内存中同时有n个进程<br></li></ul><p><strong>线程（Thread）</strong><br></p><p>线程是程序执行的最小单位，比如打开一个 QQ 进程在里面可以打字，发表情同时和很多人聊天。同时运行多个子任务，这样的子任务就可以成为线程，每一个进程中至少有一个线程。<br></p><p><strong>调度</strong><br></p><p>1、 <em>调度程序（scheduler）</em>-多进程同时竞争CPU时，超过两个的进程处于就绪态，那么单CPU必须选择下一个要运行的进程，完成选择工作的程序称为调度程序（另称CPU调度器）<br><br>2、 <em>CPU分配器（Dispatcher</em>- 决定了将CPU分配给谁，然后分配器将CPU控制权交给该进程<br><br>3、 <em>进程行为</em> - 一般分为I/O和计算（CPU），根据占用时间不同，分为I/O密集型（I/O burst）进程和CPU密集型（CPU burst）进程<br><br>4、 当然调度是一个复杂的操作会有调度算法具体请参考<a href="https://yq.aliyun.com/articles/278727" target="_blank" rel="noopener">阿里云社区博客</a></p><p><strong>计算密集型和IO密集型</strong><br></p><p>1、计算密集型任务的特点是要进行大量的计算，消耗CPU资源，计算密集型任务同时进行的数量应当等于CPU的核心数<br></p><p>2、IO密集型特点是CPU消耗很少，任务的大部分时间都在等待IO操作完成（因为IO的速度远远低于CPU和内存的速度）。对于IO密集型任务，任务越多，CPU效率越高，但也有一个限度。常见的大部分任务都是IO密集型任务，比如Web应用<br></p><p><strong>多进程-多线程</strong><br></p><p>1、多进程模式最大的优点就是稳定性高，因为子进程崩溃，不会影响主进程和其他子进程。著名的Apache最早就是采用多进程模式，多进程模式的缺点是创建进程的代价大<br></p><p>2、多线程模式致命的缺点就是任何一个线程挂掉都可能直接造成整个进程崩溃，因为所有线程共享进程的内存，但创建线程相对于进程开销较小，，所以运行速度较比多进程快，并且线程之间可以共享数据。可以有效解决多进程内存浪费问题。但由于每个线程都拥有自己独立的堆栈，需要占用一定的内存空间，而且操作系统内核在切换线程时也要切换线程上下文。所以在大并发量时，多线程结构无法做到强大的伸缩性<br></p><p><strong>异步I/O</strong><br></p><p>1、一个任务在执行的过程中大部分时间都在等待 I/O 操作，单进程单线程模型会导致别的任务无法并行执行<br><br>2、充分利用操作系统提供的异步 I/O 支持，就可以用单进程单线程模型来执行多任务，这种模型称为事件驱动模型<br><br>3、在单核CPU上采用单进程模型可以高效地支持多任务。在多核CPU上，可以运行多个进程（数量与CPU核心数相同），充分利用多核CPU。由于系统总的进程数量十分有限，因此操作系统调度非常高效<br></p><p><strong>事件驱动模型</strong><br></p><p>1、事件驱动模型是为了解决高并发（如Node，Nginx)<br><br>2、操作系统在调度时较少的切换上下文，没有线程同步等问题<br><br>3、所有处理都在单线程上进行，所以影响性能的点都在 CPU 的计算能力上，由于不受多进程或多线程模式中资源上线的影响，可伸缩性较强<br></p><p><strong>Node事件驱动模型</strong></p><p>1、每一个 I/O 工作被添加到事件队列中，线程循环地处理队列上的工作任务，当执行过程中遇到来堵塞(读取文件、查询数据库)时，线程不会停下来等待结果，而是留下一个处理结果的回调函数，转而继续执行队列中的下一个任务。这个传递到队列中的回调函数在堵塞任务运行结束后才被线程调用<br></p><p><img src="/images/event.png"><br></p><p>2、Node 在启动进程中会创建一个循环，每次循环运行就是一个Tick周期，每个Tick周期中会从事件队列查看是否有事件需要处理，直到事件队列全部执行完毕，node应用就会终<br><br>3、Node 对于堵塞 I/O 使用线程池来在操作，通过取其中一个子线程线程来执行复杂任务，而不占用主循环线程。当堵塞任务执行完毕通过添加到事件队列中的回调函数来处理接下来的工作，这样就防止堵塞 I/O 占用空闲资源，这就是所谓的非阻塞式 I/O<br></p><p><img src="/images/event-loop.png"><br></p><p><strong>事件队列调度（通过回调函数将任务添加事件队列中）</strong><br><br>1、内置的事件和事件监听器（http、server的一些事件）<br><br>2、异步堵塞 I/O 库(db处理、fs处理等)<br><br>3、定时器setTimeout、setInterval<br><br>4、全局对象process的.nextTick()API<br><br>5、自定义的事件和监听器<br></p><p><strong>内置事件(举例)</strong><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入 events 模块</span><span class="token keyword">let</span> events <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 创建事件对象</span><span class="token keyword">let</span> eventEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">events<span class="token punctuation">.</span>EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 创建事件处理程序</span><span class="token keyword">let</span> connectHandler <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 开始触发事件 </span>   eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 绑定事件处理程序</span>eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> connectHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 触发事件处理程序</span>eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"程序执行完毕。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上是Node 事件驱动模型的基本概念。在下篇进程文章中会介绍在 Node 中怎样创建多进程架构，也会在<strong>node高级系列-v8与异步I/O</strong>中详细介绍 Node的异步 I/O <br></p><h2 id="更多方法参考"><a href="#更多方法参考" class="headerlink" title="更多方法参考"></a>更多方法参考<br></h2><p><a href="http://nodejs.cn/api/events.html" target="_blank" rel="noopener">Node Api events 事件模块 </a></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>原生拖拽</title>
      <link href="/2019/04/09/javascript/drag/"/>
      <url>/2019/04/09/javascript/drag/</url>
      
        <content type="html"><![CDATA[<p>在实际开发中我们经常会遇到关于元素拖拽的场景，那么在我们今天实现一个简单的拖拽元素功能</p><h3 id="css"><a href="#css" class="headerlink" title="css "></a>css <hr></h3><pre class="line-numbers language-css"><code class="language-css">  <span class="token selector">* </span><span class="token punctuation">{</span>      <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token selector"><span class="token class">.demo-box</span> </span><span class="token punctuation">{</span>      <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>      <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>      <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>      <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode">#ccc</span><span class="token punctuation">;</span>      <span class="token property">border</span><span class="token punctuation">:</span> solid <span class="token number">1</span>px <span class="token hexcode">#ccc</span><span class="token punctuation">;</span>      <span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">5</span>px<span class="token punctuation">;</span>      <span class="token property">line-height</span><span class="token punctuation">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>      <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="html"><a href="#html" class="headerlink" title="html"></a>html<hr></h3><pre class="line-numbers language-html"><code class="language-html">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>demo<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>demo-box<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>按住左键拖动<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="js"><a href="#js" class="headerlink" title="js "></a>js <hr></h3><pre class="line-numbers language-js"><code class="language-js">  window<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//用于确定是否是拖拽的对象</span>    <span class="token keyword">var</span> drag<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//鼠标位于目标元素上的时候距离目标元素的位置</span>    <span class="token keyword">var</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//取得元素</span>    <span class="token keyword">var</span> ele <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     *鼠标按事件     *@param  evt 事件形参     */</span>    ele<span class="token punctuation">.</span>onmousedown <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//取得事件对象</span>      _event <span class="token operator">=</span> evt <span class="token operator">||</span> window<span class="token punctuation">.</span>event<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//设置drag元素,计算当前位置</span>      _target <span class="token operator">=</span> _event<span class="token punctuation">.</span>target <span class="token operator">||</span> _event<span class="token punctuation">.</span>srcElement<span class="token punctuation">;</span>      x <span class="token operator">=</span> _event<span class="token punctuation">.</span>clientX <span class="token operator">-</span> _target<span class="token punctuation">.</span>offsetLeft<span class="token punctuation">;</span>      y <span class="token operator">=</span> _event<span class="token punctuation">.</span>clientY <span class="token operator">-</span> _target<span class="token punctuation">.</span>offsetTop<span class="token punctuation">;</span>      drag <span class="token operator">=</span> _target<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     *鼠标移动事件     * @param evt 事件形参     */</span>    document<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//确定鼠标是在目标元素上按下去后才开始移动</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>drag<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _event <span class="token operator">=</span> evt <span class="token operator">||</span> window<span class="token punctuation">.</span>event<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//设置边界全局变量</span>        <span class="token keyword">var</span> _left <span class="token operator">=</span> _event<span class="token punctuation">.</span>clientX <span class="token operator">-</span> x<span class="token punctuation">;</span>        <span class="token keyword">var</span> _top <span class="token operator">=</span> _event<span class="token punctuation">.</span>clientY <span class="token operator">-</span> y<span class="token punctuation">;</span>        <span class="token keyword">var</span> _windowInnerWidth <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>        <span class="token keyword">var</span> _windowInnerHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight        <span class="token keyword">var</span> _dragOffWidth <span class="token operator">=</span> drag<span class="token punctuation">.</span>offsetWidth        <span class="token keyword">var</span> _dragOffHeight <span class="token operator">=</span> drag<span class="token punctuation">.</span>offsetHeight        <span class="token keyword">var</span> _windowWidth <span class="token operator">=</span> _windowInnerWidth <span class="token operator">-</span> _dragOffWidth        <span class="token keyword">var</span> _windowHeight <span class="token operator">=</span> _windowInnerHeight <span class="token operator">-</span> _dragOffHeight        <span class="token comment" spellcheck="true">//控制拖拽物体的范围只能在浏览器视窗内，不允许出现滚动条  </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>_left <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          _left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_left <span class="token operator">></span> _windowWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>          _left <span class="token operator">=</span> _windowWidth<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>_top <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          _top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_top <span class="token operator">></span> _windowHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>          _top <span class="token operator">=</span> _windowHeight<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//设置样式</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cursor <span class="token operator">=</span> <span class="token string">'move'</span><span class="token punctuation">;</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>border <span class="token operator">=</span> <span class="token string">'dashed 1px red'</span><span class="token punctuation">;</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> _left <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> _top <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**      * 松开鼠标事件     * @param evt 事件形参      */</span>    document<span class="token punctuation">.</span>onmouseup <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>drag<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//卸载样式</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cursor <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        drag<span class="token punctuation">.</span>style<span class="token punctuation">.</span>border <span class="token operator">=</span> <span class="token string">'dashed 1px #ccc'</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      drag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>crypto 加密模块</title>
      <link href="/2019/04/08/node/crypto/"/>
      <url>/2019/04/08/node/crypto/</url>
      
        <content type="html"><![CDATA[<p>crypto 模块也是核心模块之一，提供了加密功能，包括对 OpenSSL 的哈希、HMAC、加密、解密、签名、以及验证功能的一整套封装。上文中提到过核心 C/C++ 模块运行速度比其他模块要快。<br></p><p><strong>MD5和SHA1</strong><br><br>MD5是一种常用的哈希算法，用于给任意数据一个“签名”。这个签名通常用一个十六进制的字符串表示：<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入加密模块</span><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 创建 Hash 实例</span><span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 计算后的HMAC摘要 update() 方法默认字符串编码为UTF-8，也可以传入Buffer</span>hash<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">'Hello, nodejs!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// encoding 值可以是 'hex', 'latin1' 或者 'base64'. </span> <span class="token comment" spellcheck="true">// 如果encoding 是字符串会被直接返回，其它情况会返回一个 a Buffer.</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Hash 对象在 hash.digest() 方法调用之后不能再次被使用。多次的调用会引发错误并抛出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Hmac</strong><br><br>Hmac算法也是一种哈希算法，它可以利用MD5或SHA1等哈希算法。不同的是，Hmac还需要一个密钥：<br></p><pre><code>// 引入加密模块const crypto = require(&#39;crypto&#39;);// 创建 hmac 实例const hmac = crypto.createHmac(&#39;sha256&#39;, &#39;secret-key&#39;);// 计算后的HMAC摘要 update() 方法默认字符串编码为UTF-8，也可以传入Bufferhmac.update(&#39;Hello, nodejs!&#39;);// encoding 值可以是 &#39;hex&#39;, &#39;latin1&#39; 或者 &#39;base64&#39;.   如果encoding 是字符串会被直接返回，其它情况会返回一个 a Buffer.console.log(hmac.digest(&#39;hex&#39;));只要密钥发生了变化，那么同样的输入数据也会得到不同的签名，因此，可以把Hmac理解为用随机数“增强”的哈希算法</code></pre><p><strong>AES</strong><br><br>AES是一种常用的对称加密算法，加解密都用同一个密钥。crypto模块提供了AES支持，但是需要自己封装好函数，便于使用：<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入加密模块</span><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 加密函数</span><span class="token keyword">function</span> <span class="token function">aesEncrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> cipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createCipher</span><span class="token punctuation">(</span><span class="token string">'aes192'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> crypted <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  crypted <span class="token operator">+</span><span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> crypted<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 解密函数</span><span class="token keyword">function</span> <span class="token function">aesDecrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> decipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDecipher</span><span class="token punctuation">(</span><span class="token string">'aes192'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> decrypted <span class="token operator">=</span> decipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  decrypted <span class="token operator">+</span><span class="token operator">=</span> decipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> decrypted<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">'Hello, this is a secret message!'</span><span class="token punctuation">;</span><span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token string">'Password!'</span><span class="token punctuation">;</span><span class="token keyword">let</span> encrypted <span class="token operator">=</span> <span class="token function">aesEncrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> decrypted <span class="token operator">=</span> <span class="token function">aesDecrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Plain text: '</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Encrypted text: '</span> <span class="token operator">+</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Decrypted text: '</span> <span class="token operator">+</span> decrypted<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果如下：<br></p><pre><code>Plain text: Hello, this is a secret message!Encrypted text: 8a944d97bdabc157a5b7a40cb180e7...Decrypted text: Hello, this is a secret message!</code></pre><p><strong>Diffie-Hellman</strong><br></p><p>DH算法是一种密钥交换协议，它可以让双方在不泄漏密钥的情况下协商出一个密钥来。DH算法基于离散对数数学原理<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入加密模块</span><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 进行加密交换 crypto_a</span><span class="token keyword">let</span> crypto_a <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDiffieHellman</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> crypto_a_keys <span class="token operator">=</span> crypto_a<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> prime <span class="token operator">=</span> crypto_a<span class="token punctuation">.</span><span class="token function">getPrime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> generator <span class="token operator">=</span> crypto_a<span class="token punctuation">.</span><span class="token function">getGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Prime: '</span> <span class="token operator">+</span> prime<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Generator: '</span> <span class="token operator">+</span> generator<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 进行加密交换 crypto_b</span><span class="token keyword">let</span> crypto_b <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDiffieHellman</span><span class="token punctuation">(</span>prime<span class="token punctuation">,</span> generator<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> crypto_b_keys <span class="token operator">=</span> crypto_b<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 交换生成密钥</span><span class="token keyword">let</span> a_secret <span class="token operator">=</span> crypto_a<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>crypto_b_keys<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> b_secret <span class="token operator">=</span> crypto_b<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>crypto_a_keys<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>RSA</strong></p><p>RSA算法是一种非对称加密算法，即由一个私钥和一个公钥构成的密钥对，通过私钥加密，公钥解密，或者通过公钥加密，私钥解密。其中，公钥可以公开，私钥必须保密<br></p><p>1、生成一个RSA密钥对：<br></p><pre class="line-numbers language-js"><code class="language-js">openssl genrsa <span class="token operator">-</span>aes256 <span class="token operator">-</span>out rsa<span class="token operator">-</span>key<span class="token punctuation">.</span>pem <span class="token number">2048</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2、通过上面的rsa-key.pem加密文件，导出原始的私钥<br></p><pre class="line-numbers language-js"><code class="language-js">openssl rsa <span class="token operator">-</span><span class="token keyword">in</span> rsa<span class="token operator">-</span>key<span class="token punctuation">.</span>pem <span class="token operator">-</span>outform PEM <span class="token operator">-</span>out rsa<span class="token operator">-</span>prv<span class="token punctuation">.</span>pem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>3、命令导出原始的公钥<br></p><pre class="line-numbers language-js"><code class="language-js">openssl rsa <span class="token operator">-</span><span class="token keyword">in</span> rsa<span class="token operator">-</span>key<span class="token punctuation">.</span>pem <span class="token operator">-</span>outform PEM <span class="token operator">-</span>pubout <span class="token operator">-</span>out rsa<span class="token operator">-</span>pub<span class="token punctuation">.</span>pem<span class="token comment" spellcheck="true">//这样，我们就准备好了原始私钥文件rsa-prv.pem和原始公钥文件rsa-pub.pem，编码格式均为PEM</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>使用crypto模块提供的方法，即可实现非对称加解密<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 从文件加载key:</span><span class="token keyword">function</span> <span class="token function">loadKey</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// key实际上就是PEM编码的字符串:</span>  <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> prvKey <span class="token operator">=</span> <span class="token function">loadKey</span><span class="token punctuation">(</span><span class="token string">'./rsa-prv.pem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> pubKey <span class="token operator">=</span> <span class="token function">loadKey</span><span class="token punctuation">(</span><span class="token string">'./rsa-pub.pem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">'Hello, world!'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 使用私钥加密:</span><span class="token keyword">let</span> enc_by_prv <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">privateEncrypt</span><span class="token punctuation">(</span>prvKey<span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'encrypted by private key: '</span> <span class="token operator">+</span> enc_by_prv<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> dec_by_pub <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">publicDecrypt</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">,</span> enc_by_prv<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'decrypted by public key: '</span> <span class="token operator">+</span> dec_by_pub<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//执行后，可以得到解密后的消息，与原始消息相同。</span><span class="token comment" spellcheck="true">//接下来我们使用公钥加密，私钥解密：</span><span class="token comment" spellcheck="true">// 使用公钥加密:</span><span class="token keyword">let</span> enc_by_pub <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">publicEncrypt</span><span class="token punctuation">(</span>pubKey<span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'encrypted by public key: '</span> <span class="token operator">+</span> enc_by_pub<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 使用私钥解密:</span><span class="token keyword">let</span> dec_by_prv <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">privateDecrypt</span><span class="token punctuation">(</span>prvKey<span class="token punctuation">,</span> enc_by_pub<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'decrypted by private key: '</span> <span class="token operator">+</span> dec_by_prv<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//执行得到的解密后的消息仍与原始消息相同。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>证书</strong><br>crypto模块也可以处理数字证书。数字证书通常用在SSL连接，也就是Web的https连接。一般情况下，https连接只需要处理服务器端的单向认证，如无特殊需求（例如自己作为Root给客户发认证证书），建议用反向代理服务器如Nginx等Web服务器去处理证书。<br></p><h2 id="更多参考"><a href="#更多参考" class="headerlink" title="更多参考"></a>更多参考<br></h2><p><a href="https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000/001434501504929883d11d84a1541c6907eefd792c0da51000" target="_blank" rel="noopener">廖雪峰老师的Crypto</a></p><p><a href="http://nodejs.cn/api/crypto.html" target="_blank" rel="noopener">Node Api crypto 加密模块 </a></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>module 模块机制</title>
      <link href="/2019/04/05/node/module/"/>
      <url>/2019/04/05/node/module/</url>
      
        <content type="html"><![CDATA[<p>模块是Node.js 应用程序的基本组成部分，文件和模块是一一对应的。前端模块化组件化也是在这几年逐渐的流行，在 web2.0 发展过程如下<br></p><p><img src="/images/module.png" width="300"><br></p><h3 id="CommonJS-规范"><a href="#CommonJS-规范" class="headerlink" title="CommonJS 规范"></a>CommonJS 规范<br></h3><p>CommonJS（<a href="http://www.commonjs.org" target="_blank" rel="noopener">http://www.commonjs.org</a>）规范的出现解决了JavaScript 没有模块系统，标准库等等问题，而 Node.js 自身实现了 require 作为其引入模块的方法，同时 NPM 也基于 CommonJS 定义的包规范，实现了依赖管理和模块自动安装等功能。下图展现Node与浏览器以及W3C组织、CommonJS组织、ECMAScript之间的关系<br></p><p><img src="/images/commonjs.png" width="550"><br></p><h3 id="CommonJS-模块"><a href="#CommonJS-模块" class="headerlink" title="CommonJS 模块"></a>CommonJS 模块</h3><p>1、模块引用 require 关键字 <br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> math <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'math'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2、模块定义导出 exports 关键字<br></p><pre class="line-numbers language-js"><code class="language-js">exports<span class="token punctuation">.</span>area <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Math<span class="token punctuation">.</span>PI <span class="token operator">*</span> r <span class="token operator">*</span> r<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>3、模块标识<br><br>模块标识其实就是传递给require()方法的参数，它必须是符合小驼峰命名的字符串，或者以.、..开头的相对路径，或者绝对路径，每个模块都有独立的空间。防止虑变量污染。<br></p><h3 id="Node-模块实现"><a href="#Node-模块实现" class="headerlink" title="Node 模块实现"></a>Node 模块实现<br></h3><p>1、引入模块三个步骤(分为核心模块和文件模块)<br></p><pre><code>(1) 路径分析(2) 文件定位(3) 编译执行</code></pre><p>核心模块和文件模块的区别在于加载的时机，核心模块在 Node 进程启动时被直接加载到内存中比文件模块省略了文件定位和编译执行过程<br></p><h3 id="Node-模块载入策略"><a href="#Node-模块载入策略" class="headerlink" title="Node 模块载入策略"></a>Node 模块载入策略<br></h3><p>1、不论是核心模块还是文件模块，require()方法对相同模块的二次加载都一律采用缓存优先，以减少二次引入时的开销<br><br>2、模块引用的过程由于标识符不同在路径分析和文件定位中有一定的差异<br></p><pre><code>// 路径分析核心模块，如http、fs、path等(加载最快).或..开始的相对路径文件模块(慢于核心模块)以/开始的绝对路径文件模块(慢于核心模块)自定义模块（最慢-由于沿路径向上逐级递归，直到根目录下的node_modules目录，层级越多越耗时// 文件定位由于其扩展名不同 Node 会按 .js、.json、.node 的次序补、足扩展名，依次尝试调用fs模块同步阻塞式地判断文件是否存在如果文件不是 .js 可以在加载的时候写上文件的扩展名，可以加快文件定位速度，配合缓存，可以大幅度缓解 Node 单线程中阻塞式调用的缺陷</code></pre><p>3、模块编译</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>    parent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span> 对于不同的文件扩展名，其载入方法也有所不同<span class="token punctuation">.</span>js 文件  通过fs模块同步读取文件后编译执行。在编译过程中进行了头尾包装。在头部添加了  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname<span class="token punctuation">)</span> <span class="token punctuation">{</span>    \n，在尾部添加了\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>。  <span class="token function">通过vm原生模块的runInThisContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法执行（类似eval，只是具有明确上下文，不污染全局），返回一个具体的  <span class="token keyword">function</span><span class="token function">对象。最后，将当前模块对象的exports属性、require</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法、module（模块对象自身），  以及在文件定位中得到的完整文件路径和文件目录作为参数传递给这个<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>执行。<span class="token punctuation">.</span>node 文件。用C<span class="token operator">/</span>C<span class="token operator">++</span><span class="token function">编写的扩展文件，通过dlopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法加载最后编译生成的文件。  Node调用process<span class="token punctuation">.</span><span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">方法进行加载和执行。在Node的架构下，dlopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法在Windows  和<span class="token operator">*</span>nix平台下分别有不同的实现，通过libuv兼容层进行了封装<span class="token punctuation">.</span>json 文件。通过fs模块同步读取文件后，用JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>解析返回结果。其余扩展名文件。它们都被当做<span class="token punctuation">.</span>js文件载入。每一个编译成功的模块都会将其文件路径作为索引缓存在Module<span class="token punctuation">.</span>_cache对象上，以提高二次引入的性能。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Node-核心模块的编译、引入、加载过程"><a href="#Node-核心模块的编译、引入、加载过程" class="headerlink" title="Node 核心模块的编译、引入、加载过程"></a>Node 核心模块的编译、引入、加载过程<br></h3><p><strong>模块调用栈</strong><br></p><p>1、C/C++内建模块属于最底层的模块，它属于核心模块，主要提供API给JavaScript核心模块和第三方JavaScript文件模块调用。<br><br>2、JavaScript核心模块主要扮演的职责有两类：一类是作为C/C++内建模块的封装层和桥接层，供文件模块调用；一类是纯粹的功能模块，它不需要跟底层打交道，但是又十分重要<br></p><p><img src="/images/module-p.png" width="350"><br></p><p><strong>核心模块调用流程</strong><br></p><p>1、 JavaScript 核心模块编译过程<br></p><ul><li><p>转存为转存为C/C++代码（Node采用了V8附带的js2c.py工具，将所有内置的JavaScript代码（src/node.js和lib/*.js）转换成C++里的数组，生成node_natives.h头文件，以字符串的形式存储在 node 的命令空间中）<br></p></li><li><p>启动 node 进程 JavaScript 代码直接加载进内存中<br></p></li><li><p>编译 JavaScript 核心模块（lib目录下的所有模块文件也没有定义require、module、exports这些变量。上面说过在引入 JavaScript 核心模块过程进行头尾包装，才可以执行exports对象）<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// node_natives.h 头文件代码</span>namespace node <span class="token punctuation">{</span><span class="token keyword">const</span> char node_native<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">const</span> char dgram_native<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">const</span> char console_native<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">const</span> char buffer_native<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">const</span> char querystring_native<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">const</span> char punycode_native<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token operator">...</span>struct _native <span class="token punctuation">{</span>  <span class="token keyword">const</span> char<span class="token operator">*</span> name<span class="token punctuation">;</span>  <span class="token keyword">const</span> char<span class="token operator">*</span> source<span class="token punctuation">;</span>  size_t source_len<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">const</span> struct _native natives<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token punctuation">{</span> <span class="token string">"node"</span><span class="token punctuation">,</span> node_native<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>node_native<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> <span class="token string">"dgram"</span><span class="token punctuation">,</span> dgram_native<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>dgram_native<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// JavaScript 核心模块通过process.binding('natives')取出，编译成功的模块缓存到 NativeModule._cache 对象上，文件模块则缓存到 Module._cache 对象上</span><span class="token keyword">function</span> <span class="token function">NativeModule</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> id <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span>NativeModule<span class="token punctuation">.</span>_source <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">binding</span><span class="token punctuation">(</span><span class="token string">'natives'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>NativeModule<span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>2、 C/C++核心模块的编译过程<br></p><ul><li><p>定义内建模块内部结构</p></li><li><p>通过NODE_MODULE宏将模块定义到node命名空间中，模块的具体初始化方法挂载为结构的register_func成员<br></p></li><li><p>node_extensions.h文件将这些散列的内建模块统一放进了一个叫node_module_list的数组中<br></p></li><li><p>Node 通过 get_builtin_module() 方法从 node_module_list 数组中取出这些模块<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 内建模块的内部结构定义</span>struct node_module_struct <span class="token punctuation">{</span>int version<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>dso_handle<span class="token punctuation">;</span><span class="token keyword">const</span> char <span class="token operator">*</span>filename<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>register_func<span class="token punctuation">)</span> <span class="token punctuation">(</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Handle<span class="token operator">&lt;</span>v8<span class="token punctuation">:</span><span class="token punctuation">:</span>Object<span class="token operator">></span> target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> char <span class="token operator">*</span>modname<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 挂载为结构的register_func成员</span>#define <span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>modname<span class="token punctuation">,</span> regfunc<span class="token punctuation">)</span> extern <span class="token string">"C"</span> <span class="token punctuation">{</span>  NODE_MODULE_EXPORT node<span class="token punctuation">:</span><span class="token punctuation">:</span>node_module_struct modname ## _module <span class="token operator">=</span>  <span class="token punctuation">{</span>    NODE_STANDARD_MODULE_STUFF<span class="token punctuation">,</span>    regfunc<span class="token punctuation">,</span>    <span class="token function">NODE_STRINGIFY</span><span class="token punctuation">(</span>modname<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>3、核心模块的引入流程<br><br>如 os 原生模块的引入流程<br><br><img src="/images/module-os.png" width="350"><br></p><p>通过以上我们大致了解了 Node 中模块的编译、加载、引入流程。当然还有核心模块的编写，在这里就不过多的阐述了。更多请参考朴灵老师编著的《深入浅出 node》，相信会有更多的收获。<br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>querystring 路径操作</title>
      <link href="/2019/04/04/node/querystring/"/>
      <url>/2019/04/04/node/querystring/</url>
      
        <content type="html"><![CDATA[<p>querystring 模块提供用于解析和格式化 URL 查询字符串<br></p><h3 id="解析-URL-字符串-querystring-parse-str-sep-eq-options"><a href="#解析-URL-字符串-querystring-parse-str-sep-eq-options" class="headerlink" title="解析 URL 字符串 querystring.parse(str[, sep[, eq[, options]]]) "></a>解析 URL 字符串 querystring.parse(str[, sep[, eq[, options]]]) <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入模块</span><span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'foo=bar&amp;abc=xyz&amp;abc=123'</span><span class="token punctuation">)</span>输出为：<span class="token punctuation">{</span>  foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>  abc<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'xyz'</span><span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>默认情况下，将假定查询字符串中的百分比编码字符使用 UTF-8 编码。 如果使用其他字符编码，则需要指定其他 decodeURIComponent 选项：<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 假设 gbkEncodeURIComponent 函数已存在。</span>querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'w=%D6%D0%CE%C4&amp;foo=bar'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">{</span> decodeURIComponent<span class="token punctuation">:</span> gbkDecodeURIComponent <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="序列化-URL-字符串-querystring-stringify-obj-sep-eq-options"><a href="#序列化-URL-字符串-querystring-stringify-obj-sep-eq-options" class="headerlink" title="序列化 URL 字符串 querystring.stringify(obj[, sep[, eq[, options]]]) "></a>序列化 URL 字符串 querystring.stringify(obj[, sep[, eq[, options]]]) <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入模块</span><span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出为 'foo=bar&amp;baz=qux&amp;baz=quux&amp;corge='</span>querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'qux'</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> corge<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出为 'foo:bar;baz:qux'</span>querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token string">'qux'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">';'</span><span class="token punctuation">,</span> <span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>默认情况下，查询字符串中需要百分比编码的字符将编码为 UTF-8。 如果需要其他编码，则需要指定其他 encodeURIComponent 选项：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 假设 gbkEncodeURIComponent 函数已存在。</span>querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> w<span class="token punctuation">:</span> <span class="token string">'中文'</span><span class="token punctuation">,</span> foo<span class="token punctuation">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">{</span> encodeURIComponent<span class="token punctuation">:</span> gbkEncodeURIComponent <span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><a href="https://nodejs.org/docs/latest-v9.x/api/querystring.html" target="_blank" rel="noopener">其他方法请参考 Node Api </a><br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>path 路径操作</title>
      <link href="/2019/04/02/node/path/"/>
      <url>/2019/04/02/node/path/</url>
      
        <content type="html"><![CDATA[<p>path 模块提供用于处理文件路径和目录路径的实用工具<br></p><h3 id="path使用特点"><a href="#path使用特点" class="headerlink" title="path使用特点"></a>path使用特点</h3><p>path 模块的默认操作因 Node.js 应用程序运行所在的操作系统而异。 具体来说，当在 Windows 操作系统上运行时， path 模块将假定正在使用 Windows 风格的路径。<br></p><h3 id="获取路径-path-dirname-p"><a href="#获取路径-path-dirname-p" class="headerlink" title="获取路径    path.dirname(p) "></a>获取路径    path.dirname(p) <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入 path 模块</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出 /demo/js/test.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token string">'/demo/js/test.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取文件名-path-basename-p"><a href="#获取文件名-path-basename-p" class="headerlink" title="获取文件名 path.basename(p) "></a>获取文件名 path.basename(p) <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入 path 模块</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span> 输出：test<span class="token punctuation">.</span>jsconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/demo/js/test.js'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出：test</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/demo/js/test/'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出：test</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/demo/js/test'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取文件扩展名-path-extname-p"><a href="#获取文件扩展名-path-extname-p" class="headerlink" title="获取文件扩展名 path.extname(p) "></a>获取文件扩展名 path.extname(p) <br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入 path 模块</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出 .js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'/demo/js/test.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="拼接文件路径-path-join-…paths"><a href="#拼接文件路径-path-join-…paths" class="headerlink" title="拼接文件路径 path.join([…paths])"></a>拼接文件路径 path.join([…paths])<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入 path 模块</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// /demo/js/test.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/demo'</span><span class="token punctuation">,</span> <span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'test.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取的绝对路径-文件名-path-reslove-from-…-to"><a href="#获取的绝对路径-文件名-path-reslove-from-…-to" class="headerlink" title="获取的绝对路径/文件名 path.reslove([from …], to)"></a>获取的绝对路径/文件名 path.reslove([from …], to)<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入 path 模块</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出当前项目的绝对路径</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">reslove</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出当前项目的绝对路径</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">reslove</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出 /foo/bar/baz</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'/foo/bar'</span><span class="token punctuation">,</span> <span class="token string">'./baz'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出 /baz/file</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'/foo/bar'</span><span class="token punctuation">,</span> <span class="token string">'/baz/file/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取路径字符串的对象-path-parse-p"><a href="#获取路径字符串的对象-path-parse-p" class="headerlink" title="获取路径字符串的对象 path.parse(p)"></a>获取路径字符串的对象 path.parse(p)<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入 path 模块</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'/home/user/dir/file.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 返回:</span><span class="token comment" spellcheck="true">// { root: '/',</span><span class="token comment" spellcheck="true">//   dir: '/home/user/dir',</span><span class="token comment" spellcheck="true">//   base: 'file.txt',</span><span class="token comment" spellcheck="true">//   ext: '.txt',</span><span class="token comment" spellcheck="true">//   name: 'file' }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取规范化路径-path-normalize-p"><a href="#获取规范化路径-path-normalize-p" class="headerlink" title="获取规范化路径 path.normalize(p)"></a>获取规范化路径 path.normalize(p)<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入 path 模块</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出 '/foo/bar/baz/asdf'</span>path<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token string">'/foo/bar//baz/asdf/quux/..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://nodejs.org/docs/latest-v9.x/api/path.html" target="_blank" rel="noopener">其他方法请参考 Node Api </a><br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fs 文件操作</title>
      <link href="/2019/04/01/node/fs/"/>
      <url>/2019/04/01/node/fs/</url>
      
        <content type="html"><![CDATA[<p>在 node 中文件交互是非常重要的，例如文件的打开、读取、写入文件、以及与其交互等等，这其中围绕着异步模式和同步模式读取的话题。下面就 node 的 fs 文件操作模举例说明<br></p><h3 id="fs使用特点"><a href="#fs使用特点" class="headerlink" title="fs使用特点"></a>fs使用特点</h3><p>1、同步的版本将阻塞整个进程，直到它们完成（停止所有连接）<br><br>2、异步文件系统不会阻塞程序的执行，而是在操作完成时，通过回调函数将结果返回，但是无法保证操作的的正确性和有效的顺序<br></p><h3 id="文件写入"><a href="#文件写入" class="headerlink" title="文件写入"></a>文件写入<br></h3><ol><li>异步文件写入<br></li></ol><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入 fs 模块</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description * 异步打开文件操作 fs.open * 异步写入文件操作 fs.writeFile * 异步关闭文件操作 fs.close */</span>fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'file.txt'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>  fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"node是很有意思的语言！"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入文件成功'</span><span class="token punctuation">)</span>    fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件以保存并关闭'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>同步写入方式<br><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入模块 </span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><p>// 打开文件 同步<br>var fd=fs.openSync(‘file.txt’, ‘w’);</p><p>// 写入内容<br>fs.writeFileSync(fd,”node是很有意思的语言!”); </p><p>// 保存并关闭<br>fs.closeSync(fd);</p><pre><code>### 读写操作&lt;br/&gt;1. 文件读写操作&lt;br/&gt;```js// 引入模块const fs = require(&#39;fs&#39;);/** * @description * 异步读取文件 fs.readFile */fs.readFile(&#39;source/file.txt&#39;,&#39;utf8&#39;,(err,data)=&gt;{  if (err) throw err;  console.log(data); //data 默认读取的是二进制 使用toString() 方法转换成})</code></pre><ol start="2"><li>图片读写操作<br></li></ol><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入模块</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description * 异步读取文件 fs.readFile * 异步写入文件 fs.writeFile */</span>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"source/a.jpg"</span><span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 文件写入</span>  fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'b.jpg'</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入成功！'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>视频读写操作<br></li></ol><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入模块</span><span class="token keyword">let</span> fs<span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description * 异步读取文件 fs.readFile * 异步写入文件 fs.writeFile * 创建文件读取流 fs.createReadStream * 创建文件写入流 fs.createWriteStream * 创建管道 fileStream.pipe * fs.readFile() 函数会缓冲整个文件。  * 为了最小化内存成本，尽可能通过 fs.createReadStream() 进行流式传输。 */</span><span class="token comment" spellcheck="true">// 方式一</span>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'source/a.mp4'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 文件写入</span>  fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'b.mp4'</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入成功！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 方式二</span><span class="token keyword">let</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'source/a.mp4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'new.mp4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>re<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>使用同步文件流写入操作<br><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入模块</span><span class="token keyword">let</span> fs<span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><p>// 建立通道<br>let ws = fs.createWriteStream(‘file.txt’)</p><p>// 打开通道<br>ws.once(‘open’, () =&gt; {<br>    console.log(‘通道打开’);<br>})</p><p>ws.once(‘close’, () =&gt; {<br>    console.log(‘通道关闭’);<br>})</p><p>// 写入内容<br>ws.write(‘node开始’);<br>ws.write(‘node1’);<br>ws.write(‘node2’);<br>ws.write(‘node结束’);</p><pre><code>&lt;a href=&quot;https://nodejs.org/docs/latest-v9.x/api/fs.html&quot;&gt;其他方法请参考 Node Api &lt;/a&gt;&lt;br/&gt;</code></pre>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>url</title>
      <link href="/2019/03/28/node/url/"/>
      <url>/2019/03/28/node/url/</url>
      
        <content type="html"><![CDATA[<p>url模块提供用于URL解析和解析的实用程序<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>获取并设置URL的片段部分<strong>url.hash</strong><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> myURL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://example.org/foo#bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myURL<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//#bar</span>myURL<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token string">'baz'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myURL<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//https://example.org/foo#baz</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获取并设置URL的主机部分<strong>url.host</strong><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> myURL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://example.org:81/foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myURL<span class="token punctuation">.</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//example.org:81</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myURL<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//example.org</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>获取并设置序列化url<strong>url.href</strong><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> myURL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://example.org:81/foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myURL<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//https://example.org:81/foo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>获取并设置URL的路径部分<strong>url.pathname</strong><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> myURL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://example.org:81/foo/abc?name=123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myURL<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// /foo/abc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>获取并设置URL的端口部分<strong>url.port  0到65535</strong><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> myURL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://example.org:81/foo/abc?name=123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myURL<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 81</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>获取并设置URL的序列化查询部分<strong>url.search</strong><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> myURL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://example.org:81/foo/abc?name=123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myURL<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// name=123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>获取URLSearchParams表示URL的查询参数的对象<strong>url.serchParams</strong><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> myURL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://example.org:81/foo/abc?name=123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myURL<span class="token punctuation">.</span>searchParams<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><a href="https://nodejs.org/api/url.html" target="_blank" rel="noopener">更多方法请参考 Node Api </a><br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tcp udp http</title>
      <link href="/2019/03/23/node/http/"/>
      <url>/2019/03/23/node/http/</url>
      
        <content type="html"><![CDATA[<h3 id="构建TCP服务"><a href="#构建TCP服务" class="headerlink" title="构建TCP服务"></a>构建TCP服务<br></h3><p> tcp全名为传输控制协议，在OSI模型中属于传输层协议如下图<br><br> <img src="/images/tcp.png" width="300px"><br></p><p> tcp是面向连接的协议，特点是在传输之前需要3次握手形成会话如下图<br><br> <img src="/images/ack.png" width="300px"><br></p><p>  第一次握手：客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认<br><br>  第二次握手：服务器收到syn包，必须确认客户的SYN(ack=j+1)，同时自己也发送一个SYN包(syn=k)，即SYN+ACK包，此时服务器进入SYN_RECV状态<br><br>  第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手<br></p><p>  当然tcp也会有四次挥手，在这里就不具体说明了<br></p><h3 id="创建TCP服务端"><a href="#创建TCP服务端" class="headerlink" title="创建TCP服务端"></a>创建TCP服务端<br></h3><p>1、创建TCP服务端接受网络请求<br><br>1.1服务器事件<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 开始新连接</span>  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 断开连接</span>  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'断开连接'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8124</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server start listen port 8124 !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码创建为服务器事件，它是一个<strong>EventEmitter</strong>实例，自定义事件有一下几种<br></p><ul><li>listening 绑定的端口</li><li>connection 连接到服务器时出发此事件</li><li>close 服务器关闭时触发</li><li>error 服务器发生异常时触发<br></li></ul><p>1.2连接事件<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> client <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token punctuation">:</span> <span class="token number">8124</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'client connected !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  client<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>  conosle<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  client<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'此连接结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码创建连接事件，服务器可以同时与多个客户端保持连接，对于每个连接其实都是<strong>Stream</strong>对象，它用于服务器端和客户端之间的通讯，自定义事件如下<br></p><ul><li>data 当一端调用write()发送数据时，另一端会触发data，事件传递的数据是write()发送的数据</li><li>end 当连接中的任意一端发送<strong>FIN</strong> 数据时，触发此事件</li><li>drain 当一端调用write()发送数据时，触发此事件</li><li>close 当所有连接完全关闭时触发</li><li>error 服务器发生异常时触发</li><li>timeout 连接超时时触发</li></ul><p><strong>node中 TCP默认开启Nagle算法（优化网络数据包）此算法由于要求缓冲数据达到一定数量或一定时间后才发送，所以可能会造成延迟发送</strong></p><h3 id="构建UDP服务"><a href="#构建UDP服务" class="headerlink" title="构建UDP服务"></a>构建UDP服务<br></h3><p>UDP用户数据包协议，和TCP一样属于网络传输层<br></p><h3 id="创建UDP服务端"><a href="#创建UDP服务端" class="headerlink" title="创建UDP服务端"></a>创建UDP服务端<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> dgram <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dgram'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 创建server对象</span><span class="token keyword">var</span> server  <span class="token operator">=</span> dgram<span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token string">'udp4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 接到消息时，触发该事件，携带的数据为消息buffer和远程地址信息对象</span>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> rinfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rinfo<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 绑定端口之后启动监听时间</span>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> address <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 绑定端口</span>server<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">41234</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建UDP客户端"><a href="#创建UDP客户端" class="headerlink" title="创建UDP客户端"></a>创建UDP客户端<br></h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> dgram <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dgram'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> client <span class="token operator">=</span> dgram<span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token string">'udp4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">41234</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>  client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="构建HTTP服务"><a href="#构建HTTP服务" class="headerlink" title="构建HTTP服务"></a>构建HTTP服务<br></h3><p>HTTP是超文本传输协议，是构建在TCP之上的，属于应用层协议，在HTTP的两端是服务端和浏览器也就是B/S模式<br></p><h3 id="HTTP报文"><a href="#HTTP报文" class="headerlink" title="HTTP报文"></a>HTTP报文<br></h3><p>我们可以在命令行利用curl -v <a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a> 来模拟请求，产生如下报文信息<br></p><p>第一部分其实就是标准的TCP3次握手过程<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">*</span> About to <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> to localhost <span class="token punctuation">(</span><span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">)</span> port <span class="token number">8080</span> <span class="token punctuation">(</span>#<span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>   Trying <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token operator">...</span><span class="token operator">*</span> TCP_NODELAY <span class="token keyword">set</span><span class="token operator">*</span> Connected to localhost <span class="token punctuation">(</span><span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">)</span> port <span class="token number">8080</span> <span class="token punctuation">(</span>#<span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>第二部分在握手完成之后，客户端向服务端发送的请求报文<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">></span> GET <span class="token operator">/</span> HTTP<span class="token operator">/</span><span class="token number">1.1</span><span class="token operator">></span> Host<span class="token punctuation">:</span> <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">></span> User<span class="token operator">-</span>Agent<span class="token punctuation">:</span> curl<span class="token operator">/</span><span class="token number">7.54</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">></span> Accept<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token operator">/</span><span class="token operator">*</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第三部分是服务端处理结束后，向客户端发送的响应内容包括响应头和响应体<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span> HTTP<span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> OK<span class="token operator">&lt;</span> X<span class="token operator">-</span>Powered<span class="token operator">-</span>By<span class="token punctuation">:</span> Express<span class="token operator">&lt;</span> Accept<span class="token operator">-</span>Ranges<span class="token punctuation">:</span> bytes<span class="token operator">&lt;</span> Content<span class="token operator">-</span>Type<span class="token punctuation">:</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span> charset<span class="token operator">=</span>UTF<span class="token number">-8</span><span class="token operator">&lt;</span> Content<span class="token operator">-</span>Length<span class="token punctuation">:</span> <span class="token number">820</span><span class="token operator">&lt;</span> ETag<span class="token punctuation">:</span> W<span class="token operator">/</span><span class="token string">"334-dKswJvgc24O5QPXd939SLJD+BhM"</span><span class="token operator">&lt;</span> Date<span class="token punctuation">:</span> Thu<span class="token punctuation">,</span> <span class="token number">11</span> Apr <span class="token number">2019</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">33</span><span class="token punctuation">:</span><span class="token number">03</span> GMT<span class="token operator">&lt;</span> Connection<span class="token punctuation">:</span> keep<span class="token operator">-</span>alive<span class="token operator">&lt;</span>hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第四部分是结束此会话<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">*</span> Connection #<span class="token number">0</span> to host <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span> left intact<span class="token operator">*</span> Closing connection #<span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>通过上面的信息中我们可以看出虽然是基于 TCP，但是本身确实基于请求响应式的，一问一答模式并不是会话模式。<br></p><h3 id="HTTP模块"><a href="#HTTP模块" class="headerlink" title="HTTP模块"></a>HTTP模块<br></h3><p>node http 模块承继 tcp 服务器（ net 模块）它能够与多个客户端保持连接，采用事件驱动，不会为每个连接创建额外的线程或进程。占用内存低，所以能实现高并发，tcp 服务以connection进行服务，http以request进行服务。node http 模块将connection和request进行封装<br><br><img src="/images/request.png" width="400px"><br></p><p>http模块将所有读写抽象为ServerRequest和ServerResponse对象<br><br><img src="/images/http.png" width="400px"><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span> <span class="token punctuation">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Hello Word'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="HTTP代理"><a href="#HTTP代理" class="headerlink" title="HTTP代理"></a>HTTP代理<br></h3><p>http 提供的 ClientRequest 是基于 tcp 层实现的，在keepalive情况下，一个底层会话能够连接多个请求。<br><br>http 模块包含一个默认的客户端代理对象http.globalAgent<br><br>通过 ClientRequest 对象对用一个服务器发起的 http 最多可以创建5个连接，实际上是一个连接池。如果 http 客户端同时对一个服务器发起超过5个请求，其实也只有5个处于并发状态。<br><br><img src="/images/http代理.png" width="400px"><br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 可以通过http.Agent修改连接数量，但连接数量过大会影响服务器性能</span><span class="token keyword">var</span> agent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">http<span class="token punctuation">.</span>Agent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  maxSockets<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">var</span> option <span class="token operator">=</span> <span class="token punctuation">{</span>  hostname<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>  port<span class="token punctuation">:</span> <span class="token number">1334</span><span class="token punctuation">,</span>  path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>  method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>  agent<span class="token punctuation">:</span> agent<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="构建-WebSocket-服务"><a href="#构建-WebSocket-服务" class="headerlink" title="构建 WebSocket 服务"></a>构建 WebSocket 服务<br></h3><p>Websocket 协议解决了服务器与客户端全双工通信的问题,也就是客户端和服务端之间的长连接<br></p><h3 id="WebSocket协议解析"><a href="#WebSocket协议解析" class="headerlink" title="WebSocket协议解析"></a>WebSocket协议解析<br></h3><p>WebSocket协议主要分为两个部分第一部分 http <strong>握手</strong>连接，第二部分协议升级为 WebSocket 进行<strong>数据传输</strong><br><br><img src="/images/websocket.png" width="400px"><br></p><h3 id="TCP-UDP-HTTP-WebSocket区别"><a href="#TCP-UDP-HTTP-WebSocket区别" class="headerlink" title="TCP UDP HTTP WebSocket区别"></a>TCP UDP HTTP WebSocket区别</h3><ol><li>TCP UDP HTTP WebSocket都是协议，而TCP/IP是不同协议的组合 <br></li><li>Socket的本质是API，只不过是对TCP/IP协议族的抽象或者说封装<br></li><li>从分层上来区分，HTTP，WebSocket是应用层协议，TCP，UDP是传输层协议，IP是网络层协议<br></li></ol><p><strong>1.TCP和UDP</strong><br></p><p>TCP是面向连接的传输控制协议。TCP连接之后，客户端和服务器可以互相发送和接收消息，在客户端或者服务器没有主动断开之前，连接一直存在，故称为长连接。特点：连接有耗时，传输数据无大小限制，准确可靠，先发先至<br><br>UDP是无连接的用户数据报协议，所谓的无连接就是在传输数据之前不需要交换信息，没有握手建立连接的过程，只需要直接将对应的数据发送到指定的地址和端口就行。故UDP的特点是不稳定，速度快，可广播，一般数据包限定64KB之内，先发未必先至<br></p><p><strong>2.HTTP</strong><br></p><p>HTTP是基于TCP协议的应用，请求时需建立TCP连接，而且请求包中需要包含请求方法，URI，协议版本等信息，请求结束后断开连接，完成一次请求/响应操作。故称为短连接。<br>而HTTP/1.1中的keep-alive所保持的长连接则是为了优化每次HTTP请求中TCP连接三次握手的麻烦和资源开销，只建立一次TCP连接，多次的在这个通道上完成请求/响应操作<br></p><p><strong>3.WebSocket</strong><br></p><p>WebSocket也是一种协议，并且也是基于TCP协议的。具体流程是WebSocket通过HTTP先发送一个标记了 Upgrade 的请求，服务端解析后开始建立TCP连接，省去了HTTP每次请求都要上传header的冗余，可以理解为WebSocket是HTTP的优化<br></p><p><strong>4.HTTP、WebSocket与TCP的关系</strong><br></p><p>HTTP通信过程是客户端不发请求则服务器永远无法发送数据给客户端，而WebSocket则在进行第一次HTTP请求之后，其他全部采用TCP通道进行双向通讯<br><br>HTTP和WebSocket虽都是基于TCP协议<br></p>]]></content>
      
      
      <categories>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>操作数组API方法</title>
      <link href="/2019/03/20/javascript/api/"/>
      <url>/2019/03/20/javascript/api/</url>
      
        <content type="html"><![CDATA[<h3 id="Array对象的作用"><a href="#Array对象的作用" class="headerlink" title="Array对象的作用"></a>Array对象的作用</h3><p>Array 对象用于在单个的变量中存储多个值</p><h3 id="创建Array对象的方法"><a href="#创建Array对象的方法" class="headerlink" title="创建Array对象的方法"></a>创建Array对象的方法</h3><p><code>var arrayObj = new Array()；</code><br><br><code>var arrayObj = []; //本人习惯用这种</code><br><br>返回值：返回新创建并被初始化了的数组。如果调用arrayObj时没有参数或者没有指定 值，那么返回的值为空，数组的length为0。<br></p><h3 id="Array对象的三个属性"><a href="#Array对象的三个属性" class="headerlink" title="Array对象的三个属性"></a>Array对象的三个属性</h3><p><code>constructor</code> //返回数组函数的引用。<br><br><code>length</code> //返回数组元素的长度（最常用）<br><br><code>prototype</code> //可以向数组对象添加属性和方法。<br></p><h3 id="concat"><a href="#concat" class="headerlink" title="concat()"></a>concat()</h3><p>该方法用于连接或者合并数组，并且不会改变原数组，返回一个新数组的副本</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arrObj1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arrObj<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arrObj1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,2,3,4,5,6,7,8]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="join"><a href="#join" class="headerlink" title="join()"></a>join()</h3><p>该方法用于把数组中的所有元素用指定的分隔符分割，返回一个字符串</p><pre class="line-numbers language-js"><code class="language-js">newArray<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//"1,2,3,4,5,6,7,8"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="pop"><a href="#pop" class="headerlink" title="pop()"></a>pop()</h3><p>该方法用于删除并返回数组的最后一个元素,并将原数组的length -1</p><pre><code>arrObj.pop()//4console.log(arrObj); //[1,2,3]</code></pre><h3 id="push"><a href="#push" class="headerlink" title="push()"></a>push()</h3><p>该方法可向数组的末尾添加一个或多个元素，并返回新的长度</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrObj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,2,3,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="shift"><a href="#shift" class="headerlink" title="shift()"></a>shift()</h3><p>该方法用于删除并返回数组的第一个元素,并将原数组的length -1</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrObj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//[2,3,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="unshift"><a href="#unshift" class="headerlink" title="unshift()"></a>unshift()</h3><p>该方法可向数组的开头添加一个或多个元素，并返回新的长度</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrObj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,2,3,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="slice"><a href="#slice" class="headerlink" title="slice()"></a>slice()</h3><p>该方法可从已有的数组中返回选定的元素,形成一个新的数组</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[2]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrObj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//[1,2,3,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="splice"><a href="#splice" class="headerlink" title="splice()"></a>splice()</h3><p>该法向数组中添加/删除元素，然后返回被删除的元素。该方法会改变原数组</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[2,3]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrObj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,5,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="reverse"><a href="#reverse" class="headerlink" title="reverse()"></a>reverse()</h3><p>该方法用于颠倒数组中元素的顺序，并且改变原来的数组，而不会创建新的数组</p><pre class="line-numbers language-js"><code class="language-js">arrObj<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[4,5,1]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="sort"><a href="#sort" class="headerlink" title="sort()"></a>sort()</h3><p>该方法用于对数组的元素进行排序</p><p>注意：该方法是按照字符编码顺序进行排序，如果想要实现业务逻辑排序需要自定义比较函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrObjSort <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arrObjSort1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arrObjSort<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,2,3,4,5]</span>arrObjSort1<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1, 10, 2, 20, 3, 30, 4, 5, 50]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>自定义排序</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">__sortNumber</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token keyword">return</span> a<span class="token operator">-</span>b<span class="token punctuation">;</span><span class="token punctuation">}</span>arrObjSort1<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>__sortNumber<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1, 2, 3, 4, 5, 10, 20, 30, 50]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString()"></a>toString()</h3><p>该方法可把数组转换为字符串，并返回结果，与不带参数的join相同</p><pre class="line-numbers language-js"><code class="language-js">arrObjSort1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//"1,2,3,4,5,10,20,30,50"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>toLocaleString-该方法可数组转换为本地字符串。和toString基本相同，但toLocaleString调用的是地区特定的分隔符把生成的字符串连接起来。<br></p><p>如果你开发的脚本在世界范围都有人使用,那么将对象转换成字符串时请使用toString()方法<br></p><p>因为LocaleString()会根据你机器的本地环境来返回字符串,它和toString()返回的值在不同的本地环境下使用的符号会有微妙的变化<br></p><p>如果是为了返回时间类型的数据,推荐使用LocaleString().若是在后台处理字符串,请务必使用toString()<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> myArr <span class="token operator">=</span> <span class="token punctuation">[</span>date<span class="token punctuation">,</span><span class="token string">'go home'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>myArr<span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//"2017/11/7 下午4:35:43,go home"</span>myArr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//"Tue Nov 07 2017 16:36:25 GMT+0800 (CST),go home"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="indexOf"><a href="#indexOf" class="headerlink" title="indexOf()"></a>indexOf()</h3><p>该方法可确定某个元素在数组实例中第一次出现的索引位置。如果没找到返回-1,可用索引值进行逻辑判断</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//1</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//-1</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//-1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查找元素出现的位置索引<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>  index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>判断一个元素是否在数组里，不在则向数组中添加元素<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">__upDataCollection</span><span class="token punctuation">(</span>arrCollection<span class="token punctuation">,</span>indicesEle<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> matchIndex <span class="token operator">=</span>  arrCollection<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>indicesEle<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>matchIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>indicesEle<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'元素中存在相同的值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">__upDataCollection</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1, 2, 3, 4, 5, 6, 7, 8]</span><span class="token function">__upDataCollection</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//'元素中存在相同的值'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="forEach"><a href="#forEach" class="headerlink" title="forEach()"></a>forEach()</h3><p>该方法按升序为数组中含有效值的每一项执行一次callback 函数（遍历数组）</p><p><code>forEach()</code> 为每个数组元素执行callback函数；不像<code>map()</code> 或者<code>reduce()</code> ，它总是返回 <code>undefined</code>值，也没有办法终止或跳出正在运行循环的<code>forEach</code>。如果常规的遍历想要检测条件返回bool , 并且可以终止循环，可使用<code>Array.some,Ayyay.every</code>.或者es6新方法<code>Array.find()</code>等等</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arrayObj<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> index<span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">{</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"value["</span> <span class="token operator">+</span> index <span class="token operator">+</span> <span class="token string">"] = "</span> <span class="token operator">+</span> element<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//value[0] = 1</span><span class="token comment" spellcheck="true">//value[1] = 2</span><span class="token comment" spellcheck="true">//value[2] = 3</span><span class="token comment" spellcheck="true">//value[4] = 5</span><span class="token comment" spellcheck="true">//可以观察到以上遍历并没有出现undefind</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="map"><a href="#map" class="headerlink" title="map()"></a>map()</h3><p>该方法会给原数组中的每个元素都按顺序调用一次 callback 函数。callback 每次执行后的返回值（包括 undefined）组合起来形成一个新数组，并且不修改调用它的原数组本身（当然可以在 callback 执行时改变原数组）</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//常用的有些业务场景需要重新重组数组对象</span><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'wangwu'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">26</span><span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> newArrayObj <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> index<span class="token punctuation">,</span> array<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   newObj<span class="token punctuation">[</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">.</span>age<span class="token punctuation">;</span>   <span class="token keyword">return</span> newObj<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArrayObj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[{'zhangsan':20},{'lisi':30},{'wangwu':26}]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="filter"><a href="#filter" class="headerlink" title="filter()"></a>filter()</h3><p>该方法创建一个新数组,通过次函数方法会返回相应的过滤后的数据,并且不会改变原数组</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> newArrayObj <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>index<span class="token punctuation">,</span>array<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token keyword">return</span> value <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArrayObj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[4, 5, 6]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce()"></a>reduce()</h3><p>为数组中的每一个元素依次执行callback函数，不包括数组中被删除或从未被赋值的元素,返回函数累计处理的结果</p><p><code>callback</code>执行数组中每个值的函数，包含四个参数：<br></p><p><code>accumulator</code>累加器累加回调的返回值; 它是上一次调用回调时返回的累积值，或initialValue（如下所示）。<br></p><p><code>currentValue</code>数组中正在处理的元素。<br></p><p><code>currentIndex</code>数组中正在处理的当前元素的索引。<br></p><p>如果提供了initialValue，则索引号为0，否则为索引为1。array调用reduce的数组initialValue[可选] 用作第一个调用 callback的第一个参数的值。<br></p><p>如果没有提供初始值，则将使用数组中的第一个元素。 在没有初始值的空数组上调用 reduce 将报错。<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> totalValue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>sum<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> sum <span class="token operator">+</span> value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// totalValue  6</span><span class="token comment" spellcheck="true">//将二维数组转化为一维数组</span><span class="token keyword">var</span> flattened <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>    <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// flattened is [0, 1, 2, 3, 4, 5] </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="some"><a href="#some" class="headerlink" title="some()"></a>some()</h3><p>该方法用于检测数组中的某些元素是否通过callback函数实现的方法。返回bool值</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> flag <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>index<span class="token punctuation">,</span>array<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> element <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="every"><a href="#every" class="headerlink" title="every()"></a>every()</h3><p>该方法用于检测数组中的所有元素是否通过callback函数实现的方法。返回bool值</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> flag <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>index<span class="token punctuation">,</span>array<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> element <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="扩展运算符-…"><a href="#扩展运算符-…" class="headerlink" title="扩展运算符(…)"></a>扩展运算符(…)</h3><p>该运算符将一个数组转为用逗号分隔的参数序列</p><p>扩展运算符即可以复制，合并数组，操作分割字符串与结构赋值结合还可以当函数的形参<br></p><pre class="line-numbers language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//1 2 3 4 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>合并数组：<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> arrayObj1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> newArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arrayObj<span class="token punctuation">,</span><span class="token operator">...</span>arrayObj1<span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArray<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//[1, 2, 3, 4, 5, 6, 7, 8, 9]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>复制数组：<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> arrayObjNew <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arrayObj<span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrayObjNew<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//[1,2,3,4,5];</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>与结构赋值结合：<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>variable<span class="token punctuation">,</span> <span class="token operator">...</span>array<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>variable<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[2,3,4,5]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>函数形参：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//例子1:</span><span class="token keyword">let</span> _arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> _arrayObj1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> __operationArr <span class="token operator">=</span> <span class="token punctuation">(</span>array<span class="token punctuation">,</span>items<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    array<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[1,1,2,3,4,5]</span><span class="token punctuation">}</span><span class="token function">__operationArr</span><span class="token punctuation">(</span>_arrayObj<span class="token punctuation">,</span>_arrayObj1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//例子2:</span><span class="token keyword">var</span> __add <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">,</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c <span class="token operator">+</span>d <span class="token operator">+</span> e<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">__add</span><span class="token punctuation">(</span><span class="token operator">...</span>_arrayObj1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//15</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>求出数组最大元素：<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>arrayObj<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="form"><a href="#form" class="headerlink" title="form()"></a>form()</h3><p>该法从一个类似数组或可迭代对象中创建一个新的数组实例，相当于相当于[].slice.call()</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//例子1:</span><span class="token keyword">let</span> arrayItems <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>    <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span>    <span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token string">'wangwu'</span><span class="token punctuation">,</span>    length<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ES5的写法</span><span class="token keyword">var</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arrayItems<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ['zhangsan', 'lisi', 'wangwu']</span><span class="token comment" spellcheck="true">// ES6的写法</span><span class="token keyword">let</span> arr2 <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>arrayItems<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ['zhangsan', 'lisi', 'wangwu']</span>例子<span class="token number">2</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">// 常见的DOM NodeList对象</span><span class="token keyword">let</span> ps <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> pElementArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>pElementArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将字符串分割字后变为数组<br></p><pre class="line-numbers language-js"><code class="language-js">Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//['f','o','o']</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="of"><a href="#of" class="headerlink" title="of()"></a>of()</h3><p>该方法创建一个具有可变数量参数的新数组实例，而不考虑参数的数量或类型</p><p>Array.of() 和 Array 构造函数之间的区别在于处理整数参数：Array.of(7) 创建一个具有单个元素 7 的数组，而 Array(7) 创建一个包含 7 个 undefined 元素的数组。<br></p><pre class="line-numbers language-js"><code class="language-js">Array<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// [7] </span>Array<span class="token punctuation">.</span><span class="token keyword">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1, 2, 3]</span><span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// [ , , , , , , ]</span><span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// [1, 2, 3]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="copyWithin"><a href="#copyWithin" class="headerlink" title="copyWithin()"></a>copyWithin()</h3><p>该方法浅复制数组的一部分到同一数组中的另一个位置，并返回它，而不修改其大小</p><p>arr.copyWithin(target)<br></p><p>arr.copyWithin(target, start)<br></p><p>arr.copyWithin(target, start, end)<br></p><p>arr.copyWithin(目标索引, [源开始索引], [结束源索引])<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// [1, 2, 3, 1, 2]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// [4, 5, 3, 4, 5]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// [4, 2, 3, 4, 5]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// [1, 2, 3, 3, 4]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copyWithin<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span>length<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// {0: 1, 3: 1, length: 5}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="find"><a href="#find" class="headerlink" title="find()"></a>find()</h3><p>该方法返回数组中满足提供的callback的第一个元素的值。否则返回 undefined</p><p>如果你需要找到一个元素的位置或者一个元素是否存在于数组中，使用<code>Array.prototype.indexOf()</code> 或 <code>Array.prototype.includes()</code>。</p><p>如果你需要找到元素的索引，而不是其值<code>Array.prototype.findIndex()</code>;</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> arrayObj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> backValue <span class="token operator">=</span> arrayObj<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">return</span> element <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>backValue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//60</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="fill"><a href="#fill" class="headerlink" title="fill()"></a>fill()</h3><p>该方法用一个固定值填充一个数组中从起始索引到终止索引内的全部元素</p><p>语法：<br><br>arr.fill(value) <br><br>arr.fill(value, start) <br><br>arr.fill(value, start, end)<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// [4, 4, 4]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true">// [1, 4, 4]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// [1, 4, 3]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// [1, 2, 3]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// [4, 2, 3]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// [1, 2, 3]</span><span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// [4, 4, 4]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fill<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span>length<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {0: 4, 1: 4, 2: 4, length: 3}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="entries"><a href="#entries" class="headerlink" title="entries()"></a>entries()</h3><p>该方法返回一个新的Array Iterator对象，该对象包含数组中每个索引的键/值对</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> iterator <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// undefined</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Array Iterator {}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [0, "a"]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1, "b"]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [2, "c"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="includes"><a href="#includes" class="headerlink" title="includes()"></a>includes()</h3><p>该方法用来判断一个数组是否包含一个指定的值，如果是，酌情返回 true或 false</p><p>语法：<br><br>arr.includes(searchElement)<br><br>arr.includes(searchElement, fromIndex)<br></p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// true</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// false</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// false</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面向对象之继承</title>
      <link href="/2019/03/15/javascript/inheritance/"/>
      <url>/2019/03/15/javascript/inheritance/</url>
      
        <content type="html"><![CDATA[<p>原型链虽然很强大，也可以用它来实现继承，但是总会有这样那样的问题。其中最主要的问题是原型链的引用问题。下面借鉴JS高程中的几种方式来学习JS继承,JS继承也是面向对象（oo）编程，但不使用类或者接口，而是使用创建对象的形式。虽然在ES6中实现了Class但其实只是语法糖，原理依然是<strong>proto</strong>。在JS超集中（TypeScript）用类与接口实现继承，会在后续文章中学习记录。</p><h3 id="原型链继承"><a href="#原型链继承" class="headerlink" title="原型链继承"></a>原型链继承</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Parent <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zhansan'</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> Child <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// zhangsan</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  问题</p><ul><li>引用类型的值的原型属性会被所有实例共享</li><li>在创建子类型的实例时不能向超类型的构造函数传参（没法办在不影响所有对象实例的情况下传参）</li></ul><h3 id="借用构造函数继承（经典继承）"><a href="#借用构造函数继承（经典继承）" class="headerlink" title="借用构造函数继承（经典继承）"></a>借用构造函数继承（经典继承）</h3><p>在子类构造函数内部调用超类型构造函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Parent <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> Child <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'wangyu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ['zhangsan', 'lisi' ,'wangyu']</span><span class="token keyword">var</span> child1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child1<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//  ['zhangsan', 'lisi']</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>优点：解决了原型链继承的问题</p><p>缺点：方法都在构造函数中定义，函数无法复用，创建实例时方法都会被创建一遍</p><h3 id="组合继承（伪经典继承）"><a href="#组合继承（伪经典继承）" class="headerlink" title="组合继承（伪经典继承）"></a>组合继承（伪经典继承）</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Parent <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> Child <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token string">'20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'black'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// zhangsan</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 20</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>colors<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ["red", "blue", "green", "black"]</span><span class="token keyword">var</span> child1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token string">'28'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// lisi</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 28</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span>colors<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ["red", "blue", "green"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>优点：融合原型链继承和构造函数的优</p><p>缺点：调用多次超类构造函数</p><h3 id="原型式继承（道格拉斯）"><a href="#原型式继承（道格拉斯）" class="headerlink" title="原型式继承（道格拉斯）"></a>原型式继承（道格拉斯）</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createObj</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  F<span class="token punctuation">.</span>prototype <span class="token operator">=</span> o<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">'zhansan'</span><span class="token punctuation">,</span>  hobbies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'swimming'</span><span class="token punctuation">,</span> <span class="token string">'reading'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token function">createObj</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token function">createObj</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>person1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'person'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// zhangsan</span>person2<span class="token punctuation">.</span>hobbies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'running'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">.</span>hobbies<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ["swimming", "reading", "running"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>缺点：引用类型的值的原型属性会被所有实例共享</p><h3 id="寄生式继承（道格拉斯升级版）"><a href="#寄生式继承（道格拉斯升级版）" class="headerlink" title="寄生式继承（道格拉斯升级版）"></a>寄生式继承（道格拉斯升级版）</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> createObj <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> clone <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>  clone<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> clone<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>缺点：跟借用构造函数模式一样，创建实例时方法都会被创建一遍</p><h3 id="寄生组合式继承"><a href="#寄生组合式继承" class="headerlink" title="寄生组合式继承"></a>寄生组合式继承</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">inheritPrototype</span><span class="token punctuation">(</span>Child<span class="token punctuation">,</span> Parent<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>  prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span>  Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> prototype<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"red"</span><span class="token punctuation">,</span> <span class="token string">"blue"</span><span class="token punctuation">,</span> <span class="token string">"green"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">{</span>  Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">inheritPrototype</span><span class="token punctuation">(</span>Child<span class="token punctuation">,</span> Parent<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//实现继承</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayAge <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>优点：保证了原型链链路的正确性,没有多余的属性等优点，所以最为理想的ES5继承</p><h3 id="ES6继承"><a href="#ES6继承" class="headerlink" title="ES6继承"></a>ES6继承</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//class 相当于es5中构造函数</span><span class="token comment" spellcheck="true">//class中定义方法时，前后不能加function，全部定义在class的protopyte属性中</span><span class="token comment" spellcheck="true">//class中定义的所有方法是不可枚举的</span><span class="token comment" spellcheck="true">//class中只能定义方法，不能定义对象，变量等</span><span class="token comment" spellcheck="true">//class和方法内默认都是严格模式</span><span class="token comment" spellcheck="true">//es5中constructor为隐式属性</span><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'wang'</span><span class="token punctuation">,</span>age<span class="token operator">=</span><span class="token string">'27'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> eat food`</span></span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//继承父类</span><span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span><span class="token punctuation">{</span>   <span class="token function">constructor</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'ren'</span><span class="token punctuation">,</span>age <span class="token operator">=</span> <span class="token string">'27'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//继承父类属性</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>     <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//继承父类方法</span>      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">let</span> child <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'xiaoxiami'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> child<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>优点</p><ul><li>在语法糖下代码量明显减少，和ES6区别ES5继承首先是在子类中创建自己的this指向，最后将方法添加到this中</li></ul><pre class="line-numbers language-js"><code class="language-js">Child<span class="token punctuation">.</span>prototype<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Parent<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">||</span> Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>es6继承是使用关键字先创建父类的实例对象this，最后在子类class中修改this</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>原型及原型链</title>
      <link href="/2019/03/10/javascript/prototype/"/>
      <url>/2019/03/10/javascript/prototype/</url>
      
        <content type="html"><![CDATA[<h3 id="普通对象和函数对象"><a href="#普通对象和函数对象" class="headerlink" title="普通对象和函数对象"></a>普通对象和函数对象</h3><pre class="line-numbers language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// 普通对象</span>  <span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   <span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> obj3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 函数对象</span>  <span class="token keyword">function</span> <span class="token function">person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   <span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">,</span><span class="token string">'console.warn(aaaa)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Object<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Function<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> person1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//function  </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// true </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//object </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//object </span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//object</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj3 <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过以上实例我们知道 new Function 构建的都是函数对象(关于普通函数与new Function的区别请参考 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank" rel="noopener">mozilla开发者</a>), 其余都是普通对象,关于Object与Function的区别会在这章节最后总结</p><h3 id="通过构造函数模式创建对象"><a href="#通过构造函数模式创建对象" class="headerlink" title="通过构造函数模式创建对象"></a>通过构造函数模式创建对象</h3><p>在js高程中我们知道创建对象有很多种模式如下</p><ul><li>工厂模式</li><li>构造函数模式</li><li>原型模式</li><li>组合使用构造函数和原型模式</li><li>动态原型模式</li><li>寄生构造函数模式</li><li>稳妥构造函数模式</li></ul><p>当然这几种模式在这里暂时不展开说明，后续继承的时候在分别用讨论，我们这里简单的回忆一下用构造函数创建对象</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'zhansan'</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="proto-prototype-constructor"><a href="#proto-prototype-constructor" class="headerlink" title="proto,prototype,constructor"></a><strong>proto</strong>,prototype,constructor</h3><ul><li><code>__proto__</code>:在JavaScript权威指南中指出每个js对象一定对应一个原型对象，并从原型对象继承属性和方法。</li><li><code>prototype</code>: 当创建函数对象时，js会自动为这个函数添加prototype属性（<strong>这里明确一下只有函数对象才会有此属性</strong>）</li><li>每个原型都有一个 constructor 属性指向关联的构造函数。</li></ul><p>通过上述三点我们针对2中的代码解释为</p><p>当创建<code>Person</code>函数时，js会自动为该函数创建<code>prototype</code>属性，这个属性指向函数的原型对象，函数的原型对象（<code>Person.prototype</code>）会自动获取一个<code>constructor</code>属性指向关联的Person。当我们通过new关键字调用时，js就会创建该构造函数的实例<code>person1</code>或<code>person2</code>，此时我们就可以通过<code>prototype</code>来存储要共享的属性和方法</p><p>下面我们通过图例来说明我们上面的文字</p><p><image src="/images/Person.png"></image></p><p>这里我们注意虽然person1和person2这两个个实例都不包含属性和方法，但是我们可以通过查找对象属性来实现调用person1.sayName()</p><p>此时我们来确定两个实例对象返回的原型指针是否一样(<strong>Object.getPrototypeOf 此方法可以获取对象的原型</strong>)</p><pre class="line-numbers language-js"><code class="language-js">Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>person1<span class="token punctuation">)</span> <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototype <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>person1<span class="token punctuation">)</span> <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototype <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>通过如上输出结果得知他们内部都有一个指向Person.prototype的指针也就是</p><pre class="line-numbers language-js"><code class="language-js">person1<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototypeperson2<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototype<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>经过上面解释这么多我们得出的结果就是如下 </p><pre class="line-numbers language-js"><code class="language-js">person1<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> Person<span class="token punctuation">.</span>prototypePerson<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">==</span> Person<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><ul><li>js几乎所有对象都是Object; 典型对象继承属性（包括方法）</li><li>所有引用类型的原型链上必然存在Object的原型</li><li>new Object 出来的实例是普通对象我们前面说过只有函数对象才有prototype</li><li>Object 实际是function Object跟function Function 类似</li><li>Object.prototype是Object构造函数的属性。它也是原型链的终结</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Object <span class="token punctuation">(</span>name<span class="token punctuation">,</span>age<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span>Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span>object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>object<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们通样以图例的形式来说明Object的<strong>proto</strong>,prototype,constructor</p><p><image src="/images/Object.png"></image></p><p>通过以上图例我们得出结论<code>Object.prototype.__proto__ === null</code></p><p>这里面扩展一下null和undefined区别</p><ul><li>null === undefined为false，null == undefined为true 说明只是值相等</li><li>null是一个表示”无”的对象，转为数值时为0；undefined是一个表示”无”的原始值，转为数值时为NaN。</li><li>null表示变量未指向任何对象，undefined表示变量被声明但是没有被赋值</li></ul><h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><ul><li>在js中每个函数实际上都是一个Function对象。</li><li>使用Function构造器生成的Function对象是在函数创建时解析的,而其他函数方式是跟其他代码一起解析，所以较为低效</li><li>全局的Function对象没有自己的属性和方法，通过Function.prototype上继承部分属性和方法。</li><li>我们说js中万物皆对象，Function也也是对象，只不过是函数对象所以<code>Function.prototype.__proto__</code>指针指向<code>Object.prototype</code></li><li><code>Object.__proto__</code> 指针指向<code>Function.prototype</code></li></ul><p><strong>Function创建的函数一般在全局作用域中被创建，但并不会像其他函数一样产生闭包，所以只能自己内部和全局的变量</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Function <span class="token punctuation">(</span>name<span class="token punctuation">,</span>age<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name  <span class="token operator">=</span> name  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">}</span>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span>f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>f<span class="token punctuation">.</span>sayName <span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们同样以图例的形式来说明Function的<strong>proto</strong>,prototype,constructor</p><p><image src="/images/Function.png"></image></p><p>通过以上图例我们得出结论<code>Object.prototype === Function.prototype.__proto__</code></p><h3 id="将Function，Object，Person链接起来"><a href="#将Function，Object，Person链接起来" class="headerlink" title="将Function，Object，Person链接起来"></a>将Function，Object，Person链接起来</h3><p>此时我们同样通过图例的形式将上面整合起来。来看看整个链路是什么样子</p><p><image src="/images/prototype.png"></image></p><p> 通过以上图例我们可以观察到其实js原型链就是由相互关联的链条组成，查找属性或者方法的过程就是图中红色链条的过程，如果找到则终止否则直到返回null</p><p><code>person1</code> &gt; <code>person1.__proto__</code> &gt; <code>Person.prototype</code> &gt; <code>Person.prototype.__proto__</code> &gt; <code>Object.prototype</code> &gt; <code>Object.prototype.__proto__</code> &gt; <code>null</code></p><p>最后我们来看一下Object和Function的关系，上面已经提到<code>Object.prototype === Function.prototype.__proto__</code></p><ul><li><code>Function.__proto__</code> &gt; <code>Function.prototype</code> &gt; <code>Function.prototype.__proto__</code> &gt; <code>Object.prototype</code> –&gt; <code>Object.prototype.__proto__</code> –&gt; ‘null’;简写为<code>Function.__proto__.__proto__.__proto__</code> &gt; <code>null</code></li><li><code>Object.__proto__</code> &gt; <code>Funtion.prototype</code> &gt; <code>Function.prototype.__proto__</code> &gt; <code>Object.prototype</code> &gt;<code>Object.prototype.__proto__</code> &gt; <code>null</code>;简写为<code>Object.__proto__.__proto__.__proto__</code> &gt; <code>null</code></li></ul><p>通过上面我们可以得出结论</p><ul><li>只有函数对象才有 prototype，但是每个对象（普通对象和函数对象）都拥有<strong>proto</strong>属性</li><li>原型对象都有一个 constructor 属性指向它们的构造函数（也就是自己）</li><li>原生对象既是对象，也是构造函数</li><li>实例对象的隐式原型始终指向构造函数的显式原型（<code>person1.__proto__</code> &gt; <code>Person.prototype</code>）</li><li>原型链的查找过程链接依赖 <strong>proto</strong> 指针逐级向上，并且原型链的尽头始终为null</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>this</title>
      <link href="/2019/03/05/javascript/this/"/>
      <url>/2019/03/05/javascript/this/</url>
      
        <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念<hr></h3><p>当一个函数被创建的时候，会创建一个活动对象（执行上下文EC），这里面包含了函数的调用栈，函数的调用方式、传入的参数等信息，this就是执行上下文的一个属性，会在函数执行过程中用到</p><h3 id="绑定规则"><a href="#绑定规则" class="headerlink" title="绑定规则"></a>绑定规则<hr></h3><p>默认绑定、隐式绑定、apply,call、new绑定。优先级从低到高</p><h3 id="默认绑定"><a href="#默认绑定" class="headerlink" title="默认绑定"></a>默认绑定<hr></h3><pre class="line-numbers language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//window</span><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 非严格模式下1 ，严格模式下undefined</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="隐式调用"><a href="#隐式调用" class="headerlink" title="隐式调用"></a>隐式调用<hr></h3><p>作为对象方法调用，this 指代上下文对象</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>   a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>  fun<span class="token punctuation">:</span> fun <span class="token punctuation">}</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span><span class="token keyword">var</span> c <span class="token operator">=</span> obj<span class="token punctuation">.</span>fun<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="apply-call"><a href="#apply-call" class="headerlink" title="apply,call"></a>apply,call<hr></h3><p>改变对象的prototype关联对象来改变this,对于null，undefined绑定会失效</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>   a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>   a<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj2 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>fun<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> undefined <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="作为构造函数调用"><a href="#作为构造函数调用" class="headerlink" title="作为构造函数调用"></a>作为构造函数调用<hr></h3><p>this 指代new 出的对象<br>使用new来调用函数，会自动执行如下操作：</p><ul><li>创建一个全新的对象。</li><li>这个新对象会被执行[[原型]]连接。</li><li>这个新对象会绑定到函数调用的this。</li><li>如果函数没有返回其他对象,那么new表达式中的函数调用会自动返回这个新对象。<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fun</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fun</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="es6中箭头函数this指向"><a href="#es6中箭头函数this指向" class="headerlink" title="es6中箭头函数this指向"></a>es6中箭头函数this指向<hr></h3><p>  取决于外层（函数或全局）作用域。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>  this判断机制</p><ul><li>函数是否在 new 中调用，如果是那么this 绑定的是新创建的对象</li><li>函数是否通过apply、call（显示绑定）、硬绑定调用，如果是,this指向的是指定的对象</li><li>函数否是在某个上下文中调用（隐式绑定），如果是this绑定的就是那个上下文对象</li><li>如果都不是 this 使用默认绑定规则是当前的全局对象，严格模式则是 undefined</li><li>如果 apply、call、bind 等传入的是 null,或者 undefined 则使用默认绑定</li><li>如果是 es6 那么 this 是根据外层作用域来决定的</li></ul>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>闭包</title>
      <link href="/2019/02/25/javascript/closure/"/>
      <url>/2019/02/25/javascript/closure/</url>
      
        <content type="html"><![CDATA[<p>说到闭包我们先来了解一下 JS 的作用域</p><h3 id="什么是作用域"><a href="#什么是作用域" class="headerlink" title="什么是作用域"></a>什么是作用域<hr></h3><p>作用域是根据名称查找变量的一套规则，负责收集并维护数据的声明和标识，通过一系列的声明和标识能够组成访问查询</p><h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类<hr></h3><ul><li>全局作用域</li><li>局部作用域</li><li>块级作用域</li></ul><p>那么作用域到底在哪里呢？我们先来了解一下除作用域外在 JS 中另外两个比较重要的东西编译器和引擎</p><p>编译器：负责代码的编译等工作，它有三个阶段</p><ul><li>词法分析: 把咱们的代码分析成词法单元（token令牌的形式）</li><li>语法分析: 将上一个阶段组成的词法单元组成，词法单元流的形式，形成逐级嵌套的形式这个阶段也叫（AST抽象语法树）</li><li>代码生成: 将抽象语法树进行对比生成我们要执行的代码块</li></ul><p>引擎：负责编译和代码的执行等工作，执行的过程是</p><ul><li>在全局代码执行前, js引擎就会创建一个栈来存储管理所有的执行上下文对象</li><li>在全局执行环境(window)确定后, 将其push到栈中</li><li>在函数执行环境创建后, 将其push到栈中</li><li>在当前函数执行完后,将栈顶的对象pop</li><li>当所有的代码执行完后, 栈中只剩下window</li></ul><p>js初始化执行的时候会首先生成 GC 全局执行上下文，，生成必要的对象[objects] 和 [function]。会对他进行压栈操作，放到栈底。如果有很多函数会生成很多个 EC（执行上下文），每一个 EC 进行压栈操作形成 ESC（上下执行栈）。</p><h3 id="上下文执行环境（EC）"><a href="#上下文执行环境（EC）" class="headerlink" title="上下文执行环境（EC）"></a>上下文执行环境（EC）<hr></h3><p>概念：执行环境定义了变量或者函数有权访问的其他数据，决定了各自的行为</p><p>组成部分：</p><ul><li>变量对象（varible object）：存放当前执行环境中定义的变量和函数，<strong>如果当前环境是函数则将活动对象（activation object）作为变量对象，但不包括函数表达式</strong></li><li>作用域链（scope）：当代码在执行环境中运行时，会创建<strong>变量对象</strong>的一个<strong>作用域链（词法作用域）</strong>，能够保证对执行环境中所有变量和函数有序访问</li><li>this指向：根据调用的规则不同this指向不同产生的执行环境上下文不同</li></ul><p>EC 的执行生命周期：</p><ul><li>创建阶段<ul><li>创建变量对象阶段（存储的与上下相关的数据作用域，它是一个特殊的对象包含着上下文的变量、函数声明（函数表达式不再vo中）</li><li>创建作用域链（scope）</li><li>创建 this 指向（thisValue）</li></ul></li><li>执行阶段<br>创建活动对象 ao（是一个活动对象，当函数被调用者激活的时候，这个特殊的 ao 就被创建了（函数表达式不再ao中））</li><li>回收阶段<br>执行完毕后垃圾回收机制进行回收</li></ul><p>EC 和 Scope 的区别：</p><ul><li>创建时机不同，全局执行上下文是在全局作用域确定后js代码执行前创建的而函数执行上下文是在调用函数时, 函数体代码执行之前创建</li><li>作用域是静态的，执行上下文是动态的</li></ul><h3 id="作用域链"><a href="#作用域链" class="headerlink" title="作用域链"></a>作用域链<hr></h3><ul><li>从内到外多个作用域形成的链</li><li>包含父级(<strong>[[scope]]</strong>)变量对象与作用域链和自身的变量对象</li></ul><h3 id="闭包概念"><a href="#闭包概念" class="headerlink" title="闭包概念 "></a>闭包概念 <hr></h3><p>当函数可以记住并访问所在的词法作用域时就产生了闭包，即使是在作用域外执行</p><h3 id="闭包作用"><a href="#闭包作用" class="headerlink" title="闭包作用 "></a>闭包作用 <hr></h3><p>匿名自执行函数,减少内存消耗</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>$<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>jQuery<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>缓存计算结果</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> fun1 <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      a<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token function">alert</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2       </span>  <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3           </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>封装,管理私有方法和变量，避免全局变量冲突污染</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">"renbo"</span><span class="token punctuation">;</span>           <span class="token keyword">return</span> <span class="token punctuation">{</span>          getName <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> name<span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>          setName <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>newName<span class="token punctuation">)</span><span class="token punctuation">{</span>            name <span class="token operator">=</span> newName<span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实现类和继承等等</p><h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景 "></a>应用场景 <hr></h3><ul><li>定时器、事件监听器、Ajax 请求，跨窗口通信，DOM事件的点击等</li><li>常用的就是IIFE 能够防止变量污染等作用</li></ul><h3 id="闭包缺点"><a href="#闭包缺点" class="headerlink" title="闭包缺点 "></a>闭包缺点 <hr></h3><ul><li>由于变量对象（ao）一直在内存中被外部变量引用不能被垃圾回收机制释放，导致内存过高。</li><li>由于多个函数共享一个父级，当父级有变量更改时，所有子函数受影响</li></ul><h3 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h3><p><a href="https://www.cnblogs.com/TomXu/archive/2012/01/12/2308594.html" target="_blank" rel="noopener">汤姆大叔的博客</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>变量提升</title>
      <link href="/2019/02/20/javascript/variableascension/"/>
      <url>/2019/02/20/javascript/variableascension/</url>
      
        <content type="html"><![CDATA[<h2 id="变量提升"><a href="#变量提升" class="headerlink" title="变量提升"></a>变量提升</h2><h3 id="执行步骤"><a href="#执行步骤" class="headerlink" title="执行步骤"></a>执行步骤<hr></h3><p>js代码虽然是逐行向下执行的，但执行的时候分为两个步骤**</p><ul><li>编译阶段（词法解释/预解释）</li><li>执行</li></ul><h3 id="编译阶段"><a href="#编译阶段" class="headerlink" title="编译阶段"></a>编译阶段<hr></h3><p>函数声明和变量声明总是会被解释器(编译阶段)悄悄地被“提升”到最顶部，最后执行</p><h3 id="解析顺序"><a href="#解析顺序" class="headerlink" title="解析顺序"></a>解析顺序</h3><ul><li>this和arguments（语言内置）</li><li>函数的形式参数</li><li>函数声明</li><li>变量声明</li></ul><h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级<hr></h3><p>函数的声明比变量的声明的优先级要高</p><h3 id="es6中let关键字及块及作用域"><a href="#es6中let关键字及块及作用域" class="headerlink" title="es6中let关键字及块及作用域"></a>es6中let关键字及块及作用域<hr></h3><pre class="line-numbers language-js"><code class="language-js">  a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> a<span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo</span>  <span class="token comment" spellcheck="true">// 编译后的代码</span>  <span class="token keyword">var</span> a<span class="token punctuation">;</span>  a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 编译后的代码</span>  <span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a<span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo undefined zhangsan</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="函数提升"><a href="#函数提升" class="headerlink" title="函数提升"></a>函数提升</h2><pre class="line-numbers language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// 两种函数的书写方式</span>  <span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//函数表达式</span>  <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//函数声明方式 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>  只有声明方式的函数才会有函数提升</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">'renbo'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 编译后</span>  <span class="token keyword">function</span> test <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 在函数作用域内，被提升最前面</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefined</span>    a <span class="token operator">=</span> renbo<span class="token punctuation">;</span>   <span class="token punctuation">}</span>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据类型</title>
      <link href="/2019/02/12/javascript/type/"/>
      <url>/2019/02/12/javascript/type/</url>
      
        <content type="html"><![CDATA[<h2 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型<hr></h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>  基本数据类型是按值进行进行访问，变量是放在栈（stack）内存里</p><h3 id="种类"><a href="#种类" class="headerlink" title="种类"></a>种类</h3><p>  Undefined、Null、Boolean、String、Number、Symbol（es6）</p><p>  基本数据类型的值是不可变的</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"renbo"</span><span class="token punctuation">;</span>  str<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// RENBO</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// renbo</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>  按值进行比较</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">===</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>  虽然数据类型不相同（true为bool,1为Number)但在比较之前js自动进行了数据类型的隐式转换</p><p>  == 是进行值比较所以为true</p><p>  === 不仅比较值还要比较数据类型所以为false</p><p>  栈内存中保存了变量的标识符和变量的值</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a<span class="token punctuation">,</span>b<span class="token punctuation">;</span>  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  b <span class="token operator">=</span> a<span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>  a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  <image src="/images/javascript-stack.png"></image></p><h2 id="引用数据类型"><a href="#引用数据类型" class="headerlink" title="引用数据类型"></a>引用数据类型<hr></h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>  引用类型的值是保存在堆内存（Heap）中的对象（Object）</p><h3 id="种类-1"><a href="#种类-1" class="headerlink" title="种类"></a>种类</h3><p>  统称为Object，细分有：Object，Array，Function，Data，RegExp等</p><p>  引用类型的值式可变化的</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'renbo'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>  obj<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  obj<span class="token punctuation">.</span>say <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">'My name is'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'I‘m'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token operator">+</span> <span class="token string">'years old'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  obj<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//My name is zhangsan I‘m 28 years old</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  按引用地址比较</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> obj1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj <span class="token operator">===</span> obj1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>  栈内存中保存了变量标识符和指向堆内存中该对象的指针</p><p>  堆内存中保存了对象的内容</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'renbo'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>  a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// zhangsan</span>  b<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>age<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 28</span>  b<span class="token punctuation">.</span>say <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">'My name is'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'I‘m'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token operator">+</span> <span class="token string">'years old'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//My name is zhangsan I‘m 28 years old</span>  <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">{</span>    name<span class="token punctuation">:</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span>    age<span class="token punctuation">:</span><span class="token number">28</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><image src="/images/javascript-stack1.png"></image></p><h3 id="类型检测"><a href="#类型检测" class="headerlink" title="类型检测"></a>类型检测</h3><p>  <strong>typeof</strong></p><p>  经常检查变量是不是基本数据类型</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a<span class="token punctuation">;</span>  a <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// string</span>  a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// boolean</span>  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// number </span>  a <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// object</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefined</span>  a <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// symbol</span>  a <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// function</span>  a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// object</span>  a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// object</span>  a <span class="token operator">=</span> <span class="token regex">/renbo/g</span><span class="token punctuation">;</span>  <span class="token keyword">typeof</span> a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// object   </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  <strong>instanceof</strong></p><p>  经常用来判断引用类型的变量具体是某种类型</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> a<span class="token punctuation">;</span>  a <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  a <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  a <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  a <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>  a <span class="token operator">=</span> <span class="token regex">/renbo/g</span><span class="token punctuation">;</span>  a <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span> <span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true    </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="数据类型转换"><a href="#数据类型转换" class="headerlink" title="数据类型转换"></a>数据类型转换<hr></h2><p>  上面所有 typeOf 返回值为 “object” 的对象都包含一个内部属性[[Class]], 我们也可以通过[[Class]]来判断数据的类型，相比 typeof 较为准确。这个属性一般通过 Object.prototype.toString.call(…) 来查看，例如</p><pre class="line-numbers language-js"><code class="language-js">  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'1,2,3'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object Array]</span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span><span class="token string">'mm'</span><span class="token punctuation">,</span>age<span class="token punctuation">:</span><span class="token number">24</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object Object]</span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object Function]</span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token regex">/regex/i</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object RegExp]</span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object Date]</span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object String]</span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// [object Number] </span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object Boolean]</span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object Null]</span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>undefined<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object Undefined]</span>  Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [object Symbol]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上面的例子中得出：</p><ul><li>对象的内部[[Class]]属性和创建该对象的内建原生构造相对应</li><li>基本类型值由于没有length、toString()这样的方法需要<code>封装对象</code>才能访问，这时候引擎为基本类型包装一个封装对象俗称<code>装箱</code></li></ul><p><em>装箱：是指将基本数据类型转换为对应的引用类型的操作。装箱分为隐式装箱和显示装箱</em></p><p>所以当我们写如下代码时, TMM 被包装成 <code>String(&#39;TMM&#39;)</code>。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token string">'TMM'</span><span class="token punctuation">;</span>a<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//tmm</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>引擎为什么要这么做呢？</p><ul><li>开发使用更方便</li><li>使用基本数据类型操作内存更方便</li></ul><p>再来看下面的例子</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boolean</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>a<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 'abc'</span>b<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 42</span>c<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面例子是将封装对象转换为基本数据类型这种俗称拆箱，通常通过引用类型的 <code>valueOf()</code> 和 <code>toString()</code> 方法来实现</p><p><strong>强制类型转换</strong></p><ul><li>类型转换发生在静态类型语言的编译阶段</li><li>强制类型转换发生在动态类型语言的运行时(runtime)</li><li>强制类型转换分为隐式转换和显示转换</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token keyword">var</span> b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token string">""</span> <span class="token comment" spellcheck="true">// 隐式强制类型转换</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 显示强制类型转换</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在介绍显示和隐式强制类型转换之前，我们先来了解一下 ToString、ToNumber、ToBoolean、ToPrimitive 的转换规则<br><strong>ToString 运算符根据下表将其参数转换为字符串类型的值</strong><br><image src="/images/type-to-string.jpg"></image></p><p><strong>ToNumber 抽象操作根据下表将其参数转换为数值类型的值</strong><br><image src="/images/type-to-number.jpg"></image></p><p><strong>ToBoolean 抽象操作根据下表将其参数转换为布尔值类型的值</strong><br><image src="/images/type-to-boolean.jpg"></image></p><p><strong>ToPrimitive 抽象操作根据下面转换规则</strong></p><ul><li>ToPrimitive 运算符把其值参数转换为非对象类型。</li><li>如果对象有能力被转换为不止一种原语类型，可以使用可选的期望类型来暗示那个类型</li><li>如果输入类型为 <code>undefined</code>,<code>null</code>、<code>Boolean</code>、<code>Number</code>、<code>String</code> 则结果等于输入的参数不进行转换</li><li>如果输入类型为对象，则返回改对象的默认值。调用改对象的内部方法<a href="https://www.w3.org/html/ig/zh/wiki/ES5/%E7%B1%BB%E5%9E%8B#DefaultValue-impl" target="_blank" rel="noopener">[[DefaultValue]]</a> 来恢复这个默认值，调用时传递暗示的期望类型</li></ul><p>下面我们看一下 ToPrimitive 相关源码</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ECMA-262, section 9.1, page 30. Use null/undefined for no hint,</span><span class="token comment" spellcheck="true">// (1) for number hint, and (2) for string hint.</span><span class="token keyword">function</span> <span class="token function">ToPrimitive</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> hint<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Fast case check.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_STRING</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> x<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Normal behavior.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_SPEC_OBJECT</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> x<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_SYMBOL_WRAPPER</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">MakeTypeError</span><span class="token punctuation">(</span>kSymbolToPrimitive<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hint <span class="token operator">==</span> NO_HINT<span class="token punctuation">)</span> hint <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">IS_DATE</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> STRING_HINT <span class="token punctuation">:</span> NUMBER_HINT<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>hint <span class="token operator">==</span> NUMBER_HINT<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">DefaultNumber</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">DefaultString</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ECMA-262, section 8.6.2.6, page 28.</span><span class="token keyword">function</span> <span class="token function">DefaultNumber</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_SYMBOL_WRAPPER</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> valueOf <span class="token operator">=</span> x<span class="token punctuation">.</span>valueOf<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_SPEC_FUNCTION</span><span class="token punctuation">(</span>valueOf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token operator">%</span><span class="token function">_CallFunction</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> valueOf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsPrimitive</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> v<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> toString <span class="token operator">=</span> x<span class="token punctuation">.</span>toString<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_SPEC_FUNCTION</span><span class="token punctuation">(</span>toString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token operator">%</span><span class="token function">_CallFunction</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> toString<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsPrimitive</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> s<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">throw</span> <span class="token function">MakeTypeError</span><span class="token punctuation">(</span>kCannotConvertToPrimitive<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ECMA-262, section 8.6.2.6, page 28.</span><span class="token keyword">function</span> <span class="token function">DefaultString</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_SYMBOL_WRAPPER</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> toString <span class="token operator">=</span> x<span class="token punctuation">.</span>toString<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_SPEC_FUNCTION</span><span class="token punctuation">(</span>toString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token operator">%</span><span class="token function">_CallFunction</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> toString<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsPrimitive</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> s<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> valueOf <span class="token operator">=</span> x<span class="token punctuation">.</span>valueOf<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_SPEC_FUNCTION</span><span class="token punctuation">(</span>valueOf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token operator">%</span><span class="token function">_CallFunction</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> valueOf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsPrimitive</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> v<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">throw</span> <span class="token function">MakeTypeError</span><span class="token punctuation">(</span>kCannotConvertToPrimitive<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们梳理一下上面代码的逻辑</p><ul><li>如果变量为字符串，直接返回</li><li>如果!IS_SPEC_OBJECT(x)，直接返回</li><li>如果IS_SYMBOL_WRAPPER(x)，则抛出异常</li><li>否则会根据传入的hint来调用 DefaultNumber 和 DefaultString，如果为 Date 对象，会调用 DefaultString<ul><li>DefaultNumber：首先x.valueOf，如果为primitive，则返回valueOf后的值，否则继续调用x.toString，如果为primitive，则返回toString后的值，否则抛出异常</li><li>DefaultString：和DefaultNumber正好相反，先调用toString，如果不是primitive再调用valueOf</li></ul></li></ul><p>看了 ToPrimitive 的源码和解释，那么它到底有什么作用呢？实际上很多操作会调用 ToPrimitive，比如加，相等、或者比较等，让我们来看一个例子</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment" spellcheck="true">// "[object Object]1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面代码会经历如下步骤</p><ul><li>{} 和 1 首先都会调用 ToPrimitive</li><li>{} 会走到 DefaultNumber，然后先调用valueOf 返回 Object{},不是primitive类型，然后然后继续走到 toString 返回 [object Object]，是 String 类型</li><li>最后加操作结果为[object Object]1</li></ul><p><strong>显式强制类型转换</strong></p><p>1、字符串和数字之间的显示转换</p><ul><li>通过String(..)和Number(..)这两个内建函数</li><li>相关运算符 <code>+</code>、<code>~</code>、<code>~~</code>等</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// "42" 根据上面ECMA 转换规则 ToString 得出</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token string">'3.14'</span><span class="token punctuation">;</span><span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 3.14 根据上面ECMA 转换规则 ToNumber 得出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 涉及隐式转换，因为 42 这样的基本类型值没有 toString()</span><span class="token comment" spellcheck="true">// 需要 JS 引擎装箱操作，然后调用 toString()</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// "42" </span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token string">"3.14"</span><span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token operator">+</span>c<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 3.14 +运算符显式地将c转换为数字</span><span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token number">5</span><span class="token operator">+</span> <span class="token operator">+</span>c  <span class="token comment" spellcheck="true">// 5+ 3.14 ==> 8.14  </span><span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token string">'5'</span><span class="token operator">+</span> <span class="token operator">+</span>c <span class="token comment" spellcheck="true">// '5'+ 3.14 ==> "53.14"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一元运算符+会将操作数<code>显式强制类型</code>转换为数字，而非数字加法运算（也不是字符串拼接）</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">~</span><span class="token number">42</span> <span class="token comment" spellcheck="true">// -(42+1) ==> -43  // 返回2的补码</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">"Hello World"</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'lo'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 找到匹配值</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ~ 只有反转 -1 的时候是假值，其余为真值，可用于代替判断</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">~</span>a<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'lo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 找到匹配</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">49.6</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// -50</span><span class="token comment" spellcheck="true">// 第一个~执行ToInt32并反转字位</span><span class="token comment" spellcheck="true">// 第二个~再进行一次字位反转，即将所有字位反转回原值，最后得到的仍然是ToInt32的结果。</span><span class="token comment" spellcheck="true">// 作用是能将值截除一个 32 位整数</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">-</span><span class="token number">49.6</span> <span class="token comment" spellcheck="true">// -49   </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>字位运算符“非”(~) 只适用于32位整数，运算符会强制操作数使用32位格式。是通过抽象操作 <a href="https://www.w3.org/html/ig/zh/wiki/ES5/%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E4%B8%8E%E6%B5%8B%E8%AF%95#ToInt32.EF.BC.9A.EF.BC.8832_.E4.BD.8D.E6.9C.89.E7.AC.A6.E5.8F.B7.E6.95.B4.E6.95.B0.EF.BC.89" target="_blank" rel="noopener"> ToInt32 </a>实现的</p><p>2、显式解析数字字符串</p><p>解析字符串中的数字和将字符串强制类型转换为数字的返回结果都是数字。但解析和转换两者之间还是有明显的差别</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token string">"42px"</span><span class="token punctuation">;</span><span class="token function">Number</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 42</span><span class="token function">parseInt</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 42</span><span class="token function">Number</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// NaN</span><span class="token function">parseInt</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>解析允许字符串中含有非数字字符，解析按从左到右的顺序，如果遇到非数字字符就停止。而转换不允许出现非数字字符，否则会失败并返回NaN。</li><li>parseInt 针对的是字符串，向parseInt(..)传递数字和其他类型的参数是没有用的，比如true、function(){…}和[1,2,3]。</li><li>关于更多 parseInt 请参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/parseInt" target="_blank" rel="noopener">MDN</a></li></ul><p>3、显式转换为布尔值</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">'0'</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">var</span> g<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 利用 Boolean 显示转换 </span><span class="token function">Boolean</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//true</span><span class="token function">Boolean</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//true</span><span class="token function">Boolean</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//true</span><span class="token function">Boolean</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//false</span><span class="token function">Boolean</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//false</span><span class="token function">Boolean</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//false</span><span class="token function">Boolean</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//false</span><span class="token comment" spellcheck="true">// 一元运算符！显式地将值强制类型转换为布尔值,同时还将真值反转为假值（或者将假值反转为真值)</span><span class="token comment" spellcheck="true">// 第二个！会将结果反转回原值</span><span class="token operator">!</span><span class="token operator">!</span> a <span class="token comment" spellcheck="true">//true</span><span class="token operator">!</span><span class="token operator">!</span> b <span class="token comment" spellcheck="true">//true</span><span class="token operator">!</span><span class="token operator">!</span> c <span class="token comment" spellcheck="true">//true</span><span class="token operator">!</span><span class="token operator">!</span> d <span class="token comment" spellcheck="true">//false</span><span class="token operator">!</span><span class="token operator">!</span> e <span class="token comment" spellcheck="true">//false</span><span class="token operator">!</span><span class="token operator">!</span> f <span class="token comment" spellcheck="true">//false</span><span class="token operator">!</span><span class="token operator">!</span> g <span class="token comment" spellcheck="true">//false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>隐式强制类型转换</strong></p><p>隐式强制类型转换指的是那些隐蔽的强制类型转换</p><p>1、字符串和数字之间的隐式强制类型转换</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">"42"</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token string">"0"</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">42</span><span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token number">0</span>a <span class="token operator">+</span> b <span class="token comment" spellcheck="true">//420</span>c <span class="token operator">+</span> d <span class="token comment" spellcheck="true">//42</span><span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>e <span class="token operator">+</span> f <span class="token comment" spellcheck="true">// "1,23,4"</span><span class="token comment" spellcheck="true">// 坑</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 0 , {}被当作代码块</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// "[object Object]"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据<a href="https://www.w3.org/html/ig/zh/wiki/ES5/%E8%A1%A8%E8%BE%BE%E5%BC%8F#.E4.BA.8C.E5.85.83.E9.80.BB.E8.BE.91.E8.BF.90.E7.AE.97.E7.AC.A6" target="_blank" rel="noopener">ES5规范</a>，如果某个操作数是字符串或者能够通过以下步骤转换为字符串的话，+将进行拼接操作。如果其中一个操作数是对象（包括数组），则首先对其调用ToPrimitive抽象操作，该抽象操作再调用[[DefaultValue]]。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>  valueOf<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  toString<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">}</span>a <span class="token operator">+</span> <span class="token string">''</span> <span class="token comment" spellcheck="true">//'42'</span><span class="token function">String</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// '2'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面重写了对象的 valueOf 和 toString 导致和正常的返回结果不同，所以应尽量避免重写这些方法</p><p>2、隐式强制类型转换为布尔值</p><p>下面的情况会发生布尔值隐式强制类型转换</p><ul><li><code>if (..)</code>语句中的条件判断表达式。</li><li><code>for ( .. ; .. ; .. )</code>语句中的条件判断表达式（第二个）</li><li><code>while (..)</code>和<code>do..while(..)</code>循环中的条件判断表达式</li><li><code>? ：</code>中的条件判断表达式</li><li>逻辑运算符 <code>||</code>（逻辑或）和 <code>&amp;&amp;</code>（逻辑与）左边的操作数（作为条件判断表达式）</li></ul><p>以上情况中，非布尔值会被隐式强制类型转换为布尔值，遵循前面介绍过的ToBoolean抽象操作规则。</p><p>3、逻辑运算符||（或）和 &amp;&amp;（与）</p><p>&amp;&amp; 和 || 运算符的返回值并不一定是布尔类型，而是两个操作数其中一个的值</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token string">"abc"</span><span class="token punctuation">;</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>a <span class="token operator">||</span> b <span class="token comment" spellcheck="true">//42</span>a <span class="token operator">&amp;&amp;</span> b <span class="token comment" spellcheck="true">// "abc"</span>c <span class="token operator">||</span> b <span class="token comment" spellcheck="true">//"abc"</span>c <span class="token operator">&amp;&amp;</span> b <span class="token comment" spellcheck="true">//null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>|| 和 &amp;&amp; 首先会对第一个操作数执行条件判断，如果其不是布尔值就先进行ToBoolean强制类型转换，然后再执行条件判断。</li><li>|| 如果条件判断结果为true就返回第一个操作数的值，如果为false就返回第二个操作数的值。</li><li>&amp;&amp; 则相反，如果条件判断结果为true就返回第二个操作数的值，如果为false就返回第一个操作数的值。</li></ul><p>虽然 <code>&amp;&amp;</code> <code>||</code> 返回的不是 <code>true</code> 和 <code>false</code>，那么为什么 <code>a &amp;&amp; (b || c)</code> 这样的表达式在 <code>if</code> 和 <code>for</code> 中没出过问题?</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token string">"foo"</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>b <span class="token operator">||</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行成功'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码 <code>a &amp;&amp; (b || c)</code> 的结果实际上是“foo”而非true，最后经过if 将 foo 强制类型转换为布尔值，所以最后结果为true,实际上相当于执行了下面的代码</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>a <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>b <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行成功'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>4、符号的强制类型转换<br>符号不能够被强制类型转换为数字（显式和隐式都会产生错误），但可以被强制类型转换为布尔值（显式和隐式结果都是true）</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">"cool"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">String</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//"Symbol(cool)"</span><span class="token keyword">var</span> s2 <span class="token operator">=</span> Symbol <span class="token punctuation">(</span><span class="token string">"newcool"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>s2 <span class="token operator">+</span> <span class="token string">""</span>  <span class="token comment" spellcheck="true">// TypeError(Cannot convert a Symbol value to a string)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>宽松相等和严格相等</strong></p><p>宽松相等（loose equals）==和严格相等（strict equals）===都用来判断两个值是否“相等”，经常在面试中会被问到 == 和 === 区别是什么？<br>大多数人回答的是 “==检查值是否相等，===检查值和类型是否相等”，这样解释没有错，但是不够准确，正确的应该是 “==允许在相等比较中进行强制类型转换，而===不允许。”</p><p>1、数字和字符串之间的比较</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token string">"42"</span><span class="token punctuation">;</span>a <span class="token operator">===</span> b<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span>a <span class="token operator">==</span> b<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>a === b 因为没有强制类型转换所有为false，而a == b 需要进行类型转换的，具体的转换步骤是：</p><ul><li>如果Type(x)是数字，Type(y)是字符串，则返回x == ToNumber(y)的结果</li><li>如果Type(x)是字符串，Type(y)是数字，则返回ToNumber(x) == y的结果。</li></ul><p>2、其他类型和布尔类型之间的相等比较</p><p>==最容易出错的一个地方是true和false与其他类型之间的相等比较</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token boolean">true</span> a <span class="token operator">==</span> b  <span class="token comment" spellcheck="true">// false </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>上面的例子为什么  a == b 是 false  呢？其实遵循了如下规则</p><ul><li>如果Type(x)是布尔类型，则返回ToNumber(x) == y的结果</li><li>如果Type(y)是布尔类型，则返回x == ToNumber(y)的结果</li></ul><p>所以转换过后也就是 42 == 1；所以为 false。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 不能这样用，条件不成立</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// 执行}</span><span class="token comment" spellcheck="true">// 可以这样</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// 执行} </span><span class="token comment" spellcheck="true">// 也可以这样显示的用法</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// 执行}</span><span class="token comment" spellcheck="true">// 也可以这样</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Boolean</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// 执行}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3、null 和 undefined 之间的相等比较</p><p>null和undefined之间的==也涉及隐式强制类型转换，但是唯独这两个比较特殊，ES5规范中规定了下面的规则</p><ul><li>如果x为null, y为undefined，则结果为true</li><li>如果x为undefined, y为null，则结果为true<br>也就是说 null 和 undefined在 == 中相等，也可以说是一回事，除此之外其他值都不存在这种情况</li></ul><p>4、对象和非对象之间的相等比较</p><p>对象（对象/函数/数组）和标量基本类型（字符串/数字/布尔值）之间的相等比较，ES5规范中规定了下面的规则</p><ul><li>如果Type(x)是字符串或数字，Type(y)是对象，则返回x == ToPrimitive(y)的结果</li><li>如果Type(x)是对象，Type(y)是字符串或数字，则返回ToPrimitive(x) == y的结果</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">42</span> a <span class="token operator">==</span> b <span class="token comment" spellcheck="true">// true </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>但是有一些值是例外的，原因是==算法中其他优先级更高的规则</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">null</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>a <span class="token operator">==</span> b <span class="token comment" spellcheck="true">// false </span><span class="token keyword">var</span> c <span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>c <span class="token operator">==</span> d <span class="token comment" spellcheck="true">// fasle </span><span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token number">NaN</span><span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>e <span class="token operator">==</span> f <span class="token comment" spellcheck="true">// false </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为没有对应的封装对象，所以null和undefined不能够被封装（boxed）,Object(null)和Object()均返回一个常规对象</p><p>NaN能够被封装为封装对象，但拆封之后NaN == NaN返回false，因为NaN不等于NaN</p><p><strong>比较少见的情况</strong></p><p>1、 返回其他数字</p><pre class="line-numbers language-js"><code class="language-js">Number<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  retrun <span class="token number">3</span><span class="token punctuation">}</span><span class="token keyword">new</span> <span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span>  <span class="token comment" spellcheck="true">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>原因还是因为Number(2)涉及ToPrimitive强制类型转换，因此会调用valueOf()，然而我们修改了返回值。<br>所以这块有一个经典的面试题，如何让以下情况同时满足</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>解法就是： </p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>Number<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> i<span class="token operator">++</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Number</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 参数传入多少都不会影响其返回值</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2、假值的相等比较</p><p>下面列出了常规和非常规的情况</p><pre class="line-numbers language-js"><code class="language-js"><span class="token string">'0'</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token comment" spellcheck="true">// false</span><span class="token string">'0'</span> <span class="token operator">==</span> undefined <span class="token comment" spellcheck="true">// false </span><span class="token string">'0'</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">// true  --注意</span><span class="token string">'0'</span> <span class="token operator">==</span> <span class="token number">NaN</span> <span class="token comment" spellcheck="true">// false </span><span class="token string">'0'</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">// true</span><span class="token string">'0'</span> <span class="token operator">==</span> <span class="token string">''</span> <span class="token comment" spellcheck="true">// false</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token comment" spellcheck="true">// false</span><span class="token boolean">false</span> <span class="token operator">==</span> undefined  <span class="token comment" spellcheck="true">// false</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token number">NaN</span>  <span class="token comment" spellcheck="true">// false </span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token number">0</span>    <span class="token comment" spellcheck="true">// true --注意</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token string">''</span>  <span class="token comment" spellcheck="true">// true--注意</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// true--注意</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// false </span><span class="token string">""</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token comment" spellcheck="true">//false</span><span class="token string">""</span> <span class="token operator">==</span> undefined <span class="token comment" spellcheck="true">// false</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token number">NaN</span> <span class="token comment" spellcheck="true">//false</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">// true-- 注意</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// true--注意</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// false</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token comment" spellcheck="true">//false </span><span class="token number">0</span> <span class="token operator">==</span> undefined <span class="token comment" spellcheck="true">// false</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token number">NaN</span> <span class="token comment" spellcheck="true">// false</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// true //--注意</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// false </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上24种情况，有17种情况比较好理解。因为我们知道 NaN和任何其他值都不想等包括自己。undefined 和 null 相等，除外都不相等。其他7种标识注意的地方没有什么好的方法，最好背下来</p><p>3、极端的情况</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">//true </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面是根据ToBoolean规则，进行布尔值强制类型转换。所以变成了[] == false，根据上面的假值相等的情况，就为true</p><p>4、安全的运用隐式强制类型转换<br>我们要对 == 两边的值认真推敲，以下两个原则可以避免出错</p><ul><li>如果两边的值中有true或者false，千万不要使用==</li><li>如果两边的值中有[]、””或者0，尽量不要使用==</li></ul><p>这个时候 === 就是我们最好的选择，相对来说更安全。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考<hr></h3><p><a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-262.pdf" target="_blank" rel="noopener">ECMA-262</a><br><a href="https://www.w3.org/html/ig/zh/wiki/ES5" target="_blank" rel="noopener">ES5规范</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vuex 原理</title>
      <link href="/2018/09/10/vue/vuex/"/>
      <url>/2018/09/10/vue/vuex/</url>
      
        <content type="html"><![CDATA[<p>说我 Vuex 大家也都能够耳熟能详了，它是进行状态管理的，也就是说全局数据缓存，通讯的作用。</p><h2 id="什么是-Vuex"><a href="#什么是-Vuex" class="headerlink" title="什么是 Vuex"></a>什么是 Vuex</h2><p>用 Vuex 官网的话讲 Vuex 是 Vue.js 应用程序的状态管理模式+库。它充当应用程序中所有组件的集中存储，其规则确保状态只能以可预测的方式进行更改。下面我们来看一张很熟悉的图来理解 Vuex 背后的基本思想</p><img src="/images/vuex.png"><h2 id="Vuex-的核心概念"><a href="#Vuex-的核心概念" class="headerlink" title="Vuex 的核心概念"></a>Vuex 的核心概念</h2><p>下面我们通过几个概念的解释来理解上面的图</p><h3 id="State"><a href="#State" class="headerlink" title="State"></a>State<hr></h3><p>Vuex 的唯一数据源，我们想使用的数据都定义在此处，唯一数据源确保我们的数据按照我们想要的方式去变动，可以通过 store.state 来取得内部数据</p><h3 id="Getter"><a href="#Getter" class="headerlink" title="Getter"></a>Getter<hr></h3><p>store 的计算属性，当我们需要对 state 的数据进行一些处理的时候，可以先在 getters 里进行操作，处理完的数据可以通过 store.getters 来获取。</p><h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action<hr></h3><p>Action 类似于 mutation，不同在于：</p><p>Action 通过 commit 方法提交 mutation，而不是直接变更状态。<br>Action 可以包含任意异步操作。<br>Action 通过 store.dispatch(action) 来触发事件</p><h3 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation<hr></h3><p>更改 Vuex 的 store 中的状态的唯一方法是提交 mutation，避免我们在使用过程中覆盖 state 造成数据丢失。</p><p>每个 mutation 都有一个字符串的 事件类型 (type) 和 一个 回调函数 (handler)</p><p>如果我们直接通过 store.state 来修改数据，vue 会抛出警告，并无法触发 mutation 的修改。</p><h3 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module<hr></h3><p>由于使用单一状态树，应用的所有状态会集中到一个比较大的对象。当应用变得非常复杂时，store 对象就有可能变得相当臃肿。<br>为了解决以上问题，Vuex 允许我们将 store 分割成模块（module）。每个模块拥有自己的 state、mutation、action、getter、甚至是嵌套子模块——从上至下进行同样方式的分割。</p><p>还有一些其他辅助函数的概念在这个就不一一列举了，每个名称的更全面的概念以及 demo 请查看 vuex<a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener">官网</a>文档</p><h2 id="vuex-的源码分析"><a href="#vuex-的源码分析" class="headerlink" title="vuex 的源码分析"></a>vuex 的源码分析</h2><p>关于使用我相信大家都会bu用过多的介绍，下面我们通过对源码的分析来了解 vuex 的原理更有利于我们在日常开发中使用，出现问题能够更清楚的知道问题出在哪里</p><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化<hr></h3><p>当我们在代码中通过引入如下代码的时候</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>实际上是引用一个对象，它定义在 <code>src/index.js</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Store<span class="token punctuation">,</span> install <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./store'</span><span class="token keyword">import</span> <span class="token punctuation">{</span> mapState<span class="token punctuation">,</span> mapMutations<span class="token punctuation">,</span> mapGetters<span class="token punctuation">,</span> mapActions<span class="token punctuation">,</span> createNamespacedHelpers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./helpers'</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  Store<span class="token punctuation">,</span>  install<span class="token punctuation">,</span>  version<span class="token punctuation">:</span> <span class="token string">'__VERSION__'</span><span class="token punctuation">,</span>  mapState<span class="token punctuation">,</span>  mapMutations<span class="token punctuation">,</span>  mapGetters<span class="token punctuation">,</span>  mapActions<span class="token punctuation">,</span>  createNamespacedHelpers<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码看见在引用的时候实际上就暴露了很多方法也是我们非常熟悉并且经常用的。</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用<hr></h3><p>当我们执行以下代码的时候</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>和 vue-router 一样，Vue.use 方法会注入一个插件，调用这个对象的 install 方法，该方法定义在 <code>src/store.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> install <span class="token punctuation">(</span>_Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Vue <span class="token operator">&amp;&amp;</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>        <span class="token string">'[vuex] already installed. Vue.use(Vuex) should be called only once.'</span>      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  Vue <span class="token operator">=</span> _Vue  <span class="token function">applyMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码我们看到其实和vue-router 差不多也是做了几件事情</p><ul><li>对 vue 对象做校验防止重复安装</li><li>将 vue 对象传递到本地中</li><li>调用 applyMixin 方法进行初始化</li></ul><p>接下来我们看一下 applyMixin 方法，定义在 <code>src/mixin.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> beforeCreate<span class="token punctuation">:</span> vuexInit <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// Vuex init钩子，注入到每个实例 init 钩子列表</span>  <span class="token keyword">function</span> vuexInit <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options    <span class="token comment" spellcheck="true">// 进行依赖注入</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>store <span class="token operator">===</span> <span class="token string">'function'</span>        <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">:</span> options<span class="token punctuation">.</span>store    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>parent <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码我们知道在执行 applyMixin 的时候实际上就是在 Vue beforeCreate 生命周期钩子函数里执行了 vuexInit 方法，将实例化的 Store 对象挂载到 $store 上。</p><h3 id="Store-实例化"><a href="#Store-实例化" class="headerlink" title="Store 实例化"></a>Store 实例化<hr></h3><p>当我们执行</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  actions<span class="token punctuation">,</span>  getters<span class="token punctuation">,</span>  state<span class="token punctuation">,</span>  mutations<span class="token punctuation">,</span>  modules  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们看到实际上 Store 对象的构造函数接收一个对象参数它包含 actions、getters、state、mutations、modules 等 Vuex 的核心概念，它定义在 <code>src/store.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span>options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果没有挂在成功 Vue 这里面自动在 window 上挂载 Vue</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Vue <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">install</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span>      plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      strict <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span> <span class="token operator">=</span> options    <span class="token comment" spellcheck="true">// store 的内部状态</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_actions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_mutations <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_wrappedGetters <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_modules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleCollection</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_modulesNamespaceMap <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_subscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_watcherVM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 绑定、提交和分发</span>    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> commit <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token keyword">function</span> boundDispatch <span class="token punctuation">(</span>type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> dispatch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>commit <span class="token operator">=</span> <span class="token keyword">function</span> boundCommit <span class="token punctuation">(</span>type<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> commit<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 严格模式</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>strict <span class="token operator">=</span> strict    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">.</span>state    <span class="token comment" spellcheck="true">// 初始化模块，递归地注册所有的子模块，并在 this. _wrappedge 中收集所有的模块 getter</span>    <span class="token function">installModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 初始化负责响应的存储vm(也将 _wrappedgeas 登记为计算属性)</span>    <span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// apply plugins</span>    plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>plugin <span class="token operator">=</span><span class="token operator">></span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> useDevtools <span class="token operator">=</span> options<span class="token punctuation">.</span>devtools <span class="token operator">!==</span> undefined <span class="token operator">?</span> options<span class="token punctuation">.</span>devtools <span class="token punctuation">:</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>devtools    <span class="token keyword">if</span> <span class="token punctuation">(</span>useDevtools<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">devtoolPlugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面代码主要是执行了以下过程</p><ul><li>如果没有传入 Vue，那么自动安装一下插件</li><li>初始化模块、安装模块收集所有模块的 getter</li><li>初始化 store._vm</li></ul><h3 id="获取模块"><a href="#获取模块" class="headerlink" title="获取模块"></a>获取模块<hr></h3><p>由于使用单一状态树，应用的所有状态会集中到一个比较大的对象，这样我们可以将 store 分割成模块（module，每个模块都拥有自己的 state、mutation、action、getter，甚至是嵌套子模块。如下</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> moduleA <span class="token operator">=</span> <span class="token punctuation">{</span>  state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  getters<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">const</span> moduleB <span class="token operator">=</span> <span class="token punctuation">{</span>  state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  getters<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  modules<span class="token punctuation">:</span> <span class="token punctuation">{</span>    a<span class="token punctuation">:</span> moduleA<span class="token punctuation">,</span>    b<span class="token punctuation">:</span> moduleB  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>a <span class="token comment" spellcheck="true">// -> moduleA 的状态</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>b <span class="token comment" spellcheck="true">// -> moduleB 的状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们打开 <code>module/module-collection.js</code> 文件，找到 ModuleCollection 类</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ModuleCollection</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span>rawRootModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rawRootModule<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到上面执行了 register 方法</p><pre class="line-numbers language-js"><code class="language-js">register <span class="token punctuation">(</span>path<span class="token punctuation">,</span> rawModule<span class="token punctuation">,</span> runtime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> newModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> newModule  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newModule<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">forEachValue</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span>rawChildModule<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> rawChildModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>register 接收 3 个参数</p><ul><li>path 表示路径，因为我们整体目标是要构建一颗模块树，path 是在构建树的过程中维护的路径</li><li>rawModule 表示定义模块的配置项</li><li>runtime 表示是否是一个运行时创建的模块</li></ul><p>上面实际上注册了 Module 的实例，Module 是用来描述单个模块的类，它的定义在 <code>src/module/module.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span>rawModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>runtime <span class="token operator">=</span> runtime    <span class="token keyword">this</span><span class="token punctuation">.</span>_children <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_rawModule <span class="token operator">=</span> rawModule    <span class="token keyword">const</span> rawState <span class="token operator">=</span> rawModule<span class="token punctuation">.</span>state    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> rawState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">rawState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> rawState<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对于每一个模块而言，_children 是该模块的子模块，_rawModule 是该模块的配置，state 是该模块的 state。</p><p>回到 register，那么在实例化一个 Module 后，判断当前的 path 的长度如果为 0，则说明它是一个根模块，所以把 newModule 赋值给了 this.root</p><p>接着判断是否有 modules 项，如果有，则执行下面代码</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">forEachValue</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span>rawChildModule<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> rawChildModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这段代码主要是遍历 modules，递归调用 register 方法，将配置项里的 modules 的 key 作为路径保存到 path 中，传入子 module 和创建状态。</p><p>如果 path 的长度不为 0，那么执行以下代码建立父子关系</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newModule<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>上面调用了 get</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">get</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> module<span class="token punctuation">.</span><span class="token function">getChild</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先获取父模块，这里通过 get 方法中的 reduce 方法一层层去找到对应的模块，查找的过程中，执行的是 module.getChild(key) 方法</p><pre class="line-numbers language-js"><code class="language-js">getChild <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_children<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>返回当前模块的 _children 中对应 key 的模块，那么每个模块当中的 key 是如何添加的呢</p><pre class="line-numbers language-js"><code class="language-js">addChild <span class="token punctuation">(</span>key<span class="token punctuation">,</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_children<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>对于 root module 的下一层 modules 来说，它们的 parent 就是 root module，那么他们就会被添加的 root module 的 _children 中。每个子模块通过路径找到它的父模块，然后通过父模块的 addChild 方法建立父子关系，递归执行这样的过程，最终就建立一颗完整的模块树。</p><h3 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h3><p>当我们构建好模块树，接下来就需要去安装这些模块了，看一下 installModule 方法代码如下</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> installModule <span class="token punctuation">(</span>store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">,</span> module<span class="token punctuation">,</span> hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isRoot <span class="token operator">=</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>length  <span class="token keyword">const</span> namespace <span class="token operator">=</span> store<span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 注册命名空间 map</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>namespaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_modulesNamespaceMap<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[vuex] duplicate namespace </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>namespace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> for the namespaced module </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    store<span class="token punctuation">.</span>_modulesNamespaceMap<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> module  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 获取父模块的 state，获取当前模块的名称，通过 Vue.set 将当前模块的 state 挂载到父模块上，key 是模块名称。</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> parentState <span class="token operator">=</span> <span class="token function">getNestedState</span><span class="token punctuation">(</span>rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> moduleName <span class="token operator">=</span> path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>    store<span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      Vue<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>parentState<span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> module<span class="token punctuation">.</span>state<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 通过 makeLocalContext 方法创建本地上下文环境，接收 store（root store）、namespace（模块命名空间）、path（模块路径） 三个参数</span>  <span class="token keyword">const</span> local <span class="token operator">=</span> module<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">makeLocalContext</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> path<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 调用 registerMutation 方法进行 Mutations 注册</span>  module<span class="token punctuation">.</span><span class="token function">forEachMutation</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutation<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key    <span class="token function">registerMutation</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> mutation<span class="token punctuation">,</span> local<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 调用 registerAction 方法进行 Actions 注册</span>  module<span class="token punctuation">.</span><span class="token function">forEachAction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> type <span class="token operator">=</span> action<span class="token punctuation">.</span>root <span class="token operator">?</span> key <span class="token punctuation">:</span> namespace <span class="token operator">+</span> key    <span class="token keyword">const</span> handler <span class="token operator">=</span> action<span class="token punctuation">.</span>handler <span class="token operator">||</span> action    <span class="token function">registerAction</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 调用 registerGetter 方法进行 Getter 注册</span>  module<span class="token punctuation">.</span><span class="token function">forEachGetter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key    <span class="token function">registerGetter</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> getter<span class="token punctuation">,</span> local<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 开始遍历模块的子模块，然后递归安装。</span>  module<span class="token punctuation">.</span><span class="token function">forEachChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">installModule</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> hot<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的逻辑就是初始化 state、getters、mutations、actions，这里有 5 个参数，分别代表</p><ul><li>store：root store</li><li>rootState：root state</li><li>path：模块访问路径</li><li>module：当前模块</li><li>hot：是否热更新</li></ul><p>默认情况下，模块内部的 action、mutation 和 getter 是注册在全局命名空间的——这样使得多个模块能够对同一 mutation 或 action 作出响应。如果我们希望模块具有更高的封装度和复用性，可以通过添加 namespaced: true 的方式使其成为带命名空间的模块。当模块被注册后，它的所有 getter、action 及 mutation 都会自动根据模块注册的路径调整命名。例如：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  modules<span class="token punctuation">:</span> <span class="token punctuation">{</span>    account<span class="token punctuation">:</span> <span class="token punctuation">{</span>      namespaced<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 模块内容（module assets）</span>      state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模块内的状态已经是嵌套的了，使用 `namespaced` 属性不会对其产生影响</span>      getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>        isAdmin <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> getters['account/isAdmin']</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>        login <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> dispatch('account/login')</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>        login <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> commit('account/login')</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 嵌套模块</span>      modules<span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 继承父模块的命名空间</span>        myPage<span class="token punctuation">:</span> <span class="token punctuation">{</span>          state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>          getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>            profile <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> getters['account/profile']</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 进一步嵌套命名空间</span>        posts<span class="token punctuation">:</span> <span class="token punctuation">{</span>          namespaced<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>          state<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>          getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>            popular <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// -> getters['account/posts/popular']</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>回到 installModule 方法，第一步根据 path 获取 namespace</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> namespace <span class="token operator">=</span> store<span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>getNamespace 的定义在 src/module/module-collection.js 中</p><pre class="line-numbers language-js"><code class="language-js">getNamespace <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>root  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    module <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">getChild</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>    <span class="token keyword">return</span> namespace <span class="token operator">+</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>namespaced <span class="token operator">?</span> key <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从 root module 开始，通过 reduce 方法一层层找子模块，如果发现该模块配置了 namespaced 为 true，则把该模块的 key 拼到 namesapce 中，最终返回完整的 namespace 字符串</p><p>为了方便以后能根据 namespace 查找模块执行以下方法把 namespace 对应的模块保存下来</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>namespaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>  store<span class="token punctuation">.</span>_modulesNamespaceMap<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>第二步根据 !isRoot &amp;&amp; !hot 来获取模块的名称、state 等</p><p>从 root state 开始，通过 path.reduce 方法一层层查找子模块 state，最终找到目标模块的 state。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> getNestedState <span class="token punctuation">(</span>state<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> path<span class="token punctuation">.</span>length    <span class="token operator">?</span> path<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> state<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>    <span class="token punctuation">:</span> state<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第三步通过 makeLocalContext 方法创建本地上下文环境</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> local <span class="token operator">=</span> module<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">makeLocalContext</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> makeLocalContext <span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> noNamespace <span class="token operator">=</span> namespace <span class="token operator">===</span> <span class="token string">''</span>  <span class="token keyword">const</span> local <span class="token operator">=</span> <span class="token punctuation">{</span>    dispatch<span class="token punctuation">:</span> noNamespace <span class="token operator">?</span> store<span class="token punctuation">.</span>dispatch <span class="token punctuation">:</span> <span class="token punctuation">(</span>_type<span class="token punctuation">,</span> _payload<span class="token punctuation">,</span> _options<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">unifyObjectStyle</span><span class="token punctuation">(</span>_type<span class="token punctuation">,</span> _payload<span class="token punctuation">,</span> _options<span class="token punctuation">)</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> payload<span class="token punctuation">,</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> args      <span class="token keyword">let</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> args      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options <span class="token operator">||</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>        type <span class="token operator">=</span> namespace <span class="token operator">+</span> type        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[vuex] unknown local action type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, global type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>          <span class="token keyword">return</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    commit<span class="token punctuation">:</span> noNamespace <span class="token operator">?</span> store<span class="token punctuation">.</span>commit <span class="token punctuation">:</span> <span class="token punctuation">(</span>_type<span class="token punctuation">,</span> _payload<span class="token punctuation">,</span> _options<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">unifyObjectStyle</span><span class="token punctuation">(</span>_type<span class="token punctuation">,</span> _payload<span class="token punctuation">,</span> _options<span class="token punctuation">)</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> payload<span class="token punctuation">,</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> args      <span class="token keyword">let</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> args      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options <span class="token operator">||</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>        type <span class="token operator">=</span> namespace <span class="token operator">+</span> type        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[vuex] unknown local mutation type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, global type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>          <span class="token keyword">return</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// getters and state object must be gotten lazily</span>  <span class="token comment" spellcheck="true">// because they will be changed by vm update</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>local<span class="token punctuation">,</span> <span class="token punctuation">{</span>    getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> noNamespace        <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> store<span class="token punctuation">.</span>getters        <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">makeLocalGetters</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    state<span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">getNestedState</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>state<span class="token punctuation">,</span> path<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> local<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果没有命名空间的情况就是直接使用 root store 上的 dispatch 和 commit 方法，否则使用新定义的方法，这个方法接收三个参数</p><ul><li>_type：dispatch、commit 的 type</li><li>_payload：提交的参数</li><li>_options：其他选项，例如 { root: true } 这个在子模块派发到根仓库的配置项</li></ul><p>把 type 自动拼接上 namespace，然后执行 store 上对应的方法。</p><p>对于 getters 而言，如果没有 namespace，则直接返回 root store 的 getters，否则返回 makeLocalGetters(store, namespace) 的返回值</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> makeLocalGetters <span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> gettersProxy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 获取了 namespace 的长度</span>  <span class="token keyword">const</span> splitPos <span class="token operator">=</span> namespace<span class="token punctuation">.</span>length  <span class="token comment" spellcheck="true">// 遍历 root store 下的所有 getters</span>  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>type <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 判断它的类型是否匹配 namespace,不匹配直接结束</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> splitPos<span class="token punctuation">)</span> <span class="token operator">!==</span> namespace<span class="token punctuation">)</span> <span class="token keyword">return</span>    <span class="token comment" spellcheck="true">// 获取本地 type，也就是 getNumberPlusOne</span>    <span class="token keyword">const</span> localType <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>splitPos<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 用 Object.defineProperty 定义了 gettersProxy，获取 localType 实际上就是访问了 store.getters[type]</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>gettersProxy<span class="token punctuation">,</span> localType<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> store<span class="token punctuation">.</span>getters<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span>      enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 访问代理对象</span>  <span class="token keyword">return</span> gettersProxy<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第四步注册 Mutations</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">forEachMutation</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutation<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key  <span class="token function">registerMutation</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> mutation<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">function</span> registerMutation <span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  entry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> wrappedMutationHandler <span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>    handler<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> local<span class="token punctuation">.</span>state<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过遍历 module 下的每一个 mutations 属性的值，然后获取带有命名空间的 type，再调用 registerMutation 方法进行注册，该方法实际上就是给 root store 上的 _mutations[types] 添加 wrappedMutationHandler 方法，从而允许我们一个 type 对应多个 mutaions。</p><p>第五步注册 Actions</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">forEachAction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> type <span class="token operator">=</span> action<span class="token punctuation">.</span>root <span class="token operator">?</span> key <span class="token punctuation">:</span> namespace <span class="token operator">+</span> key  <span class="token keyword">const</span> handler <span class="token operator">=</span> action<span class="token punctuation">.</span>handler <span class="token operator">||</span> action  <span class="token function">registerAction</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">function</span> registerAction <span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  entry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> wrappedActionHandler <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> res <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">{</span>      dispatch<span class="token punctuation">:</span> local<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span>      commit<span class="token punctuation">:</span> local<span class="token punctuation">.</span>commit<span class="token punctuation">,</span>      getters<span class="token punctuation">:</span> local<span class="token punctuation">.</span>getters<span class="token punctuation">,</span>      state<span class="token punctuation">:</span> local<span class="token punctuation">.</span>state<span class="token punctuation">,</span>      rootGetters<span class="token punctuation">:</span> store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span>      rootState<span class="token punctuation">:</span> store<span class="token punctuation">.</span>state    <span class="token punctuation">}</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> cb<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPromise</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      res <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_devtoolHook<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        store<span class="token punctuation">.</span>_devtoolHook<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'vuex:error'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">throw</span> err      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> res    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过遍历模块中的 actions 拿到每一个 action 和 key。判断 action.root，如果否的情况把 key 拼接上 namespace，然后执行 registerAction 方法。registerAction 接收四个参数</p><ul><li>store：store 实例</li><li>namespacedType：带命名空间的 type</li><li>handler：回调函数</li><li>local：上下文环境，root 为 store，module 为 local</li></ul><p>可以看到 actions 回调的第一个参数是一个对象，里面包含了 dispatch、commit、getters、state、rootGetters、rootState 字段，最后 actions 里通过 Promise 的异步过程，判断 res 的类型返回对应的值</p><p>第五步注册 Getters</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">forEachGetter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key  <span class="token function">registerGetter</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> getter<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">function</span> registerGetter <span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> rawGetter<span class="token punctuation">,</span> local<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_wrappedGetters<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[vuex] duplicate getter key: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  store<span class="token punctuation">.</span>_wrappedGetters<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> wrappedGetter <span class="token punctuation">(</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">rawGetter</span><span class="token punctuation">(</span>      local<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// local state</span>      local<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// local getters</span>      store<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// root state</span>      store<span class="token punctuation">.</span>getters <span class="token comment" spellcheck="true">// root getters</span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过遍历模块中的 getters 的定义，拿到每一个 getter 和 key，并把 key 拼接上 namespace，然后执行 registerGetter 方法。registerGetter 首先通过 store._wrappedGetters[type] 方法 判断 getter key 重复是否重复，接着在 _wrappedGetters 上以 type 为 key，挂载 wrappedGetter 函数，返回 rawGetters 函数执行的结果。</p><p>第六步安装子模块</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">forEachChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">installModule</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> hot<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>很简单就是递归安装的过程</p><p>以上就是 installModule 函数的作用进行 state、getters、actions、mutations 等模块的初始化和安装工作，接下来我们看 Store 实例化的最后一步，就是执行初始化 store._vm 的逻辑</p><h3 id="初始化-store-vm"><a href="#初始化-store-vm" class="headerlink" title="初始化 store._vm"></a>初始化 store._vm<hr></h3><p>入口是</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>看一下这个函数的定义</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> resetStoreVM <span class="token punctuation">(</span>store<span class="token punctuation">,</span> state<span class="token punctuation">,</span> hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> oldVm <span class="token operator">=</span> store<span class="token punctuation">.</span>_vm  <span class="token comment" spellcheck="true">// 建立 getters 和 state 的联系</span>  store<span class="token punctuation">.</span>getters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">const</span> wrappedGetters <span class="token operator">=</span> store<span class="token punctuation">.</span>_wrappedGetters  <span class="token keyword">const</span> computed <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 执行 computed[key] 对应的函数的时候，会执行 rawGetter(local.state,...) 方法，那么就会访问到 store.state，进而访问到 store._vm._data.$$state，这样就建立了一个依赖关系。当 store.state 发生变化的时候，下一次再访问 store.getters 的时候会重新计算。</span>  <span class="token function">forEachValue</span><span class="token punctuation">(</span>wrappedGetters<span class="token punctuation">,</span> <span class="token punctuation">(</span>fn<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//使用 computed 来利用其延迟缓存机制</span>    computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">fn</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> store<span class="token punctuation">.</span>_vm<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>      enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// for local getters</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 使用一个Vue实例来存储状态树抑制警告，以防用户添加了一些奇怪的全局混合</span>  <span class="token keyword">const</span> silent <span class="token operator">=</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>silent  Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>silent <span class="token operator">=</span> <span class="token boolean">true</span>  <span class="token comment" spellcheck="true">// 实例化一个 Vue 实例 store._vm，并把 computed 进去</span>  store<span class="token punctuation">.</span>_vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>      $$state<span class="token punctuation">:</span> state    <span class="token punctuation">}</span><span class="token punctuation">,</span>    computed  <span class="token punctuation">}</span><span class="token punctuation">)</span>  Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>silent <span class="token operator">=</span> silent  <span class="token comment" spellcheck="true">// 为新vm启用严格模式</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>strict<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">enableStrictMode</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVm<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 将所有订阅的观察者的更改发送到强制 getter 重新评估以便热重载</span>      <span class="token comment" spellcheck="true">// store._vm 会添加一个 wathcer 来观测 this._data.$$state 的变化，也就是当 store.state 被修改的时候, store._committing 必须为 true，否则在开发阶段会报警告</span>      store<span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        oldVm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state <span class="token operator">=</span> <span class="token keyword">null</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> oldVm<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里方法的主要是将 state 与 getters 建立好关系，实例化一个 Vue 挂载到 _vm 属性上，通过 computed 属性将 getters 与 state 关联起来并缓存结果。</p><h3 id="辅助函数过程分析"><a href="#辅助函数过程分析" class="headerlink" title="辅助函数过程分析"></a>辅助函数过程分析<hr></h3><p>当然还有很多 API 的分析过程比如怎么执行的 commit、dispatch，mapState 和 mapGetters、mapMutations、mapActions 等辅助函数的实现</p><p>我们可以看 <a href="https://ustbhuangyi.github.io/vue-analysis/vuex/api.html#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8" target="_blank" rel="noopener">Vue 技术揭秘</a>中关于这些的讲些</p>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在mac中配置多个github账号ssh密钥</title>
      <link href="/2018/08/10/linux/git/"/>
      <url>/2018/08/10/linux/git/</url>
      
        <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>很多时候我们本地生成的只有一个自己的ssh，但是多个ssh配置的场景也是蛮多的，所以想要commit，push等操作需要配置私钥ssh或者http，才能连接远程git仓库</p><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>我们假设原来在~/.ssh目录下已经生成了一对密钥,此密钥文件名字是默认生成</p><pre class="line-numbers language-js"><code class="language-js">id_rsaid_rsa<span class="token punctuation">.</span>pub<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>生成第二个ssh key</p><pre class="line-numbers language-js"><code class="language-js">ssh<span class="token operator">-</span>keygen <span class="token operator">-</span>t rsa <span class="token operator">-</span>C <span class="token string">"yourmail@gmail.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这里面不要一路回车，第一步需要我们手动填写保存文件的名字和路径</p><pre class="line-numbers language-js"><code class="language-js">Generating <span class="token keyword">public</span><span class="token operator">/</span><span class="token keyword">private</span> rsa key pair<span class="token punctuation">.</span>Enter file <span class="token keyword">in</span> which to save the key <span class="token punctuation">(</span><span class="token operator">/</span>Users<span class="token regex">/renbo/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">/</span>Users<span class="token regex">/renbo/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa_github<span class="token operator">&lt;</span>剩下两个直接回车<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这里我们用id_rsa_github来区别原有密钥对，避免被覆盖。<br>完成之后，我们可以看到~/.ssh目录下多了两个文件，变成：</p><pre class="line-numbers language-js"><code class="language-js">id_rsaid_ras<span class="token punctuation">.</span>pubid_rsa_githubid_rsa_github<span class="token punctuation">.</span>pubknown_hosts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打开ssh-agent(关于ssh-agent后续介绍)</p><p>这里如果你用的github官方的bash，用：</p><pre class="line-numbers language-js"><code class="language-js">ssh<span class="token operator">-</span>agent <span class="token operator">-</span>s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果是其他的，比如msysgit，用：</p><pre class="line-numbers language-js"><code class="language-js">eval <span class="token function">$</span><span class="token punctuation">(</span>ssh<span class="token operator">-</span>agent <span class="token operator">-</span>s<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>略过这一步的话，下一步会提示这样的错误：Could not open a connection to your authentication agent.</p><h3 id="添加私钥"><a href="#添加私钥" class="headerlink" title="添加私钥"></a>添加私钥</h3><pre class="line-numbers language-js"><code class="language-js">ssh<span class="token operator">-</span>add <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsassh<span class="token operator">-</span>add <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa_github<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="创建config文件"><a href="#创建config文件" class="headerlink" title="创建config文件"></a>创建config文件</h3><p>在~/.ssh目录下创建名为config的文件。mkdir config</p><p>打开文件sudo vim config添加一下内容：</p><pre class="line-numbers language-js"><code class="language-js"># gitlab  Host gitlab<span class="token punctuation">.</span>com  HostName gitlab<span class="token punctuation">.</span>com  PreferredAuthentications publickey  IdentityFile <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa_gitlab# github  Host github<span class="token punctuation">.</span>com  HostName github<span class="token punctuation">.</span>com  PreferredAuthentications publickey  IdentityFile <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa_github<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中，Host和HostName填写git服务器的域名。</p><p>IdentityFile指定私钥的路径。</p><p>如果在Linux系统下提示错误：Bad owner or permissions on /home/gary/.ssh/config</p><p>说明config权限过大，chmod命令调整：</p><pre class="line-numbers language-js"><code class="language-js">chmod <span class="token number">644</span> <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后在github和gitlab上添加公钥即可。githua 在右上角的头像的设置中</p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>然后用ssh命令分别测试：</p><pre class="line-numbers language-js"><code class="language-js">ssh <span class="token operator">-</span>T git@github<span class="token punctuation">.</span>com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>  如果到这里你没有成功的话，别急，教你解决问题的终极办法–debug</p><p>  比如测试github：</p><pre class="line-numbers language-js"><code class="language-js">  ssh <span class="token operator">-</span>vT git@github<span class="token punctuation">.</span>com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>  -v 是输出编译信息，然后根据编译信息自己去解决问题吧。</p><h3 id="关于https用户名"><a href="#关于https用户名" class="headerlink" title="关于https用户名"></a>关于https用户名</h3><p>  如果之前有设置全局用户名和邮箱的话，需要unset一下</p><pre class="line-numbers language-js"><code class="language-js">  git config <span class="token operator">--</span>global <span class="token operator">--</span>unset user<span class="token punctuation">.</span>name  git config <span class="token operator">--</span>global <span class="token operator">--</span>unset user<span class="token punctuation">.</span>email<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>  然后在不同的仓库下设置局部的用户名和邮箱</p><p>  比如在公司的repository下</p><pre class="line-numbers language-js"><code class="language-js">  git config user<span class="token punctuation">.</span>name <span class="token string">"yourname"</span>   git config user<span class="token punctuation">.</span>email <span class="token string">"youremail"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>  在自己的github的仓库在执行刚刚的命令一遍即可。</p><p>  这样就可以在不同的仓库，已不同的账号登录。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue-router 原理</title>
      <link href="/2018/08/10/vue/vuerouter/"/>
      <url>/2018/08/10/vue/vuerouter/</url>
      
        <content type="html"><![CDATA[<p>路由的概念，在现在的前端领域其实不算陌生。它的作用就是根据不用的路径去映射到不同的视图。</p><h2 id="后端路由"><a href="#后端路由" class="headerlink" title="后端路由"></a>后端路由</h2><p>路由的概念实际上是从后端开始由来的，后端根据不同的路径去匹配不同的资源例如</p><pre class="line-numbers language-js"><code class="language-js">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>studyfe<span class="token punctuation">.</span>cn<span class="token operator">/</span>login<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>大致流程可以分为以下几个阶段</p><ul><li>浏览器发送请求</li><li>服务器监听到请求，解析 url 路径</li><li>根据路由配置，返回资源信息</li><li>浏览器通过解析资源信息，呈现到前端页面</li></ul><h2 id="前端路由"><a href="#前端路由" class="headerlink" title="前端路由"></a>前端路由</h2><h3 id="hash-模式"><a href="#hash-模式" class="headerlink" title="hash 模式"></a>hash 模式<hr></h3><p>在 HTML5 的 history 没有出来之前，要实现前端路由机制而不请求后端资源就应用到了 hash 模式，hash 是指 url 尾巴后的 # 号及后面的字符。也被常称为锚点。hash 改变会触发 hashchange 事件，也能对浏览器的前进后退进行控制</p><pre class="line-numbers language-js"><code class="language-js">window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token string">'#toc-heading-1'</span>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 根据业务场景进行控制</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="history-模式"><a href="#history-模式" class="headerlink" title="history 模式"></a>history 模式<hr></h3><p>HTML5标准发布。多了两个 API，history.pushState 和 history.replaceState 来进行路由控制。通过这两个方法可以改变 url 且不向服务器发送请求。比较两种方法</p><ul><li>history 比 hash 更美观，url 后面不会多一个 #，</li><li>history API 可以是更灵活的控制前端路由，例如前进后退等等</li><li>history 模式在用户刷新的时候需要服务端支持进行重定向，避免出现错误</li><li>hash 传参是基于 url 的如果要传递复杂数据会有体积限制</li><li>hash 兼容到 IE8， history 兼容到 IE10</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * @param state：状态对象，通过pushState () 创建新的历史记录条目。大小不能超过640k * @param title：标题，基本没用，一般传 null。Firefox 目前忽略这个参数 * @param url：该参数定义了新的历史URL记录。新的 url 与当前 url 的 origin 必须一样，否则会抛出错误 */</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 示例</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token string">'https://www.studyfe.cn/2018/08/10/vue/vueroute'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"/2019/08/27/vue/vueprinciple/"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 修改当前历史记录与 pushState 类似</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 监听浏览器前进后退事件</span>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"popstate"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 后退</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 前进</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 前进一步</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>length <span class="token comment" spellcheck="true">// 查看当前记录的栈的数量</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="vue-router"><a href="#vue-router" class="headerlink" title="vue-router"></a>vue-router</h2><p>vue-router 在开发中 vue 项目中起到了非常大的作用，它支持 hash、history、abstract 3 种路由方式，提供了提供了 <router-link> 和 <router-view> 2 种组件和一系列的路由配置</router-view></router-link></p><p>使用 <router-link> 和 <router-view> 组件进行路由操作</router-view></router-link></p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello App!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 使用 router-link 组件来导航. --></span>    <span class="token comment" spellcheck="true">&lt;!-- 通过传入 `to` 属性指定链接. --></span>    <span class="token comment" spellcheck="true">&lt;!-- &lt;router-link> 默认会被渲染成一个 `&lt;a>` 标签 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/foo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Go to Foo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/bar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Go to Bar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>  <span class="token comment" spellcheck="true">&lt;!-- 路由出口 --></span>  <span class="token comment" spellcheck="true">&lt;!-- 路由匹配到的组件将渲染在这里 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用 vue-cli 我们经常会在入口文件进行配置</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span><span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span><span class="token comment" spellcheck="true">// 1. 定义（路由）组件。</span><span class="token comment" spellcheck="true">// 可以从其他文件 import 进来</span><span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div>foo&lt;/div>'</span> <span class="token punctuation">}</span><span class="token keyword">const</span> Bar <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div>bar&lt;/div>'</span> <span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 2. 定义路由</span><span class="token comment" spellcheck="true">// 每个路由应该映射一个组件。 其中"component" 可以是</span><span class="token comment" spellcheck="true">// 通过 Vue.extend() 创建的组件构造器，</span><span class="token comment" spellcheck="true">// 或者，只是一个组件配置对象。</span><span class="token comment" spellcheck="true">// 我们晚点再讨论嵌套路由。</span><span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/bar'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Bar <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// 3. 创建 router 实例，然后传 `routes` 配置</span><span class="token comment" spellcheck="true">// 你还可以传别的配置参数, 不过先这么简单着吧。</span><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  routes <span class="token comment" spellcheck="true">// （缩写）相当于 routes: routes</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 4. 创建和挂载根实例。</span><span class="token comment" spellcheck="true">// 记得要通过 router 配置参数注入路由，</span><span class="token comment" spellcheck="true">// 从而让整个应用都有路由功能</span><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  router<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的例子可以看到 vue-router 是通过 Vue.use 的方法被注入进 Vue 实例中，那么接下来我们就通过 Vue.use 来了解整个 vue-router</p><h3 id="vue-router-实现之-install"><a href="#vue-router-实现之-install" class="headerlink" title="vue-router 实现之 install"></a>vue-router 实现之 install<hr></h3><p>Vue.use 定义在 <code>vue/src/core/global-api/use.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js">Vue<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">:</span> Function <span class="token operator">|</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    plugin<span class="token punctuation">.</span>install<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> args<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    plugin<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面方法很清晰的看到 Vue.use 实际上就是执行这个 install 方法，并且在这个 install 方法的第一个参数我们可以拿到 Vue 对象。Vue-Router 的入口文件是 <code>src/index.js</code>，其中定义了 VueRouter 类，也实现了 install 的静态方法</p><pre class="line-numbers language-js"><code class="language-js">VueRouter<span class="token punctuation">.</span>install <span class="token operator">=</span> install<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>它的定义在 src/install.js 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">function</span> install <span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ...</span>  <span class="token comment" spellcheck="true">// 混入 beforeCreate 钩子</span>  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    beforeCreate <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 在option上面存在router则代表是根组件 </span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router        <span class="token comment" spellcheck="true">// 执行_router实例的 init 方法</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 为 vue 实例定义数据劫持</span>        Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 非根组件则直接从父组件中获取</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>      <span class="token punctuation">}</span>      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    destroyed <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 设置代理，当访问 this.$router 的时候，代理到 this._routerRoot._router</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$router'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_router <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 设置代理，当访问 this.$route 的时候，代理到 this._routerRoot._route</span>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$route'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_route <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 注册 router-view 和 router-link 组件</span>  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span> View<span class="token punctuation">)</span>  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span> Link<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// Vue钩子合并策略</span>  <span class="token keyword">const</span> strats <span class="token operator">=</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>optionMergeStrategies  <span class="token comment" spellcheck="true">// use the same hook merging strategy for route hooks</span>  strats<span class="token punctuation">.</span>beforeRouteEnter <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteLeave <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteUpdate <span class="token operator">=</span> strats<span class="token punctuation">.</span>created  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的伪代码我们看到 Vue-Router 的 install 方法 实际上就是初始化的过程</p><ul><li>混入了 beforeCreate，在执行 <code>new Vue({router})</code> 的时候传入 router 对象，挂在到 vue 的根组件上</li><li>执行 <code>this._router.init(this)</code> </li><li>调用了 <code>Vue.util.defineReactive</code> 方法来进行响应式数据定义，主要是为了路由的变化能够即使响应页面的更新</li><li>通过 registerInstance(this, this) 这个方法来实现对 router-view 的挂载操作</li><li>通过 Object.defineProperty 在 Vue 的原型上定义了 $router 和 $route 2 个属性的 get 方法</li><li>进行组件的注册钩子合并等操作</li></ul><h3 id="vue-router-实现之-new-VueRouter"><a href="#vue-router-实现之-new-VueRouter" class="headerlink" title="vue-router 实现之 new VueRouter"></a>vue-router 实现之 new VueRouter<hr></h3><p> 为了构造出 router 实例对象，VueRouter 定义了一些属性和方法，当我们进行 new VueRouter 的时候，如下</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>  routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Home <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/bar/:id'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Bar <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么接下来我们看看 new VueRouter 的时候做了什么</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  constructor <span class="token punctuation">(</span>options<span class="token punctuation">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>apps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span> mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>      mode <span class="token operator">=</span> <span class="token string">'hash'</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>      mode <span class="token operator">=</span> <span class="token string">'abstract'</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode    <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token punctuation">:</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token punctuation">:</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token punctuation">:</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  match <span class="token punctuation">(</span>    raw<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>    current<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span>    redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location  <span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> current<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">get</span> currentRoute <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>Route <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>current  <span class="token punctuation">}</span>  init <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面我们可以看得出 constructor 中 主要是通过参数 mode 来指定路由模式，在最初阶段还进行了兼容判断。如果当前环境不支持 history 模式，会强制切换到 hash 模式。如果当前环境不是浏览器环境，会切换到abstract模式下。然后再根据不同模式来生成不同的 history 操作对象。</p><p>实例化 VueRouter 后会返回它的实例 router，我们在 new Vue 的时候会把 router 作为配置的属性传入，在混入 beforCreate 钩子的时候执行了</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接下来我们看看 init 方法</p><pre class="line-numbers language-js"><code class="language-js">init <span class="token punctuation">(</span>app<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app  <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history  <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> setupHashListener <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>      history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      setupHashListener<span class="token punctuation">,</span>      setupHashListener    <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>route <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>init 主要是通过 history 不同执行 history.transitionTo 切换路由。最后通过 history.listen 来注册路由变化的响应回调。</p><h3 id="vue-router-实现之-HashHistory"><a href="#vue-router-实现之-HashHistory" class="headerlink" title="vue-router 实现之 HashHistory"></a>vue-router 实现之 HashHistory<hr></h3><p>在上面代码中如果 mode 为 hash 则执行 new HashHistory 函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HashHistory</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>  constructor <span class="token punctuation">(</span>router<span class="token punctuation">:</span> Router<span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token operator">?</span>string<span class="token punctuation">,</span> fallback<span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// check history fallback deeplinking</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fallback <span class="token operator">&amp;&amp;</span> <span class="token function">checkFallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 保证 hash 是以 / 开头，而不是 #/，如果是 #/就会触发 hashchange 事件 这样执行 beforeEnter 钩子时候会触发两次</span>    <span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token keyword">function</span> checkFallback <span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^\/#/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">cleanPath</span><span class="token punctuation">(</span>base <span class="token operator">+</span> <span class="token string">'/#'</span> <span class="token operator">+</span> location<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> ensureSlash <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span>  <span class="token function">replaceHash</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token operator">+</span> path<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> getHash <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 主要是取 hash，因为兼容性问题所以没有直接使用 window.location.hash</span>  <span class="token keyword">let</span> href <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href  <span class="token keyword">const</span> index <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span>  href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> searchIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>searchIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> hashIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hashIndex <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      href <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> hashIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashIndex<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> href <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>searchIndex <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      href <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> searchIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>searchIndex<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> href<span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 init 的时候如果是 HashHistory 则会执行 history.transitionTo</p><pre class="line-numbers language-js"><code class="language-js">history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>  history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  setupHashListener<span class="token punctuation">,</span>  setupHashListener<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js">transitionTo <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 通过 match 匹配 URL 的 router 对象 </span>    <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>      onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">// fire ready cbs once</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>onAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>transitionTo 首先根据目标 location 和当前路径 this.current 执行 this.router.match 方法去匹配到目标的路径。这里 this.current 是 history 维护的当前路径，它的初始值是在 history 的构造函数中初始化的：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> START<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>START 的定义在 src/util/route.js 中：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">export</span> <span class="token keyword">const</span> START <span class="token operator">=</span> <span class="token function">createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这样我们就创建了初始的 Route，那么接下来会执行 confirmTransition 做真正的切换处理</p><pre class="line-numbers language-js"><code class="language-js">confirmTransition <span class="token punctuation">(</span>route<span class="token punctuation">:</span> Route<span class="token punctuation">,</span> onComplete<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current  <span class="token keyword">const</span> abort <span class="token operator">=</span> err <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    onAbort <span class="token operator">&amp;&amp;</span> <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 如果是相同的路由并且 matched.length 相同，那么进行跳转 / 且记进行中断处理</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> <span class="token punctuation">{</span>    updated<span class="token punctuation">,</span>    deactivated<span class="token punctuation">,</span>    activated  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 整个切换周期的队列</span>  <span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>    <span class="token comment" spellcheck="true">// 得到即将被销毁组建的 beforeRouteLeave 钩子函数</span>    <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 全局 router before hooks</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 得到组件 updated 钩子</span>    <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 将要更新的路由的 beforeEnter 钩子</span>    activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 异步组件的执行</span>    <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>  <span class="token punctuation">)</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> route  <span class="token comment" spellcheck="true">// 每一个队列执行的 iterator 函数</span>  <span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 执行队列 leave 和 beforeEnter 相关钩子</span>  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面函数的内部实现我们就略过通过注释我们知道它的作用就可以了，现在我们屡一下上面的流程</p><ul><li>执行 transitionTo 函数，通过 match 函数的匹配得到 router 对象</li><li>执行 confirmTransition 函数，判断是否需要跳转，如果不需要则进行中断处理，否则先得到钩子函数的任务队列 queue</li><li>通过 runQueue 函数来批次执行任务队列中的每个方法</li><li>执行 queue 的钩子函数的时候，通过 iterator 来构造迭代器由用户传入 next 方法，确定执行的过程</li><li>整个队列执行完毕后，开始处理完成后的回调函数。</li></ul><blockquote><p>导航守卫</p></blockquote><p>导航守卫，实际上就是发生在路由路径切换的时候，执行的一系列钩子函数。</p><p>我们先从整体上看一下这些钩子函数执行的逻辑，首先构造一个队列 queue，它实际上是一个数组；然后再定义一个迭代器函数 iterator；最后再执行 runQueue 方法来执行这个队列。我们先来看一下 runQueue 的定义，在 <code>src/util/async.js</code> 中：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> runQueue <span class="token punctuation">(</span>queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">></span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> cb<span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> step <span class="token operator">=</span> index <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">fn</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是非常经典的异步函数队列执行模式，fn 就是我们传入的 iterator 函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token punctuation">(</span>to<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>        <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>        <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>          <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>          <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>iterator 函数就是去执行每一个导航守卫 hook，并传入 route、current 和匿名函数，这些参数分别对应得到是文档中的 to、from、next 当执行了匿名函数，会根据一些条件执行 abort 或 next，只有执行 next 的时候，才会前进到下一个导航守卫钩子函数中，这也就是为什么官方文档会说只有执行 next 方法来 resolve 这个钩子函数。</p><p>最后我们来看一下 queue 是怎么构造的</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>  <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>  <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>  activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>按照顺序如下：</p><ol><li><p>在失活的组件里调用离开守卫。</p></li><li><p>调用全局的 beforeEach 守卫。</p></li><li><p>在重用的组件里调用 beforeRouteUpdate 守卫</p></li><li><p>在激活的路由配置里调用 beforeEnter。</p></li><li><p>解析异步路由组件。</p></li></ol><p>接下来我们来分别介绍这 5 步的实现</p><p>第一步执行 extractLeaveGuards(deactivated)，先来看一下 extractLeaveGuards 的定义</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> extractLeaveGuards <span class="token punctuation">(</span>deactivated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">,</span> <span class="token string">'beforeRouteLeave'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>它内部调用了 extractGuards 的通用方法，可以从 RouteRecord 数组中提取各个阶段的守卫</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> extractGuards <span class="token punctuation">(</span>  records<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">,</span>  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>  bind<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>  reverse<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> guards <span class="token operator">=</span> <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token punctuation">(</span>def<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> guard <span class="token operator">=</span> <span class="token function">extractGuard</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> name<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span>        <span class="token operator">?</span> guard<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>guard <span class="token operator">=</span><span class="token operator">></span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>reverse <span class="token operator">?</span> guards<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> guards<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里用到了 flatMapComponents 方法去从 records 中获取所有的导航，它的定义在 <code>src/util/resolve-components.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> flatMapComponents <span class="token punctuation">(</span>  matched<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">,</span>  fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>matched<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>components<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>key <span class="token operator">=</span><span class="token operator">></span> <span class="token function">fn</span><span class="token punctuation">(</span>      m<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>      m<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>      m<span class="token punctuation">,</span> key    <span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> flatten <span class="token punctuation">(</span>arr<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>concat<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>flatMapComponents 的作用就是返回一个数组，数组的元素是从 matched 里获取到所有组件的 key，然后返回 fn 函数执行的结果，flatten 作用是把二维数组拍平成一维数组。</p><p>那么对于 extractGuards 中 flatMapComponents 的调用，执行每个 fn 的时候，通过 extractGuard(def, name) 获取到组件中对应 name 的导航守卫</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> extractGuard <span class="token punctuation">(</span>  def<span class="token punctuation">:</span> Object <span class="token operator">|</span> Function<span class="token punctuation">,</span>  key<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> NavigationGuard <span class="token operator">|</span> Array<span class="token operator">&lt;</span>NavigationGuard<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    def <span class="token operator">=</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>def<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> def<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获取到 guard 后，还会调用 bind 方法把组件的实例 instance 作为函数执行的上下文绑定到 guard 上，bind 方法的对应的是 bindGuard</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> bindGuard <span class="token punctuation">(</span>guard<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span> instance<span class="token punctuation">:</span> <span class="token operator">?</span>_Vue<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>NavigationGuard <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> boundRouteGuard <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> guard<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么对于 extractLeaveGuards(deactivated) 而言，获取到的就是所有失活组件中定义的 beforeRouteLeave 钩子函数。</p><p>第二步是 <code>this.router.beforeHooks</code>，在我们的 VueRouter 类中定义了 beforeEach 方法，在 <code>src/index.js</code> 中：</p><pre class="line-numbers language-js"><code class="language-js">beforeEach <span class="token punctuation">(</span>fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">function</span> registerHook <span class="token punctuation">(</span>list<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当用户使用 router.beforeEach 注册了一个全局守卫，就会往 router.beforeHooks 添加一个钩子函数，这样 this.router.beforeHooks 获取的就是用户注册的全局 beforeEach 守卫。</p><p>第三步执行了 extractUpdateHooks(updated)，来看一下 extractUpdateHooks 的定义：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> extractUpdateHooks <span class="token punctuation">(</span>updated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>updated<span class="token punctuation">,</span> <span class="token string">'beforeRouteUpdate'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>和 extractLeaveGuards(deactivated) 类似，extractUpdateHooks(updated) 获取到的就是所有重用的组件中定义的 beforeRouteUpdate 钩子函数</p><p>第四步是执行 activated.map(m =&gt; m.beforeEnter)，获取的是在激活的路由配置中定义的 beforeEnter 函数。</p><p>第五步是执行 resolveAsyncComponents(activated) 解析异步组件，先来看一下 resolveAsyncComponents 的定义，在 <code>src/util/resolve-components.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> resolveAsyncComponents <span class="token punctuation">(</span>matched<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> hasAsync <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>matched<span class="token punctuation">,</span> <span class="token punctuation">(</span>def<span class="token punctuation">,</span> _<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> def<span class="token punctuation">.</span>cid <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>        hasAsync <span class="token operator">=</span> <span class="token boolean">true</span>        pending<span class="token operator">++</span>        <span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span>resolvedDef <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isESModule</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            resolvedDef <span class="token operator">=</span> resolvedDef<span class="token punctuation">.</span><span class="token keyword">default</span>          <span class="token punctuation">}</span>          def<span class="token punctuation">.</span>resolved <span class="token operator">=</span> <span class="token keyword">typeof</span> resolvedDef <span class="token operator">===</span> <span class="token string">'function'</span>            <span class="token operator">?</span> resolvedDef            <span class="token punctuation">:</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span>          match<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> resolvedDef          pending<span class="token operator">--</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">const</span> reject <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span>reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token string">`Failed to resolve async component </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>          process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>            error <span class="token operator">=</span> <span class="token function">isError</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>              <span class="token operator">?</span> reason              <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>            <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">let</span> res        <span class="token keyword">try</span> <span class="token punctuation">{</span>          res <span class="token operator">=</span> <span class="token function">def</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">const</span> comp <span class="token operator">=</span> res<span class="token punctuation">.</span>component            <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> comp<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              comp<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasAsync<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>resolveAsyncComponents 返回的是一个导航守卫函数，有标准的 to、from、next 参数。它的内部实现很简单，利用了 flatMapComponents 方法从 matched 中获取到每个组件的定义，判断如果是异步组件，则执行异步组件加载逻辑，加载成功后会执行 match.components[key] = resolvedDef 把解析好的异步组件放到对应的 components 上，并且执行 next 函数。</p><p>这样在 resolveAsyncComponents(activated) 解析完所有激活的异步组件后，我们就可以拿到这一次所有激活的组件。这样我们在做完这 5 步后又做了一些事情</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">const</span> isValid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route  <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>  <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li><p>在被激活的组件里调用 beforeRouteEnter。</p></li><li><p>调用全局的 beforeResolve 守卫。</p></li><li><p>调用全局的 afterEach 钩子。</p></li></ol><p>可以看到，当处理完任务队列之后的回调主要是接入路由组件后期的钩子函数 beforeRouteEnter 和 beforeResolve，并进行队列执行。最后执行回调函数 onComplete</p><p>到这里，已经完成了对当前 route 的切换动作，在完成路由切换后执行了 <code>onComplete &amp;&amp; onComplete(route)</code> ，那么主要会引起 url 和 组件的变化我们来看看</p><p>当我们点击 router-link 的时候，实际上最终会执行 router.push，如下</p><pre class="line-numbers language-js"><code class="language-js">push <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>this.history.push 函数，这个函数是子类实现的，不同模式下该函数的实现略有不同，我们来看一下平时使用比较多的 hash 模式该函数的实现，在 <code>src/history/hash.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js">push <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">{</span> current<span class="token punctuation">:</span> fromRoute <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> route <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">pushHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>    <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> fromRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>    onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>push 函数会先执行 this.transitionTo 做路径切换，在切换完成的回调函数中，执行 pushHash 函数</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> pushHash <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">pushState</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> path  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>supportsPushState 的定义在 <code>src/util/push-state.js</code> 中</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> supportsPushState <span class="token operator">=</span> inBrowser <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> ua <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent  <span class="token keyword">if</span> <span class="token punctuation">(</span>    <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 2.'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 4.0'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Mobile Safari'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>    ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Chrome'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>    ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Windows Phone'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> window<span class="token punctuation">.</span>history <span class="token operator">&amp;&amp;</span> <span class="token string">'pushState'</span> <span class="token keyword">in</span> window<span class="token punctuation">.</span>history<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果支持的话，则获取当前完整的 url，执行 pushState 方法</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> pushState <span class="token punctuation">(</span>url<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">,</span> replace<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">saveScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> history <span class="token operator">=</span> window<span class="token punctuation">.</span>history  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>      history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token punctuation">:</span> _key <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      _key <span class="token operator">=</span> <span class="token function">genKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token punctuation">:</span> _key <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>location<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">'replace'</span> <span class="token punctuation">:</span> <span class="token string">'assign'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>pushState 会调用浏览器原生的 history 的 pushState 接口或者 replaceState 接口，更新浏览器的 url 地址，并把当前 url 压入历史栈中。</p><p>然后在 history 的初始化中，会设置一个监听器，监听历史栈的变化</p><pre class="line-numbers language-js"><code class="language-js">setupListeners <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router  <span class="token comment" spellcheck="true">// 处理滚动</span>  <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior  <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 通过 supportsPushState 判断监听popstate 还是 hashchange</span>  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>supportsPushState <span class="token operator">?</span> <span class="token string">'popstate'</span> <span class="token punctuation">:</span> <span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current    <span class="token comment" spellcheck="true">// 判断路由格式</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> route <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// 如果不支持 history 模式，则换成 hash 模式</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">replaceHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当点击浏览器返回按钮的时候，如果已经有 url 被压入历史栈，则会触发 popstate 事件，然后拿到当前要跳转的 hash，执行 transtionTo 方法做一次路径转换。</p><p>可以看到 setupListeners 这里主要做了 2 件事情，一个是对路由切换滚动位置的处理，另一个是对路由变动做了一次监听。这样我们就完成了对真个 hash 的分析过程</p><h3 id="vue-router-实现之-HTML5History"><a href="#vue-router-实现之-HTML5History" class="headerlink" title="vue-router 实现之 HTML5History"></a>vue-router 实现之 HTML5History<hr></h3><p>当初始化的时候 mode 等于 history 模式的时候，就会执行 HTML5History，然后会执行 history 对象上的 transitionTo 方法</p><p>在vue-router实例化过程中，执行对 HTML5History 的实例化</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>看一下 HTML5History 函数的构造</p><pre class="line-numbers language-js"><code class="language-js">  constructor <span class="token punctuation">(</span>router<span class="token punctuation">:</span> Router<span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token operator">?</span>string<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 实现 base 基类中的构造函数</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 滚动信息处理</span>    <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior    <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> initLocation <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current      <span class="token comment" spellcheck="true">// 避免在有的浏览器中第一次加载路由就会触发 `popstate` 事件</span>      <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> START <span class="token operator">&amp;&amp;</span> location <span class="token operator">===</span> initLocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// 执行跳转动作</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> route <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">handleScroll</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，只是调用基类构造函数以及初始化监听事件。由于在上面已经介绍了 transitionTo 和 confirmTransition。这里不再过多介绍了。那么我们来看几个之前没介绍的一下 API 吧</p><pre class="line-numbers language-js"><code class="language-js">  push <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  replace <span class="token punctuation">(</span>location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  go <span class="token punctuation">(</span>n<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  back <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  forward <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到 vue-router 这个 API 实际上都是效仿 window.history API 的，所以也不用多说。这样我们就完成了对 HTML5History 的介绍</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结<hr></h3><p>从上面我们看到路径变化是路由中最重要的功能，在路由记性切换的时候会把当前的路线切换到目标路线，切换过程中会执行一系列的导航守卫钩子函数，更改 url，同时渲染组件。其实最重要的几个函数就是</p><ul><li>match 进行匹配路由得到路由对象</li><li>transitionTo 做路径切换</li><li>confirmTransition 处理队列的钩子函数，在处理钩子函数的时候会按照上面介绍的执行 8 个小步骤的顺序</li><li>setupListeners 监听导航等功能</li></ul>]]></content>
      
      
      <categories>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux vim使用</title>
      <link href="/2018/07/28/linux/vim/"/>
      <url>/2018/07/28/linux/vim/</url>
      
        <content type="html"><![CDATA[<h3 id="vim三种模式"><a href="#vim三种模式" class="headerlink" title="vim三种模式"></a>vim三种模式</h3><p>命令模式、插入模式、编辑模式。使用ESC或i或：来切换模式</p><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">:</span>q  退出<span class="token punctuation">:</span>q<span class="token operator">!</span> 强制退出<span class="token punctuation">:</span>wq 保存并退出<span class="token punctuation">:</span><span class="token keyword">set</span> number  显示行号<span class="token punctuation">:</span><span class="token keyword">set</span> nonumber  隐藏行号<span class="token operator">/</span>host  在文档中查找host 按n跳到查找下一个，shift<span class="token operator">+</span>n查找上一个yyp  复制光标所在行，并粘贴<span class="token function">h</span><span class="token punctuation">(</span>左移一个字符←<span class="token punctuation">)</span><span class="token function">、j</span><span class="token punctuation">(</span>下一行↓<span class="token punctuation">)</span><span class="token function">、k</span><span class="token punctuation">(</span>上一行↑<span class="token punctuation">)</span><span class="token function">、l</span><span class="token punctuation">(</span>右移一个字符→<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件权限</title>
      <link href="/2018/07/25/linux/fileauth/"/>
      <url>/2018/07/25/linux/fileauth/</url>
      
        <content type="html"><![CDATA[<h3 id="三种基本权限"><a href="#三种基本权限" class="headerlink" title="三种基本权限"></a>三种基本权限</h3><pre class="line-numbers language-js"><code class="language-js">R  读  数值表示为<span class="token number">4</span>W  写  数值表示为<span class="token number">2</span>X  可执行  数值表示为<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>1.执行ls -al命令行会出现<br></p><pre class="line-numbers language-js"><code class="language-js">drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x  <span class="token number">19</span> renbo  staff   608B Mar <span class="token number">27</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">31</span> <span class="token operator">-</span>notes<span class="token operator">-</span>summarydrwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x  <span class="token number">41</span> renbo  staff   <span class="token number">1</span><span class="token punctuation">.</span>3K Mar <span class="token number">12</span> <span class="token number">17</span><span class="token punctuation">:</span><span class="token number">05</span> ant<span class="token operator">-</span>design<span class="token operator">-</span>prodrwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x   <span class="token number">7</span> renbo  staff   224B May <span class="token number">18</span>  <span class="token number">2018</span> canvasdrwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x   <span class="token number">8</span> renbo  staff   256B Sep <span class="token number">11</span>  <span class="token number">2017</span> doT<span class="token operator">-</span>demodrwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x  <span class="token number">19</span> renbo  staff   608B May <span class="token number">24</span>  <span class="token number">2018</span> egg<span class="token operator">-</span>exampledrwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x   <span class="token number">4</span> renbo  staff   128B Nov <span class="token number">21</span> <span class="token number">13</span><span class="token punctuation">:</span><span class="token number">52</span> expressdrwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x   <span class="token number">3</span> renbo  staff    96B Aug <span class="token number">13</span>  <span class="token number">2018</span> flutter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2.解释：</p><pre class="line-numbers language-js"><code class="language-js">d ：第一位表示文件类型，d是目录文件、l是链接文件、<span class="token operator">-</span>是普通文件、p是管道rwx ：第<span class="token number">2</span><span class="token operator">-</span><span class="token number">4</span>位表示这个文件的属主拥有的权限。r是读、w是写、x是执行r<span class="token operator">-</span>x ：第<span class="token number">5</span><span class="token operator">-</span><span class="token number">7</span>位表示和这个文件属主所在同一个组的用户所具有的权限r<span class="token operator">-</span>x ：第<span class="token number">8</span><span class="token operator">-</span><span class="token number">10</span>位表示其他用户所具有的权限r<span class="token punctuation">:</span>read就是读权限     <span class="token operator">--</span>数字<span class="token number">4</span>表示w<span class="token punctuation">:</span>write就是写权限    <span class="token operator">--</span>数字<span class="token number">2</span>表示x<span class="token punctuation">:</span>excute就是执行权限 <span class="token operator">--</span>数字<span class="token number">1</span>表示<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="更改权限"><a href="#更改权限" class="headerlink" title="更改权限"></a>更改权限</h3><pre class="line-numbers language-js"><code class="language-js">sudo chmod <span class="token punctuation">[</span>u所属用户  g所属组  o其他用户  a所有用户<span class="token punctuation">]</span>  <span class="token punctuation">[</span><span class="token operator">+</span>增加权限  <span class="token operator">-</span>减少权限<span class="token punctuation">]</span>  <span class="token punctuation">[</span>r  w  x<span class="token punctuation">]</span>   目录名 例如：有一个文件filename，权限为“<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span>x” <span class="token punctuation">,</span>将权限值改为<span class="token string">"-rwxrw-r-x"</span>，用数值表示为<span class="token number">765</span>sudo chmod u<span class="token operator">+</span>x g<span class="token operator">+</span>w o<span class="token operator">+</span>r  filename上面的例子可以用数值表示sudo chmod <span class="token number">765</span> filename一般超级权限为sudo chmod <span class="token number">777</span> filename<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用户及用户组管理</title>
      <link href="/2018/07/22/linux/user/"/>
      <url>/2018/07/22/linux/user/</url>
      
        <content type="html"><![CDATA[<h3 id="查看存储用户账号"><a href="#查看存储用户账号" class="headerlink" title="查看存储用户账号"></a>查看存储用户账号</h3><pre class="line-numbers language-js"><code class="language-js">cat <span class="token operator">/</span>etc<span class="token operator">/</span>passwd输出的结构用户名<span class="token punctuation">:</span>口令<span class="token punctuation">:</span>用户标识号<span class="token punctuation">:</span>组标识号<span class="token punctuation">:</span>注释性描述<span class="token punctuation">:</span>主目录<span class="token punctuation">:</span>登录Shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看存储组账号"><a href="#查看存储组账号" class="headerlink" title="查看存储组账号"></a>查看存储组账号</h3><pre class="line-numbers language-js"><code class="language-js">cat <span class="token operator">/</span>etc<span class="token operator">/</span>group  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="查看存储用户账号的密码"><a href="#查看存储用户账号的密码" class="headerlink" title="查看存储用户账号的密码"></a>查看存储用户账号的密码</h3><pre class="line-numbers language-js"><code class="language-js">cat <span class="token operator">/</span>etc<span class="token operator">/</span>shadow   <span class="token comment" spellcheck="true">//输出结构</span><span class="token comment" spellcheck="true">//登录名:加密口令:最后一次修改时间:最小时间间隔:最大时间间隔:警告时间:不活动时间:失效时间:标志</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看存储用户组账号的密码"><a href="#查看存储用户组账号的密码" class="headerlink" title="查看存储用户组账号的密码"></a>查看存储用户组账号的密码</h3><pre class="line-numbers language-js"><code class="language-js">cat <span class="token operator">/</span>etc<span class="token operator">/</span>gshadow  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="建立用户帐号"><a href="#建立用户帐号" class="headerlink" title="建立用户帐号"></a>建立用户帐号</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//参数</span><span class="token operator">-</span>c comment 指定一段注释性描述。<span class="token operator">-</span>d 目录 指定用户主目录，如果此目录不存在，则同时使用<span class="token operator">-</span>m选项，可以创建主目录。<span class="token operator">-</span>g 用户组 指定用户所属的用户组。<span class="token operator">-</span>G 用户组，用户组 指定用户所属的附加组。<span class="token operator">-</span>s Shell文件 指定用户的登录Shell。<span class="token operator">-</span>u 用户号 指定用户的用户号，如果同时有<span class="token operator">-</span>o选项，则可以重复使用其他用户的标识号。useradd renbo  添加一般用户useradd <span class="token operator">-</span>g root renbo  为添加用户指定用户组useradd <span class="token operator">-</span>r renbo  创建系统用户useradd <span class="token operator">-</span>d <span class="token operator">/</span>home renbo  为新添加的用户指定home目录useradd caojh <span class="token operator">-</span>u <span class="token number">544</span>  建立用户且制定ID<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="删除用户帐号"><a href="#删除用户帐号" class="headerlink" title="删除用户帐号"></a>删除用户帐号</h3><pre class="line-numbers language-js"><code class="language-js">userdel  同建立账号用法相同 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="新建组"><a href="#新建组" class="headerlink" title="新建组"></a>新建组</h3><pre class="line-numbers language-js"><code class="language-js">groupadd 组名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="删除组"><a href="#删除组" class="headerlink" title="删除组"></a>删除组</h3><pre class="line-numbers language-js"><code class="language-js">groupdel 组名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="修改账号"><a href="#修改账号" class="headerlink" title="修改账号"></a>修改账号</h3><pre class="line-numbers language-js"><code class="language-js">usermod 选项 用户名和useradd用法相同<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="指定口令"><a href="#指定口令" class="headerlink" title="指定口令"></a>指定口令</h3><p>用户口令管理给root设置密码(用户账号刚创建时没有口令，但是被系统锁定，无法使用，必须为其指定口令后才可以使用，即使是指定空口令)</p><pre class="line-numbers language-js"><code class="language-js">passwd root <span class="token operator">-</span>l 锁定口令，即禁用账号。<span class="token operator">-</span>u 口令解锁。<span class="token operator">-</span>d 使账号无口令。<span class="token operator">-</span>f 强迫用户下次登录时修改口令。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="切换用户"><a href="#切换用户" class="headerlink" title="切换用户"></a>切换用户</h3><pre class="line-numbers language-js"><code class="language-js">su root su <span class="token operator">-</span> root   切换到root用户改变环境变量su user   切换用户，加载配置文件<span class="token punctuation">.</span>bashrcsu <span class="token operator">-</span> user 切换用户，加载配置文件<span class="token operator">/</span>etc<span class="token operator">/</span>profile ，加载bash_profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="系统环境变量文件"><a href="#系统环境变量文件" class="headerlink" title="系统环境变量文件"></a>系统环境变量文件</h3><pre class="line-numbers language-js"><code class="language-js">cat <span class="token operator">/</span>etc<span class="token operator">/</span>profile 查看vim <span class="token operator">/</span>etc<span class="token operator">/</span>profile 编辑<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="用户环境变量文件"><a href="#用户环境变量文件" class="headerlink" title="用户环境变量文件"></a>用户环境变量文件</h3><pre class="line-numbers language-js"><code class="language-js">cat <span class="token operator">/</span>etc<span class="token operator">/</span>bash_profile 查看vim <span class="token operator">/</span>etc<span class="token operator">/</span>bash_profile 编辑cat <span class="token punctuation">.</span>bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="更改文件的用户及用户组"><a href="#更改文件的用户及用户组" class="headerlink" title="更改文件的用户及用户组"></a>更改文件的用户及用户组</h3><pre class="line-numbers language-js"><code class="language-js">sudo chown <span class="token punctuation">[</span><span class="token operator">-</span>R<span class="token punctuation">]</span> owner<span class="token punctuation">[</span><span class="token punctuation">:</span>group<span class="token punctuation">]</span> <span class="token punctuation">{</span>File<span class="token operator">|</span>Directory<span class="token punctuation">}</span>例如：还以jdk<span class="token operator">-</span>7u21<span class="token operator">-</span>linux<span class="token operator">-</span>i586<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz为例。属于用户hadoop，组hadoop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="切换此文件所属的用户及组"><a href="#切换此文件所属的用户及组" class="headerlink" title="切换此文件所属的用户及组"></a>切换此文件所属的用户及组</h3><pre class="line-numbers language-js"><code class="language-js">sudo chown root<span class="token punctuation">:</span>root jdk<span class="token operator">-</span>7u21<span class="token operator">-</span>linux<span class="token operator">-</span>i586<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关机重启操作</title>
      <link href="/2018/07/16/linux/shutdown/"/>
      <url>/2018/07/16/linux/shutdown/</url>
      
        <content type="html"><![CDATA[<h3 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h3><pre class="line-numbers language-js"><code class="language-js">shutdown <span class="token operator">-</span>r  关机重启shutdown <span class="token operator">-</span>h  关机不重启shutdown now  立刻关机<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="halt"><a href="#halt" class="headerlink" title="halt"></a>halt</h3><p>关机</p><h3 id="reboot"><a href="#reboot" class="headerlink" title="reboot"></a>reboot</h3><p>重启</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux备份操作</title>
      <link href="/2018/07/15/linux/backup/"/>
      <url>/2018/07/15/linux/backup/</url>
      
        <content type="html"><![CDATA[<h3 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h3><pre class="line-numbers language-js"><code class="language-js">tar <span class="token operator">-</span>cvf log<span class="token punctuation">.</span>tar log2012<span class="token punctuation">.</span>log    仅打包，不压缩！ tar <span class="token operator">-</span>zcvf log<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz log2012<span class="token punctuation">.</span>log   打包后，以 gzip 压缩 tar <span class="token operator">-</span>jcvf log<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>bz2 log2012<span class="token punctuation">.</span>log  打包后，以 bzip2 压缩 tar <span class="token operator">-</span>zxvf <span class="token operator">/</span>opt<span class="token operator">/</span>soft<span class="token operator">/</span>test<span class="token operator">/</span>log<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz 解压缩<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="dump"><a href="#dump" class="headerlink" title="dump"></a>dump</h3><pre class="line-numbers language-js"><code class="language-js">dump <span class="token operator">-</span>0aj <span class="token operator">-</span>f <span class="token operator">/</span>tmp<span class="token operator">/</span>home0<span class="token punctuation">.</span>bak <span class="token operator">/</span>home  制作一个 <span class="token string">'/home'</span> 目录的完整备份dump <span class="token operator">-</span>1aj <span class="token operator">-</span>f <span class="token operator">/</span>tmp<span class="token operator">/</span>home0<span class="token punctuation">.</span>bak <span class="token operator">/</span>home  制作一个 <span class="token string">'/home'</span> 目录的交互式备份<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="restore"><a href="#restore" class="headerlink" title="restore"></a>restore</h3><pre class="line-numbers language-js"><code class="language-js">restore <span class="token operator">-</span><span class="token keyword">if</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>home0<span class="token punctuation">.</span>bak  还原备份<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><pre class="line-numbers language-js"><code class="language-js">rsync <span class="token operator">-</span>rogpav <span class="token operator">--</span><span class="token keyword">delete</span> <span class="token operator">/</span>home <span class="token operator">/</span>tmp  同步两边的目录 rsync <span class="token operator">-</span>rogpav <span class="token operator">-</span>e ssh <span class="token operator">--</span><span class="token keyword">delete</span> <span class="token operator">/</span>home ip_address<span class="token punctuation">:</span><span class="token operator">/</span>tmp  通过SSH通道rsync rsync <span class="token operator">-</span>az <span class="token operator">-</span>e ssh <span class="token operator">--</span><span class="token keyword">delete</span> ip_addr<span class="token punctuation">:</span><span class="token operator">/</span>home<span class="token operator">/</span><span class="token keyword">public</span> <span class="token operator">/</span>home<span class="token operator">/</span>local  通过ssh和压缩将一个远程目录同步到本地目录 rsync <span class="token operator">-</span>az <span class="token operator">-</span>e ssh <span class="token operator">--</span><span class="token keyword">delete</span> <span class="token operator">/</span>home<span class="token operator">/</span>local ip_addr<span class="token punctuation">:</span><span class="token operator">/</span>home<span class="token operator">/</span><span class="token keyword">public</span>  通过ssh和压缩将本地目录同步到远程目录 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux软件包管理</title>
      <link href="/2018/07/12/linux/package/"/>
      <url>/2018/07/12/linux/package/</url>
      
        <content type="html"><![CDATA[<h3 id="dpkg"><a href="#dpkg" class="headerlink" title="dpkg"></a>dpkg</h3><p>(Debian Package)管理工具，软件包名以.deb后缀</p><pre class="line-numbers language-js"><code class="language-js">sudo dpkg <span class="token operator">-</span>i <span class="token keyword">package</span><span class="token punctuation">.</span>deb 安装<span class="token operator">/</span>更新 deb 包 sudo dpkg <span class="token operator">-</span>r <span class="token keyword">package</span> 删除 deb 包 sudo dpkg <span class="token operator">-</span>l 获取所有已经安装的 deb 包 sudo dpkg <span class="token operator">-</span>s <span class="token keyword">package</span> 获得已经安装的包的信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="APT"><a href="#APT" class="headerlink" title="APT"></a>APT</h3><p>（Advanced Packaging Tool）</p><pre class="line-numbers language-js"><code class="language-js">sudo apt<span class="token operator">-</span><span class="token keyword">get</span> install <span class="token keyword">package</span> 安装<span class="token keyword">package</span>包sudo apt<span class="token operator">-</span><span class="token keyword">get</span> remove <span class="token keyword">package</span> 卸载<span class="token keyword">package</span>包sudo apt<span class="token operator">-</span><span class="token keyword">get</span> upgrade 更新所有<span class="token keyword">package</span>包  sudo apt<span class="token operator">-</span><span class="token keyword">get</span> update 更新<span class="token keyword">package</span>包                             <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="YUM-软件包升级器"><a href="#YUM-软件包升级器" class="headerlink" title="YUM 软件包升级器"></a>YUM 软件包升级器</h3><pre class="line-numbers language-js"><code class="language-js">yum install <span class="token keyword">package</span> 下载并安装rpm包 yum update <span class="token keyword">package</span> 更新rpm包 yum remove <span class="token keyword">package</span> 删除rpm包 yum list 列出当前系统中安装的所有包yum search <span class="token keyword">package</span> 在rpm仓库中搜寻软件包 yum clean packages 清理rpm缓存删除下载的包 yum clean headers 删除所有头文件yum clean all 删除所有缓存的包和头文件 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="RPM包"><a href="#RPM包" class="headerlink" title="RPM包"></a>RPM包</h3><pre class="line-numbers language-js"><code class="language-js">rpm <span class="token operator">-</span>ivh <span class="token keyword">package</span><span class="token punctuation">.</span>rpm 安装rpm包 rpm <span class="token operator">-</span>ivh <span class="token operator">--</span>nodeeps <span class="token keyword">package</span><span class="token punctuation">.</span>rpm 安装rpm包而忽略依赖关系警告 rpm <span class="token operator">-</span>U <span class="token keyword">package</span><span class="token punctuation">.</span>rpm 更新rpm包但不改变其配置文件 rpm <span class="token operator">-</span>F <span class="token keyword">package</span><span class="token punctuation">.</span>rpm 更新确定已经安装的rpm包 rpm <span class="token operator">-</span>e <span class="token keyword">package</span><span class="token punctuation">.</span>rpm 删除rpm包 rpm <span class="token operator">-</span>qa 显示系统中所有已经安装的rpm包 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>rpm文件是Redhat支持的软件包格式，而.deb是Debian上支持软件包的扩展名</p><p>由于ubuntu是对Debian的扩展，在ubuntu下不能直接使.rpm文件的，需要将.rmp转换成.deb</p><p>解决方法</p><p>1.安装alien，执行<code>sudo apt-get install alien</code></p><p>2.使用alien，执行<code>sudo alien abc.rpm</code></p><p>3.执行完成后，目录下会生成一个abc.deb文件</p><p>4.安装并使用dpkg</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux打包压缩相关指令</title>
      <link href="/2018/07/10/linux/compression/"/>
      <url>/2018/07/10/linux/compression/</url>
      
        <content type="html"><![CDATA[<h3 id="bzip2-选项-参数"><a href="#bzip2-选项-参数" class="headerlink" title="bzip2(选项)(参数)"></a>bzip2(选项)(参数)</h3><p>命令用于创建和管理（包括解压缩）</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token operator">-</span>c或——stdout：将压缩与解压缩的结果送到标准输出；  <span class="token operator">-</span>d或——decompress：执行解压缩；  <span class="token operator">-</span>f或<span class="token operator">-</span>force：bzip2在压缩或解压缩时，若输出文件与现有文件同名，预设不会覆盖现有文件。若要覆盖。请使用此参数；  <span class="token operator">-</span>h或——help：在线帮助；  <span class="token operator">-</span>k或——keep：bzip2在压缩或解压缩后，会删除原始文件。若要保留原始文件，请使用此参数；  <span class="token operator">-</span>s或——small：降低程序执行时内存的使用量；  <span class="token operator">-</span>t或——test：测试<span class="token punctuation">.</span>bz2压缩文件的完整性；  <span class="token operator">-</span>v或——verbose：压缩或解压缩文件时，显示详细的信息；  <span class="token operator">-</span>z或——compress：强制执行压缩；  <span class="token operator">-</span>V或——version：显示版本信息；  <span class="token operator">--</span>repetitive<span class="token operator">-</span>best：若文件中有重复出现的资料时，可利用此参数提高压缩效果；  <span class="token operator">--</span>repetitive<span class="token operator">-</span>fast：若文件中有重复出现的资料时，可利用此参数加快执行效果。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="gunzip-选项-参数"><a href="#gunzip-选项-参数" class="headerlink" title="gunzip(选项)(参数)"></a>gunzip(选项)(参数)</h3><p>命令用来解压缩文件</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token operator">-</span>a或——ascii：使用ASCII文字模式；  <span class="token operator">-</span>c或<span class="token operator">--</span>stdout或<span class="token operator">--</span>to<span class="token operator">-</span>stdout：把解压后的文件输出到标准输出设备；  <span class="token operator">-</span>f或<span class="token operator">-</span>force：强行解开压缩文件，不理会文件名称或硬连接是否存在以及该文件是否为符号连接；  <span class="token operator">-</span>h或——help：在线帮助；  <span class="token operator">-</span>l或——list：列出压缩文件的相关信息；  <span class="token operator">-</span>L或——license：显示版本与版权信息；  <span class="token operator">-</span>n或<span class="token operator">--</span>no<span class="token operator">-</span>name：解压缩时，若压缩文件内含有原来的文件名称及时间戳记，则将其忽略不予处理；  <span class="token operator">-</span>N或——name：解压缩时，若压缩文件内含有原来的文件名称及时间戳记，则将其回存到解开的文件上；  <span class="token operator">-</span>q或——quiet：不显示警告信息；  <span class="token operator">-</span>r或——recursive：递归处理，将指定目录下的所有文件及子目录一并处理；  <span class="token operator">-</span>S或<span class="token operator">&lt;</span>压缩字尾字符串<span class="token operator">></span>或<span class="token operator">--</span><span class="token operator">--</span>suffix<span class="token operator">&lt;</span>压缩字尾字符串<span class="token operator">></span>：更改压缩字尾字符串；  <span class="token operator">-</span>t或——test：测试压缩文件是否正确无误；  <span class="token operator">-</span>v或——verbose：显示指令执行过程；  <span class="token operator">-</span>V或——version：显示版本信息；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="gzip-选项-参数"><a href="#gzip-选项-参数" class="headerlink" title="gzip(选项)(参数)"></a>gzip(选项)(参数)</h3><p>命令用来压缩文件</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token operator">-</span>a或——ascii：使用ASCII文字模式；  <span class="token operator">-</span>d或<span class="token operator">--</span>decompress或<span class="token operator">--</span><span class="token operator">--</span>uncompress：解开压缩文件；  <span class="token operator">-</span>f或——force：强行压缩文件。不理会文件名称或硬连接是否存在以及该文件是否为符号连接；  <span class="token operator">-</span>h或——help：在线帮助；  <span class="token operator">-</span>l或——list：列出压缩文件的相关信息；  <span class="token operator">-</span>L或——license：显示版本与版权信息；  <span class="token operator">-</span>n或<span class="token operator">--</span>no<span class="token operator">-</span>name：压缩文件时，不保存原来的文件名称及时间戳记；  <span class="token operator">-</span>N或——name：压缩文件时，保存原来的文件名称及时间戳记；  <span class="token operator">-</span>q或——quiet：不显示警告信息；  <span class="token operator">-</span>r或——recursive：递归处理，将指定目录下的所有文件及子目录一并处理；  <span class="token operator">-</span>S或<span class="token operator">&lt;</span>压缩字尾字符串<span class="token operator">></span>或<span class="token operator">--</span><span class="token operator">--</span>suffix<span class="token operator">&lt;</span>压缩字尾字符串<span class="token operator">></span>：更改压缩字尾字符串；  <span class="token operator">-</span>t或——test：测试压缩文件是否正确无误；  <span class="token operator">-</span>v或——verbose：显示指令执行过程；  <span class="token operator">-</span>V或——version：显示版本信息；  <span class="token operator">-</span><span class="token operator">&lt;</span>压缩效率<span class="token operator">></span>：压缩效率是一个介于<span class="token number">1</span><span class="token operator">~</span><span class="token number">9</span>的数值，预设值为“<span class="token number">6</span>”，指定愈大的数值，压缩效率就会愈高；  <span class="token operator">--</span>best：此参数的效果和指定“<span class="token operator">-</span><span class="token number">9</span>”参数相同；  <span class="token operator">--</span>fast：此参数的效果和指定“<span class="token operator">-</span><span class="token number">1</span>”参数相同。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="tar-选项-参数"><a href="#tar-选项-参数" class="headerlink" title="tar(选项)(参数)"></a>tar(选项)(参数)</h3><p>命令用来解压压缩文件</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token operator">-</span>A或<span class="token operator">--</span>catenate：新增文件到以存在的备份文件；  <span class="token operator">-</span>B：设置区块大小；  <span class="token operator">-</span>c或<span class="token operator">--</span>create：建立新的备份文件；  <span class="token operator">-</span>C <span class="token operator">&lt;</span>目录<span class="token operator">></span>：这个选项用在解压缩，若要在特定目录解压缩，可以使用这个选项。  <span class="token operator">-</span>d：记录文件的差别；  <span class="token operator">-</span>x或<span class="token operator">--</span>extract或<span class="token operator">--</span><span class="token keyword">get</span>：从备份文件中还原文件；  <span class="token operator">-</span>t或<span class="token operator">--</span>list：列出备份文件的内容；  <span class="token operator">-</span>z或<span class="token operator">--</span>gzip或<span class="token operator">--</span>ungzip：通过gzip指令处理备份文件；  <span class="token operator">-</span>Z或<span class="token operator">--</span>compress或<span class="token operator">--</span>uncompress：通过compress指令处理备份文件；  <span class="token operator">-</span>f<span class="token operator">&lt;</span>备份文件<span class="token operator">></span>或<span class="token operator">--</span>file<span class="token operator">=</span><span class="token operator">&lt;</span>备份文件<span class="token operator">></span>：指定备份文件；  <span class="token operator">-</span>v或<span class="token operator">--</span>verbose：显示指令执行过程；  <span class="token operator">-</span>r：添加文件到已经压缩的文件；  <span class="token operator">-</span>u：添加改变了和现有的文件到已经存在的压缩文件；  <span class="token operator">-</span>j：支持bzip2解压文件；  <span class="token operator">-</span>v：显示操作过程；  <span class="token operator">-</span>l：文件系统边界设置；  <span class="token operator">-</span>k：保留原有文件不覆盖；  <span class="token operator">-</span>m：保留文件不被覆盖；  <span class="token operator">-</span>w：确认压缩文件的正确性；  <span class="token operator">-</span>p或<span class="token operator">--</span>same<span class="token operator">-</span>permissions：用原来的文件权限还原文件；  <span class="token operator">-</span>P或<span class="token operator">--</span>absolute<span class="token operator">-</span>names：文件名使用绝对名称，不移除文件名称前的“<span class="token operator">/</span>”号；  <span class="token operator">-</span>N <span class="token operator">&lt;</span>日期格式<span class="token operator">></span> 或 <span class="token operator">--</span>newer<span class="token operator">=</span><span class="token operator">&lt;</span>日期时间<span class="token operator">></span>：只将较指定日期更新的文件保存到备份文件里；  <span class="token operator">--</span>exclude<span class="token operator">=</span><span class="token operator">&lt;</span>范本样式<span class="token operator">></span>：排除符合范本样式的文件。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  实例<br></p><pre class="line-numbers language-js"><code class="language-js">  tar <span class="token operator">-</span>cvf log<span class="token punctuation">.</span>tar log2012<span class="token punctuation">.</span>log    仅打包，不压缩！   tar <span class="token operator">-</span>zcvf log<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz log2012<span class="token punctuation">.</span>log   打包后，以 gzip 压缩   tar <span class="token operator">-</span>jcvf log<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>bz2 log2012<span class="token punctuation">.</span>log  打包后，以 bzip2 压缩 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="zip-选项-参数"><a href="#zip-选项-参数" class="headerlink" title="zip(选项)(参数)"></a>zip(选项)(参数)</h3><p>命令可以用来解压缩文件</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token operator">-</span>A：调整可执行的自动解压缩文件；  <span class="token operator">-</span>b<span class="token operator">&lt;</span>工作目录<span class="token operator">></span>：指定暂时存放文件的目录；  <span class="token operator">-</span>c：替每个被压缩的文件加上注释；  <span class="token operator">-</span>d：从压缩文件内删除指定的文件；  <span class="token operator">-</span>D：压缩文件内不建立目录名称；  <span class="token operator">-</span>f：此参数的效果和指定“<span class="token operator">-</span>u”参数类似，但不仅更新既有文件，如果某些文件原本不存在于压缩文件内，使用本参数会一并将其加入压缩文件中；  <span class="token operator">-</span>F：尝试修复已损坏的压缩文件；  <span class="token operator">-</span>g：将文件压缩后附加在已有的压缩文件之后，而非另行建立新的压缩文件；  <span class="token operator">-</span>h：在线帮助；  <span class="token operator">-</span>i<span class="token operator">&lt;</span>范本样式<span class="token operator">></span>：只压缩符合条件的文件；  <span class="token operator">-</span>j：只保存文件名称及其内容，而不存放任何目录名称；  <span class="token operator">-</span>J：删除压缩文件前面不必要的数据；  <span class="token operator">-</span>k：使用MS<span class="token operator">-</span>DOS兼容格式的文件名称；  <span class="token operator">-</span>l：压缩文件时，把LF字符置换成LF<span class="token operator">+</span>CR字符；  <span class="token operator">-</span>ll：压缩文件时，把LF<span class="token operator">+</span>cp字符置换成LF字符；  <span class="token operator">-</span>L：显示版权信息；  <span class="token operator">-</span>m：将文件压缩并加入压缩文件后，删除原始文件，即把文件移到压缩文件中；  <span class="token operator">-</span>n<span class="token operator">&lt;</span>字尾字符串<span class="token operator">></span>：不压缩具有特定字尾字符串的文件；  <span class="token operator">-</span>o：以压缩文件内拥有最新更改时间的文件为准，将压缩文件的更改时间设成和该文件相同；  <span class="token operator">-</span>q：不显示指令执行过程；  <span class="token operator">-</span>r：递归处理，将指定目录下的所有文件和子目录一并处理；  <span class="token operator">-</span>S：包含系统和隐藏文件；  <span class="token operator">-</span>t<span class="token operator">&lt;</span>日期时间<span class="token operator">></span>：把压缩文件的日期设成指定的日期；  <span class="token operator">-</span>T：检查备份文件内的每个文件是否正确无误；  <span class="token operator">-</span>u：更换较新的文件到压缩文件内；  <span class="token operator">-</span>v：显示指令执行过程或显示版本信息；  <span class="token operator">-</span>V：保存VMS操作系统的文件属性；  <span class="token operator">-</span>w：在文件名称里假如版本编号，本参数仅在VMS操作系统下有效；  <span class="token operator">-</span>x<span class="token operator">&lt;</span>范本样式<span class="token operator">></span>：压缩时排除符合条件的文件；  <span class="token operator">-</span>X：不保存额外的文件属性；  <span class="token operator">-</span>y：直接保存符号连接，而非该链接所指向的文件，本参数仅在UNIX之类的系统下有效；  <span class="token operator">-</span>z：替压缩文件加上注释；  <span class="token operator">-</span>$：保存第一个被压缩文件所在磁盘的卷册名称；  <span class="token operator">-</span><span class="token operator">&lt;</span>压缩效率<span class="token operator">></span>：压缩效率是一个介于<span class="token number">1</span><span class="token operator">~</span><span class="token number">9</span>的数值。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  实例<br></p><pre class="line-numbers language-js"><code class="language-js">  zip file1<span class="token punctuation">.</span>zip file1 创建一个zip格式的压缩包   zip <span class="token operator">-</span>r file1<span class="token punctuation">.</span>zip file1 file2 dir1 将几个文件和目录同时压缩成一个zip格式的压缩包   unzip file1<span class="token punctuation">.</span>zip 解压一个zip格式压缩包 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>系统管理指令</title>
      <link href="/2018/07/02/linux/system/"/>
      <url>/2018/07/02/linux/system/</url>
      
        <content type="html"><![CDATA[<h3 id="stat"><a href="#stat" class="headerlink" title="stat"></a>stat</h3><p>显示指定文件的详细信息</p><h3 id="who"><a href="#who" class="headerlink" title="who"></a>who</h3><p>显示在线登陆用户</p><h3 id="whoami"><a href="#whoami" class="headerlink" title="whoami"></a>whoami</h3><p>显示当前操作用户</p><h3 id="hostname"><a href="#hostname" class="headerlink" title="hostname"></a>hostname</h3><p>显示主机名</p><h3 id="uname"><a href="#uname" class="headerlink" title="uname"></a>uname</h3><p>显示系统信息</p><h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3><p>动态显示当前耗费资源最多进程信息</p><h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><p>查看进程状态 </p><pre class="line-numbers language-js"><code class="language-js">ps <span class="token operator">-</span>aux<span class="token operator">-</span>A ：所有的进程均显示出来，与 <span class="token operator">-</span>e 具有同样的效用<span class="token operator">-</span>a ：显示现行终端机下的所有进程，包括其他用户的进程<span class="token operator">-</span>u ：以用户为主的进程状态x ：通常与 a 这个参数一起使用，可列出较完整信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="du"><a href="#du" class="headerlink" title="du"></a>du</h3><p>查看目录大小 <code>du -h /home</code>带有单位显示目录信息</p><h3 id="df"><a href="#df" class="headerlink" title="df"></a>df</h3><p>查看磁盘大小 <code>df -h</code>带有单位显示磁盘信息</p><h3 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h3><p>查看网络情况</p><h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>测试网络连通</p><h3 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h3><p>显示网络状态信息</p><h3 id="man"><a href="#man" class="headerlink" title="man"></a>man</h3><p>命令帮助文档如：<code>man ls</code></p><h3 id="clear"><a href="#clear" class="headerlink" title="clear"></a>clear</h3><p>清屏</p><h3 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h3><p>对命令重命名</p><pre class="line-numbers language-js"><code class="language-js">alias l<span class="token operator">=</span><span class="token string">"ls"</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h3><p>杀死进程，可以先用ps 或 top命令查看进程的id，然后再用kill命令杀死进程。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用指令</title>
      <link href="/2018/06/23/linux/instructions/"/>
      <url>/2018/06/23/linux/instructions/</url>
      
        <content type="html"><![CDATA[<h3 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h3><p>显示文件或目录</p><pre class="line-numbers language-js"><code class="language-js">ls <span class="token operator">-</span>F  <span class="token comment" spellcheck="true">//显示文件或目录</span>ls <span class="token operator">-</span>l  <span class="token comment" spellcheck="true">//列出文件详细信息l(list)</span>ls <span class="token operator">-</span>a  <span class="token comment" spellcheck="true">//列出当前目录下所有文件及目录，包括隐藏的a(all)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h3><p>创建目录</p><pre class="line-numbers language-js"><code class="language-js">mkdir dir  <span class="token comment" spellcheck="true">//创建一个dir的目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>mkdir -p 创建目录，若无父目录，则创建p(parent) <br></p><pre><code>mkdir -p /study/dir1/dir2  //创建一个的目录树</code></pre><h3 id="cd"><a href="#cd" class="headerlink" title="cd"></a>cd</h3><p>切换目录</p><pre class="line-numbers language-js"><code class="language-js">cd <span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">//返回上级目录</span>cd <span class="token operator">/</span>home  <span class="token comment" spellcheck="true">//进入指定目录</span>cd <span class="token operator">-</span> <span class="token comment" spellcheck="true">//返回上次所在的目录 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="touch"><a href="#touch" class="headerlink" title="touch"></a>touch</h3><p>修改文件或者目录的时间属性，包括存取时间和更改时间。若文件不存在，系统会建立一个新的文件</p><pre class="line-numbers language-js"><code class="language-js">touch temp  <span class="token comment" spellcheck="true">//创建名为temp的空文件</span>touch temp  <span class="token comment" spellcheck="true">//如果temp存在则是修改文件的时间属性 可通过ls -l temp 查看文件属性</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><p>命令行输出内容</p><pre class="line-numbers language-js"><code class="language-js">echo <span class="token string">'zhangsan'</span> <span class="token operator">></span><span class="token operator">></span> temp <span class="token comment" spellcheck="true">//创建名为temp带有zhangsan内容的文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h3><p>查看文件内容</p><pre class="line-numbers language-js"><code class="language-js">cat temp  <span class="token comment" spellcheck="true">//查看temp文件中的内容</span>cat <span class="token operator">-</span>n temp  <span class="token comment" spellcheck="true">//标示文件的行数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h3><p>拷贝</p><pre class="line-numbers language-js"><code class="language-js">cp temp newtemp  <span class="token comment" spellcheck="true">//复制temp文件</span>cp temp<span class="token operator">/</span><span class="token operator">*</span> <span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">//复制temp目录下的所有文件到当前工作目录 </span>cp <span class="token operator">-</span>a <span class="token operator">/</span>temp<span class="token operator">/</span>dir1 <span class="token punctuation">.</span> <span class="token comment" spellcheck="true">//复制/temp/dir1目录到当前工作目录 </span>cp <span class="token operator">-</span>a temp newtemp <span class="token comment" spellcheck="true">//复制temp目录 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="mv"><a href="#mv" class="headerlink" title="mv"></a>mv</h3><p>移动或重命名</p><pre class="line-numbers language-js"><code class="language-js">mv temp newtemp <span class="token comment" spellcheck="true">//重命名/移动一个目录 </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="rm"><a href="#rm" class="headerlink" title="rm"></a>rm</h3><p>删除文件</p><pre class="line-numbers language-js"><code class="language-js">rm <span class="token operator">-</span>f file  <span class="token comment" spellcheck="true">//删除file文件' </span>rmdir dir1  <span class="token comment" spellcheck="true">//删除dir1的目录' </span>rm <span class="token operator">-</span>rf dir1 <span class="token comment" spellcheck="true">//递归删除dir1目录所有的内容</span>rm <span class="token operator">-</span>rf dir1 dir2 <span class="token comment" spellcheck="true">//同时删除两个目录及它们的内容 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><p>在文件系统中查找某文件</p><pre class="line-numbers language-js"><code class="language-js">find <span class="token operator">/</span> <span class="token operator">-</span>name file1  <span class="token comment" spellcheck="true">//从根文件系统查找文件和目录 </span>find <span class="token operator">/</span> <span class="token operator">-</span>user renbo  <span class="token comment" spellcheck="true">//查找属于用户 'renbo' 的文件和目录 </span>find <span class="token operator">/</span>home<span class="token operator">/</span>renbo <span class="token operator">-</span>name \<span class="token operator">*</span><span class="token punctuation">.</span>bin  <span class="token comment" spellcheck="true">// 查找带home/renbo目录中有.bin结尾的文件 </span>find <span class="token operator">/</span> <span class="token operator">-</span>name \<span class="token operator">*</span><span class="token punctuation">.</span>rpm <span class="token operator">-</span>exec chmod <span class="token number">755</span> <span class="token string">'{}'</span> \ <span class="token comment" spellcheck="true">//查找以.rpm结尾的文件并定义其权限 </span>find <span class="token operator">/</span> <span class="token operator">-</span>xdev <span class="token operator">-</span>name \<span class="token operator">*</span><span class="token punctuation">.</span>rpm  <span class="token comment" spellcheck="true">//查找所有以.rpm结尾的文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="wc"><a href="#wc" class="headerlink" title="wc"></a>wc</h3><p>统计文本中行数、字数、字符数</p><pre class="line-numbers language-js"><code class="language-js">wc gitcommit<span class="token punctuation">.</span>sh  <span class="token comment" spellcheck="true">//3   13  73 gitcommit.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h3><p>在文本文件中查找某个字符串</p><pre class="line-numbers language-js"><code class="language-js">grep Aug <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>messages  <span class="token comment" spellcheck="true">//在文件 '/var/log/messages'中查找关键词"Aug" </span>grep <span class="token operator">^</span>Aug <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>messages  <span class="token comment" spellcheck="true">//在文件 '/var/log/messages'中查找以"Aug"开始的词汇 </span>grep <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>messages <span class="token comment" spellcheck="true">//选择 '/var/log/messages' 文件中所有包含数字的行 </span>grep Aug <span class="token operator">-</span>R <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span><span class="token operator">*</span>  <span class="token comment" spellcheck="true">//在目录 '/var/log' 及随后的目录中搜索字符串"Aug" </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="tree"><a href="#tree" class="headerlink" title="tree"></a>tree</h3><p>树形结构显示目录，需要安装tree包</p><pre class="line-numbers language-js"><code class="language-js">tree  <span class="token comment" spellcheck="true">//显示文件和目录由根目录开始的树形结构 </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="pwd"><a href="#pwd" class="headerlink" title="pwd"></a>pwd</h3><p>显示当前目录</p><pre class="line-numbers language-js"><code class="language-js">pwd 显示当前路径<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="ln"><a href="#ln" class="headerlink" title="ln"></a>ln</h3><p>创建链接文件</p><pre class="line-numbers language-js"><code class="language-js">ln <span class="token operator">-</span>s file1 lnk1  <span class="token comment" spellcheck="true">//创建一个指向文件或目录的软链接 </span>ln file1 lnk1  <span class="token comment" spellcheck="true">//创建一个指向文件或目录的物理链接 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="more、less"><a href="#more、less" class="headerlink" title="more、less"></a>more、less</h3><p>分页显示文本文件内容</p><pre class="line-numbers language-js"><code class="language-js">more file1  <span class="token comment" spellcheck="true">//查看一个长文件的内容 </span>less file1  <span class="token comment" spellcheck="true">//类似于 'more' 命令，但是它允许在文件中和正向操作一样的反向操作 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="head、tail"><a href="#head、tail" class="headerlink" title="head、tail"></a>head、tail</h3><pre class="line-numbers language-js"><code class="language-js">head <span class="token operator">-</span><span class="token number">2</span> file1 <span class="token comment" spellcheck="true">//查看一个文件的前两行 </span>tail <span class="token operator">-</span><span class="token number">2</span> file1 <span class="token comment" spellcheck="true">//查看一个文件的最后两行 </span>tail <span class="token operator">-</span>f <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>messages <span class="token comment" spellcheck="true">//实时查看被添加到一个文件中的内容 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSS预处理器</title>
      <link href="/2017/07/01/css/css-preprocessor/"/>
      <url>/2017/07/01/css/css-preprocessor/</url>
      
        <content type="html"><![CDATA[<p>CSS 预处理器赋予我们很多css强大的功能，能够很清晰地实现代码的分层、复用和依赖管理，提高开发效率</p><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><ol><li>Less 的基本语法跟原生的css的风格几乎差不多</li><li>Sass、Stylus 利用缩进、空格和换行来减少需要输入的字符</li></ol><p>Sass</p><pre class="line-numbers language-css"><code class="language-css"><span class="token number">.</span>header  <span class="token property">background-color</span><span class="token punctuation">:</span>red<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>Less &amp; SCSS</p><pre class="line-numbers language-css"><code class="language-css"><span class="token selector"><span class="token class">.header</span> </span><span class="token punctuation">{</span>  <span class="token property">background-color</span><span class="token punctuation">:</span>red<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Stylus</p><pre class="line-numbers language-css"><code class="language-css"><span class="token number">.</span>header  <span class="token property">background-color</span><span class="token punctuation">:</span>red<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="嵌套语法"><a href="#嵌套语法" class="headerlink" title="嵌套语法"></a>嵌套语法</h3><p>嵌套语法都是一致的,区别是 Sass 和 Stylus 可以不用书写大括号</p><p>less</p><pre class="line-numbers language-css"><code class="language-css"><span class="token selector"><span class="token class">.header</span> </span><span class="token punctuation">{</span>  <span class="token selector">&amp;<span class="token class">.title</span> </span><span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>为 CSS 增加了一种有效的复用方式，减少CSS书写重复</p><p>Sass</p><pre class="line-numbers language-css"><code class="language-css">$<span class="token property">bg</span><span class="token punctuation">:</span> <span class="token hexcode">#ccc</span><span class="token punctuation">;</span><span class="token number">.</span>header   <span class="token property">background-color</span><span class="token punctuation">:</span>$bg<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Less</p><pre class="line-numbers language-css"><code class="language-css"><span class="token atrule"><span class="token rule">@bg</span><span class="token punctuation">:</span> #ccc<span class="token punctuation">;</span></span><span class="token selector">header </span><span class="token punctuation">{</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token atrule"><span class="token rule">@bg</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Stylus</p><pre class="line-numbers language-css"><code class="language-css">bg = <span class="token hexcode">#ccc</span>header  <span class="token property">background-color</span><span class="token punctuation">:</span> bg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="import"><a href="#import" class="headerlink" title="@import"></a>@import</h3><p>Sass 只能使用 url() 表达式引入时进行变量插值</p><pre class="line-numbers language-css"><code class="language-css">  $<span class="token property">public</span><span class="token punctuation">:</span> public<span class="token punctuation">;</span>  <span class="token atrule"><span class="token rule">@import</span> <span class="token function">url</span><span class="token punctuation">(</span>styles.#</span><span class="token punctuation">{</span>$public<span class="token punctuation">}</span><span class="token number">.</span>css<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Less可以在字符串中进行插值：</p><pre class="line-numbers language-css"><code class="language-css">  <span class="token atrule"><span class="token rule">@public</span><span class="token punctuation">:</span> public<span class="token punctuation">;</span></span>  <span class="token atrule"><span class="token rule">@import</span> "styles.@</span><span class="token punctuation">{</span>public<span class="token punctuation">}</span><span class="token number">.</span>css"<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Stylus 可以利用其字符串拼接的功能实现</p><pre class="line-numbers language-css"><code class="language-css">  public = <span class="token string">"public"</span>  @import <span class="token string">"styles."</span> + public + <span class="token string">".css"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="混入-Mixins"><a href="#混入-Mixins" class="headerlink" title="混入(Mixins)"></a>混入(Mixins)</h3><p>作用: 样式层面的抽象</p><p>Sass</p><pre class="line-numbers language-css"><code class="language-css">  <span class="token atrule"><span class="token rule">@mixin</span> product-public-text</span> <span class="token punctuation">{</span>    <span class="token selector">font: </span><span class="token punctuation">{</span>      <span class="token property">size</span><span class="token punctuation">:</span> <span class="token number">20</span>px<span class="token punctuation">;</span>      <span class="token property">weight</span><span class="token punctuation">:</span> <span class="token number">600</span><span class="token punctuation">;</span>      <span class="token property">family</span><span class="token punctuation">:</span> PingFangSC<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">72</span>,<span class="token number">72</span>,<span class="token number">72</span>,<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.product-header-title</span> </span><span class="token punctuation">{</span>    <span class="token atrule"><span class="token rule">@include</span> product-public-text<span class="token punctuation">;</span></span>    <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Less</p><pre class="line-numbers language-css"><code class="language-css">  <span class="token selector"><span class="token class">.product-public-font-weight</span> </span><span class="token punctuation">{</span>    <span class="token property">font-weight</span><span class="token punctuation">:</span> <span class="token number">600</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token number">.</span><span class="token function">product-public-font</span><span class="token punctuation">(</span><span class="token atrule"><span class="token rule">@color</span><span class="token punctuation">:</span> red<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>    <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span>px<span class="token punctuation">;</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token atrule"><span class="token rule">@color</span><span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.product-header-title</span></span><span class="token punctuation">{</span>    <span class="token number">.</span>product-public-font-weight<span class="token punctuation">;</span>    <span class="token number">.</span><span class="token function">product-public-font</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>Sass</p><pre class="line-numbers language-css"><code class="language-css">  <span class="token selector"><span class="token class">.header</span> </span><span class="token punctuation">{</span>    <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.main.active</span> </span><span class="token punctuation">{</span>    <span class="token atrule"><span class="token rule">@extend</span> .header<span class="token punctuation">;</span></span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>less</p><pre class="line-numbers language-css"><code class="language-css">  <span class="token selector"><span class="token class">.header</span> </span><span class="token punctuation">{</span>    <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.main</span> </span><span class="token punctuation">{</span>    &amp;<span class="token punctuation">:</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token number">.</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Stylus,Scss</p><pre class="line-numbers language-css"><code class="language-css">  <span class="token number">.</span>header    <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  <span class="token number">.</span>main    @extend <span class="token number">.</span>header<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="高级用法（函数）"><a href="#高级用法（函数）" class="headerlink" title="高级用法（函数）"></a>高级用法（函数）</h3><p>三种预处理器都自带了诸如色彩处理（darken等）、类型判断（if each for while 等）、数值计算等内置函数</p><h3 id="三种预处理器手册"><a href="#三种预处理器手册" class="headerlink" title="三种预处理器手册"></a>三种预处理器手册</h3><ol><li>Sass：<a href="http://sass.bootcss.com/" target="_blank" rel="noopener">http://sass.bootcss.com/</a></li><li>Less： <a href="https://less.bootcss.com/" target="_blank" rel="noopener">https://less.bootcss.com/</a></li><li>stylus：<a href="https://stylus.bootcss.com/" target="_blank" rel="noopener">https://stylus.bootcss.com/</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>css分层理论</title>
      <link href="/2017/06/22/css/css-layered/"/>
      <url>/2017/06/22/css/css-layered/</url>
      
        <content type="html"><![CDATA[<p>css分层理论和命令规则将有助于它的可扩展性，性能的提高和代码的组织管理。</p><h3 id="OOSS"><a href="#OOSS" class="headerlink" title="OOSS"></a>OOSS</h3><ol><li>定义：面向对象css</li><li>设计原则：表现与结构分离，容器与内容分离</li><li>用途：创建可复用的CSS模块以提高性能</li><li>提高团队开发效率，减少耦合</li></ol><h3 id="SMACSS"><a href="#SMACSS" class="headerlink" title="SMACSS"></a>SMACSS</h3><ol><li><p>定义：可扩展的模块化架构的CSS</p></li><li><p>设计原则： 使用一套五个层次来划分CSS</p></li><li><p>用途：创建更结构化的模块以提高性能，增加效率</p><pre><code>Base - 设定HTML elements 的默认值Layout -Page structure 整个网站的「大架构」的外观   Module - Re-usable code bloks 不同页面公共模块 State - Active/Inactive etc 定义元素不同的状态 Theme - Typography and colour schemes 页面上所有「主视觉」的定义 </code></pre><pre class="line-numbers language-css"><code class="language-css"><span class="token selector"><span class="token class">.header</span> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.header-top</span> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.header-top__title</span> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.header-top__title--ico</span> </span><span class="token punctuation">{</span><span class="token punctuation">}</span>&lt;div class=<span class="token string">"header"</span>> &lt;div class=<span class="token string">"header-top"</span>>   &lt;div class=<span class="token string">"header-top__title"</span>>     &lt;div class=<span class="token string">"header-top__title--ico"</span>>&lt;/div>   &lt;/div> &lt;/div>&lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="BEM"><a href="#BEM" class="headerlink" title="BEM"></a>BEM</h3><ol><li><p>定义：block：块，Element：元素，Modifier：修饰符 </p></li><li><p>设计原则：通过给每个元素添加它的父级block模块作为前缀</p></li><li><p>用途：有助于消除页面和body类对嵌套或者附加样式依赖</p><pre class="line-numbers language-css"><code class="language-css"><span class="token selector"><span class="token class">.product-details</span> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.product-details__header</span> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.product-details__header--ico</span> </span><span class="token punctuation">{</span><span class="token punctuation">}</span>&lt;div class=<span class="token string">"product-details"</span>> &lt;div class=<span class="token string">"product-details__header"</span>>   &lt;div class=<span class="token string">"product-details__header--ico"</span>>&lt;div>  &lt;/div>&lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="SUIT"><a href="#SUIT" class="headerlink" title="SUIT"></a>SUIT</h3><ol><li>定义：SUIT起源于BEM，对组件名使用驼峰式和连字号把组件从他们的修饰和子孙后代中区分出来</li><li>用途：通过抽离组件级别的的样式表，消除潜在的混乱连字符号连接元素名来使得选择器的可读性更强。</li><li>代码示例同BEM 只不过是抽离的组件</li></ol><h3 id="ACSS"><a href="#ACSS" class="headerlink" title="ACSS"></a>ACSS</h3><p>定义： 考虑如何设计一个系统的接口。原子(Atoms)是创建一个区块的最基本的特质，比如说表单按钮。分子(Molecules)是很多个原子(Atoms)的组合，比如说一个表单中包括了一个标签，输入框和按钮。生物(Organisms)是众多分子(Molecules)的组合物，比如一个网站的顶部区域，它包括了网站的标题、导航等。而模板(Templates)又是众多生物(Organisms)的结合体。比如一个网站页面的布局。而最后的页面就是特殊的模板。</p><p><img src="/images/Acss.jpg" alt></p><h3 id="ITCSS"><a href="#ITCSS" class="headerlink" title="ITCSS"></a>ITCSS</h3><p>定义：创造了一系列的层次来管理依赖关系和促进可扩展性。基础的层次包括通用和广泛的选择器。顶部的层次包含了局部模块具体化的选择器。</p><pre><code>.Settings — 全局可用配置，设置开关。$color-ui: #BADA55; $spacing-unit:10px.Tools —通用工具函数。@mixin font-color() {font-color: $color-ui;}.Generic — 通用基础样式。Normalize, resets, box-sizing: border-box;.Base — 未归类的HTML元素。ul {list-style: square outside;}.Objects —设计部分开始使用专用类。.ui-list__item {padding: $spacing-unit;}.Components — 设计符合你们的组件。products-list {@include font-brand();border-top: 1px solid $color-ui;}.Trumps —重写，只影响一块的DOM。(通常带上我们的!important)</code></pre>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSS 动画</title>
      <link href="/2017/06/20/css/css-animation/"/>
      <url>/2017/06/20/css/css-animation/</url>
      
        <content type="html"><![CDATA[<p>API的简介及简单动画的实现</p><h3 id="3D转换（transform）"><a href="#3D转换（transform）" class="headerlink" title="3D转换（transform）"></a>3D转换（transform）</h3><ol><li><p>定义向元素应用 2D 或 3D 转换，可以对元素进行移动、缩放、转动、拉长或拉伸</p><p>translate(移动) 根据X轴和Y轴位置给定的参数，从当前元素位置移动</p><pre class="line-numbers language-js"><code class="language-js">transform<span class="token punctuation">:</span> <span class="token function">translate</span><span class="token punctuation">(</span>100px<span class="token punctuation">,</span>200px<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>rotate（旋转） 给定度数顺时针旋转的元素。负值则为逆时针旋转</p><pre class="line-numbers language-js"><code class="language-js">transform<span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>60deg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>scale (缩放) 对元素减小或者放大，取决于宽度（X轴）和高度（Y轴）的参数</p><pre class="line-numbers language-js"><code class="language-js">transform<span class="token punctuation">:</span> <span class="token function">scale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>skew (倾斜) 根据X轴和Y轴位置给定的角度参数，进行倾斜，负数则为反方向倾斜</p><pre class="line-numbers language-js"><code class="language-js">transform<span class="token punctuation">:</span> <span class="token function">skew</span><span class="token punctuation">(</span>40deg<span class="token punctuation">,</span>50deg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>transform-origin：允许改变被转换元素的位置</p><pre class="line-numbers language-js"><code class="language-js">transform<span class="token operator">-</span>origin<span class="token punctuation">:</span> x<span class="token operator">-</span>axis y<span class="token operator">-</span>axis z<span class="token operator">-</span>axis<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>transform-style：规定被嵌套元素如何在 3D 空间中显示</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// preserve-3d所有子元素在3D空间中呈现</span><span class="token comment" spellcheck="true">// flat所有子元素在2D平面呈现</span>transform<span class="token operator">-</span>style<span class="token punctuation">:</span> flat<span class="token operator">|</span>preserve<span class="token operator">-</span>3d<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>perspective:设置元素距离视图的距离，以像素计，与 perspective-origin 属性一同使用，能够改变 3D 元素的底部位置</p><pre class="line-numbers language-js"><code class="language-js">perspective<span class="token punctuation">:</span> number<span class="token operator">|</span>none<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>backface-visibility:定义当元素不面向屏幕时是否可见，在旋转元素不希望看到其背面时，该属性很有用</p><pre class="line-numbers language-js"><code class="language-js">backface<span class="token operator">-</span>visibility<span class="token punctuation">:</span> visible<span class="token operator">|</span>hidden<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h3 id="CSS3过渡（transition）"><a href="#CSS3过渡（transition）" class="headerlink" title="CSS3过渡（transition）"></a>CSS3过渡（transition）</h3><ol><li><p>某种效果可以从一种样式转变到另一种样式的效果</p><pre class="line-numbers language-js"><code class="language-js">transition<span class="token punctuation">:</span> property duration timing<span class="token operator">-</span><span class="token keyword">function</span> delay<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js">transition<span class="token operator">-</span>timing<span class="token operator">-</span><span class="token keyword">function</span><span class="token punctuation">:</span> linear<span class="token operator">|</span>ease<span class="token operator">|</span>ease<span class="token operator">-</span><span class="token keyword">in</span><span class="token operator">|</span>ease<span class="token operator">-</span>out<span class="token operator">|</span>ease<span class="token operator">-</span><span class="token keyword">in</span><span class="token operator">-</span>out<span class="token operator">|</span>cubic<span class="token operator">-</span><span class="token function">bezier</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>n<span class="token punctuation">,</span>n<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h3 id="CSS3-动画（animation及-keyframes）"><a href="#CSS3-动画（animation及-keyframes）" class="headerlink" title="CSS3 动画（animation及@keyframes）"></a>CSS3 动画（animation及@keyframes）</h3><ol><li><p>使元素从一种样式逐渐变化为另一种样式的效果</p><ul><li><p>animation</p></li><li><p>@keyframes</p></li><li><p>语法规则及拆解</p><pre class="line-numbers language-js"><code class="language-js">animation<span class="token punctuation">:</span> animation<span class="token operator">-</span>name animation<span class="token operator">-</span>duration animation<span class="token operator">-</span>timing<span class="token operator">-</span><span class="token keyword">function</span> animation<span class="token operator">-</span>fill<span class="token operator">-</span>mode animation<span class="token operator">-</span>delay animation<span class="token operator">-</span>iteration<span class="token operator">-</span>count    animation<span class="token operator">-</span>direction animation<span class="token operator">-</span>play<span class="token operator">-</span>state<span class="token punctuation">;</span>animation<span class="token operator">-</span><span class="token function">name</span><span class="token punctuation">(</span>keyframe名字<span class="token punctuation">)</span><span class="token punctuation">:</span> keyframename<span class="token operator">|</span>none<span class="token punctuation">;</span>animation<span class="token operator">-</span><span class="token function">duration</span><span class="token punctuation">(</span>动画完成一个周期需要多少秒或毫秒<span class="token punctuation">)</span><span class="token punctuation">:</span>animation<span class="token operator">-</span>duration<span class="token punctuation">:</span> time <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>animation<span class="token operator">-</span>timing<span class="token operator">-</span><span class="token keyword">function</span><span class="token punctuation">(</span>动画的速度曲线<span class="token punctuation">,</span>使用的数学函数，称为三次贝塞尔曲线，速度曲线<span class="token punctuation">)</span><span class="token punctuation">:</span> linear    <span class="token operator">|</span> ease    <span class="token operator">|</span> ease<span class="token operator">-</span><span class="token keyword">in</span> <span class="token operator">|</span> ease<span class="token operator">-</span>out    <span class="token operator">|</span> ease<span class="token operator">-</span><span class="token keyword">in</span><span class="token operator">-</span>out     <span class="token operator">|</span> cubic<span class="token operator">-</span><span class="token function">bezier</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>n<span class="token punctuation">,</span>n<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>animation<span class="token operator">-</span>fill<span class="token operator">-</span><span class="token function">mode</span><span class="token punctuation">(</span>当动画完成时或又一个延迟未开始播放时的样式<span class="token punctuation">)</span><span class="token punctuation">:</span> none<span class="token operator">|</span>forwards<span class="token operator">|</span>backwards<span class="token operator">|</span>both<span class="token operator">|</span>initial<span class="token operator">|</span>inherit<span class="token punctuation">;</span>animation<span class="token operator">-</span><span class="token function">delay</span><span class="token punctuation">(</span>动画什么时候开始<span class="token punctuation">)</span><span class="token punctuation">:</span> time<span class="token punctuation">;</span>animation<span class="token operator">-</span>iteration<span class="token operator">-</span><span class="token function">count</span><span class="token punctuation">(</span>动画被播放的次数<span class="token punctuation">)</span><span class="token punctuation">:</span>n <span class="token operator">|</span>infiniteanimation<span class="token operator">-</span><span class="token function">direction</span><span class="token punctuation">(</span>是否循环交替反向播放动画<span class="token punctuation">)</span><span class="token punctuation">:</span> normal<span class="token operator">|</span>reverse<span class="token operator">|</span>alternate<span class="token operator">|</span>alternate<span class="token operator">-</span>reverse<span class="token operator">|</span>initial<span class="token operator">|</span>inherit<span class="token punctuation">;</span>animation<span class="token operator">-</span>play<span class="token operator">-</span><span class="token function">state</span><span class="token punctuation">(</span>动画是否正在运行或暂停<span class="token punctuation">)</span><span class="token punctuation">:</span>paused<span class="token operator">|</span>running<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ol><h3 id="css动画库以及动画工具"><a href="#css动画库以及动画工具" class="headerlink" title="css动画库以及动画工具"></a>css动画库以及动画工具</h3><ul><li>matrix3d(<a href="http://ds-overdesign.com/transform/matrix3d.html" target="_blank" rel="noopener">http://ds-overdesign.com/transform/matrix3d.html</a>)</li><li>matrix(<a href="http://meyerweb.com/eric/tools/matrix" target="_blank" rel="noopener">http://meyerweb.com/eric/tools/matrix</a>)</li><li>tools(<a href="http://www.f2e.name/case/css3/tools.html" target="_blank" rel="noopener">http://www.f2e.name/case/css3/tools.html</a>)</li></ul>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSS 基本布局</title>
      <link href="/2017/06/15/css/base-layout/"/>
      <url>/2017/06/15/css/base-layout/</url>
      
        <content type="html"><![CDATA[<h3 id="自适应两栏布局"><a href="#自适应两栏布局" class="headerlink" title="自适应两栏布局"></a>自适应两栏布局</h3><p>利用BFC实现自适应两栏布局</p><pre class="line-numbers language-css"><code class="language-css"><span class="token comment" spellcheck="true">/****css****/</span><span class="token selector"><span class="token class">.aside</span></span><span class="token punctuation">{</span>  <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">180</span>px<span class="token punctuation">;</span>  <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  <span class="token property">opacity</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.main</span></span><span class="token punctuation">{</span>  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>  <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span><span class="token punctuation">}</span>&lt;!--html-->&lt;div class=<span class="token string">"box"</span>>  &lt;div class=<span class="token string">"aside"</span>>左侧&lt;/div>  &lt;div class=<span class="token string">"main"</span>>右侧&lt;/div>&lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/%E8%87%AA%E9%80%82%E5%BA%94%E4%B8%A4%E6%A0%8F%E5%B8%83%E5%B1%80.gif" alt></p><h3 id="圣杯布局和双飞翼布局"><a href="#圣杯布局和双飞翼布局" class="headerlink" title="圣杯布局和双飞翼布局"></a>圣杯布局和双飞翼布局</h3><ol><li>解决什么问题：两边定宽，中间自适应的三栏布局，中间栏放在文档流前面以优先渲染</li><li>相同点：三栏全float浮动，左右两栏加上负margin让中间栏div并排，形成三栏</li><li>不同点： <ul><li>圣杯布局为了中间内容不被遮挡，将中间div设置左右padding-left和padding-right,将左右两个div用相对布局position: relative并分别配合right和left属性，以便左右两栏div移动后不遮挡中间div。</li><li>双飞翼布局，直接在中间div内部创建子div用于放置内容，在该子div里用margin-left和margin-right为左右两栏div留出位置。</li></ul></li><li>圣杯布局代码</li></ol><pre class="line-numbers language-css"><code class="language-css"><span class="token comment" spellcheck="true">/****css****/</span><span class="token selector"><span class="token class">.main</span></span><span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100%</span><span class="token punctuation">;</span>  <span class="token property">background</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.left</span></span><span class="token punctuation">{</span>  <span class="token property">left</span><span class="token punctuation">:</span> -<span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">margin-left</span><span class="token punctuation">:</span> -<span class="token number">100%</span><span class="token punctuation">;</span>  <span class="token property">background</span><span class="token punctuation">:</span> yellowgreen<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.right</span></span><span class="token punctuation">{</span>  <span class="token property">right</span><span class="token punctuation">:</span> -<span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">margin-left</span><span class="token punctuation">:</span> -<span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.main</span>,<span class="token class">.left</span>,<span class="token class">.right</span></span><span class="token punctuation">{</span>  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>  <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>  <span class="token property">min-height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.container</span></span><span class="token punctuation">{</span>  <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>  <span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">5</span>px solid <span class="token hexcode">#ccc</span><span class="token punctuation">;</span><span class="token punctuation">}</span>&lt;!--html-->&lt;div class=<span class="token string">"container"</span>>  &lt;div class=<span class="token string">"main"</span>>中间栏目&lt;/div>  &lt;div class=<span class="token string">"left"</span>>左侧栏目&lt;/div>  &lt;div class=<span class="token string">"right"</span>>右侧栏目&lt;/div>&lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>双飞翼布局代码</li></ol><pre class="line-numbers language-css"><code class="language-css"><span class="token comment" spellcheck="true">/****css****/</span><span class="token selector"><span class="token class">.main</span>,<span class="token class">.left</span>,<span class="token class">.right</span></span><span class="token punctuation">{</span>  <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>  <span class="token property">min-height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.main</span></span><span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span><span class="token number">100%</span><span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.left</span></span><span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">margin-left</span><span class="token punctuation">:</span> -<span class="token number">100%</span><span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> yellow<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.right</span></span><span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span>  <span class="token property">margin-left</span><span class="token punctuation">:</span> -<span class="token number">200</span>px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.content</span></span><span class="token punctuation">{</span>  <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token number">200</span>px<span class="token punctuation">;</span><span class="token punctuation">}</span>&lt;!--html-->&lt;div class=<span class="token string">"container"</span>> 　　&lt;div class=<span class="token string">"main"</span>>    　　&lt;div class=<span class="token string">"content"</span>>中间栏目&lt;/div>     &lt;/div>　　&lt;div class=<span class="token string">"left"</span>>左侧栏目&lt;/div> 　　&lt;div class=<span class="token string">"right"</span>>右侧栏目&lt;/div> &lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>效果图<br><img src="/images/%E5%9C%A3%E6%9D%AF%E5%B8%83%E5%B1%80.gif" alt></li></ol><h3 id="flex弹性盒子布局"><a href="#flex弹性盒子布局" class="headerlink" title="flex弹性盒子布局"></a>flex弹性盒子布局</h3><ol><li><p>定义：Flex 是 Flexible Box 的缩写，意为”弹性布局”，用来为盒状模型提供最大的灵活性。</p></li><li><p>优点：相对于传统布局更具有灵活性。</p></li><li><p>缺点：虽然现代浏览器都支持，但是还有少部分浏览器需要单独处理其兼容性</p></li><li><p>问题：</p><ul><li>绝对定位与固定定位的盒子不参与flex布局</li><li>使用Flex布局以后，子元素的float、clear和vertical-align等属性将失效</li><li>具体语法参考阮大大flex布局语法篇和实例篇</li><li><a href="http://www.ruanyifeng.com/blog/2015/07/flex-grammar.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2015/07/flex-grammar.html</a></li><li><a href="http://www.ruanyifeng.com/blog/2015/07/flex-examples.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2015/07/flex-examples.html</a></li></ul></li><li><p>三栏布局示例 </p></li></ol><pre class="line-numbers language-css"><code class="language-css"><span class="token comment" spellcheck="true">/****css****/</span><span class="token selector"><span class="token class">.container</span></span><span class="token punctuation">{</span>  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>  <span class="token property">min-height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.main</span></span><span class="token punctuation">{</span>  <span class="token property">flex-grow</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.left</span></span><span class="token punctuation">{</span>  <span class="token property">order</span><span class="token punctuation">:</span> -<span class="token number">1</span><span class="token punctuation">;</span>  <span class="token property">flex-basis</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> yellow<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.right</span></span><span class="token punctuation">{</span>  <span class="token property">flex-basis</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span><span class="token punctuation">}</span>&lt;!--html-->&lt;div class=<span class="token string">"container"</span>>  &lt;div class=<span class="token string">"main"</span>>中间内容区域&lt;/div>  &lt;div class=<span class="token string">"left"</span>>左边栏区域&lt;/div>  &lt;div class=<span class="token string">"right"</span>>右边栏区域&lt;/div>&lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="绝对定位布局"><a href="#绝对定位布局" class="headerlink" title="绝对定位布局"></a>绝对定位布局</h3><ol><li>position:absolute绝对定位使元素脱离文档流，因此不占据当前层级的空间</li><li>三栏布局代码示例<pre class="line-numbers language-css"><code class="language-css"><span class="token comment" spellcheck="true">/****css****/</span><span class="token selector"><span class="token class">.container</span></span><span class="token punctuation">{</span><span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.main</span>,<span class="token class">.left</span>,<span class="token class">.right</span></span><span class="token punctuation">{</span><span class="token property">min-height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span><span class="token property">top</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.main</span></span><span class="token punctuation">{</span><span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token number">200</span>px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.left</span></span><span class="token punctuation">{</span><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">left</span><span class="token punctuation">:</span> <span class="token number">0</span>px<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span><span class="token property">background-color</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.right</span></span><span class="token punctuation">{</span><span class="token property">position</span><span class="token punctuation">:</span>absolute<span class="token punctuation">;</span><span class="token property">right</span><span class="token punctuation">:</span> <span class="token number">0</span>px<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span> yellow<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><!--html--><div class="container">  <div class="main">中间内容区域</div>  <div class="left">左边区域</div>  <div class="right">右边区域</div></div>```### media响应式布局<ol><li>定义（Responsive Web Design）：一个网站能够兼容多个终端，而不是为每个终端做一个特定的版本</li><li>优点<ul><li>跨平台，面对不同分辨率设备灵活性强</li><li>能够快捷解决多设备显示适应问题</li><li>节约成本</li></ul></li><li>缺点<ul><li>兼容性 不兼容低版本浏览器，各种设备工作量大，效率低下</li><li>代码冗余量大，加载时间长</li><li>折中方案，达不到理想的布局效果 </li></ul></li></ol><h3 id="移动端rem布局"><a href="#移动端rem布局" class="headerlink" title="移动端rem布局"></a>移动端rem布局</h3><ol><li>定义（font size of the root element）：相对于根元素的字体大小的单位</li><li>作用：通过js动态计算html font-size 能够使html页面比响应式布局，流式布局，设置最大宽度布局等效果更完善</li><li>需要考虑当前手机的dpr</li></ol>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSS 基础知识概念</title>
      <link href="/2017/06/11/css/base-concepts/"/>
      <url>/2017/06/11/css/base-concepts/</url>
      
        <content type="html"><![CDATA[<h3 id="什么是css"><a href="#什么是css" class="headerlink" title="什么是css"></a>什么是css</h3><p>层叠样式表(英文全称：Cascading Style Sheets),是一种用来表现html或者xml等文件样式的计算机语言。</p><h3 id="盒子模型"><a href="#盒子模型" class="headerlink" title="盒子模型"></a>盒子模型</h3><ul><li>在html文档中，每一个渲染在页面中的标签都是一个个盒子模型；</li><li>盒子模型分为w3c标准盒子模型和IE标准盒子模型；当不对Doctype进行定义时，会触发怪异模式。</li><li>盒子模型</li></ul><pre class="line-numbers language-css"><code class="language-css"><span class="token comment" spellcheck="true">/****css****/</span><span class="token selector"><span class="token class">.box</span></span><span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span><span class="token number">100</span>px<span class="token punctuation">;</span>  <span class="token property">height</span><span class="token punctuation">:</span><span class="token number">100</span>px<span class="token punctuation">;</span>  <span class="token property">border</span><span class="token punctuation">:</span><span class="token number">10</span>px<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span>red<span class="token punctuation">;</span>  <span class="token property">padding</span><span class="token punctuation">:</span><span class="token number">20</span>px<span class="token punctuation">;</span>  <span class="token property">margin</span><span class="token punctuation">:</span><span class="token number">20</span>px<span class="token punctuation">;</span><span class="token punctuation">}</span>&lt;div class=<span class="token string">"box"</span>>&lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/css%E7%9B%92%E5%AD%90%E6%A8%A1%E5%9E%8B.png" alt></p><h3 id="BFC"><a href="#BFC" class="headerlink" title="BFC"></a>BFC</h3><ul><li><p>定义（Block fomatting context）：块级格式化上下文(每一个元素盒子从上向下排列)</p></li><li><p>block-level box:display 属性为 block, list-item, table 的元素，会生成 block-level box。并且参与 block fomatting context；</p></li><li><p>是一个独立的渲染区域，只有Block-level box参与</p></li><li><p>布局规则</p><ol><li>内部的Box会在垂直方向链接放置</li><li>Box垂直方向的距离由margin决定。属于同一个BFC的两个相邻Box的margin会发生重叠</li><li>每个元素的margin box的左边， 与包含块border box的左边相接触(对于从左往右的格式化，否则相反)。即使存在浮动也是如此。</li><li>BFC的区域不会与float box重叠</li><li>BFC就是页面上的一个隔离的独立容器，容器里面的子元素不会影响到外面的元素。反之也如此。</li><li>计算BFC的高度时，浮动元素也参与计算</li></ol></li><li><p>那些元素会生成BFC</p><ol><li>根元素</li><li>float元素不为none</li><li>position为 absolute或者fixed</li><li>display为inline-block, table-cell, table-caption, flex, inline-flex</li><li>overflow不为visible</li></ol></li><li><p>BFC作用</p><ol><li>自适应两栏布局</li><li>清除内部浮动</li><li>防止margin重叠</li></ol></li><li><p>例子说明</p></li><li><p>根据以上BFC布局规则第3条、第4条来触发main生成BFC，来实现自适应两栏布局</p><pre class="line-numbers language-css"><code class="language-css">  <span class="token comment" spellcheck="true">/****css****/</span>  <span class="token selector"><span class="token class">.main</span></span><span class="token punctuation">{</span>    <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span>    <span class="token property">background</span><span class="token punctuation">:</span> yellow<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.aside</span></span><span class="token punctuation">{</span>    <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span>    <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  &lt;!--html-->  &lt;div class=<span class="token string">"box"</span>>    &lt;div class=<span class="token string">"aside"</span>>侧边栏区域&lt;/div>    &lt;div class=<span class="token string">"main"</span>>内容区域&lt;/div>  &lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>根据BFC布局规则第6条，解决float元素使其父元素高度塌陷问题</p><pre class="line-numbers language-css"><code class="language-css">  <span class="token comment" spellcheck="true">/****css****/</span>  <span class="token selector"><span class="token class">.parent</span></span><span class="token punctuation">{</span>    <span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">1</span>px solid red<span class="token punctuation">;</span>    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">400</span>px<span class="token punctuation">;</span>    <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>    <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.child</span></span><span class="token punctuation">{</span>    <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">300</span>px<span class="token punctuation">;</span>    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">198</span>px<span class="token punctuation">;</span>    <span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">1</span>px solid green<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  &lt;!--html-->  &lt;div class=<span class="token string">"parent"</span>>    &lt;div class=<span class="token string">"child"</span>>&lt;/div>    &lt;div class=<span class="token string">"child"</span>>&lt;/div>  &lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>防止margin重叠,根据生成BFC第4条规则</p><pre class="line-numbers language-css"><code class="language-css">  <span class="token comment" spellcheck="true">/****css****/</span>  <span class="token selector"><span class="token class">.box</span></span><span class="token punctuation">{</span>    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">300</span>px<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.content</span></span><span class="token punctuation">{</span>    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">300</span>px<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>    <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>    <span class="token property">background</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.warp</span></span><span class="token punctuation">{</span>    <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  &lt;!--html-->  &lt;div class=<span class="token string">"box"</span>>    &lt;div class=<span class="token string">"content"</span>>&lt;/div>    &lt;div class=<span class="token string">"content warp"</span>>&lt;/div>  &lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="IFC"><a href="#IFC" class="headerlink" title="IFC"></a>IFC</h3><ol><li><p>布局规则</p><ul><li>定义(Inline Formatting Contexts)：内联格式化上下文（每一个元素盒子从左到右排列）</li><li>IFC的line box高度 由其行内元素中 最高的实际高度计算而来（不受到竖直方向的padding/margin影响)</li><li>inline-level box:display 属性为 inline, inline-box，inline-table，table-cell，table-column-group等，会生成 inline-level box。并且参与 inline fomatting context；</li><li>当inline-level box的宽度大于containing block，且达到内容换行条件时，会将inline-level拆散为多个inline-level box并分布到多行中</li><li>inline-level box一般左右都贴紧整个IFC，但是会因为float元素而扰乱。float元素会位于IFC与与line box之间，使得line box宽度缩短</li><li>IFC中不可能有块级元素，当插入块级元素时（如p中插入div）会产生两个匿名块与div分隔开，即产生两个IFC，每个IFC对外表现为块级元素，与div垂直排列。</li></ul></li><li><p>作用</p><ul><li>水平居中：当一个块要在环境中水平居中时，设置其为inline-block则会在外层产生IFC，通过text-align则可以使其水平居中。</li><li>垂直居中：创建一个IFC，用其中一个元素撑开父元素的高度，然后设置其vertical-align:middle，其他行内元素则可以在此父元素下垂直居中。</li></ul></li><li><p>示例</p><ul><li><p>根据布局规则第4条</p><pre class="line-numbers language-css"><code class="language-css"><span class="token comment" spellcheck="true">/****css****/</span><span class="token selector"><span class="token class">.break</span></span><span class="token punctuation">{</span> <span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">1</span>px solid red<span class="token punctuation">;</span> <span class="token property">background</span><span class="token punctuation">:</span> yellow<span class="token punctuation">;</span><span class="token punctuation">}</span>&lt;!--html-->&lt;span class=<span class="token string">"break"</span>>这是一个行内盒子这是一个行内盒子这是一个行内盒子&lt;/span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/css-IFC.jpg" alt></p></li></ul></li><li><p>根据作用第1条,设置span为inline-block,则会在box上产生ifc,在box上设置text-align使span元素水平居中。</p><pre class="line-numbers language-css"><code class="language-css"> <span class="token comment" spellcheck="true">/****css****/</span> <span class="token selector"><span class="token class">.box</span></span><span class="token punctuation">{</span><span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token selector"><span class="token class">.content</span></span><span class="token punctuation">{</span>   <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>   <span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">1</span>px solid red<span class="token punctuation">;</span> <span class="token punctuation">}</span> &lt;!--html--> &lt;div class=<span class="token string">"box"</span>>   &lt;span class=<span class="token string">"content"</span>>内容区域&lt;/span> &lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>根据作用第2条，设置盒子2为inline-block，则会在box上产生ifc，设置其vertical-align:middle，盒子1垂直居中。</p><pre class="line-numbers language-css"><code class="language-css"> <span class="token comment" spellcheck="true">/****css****/</span> <span class="token selector"><span class="token class">.box</span></span><span class="token punctuation">{</span>   <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>   <span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">1</span>px solid red<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token selector"><span class="token class">.label</span></span><span class="token punctuation">{</span>   <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>   <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>   <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>   <span class="token property">vertical-align</span><span class="token punctuation">:</span> middle<span class="token punctuation">;</span> <span class="token punctuation">}</span> &lt;!--html--> &lt;div class=<span class="token string">"box"</span>>   &lt;span class=<span class="token string">"content"</span>>盒子<span class="token number">1</span>&lt;/span>   &lt;span class=<span class="token string">"label"</span>>盒子<span class="token number">2</span>&lt;/span> &lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="FFC"><a href="#FFC" class="headerlink" title="FFC"></a>FFC</h3><ol><li>定义(Flex Formatting Contexts)：自适应格式化上下文</li><li>display值为flex或者inline-flex的元素将会生成自适应容器（flex container）</li><li>FFC和BFC区别<ul><li>Flexbox 不支持 ::first-line 和 ::first-letter 这两种伪元素</li><li>vertical-align 对 Flexbox 中的子元素失效</li><li>float 和 clear 属性对 Flexbox 中的子元素是没有效果的，也不会使子元素脱离文档流</li><li>多栏布局（column-*） 在 Flexbox 中失效</li><li>Flexbox 下的子元素不会继承父级容器的宽</li></ul></li></ol><h3 id="GFC"><a href="#GFC" class="headerlink" title="GFC"></a>GFC</h3><ol><li>定义(GridLayout Formatting Contexts)：网格布局格式化上下文</li><li>display值为grid的元素，获得一个独立的渲染区域，可在网格内定义项目（item）、行（row）、列（columns）</li></ol>]]></content>
      
      
      <categories>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTML 系列总结</title>
      <link href="/2017/05/10/html/html/"/>
      <url>/2017/05/10/html/html/</url>
      
        <content type="html"><![CDATA[<div align="middle"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=407679465&auto=1&height=66"></iframe></div><h3 id="什么是html"><a href="#什么是html" class="headerlink" title="什么是html"></a>什么是html</h3><p>超文本标记语言（HyperText Markup Language），是“网页浏览器中看到展示信息的”设计的一种标记语言。</p><h3 id="Doctype含义"><a href="#Doctype含义" class="headerlink" title="Doctype含义"></a>Doctype含义</h3><ul><li><!DOCTYPE>声明位于位于HTML文档中的第一行，告诉浏览器的解释器用什么文档标准来解析这个文档。</li><li>DOCTYPE书写错误或者不存在会导致文档已兼容模式呈现</li></ul><h3 id="标准模式和混杂模式"><a href="#标准模式和混杂模式" class="headerlink" title="标准模式和混杂模式"></a>标准模式和混杂模式</h3><ul><li>标准模式： html 排版和 js 渲染工作模式都是以该浏览器支持的最高标准运行。</li><li>兼容模式：页面已宽松的向后兼容的方式显示，模拟老浏览器的行为。</li></ul><h3 id="HTML5-为什么只需要写-lt-DOCTYPE-HTML-gt"><a href="#HTML5-为什么只需要写-lt-DOCTYPE-HTML-gt" class="headerlink" title="HTML5 为什么只需要写 &lt;!DOCTYPE HTML&gt;"></a>HTML5 为什么只需要写 <code>&lt;!DOCTYPE HTML&gt;</code></h3><p>html5不是基于SGML，所以不需要对DTD进行引用，但是它需要对文档类型声明，需要doctype来规范浏览器行为。</p><h3 id="行内元素-块级元素-空元素"><a href="#行内元素-块级元素-空元素" class="headerlink" title="行内元素-块级元素-空元素"></a>行内元素-块级元素-空元素</h3><ul><li>css中规定每个元素都有默认的display属性和值</li><li>该元素的属性的值为‘inline’的则为行内元素（如:<code>span,a img,input</code>等）</li><li>该元素的属性的值为‘block’的则为块级元素（<code>div，ul,li h1...p</code>等）</li><li>空（void）元素 <code>&lt;br&gt; &lt;hr&gt; &lt;img&gt; &lt;input&gt; &lt;link&gt; &lt;meta&gt;</code> 等</li></ul><h3 id="html语义化"><a href="#html语义化" class="headerlink" title="html语义化"></a>html语义化</h3><ol><li>定义：正确的标签做正确的事情</li><li>为什么要做语义化<ul><li>有利于SEO，有利于搜索引擎爬虫更好的理解我们的网页，从而获取更多的有效信息，提升网页的权重。</li><li>在没有CSS的时候能够清晰的看出网页的结构，增强可读性，便于团队开发和维护。</li><li>支持多终端设备的浏览器渲染。</li></ul></li><li>SEO<ul><li>汉译为搜索引擎优化。是一种方式：利用搜索引擎的规则提高网站在有关搜索引擎内的自然排名。</li><li>目的：<br>为网站提供生态式的自我营销解决方案，让其在行业内占据领先地位，获得品牌收益；SEO包含站外SEO和站内SEO两方面；为了从搜索引擎中获得更多的免费流量，从网站结构、内容建设方案、用户互动传播、页面等角度进行合理规划，还会使搜索引擎中显示的网站相关信息对用户来说更具有吸引力。</li><li>优化方式： <ul><li>内部优化：<ol><li>META标签优化：例如：TITLE，KEYWORDS，DESCRIPTION等的优化。</li><li>内部链接的优化，包括相关性链接（Tag标签），锚文本链接，各导航链接，及图片链接。</li><li>网站内容更新：每天保持站内的更新(主要是文章的更新等)。</li></ol></li><li>外部优化：<ol><li>外部链接类别：友情链接、博客、论坛、B2B、新闻、分类信息、贴吧、知道、百科、站群、相关信息网等尽量保持链接的多样性。</li><li>外链运营：每天添加一定数量的外部链接，使关键词排名稳定提升。</li><li>外链选择：与一些和你网站相关性比较高，整体质量比较好的网站交换友情链接，巩固稳定关键词排名。</li></ol></li></ul></li></ul></li></ol><h3 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h3><ol><li>概念：如果两个页面的协议，端口（如果有指定）和域名都相同，则两个页面具有相同的源。</li><li>目的：保证用户信息安全，防止恶意网站窃取数据，防止cookie共享</li><li>限制范围<ul><li>cookie、localStorage、indexedDB无法读取</li><li>dom 无法获取</li><li>ajax不能发送</li><li>form表单没有限制</li></ul></li><li>如何设置同源策略(host)：document.domain</li><li>不受同源策略限制：<ul><li>页面中的链接，重定向以及表单提交是不会受到同源策略限制的。</li><li>跨域资源的引入是可以的。但是js不能读写加载的内容。如嵌入到页面中的<code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;，&lt;img&gt;，&lt;link&gt;，&lt;iframe&gt;</code>等。</li></ul></li></ol><h3 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h3><p>  受到浏览器同源策略的影响，要操作其他源下面的脚本，就需要跨域。</p><h3 id="Ajax跨域的解决方案"><a href="#Ajax跨域的解决方案" class="headerlink" title="Ajax跨域的解决方案"></a>Ajax跨域的解决方案</h3><p><strong>1.JSONP：</strong></p><p>  网页添加一个<code>&lt;script&gt;</code>元素，向服务器请求jsON数据。服务器收到请求后，将数据放在一个指定名字的回调函数里传回来。</p><pre><code>- 缺点只支持get请求- 优点简单方便，易理解，兼容性良好- 如下示例代码```js  //动态创建script，用于跨越操作  function creatScriptTag(src) {    var script = document.createElement(&#39;script&#39;);    script.setAttribute(&quot;type&quot;,&quot;text/javascript&quot;);    script.src = src;    document.body.appendChild(script);  }  // 调用creatScriptTag函数  window.onload = function () {    var url = &#39;/index.php?jsoncallback=result&#39;;    creatScriptTag(url);  }  // 定义回调函数  function result (data) {    console.log(data);  } ``````php  // index.php   &lt;?php  header(&#39;Content-type: application/json&#39;);  //获取回调函数名  $jsoncallback = htmlspecialchars($_REQUEST [&#39;jsoncallback&#39;]);  //取数据  $data = [    &#39;data&#39;=&gt;&#39;123&#39;,  ];  $json_data = json_encode(array(&#39;code&#39;=&gt;&#39;200&#39;,&#39;msg&#39;=&gt;&#39;请求成功&#39;,&#39;data&#39; =&gt; $data),jsON_UNESCAPED_UNICODE);  //输出jsonp格式的数据  echo $jsoncallback .&quot;(&quot; . $json_data . &quot;)&quot;;  ?&gt;```</code></pre><p><strong>2.WebSocket:</strong></p><p>  是一种通信协议，使用ws://（非加密）和wss://（加密）作为协议前缀。该协议不实行同源政策，只要服务器设置利用origin字段设置白名单，就可以通过它进行跨源通信。</p><p><strong>3.CORS（Cross-Origin Resource Sharing）</strong></p><ul><li>在请求头信息中增加Origin字段，用来说明此次请求来自那个源（协议+域名+端口），此字段可以设置相应白名单</li><li>必须设置<code>Access-Control-Allow-Origin</code>字段，值要求是<code>Origin</code>字段的值或者是<em>，</em>的意思是接受任意域名的请求</li><li>CORS请求默认不发送cookie和http认证信息，如果要发送，要在服务器端指<code>Access-Control-Allow-Credentials: true</code>,并且ajax请求必须打开withCredentials属性<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li>如果选择发送cookie,<code>Access-Control-Allow-Origin</code>字段不能设为*，必须指定明确的，与当前网页一致的域名</li></ul>]]></content>
      
      
      <categories>
          
          <category> HTML </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>语法、变量、数据类型</title>
      <link href="/2017/01/23/php/base/"/>
      <url>/2017/01/23/php/base/</url>
      
        <content type="html"><![CDATA[<h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><ol><li>PHP 脚本以 <code>&lt;?php 开始，以 ?&gt; 结束</code><br></li><li>PHP 文件的默认文件扩展名是 “.php”<br></li><li>PHP 文件通常包含 HTML 标签和一些 PHP 脚本代码<br></li><li>PHP 中的每个代码行都必须以分号结束，否则输出错误<br><pre><code>&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;body&gt; </code></pre></li></ol><?php   echo "Hello World!"; ?><p> </p> ```<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p><strong>PHP 变量规则：</strong><br></p><ol><li>变量以 $ 符号开始，后面跟着变量的名称,$a<br></li><li>变量名必须以字母或者下划线字符开始<br></li><li>变量名只能包含字母数字字符以及下划线（A-z、0-9 和 _ ）<br></li><li>变量名不能包含空格<br></li><li>变量名是区分大小写的（$y 和 $Y 是两个不同的变量）<br></li><li>由于PHP是弱类型语言所以变量不必声明类型和JS类似 <br></li></ol><p><strong>PHP 变量作用域</strong><br></p><p><strong>四种不同的变量作用域</strong><br></p><pre><code>local 局部global 全局static 局部-静态变量parameter 参数</code></pre><p><strong>局部和全局作用域 local global</strong><br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>   <span class="token variable">$age</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//全局作用域</span>  <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">people</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$isJob</span>  <span class="token operator">=</span> <span class="token string">'yes'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//局部变量</span>    <span class="token keyword">global</span> <span class="token variable">$name</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//访问全局作用域</span>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// zhangsan </span>  <span class="token punctuation">}</span>  <span class="token function">people</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解析：<br></p><ol><li>$age 是在函数外部定义的变量，拥有全局作用域，但是这里和 JS 的区别是 $age 在people函数中是不可访问的<br></li><li>$isJob 是在函数内部声明的变量所以是局部变量，只能在函数内部访问<br></li><li>$name global 是在函数内部<strong>调用</strong>函数外部定义的全局变量,正常情况在函数内部访问函数外部的变量则为NULL<br></li></ol><p><strong>Static 作用域</strong><br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// static $a = 1 + 2; // 解析错误 参照解析2</span>    <span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span>    <span class="token variable">$a</span><span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">test</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//0</span>  <span class="token function">test</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1</span>  <span class="token function">test</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//2</span><span class="token delimiter">?></span>```解析：<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span><span class="token number">1</span><span class="token punctuation">.</span> 静态全局变量的作用域局限于一个源文件内，只能为该源文件内的函数公用<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span><span class="token number">2</span><span class="token punctuation">.</span> 不能对静态变量用表达式的结果赋值，否则会导致解析错误<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span><span class="token number">3</span><span class="token punctuation">.</span> <span class="token keyword">static</span>全局变量只初使化一次，下一次依据上一次结果值，上例子中调用三次执行的结果是累加的。<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span><span class="token number">4</span><span class="token punctuation">.</span> 在内存的静态存储区中（静态存储区在整个程序运行期间都存在，其他局部变量存储在栈中。<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span><span class="token operator">*</span><span class="token operator">*</span>parameter 参数作用域<span class="token operator">*</span><span class="token operator">*</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span>````php  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">test</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1</span>```<span class="token operator">*</span><span class="token operator">*</span>小结<span class="token operator">*</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">.</span> 定义在函数外部的就是全局变量，它的作用域从定义处一直到文件结尾。<span class="token number">2</span><span class="token punctuation">.</span> 函数内定义的变量就是局部变量，它的作用域为函数定义范围内。<span class="token number">3</span><span class="token punctuation">.</span> 函数内访问全局变量需要 <span class="token keyword">global</span> 关键字<span class="token punctuation">,</span>如果不使用，则会覆盖全局变量<span class="token shell-comment comment">## 数据类型</span><span class="token operator">*</span><span class="token operator">*</span>php数据类型<span class="token operator">*</span><span class="token operator">*</span>String（字符串）<span class="token punctuation">,</span> Integer（整型）<span class="token punctuation">,</span> Float（浮点型）<span class="token punctuation">,</span> Boolean（布尔型）<span class="token punctuation">,</span> <span class="token keyword">Array</span>（数组）<span class="token punctuation">,</span> Object（对象）<span class="token punctuation">,</span> <span class="token keyword">NULL</span>（空值）。<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span>这里由于和 <span class="token constant">JS</span> 类似所以不多做解释<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP 常用方法</title>
      <link href="/2017/01/23/php/method/"/>
      <url>/2017/01/23/php/method/</url>
      
        <content type="html"><![CDATA[<p>此篇文章JS数组方法总结一样纯属是为了熟悉API，不得不承认PHP大法好比JS的原生方法多的很。这里只列出个人认为比较常用的。<br></p><p><strong>数组内置函数</strong><br></p><ol><li><p>for、foreach循环输出数组元素<br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> <span class="token comment" spellcheck="true">// for循环</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">echo</span> <span class="token string">"$i &lt;br/>"</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// foreach 只适用于数组</span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 创建数组</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$name</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">echo</span> <span class="token string">"$value &lt;br/>"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?></span>```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>count() 获取数组元素的个数 <br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$nameLength</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$nameLength</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span><span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出数组当前的元素的值，如果当前元素为空或者无值则返回FALSE <br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回第一个元素zhangsan </span><span class="token keyword">echo</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回最后一个元素wangwu</span><span class="token keyword">echo</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回指定元素的下一个元素</span><span class="token keyword">echo</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回指定元素的上一个元素</span><span class="token keyword">echo</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 把内部指针移动到数组的首个元素zhangsan</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>?&gt;</p><pre><code>4. 对当前数组进行排序&lt;br/&gt;```php  $numbers = array(1, 2, 3, 3, 4, 5, 6, 2);  // 返回bool  sort($numbers);  //对数组进行升序成功则为true 失败则为false  rsort($numbers); //对数组进行降序成功则为true 失败则为false  array_reverse($array, $preserve); //对原数组按反序排序，返回排序后的数组(2, 6, 5, 4, 3, 3, 2, 1)</code></pre><ol start="5"><li>合并数组<br><pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$arr1</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><p>array_merge($arr, $arr1 );</p><pre><code>6. 压栈，出栈&lt;br/&gt;```php$name = &#39;wang&#39;;$name1  = array(&#39;zhang&#39;, &#39;li&#39;);array_push($name1, $name); // 3 返回新数组的长度array_pop($name1); //li 返回被pop的值。栈为空，返回nullarray_shift($name1); //删除第一个元素并返回；array_unshift(array，val1，val2,...); //将参数按照顺序加入队列中</code></pre><ol start="7"><li>统计数组中值为出现的次数<br></li></ol><pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$val</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">array_count_values</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="8"><li>过滤数组的元素<br><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">func</span> <span class="token punctuation">(</span><span class="token variable">$var</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">(</span><span class="token variable">$var</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ol><p>$val = array(‘a’, ‘b’, 2, 3, 4);<br>print_r(array_filter($val, ‘func’)); // 3</p><pre><code>9. 检查索引是否在数组中&lt;br/&gt;```php$people = array(&#39;name&#39;=&gt;&#39;renbo&#39;, &#39;age&#39;=&gt;&#39;28&#39;);if (array_key_exists(&#39;name&#39;, $people)) {  echo &#39;name存在&#39;;}</code></pre><ol start="10"><li><p>检查数组中是否存在指定的值<br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$val</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">echo</span> <span class="token string">'存在'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>返回当前元素的Key<br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$people</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'renbo'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'28'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token variable">$people</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//name</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>返回当前元素所有的key<br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$people</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'renbo'</span><span class="token punctuation">,</span><span class="token string">'age'</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'28'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">array_keys</span><span class="token punctuation">(</span><span class="token variable">$people</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// name age</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><p><strong>时间内置函数</strong><br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token function">date</span><span class="token punctuation">(</span>format<span class="token punctuation">[</span><span class="token punctuation">,</span>timestamp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token function">mktime</span><span class="token punctuation">(</span>hour<span class="token punctuation">,</span>minute<span class="token punctuation">,</span>second<span class="token punctuation">,</span>month<span class="token punctuation">,</span>day<span class="token punctuation">,</span>year<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//省略的参数将以本地日期和时间代替</span><span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>timestamp<span class="token punctuation">]</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>URL处理内置函数</strong><br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token function">urlencode</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> 返回值字符串中所有的非字母和数字字符变成一个百分号<span class="token punctuation">(</span><span class="token operator">%</span><span class="token punctuation">)</span> 和一个两位的十六进制数，空格被转换成<span class="token operator">+</span><span class="token punctuation">,</span><span class="token operator">-</span>、_和<span class="token punctuation">.</span>不做任何转换<span class="token function">urldecode</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>其实还有好多比如字符串的内置函数、文件操作的内置函数、数据库连接的内置函数等等。其实PHP方法还是比JS多用到的时候查看API即可…<br></p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP 面向对象</title>
      <link href="/2017/01/23/php/oop/"/>
      <url>/2017/01/23/php/oop/</url>
      
        <content type="html"><![CDATA[<p><strong>面向对象基础概念</strong><br><br>Object Oriented Programming，简称OOP，是一种程序设计思想。OOP把对象作为程序的基本单元，一个对象包含了数据和操作数据的函数<br></p><p><strong>对象的主要三个特性</strong><br><br>对象的行为：可以对 对象施加那些操作，开灯，关灯就是行为<br><br>对象的形态：当施加那些方法是对象如何响应，颜色，尺寸，外型<br><br>对象的表示：对象的表示就相当于身份证，具体区分在相同的行为与状态下有什么不同<br></p><p>比如 People(人) 是一个抽象类，我们可以具体到男人和女人，男人和女人就是具体的对象，他们有名字属性，可以写，可以学习说话等行为状态。</p><p><strong>面向对象内容</strong><br></p><pre><code>类 − 定义了一件事物的抽象特点。类的定义包含了数据的形式以及对数据的操作对象 − 是类的实例成员变量 − 定义在类内部的变量。该变量的值对外是不可见的，但是可以通过成员函数访问，在类被实例化为对象后，该变量即可称为对象的属性成员函数 − 定义在类的内部，可用于访问对象的数据继承 − 继承性是子类自动共享父类数据结构和方法的机制，这是类之间的一种关系。在定义和实现一个类的时候，可以在一个已经存在的类的基础之上来进行，把这个已经存在的类所定义的内容作为自己的内容，并加入若干新的内容父类 − 一个类被其他类继承，可将该类称为父类，或基类，或超类子类 − 一个类继承其他类称为子类，也可称为派生类多态 − 多态性是指相同的函数或方法可作用于多种类型的对象上并获得不同的结果。不同的对象，收到同一消息可以产生不同的结果，这种现象称为多态性重载 − 简单说，就是函数或者方法有同样的名称，但是参数列表不相同的情形，这样的同名不同参数的函数或者方法之间，互相称之为重载函数或者方法抽象性 − 抽象性是指将具有一致的数据结构（属性）和行为（操作）的对象抽象成类。一个类就是这样一种抽象，它反映了与应用有关的重要性质，而忽略其他一些无关内容。任何类的划分都是主观的，但必须与具体的应用有关封装 − 封装是指将现实世界中存在的某个客体的属性与行为绑定在一起，并放置在一个逻辑单元内构造函数 − 主要用来在创建对象时初始化对象， 即为对象成员变量赋初始值，总与new运算符一起使用在创建对象的语句中析构函数 − 析构函数(destructor) 与构造函数相反，当对象结束其生命周期时（例如对象所在的函数已调用完毕），系统自动执行析构函数。析构函数往往用来做&quot;清理善后&quot; 的工作（例如在建立对象时用new开辟了一片内存空间，应在退出前在析构函数中用delete释放）</code></pre><h2 id="代码解析上述概念"><a href="#代码解析上述概念" class="headerlink" title="代码解析上述概念"></a>代码解析上述概念</h2><p><strong>PHP中类的定义</strong><br></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token delimiter">&lt;?php</span>    <span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 公有成员属性</span>      <span class="token keyword">public</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token variable">$age</span> <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 公有成员函数方法</span>      <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">sayName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//业务逻辑 </span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>PHP中对象的创建</strong><br></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 公有成员属性</span>    <span class="token keyword">public</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string">'zhangsan'</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$age</span> <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 公有成员函数方法（$this代表自身的对象);</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">sayName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 通过new操作符创建对象</span>  <span class="token variable">$body</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 成员对象的调用</span>  <span class="token variable">$body</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>PHP中构造函数</strong><br><br>构造函数是一种特殊的方法。主要用来在创建对象时初始化对象和JS中构造函数中的constructor相似<br></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 通过构造方法为成员变量赋初始值</span>    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$age</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">age</span> <span class="token operator">=</span> <span class="token variable">$age</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 公有成员函数方法（$this代表自身的对象);</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">sayName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">"my name is &amp;nbsp;"</span> <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">.</span><span class="token string">",&amp;nbspI`m&amp;nbsp;"</span> <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">age</span> <span class="token punctuation">.</span><span class="token string">"&amp;nbsp;years old"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">echo</span> <span class="token string">'&lt;/br>'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 通过new操作符创建zhangsan对象</span>  <span class="token variable">$zhangsan</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token variable">$zhangsan</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 通过new操作符创建lisi对象</span>  <span class="token variable">$lisi</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token variable">$lisi</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>PHP中析构函数</strong><br><br>析构函数 (destructor) 与构造函数相反，当对象结束其生命周期时，系统自动执行析构函数，常用场景例如连接数据库在<strong>construct中,处理完数据断开连接在</strong>destruct方法中<br></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 通过构造方法为成员变量赋初始值</span>    <span class="token keyword">function</span> <span class="token function">__construct</span> <span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">age</span> <span class="token operator">=</span> <span class="token variable">$age</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 公有成员函数方法（$this代表自身的对象);</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">sayName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">"my name is &amp;nbsp;"</span> <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">.</span><span class="token string">",&amp;nbspI`m&amp;nbsp;"</span> <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">age</span> <span class="token punctuation">.</span><span class="token string">"&amp;nbsp;years old"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">echo</span> <span class="token string">'&lt;/br>'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 析构函数用于销毁某些变量、对象，操作等</span>    <span class="token keyword">function</span> <span class="token function">__destruct</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 通过new操作符创建lisi对象</span>  <span class="token variable">$lisi</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$lisi</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">echo</span> <span class="token string">'&lt;br/>'</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$lisi</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token string">'销毁成功 &lt;br/>'</span><span class="token punctuation">;</span>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$lisi</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>PHP中继承实现</strong><br><br>PHP 使用关键字 extends 来继承一个类<br></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token comment" spellcheck="true">// 父类</span>  <span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> <span class="token variable">$age</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">__construct</span> <span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">age</span> <span class="token operator">=</span> <span class="token variable">$age</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">sayName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">"my name is &amp;nbsp;"</span> <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">.</span><span class="token string">",&amp;nbspI`m&amp;nbsp;"</span> <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">age</span> <span class="token punctuation">.</span><span class="token string">"&amp;nbsp;years old"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">echo</span> <span class="token string">'&lt;/br>'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 子类</span>  <span class="token keyword">class</span> <span class="token class-name">Boy</span> <span class="token keyword">extends</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">getParentProperty</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token variable">$lisi</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token variable">$boy</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boy</span><span class="token punctuation">(</span><span class="token string">'wangwu'</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token variable">$boy</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getParentProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 子类调用父类方法</span>  <span class="token variable">$boy</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>PHP中方法重写</strong></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> <span class="token variable">$age</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">__construct</span> <span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">age</span> <span class="token operator">=</span> <span class="token variable">$age</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">sayName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">"my name is &amp;nbsp;"</span> <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">.</span><span class="token string">",&amp;nbspI`m&amp;nbsp;"</span> <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">age</span> <span class="token punctuation">.</span><span class="token string">"&amp;nbsp;years old"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">echo</span> <span class="token string">'&lt;/br>'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 子类</span>  <span class="token keyword">class</span> <span class="token class-name">Boy</span> <span class="token keyword">extends</span> <span class="token class-name">People</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 重写父类方法</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">sayName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">echo</span> <span class="token punctuation">(</span><span class="token string">"my name is &amp;nbsp;"</span> <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token variable">$lisi</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token variable">$boy</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boy</span><span class="token punctuation">(</span><span class="token string">'wangwu'</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 重写方法</span>  <span class="token variable">$boy</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>PHP中访问的控制</strong><br><br>PHP 对属性或方法的访问控制，是通过在前面添加关键字 public（公有），protected（受保护）或 private（私有）来实现的<br></p><p>public &amp; var（公有）：公有的类成员可以在任何地方被访问<br></p><p>protected（受保护）：受保护的类成员则可以被其自身以及其子类和父类访问<br></p><p>private（私有）：私有的类成员则只能被其定义所在的类访问<br></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token comment" spellcheck="true">/**   * 基类   * Define People   */</span>  <span class="token keyword">class</span> <span class="token class-name">People</span>   <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 声明一个公有的构造函数</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 声明一个共有的方法</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">sayName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>      <span class="token keyword">echo</span> <span class="token string">'sayname&lt;/br>'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 声明一个受保护的方法</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">swim</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>      <span class="token keyword">echo</span> <span class="token string">'swim&lt;/br>'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 声明一个私有方法</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">study</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>      <span class="token keyword">echo</span> <span class="token string">'study'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 不加关键字默认公有方法</span>    <span class="token keyword">function</span> <span class="token function">getFun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">swim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token variable">$people</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 正常运行输出sayname</span>  <span class="token variable">$people</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 产生错误</span>  <span class="token variable">$people</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">swim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 产生错误</span>  <span class="token variable">$people</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 公有，受保护，私有都可以执行</span>  <span class="token variable">$people</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/**   * 子类   * Define Boy   */</span>  <span class="token keyword">class</span> <span class="token class-name">Boy</span> <span class="token keyword">extends</span> <span class="token class-name">People</span>  <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">getFun2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">swim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 这行会产生一个错误</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token variable">$body</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 这行能被正常执行</span>  <span class="token variable">$body</span> <span class="token operator">-</span><span class="token operator">></span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 公有的和受保护的都可执行，但私有的不行</span>  <span class="token variable">$body</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getFun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>PHP中抽象类</strong><br><br>利用关键字abstract声明抽象</p><p>如果类中有一个方法被是声明为抽象，那么这个类也必须声明为抽象<br></p><p>抽象方法只声明了调用方式（参数），不能定义其具体的功能实现（相当于没有函数体），子类通过继承实现抽象方法，且不能被实例化<br></p><p>继承一个抽象类，子类必须定义父类中的所有抽象方法并且必须要和父类的声明访问级别保持一致或者更宽松<br></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token comment" spellcheck="true">/**   * 定义抽象类People   */</span>  <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">People</span>   <span class="token punctuation">{</span>    <span class="token keyword">abstract</span> <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">runing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>      <span class="token keyword">echo</span> <span class="token string">'跑啊跑！&lt;/br>'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * 实现抽象类   */</span>  <span class="token keyword">class</span> <span class="token class-name">Zhangsan</span> <span class="token keyword">extends</span> <span class="token class-name">People</span>  <span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">echo</span> <span class="token string">'eat &lt;/br>'</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token string">'eat'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">echo</span> <span class="token string">'sleep &lt;/br>'</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token string">'sleep'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">echo</span> <span class="token string">'study &lt;/br>'</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token string">'study'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getFunc</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 调用子类</span>  <span class="token variable">$zhangsan</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Zhangsan</span><span class="token punctuation">;</span>  <span class="token variable">$zhangsan</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">runing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//跑啊跑！</span>  <span class="token variable">$zhangsan</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eat sleep study</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>场景：在很多类里面很多的方法都是在重复。这里就可以去用抽象类，当然也可以重写一个类，每个公共类实例化实例化一次，调用相同的方法。但是abstract可以省去实例化的步骤，而且可以重载这个方法,这样不是更方便简单嘛<br><br><strong>PHP中接口的使用</strong><br><br>interface主要对类名，类所拥有的方法，以及所传参数起约束和规范作用，和abstract类似。在多人协同开发项目时起重要作用<br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// 定义接口类</span><span class="token keyword">interface</span> <span class="token class-name">People</span>  <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token function">eat</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 实现接口类</span><span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token keyword">implements</span> <span class="token class-name">People</span><span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">eat</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">echo</span> <span class="token string">'我吃的苹果'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$apple</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$apple</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数约束，如果参数名字不一样会报错<br></p><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// 定义接口类</span><span class="token keyword">interface</span> <span class="token class-name">People</span>  <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token variable">$color</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 实现接口类Apple</span><span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token keyword">implements</span> <span class="token class-name">People</span><span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token variable">$color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">"我吃的$color 🍎&lt;br/>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 实现接口类Grape</span><span class="token keyword">class</span> <span class="token class-name">Grape</span> <span class="token keyword">implements</span> <span class="token class-name">People</span><span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token variable">$color</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">"我吃的$color 🍇"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$apple</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$apple</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'红'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$grape</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Grape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$grape</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">'紫'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接口继承<br></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token comment" spellcheck="true">// 定义People接口类</span>  <span class="token keyword">interface</span> <span class="token class-name">People</span>    <span class="token punctuation">{</span>      <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 继承People接口类</span>  <span class="token keyword">interface</span> <span class="token class-name">Boy</span> <span class="token keyword">extends</span> <span class="token class-name">People</span>    <span class="token punctuation">{</span>      <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">drink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 接口方法实现</span>  <span class="token keyword">class</span> <span class="token class-name">Behavior</span> <span class="token keyword">implements</span> <span class="token class-name">Boy</span>    <span class="token punctuation">{</span>      <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>          <span class="token keyword">echo</span> <span class="token string">"吃东西&lt;br>"</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">drink</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">"喝饮料&lt;br>"</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>           Behavior<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Behavior<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">drink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>总结抽象类和接口</strong><br><br>抽象类就是一个类的服务提供商，拥有众多服务<br></p><p>接口类就是一个类的规范，子类必须完成它指定方法<br></p><p>它们的区别：<br></p><p>抽象类继承用extends,接口继承用implements<br></p><p>抽象类能多重继承,接口多重继承用”,”隔开<br></p><p>抽象类中的方法不必全部重载,接口方法必须声明或者重载<br></p><p>抽象类不必只包含抽象方法,可以定义完整的方法,接口不能包含任何完整定义方法<br></p><p><strong><strong>set,</strong>get,<strong>isset,</strong>unset,<strong>call,</strong>sleep(),__wakeup()等魔术方法</strong></p><ol><li>__sleep() 方法常用于提交未提交的数据，或类似的清理操作。同时，如果有一些很大的对象，但不需要全部保存，这个功能就很好用<br></li></ol><p>__wakeup() 经常用在反序列化操作中，例如重新建立数据库连接，或执行其它初始化操作<br></p><p>引入php手册中的例子<br></p><pre class="line-numbers language-php"><code class="language-php">  <span class="token keyword">class</span> <span class="token class-name">Connection</span>   <span class="token punctuation">{</span>      <span class="token keyword">protected</span> <span class="token variable">$link</span><span class="token punctuation">;</span>      <span class="token keyword">private</span> <span class="token variable">$server</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">,</span> <span class="token variable">$db</span><span class="token punctuation">;</span>      <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$server</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">,</span> <span class="token variable">$db</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>          <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">server</span> <span class="token operator">=</span> <span class="token variable">$server</span><span class="token punctuation">;</span>          <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span> <span class="token variable">$username</span><span class="token punctuation">;</span>          <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">=</span> <span class="token variable">$password</span><span class="token punctuation">;</span>          <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token punctuation">;</span>          <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>          <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">link</span> <span class="token operator">=</span> <span class="token function">mysql_connect</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">server</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">mysql_select_db</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">link</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">,</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">'db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>          <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>属性重载<strong>set,</strong>get,<strong>isset,</strong>unset<br><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token function">__set</span> <span class="token punctuation">(</span> string <span class="token variable">$name</span> <span class="token punctuation">,</span> mixed <span class="token variable">$value</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> void <span class="token comment" spellcheck="true">// 设置私有属性值的时候调用</span><span class="token keyword">public</span> <span class="token function">__get</span> <span class="token punctuation">(</span> string <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> mixed  <span class="token comment" spellcheck="true">// 获取私有属性值的时候调用</span><span class="token keyword">public</span> <span class="token function">__isset</span> <span class="token punctuation">(</span> string <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> bool <span class="token comment" spellcheck="true">// 当判断一个私有成员属性是否被设置过时调用</span><span class="token keyword">public</span> <span class="token function">__unset</span> <span class="token punctuation">(</span> string <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> void <span class="token comment" spellcheck="true">// 当销毁一个私有成员属性的时候调用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>当实例化一个对象后，调用类中不存在或者没有权限访问的属性的时候，默认调用__get()方法。可以访问内部属性<br></li></ol><ol start="3"><li>方法重载<strong>call和</strong>callStatic<br><pre><code>call 和 callStatic 是类似的方法，前者是调用类不存在的方法时执行，而后者是调用类不存在的静态方式方法时执行。正常情况下如果调用一个类不存在的方法 PHP 会抛出致命错误，而使用这两个魔术方法我们可以替换一些更友好的提示或者记录错误调用日志信息、将用户重定向、抛出异常等等，亦或者是如同set 和 get 那样做方法的重命名。</code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
